<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nyc.hhs.service.db.services.application.ContractMapper">

    <resultMap id="contractsList" type="com.nyc.hhs.model.ContractList">
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="contractAgencyName" column="AGENCY_ID" />
        <result property="orgType" column="ORG_TYPE" />
        <result property="provider" column="ORGANIZATION_LEGAL_NAME" />
        <result property="ctId" column="EXT_CT_NUMBER" />
        <result property="contractValue" column="CONTRACT_AMOUNT" />
        <result property="lastUpdateDate" column="MODIFIED_DATE" />
        <result property="contractStatus" column="STATUS" />
        <result property="contractStatusId" column="STATUS_ID" />
        <result property="contractTypeId" column="CONTRACT_TYPE_ID" />
        <result property="contractSourceId" column="CONTRACT_SOURCE_ID" />
        <result property="contractId" column="CONTRACT_ID" />
        <result property="contractValue" column="CONTRACT_AMOUNT" />
        <result property="contractStartDate" column="CONTRACT_START_DATE" />
        <result property="contractEndDate" column="CONTRACT_END_DATE" />
        <result property="amendReason" column="AMENDMENT_REASON" />
        <result property="awardEpin" column="EXT_EPIN" />
        <result property="certFundsRequired" column="CERT_FUNDS_REQUIRED" />
        <result property="isSuspended" column="IS_SUSPENDED" />
        <result property="baseContractTitle" column="BASE_CONTRACT_TITLE" />
        <result property="parentContractId" column="PARENT_CONTRACT_ID" />
        <!-- Start : R5 Added-->
        <result property="providerOrgId" column="ORGANIZATION_ID" />
        <result property="budgetCount" column="BUDGET_EXIST_COUNT" />
        <result property="invoiceCount" column="INVOICE_EXIST_COUNT" />
        <result property="paymentCount" column="PAYMENT_EXIST_COUNT" />
        <result property="providerAdmin" column="PROVIDER_ADMIN" />
        <!-- End : R5 Added-->
        <!-- Start: Added in R7 -->
        <result property="contractFlagged" column="CONTRACT_LEVEL_FLAG" />
        <!-- End: R7 End -->
         <!-- Start: Added for R7 Defect 8644:Part 3 -->
         <result property="markAsFmsRegistered" column= "MARK_AS_FMS_REGISTERED"/>
         <result property="isBudgetApproved" column= "IS_BUDGET_APPROVED"/>
        <!-- End : Added for R7 Defect 8644: Part 3 -->
        <!-- [Start] R7.12.0 added for QC9314-->
         <result property="onGoingAmendCount" column= "ONGOINGAMENDCOUNT"/>                        
        <!-- [End] R7.12.0 added for QC9314-->
        <!-- [Start] R9.7.5 QC9719 -->
         <result property="actionDisable" column= "action_disable"/>
        <!-- [End] R9.7.5 QC9719 -->
        <!-- [Start] R9.7.6 QC9730 -->
            <result property="actionException" column= "action_exception"/>
        <!-- [End] R9.7.6 QC9730 -->
    </resultMap>

    <select id="fetchAgencyNames" resultType="hashmap">
        select AGENCY_NAME,
        AGENCY_ID from NYC_AGENCY_DETAILS where ACTIVE_FLAG='1'
        order by
        AGENCY_NAME asc 
    </select>
    
    <!-- Start R7: defect 8644 part 3,
    It updates the REQUEST_PARTIAL_MERGE column in the contract table as 1 when the city user select the option 
    Mark as FMS Registered  in the contract List-->
    <update id="updateRequestPartialMergeContractList" parameterType="String">
    UPDATE CONTRACT SET REQUEST_PARTIAL_MERGE=1 WHERE CONTRACT_ID=#{ContractId} AND CONTRACT_TYPE_ID=2
    </update>
    
    <!-- Start R7: defect 8644 part 3  -->

    <select id="fetchContractListProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultMap="contractsList">
        select CONTRACT_ID, CONTRACT_AMOUNT, ORG_TYPE,
        CONTRACT_START_DATE, CONTRACT_END_DATE,
        AMENDMENT_REASON,
        CONTRACT_TITLE, AGENCY_ID, EXT_CT_NUMBER,
        LAST_UPDATE_DATE,MODIFIED_DATE, EXT_EPIN,
        <!-- Start : R5 Added -->
        BUDGET_EXIST_COUNT, PROVIDER_ADMIN, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added -->
        STATUS, STATUS_ID,
        <!-- [Start] R9.7.5 QC9719 -->
        action_disable ,
        <!-- [End] R9.7.5 QC9719 -->
          <!-- [Start] R9.7.6 QC9730 -->
	        action_exception  , 
         <!-- [End] R9.7.6 QC9730 -->            				
        
        rn from ( Select CONTRACT_ID, CONTRACT_AMOUNT, #{orgType}
        ORG_TYPE,
        CONTRACT_START_DATE, CONTRACT_END_DATE,
        AMENDMENT_REASON,
        CONTRACT_TITLE, AGENCY_ID, EXT_CT_NUMBER,
        TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS LAST_UPDATE_DATE,
        TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS MODIFIED_DATE,
        EXT_EPIN,
        STATUS, STATUS_ID,
        <!-- Start : R5 Added -->
        BUDGET_EXIST_COUNT, PROVIDER_ADMIN, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added -->
        <!-- [Start] R9.7.3 QC9719 -->
        (select count(1) from ACTION_DISABLE_TASK_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID  
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_DISABLE_TASK_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         ) action_disable ,
        <!-- [End] R9.7.3 QC9719 -->
		<!-- [Start] R9.7.6 QC9730 -->
        (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID  and INVOICE_ADV_ONLY not in ('11','10','01')
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_EXCEPTIONAL_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         ) action_exception ,
		<!-- [End] R9.7.6 QC9730 -->
        ROWNUM as rn from (Select 
        con.CONTRACT_TITLE,
        con.AGENCY_ID,
        decode(st.STATUS_ID,61,'--',69,'--',con.EXT_CT_NUMBER)
        EXT_CT_NUMBER,
        con.CONTRACT_AMOUNT,TO_DATE (TO_CHAR (con.LAST_UPDATE_DATE, 'DD-MON-YYYY'),
                'DD-MON-YYYY') AS last_update_date,
                TO_DATE (TO_CHAR (con.MODIFIED_DATE, 'DD-MON-YYYY'),
                'DD-MON-YYYY') AS MODIFIED_DATE,
        con.EXT_EPIN,
        st.STATUS,
        st.STATUS_ID
        ,con.CONTRACT_ID,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON,
        <!-- Start : R5 Added -->
        (SELECT COUNT(1) FROM BUDGET WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID != 106 AND ACTIVE_FLAG='1') AS BUDGET_EXIST_COUNT,
        (SELECT COUNT(1) FROM STAFF_ORGANIZATION WHERE ORGANIZATION_ID = con.ORGANIZATION_ID and permission_level in ( 'Level 1','Level 2')
        and permission_type in ('F','FP') and admin_permission = 'Yes' and staff_id = #{userIdContractRestriction, jdbcType=VARCHAR}) AS PROVIDER_ADMIN,
        (SELECT COUNT(1) FROM INVOICE WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (70,71,72,73,74,75) AND CON.STATUS_ID IN(62,68,67)) AS INVOICE_EXIST_COUNT,
        (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (64,65,109) AND DELETE_FLAG = '0') AS PAYMENT_EXIST_COUNT
        <!-- End : R5 Added -->
        from CONTRACT con, STATUS_MASTER_R2_R3 st
        where con.STATUS_ID =
        st.STATUS_ID and
        ORGANIZATION_ID= #{orgName} and
        con.CONTRACT_TYPE_ID
        IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
            AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%'))
        </if>
        <if test="contractAgencyName != null and contractAgencyName !=''">
            AND con.AGENCY_ID = #{contractAgencyName}
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;=
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;=
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        ORDER BY
        <choose>
            <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
            <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
        </choose>
        <if test="secondSort != null and secondSort !=''">
            <choose>
                <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
                <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
            </choose>
        </if>
        ) a ) b where rn
        BETWEEN #{startNode} AND
        #{endNode}
    </select>
    <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
    <select id="fetchContractListAgency" parameterType="com.nyc.hhs.model.ContractList"
        resultMap="contractsList">
        select 
        CONTRACT_ID, CONTRACT_START_DATE,CONTRACT_LEVEL_FLAG,
        ORG_TYPE,AGENCY_ID,
        CONTRACT_END_DATE, AMENDMENT_REASON,
        CONTRACT_TITLE,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,
        CONTRACT_AMOUNT,
        LAST_UPDATE_DATE,MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
        EXT_EPIN,CERT_FUNDS_REQUIRED,
        <!-- Start : R5 Added-->
        ORGANIZATION_ID,BUDGET_EXIST_COUNT, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added-->
        <!-- Start : Added in R7 for defect 8644 -->
        IS_BUDGET_APPROVED,
        <!-- End : Added in R7 for defect 8644 -->
        <!-- [Start] R9.7.5 QC9719 -->
        action_disable ,
        <!-- [End] R9.7.5 QC9719 -->
		<!-- [Start] R9.7.6 QC9730 -->
	    action_exception ,
	    <!-- [End] R9.7.6 QC9730 -->     
        STATUS, STATUS_ID,rn
        from ( Select CONTRACT_ID, CONTRACT_START_DATE, #{orgType}
        ORG_TYPE,AGENCY_ID,CONTRACT_LEVEL_FLAG,
        CONTRACT_END_DATE, AMENDMENT_REASON,
        CONTRACT_TITLE,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,
        CONTRACT_AMOUNT,
        TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS
        LAST_UPDATE_DATE,
        TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS
        MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
        EXT_EPIN,CERT_FUNDS_REQUIRED,
        <!-- Start : R5 Added-->
        ORGANIZATION_ID,BUDGET_EXIST_COUNT, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added-->
        <!-- Start : Added in R7 for defect 8422 -->
        IS_BUDGET_APPROVED,
        <!-- End : Added in R7 for defect 8422 -->
        STATUS, STATUS_ID, 
        <!-- [Start] R9.7.5 QC9719 -->
        (select count(1) from ACTION_DISABLE_TASK_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID   
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_DISABLE_TASK_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         ) action_disable ,
        <!-- [End] R9.7.5 QC9719 -->
		<!-- [Start] R9.7.6 QC9730 -->        
                (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID   and INVOICE_ADV_ONLY not in ('11','10','01')
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_EXCEPTIONAL_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         )  action_exception ,
		<!-- [End] R9.7.6 QC9730 -->            				
        ROWNUM as rn from
        (select con.CONTRACT_TITLE,
        org.ORGANIZATION_LEGAL_NAME,
        <!-- Start : R7 Added -->
        (select count(1) from Flag_Contract_Details where
        contract_id=con.CONTRACT_ID)
        AS CONTRACT_LEVEL_FLAG,
        <!-- End : R7 Added -->
        decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER)
        EXT_CT_NUMBER, con.LAST_UPDATE_DATE,con.MODIFIED_DATE,
        con.EXT_EPIN,con.CERT_FUNDS_REQUIRED, st.STATUS,
        st.STATUS_ID, con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID,con.AGENCY_ID
        ,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON,
        <!-- Start : R5 Added-->
         org.ORGANIZATION_ID,
         <!-- Start : Added for R7 Defect 8644 configure New FY will be available when budget will be approved or active-->
        (SELECT count(contract_id)
        FROM budget
        WHERE fiscal_year_id in
          (SELECT MAX(fiscal_year_id) fy
          FROM budget
          WHERE budget_type_id=2
          and contract_id=CON.CONTRACT_ID AND status_id !=106
          )AND status_id IN(85,86) 
      and CONTRACT_ID = CON.CONTRACT_ID) AS IS_BUDGET_APPROVED,
        <!-- End : Added for R7 Defect 8644 -->
         
        (SELECT COUNT(1) FROM BUDGET WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID != 106 AND ACTIVE_FLAG='1') AS BUDGET_EXIST_COUNT,
        (SELECT COUNT(1) FROM INVOICE WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (71,72,73,74,75) AND CON.STATUS_ID IN(62,68,67)) AS INVOICE_EXIST_COUNT,
        (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (109,63,64,65,66,159) AND DELETE_FLAG = '0') AS PAYMENT_EXIST_COUNT
        <!-- End : R5 Added-->

        from CONTRACT con, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        where
        con.STATUS_ID =
        st.STATUS_ID and
        con.ORGANIZATION_ID=org.ORGANIZATION_ID and
        AGENCY_ID=#{orgName} and
        con.CONTRACT_TYPE_ID IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
            AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%'))
        </if>
        <if test="provider != null and provider !=''">
            AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE
            lower(#{provider})
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (59,60,61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;=
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;=
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        ORDER BY
        <choose>
            <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
            <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
        </choose>
        <if test="secondSort != null and secondSort !=''">
            <choose>
                <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
                <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
            </choose>
        </if>
        ) a 
    <!-- Added in R7 -->
    <if test="filterFlaggedContracts">
        where CONTRACT_LEVEL_FLAG=1
    </if>
    <!-- R7 End -->
        ) b where rn
        BETWEEN #{startNode} AND
        #{endNode}
    </select>

    <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
    <!-- Made changes in this query for defect 8644 part 3 in R7-->
    <select id="fetchContractListAccelerator" parameterType="com.nyc.hhs.model.ContractList"
        resultMap="contractsList">
        select
        CONTRACT_ID, CONTRACT_START_DATE, ORG_TYPE,CONTRACT_LEVEL_FLAG,
        CONTRACT_END_DATE, AMENDMENT_REASON,
        CONTRACT_TITLE,AGENCY_ID,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,CERT_FUNDS_REQUIRED,
        CONTRACT_AMOUNT,
        LAST_UPDATE_DATE,MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
        STATUS,
        <!-- Start : R5 Added-->
        ORGANIZATION_ID,BUDGET_EXIST_COUNT, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added-->
        <!-- Start : Added in R7 for defect 8644 part 2 -->
        IS_BUDGET_APPROVED,
        <!-- End : Added in R7 for defect 8644 part 2 -->
        <!-- [Start] R9.7.5 QC9719 -->
        action_disable ,
        <!-- [End] R9.7.5 QC9719 -->      
			<!-- [Start] R9.7.6 QC9730 -->
		         action_exception ,
		    <!-- [End] R9.7.6 QC9730 -->            				
        STATUS_ID, rn
        from ( Select CONTRACT_ID, CONTRACT_START_DATE, #{orgType}
        ORG_TYPE,AGENCY_ID,CONTRACT_LEVEL_FLAG,
        CONTRACT_END_DATE, AMENDMENT_REASON,
        CONTRACT_TITLE,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,CERT_FUNDS_REQUIRED,
        CONTRACT_AMOUNT,
        TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS
        LAST_UPDATE_DATE,TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS
        MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
        STATUS,
        <!-- Start : R5 Added-->
        ORGANIZATION_ID,BUDGET_EXIST_COUNT, INVOICE_EXIST_COUNT, PAYMENT_EXIST_COUNT,
        <!-- End : R5 Added-->
        <!-- Start : Added in R7 for defect 8422 part 2-->
         IS_BUDGET_APPROVED,
        <!-- End : Added in R7 for defect 8422 part 2-->
        STATUS_ID, 
        <!-- [Start] R9.7.5 QC9719 -->
        (select count(1) from ACTION_DISABLE_TASK_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID 
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_DISABLE_TASK_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         ) action_disable ,
        <!-- [End] R9.7.5 QC9719 -->
        <!-- [Start] R9.7.6 QC9730 -->
        (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
               where aet.CONTRACT_ID = a.CONTRACT_ID and aet.AGENCY_ID = a.AGENCY_ID and INVOICE_ADV_ONLY not in ('11','10','01')
                 and IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
                                                             from  ACTION_EXCEPTIONAL_OBJ eae 
                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
                                                              AND  eae.AGENCY_ID = aet.AGENCY_ID   ) 
         )  action_exception, 
		<!-- [End] R9.7.6 QC9730 -->            				
        ROWNUM as rn from (select
        con.CONTRACT_TITLE,
        org.ORGANIZATION_LEGAL_NAME,
                <!-- Start : R7 Added -->
        (select count(1) from Flag_Contract_Details where
        contract_id=con.CONTRACT_ID )
        AS CONTRACT_LEVEL_FLAG,
        <!-- End : R7 Added -->
        decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER)
        EXT_CT_NUMBER,con.CERT_FUNDS_REQUIRED, con.LAST_UPDATE_DATE,con.MODIFIED_DATE,
        st.STATUS, st.STATUS_ID,con.AGENCY_ID,
        con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID
        ,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON,
        <!-- Start : R5 Added-->
        org.ORGANIZATION_ID,
        <!-- Start : Added for R7 Defect 8644 part 2 configure New FY will be available when budget will be approved or active-->
         (SELECT count(contract_id)
        FROM budget
        WHERE fiscal_year_id in
          (SELECT MAX(fiscal_year_id) fy
          FROM budget
          WHERE budget_type_id=2
          and contract_id=CON.CONTRACT_ID AND status_id !=106
          )AND status_id      IN(85,86)    
      and CONTRACT_ID = CON.CONTRACT_ID) AS IS_BUDGET_APPROVED,
        <!-- End : Added for R7 Defect 8644 part 2-->
        (SELECT COUNT(1) FROM BUDGET WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID != 106 AND ACTIVE_FLAG='1') AS BUDGET_EXIST_COUNT,
        (SELECT COUNT(1) FROM INVOICE WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (71,72,73,74,75) AND CON.STATUS_ID IN(62,68,67)) AS INVOICE_EXIST_COUNT,
        (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = CON.CONTRACT_ID AND STATUS_ID IN (109,63,64,65,66,159) AND DELETE_FLAG = '0') AS PAYMENT_EXIST_COUNT
        <!-- End : R5 Added-->

        from CONTRACT con, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        where
        con.STATUS_ID =
        st.STATUS_ID and
        con.ORGANIZATION_ID=org.ORGANIZATION_ID and con.CONTRACT_TYPE_ID
        IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
            AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%'))
        </if>
        <if test="contractAgencyName != null and contractAgencyName !=''">
            AND con.AGENCY_ID = #{contractAgencyName}
        </if>
        <if test="provider != null and provider !=''">
            AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE
            lower(#{provider})
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (59,60,61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;=
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;=
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        ORDER BY
        <choose>
            <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
            <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
        </choose>
        <if test="secondSort != null and secondSort !=''">
            <choose>
                <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
                <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
            </choose>
        </if>
        ) a 
    <!-- Added in R7 -->
    <if test="filterFlaggedContracts">
        where CONTRACT_LEVEL_FLAG=1
    </if>
    <!-- R7 End -->
        ) b where rn
        BETWEEN #{startNode} AND
        #{endNode}

    </select>

    <select id="fetchContractAmountProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultType="String">
        Select sum(CONTRACT_AMOUNT) from CONTRACT con
        where
        con.CONTRACT_TYPE_ID IN(1,3) AND
        con.Status_ID IN (61, 62, 67) AND
        con.ORGANIZATION_ID = #{orgName} and
        CONTRACT_AMOUNT is not null
    </select>

    <select id="fetchContractCountProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultType="int">
        SELECT count(1) count FROM ( Select CONTRACT_ID, CONTRACT_AMOUNT,
        CONTRACT_START_DATE, CONTRACT_END_DATE, AMENDMENT_REASON,
        CONTRACT_TITLE, AGENCY_ID, EXT_CT_NUMBER, CONTRACT_TYPE_ID,
        LAST_UPDATE_DATE, EXT_EPIN, STATUS, STATUS_ID,
        ROWNUM as rn from
        (Select con.CONTRACT_TITLE, con.AGENCY_ID,
        con.EXT_CT_NUMBER,
        con.CONTRACT_TYPE_ID, con.CONTRACT_AMOUNT, con.LAST_UPDATE_DATE,
        con.EXT_EPIN,
        st.STATUS, st.STATUS_ID
        ,con.CONTRACT_ID,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
        from CONTRACT con, STATUS_MASTER_R2_R3 st
        where con.STATUS_ID =
        st.STATUS_ID and
        ORGANIZATION_ID=#{orgName} and
        con.CONTRACT_TYPE_ID
        IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
             AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%'))
        </if>
        <if test="contractAgencyName != null and contractAgencyName !=''">
            AND con.AGENCY_ID = #{contractAgencyName}
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        ))
    </select>
    <select id="fetchContractCountAgency" parameterType="com.nyc.hhs.model.ContractList"
        resultType="int">
        select count(1) count from ( Select CONTRACT_ID,CONTRACT_LEVEL_FLAG, CONTRACT_START_DATE,
        CONTRACT_END_DATE, AMENDMENT_REASON, CONTRACT_TITLE,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER, CONTRACT_AMOUNT,
        LAST_UPDATE_DATE,
        EXT_EPIN, STATUS, ROWNUM as rn from (select
        con.CONTRACT_TITLE,
        <!-- ADDED IN r7 -->
        (select count(1) from Flag_Contract_Details where
        contract_id=con.CONTRACT_ID) AS CONTRACT_LEVEL_FLAG,
        <!-- R7 End -->
        org.ORGANIZATION_LEGAL_NAME, con.EXT_CT_NUMBER,
        con.LAST_UPDATE_DATE,
        con.EXT_EPIN, st.STATUS
        ,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
        from CONTRACT con, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        where
        con.STATUS_ID =
        st.STATUS_ID and
        con.ORGANIZATION_ID=org.ORGANIZATION_ID and
        AGENCY_ID=#{orgName} and
        con.CONTRACT_TYPE_ID IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
            AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%'))
        </if>
        <if test="provider != null and provider !=''">
            AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE
            lower(#{provider})
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (59,60,61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        )
        <!-- Added in R7 -->
        <if test="filterFlaggedContracts">
        WHERE CONTRACT_LEVEL_FLAG=1
        </if>
        <!-- R7 End -->
        )
    </select>
    <select id="fetchContractCountAccelerator" parameterType="com.nyc.hhs.model.ContractList"
        resultType="int">
        select count(1) count from ( Select CONTRACT_ID,CONTRACT_LEVEL_FLAG, CONTRACT_START_DATE,
        CONTRACT_END_DATE, AMENDMENT_REASON, CONTRACT_TITLE,
        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER, CONTRACT_AMOUNT,
        LAST_UPDATE_DATE,
        STATUS, ROWNUM as rn from (select con.CONTRACT_TITLE,
        <!-- ADDED IN r7 -->
        (select count(1) from Flag_Contract_Details where
        contract_id=con.CONTRACT_ID) AS CONTRACT_LEVEL_FLAG,
        <!-- R7 End -->
        org.ORGANIZATION_LEGAL_NAME, con.EXT_CT_NUMBER, con.LAST_UPDATE_DATE,
        st.STATUS
        ,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
        from CONTRACT con, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        where
        con.STATUS_ID =
        st.STATUS_ID and
        con.ORGANIZATION_ID=org.ORGANIZATION_ID and con.CONTRACT_TYPE_ID
        IN(1,3)
        <if test="contractTitle != null and contractTitle !=''">
            AND
            (lower(con.CONTRACT_TITLE) LIKE
            lower('%${contractTitle}%') )
        </if>
        <if test="contractAgencyName != null and contractAgencyName !=''">
            AND con.AGENCY_ID = #{contractAgencyName}
        </if>
        <if test="provider != null and provider !=''">
            AND
            lower(org.ORGANIZATION_LEGAL_NAME) LIKE
            lower(#{provider})
        </if>
        <if test="ctId != null and ctId !=''">
            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
        </if>
        <if test="awardEpin != null and awardEpin !=''">
            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
        </if>
        <if test="contractValueFrom != null and contractValueFrom !=''">
            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
        </if>
        <if test="programName != null and programName !=''">
            AND con.PROGRAM_ID = #{programName}
        </if>
        <if test="contractValueTo != null and contractValueTo !=''">
            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId == null">
            <if test="contractStatusList != null">
                AND st.Status_ID IN
                <foreach item="items" index="index" collection="contractStatusList"
                    open="(" separator="," close=")">
                    #{items}
                </foreach>
            </if>
        </if>
        <!-- End : R5 Added -->
        <if test="contractStatusList == null">
            <choose>
                <when test="filterClicked or filterFlaggedContracts">
                    AND st.STATUS_ID IN ('')</when>
                <otherwise>AND st.STATUS_ID IN (59,60,61,62)</otherwise>
            </choose>
        </if>
        <if test="contractStartDate != null and contractStartDate !=''">
            AND con.CONTRACT_START_DATE &gt;
            #{contractStartDate,
            jdbcType=DATE} 
        </if>
        <if test="contractEndDate != null and contractEndDate !=''">
            AND con.CONTRACT_END_DATE &lt;
            #{contractEndDate,
            jdbcType=DATE} 
        </if>
        <!-- Start : R5 Added -->
        <if test="contractId != null and contractId !=''">
            AND con.CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
        </if>
        <!-- End : R5 Added -->
        )
        <!-- Added in R7 -->
        <if test="filterFlaggedContracts">
        WHERE CONTRACT_LEVEL_FLAG=1
        </if>
        <!-- R7 End -->
        )
    </select>
    
<!-- [Start] R7.5.0 QC6719 -->    
    <select id="fetchAmendmentListProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultType="string">
        SELECT base.contract_id 
        from contract base 
        left join contract amend on base.contract_id=amend.parent_contract_id 
        where amend.contract_type_id = '2' 
        and amend.status_id  not in ( 62 ,  68, 69 ) 
        and amend.delete_flag='0' 
        and amend.ORGANIZATION_ID=#{orgName} 
        and base.status_id NOT IN (67, 68)
    </select>
    <select id="fetchAmendmentListAgency" parameterType="com.nyc.hhs.model.ContractList"
        resultType="string">
        SELECT  base.contract_id 
          from  contract base left join contract amend on base.contract_id=amend.parent_contract_id 
        where amend.contract_type_id = '2' 
        and   amend.status_id  not in ( 62 ,  68, 69 )
        and   amend.delete_flag='0' 
        and   amend.AGENCY_ID=#{orgName} 
        and base.status_id NOT IN (67, 68)
    </select>
<!-- [End] R7.5.0 QC6719 -->    

    <!-- Start Release 3.8.0 Enhancement 6481 -->
    <select id="fetchContractUpdateForApprovedActiveBudget" parameterType="com.nyc.hhs.model.ContractList"
        resultType="string">
    select contract.contract_id from budget,contract where contract.contract_id = budget.contract_id    and budget.status_id in (85,86) and budget.budget_type_id = 2 and budget.active_flag=1
    </select>
    <!-- End Release 3.8.0 Enhancement 6481 -->
    
    <!-- Release 5 Contract Restriction  -->
    <select id="fetchContractForRestriction" parameterType="com.nyc.hhs.model.BaseFilter"
        resultType="string">
    select contract_id from contract where parent_contract_id in (select contract_id from contract_restriction where staff_id = #{userIdContractRestriction, jdbcType=VARCHAR})
    </select>
    
    <select id="fetchContractForRestrictionCount" parameterType="hashmap"
        resultType="int">
    select count(contract_id) from contract_restriction where contract_id in (select parent_contract_id from contract where contract_id = #{contractId}) and staff_id = #{UserId}
    </select>
    
    <select id="fetchContractForRestrictionCountInvoice" parameterType="hashmap"
        resultType="int">
    select count(contract_id) from contract_restriction where contract_id in (select contract_id from invoice where contract_id = #{invoiceId,jdbcType=NUMERIC}) and staff_id = #{userId,jdbcType=NUMERIC}
    </select>
    
    <select id="getPermissionType" resultType="string" parameterType="hashmap">
    select permission_type from staff_organization where staff_id = #{userId,jdbcType=VARCHAR} and organization_id = #{PROVIDER_ID,jdbcType=VARCHAR}
    </select>
    
    <select id="fetchDocumentListProcurementUser"  resultMap="restrictedDocumentList" parameterType="hashmap">
    select document_identifier_id , #{userId} as userId from 
        (
    (select document_identifier_id from budget_document where  document_type in <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>
    union all
    select document_identifier_id from invoice_document where  document_type in <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>)
    minus
    (select document_identifier_id from vw_attached_documents where object_name  in ('Proposal','Award','AgencyAward')     )    
    )
    </select>
    
    <resultMap id="restrictedDocumentList" type="com.nyc.hhs.model.Document">
        <result property="msDocumentId" column="document_identifier_id" />
        <result property="msUserId" column="userId" />
    </resultMap>
    
    <select id="fetchDocumentListRestrictedContracts" parameterType="hashmap"   resultMap="restrictedDocumentList">
        select document_identifier_id , #{userId} as userId from 
        (
        (select document_identifier_id from budget_document where budget_id in (
        select budget_id from budget where parent_id in (
        select budget_id from budget where contract_id in (
        select contract_id from contract_restriction where staff_id = #{userId}
        )
        )
        and document_type in 
        <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>
        )
        union all
        select document_identifier_id from invoice_document where invoice_id in (
        select invoice_id from invoice where contract_id in (
        select contract_id from contract_restriction where staff_id = #{userId}
        ))
        and document_type in 
        <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>
        )
        
        minus
        (select document_identifier_id from budget_document where budget_id in (
        select budget_id from budget where parent_id in (
        select budget_id from budget where contract_id not in (
        select contract_id from contract_restriction where staff_id = #{userId}
        )
        )
        and document_type in 
        <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>
        )
        union all
        select document_identifier_id from invoice_document where invoice_id in (
        select invoice_id from invoice where contract_id not in (
        select contract_id from contract_restriction where staff_id = #{userId}
        ))
        and document_type in 
        <foreach item="item" index="index" collection="documentType"
            open="(" separator="," close=")"> #{item}   </foreach>
        union all
        select document_identifier_id from vw_attached_documents where object_name  in ('Proposal','Award','AgencyAward')         
        )
    )
    </select>
    <!-- Release 5 Contract Restriction  -->

<!-- [Start] R7.5.0 QC6719 -->    
    <select id="fetchAmendmentListAccelearator" parameterType="com.nyc.hhs.model.ContractList"     resultType="string">
	    SELECT base.contract_id 
	    from contract base 
	    left join contract amend on base.contract_id=amend.parent_contract_id 
	    where amend.contract_type_id = '2' 
	    and   amend.status_id not in ( 62 , 68, 69 )
	    and   amend.delete_flag='0' 
	    and   base.status_id  NOT IN (67, 68)
    </select>
<!-- [End] R7.5.0 QC6719 -->

    <update id="closeContract" parameterType="hashmap">
        UPDATE CONTRACT SET
        STATUS_ID =#{ContractStatusId} WHERE CONTRACT_ID=#{ContractId}
    </update>

    <!-- build 2.6.0, defect id 5683 -->
    <update id="closeBudgetContract" parameterType="hashmap">
        UPDATE BUDGET SET
        PREV_STATUS_ID  = STATUS_ID, STATUS_ID =#{ContractBudgetStatusId} WHERE CONTRACT_ID=#{ContractId}
    </update>

    <update id="updateAmendContractInfo" parameterType="com.nyc.hhs.model.ContractList">
        update
        contract set amendment_reason = #{amendReason} ,
        contract_start_date =
        #{amendStartDate}, contract_end_date =
        #{amendEndDate}, contract_amount
        = #{newTotalContractAmount} where
        contract_id = #{contractId}
    </update>

    <!-- <select id="errorMessageAmendSceen" parameterType="com.nyc.hhs.model.ContractList" 
        resultType="int"> select count(1) from budget bud,budget_type budType, contract 
        con where bud.contract_id = con.contract_id and bud.budget_type_id = budtype.budget_type_id 
        and budtype.budget_type in (#{budgetType}) and bud.status_id in(#{statusIdAmendErrorMsg}) 
        </select> <select id="errorMessageAmendSceenInvoice" parameterType="com.nyc.hhs.model.ContractList" 
        resultType="int"> SELECT count(1) FROM invoice inv,contract con where inv.contract_id 
        = con.contract_id and inv.status_id in(#{statusIdAmendErrorMsg}) </select> 
        <select id="errorMessageAmendSceenPayments" parameterType="com.nyc.hhs.model.ContractList" 
        resultType="int"> SELECT count(1) FROM payment pay,contract con where pay.status_id 
        != #{statusIdAmendErrorMsg} and pay.contract_id = con.contract_id </select> -->
    <!-- Made changes for release 3.10.0 enhancement 5686 -->
    <update id="updateContractStatus" parameterType="hashmap">
        UPDATE CONTRACT
        SET STATUS_ID = 69,
        REUSE_EPIN = #{reuseEpin,jdbcType=VARCHAR},
        MODIFIED_DATE = current_timestamp, MODIFIED_BY_USERID =
        #{userId,jdbcType=VARCHAR}
        WHERE CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
    </update>

    <update id="updateUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
        UPDATE
        UNALLOCATED SET
        AMOUNT=#{ammount},MODIFIED_BY_USERID=#{modifiedUserId},MODIFIED_DATE=#{modifiedDate}
        WHERE UNALLOCATED_ID=#{unallocatedId}
    </update>

    <resultMap id="unallocatedFundsList" type="com.nyc.hhs.model.UnallocatedFunds">
        <result property="unallocatedId" column="UNALLOCATED_ID" />
        <result property="budgetId" column="BUDGET_ID" />
        <result property="approvedBudget" column="SUB_BUDGET_AMOUNT" />
        <result property="ammount" column="AMOUNT" />
    </resultMap>
    <select id="getSubsectionForLegalNameUpdateReqTask"
        parameterType="String" resultMap="unallocatedFundsList">
        SELECT
        A.UNALLOCATED_ID,B.SUB_BUDGET_AMOUNT,A.AMOUNT FROM UNALLOCATED
        A,SUB_BUDGET B WHERE A.SUB_BUDGET_ID = B.SUB_BUDGET_ID AND
        SUB_BUDGET_ID=#{subBudgetId}
    </select>
   <!-- QC 8394 R 7.9.0 Ad multiple lines to unallocated funds -->
    <insert id="insertUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
        INSERT INTO
        UNALLOCATED (UNALLOCATED_ID
        ,BUDGET_ID
        ,SUB_BUDGET_ID
        ,AMOUNT
        ,CREATED_DATE
        ,CREATED_BY_USERID
        ,MODIFIED_DATE   
        ,MODIFIED_BY_USERID
        ,UALLOCATED_FUND)
        VALUES
        (SEQ_UNALLOCATED_ID.NEXTVAL,
        (SELECT BUDGET_ID FROM SUB_BUDGET  WHERE SUB_BUDGET_ID=#{subBudgetId}),
        #{subBudgetId},
        #{ammount},
        #{createdDate},
        #{createdUserId},
        #{createdDate},
        #{createdUserId},
        #{unallocatedFund})
    </insert>
    
    <insert id="insertBulkUploadDocumentProperties" parameterType="hashmap"> 
        INSERT INTO
        BULK_UPLOAD
        (BULK_UPLOAD_ID,DOCUMENT_ID,FILE_NAME,STATUS,MAIL_SENT,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID)
        VALUES
        (SEQ_BULK_UPLOAD_ID.NEXTVAL,#{documentId},#{fileName},#{statusId},'N',SYSTIMESTAMP,#{createdBy},SYSTIMESTAMP,#{modifiedBy})
    </insert>
    

    <!-- Cancel Amendment S407 Starts -->

    <select id="selectContractAmendmentId" parameterType="com.nyc.hhs.model.ContractList"
        resultType="map">
        Select
             c.CONTRACT_ID,
             c.CONTRACT_AMOUNT, 
             c.STATUS_ID,
            (select count(1) from budget where contract_id = c.CONTRACT_ID AND STATUS_ID = 86) as BUDGET_COUNT
        FROM 
            CONTRACT c 
        WHERE
            contract_id =  #{contractId} 
            
    </select>
    <update id="updateContractAmendStatus" parameterType="com.nyc.hhs.model.ContractList">
        UPDATE
        CONTRACT SET
        STATUS_ID =#{contractStatusId},MODIFIED_DATE =
        current_timestamp ,MODIFIED_BY_USERID = #{modifyBy} WHERE CONTRACT_ID
        = #{contractId} AND CONTRACT_TYPE_ID = #{contractTypeId}
    </update>

    <!-- build 2.6.0, defect id 5683 -->
    <update id="updateAmenBudgetStatus" parameterType="com.nyc.hhs.model.ContractList">
        UPDATE BUDGET SET PREV_STATUS_ID  = STATUS_ID, STATUS_ID =#{budgetStatusId},MODIFIED_DATE =
        current_timestamp ,MODIFIED_BY_USERID = #{modifyBy},
        MODIFIED_BY_STAFFID = null
        WHERE CONTRACT_ID = #{contractId} and BUDGET_TYPE_ID = #{budgetTypeId}
    </update>
    
    <select id="selectAmenBudgetStatus" parameterType="com.nyc.hhs.model.ContractList" resultMap="auditDetails">
        select BUDGET_ID,status_id,'89' as prev_status_id,BUDGET_TYPE_ID from BUDGET 
        WHERE CONTRACT_ID = #{contractId} and BUDGET_TYPE_ID = #{budgetTypeId}
    </select>

    <!-- Cancel Amendment S407 Ends -->
    <!-- Added in release 6:APT  -->
    <resultMap id="aptList" type="com.nyc.hhs.model.EPinDetailBean">
        <result property="awardEpin" column="PROCUREMENT_AWARD_EPIN" />
        <result property="procurementStartDate" column="PROCUREMENT_START_DATE" />
        <result property="agencyDiv" column="AGENCY_DIVISION" />
        <result property="awardAgencyId" column="AWARD_AGENCY_ID" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="procMethod" column="PROCUREMENT_METHOD" />
        <result property="projProg" column="PROJECT_PROGRAM" />
        <result property="procDescription" column="DESCRIPTION" />
        <result property="vendorFmsId" column="VENDOR_FMS_ID" />
        <result property="providerLegalName" column="ORGANIZATION_LEGAL_NAME" />
        <result property="vendorFmsName" column="AWARDED_VENDOR_NAME" />
        <result property="contractStart" column="CONTRACT_START_DATE" />
        <result property="contractEnd" column="CONTRACT_END_DATE" />
        <result property="amendValue" column="AWARD_AMOUNT" />
        <result property="refAptEpinId" column="REF_APT_EPIN_ID" />
    </resultMap>
    <!-- Added in release 6:APT end -->

    <!-- R6: Code updated for release 6 non APT epins -->
    <!-- R7.5.0 QC9131  -->
    <select id="findContractDetailsByEPIN" parameterType="com.nyc.hhs.model.EPinDetailBean"
        resultMap="aptList">
        SELECT PROCUREMENT_AWARD_EPIN, TO_CHAR(PROCUREMENT_START_DATE,'MM/DD/YYYY') AS PROCUREMENT_START_DATE,
               AGENCY_DIVISION, AWARD_AGENCY_ID, AGENCY_ID, PROCUREMENT_METHOD, PROJECT_PROGRAM, DESCRIPTION,
               REF_APT_EPIN_MASTER.VENDOR_FMS_ID, ORG.ORGANIZATION_LEGAL_NAME, AWARDED_VENDOR_NAME,
               REF_APT_EPIN_ID, NVL(AWARD_AMOUNT,'0') AS AWARD_AMOUNT,  
               TO_CHAR(CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE,
               TO_CHAR(CONTRACT_END_DATE,'MM/DD/YYYY') AS CONTRACT_END_DATE
        FROM   REF_APT_EPIN_MASTER
        LEFT JOIN REF_VENDOR_V ON  REF_VENDOR_V.VEND_CUST_CD = REF_APT_EPIN_MASTER.VENDOR_FMS_ID
        LEFT JOIN ( select ORGANIZATION_LEGAL_NAME, ORGANIZATION_ID, EIN_ID_NN from ORGANIZATION where ORGANIZATION_ACTIVE_FLAG = 'true' ) ORG 
             ON    ORG.EIN_ID_NN = REF_VENDOR_V.TIN
        WHERE
        <choose>
            <when test="refAptEpinId != null and refAptEpinId!=''">
            REF_APT_EPIN_MASTER.REF_APT_EPIN_ID = #{refAptEpinId}
            </when>
            <otherwise>
            REF_APT_EPIN_MASTER.PROCUREMENT_AWARD_EPIN = #{epinId} AND UPPER(REF_APT_EPIN_MASTER.AGENCY_DIVISION)=UPPER(#{agencyDiv})
            </otherwise>
        </choose>
    </select>
    <!-- R7.5.0 QC9131  -->
    
    <!-- Added in release 6:APT  -->
    <resultMap id="aptList1" type="com.nyc.hhs.model.EPinDetailBean">
        <result property="awardEpin" column="PROCUREMENT_AWARD_EPIN" />
        <result property="procurementStartDate" column="PROCUREMENT_START_DATE" />
        <result property="agencyDiv" column="AGENCY_DIVISION" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="awardAgencyId" column="AWARD_AGENCY_ID" />
        <result property="procMethod" column="PROCUREMENT_METHOD" />
        <result property="projProg" column="PROJECT_PROGRAM" />
        <result property="procDescription" column="DESCRIPTION" />
        <result property="vendorFmsId" column="VENDOR_FMS_ID" />
        <result property="providerLegalName" column="ORGANIZATION_LEGAL_NAME" />
        <result property="vendorFmsName" column="AWARDED_VENDOR_NAME" />
        <result property="contractValue" column="AWARD_AMOUNT" />
        <result property="contractStart" column="CONTRACT_START_DATE" />
        <result property="contractEnd" column="CONTRACT_END_DATE" />
        <result property="refAptEpinId" column="REF_APT_EPIN_ID" />
    </resultMap>
    <!-- Added in release 6:APT end -->

    <!-- R6: Query modified for release 6 non APT epins -->
    <!-- [Start] R7.3.0 QC9015: Multiple EIN -->
    <select id="findContractDetailsByEPINforNew" parameterType="com.nyc.hhs.model.EPinDetailBean"
        resultMap="aptList1">
        SELECT PROCUREMENT_AWARD_EPIN, TO_CHAR(PROCUREMENT_START_DATE, 'MM/DD/YYYY') AS PROCUREMENT_START_DATE,
		        AGENCY_DIVISION, AGENCY_ID, AWARD_AGENCY_ID, PROCUREMENT_METHOD, PROJECT_PROGRAM,DESCRIPTION,
		        REF_APT_EPIN_MASTER.VENDOR_FMS_ID, ORG.ORGANIZATION_LEGAL_NAME,
		        AWARDED_VENDOR_NAME,AWARD_AMOUNT,REF_APT_EPIN_ID,
		        TO_CHAR(CONTRACT_START_DATE, 'MM/DD/YYYY') AS  CONTRACT_START_DATE,
		        TO_CHAR(CONTRACT_END_DATE, 'MM/DD/YYYY') AS  CONTRACT_END_DATE
        FROM   REF_APT_EPIN_MASTER
        LEFT JOIN REF_VENDOR_V ON    REF_VENDOR_V.VEND_CUST_CD = REF_APT_EPIN_MASTER.VENDOR_FMS_ID
        LEFT JOIN   ( select ORGANIZATION_LEGAL_NAME, ORGANIZATION_ID, EIN_ID_NN from ORGANIZATION where ORGANIZATION_ACTIVE_FLAG = 'true' )  ORG 
                 ON ORG.EIN_ID_NN = REF_VENDOR_V.TIN
        WHERE   REF_APT_EPIN_MASTER.PROCUREMENT_AWARD_EPIN = #{epinId} AND UPPER(AGENCY_DIVISION)=UPPER(#{agencyDiv})
    </select>
    <!-- [End] R7.3.0 QC9015: Multiple EIN -->


    <resultMap id="contractList" type="com.nyc.hhs.model.EPinDetailBean">
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="programNameId" column="PROGRAM_ID" />
        <result property="programName" column="PROGRAM_NAME" />
        <result property="contractValue" column="CONTRACT_AMOUNT" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="contractStart" column="CONTRACT_START_DATE" />
        <result property="contractEnd" column="CONTRACT_END_DATE" />
    </resultMap>

    <select id="findContractDetailsByContract" parameterType="String"
        resultMap="contractList">
        SELECT CONTRACT.CONTRACT_TITLE,
        CONTRACT.AGENCY_ID,
        PROGRAM_MASTER.PROGRAM_ID,
        PROGRAM_MASTER.PROGRAM_NAME,
        CONTRACT.CONTRACT_AMOUNT,
        CONTRACT.CONTRACT_START_DATE,
        CONTRACT.CONTRACT_END_DATE
        FROM CONTRACT
        INNER JOIN PROGRAM_MASTER ON
        PROGRAM_MASTER.PROGRAM_ID =
        CONTRACT.PROGRAM_ID
        WHERE
        CONTRACT.CONTRACT_ID = #{asContractId}
    </select>
    
    <resultMap id="contractList1" type="com.nyc.hhs.model.EPinDetailBean">
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="programNameId" column="PROGRAM_ID" />
        <result property="programName" column="PROGRAM_NAME" />
        <result property="contractValue" column="CONTRACT_AMOUNT" />
        <result property="contractStart" column="CONTRACT_START_DATE" />
        <result property="contractEnd" column="CONTRACT_END_DATE" />
    </resultMap>
    
     <!-- Start R8.4.0 qc_8537 $0 Amendments do not appear in Amendment CoF task list after configuration -->
    <resultMap id="contractAmdList" type="com.nyc.hhs.model.EPinDetailBean">
     	<result property="parentContractId" column="PARENT_CONTRACT_ID" />
        <result property="contractTitle" column="CONTRACT_TITLE" />      
        <result property="contractAmount" column="CONTRACT_AMOUNT" />
        <result property="contractStart" column="CONTRACT_START_DATE" />
        <result property="contractEnd" column="CONTRACT_END_DATE" />
    </resultMap>
    
    <select id="findContractAmendInfo" parameterType="String"
        resultMap="contractAmdList">
        SELECT PARENT_CONTRACT_ID,
		CONTRACT_TITLE,
        CONTRACT_AMOUNT,
        TO_CHAR(CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE,
        TO_CHAR(CONTRACT_END_DATE,'MM/DD/YYYY') AS CONTRACT_END_DATE
        FROM CONTRACT       
        WHERE
        CONTRACT_ID = #{asContractId}
    </select>
    
   
	<select id="fetchContractFinancialsMaxYear" parameterType="java.lang.String" resultType="int">
		SELECT MAX(FISCAL_YEAR_ID) FROM CONTRACT_FINANCIALS WHERE
		CONTRACT_ID = #{contractId}
	</select>
	
	 <insert id="addNextYearContractFinancialsZeroDollarAmd" parameterType="java.util.HashMap">
        Insert into CONTRACT_FINANCIALS 
        (CONTRACT_FINANCIALS_ID,
         PROCUREMENT_ID,
         CONTRACT_ID,
         UNIT_OF_APPROPRIATION,
         BUDGET_CODE,
         OBJECT_CODE,
         SUB_OBJECT_CODE,
         REPORTING_CATEGORY,
         FISCAL_YEAR_ID,
         AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
         LAST_UPDATE_DATE,
         ACTIVE_FLAG,
         PARENT_ID,
         CREATED_DATE,
         CREATED_BY_USERID,
         MODIFIED_DATE,
         MODIFIED_BY_USERID,
         APPROVED_BY,
         APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         PREVIOUS_AMOUNT,
         REPORTING_MODIFIED_DATE)        
		(Select 
		Seq_Contract_Financials_Id.Nextval,
		PROCUREMENT_ID , 
		CONTRACT_ID, 
		UNIT_OF_APPROPRIATION, 
		BUDGET_CODE, 
		OBJECT_CODE, 
		SUB_OBJECT_CODE,
		REPORTING_CATEGORY,
		#{nextFiscalYear},	
			0,
			DOCUMENT_IDENTIFIER_ID, 
			systimestamp, 
			1, 
			SEQ_CONTRACT_FINANCIALS_ID.currval, 
			systimestamp, 
			'system',
			systimestamp, 
			'system',
			APPROVED_BY,
         	APPROVED_DATE,
         	null,
         	null,
         	systimestamp
		From CONTRACT_FINANCIALS
		where CONTRACT_ID=#{contractId} 
		and FISCAL_YEAR_ID=
		(Select Max(FISCAL_YEAR_ID) 
		From CONTRACT_FINANCIALS 
		Where CONTRACT_ID=#{contractId}
		)
	 )
    </insert>
	
	 <insert id="addNextYearContractFinFundingStreamZeroDollarAmd" parameterType="java.util.HashMap">
       Insert into CONTRACT_FIN_FUNDING_STREAM 
		(CONTRACT_FUNDING_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 FEDERAL_AMOUNT,
		 STATE_AMOUNT,
		 CITY_AMOUNT,
		 OTHER_AMOUNT,
		 FISCAL_YEAR_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 PREVIOUS_FEDERAL_AMOUNT,
		 PREVIOUS_STATE_AMOUNT,
		 PREVIOUS_CITY_AMOUNT,
		 PREVIOUS_OTHER_AMOUNT,
 		 REPORTING_MODIFIED_DATE)				
		(Select SEQ_CONTRACT_FUNDING_ID.nextval,
		PROCUREMENT_ID,
		CONTRACT_ID, 	
		0,
		0,
		0,
		0,
		#{nextFiscalYear},
		systimestamp,
		1,
		systimestamp,
		'system',
		systimestamp,
		'system',
		null,
		null,
		null,
		null,
        systimestamp
		From CONTRACT_FIN_FUNDING_STREAM
		where CONTRACT_ID=#{contractId} 
		and FISCAL_YEAR_ID=
			(Select Max(FISCAL_YEAR_ID) 
			From CONTRACT_FIN_FUNDING_STREAM 
			Where CONTRACT_ID=#{contractId}
			)
	  )
    </insert>
     <!-- End R8.4.0 qc_8537 $0 Amendments do not appear in Amendment CoF task list after configuration -->
     
    <select id="findContractDetailsByContractForAmend" parameterType="String"
        resultMap="contractList1">
        SELECT CONTRACT.CONTRACT_TITLE,
        PROGRAM_MASTER.PROGRAM_ID,
        PROGRAM_MASTER.PROGRAM_NAME,
        CONTRACT.CONTRACT_AMOUNT,
        CONTRACT.CONTRACT_START_DATE,
        CONTRACT.CONTRACT_END_DATE
        FROM CONTRACT
        INNER JOIN PROGRAM_MASTER ON
        PROGRAM_MASTER.PROGRAM_ID =
        CONTRACT.PROGRAM_ID
        WHERE
        CONTRACT.CONTRACT_ID = #{asContractId}
    </select>

    <!-- changed query as part of build 3.1.0, enhancement id 5642-->
    <!-- Query modified as a part of release 3.10.0 enhancement 5686 -->
    <select id="validateRenewContractDetails" parameterType="String"
        resultType="int">
        SELECT COUNT(*)
        FROM
          ( SELECT DISTINCT(EXT_EPIN)
          FROM CONTRACT
          WHERE CONTRACT_TYPE_ID IN (1,2,3)
          AND STATUS_ID          != '69' AND STATUS_ID          != '165'
          and ext_epin is not null
          UNION
          SELECT DISTINCT(c.EXT_EPIN)
          FROM CONTRACT C
          INNER JOIN PROCUREMENT P
          ON C.PROCUREMENT_ID    = P.PROCUREMENT_ID
          AND C.CONTRACT_TYPE_ID = '5'
          AND P.STATUS_ID NOT   IN (7,8)
          AND C.STATUS_ID!='69' AND C.STATUS_ID!='165'
          and c.ext_epin is not null
          and (c.REUSE_EPIN IN ('Y') or  c.REUSE_EPIN is null)
          )
        WHERE ext_epin = #{asEPin}
    </select>

    <select id="validateProviderInAccelerator" parameterType="String"
        resultType="int">
        select count(*)
        from ORGANIZATION
        INNER JOIN REF_VENDOR_V ON REF_VENDOR_V.TIN = ORGANIZATION.EIN_ID_NN
        INNER JOIN REF_APT_EPIN_MASTER ON REF_VENDOR_V.VEND_CUST_CD =
        REF_APT_EPIN_MASTER.VENDOR_FMS_ID
        where REF_APT_EPIN_MASTER.VENDOR_FMS_ID = #{asVendorFmsId}
    </select>

    <!-- R6: Changes done for release 6 - non APT epins -->
    <!-- [Start] R7.3.0 QC9015 for Contract Renewal -->
    <insert id="renewContractDetails" parameterType="com.nyc.hhs.model.EPinDetailBean">
        INSERT INTO
        CONTRACT(
        CONTRACT_ID,
        CONTRACT_TYPE_ID,
        CONTRACT_SOURCE_ID,
        AGENCY_ID,
        PROGRAM_ID,
        CONTRACT_AMOUNT,
        STATUS_ID,
        REGISTRATION_FLAG,
        UPDATE_FLAG,
        LAST_UPDATE_DATE,
        CONTRACT_START_DATE,
        CONTRACT_END_DATE,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID,
        ORGANIZATION_ID,
        PARENT_CONTRACT_ID,
        CONTRACT_TITLE,
        PROCUREMENT_TITLE,
        EXT_EPIN,
        PROCUREMENT_ID,
        PROCUREMENT_METHOD,
        PROJECT_PROGRAM,
        DELETE_FLAG,
        DISCREPANCY_FLAG,
        REF_APT_EPIN_ID
        )
        values(
        #{contractId},
        #{contractTypeId},
        #{contractSourceId},
        #{agencyId},
        #{programId},
        #{contractValue},
        #{statusId},
        #{registrationFlag},
        #{updateFlag},
        current_timestamp,
        to_date(#{contractStart},'MM/DD/YYYY'),
        to_date(#{contractEnd},'MM/DD/YYYY'),
        current_timestamp,
        #{createByUserId},
        current_timestamp,
        #{createByUserId},
        ( select  DISTINCT ORGANIZATION_ID from ORGANIZATION
          INNER   JOIN   REF_VENDOR_V ON  REF_VENDOR_V.TIN = ORGANIZATION.EIN_ID_NN
          INNER   JOIN   REF_APT_EPIN_MASTER ON REF_VENDOR_V.VEND_CUST_CD =   REF_APT_EPIN_MASTER.VENDOR_FMS_ID
          where   REF_APT_EPIN_MASTER.VENDOR_FMS_ID = #{vendorFmsId}
   <!-- R7.3.0 : Add for filter out invalid epin from organization -->          
            and   ORGANIZATION.ORGANIZATION_ACTIVE_FLAG = 'true'
   <!-- R7.3.0 : Add for filter out invalid epin from organization -->
        ),
        #{parentContractId},
        #{contractTitle},
        #{procDescription},
        #{epinId},
        (SELECT NVL(PROCUREMENT_ID, NULL) AS FROM CONTRACT WHERE CONTRACT_ID =   #{parentContractId} AND CONTRACT_SOURCE_ID != #{contractSourceId}),
        #{procMethod},
        #{projProg},
        #{deleteFlag},
        #{discrepancyFlag},
        #{refAptEpinId}
        )
    </insert>
    <!-- [End] R7.3.0 QC9015 for Contract Renewal -->
    
    <!-- changed query as part of build 3.1.0, enhancement id 6020 -->
    <!-- R6: Added a new column in select query as part of release 6 - non APT epins -->
    <insert id="addNewContract" parameterType="com.nyc.hhs.model.EPinDetailBean">
        INSERT INTO CONTRACT(
        CONTRACT_ID,
        PARENT_CONTRACT_ID,
        CONTRACT_TYPE_ID,
        CONTRACT_SOURCE_ID,
        AGENCY_ID,
        PROGRAM_ID,
        CONTRACT_AMOUNT,
        STATUS_ID,
        REGISTRATION_FLAG,
        UPDATE_FLAG,
        LAST_UPDATE_DATE,
        CONTRACT_START_DATE,
        CONTRACT_END_DATE,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID,
        ORGANIZATION_ID,
        CONTRACT_TITLE,
        EXT_EPIN,
        PROCUREMENT_METHOD,
        PROJECT_PROGRAM,
        AWARD_AGENCY_ID,
        DISCREPANCY_FLAG,
        DELETE_FLAG,
        CERT_FUNDS_REQUIRED,
        BUDGET_START_YEAR,
        REF_APT_EPIN_ID
        )
        values(
        #{contractId,jdbcType=NUMERIC},
        #{contractId,jdbcType=NUMERIC},
        #{contractTypeId,jdbcType=NUMERIC},
        #{contractSourceId,jdbcType=NUMERIC},
        #{agencyId},
        #{programId,jdbcType=NUMERIC},
        #{contractValue,jdbcType=NUMERIC},
        #{statusId,jdbcType=NUMERIC},
        #{registrationFlag},
        #{updateFlag},
        current_timestamp,
        to_date(#{contractStart},'MM/DD/YYYY'),
        to_date(#{contractEnd},'MM/DD/YYYY'),
        current_timestamp,
        #{createByUserId},
        current_timestamp,
        #{createByUserId},
        (select DISTINCT ORGANIZATION_ID from ORGANIZATION
          INNER   JOIN  REF_VENDOR_V ON  REF_VENDOR_V.TIN = ORGANIZATION.EIN_ID_NN
          INNER   JOIN  REF_APT_EPIN_MASTER ON REF_VENDOR_V.VEND_CUST_CD =  REF_APT_EPIN_MASTER.VENDOR_FMS_ID
          where   REF_APT_EPIN_MASTER.VENDOR_FMS_ID = #{vendorFmsId}
            and   ORGANIZATION.ORGANIZATION_ACTIVE_FLAG = 'true'
        ),
        #{contractTitle},
        #{epinId},
        #{procMethod},
        #{projProg},
        #{awardAgencyId},
        #{discrepancyFlag},
        #{deleteFlag},
        #{chkContractCertFundsFlag},
        #{budgetStartYear,jdbcType=NUMERIC},
        #{refAptEpinId}
        )
    </insert>

    <select id="fetchContractConfTaskStatus" parameterType="hashmap"
        resultType="String">
        SELECT * FROM (SELECT PROC_STATUS_ID FROM
        CONTRACT_CONFIGURATION WHERE
        CONTRACT_ID = #{contractId} AND
        CONTRACT_TYPE_ID=#{contractTypeId}
        ORDER BY MODIFIED_DATE DESC) WHERE
        ROWNUM=1
    </select>

    <select id="fetchContractDisbursedAmount" parameterType="hashmap"
        resultType="String">
        SELECT SUM(PAYMENT_AMOUNT) AS CONTRACT_DISBURSED_AMOUNT FROM PAYMENT WHERE
        CONTRACT_ID=#{contractId} AND STATUS_ID=#{paymentStatusId}        
    </select>

    <select id="fetchContractBudgetStatus" parameterType="hashmap"
        resultType="String">
        SELECT * FROM (SELECT STATUS_ID FROM BUDGET WHERE
        CONTRACT_ID =
        #{contractId} AND BUDGET_TYPE_ID=#{budgetTypeId} AND ACTIVE_FLAG = '1' ORDER BY
        MODIFIED_DATE DESC) WHERE ROWNUM=1
    </select>
    
    <select id="fetchContractBudgetUpdateStatus" parameterType="hashmap"
        resultType="String">
        SELECT * FROM 
           (SELECT STATUS_ID FROM BUDGET WHERE CONTRACT_ID = 
           (select contract_id from contract  where parent_contract_id=#{contractId} and contract_id!=#{contractId} and contract_type_id= 4 and delete_flag=0)
            AND BUDGET_TYPE_ID=#{budgetTypeId} ORDER BY MODIFIED_DATE DESC) WHERE ROWNUM=1

    </select>
    
    <select id="fetchContractBudgetAmendmentStatus" parameterType="hashmap"
        resultType="int">
        SELECT count(STATUS_ID)
        FROM BUDGET
        WHERE CONTRACT_ID IN (
          (SELECT contract_id
          FROM contract
          WHERE parent_contract_id=#{contractId}
          AND contract_type_id    = 2
          AND delete_flag         = 0
          AND contract_amount     &lt; 0
          ))
        AND status_id IN (82,83,84)
    </select>

    <select id="fetchContractInvoiceStatus" parameterType="hashmap"
        resultType="String">
        SELECT STATUS_ID FROM INVOICE WHERE CONTRACT_ID =
        #{contractId}  and delete_flag = 0
    </select>

    <select id="fetchContractPaymentStatus" parameterType="hashmap"
        resultType="String">
        SELECT STATUS_ID FROM PAYMENT WHERE CONTRACT_ID =
        #{contractId}  and delete_flag = 0
    </select>

    <select id="getContractAmendmentAmmount" parameterType="hashmap"
        resultType="String">
        SELECT * FROM (SELECT CONTRACT_AMOUNT FROM CONTRACT WHERE
        CONTRACT_ID =
        ((select contract_id from contract  where parent_contract_id=#{contractId} and contract_id!=#{contractId} and contract_type_id= 2 and delete_flag=0 and status_id  = 61)) AND CONTRACT_TYPE_ID=#{contractTypeId}
        ORDER BY
        MODIFIED_DATE DESC) WHERE ROWNUM=1
    </select>

    <insert id="insertContractConfiguration" parameterType="hashmap">
        INSERT
        INTO CONTRACT_CONFIGURATION
        (
        CONTRACT_CONFIGURATION_ID,
        CONTRACT_ID,
        CONTRACT_TYPE_ID,
        BUDGET_ID,
        BUDGET_TYPE_ID,
        FISCAL_YEAR_ID,
        SUB_BUDGET_ID,
        PROC_STATUS_ID,
        PROC_USER,
        WORKFLOW_ID,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID
        )
        values
        (
        SEQ_CONTRACT_CONFIGURATION_ID.NEXTVAL,
        #{contractId,jdbcType=VARCHAR},
        #{contractTypeId,jdbcType=VARCHAR},
        #{budgetId,jdbcType=VARCHAR},
        #{budgetTypeId,jdbcType=VARCHAR},
        #{fiscalYearId,jdbcType=VARCHAR},
        #{subBudgetId,jdbcType=VARCHAR},
        #{procStatusId,jdbcType=VARCHAR},
        #{procUser,jdbcType=VARCHAR},
        #{workFlowId,jdbcType=VARCHAR},
        current_timestamp,
        #{submittedBy,jdbcType=VARCHAR},
        current_timestamp,
        #{submittedBy,jdbcType=VARCHAR}
        )
    </insert>

    <resultMap id="contractDetailsWF" type="com.nyc.hhs.model.FinancialWFBean">
        <result property="procurementTitle" column="PROCUREMENT_TITLE" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="procurementId" column="PROCUREMENT_ID" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="providerId" column="ORGANIZATION_ID" />
        <result property="contractNum" column="EXT_CT_NUMBER" />
        <result property="procEpin" column="EPIN" />
        <result property="awardEpin" column="EXT_EPIN" />
        <result property="programName" column="PROGRAM_NAME" />
        <result property="providerName" column="ORGANIZATION_LEGAL_NAME" />
    </resultMap>

    
    <select id="findContractDetailsByContractForWF" parameterType="String"
        resultMap="contractDetailsWF">
        SELECT A.CONTRACT_TITLE AS
        PROCUREMENT_TITLE,A.PROCUREMENT_ID,A.AGENCY_ID,A.ORGANIZATION_ID,A.EXT_CT_NUMBER,
        NVL(A.EXT_EPIN, 'N/A') AS EXT_EPIN,
        B.ORGANIZATION_LEGAL_NAME,
        C.PROGRAM_NAME,NVL(P.EPIN, 'N/A') AS EPIN
        FROM
        CONTRACT A,ORGANIZATION B,PROGRAM_MASTER C,PROCUREMENT P
        WHERE
        A.CONTRACT_ID= #{asContractId}
        AND A.ORGANIZATION_ID=B.ORGANIZATION_ID
        AND A.PROGRAM_ID=C.PROGRAM_ID
        AND P.PROCUREMENT_ID(+)= A.PROCUREMENT_ID
    </select>

    <!-- R6: Query modified as part of release 6 non APT epins -->
    <select id="findProcEpinR3ContractForWF" parameterType="String"
        resultMap="contractDetailsWF">
        select
        PROCUREMENT_AWARD_EPIN AS EPIN
        FROM
        REF_APT_EPIN_MASTER
        where
        REF_APT_EPIN_ID =(select PROCUREMENT_EPIN_ID
        from REF_APT_EPIN_MASTER
        where
        REF_APT_EPIN_ID = (select REF_APT_EPIN_ID
        from CONTRACT where CONTRACT_ID=#{contractId}
        ))
    </select>

    <select id="findProcurementDetailsForWF" parameterType="hashmap"
        resultMap="contractDetailsWF">
        SELECT
        A.PROCUREMENT_TITLE,
        A.EPIN,
        A.AGENCY_ID,
        A.PROCUREMENT_ID,
        C.PROGRAM_NAME
        FROM PROCUREMENT A,PROGRAM_MASTER C
        WHERE PROCUREMENT_ID =#{procurementId}
          AND A.PROGRAM_ID=C.PROGRAM_ID
    </select>

    <resultMap id="SequeneceID" type="java.lang.Integer">
        <result property="msSequenceID" column="CURRENTELEMENTID" />
    </resultMap>

    <select id="getContractSeqFromTable" resultMap="SequeneceID">
        SELECT
        SEQ_CONTRACT_ID.NEXTVAL CURRENTELEMENTID FROM DUAL    
    </select>

    <select id="renewalRecordExist" resultType="integer"
        parameterType="hashmap">
        SELECT count(1) FROM CONTRACT WHERE PARENT_CONTRACT_ID =
        #{contract_Id} AND STATUS_ID in
        <foreach item="item" index="index" collection="status_Id"
            open="(" separator="," close=")"> #{item}   </foreach>
        AND CONTRACT_TYPE_ID =
        #{contract_type_Id}
    </select>
    
    
    <!--[Start] QC9139 R7.7.0 :   -->
    <select id="renewalRecordExistForContractDropDown" resultType="String"  parameterType="hashmap">
        SELECT parent_contract_id FROM CONTRACT WHERE STATUS_ID in
        <foreach item="item" index="index" collection="status_Id"
            open="(" separator="," close=")"> #{item}   
        </foreach>
        AND CONTRACT_TYPE_ID in ( 1 , 3 )
        AND PARENT_CONTRACT_ID != CONTRACT_ID
        </select>
    <!--[End] QC9139 R7.7.0 :   -->

    <select id="getBudgetNotApprovedCount" parameterType="hashmap"
        resultType="int">
        SELECT count(1) FROM BUDGET WHERE parent_id IN(select budget_id from budget where contract_id = #{contractId} and delete_flag='0')
        AND
        BUDGET_TYPE_ID IN
        (#{budgetAmendment},#{budgetModification},#{budgetUpdate}) AND
        STATUS_ID!=#{budgetApproved} and delete_flag='0'
    </select>

    <select id="getNotApprovedInvoiceCount" parameterType="hashmap"
        resultType="int">
        SELECT count(1) FROM INVOICE WHERE
        CONTRACT_ID=#{contractId} AND
        STATUS_ID!=#{invoiceApproved} and delete_flag='0'
    </select>

    <select id="getNotDisbursedPaymentCount" parameterType="hashmap"
        resultType="int">
        SELECT count(1) FROM PAYMENT WHERE
        CONTRACT_ID=#{contractId} AND
        STATUS_ID!=#{paymentDisbursed} and delete_flag='0'
    </select>

    <update id="updateContractSuspendReason" parameterType="String">
        update
        contract set amendment_reason = 'reason' where contract_id =
        #{asContractId}
    </update>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3-->
    <!--   contract_id = #{asContractId} -->
    <select id="fetchAllContractId" parameterType="String" resultType="String"> 
    	select contract_id from contract 
    	where contract_id = #{asContractId} or (parent_contract_id = #{asContractId} and contract_type_id in (1,2,4))
    </select>
    

    <select id="fetchAllContractIdForUpdateCheck" parameterType="String" resultType="String"> 
        select contract_id from contract where parent_contract_id = #{asContractId} and contract_type_id in (2)
        and contract_amount &lt; 0
    </select>
    
    
    <!-- start release 3.14.0 -->
    <select id="fetchAllContractIdForNewFYCheck" parameterType="String" resultType="String"> 
        select contract_id from contract where parent_contract_id = #{asContractId} and contract_type_id in (2) and delete_flag=0
    </select>
    
    <select id="isNewFYCreatedWithMergedValuesWhenAmendmentIsRegInFMS" parameterType="String" resultType="int"> 
        select count(fiscal_year_id) from contract_financials where active_flag=0
        and contract_id in ((select contract_id from contract where ext_epin in (select distinct trkg_no from ref_contracts_h) and contract_id=#{asContractId} ))
    </select>
    <!-- end release 3.14.0 -->
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId} -->
    <select id="getAllContractIds" parameterType="hashmap" resultType="string"> 
    	select contract_id from contract 
    	where contract_id = #{ContractID} or (parent_contract_id = #{ContractID} and contract_type_id in (1,2,4)) and delete_flag='0'
    </select>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateContractSuspend" parameterType="hashmap">
        update
        (
        select
        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from contract
        where CONTRACT_ID in 
        (
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '1'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '2'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '3'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '4'
            AND delete_flag          = '0'        
        )
        ) upCon
        set upCon.PREV_STATUS_ID = upCon.status_id , upCon.status_id =
        #{lsSuspendContractStatusId}, upCon.MODIFIED_DATE = SYSTIMESTAMP,
        upCon.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upCon.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
     
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateBudgetSuspend" parameterType="hashmap">
        update
        (
        select
        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from budget
        where
        CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
        	  or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
        and status_id not in
        (#{lsBudgetApprovedStatusId},#{lsBudgetCancelledStatusId})
        ) upBud
        set upBud.PREV_STATUS_ID = upBud.status_id, upBud.status_id =
        #{lsSuspendBudgetStatusId}, upBud.MODIFIED_DATE = SYSTIMESTAMP,
        upBud.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upBud.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>

    <!-- Query modified as a part of release 3.1.0 for enhancement 6023  -->
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateInvoiceSuspend" parameterType="hashmap">
        update
        (
        select
        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from
        invoice
        where CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
        	  or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
        and status_id not in
        (#{lsInvoiceApprovedStatusId},#{lsInvoiceCancelledStatusId},#{lsInvoiceRejectedStatusId})
        ) upInv
        set upInv.PREV_STATUS_ID = upInv.STATUS_ID , upInv.status_id =
        #{lsSuspendInvoiceStatusId},upInv.MODIFIED_DATE = SYSTIMESTAMP,
        upInv.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upInv.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>

    <!-- Query modified as a part of release 3.1.0 for enhancement 6023  -->
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updatePaymentSuspend" parameterType="hashmap">
        update
        (
        select
        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from payment
        where CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
        and status_id not in
        (#{lsPaymentApprovedStatusId},#{lsPaymentDisbursedStatusId},#{lsPaymentCancelledStatusId},#{lsPaymentRejectedStatusId})
        ) upPay
        set upPay.PREV_STATUS_ID = upPay.STATUS_ID , upPay.status_id =
        #{lsSuspendPaymnetStatusId},upPay.MODIFIED_DATE = SYSTIMESTAMP,
        upPay.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upPay.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
    
    <resultMap id="auditDetails" type="com.nyc.hhs.model.PaymentSortAndFilter">
        <result property="paymentId" column="PAYMENT_ID" />
        <result property="invoiceId" column="INVOICE_ID" />
        <result property="budgetId" column="BUDGET_ID" />
        <result property="budgetTypeId" column="BUDGET_TYPE_ID" />
        <result property="contractId" column="CONTRACT_ID" />
        <result property="budgetAdvanceId" column="BUDGET_ADVANCE_ID" />
        <result property="statusId" column="status_id" />
        <result property="prevStatusId" column="PREV_STATUS_ID" />
    </resultMap>

    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectBudgetSuspend" parameterType="hashmap" resultMap="auditDetails">
        select
        BUDGET_ID,BUDGET_TYPE_ID,STATUS_ID as PREV_STATUS_ID,PREV_STATUS_ID as STATUS_ID  from budget
        where
        CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
        and status_id not in
        (#{lsBudgetApprovedStatusId},#{lsBudgetCancelledStatusId})
    </select>

    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectInvoiceSuspend" parameterType="hashmap"  resultMap="auditDetails">
        select
        INVOICE_ID,STATUS_ID as PREV_STATUS_ID,PREV_STATUS_ID as STATUS_ID  from
        invoice
        where CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR}and contract_type_id in (1,2,4))
        )
        and status_id not in
        (#{lsInvoiceApprovedStatusId},#{lsInvoiceCancelledStatusId})
    </select>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectPaymentSuspend" parameterType="hashmap" resultMap="auditDetails">
        select
        PAYMENT_ID,BUDGET_ADVANCE_ID,STATUS_ID as PREV_STATUS_ID,PREV_STATUS_ID as STATUS_ID  from payment
        where CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4,3))
        )
        and status_id not in
        (#{lsPaymentApprovedStatusId},#{lsPaymentDisbursedStatusId},#{lsPaymentCancelledStatusId})
    </select>
    
    <update id="updateContractReason" parameterType="hashmap">
        update contract
        set amendment_reason = #{asContractReason} where contract_id =
        #{asContractId,jdbcType=VARCHAR}
    </update>
     
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateContractUnsuspend" parameterType="hashmap">
        update
        (
        select STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from contract
        where status_id =
        #{lsSuspendContractStatusId}
        and CONTRACT_ID in 
        (
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '1'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '2'
            AND status_id            = '67'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '3'
            AND status_id            = '67'
            UNION ALL
            SELECT contract_id
            FROM contract
            WHERE parent_contract_id = #{asContractId,jdbcType=VARCHAR}
            AND contract_type_id     = '4'
            AND delete_flag          = '0'        
        )
        ) upCon
        set upCon.status_id =
        upCon.PREV_STATUS_ID , upCon.MODIFIED_DATE = SYSTIMESTAMP,
        upCon.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upCon.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateBudgetUnsuspend" parameterType="hashmap">
        update
        (
	        select
	        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from budget
	        where status_id =
	        #{lsSuspendBudgetStatusId} and
	        CONTRACT_ID in 
	        (
	        select contract_id from contract 
	        where contract_id = #{asContractId,jdbcType=VARCHAR}
	              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
	        )
        )upBud
        set upBud.status_id = upBud.PREV_STATUS_ID, upBud.MODIFIED_DATE = SYSTIMESTAMP,
        upBud.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upBud.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updateInvoiceUnsuspend" parameterType="hashmap">
        update
        (
	        select
	        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from
	        invoice
	        where status_id =
	        #{lsSuspendInvoiceStatusId}
	        and CONTRACT_ID in 
	        (
	        select contract_id from contract 
	        where contract_id = #{asContractId,jdbcType=VARCHAR}
	              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
	        )
        ) upInv
        set upInv.STATUS_ID = upInv.PREV_STATUS_ID,upInv.MODIFIED_DATE = SYSTIMESTAMP,
        upInv.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upInv.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <update id="updatePaymentUnsuspend" parameterType="hashmap">
        update
        (
	        select
	        STATUS_ID,PREV_STATUS_ID,MODIFIED_DATE,MODIFIED_BY_USERID,LAST_UPDATE_DATE from payment
	        where status_id =
	        #{lsSuspendPaymnetStatusId} and
	        CONTRACT_ID in 
	        (
	        select contract_id from contract 
	        where contract_id = #{asContractId,jdbcType=VARCHAR}
	              or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
	        )
        ) upPay
        set upPay.STATUS_ID = upPay.PREV_STATUS_ID,upPay.MODIFIED_DATE = SYSTIMESTAMP,
        upPay.LAST_UPDATE_DATE = SYSTIMESTAMP,
        upPay.MODIFIED_BY_USERID = #{modifiedByUserId}
    </update>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectBudgetUnsuspend" parameterType="hashmap" resultMap="auditDetails">
        select
        BUDGET_ID,BUDGET_TYPE_ID,STATUS_ID,PREV_STATUS_ID from budget
        where status_id =
        #{lsSuspendBudgetStatusId} and
        CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id = #{asContractId,jdbcType=VARCHAR}
        	  or (parent_contract_id = #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
    </select>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectInvoiceUnsuspend" parameterType="hashmap" resultMap="auditDetails">
        select
        INVOICE_ID,STATUS_ID,PREV_STATUS_ID from
        invoice
        where status_id =
        #{lsSuspendInvoiceStatusId}
        and CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id =  #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id =  #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
    </select>
    
    <!-- QC 7559 R 7.4.0 include renewal contract type 3 -->
    <!--   contract_id = #{asContractId,jdbcType=VARCHAR} -->
    <select id="selectPaymentUnsuspend" parameterType="hashmap" resultMap="auditDetails">
        select
        PAYMENT_ID,BUDGET_ADVANCE_ID,STATUS_ID,PREV_STATUS_ID from payment
        where status_id =
        #{lsSuspendPaymnetStatusId} and
        CONTRACT_ID in 
        (
        select contract_id from contract 
        where contract_id =  #{asContractId,jdbcType=VARCHAR}
              or (parent_contract_id =  #{asContractId,jdbcType=VARCHAR} and contract_type_id in (1,2,4))
        )
    </select>

    <resultMap id="newContractDetails" type="com.nyc.hhs.model.EPinDetailBean">
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="epinId" column="EXT_EPIN" />
        <result property="organizationId" column="ORGANIZATION_ID" />
        <result property="ctExtNum" column="EXT_CT_NUMBER" />
        <result property="createByUserId" column="CREATED_BY_USERID" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="procurementId" column="PROCUREMENT_ID" />
        <result property="contractId" column="CONTRACT_ID" />
    </resultMap>
    <select id="getDataWFbyContractId" parameterType="String"
        resultMap="newContractDetails">
        SELECT CONTRACT_TITLE,
        EXT_EPIN,
        ORGANIZATION_ID,
        EXT_CT_NUMBER,
        CREATED_BY_USERID,
        AGENCY_ID,
        PROCUREMENT_ID,
        CONTRACT_ID
        FROM CONTRACT WHERE CONTRACT_ID = #{asContractId}
    </select>
    
    <select id="validateAmendContract" parameterType="hashmap"
        resultType="integer">
        SELECT count(1) FROM CONTRACT WHERE
        PARENT_CONTRACT_ID = #{contract_Id}
        AND STATUS_ID in
        <foreach item="item" index="index" collection="status_Id"
            open="(" separator="," close=")"> #{item}   </foreach>
        AND
        CONTRACT_TYPE_ID = #{contract_type_Id}
    </select>

    <!-- R6: Changes made to query as part of release 6 non apt epins -->
    <insert id="amendContractDetails" parameterType="com.nyc.hhs.model.EPinDetailBean">
        INSERT INTO  CONTRACT(
        CONTRACT_ID,
        CONTRACT_TYPE_ID,
        CONTRACT_SOURCE_ID,
        AGENCY_ID,
        PROGRAM_ID,
        CONTRACT_AMOUNT,
        STATUS_ID,
        REGISTRATION_FLAG,
        UPDATE_FLAG,
        LAST_UPDATE_DATE,
        CONTRACT_START_DATE,
        CONTRACT_END_DATE,
        PROPOSED_CONTRACT_END_DATE,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID,
        ORGANIZATION_ID,
        PARENT_CONTRACT_ID,
        CONTRACT_TITLE,
        PROCUREMENT_TITLE,
        EXT_EPIN,
        PROCUREMENT_ID,
        PROCUREMENT_METHOD,
        PROJECT_PROGRAM,
        EXT_CT_NUMBER,
        AMENDMENT_REASON,
        DISCREPANCY_FLAG,
        DELETE_FLAG,
        PREV_CONTRACT_AMOUNT,
        REF_APT_EPIN_ID
        )
        values(
        #{contractId},
        #{contractTypeId},
        #{contractSourceId},
        (  SELECT agency_id  from contract where contract_id = #{parentContractId}),
        (  SELECT  PROGRAM_MASTER.PROGRAM_ID  FROM CONTRACT  
            INNER  JOIN PROGRAM_MASTER   ON  PROGRAM_MASTER.PROGRAM_ID =  CONTRACT.PROGRAM_ID
            WHERE  CONTRACT.CONTRACT_ID = #{parentContractId} ),
        #{amendValue},
        #{statusId},
        #{registrationFlag},
        #{updateFlag},
        SYSTIMESTAMP,
        to_date(#{amendmentStart},'MM/DD/YYYY'),
        to_date(#{amendmentEnd},'MM/DD/YYYY'),
        to_date(#{proposedContractEnd},'MM/DD/YYYY'),
        SYSTIMESTAMP,
        #{createByUserId},
        SYSTIMESTAMP,
        #{createByUserId},
        (select DISTINCT  ORGANIZATION_ID  from ORGANIZATION
          INNER JOIN   REF_VENDOR_V ON  REF_VENDOR_V.TIN = ORGANIZATION.EIN_ID_NN
          INNER JOIN   REF_APT_EPIN_MASTER ON REF_VENDOR_V.VEND_CUST_CD =   REF_APT_EPIN_MASTER.VENDOR_FMS_ID
          where   REF_APT_EPIN_MASTER.VENDOR_FMS_ID = #{vendorFmsId}
            and   ORGANIZATION.ORGANIZATION_ACTIVE_FLAG = 'true'
         ),
        #{parentContractId},
        #{contractTitle},
<!-- [Start] R9.5.0 QC9615  -->
        case when  (SELECT length( DESCRIPTION) FROM  REF_APT_EPIN_MASTER WHERE REF_APT_EPIN_ID =  #{refAptEpinId} ) > 120
             then  #{procDescription}
             else  (SELECT   DESCRIPTION FROM  REF_APT_EPIN_MASTER WHERE REF_APT_EPIN_ID = #{refAptEpinId} )
        end ,
<!--         (SELECT DESCRIPTION FROM  REF_APT_EPIN_MASTER WHERE REF_APT_EPIN_ID =  #{refAptEpinId}), -->
<!-- [End] R9.5.0 QC9615  -->
        #{epinId},
        (SELECT NVL(PROCUREMENT_ID,NULL) AS FROM CONTRACT WHERE  CONTRACT_ID = #{parentContractId} AND CONTRACT_SOURCE_ID != #{contractSourceId}),
        #{procMethod},
        #{projProg},
        (SELECT EXT_CT_NUMBER  FROM CONTRACT WHERE CONTRACT_ID = #{parentContractId}),
        #{amendmentReason},
        #{discrepancyFlag},
        #{deleteFlag},
        #{contractValue},
        #{refAptEpinId}
        )
    </insert>


    <select id="fetchCancelContractDetails" parameterType="String"
        resultType="hashmap">
        SELECT CONTRACT_SOURCE_ID, STATUS_ID, CONTRACT_TYPE_ID FROM
        CONTRACT WHERE CONTRACT_ID = #{contractId}
    </select>

    <!-- build 2.6.0, defect id 5683 -->
    <update id="updateContractBudgetStatus" parameterType="hashmap">
        UPDATE BUDGET SET PREV_STATUS_ID  = STATUS_ID, STATUS_ID = 89,MODIFIED_DATE = current_timestamp ,MODIFIED_BY_USERID =
        #{userId}
        WHERE CONTRACT_ID = #{contractId} AND BUDGET_TYPE_ID = 2
    </update>
    
    
    <select id="selectContractBudgetStatus" parameterType="hashmap" resultMap="auditDetails">
        select  BUDGET_ID,status_id,'89' as prev_status_id,BUDGET_TYPE_ID
        from  BUDGET WHERE CONTRACT_ID = #{contractId} AND BUDGET_TYPE_ID = 2
    </select>

    <select id="checkStatusForSusOrUnSus" parameterType="String"
        resultType="integer">
        select status_id from contract where contract_id =
        #{asContractId}
    </select>
    <!-- start release 3.14.0 -->
    <select id="isFYBudgetEntry" parameterType="map" resultType="int">
        SELECT count(1) from BUDGET where FISCAL_YEAR_ID= #{fiscalYear} and
        CONTRACT_ID = #{contractId} and BUDGET_TYPE_ID='2'
        and status_id !=106
    </select>
    <!-- end release 3.14.0 -->
    <select id="fetchContractSource" parameterType="java.lang.String"
        resultType="java.lang.String">
        SELECT contract_source_id from contract where CONTRACT_ID =
        #{asContractId}
    </select>

    <select id="fetchBudgetCount" parameterType="hashmap"
        resultType="int">
        select count(*)
        from BUDGET
        WHERE CONTRACT_ID = #{contractId}
        And Budget_Type_Id = (Select Budget_Type_Id From Budget_Type Where
        Budget_Type = 'Contract Budget')
        and ACTIVE_FLAG = 1
    </select>
    
    <!-- Queries for Batch Process Start -->
    
    <resultMap id="contractsForBatchProcessList" type="com.nyc.hhs.model.ContractBean">
        <result property="contractId" column="CONTRACT_ID" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="contractTypeId" column="CONTRACT_TYPE_ID" />
        <result property="contractAmount" column="CONTRACT_AMOUNT" />
        <result property="fmsContractAmount" column="FMS_CONTRACT_AMOUNT" />
        <result property="contractStartDate" column="CONTRACT_START_DATE" />
        <result property="fmsContractStartDate" column="FMS_CONTRACT_START_DATE" />
        <result property="contractEndDate" column="CONTRACT_END_DATE" />
        <result property="fmsContractEndDate" column="FMS_CONTRACT_END_DATE" />
        <result property="discrepancyFlag" column="DISCREPANCY_FLAG" />
        <result property="extCtNumber" column="EXT_CT_NUMBER" />
        <result property="organizationId" column="ORGANIZATION_ID" />
        <result property="agencyId" column="AGENCY_ID" />        
        <result property="budgetStartYear" column="BUDGET_START_YEAR" />
    </resultMap>

    <select id="fetchContractsForBatchProcess" parameterType="HashMap"    resultMap="contractsForBatchProcessList">
        SELECT 
        CONTRACT_ID, 
        CONTRACT_TITLE,
        CONTRACT_TYPE_ID, 
        CONTRACT_AMOUNT, 
        nvl(FMS_CONTRACT_AMOUNT, CONTRACT_AMOUNT) AS FMS_CONTRACT_AMOUNT, 
        CONTRACT_START_DATE, 
        nvl(FMS_CONTRACT_START_DATE, CONTRACT_START_DATE) AS FMS_CONTRACT_START_DATE, 
        nvl(FMS_CONTRACT_END_DATE, CONTRACT_END_DATE) AS FMS_CONTRACT_END_DATE, 
        CONTRACT_END_DATE,     
        DISCREPANCY_FLAG,
        EXT_CT_NUMBER,
        ORGANIZATION_ID,
        AGENCY_ID,
        BUDGET_START_YEAR
        FROM  
        CONTRACT 
        WHERE STATUS_ID = #{statusId} AND CONTRACT_TYPE_ID IN(1, 3, 5)
     </select>

     
     <resultMap id="approvedBudgetsOfContractList" type="com.nyc.hhs.model.ContractBudgetBean">
        <result property="budgetId" column="BUDGET_ID" />
        <result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />    
    </resultMap>

    <select id="getApprovedBudgetsOfContract" parameterType="HashMap"    resultMap="approvedBudgetsOfContractList">
        SELECT 
        BUDGET_ID, FISCAL_YEAR_ID
        FROM  
        BUDGET
        WHERE STATUS_ID = '86' AND CONTRACT_ID = #{contractID}
     </select>
     
     
     <resultMap id="amendmentContractsForBatchProcessList" type="com.nyc.hhs.model.ContractBean">
        <result property="contractId" column="CONTRACT_ID" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="contractTypeId" column="CONTRACT_TYPE_ID" />
        <result property="contractAmount" column="CONTRACT_AMOUNT" />
        <result property="fmsContractAmount" column="FMS_CONTRACT_AMOUNT" />
        <result property="contractStartDate" column="CONTRACT_START_DATE" />
        <result property="fmsContractStartDate" column="FMS_CONTRACT_START_DATE" />
        <result property="contractEndDate" column="CONTRACT_END_DATE" />
        <result property="fmsContractEndDate" column="FMS_CONTRACT_END_DATE" />
        <result property="discrepancyFlag" column="DISCREPANCY_FLAG" />        
        <result property="organizationId" column="ORGANIZATION_ID" />
        <result property="agencyId" column="AGENCY_ID" />        
        <result property="parentContractId" column="PARENT_CONTRACT_ID" />    
        <result property="parentContractTitle" column="PARENT_CONTRACT_TITLE" />
        <result property="parentContractAmount" column="PARENT_CONTRACT_AMOUNT" />
        <result property="parentContractStartDate" column="PARENT_CONTRACT_START_DATE" />
        <result property="parentContractEndDate" column="PARENT_CONTRACT_END_DATE" />    
        <result property="extCtNumber" column="EXT_CT_NUMBER" />    
        <result property="parentExtCtNumber" column="PARENT_EXT_CT_NUMBER" />        
        <result property="parentOrganizationId" column="PARENT_ORGANIZATION_ID" />
        <result property="parentAgencyId" column="PARENT_AGENCY_ID" />    
        <result property="awardEpin" column="EXT_EPIN" />    
        <result property="budgetStartYear" column="BUDGET_START_YEAR" />    
    </resultMap>

    <select id="fetchAmendmentContractsForBatchProcess" parameterType="HashMap"    resultMap="amendmentContractsForBatchProcessList">
        SELECT 
        AC.CONTRACT_ID, 
        AC.CONTRACT_TITLE,
        AC.CONTRACT_TYPE_ID, 
        AC.CONTRACT_AMOUNT,          
        nvl(AC.FMS_CONTRACT_AMOUNT, AC.CONTRACT_AMOUNT) AS FMS_CONTRACT_AMOUNT, 
        AC.CONTRACT_START_DATE, 
        nvl(AC.FMS_CONTRACT_START_DATE, AC.CONTRACT_START_DATE) AS FMS_CONTRACT_START_DATE, 
        AC.CONTRACT_END_DATE, 
        nvl(AC.FMS_CONTRACT_END_DATE, AC.CONTRACT_END_DATE) AS FMS_CONTRACT_END_DATE,
        AC.PARENT_CONTRACT_ID,    
        PC.CONTRACT_TITLE AS PARENT_CONTRACT_TITLE,
        PC.CONTRACT_AMOUNT AS PARENT_CONTRACT_AMOUNT,
        PC.CONTRACT_START_DATE AS PARENT_CONTRACT_START_DATE, 
        PC.CONTRACT_END_DATE AS PARENT_CONTRACT_END_DATE,
        AC.DISCREPANCY_FLAG,
        AC.EXT_CT_NUMBER AS EXT_CT_NUMBER,
        PC.EXT_CT_NUMBER AS PARENT_EXT_CT_NUMBER,
        AC.ORGANIZATION_ID,
        AC.AGENCY_ID,
        ac.BUDGET_START_YEAR,
        PC.ORGANIZATION_ID AS PARENT_ORGANIZATION_ID,
        PC.AGENCY_ID AS PARENT_AGENCY_ID,
        PC.EXT_EPIN AS EXT_EPIN
        FROM  
        CONTRACT AC
        LEFT JOIN CONTRACT PC ON AC.PARENT_CONTRACT_ID=PC.CONTRACT_ID
        WHERE AC.STATUS_ID = #{statusId} AND AC.CONTRACT_TYPE_ID = 2 
        and AC.DELETE_FLAG != 1
     </select>
     
     
<!--[Start] R7.12.1 QC9314 Amendment Double merge -->
    <update id="setAmendmentStatusAsRegistered" parameterType="HashMap">
        UPDATE CONTRACT 
        SET    STATUS_ID = 62 
               , DELETE_FLAG = 1
               , MODIFIED_DATE = SYSTIMESTAMP 
               , MODIFIED_BY_USERID = 'system'
        WHERE  CONTRACT_TYPE_ID = 2
        AND    REQUEST_PARTIAL_MERGE = 2
        AND    STATUS_ID= 118 
        AND    CONTRACT_ID  IN  ( SELECT CONTRACT_ID 
                                    FROM ( SELECT   DISTINCT BB.CONTRACT_ID ,
									                ( SELECT COUNT(IB.BUDGET_ID) FROM BUDGET IB WHERE IB.CONTRACT_ID =  BB.CONTRACT_ID 
									                )AS AMD_FY_CNT ,
									                ( SELECT SUM( IB1.FISCAL_YEAR_AMOUNT ) FROM BUDGET IB1 WHERE IB1.CONTRACT_ID =  BB.CONTRACT_ID  
									                ) AS SUM_AMOUNT,
									                ( SELECT  IB2.FISCAL_YEAR_AMOUNT  
									                    FROM  BUDGET IB2 WHERE IB2.CONTRACT_ID =  BB.CONTRACT_ID  
									                     AND  IB2.FISCAL_YEAR_ID  = (SELECT MAX(IB3.FISCAL_YEAR_ID) 
									                                                   FROM BUDGET IB3 WHERE IB3.CONTRACT_ID =  BB.CONTRACT_ID  
									                                                 )
									                 ) MAX_FY_AMT
									      FROM  BUDGET  BB
									      WHERE  BB.CONTRACT_ID IN ( SELECT CONTRACT_ID FROM CONTRACT 
									                                  WHERE  CONTRACT_TYPE_ID = 2
									                                    AND    REQUEST_PARTIAL_MERGE = 2
									                                    AND    STATUS_ID= 118 
									                                )
									     )
									WHERE AMD_FY_CNT = 1
									AND SUM_AMOUNT = MAX_FY_AMT
				                )
	</update>
	<update id="setBudgetFromAmendStatusAsActive" parameterType="HashMap">
        UPDATE BUDGET 
        SET    STATUS_ID = 85 
               , MODIFIED_DATE = SYSTIMESTAMP 
               , MODIFIED_BY_USERID = 'system'
        WHERE  BUDGET_ID IN ( SELECT    bug.BUDGET_ID 
								FROM BUDGET bug
								INNER JOIN ( SELECT   CONTRACT_ID,  max(FISCAL_YEAR_ID) AS FISCAL_YEAR_ID
								               FROM   BUDGET
								              WHERE   CONTRACT_ID IN ( SELECT    PARENT_CONTRACT_ID FROM  CONTRACT   
								                                        WHERE    CONTRACT_TYPE_ID = 2
								                                          AND    REQUEST_PARTIAL_MERGE = 2
								                                          AND    STATUS_ID= 118  
								                                     )
								               group by BUDGET.CONTRACT_ID                           
								            ) MAX_FIS 
								ON BUG.CONTRACT_ID = MAX_FIS.CONTRACT_ID AND BUG.FISCAL_YEAR_ID = MAX_FIS.FISCAL_YEAR_ID
								WHERE   bug.CONTRACT_ID IN ( SELECT    PARENT_CONTRACT_ID FROM  CONTRACT
								                              WHERE    CONTRACT_TYPE_ID = 2
								                                AND    REQUEST_PARTIAL_MERGE = 2
								                                AND    STATUS_ID= 118  
								                           )
								AND     bug.BUDGET_TYPE_ID  = 2
								AND     bug.STATUS_ID       = 86
                             )
        AND    BUDGET_TYPE_ID = 2
        AND    STATUS_ID = 86
	</update>
<!--[End] R7.12.0 QC9314  Amendment Double merge -->

     
     
     <update id="setContractStatusAsRegistered" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET STATUS_ID='62'
        <if test="contractTypeId == 2">            
            , DELETE_FLAG = '1'
        </if>
         WHERE CONTRACT_ID=#{contractId}
     </update>
     
     <!-- R6 APT Interface starts -->
     <update id="setContractStatusAsRegisteredForCOF" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET STATUS_ID=#{statusId}
         WHERE CONTRACT_ID=#{contractId}
     </update>
     
     <update id="setContractStatusAsRegisteredForAmendmentCOF" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET STATUS_ID=#{statusId}
         WHERE CONTRACT_ID=#{contractId}
     </update> 
     <!-- R6 APT Interface ends -->
     
     <update id="batchUpdateBudgetModificationAndUpdateStatus" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE BUDGET SET STATUS_ID='8' WHERE 
        (
        (BUDGET_TYPE_ID = 3 AND STATUS_ID IN('1', '2', '3')) 
        OR 
        (BUDGET_TYPE_ID = 4 AND STATUS_ID = '3')
        ) AND CONTRACT_ID=#{contractId}
    </update>
     
     <update id="resetDiscrepancyStatus" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET 
        DISCREPANCY_FLAG='0'
        WHERE 
        CONTRACT_ID=#{contractId}
    </update>         
     
     <update id="removeContractDiscrepancies" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET    
        <if test="contractTypeId == 2">            
            CONTRACT_START_DATE=#{fmsContractStartDate, jdbcType=DATE}, 
            CONTRACT_END_DATE=#{fmsContractStartDate, jdbcType=DATE}
        </if>
        <if test="contractTypeId != 2">    
            CONTRACT_START_DATE=NVL(FMS_CONTRACT_START_DATE, CONTRACT_START_DATE), 
            CONTRACT_END_DATE=NVL(FMS_CONTRACT_END_DATE,CONTRACT_END_DATE)
        </if>
        WHERE 
        <if test="contractTypeId == 2">            
            CONTRACT_ID=#{parentContractId}
        </if>
        <if test="contractTypeId != 2">    
            CONTRACT_ID=#{contractId}
        </if>        
     </update>
    <!-- Start R8.4.0 qc_8537 $0 Amendments do not appear in Amendment CoF task list after configuration -->
     <update id="mergeAmendmentDatesInBaseContract" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET
		        CONTRACT_END_DATE=#{contractEndDate, jdbcType=DATE},
		        MODIFIED_DATE = systimestamp
        WHERE   CONTRACT_ID=#{parentContractId}                
     </update>
	<!-- End R8.4.0 qc_8537 $0 Amendments do not appear in Amendment CoF task list after configuration -->
     <update id="removeContractDiscrepancyAndMarkRegistered" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET 
        DISCREPANCY_FLAG='0', 
        CONTRACT_AMOUNT=NVL(FMS_CONTRACT_AMOUNT, CONTRACT_AMOUNT), 
        CONTRACT_START_DATE=NVL(FMS_CONTRACT_START_DATE, CONTRACT_START_DATE), 
        CONTRACT_END_DATE=NVL(FMS_CONTRACT_END_DATE,CONTRACT_END_DATE), 
        STATUS_ID='62' 
        <if test="contractTypeId == 2">            
            , DELETE_FLAG = '1'
        </if>
        WHERE 
        CONTRACT_ID=#{contractId}
    </update><!--
     
     <update id="closeBudgetModificationTask" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE BUDGET SET ACTIVE_FLAG = '0' WHERE 
        <if test="contractTypeId == 2">    
        CONTRACT_ID=#{parentContractId} 
        </if>
        <if test="contractTypeId != 2">    
        CONTRACT_ID=#{contractId} 
        </if>        
        AND BUDGET_TYPE_ID ='3' AND ACTIVE_FLAG = '1'
    </update>
    
    
    --><!--
    <update id="updateParentContractForNegAmend" parameterType="com.nyc.hhs.model.ContractBean">
        UPDATE CONTRACT SET        
        CONTRACT_AMOUNT=#{fmsContractAmountAfterMerge},
        CONTRACT_START_DATE=#{fmsContractStartDate, jdbcType=DATE},
        CONTRACT_END_DATE=#{fmsContractEndDate, jdbcType=DATE}
        WHERE 
        CONTRACT_ID=#{parentContractId}
    </update>
    -->
    
    <resultMap id="contractBudgetsList" type="com.nyc.hhs.model.ContractBudgetBean">
        <result property="budgetId" column="BUDGET_ID" />    
        <result property="statusId" column="STATUS_ID" />            
        <result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
        <result property="totalbudgetAmount" column="FISCAL_YEAR_AMOUNT" />
    </resultMap>
    
    <select id="fetchContractBudgets" parameterType="HashMap"    resultMap="contractBudgetsList">
        SELECT 
        BUDGET_ID,
        STATUS_ID     
        FROM  
        BUDGET        
        WHERE CONTRACT_ID = #{contractID}
         <!-- start release 3.14.0 -->
         and active_flag=1
         <!-- end release 3.14.0 -->
     </select>    

    <update id="deleteFiscalYear" parameterType="HashMap">
        UPDATE  CONTRACT_FINANCIALS SET ACTIVE_FLAG = '0' WHERE CONTRACT_ID=#{contractID} AND FISCAL_YEAR = #{fiscalYear}
    </update>    

    <!-- build 2.6.0, defect id 5683 -->
    <update id="markApprovedBudgetsAsActive" parameterType="HashMap">
        UPDATE BUDGET SET
        PREV_STATUS_ID  = STATUS_ID,
        STATUS_ID = '85' 
        <!-- changes for agency outbound interafce 6641 -->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID=#{modifyBy}
        WHERE 
        STATUS_ID = '86' AND CONTRACT_ID=#{contractID}
    </update>    
    
    <update id="updateBudgetsExtCtNumber" parameterType="HashMap">
        UPDATE BUDGET SET
        CT_NUMBER = #{extCtNumber} 
        WHERE 
        CONTRACT_ID=#{contractID}
    </update>    
    
    
    <resultMap type="com.nyc.hhs.model.ContractFinancialBean" id="ContractConfigFinancialUpdate">
                <result property="contractId" column="CONTRACT_ID"></result>
                <result property="contractFinancialId" column="CONTRACT_FINANCIALS_ID"></result>
                <result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION"></result>
                <result property="objectCode" column="OBJECT_CODE"></result>
                <result property="budgetCode" column="BUDGET_CODE"></result>
                <result property="fiscalYear" column="FISCAL_YEAR_ID"></result>
                <result property="procurementId" column="PROCUREMENT_ID"></result>
                <result property="activeFlag" column="ACTIVE_FLAG"></result>
                <result property="ammount" column="AMOUNT"></result>
                <result property="parentId" column="PARENT_ID"></result>
                <result property="subOc" column="SUB_OBJECT_CODE"></result>
                <result property="rc" column="REPORTING_CATEGORY"></result>
                <result property="createByUserId" column="CREATED_BY_USERID"></result>
                <result property="modifyByUserId" column="MODIFIED_BY_USERID"></result>
                <result property="modDate" column="MODIFIED_DATE"></result>
    </resultMap>
    
    <select id="fetchedContractFinancialDetails" parameterType="HashMap"  resultMap="ContractConfigFinancialUpdate">
        SELECT
             CONTRACT_FINANCIALS_ID,
             CONTRACT_ID,
             UNIT_OF_APPROPRIATION,
             BUDGET_CODE,
             OBJECT_CODE,
             SUB_OBJECT_CODE,
             REPORTING_CATEGORY,
             FISCAL_YEAR_ID,
             AMOUNT,
             parent_id,
             PROCUREMENT_ID,
             ACTIVE_FLAG,
             CREATED_BY_USERID,
             MODIFIED_BY_USERID,
             MODIFIED_DATE
            FROM CONTRACT_FINANCIALS
              WHERE
            CONTRACT_ID = #{contractID} AND FISCAL_YEAR_ID = #{fiscalYear} AND active_flag='1'
    </select>
    
    <!-- build 3.1.0, defect id 6398 -->
    <select id="fetchedContractFinancialDetailsBatch" parameterType="String"  resultMap="ContractConfigFinancialUpdate">
        SELECT
             CONTRACT_FINANCIALS_ID,
             CONTRACT_ID,
             UNIT_OF_APPROPRIATION,
             BUDGET_CODE,
             OBJECT_CODE,
             SUB_OBJECT_CODE,
             REPORTING_CATEGORY,
             FISCAL_YEAR_ID,
             AMOUNT,
             parent_id,
             PROCUREMENT_ID,
             ACTIVE_FLAG,
             CREATED_BY_USERID,
             MODIFIED_BY_USERID,
             MODIFIED_DATE
            FROM CONTRACT_FINANCIALS
              WHERE
            CONTRACT_ID = #{contractID} AND active_flag='1'
    </select>
    
    
    <resultMap id="resultMapBaseContractDetailsForUpdate" type="com.nyc.hhs.model.EPinDetailBean" >
        <result property="contractId" column="CONTRACT_ID" />
        <result property="contractSourceId" column="CONTRACT_SOURCE_ID" />
        <result property="agencyId" column="AGENCY_ID" />
        <result property="programId" column="PROGRAM_ID" />
        <result property="createByUserId" column="CREATED_BY_USERID" />
        <result property="organizationId" column="ORGANIZATION_ID" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="epinId" column="EXT_EPIN" />
    </resultMap>
    
    <select id="fetchBaseContractDetailsForUpdate" parameterType="HashMap"  resultMap="resultMapBaseContractDetailsForUpdate">
        SELECT
            CONTRACT_ID,
            CONTRACT_SOURCE_ID,
            AGENCY_ID,
            PROGRAM_ID,
            CREATED_BY_USERID,
            ORGANIZATION_ID,
            CONTRACT_TITLE,
            EXT_EPIN
            FROM CONTRACT
              WHERE
            CONTRACT_ID = #{contractID}
    </select>
    
    <!--<insert id="addNewContractForUpdate" parameterType="com.nyc.hhs.model.EPinDetailBean">
        INSERT INTO CONTRACT(
        CONTRACT_ID,
        PARENT_CONTRACT_ID,
        CONTRACT_TYPE_ID,
        CONTRACT_SOURCE_ID,
        AGENCY_ID,
        PROGRAM_ID,
        CONTRACT_AMOUNT,
        STATUS_ID,
        REGISTRATION_FLAG,
        UPDATE_FLAG,
        LAST_UPDATE_DATE,
        CONTRACT_START_DATE,
        CONTRACT_END_DATE,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID,
        ORGANIZATION_ID,
        CONTRACT_TITLE,
        EXT_EPIN,        
        DISCREPANCY_FLAG,
        DELETE_FLAG
        )
        values(
        #{contractId},
        #{parentContractId},
        4,
        #{contractSourceId},
        #{agencyId},
        #{programId},
        #{contractValue},
        59,
        '0',
        '0',
        current_timestamp,
        to_date(#{contractStart},'MM/DD/YYYY'),
        to_date(#{contractEnd},'MM/DD/YYYY'),
        current_timestamp,
        #{createByUserId},
        current_timestamp,
        #{createByUserId},
        #{organizationId},
        #{contractTitle},
        #{epinId},        
        '0',
        '0'        
        )
    </insert>
    
    
    
    -->
    <!-- R6: Added extra field REF_APT_EPIN_ID in insert -->
    <insert id="addNewContractForUpdate" parameterType="com.nyc.hhs.model.EPinDetailBean">
    insert into contract
        (CONTRACT_ID,CONTRACT_TYPE_ID,PROCUREMENT_ID,CONTRACT_SOURCE_ID,PROCUREMENT_TITLE,
        CONTRACT_TITLE,AGENCY_ID,ORGANIZATION_ID,EXT_CT_NUMBER,EXT_EPIN,PROGRAM_ID,CONTRACT_AMOUNT,STATUS_ID,EXT_COMMODITY_CODE,
        EXT_REGISTRATION_DATE,EXT_DOC_VERSION,REGISTRATION_FLAG,UPDATE_FLAG,LAST_UPDATE_DATE,CONTRACT_START_DATE,CONTRACT_END_DATE,
        AMENDMENT_REASON,PREV_STATUS_ID,PROCUREMENT_METHOD,PROJECT_PROGRAM,AWARD_AGENCY_ID,PARENT_CONTRACT_ID,DELETE_FLAG,
        DISCREPANCY_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID, REF_APT_EPIN_ID)
        (select
        #{contractId},4,PROCUREMENT_ID,CONTRACT_SOURCE_ID,PROCUREMENT_TITLE,CONTRACT_TITLE,AGENCY_ID,
        ORGANIZATION_ID,EXT_CT_NUMBER,EXT_EPIN,PROGRAM_ID,#{contractValue,jdbcType=NUMERIC},59,EXT_COMMODITY_CODE,
        EXT_REGISTRATION_DATE,EXT_DOC_VERSION,REGISTRATION_FLAG,UPDATE_FLAG,LAST_UPDATE_DATE,#{contractStartDate, jdbcType=DATE},
        #{contractEndDate, jdbcType=DATE},AMENDMENT_REASON,PREV_STATUS_ID,PROCUREMENT_METHOD,PROJECT_PROGRAM,AWARD_AGENCY_ID,
        #{parentContractId},'0','0',current_timestamp,CREATED_BY_USERID,current_timestamp,MODIFIED_BY_USERID, REF_APT_EPIN_ID
        from CONTRACT
        where CONTRACT_ID = #{parentContractId})
        
    </insert>
        
    <select id="getContractL2Providers" parameterType="HashMap" resultType="String">
        SELECT 
        STAFF_ID AS PROVIDER_ID
        FROM 
        STAFF_DETAILS SDETAIL 
        LEFT JOIN 
        CONTRACT CONT 
        ON SDETAIL.ORGANIZATION_ID = CONT.ORGANIZATION_ID 
        WHERE 
        CONTRACT_ID =  #{contractID} 
        AND 
        SDETAIL.PERMISSION_LEVEL = 'Level 2'
    </select>
        
    <select id="getContractAgencyUsers" parameterType="HashMap" resultType="String">
        SELECT USER_ID 
        FROM 
        city_user_details 
        WHERE 
        user_type = 'agency_org' 
        AND  
        organization_name = (SELECT AGENCY_ID FROM  CONTRACT WHERE CONTRACT_ID = #{contractID} ) 
        AND 
        UPPER(USER_ROLE) in ('FINANCE_MANAGER', 'FINANCE MANAGER')
        AND
        ACTIVE_FLAG = 1
    </select>
        
        
    <resultMap id="contractUpdateRecord" type="com.nyc.hhs.model.ContractBean">
        <result property="contractId" column="CONTRACT_ID" />    
    </resultMap>
        
        
    <select id="getUpdateTypeContractRecord" parameterType="HashMap" resultMap="contractUpdateRecord">
        SELECT CONTRACT_ID 
        FROM CONTRACT 
        WHERE 
        PARENT_CONTRACT_ID=#{contractID} AND 
        CONTRACT_TYPE_ID='2' AND 
        DELETE_FLAG='0' ORDER BY MODIFIED_DATE
    </select>
             
    
    <!-- Queries for Batch Process End -->
    
    
    <insert id="insertFetchedContractFinancialDetails" parameterType="com.nyc.hhs.model.ContractFinancialBean">
        Insert into CONTRACT_FINANCIALS 
        (CONTRACT_FINANCIALS_ID,
         PROCUREMENT_ID,
         CONTRACT_ID,
         UNIT_OF_APPROPRIATION,
         BUDGET_CODE,
         OBJECT_CODE,
         SUB_OBJECT_CODE,
         REPORTING_CATEGORY,
         FISCAL_YEAR_ID,
         AMOUNT,
         LAST_UPDATE_DATE,
         ACTIVE_FLAG,
         PARENT_ID,
         CREATED_DATE,
         CREATED_BY_USERID,
         MODIFIED_DATE,
         MODIFIED_BY_USERID)
         values 
        
        (SEQ_CONTRACT_FINANCIALS_ID.nextval,
        #{procurementId ,jdbcType=NUMERIC},
        #{contractId},
        #{unitOfAppropriation},
        #{budgetCode},
        #{objectCode},
        #{subOc},
        #{rc},
        #{fiscalYear},
        #{ammount},
        SYSTIMESTAMP,
        #{activeFlag},
        <choose>
            <when test="contractFinancialId != null and contractFinancialId!=''">
            #{contractFinancialId},
            </when>
            <otherwise>
            SEQ_CONTRACT_FINANCIALS_ID.currval,
            </otherwise>
        </choose>
        SYSTIMESTAMP,
        #{createByUserId},
        <choose>
            <when test="modDate != null and modDate!=''">
            #{modDate},
            </when>
            <otherwise>
            SYSTIMESTAMP,
            </otherwise>
        </choose>
        #{modifyByUserId})
    </insert>

    <!-- build 3.1.0, defect id 6398 -->
    <insert id="insertFetchedContractFinancialDetailsBatch" parameterType="com.nyc.hhs.model.ContractFinancialBean">
        Insert into CONTRACT_FINANCIALS 
        (CONTRACT_FINANCIALS_ID,
         PROCUREMENT_ID,
         CONTRACT_ID,
         UNIT_OF_APPROPRIATION,
         BUDGET_CODE,
         OBJECT_CODE,
         SUB_OBJECT_CODE,
         REPORTING_CATEGORY,
         FISCAL_YEAR_ID,
         AMOUNT,
         LAST_UPDATE_DATE,
         ACTIVE_FLAG,
         PARENT_ID,
         CREATED_DATE,
         CREATED_BY_USERID,
         MODIFIED_DATE,
         MODIFIED_BY_USERID)
         values 
        
        (SEQ_CONTRACT_FINANCIALS_ID.nextval,
        #{procurementId ,jdbcType=NUMERIC},
        #{contractId},
        #{unitOfAppropriation},
        #{budgetCode},
        #{objectCode},
        #{subOc},
        #{rc},
        #{fiscalYear},
        #{ammount},
        SYSTIMESTAMP,
        #{activeFlag},
        #{parentId , jdbcType=VARCHAR},
        SYSTIMESTAMP,
        #{createByUserId},
        SYSTIMESTAMP,
        #{modifyByUserId})
    </insert>

    <select id="fetchBaseAmendmentContractDetails" parameterType="String"
        resultMap="contractsList">
        select CONTRACT_ID, EXT_EPIN, CONTRACT_START_DATE, CONTRACT_END_DATE,contract_type_id
        from   ( select   A.PARENT_CONTRACT_ID AS CONTRACT_ID,A.EXT_EPIN, A.CONTRACT_START_DATE, A.CONTRACT_END_DATE,A.CONTRACT_TYPE_ID 
                   from   CONTRACT A,CONTRACT B 
                  WHERE   A.PARENT_CONTRACT_ID = ( <include refid="fetchParentContractId"/> ) 
                   and   ( B.CERT_FUNDS_REQUIRED IS NULL OR B.CERT_FUNDS_REQUIRED = '1') 
                   and    A.PARENT_CONTRACT_ID = B.CONTRACT_ID 
                   and    A.CONTRACT_TYPE_ID = 6 
                 UNION ALL 
                 select B.CONTRACT_ID AS CONTRACT_ID, B.EXT_EPIN AS EXT_EPIN , 
                        (select CONTRACT_START_DATE from CONTRACT 
                          WHERE CONTRACT_ID = ( <include refid="fetchParentContractId"/> )
                         ) as CONTRACT_START_DATE , 
                         B.PROPOSED_CONTRACT_END_DATE,CONTRACT_TYPE_ID 
                 from  CONTRACT_FINANCIALS A, CONTRACT B 
                 where  A.CONTRACT_ID = B.CONTRACT_ID 
                 and A.CONTRACT_ID in (select   CONTRACT_ID from CONTRACT 
                                        where   PARENT_CONTRACT_ID = ( <include refid="fetchParentContractId"/> ) 
                                          and   CONTRACT_TYPE_ID = '2') 
                                          and   a.APPROVED_BY is not null 
                 group by b.CONTRACT_ID,EXT_EPIN,CONTRACT_START_DATE,PROPOSED_CONTRACT_END_DATE,CONTRACT_AMOUNT,CONTRACT_TYPE_ID 
               ) 
    </select>

    <sql id="fetchParentContractId">
    select decode(CONTRACT_TYPE_ID, 3, CONTRACT_ID,  PARENT_CONTRACT_ID ) from CONTRACT where CONTRACT_ID = #{asContractId}
    </sql>
    
    <select id="fetchBaseAmendmentContractDetailsAmendmentList" parameterType="hashMap"
        resultMap="contractsList">
        select b.CONTRACT_ID as CONTRACT_ID, b.EXT_EPIN as EXT_EPIN ,
        (select CONTRACT_START_DATE from CONTRACT WHERE contract_id = #{asContractId}) as
        CONTRACT_START_DATE , b.PROPOSED_CONTRACT_END_DATE as CONTRACT_END_DATE
        from contract_financials a, contract b
        where
        a.CONTRACT_ID = b.CONTRACT_ID and
        a.CONTRACT_ID in (select contract_id from contract where parent_contract_id = #{asContractId}
        AND contract_id = #{asAmendContractId}
        AND contract_type_id = '2')
        and a.APPROVED_BY is not null 
        group by
        b.CONTRACT_ID,EXT_EPIN,CONTRACT_START_DATE,PROPOSED_CONTRACT_END_DATE
    </select>
    
    <select id="fetchBaseAwardEpin" parameterType="String"
        resultType="java.lang.String">
        select EXT_EPIN
        from 
        CONTRACT
        WHERE 
        contract_id = #{asContractId}
    </select>
    
  <select id="renewContractDateValidation" parameterType="java.lang.String" resultType="java.lang.String">
          SELECT TO_CHAR(CONTRACT_END_DATE,'MM/DD/YYYY') FROM CONTRACT WHERE CONTRACT_ID = #{aoContractId}
  </select>
  
   <select id="fetchNewFYTaskDaysValue" resultType="int">
      SELECT SETTINGS_VALUE FROM APPLICATION_SETTINGS WHERE COMPONENT_NAME ='NewFYTask' AND SETTINGS_NAME = 'DurationInDays'
   </select> 
  
   <!-- BEGIN Rel 3.15.0 ; QC 6797. Added filtering on STATUS_ID=106, so as to apply only for Out-Years. -->
  <select id="fetchLastFYConfigured" parameterType="String" resultType="java.lang.Integer">
    select FISCAL_YEAR_ID from
    (select FISCAL_YEAR_ID from BUDGET where CONTRACT_ID = #{asContractId} and
    			BUDGET_TYPE_ID='2'
                and status_id = 106
                order by FISCAL_YEAR_ID desc) 
        where rownum = 1
    </select>
   <!-- END Rel 3.15.0 ; QC 6797-->
    
    <!-- release 3.14.0 -->
    <select id="fetchLastFYConfiguredNextNewFy" parameterType="String" resultType="java.lang.Integer">
    select FISCAL_YEAR_ID from
    (select FISCAL_YEAR_ID from BUDGET where CONTRACT_ID = #{asContractId} and
    BUDGET_TYPE_ID='2' and status_id!=106
    order by FISCAL_YEAR_ID desc) where rownum = 1
    </select>
    <!-- release 3.14.0 -->
    <select id="fetchContractInfo" parameterType="String"
    resultType="hashmap">
        SELECT  MAX(con1.CONTRACT_TYPE_ID)AS CONTRACT_TYPE_ID ,
        MAX(con2.CONTRACT_ID) AS CONTRACT_ID,
        MAX(con1.CONTRACT_SOURCE_ID) AS CONTRACT_SOURCE_ID
        FROM contract con1,
        contract con2
        WHERE con1.CONTRACT_ID = #{asContractId}
        AND con2.CONTRACT_ID = con1.PARENT_CONTRACT_ID
    </select>
  
      <update id="revertContractToBaseValue" parameterType="hashmap">
      update contract set 
      contract_amount = ((select contract_amount from contract where 
       contract_id = (select parent_contract_id from contract where contract_id = #{contractId})) - 
      (select contract_amount from contract where contract_id = #{contractId})),
      MODIFIED_BY_USERID = #{submittedBy},
      MODIFIED_DATE = current_timestamp 
      WHERE contract_id = (select parent_contract_id from contract where contract_id = #{contractId})
    </update>
  <select id="fetchUpdateContractId" parameterType="String"
    resultType="hashmap">
        SELECT  CONTRACT_ID AS CONTRACT_ID
        FROM contract
        WHERE  PARENT_CONTRACT_ID = #{contractId} AND CONTRACT_TYPE_ID = '4' AND DELETE_FLAG = '0'
    </select>
  
      <update id="deleteModificationBudget" parameterType="java.util.Map">
        UPDATE BUDGET SET DELETE_FLAG = '1', ACTIVE_FLAG = '0',
        MODIFIED_BY_USERID = #{modifyBy},
        MODIFIED_DATE=current_timestamp,
        MODIFIED_BY_STAFFID =
        null   WHERE 
        CONTRACT_ID=#{ContractID} 
        AND BUDGET_TYPE_ID ='3' AND  ACTIVE_FLAG = '1'
    </update>
      <update id="deleteUpdateBudget" parameterType="java.util.Map">
         UPDATE BUDGET SET DELETE_FLAG = '1', ACTIVE_FLAG = '0',
         MODIFIED_BY_USERID = #{modifyBy},
         MODIFIED_DATE=current_timestamp,
         MODIFIED_BY_STAFFID = null  
         WHERE 
         CONTRACT_ID = (SELECT CONTRACT_ID FROM CONTRACT WHERE PARENT_CONTRACT_ID = #{ContractID} AND CONTRACT_TYPE_ID = '4' AND DELETE_FLAG = '0') 
         AND BUDGET_TYPE_ID ='4' AND  ACTIVE_FLAG = '1'
    </update>
    
     <update id="deleteUddateContract" parameterType="java.util.Map">
        UPDATE CONTRACT SET DELETE_FLAG = '1', 
        MODIFIED_DATE = current_timestamp, MODIFIED_BY_USERID =
        #{modifyBy,jdbcType=VARCHAR}
        WHERE 
        CONTRACT_ID=(SELECT CONTRACT_ID FROM CONTRACT WHERE PARENT_CONTRACT_ID = #{ContractID} AND CONTRACT_TYPE_ID = '4' AND DELETE_FLAG = '0')
    </update>
     <update id="deleteBaseBudget" parameterType="java.util.Map">
        UPDATE BUDGET SET DELETE_FLAG = '1', ACTIVE_FLAG = '0',
         MODIFIED_BY_USERID = #{modifyBy},
         MODIFIED_DATE=current_timestamp,
         MODIFIED_BY_STAFFID = null 
         WHERE 
        CONTRACT_ID = #{contractId}
        AND  ACTIVE_FLAG = '1'
    </update>
     <update id="deleteBaseContract" parameterType="java.util.Map">
        UPDATE CONTRACT SET DELETE_FLAG = '1',
        MODIFIED_DATE = current_timestamp, MODIFIED_BY_USERID =
        #{modifyBy,jdbcType=VARCHAR}
        WHERE 
        CONTRACT_ID = #{contractId}
    </update>
    <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
    <!-- Made changes in this query for defect id 6400 release 3.4.0  -->
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313-->
        <select id="fetchAmendmentListScreenAccelerator" parameterType="com.nyc.hhs.model.ContractList"
        resultMap="contractsList">
        select #{isSuspended} as IS_SUSPENDED,PARENT_CONTRACT_ID, CONTRACT_ID, CONTRACT_START_DATE, ORG_TYPE,
                CONTRACT_END_DATE, AMENDMENT_REASON,AGENCY_ID,     CONTRACT_TITLE, ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,CERT_FUNDS_REQUIRED,
                CONTRACT_AMOUNT,TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS LAST_UPDATE_DATE,  TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS MODIFIED_DATE,
                CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID, STATUS,BASE_CONTRACT_TITLE,EXT_EPIN, 
                <!-- R7 Start:8644 -->
                MARK_AS_FMS_REGISTERED,
                <!-- R7 End:8644 -->
                <!-- [Start] R7.12.0  QC9314-->
                onGoingAmendCount,
                <!-- [End] R7.12.0  QC9314-->
                <!-- Start : R5 Added-->
                ORGANIZATION_ID, BUDGET_EXIST_COUNT,
                <!-- End : R5 Added-->
                STATUS_ID, rn
				<!-- [Start] R9.7.5 QC9719 -->
		        , 0 as action_disable 
		        <!-- [End] R9.7.5 QC9719 -->  
			<!-- [Start] R9.7.6 QC9730 -->
		        , action_exception 
		    <!-- [End] R9.7.6 QC9730 -->    		        
        from ( Select MARK_AS_FMS_REGISTERED, onGoingAmendCount ,PARENT_CONTRACT_ID,CONTRACT_ID, CONTRACT_START_DATE, #{orgType}
                        ORG_TYPE,AGENCY_ID, CONTRACT_END_DATE, AMENDMENT_REASON,CONTRACT_TITLE,
                        ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,CERT_FUNDS_REQUIRED, CONTRACT_AMOUNT,
                        <!-- Start : R5 Added-->
                        ORGANIZATION_ID, BUDGET_EXIST_COUNT,
                        <!-- End : R5 Added-->
                        LAST_UPDATE_DATE,MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
                        STATUS,BASE_CONTRACT_TITLE,EXT_EPIN,
                        STATUS_ID, ROWNUM as rn 
						<!-- [Start] R9.7.6 QC9730 -->
					     , (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
						               where  aet.CONTRACT_ID = a.CONTRACT_ID  and aet.AGENCY_ID = a.AGENCY_ID and INVOICE_ADV_ONLY not in ('11','10','01')
						                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select   nvl( max(eae.VERSION_NO), 0 ) 
						                                                                 from   ACTION_EXCEPTIONAL_OBJ eae 
						                                                                where   eae.CONTRACT_ID = aet.CONTRACT_ID 
						                                                                  AND   eae.AGENCY_ID =  aet.AGENCY_ID  ) 
						         ) action_exception 
					    <!-- [End] R9.7.6 QC9730 -->    		        
                from (  select 
                           <!--Start: Added for R7 Defect part 3  -->
                            (SELECT     COUNT(contract_id)
                               FROM    (select amend.contract_type_id AS type_id, amend.contract_id as contract_id,
                                                  amend.parent_contract_id amend_parent_id,amend.REQUEST_PARTIAL_MERGE,
                                                  amend.contract_amendment_end_year,base.contract_end_year,
                                                  amend.contract_amendment_end_month,base.contract_end_month

                                         from     (SELECT   to_char(contract_end_date,'YYYY') as contract_amendment_end_year,contract_type_id,
                                                            REQUEST_PARTIAL_MERGE,  to_char(contract_end_date,'mm') as contract_amendment_end_month,
                                                            contract_id,parent_contract_id 
                                                    from    contract
                                                    WHERE   contract_type_id   =  2
                                                      AND   REQUEST_PARTIAL_MERGE = 0 
                                                      AND   is_amendment_registered_in_fms = 0 
                                                      AND   STATUS_ID !=69
                                                  ) amend join     (SELECT   to_char(contract_end_date,'YYYY') as contract_end_year,
                                                                          to_char(contract_end_date,'mm') as contract_end_month,contract_id,
                                                                          parent_contract_id
                                                                   from   contract
                                                                  WHERE   contract_type_id=1
                                                                 ) base
                                                          on  amend.parent_contract_id=base.contract_id
                                        where  ((amend.contract_amendment_end_year &gt; base.contract_end_year AND amend.contract_amendment_end_month &gt;6)
                                           OR  (amend.contract_amendment_end_year = base.contract_end_year AND amend.contract_amendment_end_month &gt;6 AND base.contract_end_month&lt;=6)
                                           OR  (amend.contract_amendment_end_year &gt; base.contract_end_year AND amend.contract_amendment_end_month &lt;=6 AND base.contract_end_month &lt;=6))
                                        ) a
                              WHERE a.contract_id=CON.CONTRACT_ID
                             )  as MARK_AS_FMS_REGISTERED,
                            <!-- End: For R7 Defect part 3 -->
                            <!-- [Start] R7.12.0 added for QC9314-->
		                      ( SELECT  count(sub_con.CONTRACT_ID)  FROM   CONTRACT   sub_con
		                       WHERE   sub_con.PARENT_CONTRACT_ID   =   con.parent_contract_id
		                        AND    sub_con.CONTRACT_TYPE_ID = 2
		                        AND    sub_con.STATUS_ID in ( 59, 60, 128, 129, 61, 130, 118 , 192 )
		                       )  as onGoingAmendCount,
                            <!-- [End] R7.12.0 added for QC9314 -->
                             con.CONTRACT_TITLE,conBase.contract_title as BASE_CONTRACT_TITLE,con.EXT_EPIN,
                             org.ORGANIZATION_LEGAL_NAME,con.AGENCY_ID,
                             decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER)
                             EXT_CT_NUMBER,con.CERT_FUNDS_REQUIRED, con.LAST_UPDATE_DATE,con.MODIFIED_DATE,
                             <!-- Start : R5 Added-->
                             org.ORGANIZATION_ID,
                           ( SELECT   COUNT(1) 
                               FROM   BUDGET 
                              WHERE   CONTRACT_ID = con.CONTRACT_ID 
                                AND   STATUS_ID != 106 
                                AND ACTIVE_FLAG = '1'
                            ) AS BUDGET_EXIST_COUNT,
                            <!-- End : R5 Added-->
                            st.STATUS, st.STATUS_ID,
                           ( CASE    WHEN st.STATUS_ID = 67 THEN 14
                                     ELSE st.status_process_type_id
                                END 
                             ) AS status_process_type_id,
                           con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID ,con.PARENT_CONTRACT_ID,con.CONTRACT_ID,
                           con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
                  from   CONTRACT con,CONTRACT conBase, ORGANIZATION org, STATUS_MASTER_R2_R3 st
                 where   conBase.contract_id = con.parent_contract_id 
                   and   con.STATUS_ID = st.STATUS_ID 
                   and   con.ORGANIZATION_ID = org.ORGANIZATION_ID 
                   and   con.CONTRACT_TYPE_ID  IN  ( 2 )
                   <if test="contractId != null and contractId !=''">
                   AND   con.parent_contract_id = (select   decode ( contract_type_id, 3 , contract_id , parent_contract_id ) 
                                                       from   contract 
                                                      where   contract_id = #{contractId} and rownum=1
                                                     )
                   </if>
                   <if test=" amendmentContractId != null and amendmentContractId != '' ">
                   AND con.contract_id = #{amendmentContractId}
                   </if>
                   <if test="contractTitle != null and contractTitle !=''">
                    AND (lower(con.CONTRACT_TITLE) LIKE  lower('%${contractTitle}%'))
                   </if>
                   <if test="contractAgencyName != null and contractAgencyName !=''">
                    AND con.AGENCY_ID = #{contractAgencyName}
                   </if>
                   <if test="programName != null and programName !=''">
                    AND con.PROGRAM_ID = #{programName}
                   </if>
                   <if test="ctId != null and ctId !=''">
                    AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
                   </if>
                    <if test="awardEpin != null and awardEpin !=''">
                        AND lower(con.EXT_EPIN) = lower(#{awardEpin})
                    </if>
                    <if test="contractValueFrom != null and contractValueFrom !=''">
                        AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
                    </if>
                    <if test="contractValueTo != null and contractValueTo !=''">
                        AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
                    </if>
                    <if test="provider != null and provider !=''">
                        AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE  lower(#{provider})
                    </if>
                    <if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
                        AND con.MODIFIED_DATE &gt;  to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
                    </if>
                    <if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
                        AND con.MODIFIED_DATE &lt; to_date(#{dateLastUpdateTo,jdbcType=DATE},'MM/dd/YYYY') 
                    </if>
                    <if test="contractId == null || amendmentContractId == null">
                        <if test="contractStatusList != null">
                            AND st.Status_ID IN
                            <foreach item="items" index="index" collection="contractStatusList"
                                open="(" separator="," close=")">
                                #{items}
                                  </foreach>
                        </if>
                    </if>
                    ORDER BY
                    <choose>
                        <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
                        <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
                    </choose>
                    <if test="secondSort != null and secondSort !=''">
                        <choose>
                            <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
                            <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
                        </choose>
                    </if>
                    ) a 
        <if test="baseContractTitle != null and baseContractTitle !=''">
            where (lower(BASE_CONTRACT_TITLE) LIKE     lower('%${baseContractTitle}%'))
        </if>  
        ) b where rn BETWEEN #{startNode} AND #{endNode}
    </select>
    
    <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
    <!-- Made changes for Enhancement id 6400 release 3.4.0 -->
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313 -->
    <select id="fetchAmendmentListScreenAgency" parameterType="com.nyc.hhs.model.ContractList" resultMap="contractsList">
        select #{isSuspended} as IS_SUSPENDED, PARENT_CONTRACT_ID,CONTRACT_ID, CONTRACT_START_DATE, ORG_TYPE,
                CONTRACT_END_DATE, AMENDMENT_REASON, CONTRACT_TITLE,AGENCY_ID,ORGANIZATION_LEGAL_NAME, EXT_CT_NUMBER,CERT_FUNDS_REQUIRED,
                CONTRACT_AMOUNT,TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS LAST_UPDATE_DATE,TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS MODIFIED_DATE,
                CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID, STATUS,BASE_CONTRACT_TITLE,EXT_EPIN,
                <!-- Start : R5 Added-->
                ORGANIZATION_ID, BUDGET_EXIST_COUNT,
                <!-- End : R5 Added-->
                <!-- [Start] R7.12.0 added for QC9314-->
                onGoingAmendCount ,
                <!-- [End] R7.12.0 added for QC9314 -->
                STATUS_ID, rn 
				<!-- [Start] R9.7.5 QC9719 -->
		        , 0 as action_disable 
		        <!-- [End] R9.7.5 QC9719 -->
				<!-- [Start] R9.7.6 QC9730 -->
			    , action_exception 
			    <!-- [End] R9.7.6 QC9730 -->    		        
        from ( Select PARENT_CONTRACT_ID,CONTRACT_ID, CONTRACT_START_DATE, #{orgType}
                        ORG_TYPE,AGENCY_ID, CONTRACT_END_DATE, AMENDMENT_REASON, CONTRACT_TITLE, ORGANIZATION_LEGAL_NAME, 
                        EXT_CT_NUMBER,CERT_FUNDS_REQUIRED, CONTRACT_AMOUNT, onGoingAmendCount ,
                        <!-- Start : R5 Added-->
                        ORGANIZATION_ID, BUDGET_EXIST_COUNT,
                        <!-- End : R5 Added-->
                        LAST_UPDATE_DATE,MODIFIED_DATE, CONTRACT_TYPE_ID, CONTRACT_SOURCE_ID,
                        STATUS,BASE_CONTRACT_TITLE,EXT_EPIN, STATUS_ID, ROWNUM as rn 
						<!-- [Start] R9.7.6 QC9730 -->
					     , (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
						               where  aet.CONTRACT_ID = a.CONTRACT_ID  and aet.AGENCY_ID = a.AGENCY_ID and INVOICE_ADV_ONLY not in ('11','10','01')
						                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select   nvl( max(eae.VERSION_NO), 0 ) 
						                                                                 from   ACTION_EXCEPTIONAL_OBJ eae 
						                                                                where   eae.CONTRACT_ID = aet.CONTRACT_ID 
						                                                                  AND   eae.AGENCY_ID =  aet.AGENCY_ID  ) 
						  ) action_exception 
					    <!-- [End] R9.7.6 QC9730 -->    		
                 from ( select con.CONTRACT_TITLE,conBase.contract_title as BASE_CONTRACT_TITLE,con.EXT_EPIN, org.ORGANIZATION_LEGAL_NAME,con.AGENCY_ID,
                            <!-- [Start] R7.12.0 added for QC9314-->
		                   ( SELECT  count(sub_con.CONTRACT_ID)  FROM   CONTRACT   sub_con
		                       WHERE   sub_con.PARENT_CONTRACT_ID   =   con.parent_contract_id
		                        AND    sub_con.CONTRACT_TYPE_ID = 2
		                        AND    sub_con.STATUS_ID in ( 59, 60, 128, 129, 61, 130, 118 , 192 )
                            )  as onGoingAmendCount,
                            <!-- [End] R7.12.0 added for QC9314 -->
								decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER) EXT_CT_NUMBER,con.CERT_FUNDS_REQUIRED, 
								con.LAST_UPDATE_DATE,con.MODIFIED_DATE, st.STATUS, st.STATUS_ID,
								( CASE    WHEN   st.STATUS_ID = 67 THEN 14
								          ELSE   st.status_process_type_id
								    END
								) AS status_process_type_id,
								con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID,
								<!-- Start : R5 Added-->
								org.ORGANIZATION_ID,
								(SELECT COUNT(1) FROM BUDGET WHERE CONTRACT_ID = con.CONTRACT_ID AND STATUS_ID != 106 AND ACTIVE_FLAG = '1') AS BUDGET_EXIST_COUNT,
								<!-- End : R5 Added-->
								con.PARENT_CONTRACT_ID,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
						from	CONTRACT con,CONTRACT conBase, ORGANIZATION org, STATUS_MASTER_R2_R3 st
						where	conBase.contract_id = con.parent_contract_id 
						and		con.STATUS_ID = st.STATUS_ID 
						and		con.ORGANIZATION_ID  =  org.ORGANIZATION_ID 
						and		con.CONTRACT_TYPE_ID IN(2) 
						and     CON.AGENCY_ID= #{orgName}
						<if test="contractId != null and contractId !=''">
						    AND con.parent_contract_id = (select decode ( contract_type_id, 3 , contract_id , parent_contract_id ) 
						                                   from contract where contract_id = #{contractId} and rownum=1)
						</if>
						<if test=" amendmentContractId != null and amendmentContractId != '' ">
						AND con.contract_id = #{amendmentContractId}
						</if>
						<if test="contractTitle != null and contractTitle !=''">
						    AND (lower(con.CONTRACT_TITLE) LIKE lower('%${contractTitle}%'))
						</if>
						<if test="awardEpin != null and awardEpin !=''">
						    AND con.EXT_EPIN = #{awardEpin}
						</if>
						<if test="contractValueFrom != null and contractValueFrom !=''">
						    AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
						</if>
						<if test="contractValueTo != null and contractValueTo !=''">
						    AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
						</if>
						<if test="provider != null and provider !=''">
						    AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE lower(#{provider})
						</if>
						<if test="programName != null and programName !=''">
						    AND con.PROGRAM_ID = #{programName}
						</if>
						<if test="ctId != null and ctId !=''">
						    AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
						</if>
						<if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
						    AND con.MODIFIED_DATE &gt;  to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
						</if>
						<if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
						    AND con.MODIFIED_DATE &lt;  to_date(#{dateLastUpdateTo, jdbcType=DATE},'MM/dd/YYYY') 
						</if>
						<if test="contractId ==null || amendmentContractId == null">
							<if test="contractStatusList != null">
							    AND st.Status_ID IN
								<foreach item="items" index="index" collection="contractStatusList" open="(" separator="," close=")">
								#{items}
								</foreach>
							</if>
						</if>
						ORDER BY
						<choose>
						    <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
						    <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
						</choose>
						<if test="secondSort != null and secondSort !=''">
						    <choose>
						        <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
						        <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
						    </choose>
						</if>
				     ) a 
		      <if test="baseContractTitle != null and baseContractTitle !=''">
		       where (lower(BASE_CONTRACT_TITLE) LIKE lower('%${baseContractTitle}%'))
		     </if>  
		  ) b where rn BETWEEN #{startNode} AND #{endNode}
</select>


    <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313 -->
    <select id="fetchAmendmentListScreenProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultMap="contractsList">
        select PARENT_CONTRACT_ID,CONTRACT_ID, CONTRACT_AMOUNT, ORG_TYPE,
		        CONTRACT_START_DATE, CONTRACT_END_DATE,  AMENDMENT_REASON,AGENCY_ID, CONTRACT_TITLE, EXT_CT_NUMBER,
		        LAST_UPDATE_DATE,MODIFIED_DATE, EXT_EPIN,  STATUS, STATUS_ID,BASE_CONTRACT_TITLE,
		        <!-- Start : R5 Added-->
		        BUDGET_EXIST_COUNT,
		        <!-- End : R5 Added-->
		        rn 
				<!-- [Start] R9.7.5 QC9719 -->
		        , 0 as action_disable 
		        <!-- [End] R9.7.5 QC9719 -->
				<!-- [Start] R9.7.6 QC9730 -->
			    , action_exception 
			    <!-- [End] R9.7.6 QC9730 -->    
        from ( Select PARENT_CONTRACT_ID,CONTRACT_ID, CONTRACT_AMOUNT, #{orgType}
				        ORG_TYPE,AGENCY_ID, CONTRACT_START_DATE, CONTRACT_END_DATE,
				        AMENDMENT_REASON, CONTRACT_TITLE, EXT_CT_NUMBER,
				        TO_CHAR(LAST_UPDATE_DATE,'MM/DD/YYYY') AS LAST_UPDATE_DATE, TO_CHAR(MODIFIED_DATE,'MM/DD/YYYY') AS MODIFIED_DATE,
				        EXT_EPIN,BASE_CONTRACT_TITLE,
				        <!-- Start : R5 Added-->
				        BUDGET_EXIST_COUNT,
				        <!-- End : R5 Added-->
				        STATUS, STATUS_ID,
				        ROWNUM as rn 
						<!-- [Start] R9.7.6 QC9730 -->
					     , (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
						               where  aet.CONTRACT_ID = a.CONTRACT_ID  and aet.AGENCY_ID = a.AGENCY_ID and INVOICE_ADV_ONLY not in ('11','10','01')
						                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select   nvl( max(eae.VERSION_NO), 0 ) 
						                                                                 from   ACTION_EXCEPTIONAL_OBJ eae 
						                                                                where   eae.CONTRACT_ID = aet.CONTRACT_ID 
						                                                                  AND   eae.AGENCY_ID =  aet.AGENCY_ID  ) 
						  ) action_exception 
					    <!-- [End] R9.7.6 QC9730 -->
				  from ( Select con.CONTRACT_TITLE,con.AGENCY_ID,conBase.contract_title as BASE_CONTRACT_TITLE,
						        <!-- Start : R5 Added-->
						        (SELECT COUNT(1) FROM BUDGET WHERE CONTRACT_ID = con.CONTRACT_ID AND STATUS_ID != 106 AND ACTIVE_FLAG = '1') AS BUDGET_EXIST_COUNT,
						        <!-- End : R5 Added-->
						        decode(st.STATUS_ID,61,'--',69,'--',con.EXT_CT_NUMBER)
        						EXT_CT_NUMBER, con.CONTRACT_AMOUNT,
        						TO_DATE (TO_CHAR (con.LAST_UPDATE_DATE, 'DD-MON-YYYY'), 'DD-MON-YYYY') AS last_update_date,
                				TO_DATE (TO_CHAR (con.MODIFIED_DATE, 'DD-MON-YYYY'), 'DD-MON-YYYY') AS MODIFIED_DATE,
        						con.EXT_EPIN, st.STATUS,
        						(   CASE
							            WHEN st.STATUS_ID = 130   THEN 61
							            ELSE st.STATUS_ID
						              END 
						         )AS STATUS_ID,
              					(  	CASE
            							WHEN st.STATUS_ID = 67 THEN 14
										WHEN st.status_process_type_id=6   THEN 5
										ELSE st.status_process_type_id
              						END 
              					) AS status_process_type_id,
              					con.PARENT_CONTRACT_ID,con.CONTRACT_ID,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
        				from CONTRACT con,CONTRACT conBase, STATUS_MASTER_R2_R3 st
        				where con.STATUS_ID =    st.STATUS_ID 
        				and    CON.ORGANIZATION_ID= #{orgName} 
        				and    con.CONTRACT_TYPE_ID IN(2)
        				and    conBase.contract_id = con.parent_contract_id
				        <if test="contractId != null and contractId !=''">
				            AND con.parent_contract_id = (select decode ( contract_type_id, 3 , contract_id , parent_contract_id ) 
				                                            from contract 
				                                            where contract_id = #{contractId} and rownum=1 )
				        </if>
				        <if test=" amendmentContractId != null and amendmentContractId != '' ">
				        AND con.contract_id = #{amendmentContractId}
				        </if>
				        <if test="contractTitle != null and contractTitle !=''">
				            AND
				            (lower(con.CONTRACT_TITLE) LIKE
				            lower('%${contractTitle}%'))
				        </if>
				        <if test="contractAgencyName != null and contractAgencyName !=''">
				            AND con.AGENCY_ID = #{contractAgencyName}
				        </if>
				        <if test="awardEpin != null and awardEpin !=''">
				            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
				        </if>
				        <if test="contractValueFrom != null and contractValueFrom !=''">
				            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
				        </if>
				        <if test="contractValueTo != null and contractValueTo !=''">
				            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
				        </if>
				        <if test="contractId == null || amendmentContractId == null">
				        <if test="contractStatusList != null">
				            AND st.Status_ID IN
				            <foreach item="items" index="index" collection="contractStatusList"
				                open="(" separator="," close=")">
				                #{items}
				            </foreach>
				        </if>
				        </if>
				        <if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
				            AND con.MODIFIED_DATE &gt; to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
				            AND con.MODIFIED_DATE &lt; to_date(#{dateLastUpdateTo, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        ORDER BY
				        <choose>
				            <when test="firstSortDate != false">${firstSort} ${firstSortType}</when>
				            <otherwise>lower(${firstSort}) ${firstSortType}</otherwise>
				        </choose>
				        <if test="secondSort != null and secondSort !=''">
				            <choose>
				                <when test="secondSortDate != false">, ${secondSort} ${secondSortType}</when>
				                <otherwise>, lower(${secondSort}) ${secondSortType}</otherwise>
				            </choose>
				        </if>
        				) a 
        	<if test="baseContractTitle != null and baseContractTitle !=''">
            where (lower(BASE_CONTRACT_TITLE) LIKE lower('%${baseContractTitle}%'))
        	</if>  
        ) b where rn  BETWEEN #{startNode} AND  #{endNode}
    </select>
    
    
    <!-- Made changes in this query for defect id 6400 release 3.4.0  -->
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313 -->
    <select id="fetchAmendmentCountAccelerator" parameterType="com.nyc.hhs.model.ContractList"
        resultType="int">
        select count(1) count 
        from ( select * 
				from (select con.CONTRACT_TITLE,conBase.contract_title as BASE_CONTRACT_TITLE,con.EXT_EPIN,
					        org.ORGANIZATION_LEGAL_NAME, decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER)
					        EXT_CT_NUMBER,con.CERT_FUNDS_REQUIRED, con.LAST_UPDATE_DATE,con.MODIFIED_DATE,
					        st.STATUS, st.STATUS_ID,    con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID ,
					        con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
				        from CONTRACT con,CONTRACT conBase, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        				where  conBase.contract_id = con.parent_contract_id 
        				and    con.STATUS_ID = st.STATUS_ID and con.ORGANIZATION_ID=org.ORGANIZATION_ID 
        				and    con.CONTRACT_TYPE_ID  IN(2)
				        <if test="contractId != null and contractId !=''">
				        AND con.parent_contract_id = (select  decode ( contract_type_id, 3 , contract_id , parent_contract_id )  
			                                            from  contract 
			                                           where  contract_id = #{contractId} and rownum = 1 )
				        </if>
				        <if test=" amendmentContractId != null and amendmentContractId != '' ">
				        	AND con.contract_id = #{amendmentContractId}
				        </if>
				        <if test="contractTitle != null and contractTitle !=''">
				            AND  (lower(con.CONTRACT_TITLE) LIKE  lower('%${contractTitle}%'))
				        </if>
				        <if test="contractAgencyName != null and contractAgencyName !=''">
				            AND con.AGENCY_ID = #{contractAgencyName}
				        </if>
				        <if test="awardEpin != null and awardEpin !=''">
				            AND lower(con.EXT_EPIN) = lower(#{awardEpin})
				        </if>
				        <if test="contractValueFrom != null and contractValueFrom !=''">
				            AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
				        </if>
				        <if test="contractValueTo != null and contractValueTo !=''">
				            AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
				        </if>
				        <if test="provider != null and provider !=''">
				            AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE  lower(#{provider})
				        </if>
				        <if test="programName != null and programName !=''">
				            AND con.PROGRAM_ID = #{programName}
				        </if>
				        <if test="ctId != null and ctId !=''">
				            AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
				        </if>
				        <if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
				            AND con.MODIFIED_DATE &gt;  to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
				            AND con.MODIFIED_DATE &lt; to_date(#{dateLastUpdateTo, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="contractId == null || amendmentContractId == null">
					        <if test="contractStatusList != null">
					            AND st.Status_ID IN
					            <foreach item="items" index="index" collection="contractStatusList" open="(" separator="," close=")">
					                #{items}
					            </foreach>
					        </if>
				        </if>
				        ) 
        	<if test="baseContractTitle != null and baseContractTitle !=''">
            where (lower(BASE_CONTRACT_TITLE) LIKE  lower('%${baseContractTitle}%'))
       		</if>)
    </select>
    <!-- Made changes for Enhancement id 6400 release 3.4.0 -->
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313 -->
    <select id="fetchAmendmentCountAgency" parameterType="com.nyc.hhs.model.ContractList" resultType="int">
        select count(1) count 
        from (select * 
				from ( select   con.CONTRACT_TITLE,conBase.contract_title as BASE_CONTRACT_TITLE,con.EXT_EPIN,
						        org.ORGANIZATION_LEGAL_NAME, decode(st.STATUS_ID,59,'--',60,'--',61,'--',69,'--',con.EXT_CT_NUMBER)
						        EXT_CT_NUMBER,con.CERT_FUNDS_REQUIRED, con.LAST_UPDATE_DATE,con.MODIFIED_DATE, st.STATUS, st.STATUS_ID,
						        con.CONTRACT_TYPE_ID, con.CONTRACT_SOURCE_ID ,con.CONTRACT_ID,con.CONTRACT_AMOUNT,con.CONTRACT_START_DATE,
						        con.CONTRACT_END_DATE,con.AMENDMENT_REASON 
						from    CONTRACT con,CONTRACT conBase, ORGANIZATION org, STATUS_MASTER_R2_R3 st
        				where    conBase.contract_id = con.parent_contract_id 
        				and      con.STATUS_ID =   st.STATUS_ID 
        				and      con.ORGANIZATION_ID=org.ORGANIZATION_ID 
        				and     con.CONTRACT_TYPE_ID IN(2)
        				and     CON.AGENCY_ID= #{orgName}
				        <if test="contractId != null and contractId !=''">
				        AND     con.parent_contract_id = (select  decode ( contract_type_id, 3 , contract_id , parent_contract_id )   
				                                            from  contract where contract_id = #{contractId} 
				                                             and   rownum = 1
				                                         )
				        </if>
				        <if test=" amendmentContractId != null and amendmentContractId != '' ">
				        AND con.contract_id = #{amendmentContractId}
				        </if>
				        <if test="contractTitle != null and contractTitle !=''">
				        AND (lower(con.CONTRACT_TITLE) LIKE  lower('%${contractTitle}%'))
				        </if>
				        <if test="awardEpin != null and awardEpin !=''">
				        AND lower(con.EXT_EPIN) = lower(#{awardEpin})
				        </if>
				        <if test="contractValueFrom != null and contractValueFrom !=''">
				        AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
				        </if>
				        <if test="contractValueTo != null and contractValueTo !=''">
				        AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
				        </if>
				        <if test="provider != null and provider !=''">
				        AND lower(org.ORGANIZATION_LEGAL_NAME) LIKE lower(#{provider})
				        </if>
				        <if test="programName != null and programName !=''">
				        AND con.PROGRAM_ID = #{programName}
				        </if>
				        <if test="ctId != null and ctId !=''">
				        AND lower(con.EXT_CT_NUMBER) = lower(#{ctId})
				        </if>
				        <if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
				        AND con.MODIFIED_DATE &gt; to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
				        AND con.MODIFIED_DATE &lt;  to_date(#{dateLastUpdateTo, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="contractId == null || amendmentContractId == null">
					        <if test="contractStatusList != null">
					            AND st.Status_ID IN
					            <foreach item="items" index="index" collection="contractStatusList"
					                open="(" separator="," close=")">
					                #{items}
					            </foreach>
					        </if>
				        </if>
        				) 
	        <if test="baseContractTitle != null and baseContractTitle !=''">
	            where  (lower(BASE_CONTRACT_TITLE) LIKE lower('%${baseContractTitle}%'))
	        </if>
	        )
    </select>
    
    <!-- Made changes for Emergency Build 4.0.1 defect 8360 -->
    <!-- Made changes for Emergency Build 4.0.0.3 defect 8397 and 8313 -->
    <select id="fetchAmendmentCountProvider" parameterType="com.nyc.hhs.model.ContractList"
        resultType="int">
        select count(1) count 
        from (select * 
				from (Select  con.CONTRACT_TITLE, con.AGENCY_ID,conBase.contract_title as BASE_CONTRACT_TITLE,
        					decode(st.STATUS_ID,61,'--',69,'--',con.EXT_CT_NUMBER)  EXT_CT_NUMBER,
        					con.CONTRACT_AMOUNT,TO_DATE (TO_CHAR (con.LAST_UPDATE_DATE, 'DD-MON-YYYY'),'DD-MON-YYYY') AS last_update_date,
                			TO_DATE (TO_CHAR (con.MODIFIED_DATE, 'DD-MON-YYYY'),'DD-MON-YYYY') AS MODIFIED_DATE, con.EXT_EPIN, st.STATUS,
					        ( CASE
					            WHEN st.STATUS_ID = 130  THEN 61
					            ELSE st.STATUS_ID
								END 
							)AS STATUS_ID,
              				con.CONTRACT_ID,con.CONTRACT_START_DATE,con.CONTRACT_END_DATE,con.AMENDMENT_REASON
        				from CONTRACT con,CONTRACT conBase, STATUS_MASTER_R2_R3 st
        				where con.STATUS_ID = st.STATUS_ID 
        				and   CON.ORGANIZATION_ID= #{orgName} 
        				and   con.CONTRACT_TYPE_ID IN(2)
        				and   conBase.contract_id = con.parent_contract_id
				        <if test="contractId != null and contractId !=''">
				        AND con.parent_contract_id = (select   decode ( contract_type_id, 3 , contract_id , parent_contract_id )    
				                                        from   contract 
				                                        where  contract_id = #{contractId} and rownum = 1
				                                      )
				        </if>
				        <if test=" amendmentContractId != null and amendmentContractId != '' ">
				        AND con.contract_id = #{amendmentContractId}
				        </if>
				        <if test="contractAgencyName != null and contractAgencyName !=''">
				        AND con.AGENCY_ID = #{contractAgencyName}
				        </if>
				        <if test="contractTitle != null and contractTitle !=''">
				        AND (lower(con.CONTRACT_TITLE) LIKE lower('%${contractTitle}%'))
				        </if>
				        <if test="awardEpin != null and awardEpin !=''">
				        AND lower(con.EXT_EPIN) = lower(#{awardEpin})
				        </if>
				        <if test="contractValueFrom != null and contractValueFrom !=''">
				        AND con.CONTRACT_AMOUNT &gt;= #{contractValueFrom}
				        </if>
				        <if test="contractValueTo != null and contractValueTo !=''">
				        AND con.CONTRACT_AMOUNT &lt;= #{contractValueTo}
				        </if>
				        <if test="dateLastUpdateFrom != null and dateLastUpdateFrom !=''">
				        AND con.MODIFIED_DATE &gt; to_date(#{dateLastUpdateFrom, jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="dateLastUpdateTo != null and dateLastUpdateTo !=''">
				        AND con.MODIFIED_DATE &lt;to_date(#{dateLastUpdateTo,jdbcType=DATE},'MM/dd/YYYY') 
				        </if>
				        <if test="contractId == null || amendmentContractId == null">
					        <if test="contractStatusList != null">
					            AND st.Status_ID IN
					            <foreach item="items" index="index" collection="contractStatusList"
					                open="(" separator="," close=")">
					                #{items}
					            </foreach>
					        </if>
				        </if>
				        ) 
	        <if test="baseContractTitle != null and baseContractTitle !=''">
	            where  (lower(BASE_CONTRACT_TITLE) LIKE lower('%${baseContractTitle}%'))
	        </if>
	       )
    </select>

    <select id="fetchAllNegativeAmendmentAmounts" parameterType="String" resultType="String">
    select nvl(sum(contract_amount),0) as AMOUNT from contract where parent_contract_id =#{asContractId} and contract_amount &lt; 0
    and contract_type_id =2 and ((status_id  in (59,60,128)) or (status_id =129 and 
     ( select count(1) from budget where contract_id in (select contract_id from contract where 
  parent_contract_id =#{asContractId} and contract_amount &lt; 0
    and status_id =129 and contract_type_id =2) and status_id  in (85,86))=0)
   )
    
    </select>
    
    <select id="updateBudgetCount" parameterType="String"
        resultType="integer">
        SELECT COUNT(*)
        FROM BUDGET
        WHERE CONTRACT_ID IN
          (SELECT contract_id
          FROM contract
          WHERE parent_contract_id = #{asContractId}
          AND contract_type_id     = 4
          )
        AND STATUS_ID     IN (82,83,84)
        AND BUDGET_TYPE_ID = 4
        AND ACTIVE_FLAG='1'
    </select>
    
    <select id="negativeAmendment" parameterType="String"
        resultType="integer">
        SELECT count(1) FROM CONTRACT WHERE
        CONTRACT_ID = #{asContractId}
        AND CONTRACT_AMOUNT &lt; 0
    </select>
    
    <select id="sentForRegOrCanCheck" parameterType="com.nyc.hhs.model.ContractList" resultType="int">
        SELECT count(*)
        FROM contract
        WHERE status_id        = #{contractStatusId}
        AND parent_contract_id = (SELECT parent_contract_id FROM contract WHERE contract_id = #{contractId})
        AND contract_type_id = 2
    </select>
    
    <select id="isStatusSentForReg" parameterType="com.nyc.hhs.model.ContractList" resultType="int">
      select count(1) from  contract where contract_id =  #{contractId} and status_id = #{contractStatusId}
    </select>
    
    <select id="isPDFBudgetAmendmentGenerated" parameterType="hashmap" resultType="int">
        SELECT count(*)
        FROM pdf_batch_details
        WHERE sub_entity_type =#{subEntityType}
        AND entity_type       =  #{newEntityType}
        AND entity_id         =  #{newEntityId}
        AND status            = #{status}
    </select>
    
    <select id="isPDFAmendmentCofGenerated" parameterType="hashmap" resultType="int">
        SELECT count(*)
        FROM pdf_batch_details
        WHERE sub_entity_type =#{newEntityType}
        AND entity_type       =  #{newEntityType}
        AND entity_id         =  #{newEntityId}
        AND status            = #{status}
    </select>
    
    <select id="negAmendRegOrCanCheck" parameterType="com.nyc.hhs.model.ContractList" resultType="int">
        SELECT COUNT(*)
        FROM contract
        WHERE parent_contract_id =
        (SELECT parent_contract_id FROM contract WHERE contract_id = #{contractId} and contract_amount  &gt; 0)
        AND contract_amount  &lt; 0
        AND contract_type_id = 2
        AND status_id       IN 
        <foreach item="items" index="index" collection="contractStatusList"
                open="(" separator="," close=")">
                #{items}
        </foreach>
    </select>
    
    <update id="updateStatusToSentForReg" parameterType="com.nyc.hhs.model.ContractList">
        update contract set status_id = #{contractStatusId} where contract_id = #{contractId}
    </update>
    
    <select id="budgetApprovedCount" parameterType="hashmap" resultType="int">
        select count(1) from budget b where contract_id = #{amendcontractid} and status_id = #{asStatusId}
    </select>
    
    <select id="negAmendCount" parameterType="hashmap" resultType="int">
    select count(1) from contract where parent_contract_id in (select parent_contract_id from contract where contract_id = #{amendcontractid})
    and contract_id not in (#{amendcontractid}) and contract_type_id = #{contractTypeId} 
    and status_id in
    <foreach item="items" index="index" collection="statusList"
                open="(" separator="," close=")">
                #{items}
        </foreach>
     and contract_amount &lt; 0
    </select>
    
    
    <resultMap id="PDFBatch" type="com.nyc.hhs.model.PDFBatch">
        <result property="entityType" column="ENTITY_TYPE" />
        <result property="subEntityType" column="SUB_ENTITY_TYPE" />
        <result property="entityId" column="ENTITY_ID" />
        <result property="subEntityId" column="SUB_ENTITY_ID" />
    </resultMap>
    
    <select id="fetchEntityIdForPdf"  parameterType="hashmap"    resultMap="PDFBatch">
        SELECT entity_id,entity_type,SUB_ENTITY_ID,SUB_ENTITY_TYPE
        FROM pdf_batch_details
        WHERE  status       IN (  #{status})
        UNION ALL
        SELECT entity_id,entity_type,SUB_ENTITY_ID,SUB_ENTITY_TYPE
        FROM pdf_batch_details
        WHERE status                          IN ( #{statusId})
        AND systimestamp  - last_picked_time > interval '1' hour 
    </select>
    
    
    <select id="fetchEntityIdForPdfR2"  parameterType="hashmap"    resultType="string">
        SELECT entity_id
        FROM pdf_batch_details
        WHERE entity_type =#{newEntityType} 
        AND status       IN (  #{status})
        UNION ALL
        SELECT entity_id
        FROM pdf_batch_details
        WHERE entity_type                    =#{newEntityType} 
        AND status                          IN ( #{statusId})
        AND systimestamp  - last_picked_time > interval '1' hour 
    </select>
    
    
    <update id="updateStatusForPdf" parameterType="hashmap">
    update pdf_batch_details set STATUS =#{statusId} , LAST_PICKED_TIME = systimestamp
    where sub_entity_id in
        <foreach item="items" index="index" collection="subEntityId"
                open="(" separator="," close=")">
                #{items}
        </foreach>
    </update>
    
    <update id="updateStatusForPdfAfterUpload" parameterType="hashmap">
    update pdf_batch_details set STATUS =#{status} , LAST_PICKED_TIME = systimestamp
    where sub_entity_id = #{subEntityId}
    </update>
    
        <select id="fetchApprovedBaseBudgetId" parameterType="String"
            resultType="String">
        SELECT budget_id
        FROM
          (SELECT budget_id
          FROM budget
          WHERE contract_id = #{asContractId}
          ORDER BY created_date ASC
          )
        WHERE rownum = 1
        </select>
    
    <select id="isOpenEndedRfpStartEndDateNotSet"  parameterType="String"    resultType="int">
        SELECT COUNT(*)
        FROM contract a,
          procurement b
        WHERE a.procurement_id     = b.procurement_id
        AND b.is_open_ended_rfp    = '1'
        AND a.contract_id          = #{asContractId}
        AND a.contract_start_date IS NULL
        AND a.contract_end_date   IS NULL    
    </select>
    <update id="updateContractStartEndDateForOpenEndedRfp" parameterType="hashmap">
        update contract set contract_start_date = to_date(#{contractStartDate},'MM/DD/YYYY') , contract_end_date = to_date(#{contractEndDate},'MM/DD/YYYY') 
        where contract_id = #{contractId} and contract_type_id = '1'
    </update>    
    
    <select id="getBudgetIdsFromContractId" parameterType="com.nyc.hhs.model.ContractList" resultType="String">
        SELECT LISTAGG(BUDGET_ID, ',') WITHIN GROUP (ORDER BY BUDGET_ID)  FROM BUDGET  WHERE CONTRACT_ID = #{contractId}
    </select>
    
    
    <resultMap id="BulkFileProps" type="com.batch.bulkupload.BulkUploadFileInformation">
        <result property="fileId" column="BULK_UPLOAD_ID" />
        <result property="documentId" column="DOCUMENT_ID" />
        <result property="fileName" column="FILE_NAME" />
        <result property="fileStatus" column="STATUS" />
        <result property="createdBy" column="CREATED_BY_USERID" />
        <result property="bulkUploadId" column="BULK_UPLOAD_ID" />
    </resultMap>
    <select id="getBulkUploadFileInfo"  parameterType="hashmap"    resultMap="BulkFileProps">
        
        SELECT BULK_UPLOAD.BULK_UPLOAD_ID,
        BULK_UPLOAD.DOCUMENT_ID,
        BULK_UPLOAD.FILE_NAME,
        BULK_UPLOAD.CREATED_BY_USERID,
        BULK_UPLOAD.BULK_UPLOAD_ID
        FROM BULK_UPLOAD WHERE  BULK_UPLOAD.STATUS =#{asFileStatusNotProcessed}
         or (BULK_UPLOAD.STATUS in (#{asFileStatusInProgreass}) 
         AND systimestamp  - BULK_UPLOAD.LOCK_IN_PROGRESS > interval ${multiplyBy} hour 
         )
    </select>
    
    <update id="updateBulkUploadDocStatus" parameterType="HashMap">
        update BULK_UPLOAD set STATUS=#{asDocStatus},MODIFIED_BY_USERID=#{modifiedBy},MODIFIED_DATE=SYSTIMESTAMP where DOCUMENT_ID=#{asDocId}
    </update>
    
    <update id="updateBulkUploadDocLockStatus" parameterType="HashMap">
        update BULK_UPLOAD set LOCK_IN_PROGRESS=SYSTIMESTAMP,MODIFIED_BY_USERID=#{modifiedBy},MODIFIED_DATE=SYSTIMESTAMP where DOCUMENT_ID=#{asDocId}
    </update>
    
    
    <update id="bulkUploadSystemFailure" parameterType="HashMap">
        update BULK_UPLOAD set status=#{BULK_UPLOAD_SYSTEM_FAILURE},MODIFIED_BY_USERID=#{modifiedBy},
        MODIFIED_DATE=SYSTIMESTAMP where BULK_UPLOAD_ID = #{BulkUpload}
    </update>        

    <insert id="insertBulkUploadStatusByRecord" parameterType="com.batch.bulkupload.BulkUploadContractInfo"> 
        INSERT INTO BULK_UPLOAD_DATA
       (BULK_UPLOAD_DATA_ID,BULK_UPLOAD_ID,
        ROW_NO,CONTRACT_TYPE,AWARD_EPIN,AGENCY,
        ACCELERATOR_PROGRAM_NAME,CONTRACT_TITLE,
        CONTRACT_VALUE,CONTRACT_START_DATE,
       CONTRACT_END_DATE,UPLOAD_FLAG,ERROR_MESSAGE,
       CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,
       MODIFIED_BY_USERID)
       VALUES(SEQ_BULK_UPLOAD_DATA_ID.NEXTVAL,#{fileUploadId},#{rowNumber},
       #{contractType},#{epin},#{agency},#{accProgramName},
       #{contractTitle},#{contractValue},
       #{contractStartDate},
       #{contractEndDate},
       #{uploadFlag},#{errorMessage},SYSTIMESTAMP,
       #{createdByUserId},SYSTIMESTAMP,#{modifiedByUserId})
    </insert>
    
    <select id="getAmendAffectedBudgetIds"  parameterType="com.nyc.hhs.model.ContractBean"    resultType="String">
        
        SELECT Distinct BUDGET_ID
        FROM BUDGET_CUSTOMIZATION
        WHERE CONTRACT_ID = #{contractId}
        
    </select>
    
    <select id="fetchEntryTypeForBaseAmendMerge" parameterType="com.nyc.hhs.model.ContractBean" resultType="String">

        SELECT ENTRY_TYPE_ID
        FROM BUDGET_CUSTOMIZATION
        WHERE CONTRACT_ID = #{contractId}
        AND BUDGET_ID = #{amendAffectedBudgetId}

    </select>
    
    <insert id="mergeBaseBudCustomization" parameterType="hashmap">

        INSERT INTO BUDGET_CUSTOMIZATION 
        (BUDGET_CUSTOMIZATION_ID,
        CONTRACT_ID,
        BUDGET_ID,
        ENTRY_TYPE_ID,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID,
        ISPUBLISHED)
        values
        (
        SEQ_BUDGET_CUSTOMIZATION_ID.nextval,
        #{contractID},
        ( SELECT PARENT_ID FROM BUDGET WHERE BUDGET_ID = #{budgetID}),
        #{entryTypeId},
        SYSTIMESTAMP,
        #{User},
        SYSTIMESTAMP,
        #{User},
        '1'
        )
        
    </insert>
    
    <select id="fetchAmendAffectedBaseBudgetIds" parameterType="String" resultType="String">

        SELECT LISTAGG(PARENT_ID, ',') WITHIN GROUP (ORDER BY PARENT_ID)  FROM BUDGET  WHERE CONTRACT_ID = #{contractID}

    </select>
    
    <select id="getTotalContracts" parameterType="String" resultType="java.lang.Integer">
        select count(1) as total_contracts from bulk_upload_data bud
        where bud.bulk_upload_id = #{bulkUploadId}
    </select>
    
    <resultMap id="bulkUploadData" type="com.batch.bulkupload.BulkUploadContractInfo">
        <result property="bulkUploadDataId" column="bulk_upload_data_id" />
        <result property="errorMessage" column="error_details" />
        <result property="fileUploadId" column="bulk_upload_id" />
    </resultMap>
    
    <select id="getErrorList" parameterType="String" resultMap="bulkUploadData">
        select bud.bulk_upload_data_id,bud.bulk_upload_id, 
        'ROW: ' || bud.row_no ||'; Error Message: ' || bud.error_message as error_details from bulk_upload_data bud
        where bud.bulk_upload_id = #{bulkUploadId} and bud.error_message != 'Processed'
    </select>

    
    <select id="getBaseContractId" parameterType="String" resultType="String">
    select PARENT_CONTRACT_ID from contract where contract_id = #{asContractId}
    </select>
    
    <update id="updatePdfStatusNotStarted" parameterType="hashmap">
    UPDATE pdf_batch_details
    SET status            = #{status},
     modified_by_user_id = #{userId},
      modified_date       = systimestamp
    WHERE sub_entity_id   = #{asContractId}
    </update>
    
    <!-- Start Release 3.8.0 Enhancement 6481 -->
    <select id="getPendingRegContractApprovedBudgetCount" parameterType="String"
        resultType="integer">
    select count(1) from budget where contract_id = #{asContractId}    and status_id in (85,86)
    </select>
    <select id="fetchContractForUpdateTask" parameterType="String"
        resultType="String">
    select contract_id from contract where parent_contract_id = #{asContractId} and contract_type_id =4 
    and delete_flag = 0
    </select>
    <!-- End Release 3.8.0 Enhancement 6481 -->    


    <!-- Start || Added For Enhancement 6000 for Release 3.8.0 -->
    
    <select id="fetchApproveActiveBudget" parameterType="String"
        resultType="int">
        select count(*)
        from BUDGET
        WHERE CONTRACT_ID = #{contractId}
        And STATUS_ID in ('85','86')
    </select>
    
    <select id="fetchParentContractIdList" parameterType="String"
        resultType="String">
    select  LISTAGG(contract_id,',') WITHIN GROUP (ORDER BY contract_id) from contract where parent_contract_id in ( #{asContractId})
    </select>
    <delete id="deletePersonnelService" parameterType="String">
        DELETE FROM PERSONNEL_SERVICE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteOpSupportOthers" parameterType="String">
        DELETE FROM OTHER_DETAILS WHERE entity_id IN (select operations_support_id FROM OPERATIONS_AND_SUPPORT WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})) AND entry_type_id='2'
    </delete>
    <delete id="deleteOpSupport" parameterType="String">
        DELETE FROM OPERATIONS_AND_SUPPORT WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteUtilities" parameterType="String">
        DELETE FROM UTILITIES WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteProffServiceOthers" parameterType="String">
        DELETE FROM OTHER_DETAILS WHERE entity_id IN (select professional_service_id FROM PROFESSIONAL_SERVICE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})) AND entry_type_id='4'
    </delete>
    <delete id="deleteProffService" parameterType="String">
        DELETE FROM PROFESSIONAL_SERVICE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteRent" parameterType="String">
        DELETE FROM RENT WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteContractedService" parameterType="String">
        DELETE FROM CONTRACTED_SERVICE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteRate" parameterType="String">
        DELETE FROM RATE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteMilestone" parameterType="String">
        DELETE FROM MILESTONE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteUnallocated" parameterType="String">
        DELETE FROM UNALLOCATED WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteIndirectRate" parameterType="String">
        DELETE FROM INDIRECT_RATE WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteProgIncomeOthers" parameterType="String">
        DELETE FROM OTHER_DETAILS WHERE entity_id IN (select program_income_id FROM PROGRAM_INCOME WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})) AND entry_type_id='11'
    </delete>
    <delete id="deleteProgramIncome" parameterType="String">
        DELETE FROM PROGRAM_INCOME WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteFringeBenefit" parameterType="String">
        DELETE FROM FRINGE_BENEFIT WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <delete id="deleteEquipment" parameterType="String">
        DELETE FROM EQUIPMENT WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>    
    
    <delete id="deleteSubBudgetSite" parameterType="String">
        DELETE FROM SUB_BUDGET_SITE WHERE sub_budget_id IN (select sub_budget_id FROM SUB_BUDGET WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId}))
    </delete>
    <delete id="deleteSubBudget" parameterType="String">
        DELETE FROM SUB_BUDGET WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>    
    
    <delete id="deleteBudgetCustomiz" parameterType="String">
        DELETE FROM BUDGET_CUSTOMIZATION WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <delete id="deleteBudgetDoc" parameterType="String">
        DELETE FROM BUDGET_DOCUMENT WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <delete id="deleteAssociatedBudgets" parameterType="String">
        DELETE FROM BUDGET WHERE CONTRACT_ID = #{asContractId}
    </delete>    
    
    <delete id="deleteContractFinFunding" parameterType="String">
        DELETE FROM CONTRACT_FIN_FUNDING_STREAM WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <delete id="deleteContractFinancials" parameterType="String">
        DELETE FROM CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <delete id="deleteContractDoc" parameterType="String">
        DELETE FROM CONTRACT_DOCUMENT WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <delete id="deleteContract" parameterType="String">
        DELETE FROM CONTRACT WHERE CONTRACT_ID = #{asContractId}
    </delete>

    <select id="fetchContractTitleAndOrgID" parameterType="String"
        resultType="map">
        select contract_title,organization_id,agency_id
        from CONTRACT
        WHERE CONTRACT_ID = #{contractId}
    </select>
    
    <select id="fetchPendingBudget" parameterType="String"
        resultType="int">
        select count(*)
        from BUDGET
        WHERE CONTRACT_ID = #{contractId}
        And STATUS_ID in ('82','83','84')
    </select>
    
    <select id="fetchBudgetsForContract" parameterType="String"
        resultType="String">
        select BUDGET_ID
        FROM BUDGET WHERE CONTRACT_ID = #{asContractId,jdbcType=VARCHAR}
    </select>
    
    <select id="fetchContractBudgetDocs" parameterType="String"
        resultType="String">
        select DOCUMENT_IDENTIFIER_ID from contract_document where contract_id in 
        (select contract_id from contract where parent_contract_id = #{asContractId,jdbcType=VARCHAR}) 
        UNION ALL
        select DOCUMENT_IDENTIFIER_ID from budget_document where contract_id in 
        (select contract_id from contract where parent_contract_id = #{asContractId,jdbcType=VARCHAR})
    </select>
    
    <!-- End || Added For Enhancement 6000 for Release 3.8.0 -->
    
    <!-- Start || Added For Enhancement 6482 for Release 3.8.0 -->
    <!-- R6: Updated query to also fetch REF_APT_EPIN_ID -->
    <select id="findContractEpin" parameterType="String"
        resultType="map">
        select EXT_EPIN, AGENCY_ID, REF_APT_EPIN_ID
        FROM CONTRACT WHERE CONTRACT_ID = #{contractId}
    </select>
    <select id="findAgencyName" parameterType="String"
        resultType="String">
        select AGENCY_NAME
        FROM NYC_AGENCY_DETAILS WHERE AGENCY_ID = #{agencyId}
    </select>
        <update id="updateContractForTitleProgramName" parameterType="hashmap">
        UPDATE CONTRACT
        SET CONTRACT_TITLE  = #{asUpdatedContractTitle},
        PROGRAM_ID = #{asProgramId},
         MODIFIED_BY_USERID = #{asUserId},
          modified_date       = systimestamp
        WHERE CONTRACT_ID   = #{asContractId}
    </update>
    
    <update id="updateBudgetForTitleProgramName" parameterType="hashmap">
        UPDATE BUDGET
        SET PROGRAM_ID = #{asProgramId},
         MODIFIED_BY_USERID = #{asUserId},
          modified_date       = systimestamp
        WHERE CONTRACT_ID   = #{asContractId}
    </update>
    <!-- End || Added For Enhancement 6482 for Release 3.8.0 -->
    
    <!-- Start of Release 3.12.0 Enhancement 6601 -->
    
    <select id="getAmendmentRegisterdInFms" parameterType="hashmap" resultMap="contractsList">
        with ref_h as (
        select distinct trkg_no,max(doc_vers_no) max_doc_vers_no,MAX_CNTRC_AM,cntrct_end_dt from ref_contracts_h  group by trkg_no,MAX_CNTRC_AM,cntrct_end_dt),
        CONTRACT_TEMP AS (
        SELECT SUM(BASE.CONTRACT_AMOUNT+ AMEND.CONTRACT_AMOUNT) TOTAL_CONTRACT_AMOUNT, AMEND.EXT_EPIN,AMEND.EXT_DOC_VERSION,AMEND.CONTRACT_END_DATE,AMEND.contract_id FROM CONTRACT BASE, CONTRACT AMEND WHERE AMEND.DELETE_FLAG=0 AND AMEND.STATUS_ID IN (128,129)
        <!--Added amend.request_partial_merge != 2 for defect 8644 part 3  --> and amend.request_partial_merge != 2
        AND AMEND.CONTRACT_TYPE_ID=2 AND AMEND.IS_AMENDMENT_REGISTERED_IN_FMS=0 AND BASE.CONTRACT_ID=AMEND.PARENT_CONTRACT_ID  GROUP BY AMEND.EXT_EPIN, AMEND.EXT_DOC_VERSION,AMEND.CONTRACT_END_DATE,AMEND.CONTRACT_ID)
        SELECT CONTRACT_ID FROM CONTRACT_TEMP , REF_H WHERE EXT_EPIN = TRKG_NO
                
    </select>
    
    <!-- Defect 8644 Part 3 changes start -->
    <!-- <update id="getAmendmentRegisterdInFmsWithPM" parameterType="hashmap" >
       update contract set status_id=118 where contract_id in (with ref_h as (
        select distinct trkg_no,max(doc_vers_no) max_doc_vers_no,MAX_CNTRC_AM,cntrct_end_dt from ref_contracts_h  group by trkg_no,MAX_CNTRC_AM,cntrct_end_dt),
        CONTRACT_TEMP AS (
        SELECT SUM(BASE.CONTRACT_AMOUNT+ AMEND.CONTRACT_AMOUNT) TOTAL_CONTRACT_AMOUNT, AMEND.EXT_EPIN,AMEND.EXT_DOC_VERSION,AMEND.CONTRACT_END_DATE,AMEND.contract_id FROM CONTRACT BASE, CONTRACT AMEND WHERE AMEND.DELETE_FLAG=0 AND AMEND.STATUS_ID IN (128,129) and amend.request_partial_merge = 2
        AND AMEND.CONTRACT_TYPE_ID=2 AND AMEND.IS_AMENDMENT_REGISTERED_IN_FMS=0 AND BASE.CONTRACT_ID=AMEND.PARENT_CONTRACT_ID  GROUP BY AMEND.EXT_EPIN, AMEND.EXT_DOC_VERSION,AMEND.CONTRACT_END_DATE,AMEND.CONTRACT_ID)
        SELECT CONTRACT_ID FROM CONTRACT_TEMP , REF_H WHERE EXT_EPIN = TRKG_NO)
    
    </update> -->
    
    
         <select id="getPartialMergeRequestList" parameterType="hashmap" resultMap="contractsList">
        
        select contract_id from contract where REQUEST_PARTIAL_MERGE=1
        
        </select>
        <!-- Defect 8644 Part 3 changes end -->
    
    <update id="updateFlagAmendmentRegisteredInFMS" parameterType="hashmap">
        update contract set IS_AMENDMENT_REGISTERED_IN_FMS = 1, modified_by_userid=#{userId,jdbcType=VARCHAR}, modified_date= systimestamp where contract_id in (
        with ref_h as (
        select distinct trkg_no,max(doc_vers_no) max_doc_vers_no,MAX_CNTRC_AM,cntrct_end_dt from ref_contracts_h  group by trkg_no,MAX_CNTRC_AM,cntrct_end_dt),
        CONTRACT_TEMP AS (
        SELECT SUM(BASE.CONTRACT_AMOUNT+ AMEND.CONTRACT_AMOUNT) TOTAL_CONTRACT_AMOUNT, AMEND.EXT_EPIN,AMEND.EXT_DOC_VERSION,AMEND.CONTRACT_END_DATE,AMEND.contract_id FROM CONTRACT BASE, CONTRACT AMEND WHERE AMEND.DELETE_FLAG=0 
        AND AMEND.STATUS_ID IN (128,129)
        AND AMEND.CONTRACT_ID = #{contractID}
        and amend.contract_type_id=2 and amend.IS_AMENDMENT_REGISTERED_IN_FMS=0 and base.contract_id=amend.parent_contract_id  group by amend.ext_epin, amend.ext_doc_version,amend.contract_end_date,AMEND.contract_id),
        curr_ref_h  as (
        select contract_id from contract_temp , ref_h where ext_epin = trkg_no
        )
        SELECT contract_id FROM CURR_REF_H
        ) and STATUS_ID IN (128,129)
    </update>
    
    <update id="resetFlagAmendmentRegisteredInFMS" parameterType="hashmap">
    update contract set IS_AMENDMENT_REGISTERED_IN_FMS = 0, modified_by_userid=#{userId,jdbcType=VARCHAR}, modified_date= systimestamp where contract_id =#{contractId}
    </update>
    
    <update id="markAmendmentETLRegistredWhichAreRegisteredInFMS" parameterType="hashmap">
        update contract set status_id = 118, modified_by_userid=#{userId,jdbcType=VARCHAR}, modified_date= systimestamp,UPDATE_FLAG = '1' where ext_epin in (
        with ref_h as (
        select distinct trkg_no,max(doc_vers_no) max_doc_vers_no,MAX_CNTRC_AM,cntrct_end_dt from ref_contracts_h  group by trkg_no,MAX_CNTRC_AM,cntrct_end_dt),
        contract_temp as (
        select sum(base.contract_amount+ amend.contract_amount) total_contract_amount, amend.ext_epin,amend.ext_doc_version,amend.contract_end_date from contract base, contract amend where amend.delete_flag=0 and amend.status_id in (61,130)
        and amend.contract_type_id=2 and base.contract_id=amend.parent_contract_id and amend.IS_AMENDMENT_REGISTERED_IN_FMS=0 group by amend.ext_epin, amend.ext_doc_version,amend.contract_end_date),
        curr_ref_h  as (
        select ext_epin from contract_temp , ref_h where ext_epin = trkg_no
        <!-- and ext_doc_version =  max_doc_vers_no
        and total_contract_amount=MAX_CNTRC_AM 
        and contract_end_date=cntrct_end_dt-->
        )
        select ext_epin from curr_ref_h
        
        union all
        
        select ext_epin from contract where IS_AMENDMENT_REGISTERED_IN_FMS = 1 and contract_type_id = 2 and delete_flag = 0 and status_id in (61,130) 
        ) and STATUS_ID IN (61,130)
    </update>
    
    <!-- Start R7 Defect: 8644 part 3  -->
    <update id="markAmendmentETLRegistredWithPartialMergeRequest" parameterType="hashmap">
    update contract set IS_AMENDMENT_REGISTERED_IN_FMS =1 where REQUEST_PARTIAL_MERGE=2 and status_id = 118 and contract_type_id = 2
    
    </update>
    <!-- End R7 Defect: 8644 part 3 -->
    <select id="fetchAmendmentContractBudgets" parameterType="HashMap"    resultMap="contractBudgetsList">
        SELECT 
        BUDGET_ID,
        FISCAL_YEAR_ID     
        FROM  
        BUDGET        
        WHERE CONTRACT_ID = #{contractID}
     </select>    
     
     <select id="fetchAmendmentContractBudgetsAlreadyMerged" parameterType="HashMap"    resultMap="contractBudgetsList">
          SELECT FISCAL_YEAR_ID FROM CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{contractID}
          MINUS
          select fiscal_year_id from budget where contract_id = #{contractID} 
          <!-- start release 3.14.0 -->
          and active_flag=1
          <!-- end release 3.14.0 -->
      </select>
     
     <!-- start release 3.14.0 -->
     <select id="mismatchContractFinancialsAndBudgetAmount" parameterType="HashMap"    resultMap="contractBudgetsList">
         SELECT fiscal_year_amount,fiscal_year_id FROM BUDGET WHERE CONTRACT_ID IN (#{parentContractId}) and ACTIVE_FLAG= 1
         and status_id!=106 and budget_type_id = 2
        and fiscal_year_id  not  in  <foreach item="items" index="index" collection="loAmendmentBudgetList"
            open="(" separator="," close=")">
            #{items}
        </foreach>
        minus
        select sum(amount),fiscal_year_id from contract_financials where CONTRACT_ID IN (#{parentContractId}) and ACTIVE_FLAG= 1
            and fiscal_year_id not in  <foreach item="items" index="index" collection="loAmendmentBudgetList"
            open="(" separator="," close=")">
            #{items}
        </foreach>
        GROUP BY FISCAL_YEAR_ID
    </select>
    <!-- end release 3.14.0 -->
    
    <select id="getContractFinancialsInformation" parameterType="HashMap"    resultType="String">
             select sum(amount) from contract_financials where CONTRACT_ID IN (#{parentContractId}) and ACTIVE_FLAG= 1
            and fiscal_year_id in (#{fiscalYearID})
    </select>
     
     <select id="getContractInformation" parameterType="HashMap" resultType="HashMap">
             select CONTRACT_TITLE,EXT_CT_NUMBER from contract where CONTRACT_ID IN (#{parentContractId}) and delete_flag= 0
    </select>
     
     <select id="cancelAmendmentCheckRegisteredInFms" parameterType="HashMap" resultType="integer">
     select count(trkg_no) from ref_contracts_h where trkg_no in (select ext_epin from contract where contract_id = #{amendcontractid})
     </select>
    <!-- End of Release 3.12.0 Enhancement 6601 -->
    
    <!--Start Release 5 contract restriction -->
    <select id="fetchUserAccessDetails" parameterType="hashmap"
        resultMap="fetchUserAccessData">
        select sd.staff_id , sd.first_name || ' ' || sd.last_name
        user_name,
        decode(nvl(cr.staff_id,0),0, 0, 1) user_access_flag,
        decode(so.permission_level,'Level 2', 'L2','L1') permission_level,
        sd.email email from
        contract c inner join staff_organization so on
        c.organization_id =
        so.organization_id
        inner join staff_details sd on
        sd.staff_id = so.staff_id
        left join contract_restriction cr on
        c.contract_id = cr.contract_id and
        cr.organization_id =
        so.organization_id and cr.staff_id = sd.staff_id
        where
        c.contract_id =
        #{asContractId} and so.ACTIVE_FLAG='Yes'
        and permission_level in ( 'Level 1','Level 2')
        and permission_type in ('F','FP')
        and sd.user_dn is not null
        and sd.staff_id != #{userId}
        order by user_name, permission_level,email
    </select>
    <resultMap id="fetchUserAccessData" type="com.nyc.hhs.model.ContractBean">
        <result property="staffId" column="STAFF_ID" />
        <result property="userName" column="USER_NAME" />
        <result property="accessFlag" column="USER_ACCESS_FLAG" />
        <result property="email" column="EMAIL" />
        <result property="permission_level" column="PERMISSION_LEVEL" />
    </resultMap>

    <select id="fetchL2Count" parameterType="com.nyc.hhs.model.ContractBean" resultType="int">
        select count(o.staff_id) STAFF_ID 
        from contract c 
        inner join staff_organization o 
        on c.organization_id=o.organization_id 
        and c.contract_id=#{contractId}
        and o.permission_level  in ('Level 2')
        and o.ACTIVE_FLAG = 'Yes'
        and o.permission_type in ('FP','F')
        <if test="userListWithoutAccess.size > 0">
        and o.staff_id not in
        <foreach item="items" index="index" collection="userListWithoutAccess"
                    open="(" separator="," close=")">
                    #{items}
        </foreach>
         </if>
          and 
        o.staff_id not in (select staff_id from CONTRACT_RESTRICTION where staff_id =#{userId} and contract_id = #{contractId})
       
    </select>

    <delete id="deleteContractRestriction" parameterType="hashmap">
        delete from
        contract_restriction where contract_id=#{contractID} 
        and staff_id ! = #{userId} 
    </delete>

    <insert id="insertContractRestrictonDetails" parameterType="hashmap">
        insert into
        contract_restriction(
        CONTRACT_RESTRICTION_ID,
        CONTRACT_ID,
        STAFF_ID,
        ORGANIZATION_ID,
        CREATED_DATE,
        CREATED_BY_STAFF_ID,
        MODIFIED_DATE,
        MODIFIED_BY_STAFF_ID ) values
        (
        SEQ_CONTRACT_RESTRICTION_ID.NEXTVAL,#{contractID},#{staffID},
        (select
        organization_id from contract where contract_id =#{contractID} )
        ,sysdate,#{userId},sysdate,#{userId}
        )
    </insert>
    <!--End Release 5 contract restriction -->
    <!-- Added for R5: Cancel All Awards -->
        
    <update id="updateContractForNegotiationSeleted" parameterType="hashmap">
        update contract set status_id= #{contractStatus} where evaluation_pool_mapping_id = #{evaluationPoolMappingId} 
        and ORGANIZATION_ID= #{providerId} and status_id != 69
    </update>
    
    <update id="updateContractAmountAfterNegotiation" parameterType="hashmap">
    update contract set status_id=#{contractStatus} , contract_amount= (select sum(negotiated_award_amount)
    from evaluation_results eval, PROPOSAL_CONFIG PRO,ORGANIZATION ORG,
    EVALUATION_POOL_MAPPING EPM WHERE EVAL.PROPOSAL_ID = PRO.PROPOSAL_ID
    AND PRO.ORGANIZATION_ID = ORG.ORGANIZATION_ID
    AND PRO.PROC_REVIEW_STATUS_ID = 23 AND
    PRO.EVALUATION_GROUP_ID = EPM.EVALUATION_GROUP_ID AND PRO.COMPETITION_POOL_ID =
    EPM.COMPETITION_POOL_ID AND
    EPM.EVALUATION_POOL_MAPPING_ID = #{evaluationPoolMappingId} and org.organization_id = #{providerId} )
    where EVALUATION_POOL_MAPPING_ID=#{evaluationPoolMappingId} and organization_id = #{providerId} and status_id != 69
    </update>
    
    <select id="getParentContractIdForCancelAllAwards" parameterType="String"
        resultType="String">
    select  LISTAGG(contract_id,',') WITHIN GROUP (ORDER BY contract_id) from contract where evaluation_pool_mapping_id=#{evaluationPoolMappingId}
    </select>
    
    <select id="fetchEnableDisableCancelAllCount" parameterType="String"
        resultType="int">
    select count(contract_id) from contract where status_id in ('61','62','118') and 
    evaluation_pool_mapping_id = #{evaluationPoolMappingId}
    </select>
    
    <delete id="deleteDefaultAssignment" parameterType="String">
        DELETE FROM default_assignment WHERE CONTRACT_ID = #{asContractId}
    </delete>
    
    <delete id="deleteContractRestrictions" parameterType="String">
        DELETE FROM contract_restriction WHERE CONTRACT_ID = #{asContractId}
    </delete>
    <select id="ViewUserAccessDropdownFlag" parameterType="com.nyc.hhs.model.BaseFilter" resultType="int">
    select count(1) from staff_organization where  permission_level in ( 'Level 1','Level 2')
        and permission_type in ('F','FP') and admin_permission = 'Yes' and staff_id = #{userIdContractRestriction, jdbcType=VARCHAR} and organization_id = #{orgName}
    </select>
    <!-- Added for R5: Cancel All Awards -->
    <!-- Change for R5 : Defect 8363 Starts-->
    <select id="checkApprovalForFinance" parameterType="java.lang.String"
        resultType="int">
        select count(contract_id) from contract where contract_type_id=1 and status_id not in(58,69,165)
        and evaluation_pool_mapping_id =#{asEvaluationPoolMappingId} 
    </select>
    <!-- Change for R5 Starts-->
    <!-- R6 Changes start -->
    <delete id="deletePersonnelServicesDetails" parameterType="String">
        DELETE FROM PERSONNEL_SERVICE_DETAIL WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    
    <delete id="deleteFringeBenefitDetail" parameterType="String">
        DELETE FROM FRINGE_BENEFIT_DETAIL WHERE budget_id IN (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    <!-- Changed as part of R6 emergency build defect 8646 where we are checking if the current entity is not there in VW_LINKED_EPIN_DETAILS view -->
    <!-- Also added a check of entity type for Procurement table 'P' as entity_id can be same in two tables -->
    <select id="validateEpinIsUnique" parameterType="com.nyc.hhs.model.EPinDetailBean"
        resultType="int">
        SELECT count(*) from VW_LINKED_EPIN_DETAILS
        WHERE UPPER(epin) = UPPER(#{epinId})
        AND UPPER(agency_id) = UPPER(#{agencyId})
        <if test="procurementId != null and procurementId !=''">
        AND (entity_id != #{procurementId} AND entity_type = 'P')
        </if>
    </select>
    <!-- R6 Changes ends -->
    <!-- Start: Added for R7 8644 -->
        
    
    <delete id="deletePersonnelServicesDetailForFY" parameterType="String">
        DELETE FROM PERSONNEL_SERVICE_DETAIL WHERE budget_id = #{asBudgetId}
    </delete>
    
    <delete id="deleteFringeBenefitDetailForFY" parameterType="String">
        DELETE FROM FRINGE_BENEFIT_DETAIL WHERE budget_id = #{asBudgetId}
    </delete>
    
    
    <update id="addYearToContractEndDate" parameterType="String">
      Update Contract Set Contract_End_Date = Add_Months(Contract_End_Date,12) Where Contract_Id=#{contractId}
    </update>
    
    <insert id="addYearToContractFinancials" parameterType="String">
        Insert into CONTRACT_FINANCIALS 
        (CONTRACT_FINANCIALS_ID,
         PROCUREMENT_ID,
         CONTRACT_ID,
         UNIT_OF_APPROPRIATION,
         BUDGET_CODE,
         OBJECT_CODE,
         SUB_OBJECT_CODE,
         REPORTING_CATEGORY,
         FISCAL_YEAR_ID,
         AMOUNT,
         LAST_UPDATE_DATE,
         ACTIVE_FLAG,
         PARENT_ID,
         CREATED_DATE,
         CREATED_BY_USERID,
         MODIFIED_DATE,
         Modified_By_Userid)
     (Select Seq_Contract_Financials_Id.Nextval,Procurement_Id , Contract_Id, Unit_Of_Appropriation, Budget_Code, Object_Code, Sub_Object_Code,Reporting_Category,
    (Select Max(Fiscal_Year_Id)+1 From Contract_Financials Where Contract_Id=#{contractId}), '0', Sysdate , Active_Flag, SEQ_CONTRACT_FINANCIALS_ID.currval, Sysdate , 'agency_14', Sysdate, 'agency_14' From Contract_Financials
    where contract_id=#{contractId} and Fiscal_Year_Id=(Select Max(Fiscal_Year_Id) From Contract_Financials Where Contract_Id=#{contractId}))
    </insert>
        <!-- R7 Changes Starts for flag contract -->
    <delete id="updateContractLevelMessage" parameterType="map">
        delete from FLAG_CONTRACT_DETAILS  where contract_id=#{contractId}
    </delete>

    <insert id="saveContractLevelMessage" parameterType="map">
        insert into Flag_Contract_Details(FLAG_CONTRACT_DETAIL_ID,
        CONTRACT_ID,
        MESSAGE_TEXT,
        CREATED_DATE,
        CREATED_BY_USERID,
        MODIFIED_DATE,
        MODIFIED_BY_USERID
        )
        values(SEQ_contract_level_message.NEXTVAL,#{contractId},#{contractMessage},SYSTIMESTAMP,#{userId},SYSTIMESTAMP,#{userId})
    </insert>

    <insert id="saveContractLevelMessageHistory" parameterType="map">
    INSERT
INTO flag_contract_history
  (
    FLAG_CONTRACT_HISTORY_ID,
    FLAG_CONTRACT_DETAIL_ID,
    CONTRACT_ID,
    MESSAGE_TEXT,
    CREATED_DATE,
    CREATED_BY_USERID,
    MODIFIED_DATE,
    MODIFIED_BY_USERID
  )
  (SELECT SEQ_flag_contract_history.nextval,
      FLAG_CONTRACT_DETAIL_ID,
      CONTRACT_ID,
      MESSAGE_TEXT,
      CREATED_DATE,
      CREATED_BY_USERID,
      SYSTIMESTAMP,
      #{userId}
    FROM FLAG_CONTRACT_DETAILS
    WHERE contract_id=#{contractId}
  )
    </insert>
    

    <select id="retrieveContractMessage" parameterType="java.lang.String"
        resultMap="retriveMessageDetails">
        SELECT fcd.MESSAGE_TEXT,cu.FIRST_NAME||' '||cu.LAST_NAME AS flagged_by
        FROM Flag_Contract_Details fcd
        inner join CITY_USER_DETAILS cu
        on fcd.MODIFIED_BY_USERID=cu.USER_ID
        and fcd.contract_id = (select parent_contract_id from contract where
        contract_id=#{contractId} and rownum=1)
    </select>
    <resultMap id="retriveMessageDetails" type="com.nyc.hhs.model.ContractList">
        <result property="modifyBy" column="flagged_by" />
        <result property="contractMessage" column="message_text" />
    </resultMap>
    
    <select id="fetchUnflagOverlayDetails" parameterType="java.lang.String"
        resultMap="unflagBeanOverlay">
        select cu.FIRST_NAME||' '||cu.LAST_NAME as flagged_by,nvl(c.EXT_CT_NUMBER,'--') as EXT_CT_NUMBER,
         (select substr(agency_name,INSTR(agency_name,'-')+2) from nyc_agency_details where agency_id=c.agency_id) as agency_id,
        cl.message_text,c.contract_title,
        TO_CHAR(cl.created_date, 'MM/DD/YYYY') as created_date
        from Flag_Contract_Details cl
        left join city_user_details cu
        on cl.CREATED_BY_USERID=cu.USER_ID
        left join contract c
        on c.contract_id=cl.contract_id
        where cl.contract_id=#{contractId}
        and c.contract_type_id in(1,3) and rownum=1
    </select>

    <resultMap id="unflagBeanOverlay" type="com.nyc.hhs.model.ContractList">
        <result property="modifyBy" column="flagged_by" />
            <result property="agencyId" column="agency_id" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="dateLastUpdateTo" column="created_date" />
        <result property="contractMessage" column="message_text" />
        <result property="extCT" column="EXT_CT_NUMBER" />
    </resultMap>

    <select id="fetchFlagOverlayDetail" parameterType="string"
        resultMap="flagBeanOverlay">
         select c.contract_title,nvl(c.EXT_CT_NUMBER,'--') as EXT_CT_NUMBER,
        (select substr(agency_name,INSTR(agency_name,'-')+2) from nyc_agency_details where agency_id=c.agency_id) as agency_id
        from contract c where contract_id=(select
        parent_contract_id from contract where contract_id=#{contractId} and
        rownum=1) and contract_type_id=1
    </select>
        <resultMap id="flagBeanOverlay" type="com.nyc.hhs.model.ContractList">
            <result property="agencyId" column="agency_id" />
            <result property="contractTitle" column="CONTRACT_TITLE" />
            <result property="extCT" column="EXT_CT_NUMBER" />
    </resultMap>
    <!-- R7 changes Ends for flag contract-->
    <!-- Start:Added in R7 for Cost Center -->
    <update id="updateCostCenterEnabled" parameterType="hashmap">
        update contract set COST_CENTER_OPTED = #{statusId},
        MODIFIED_DATE = current_timestamp, MODIFIED_BY_USERID =
        #{createdByUserId}  where contract_id =  #{contractID} 
    </update>
    <!-- End:Added in R7 for Cost Center -->
    
    <!-- Start:Added in R7 for Cost-Center -->
    <delete id="deleteServices" parameterType="String">
    DELETE
    FROM bc_services_details
    WHERE budget_id IN
      (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    
    <delete id="deleteCostCenter" parameterType="String">
    DELETE
    FROM COST_CENTER_DETAILS
    WHERE budget_id IN
      (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    
    <delete id="deleteServicesConfig" parameterType="String">
    DELETE
    FROM BUDGET_SERVICES_CONFIGURATION
    WHERE budget_id IN
      (SELECT budget_id FROM BUDGET WHERE CONTRACT_ID = #{asContractId})
    </delete>
    
    <update id="updateCostCenterOptedForConCofReturn" parameterType="hashmap">
    update contract set COST_CENTER_OPTED = null,
    MODIFIED_DATE = current_timestamp, MODIFIED_BY_USERID =
    #{createdByUserId}  where contract_id =  #{contractID} and COST_CENTER_OPTED = 0
    </update>
    
    <!-- End:Added in R7 for Cost-Center -->
    
    <!--Start: R7 changes for defect 8705  -->
    <update id="budgetEndDateUpdatedInAmendment" parameterType="java.util.Map">
        UPDATE BUDGET SET BUDGET_END_DATE=#{budgetEndDate},MODIFIED_DATE=systimestamp, MODIFIED_BY_USERID =#{lastModifiedBy}
        WHERE BUDGET_ID=#{lsBudgetId}
    </update>
    
    <!-- Update in Emergency 7.0.1:Defect 9000 contract_end_date changed to proposed_end_date -->
    <select id="fetchBudgetDetails" parameterType="java.lang.String"
        resultType="hashmap">
     select budget_id,fiscal_year_id,TO_CHAR(budget_end_date,'MM/DD/YYYY') as budget_end_date, TO_CHAR((select proposed_contract_end_date from contract where contract_id=#{asContractId}),'MM/DD/YYYY') 
     as amend_contract_end_date
     from budget where contract_id in (select parent_contract_id from contract where contract_id=#{asContractId}) and budget_type_id=2
    </select>
        
    <select id="asRequestPartialMergeStatus" resultType="String">
            SELECT count(1) 
            from CONTRACT con
            WHERE con.PARENT_CONTRACT_ID = #{asContractId} and con.contract_type_id=2 and con.status_id !=62 and con.REQUEST_PARTIAL_MERGE &gt;0
      </select>
      
    <select id="fetchFYAmendContractEndDate" parameterType="java.util.Map"
        resultType="java.lang.String">
         select max(fiscal_year_id) from budget where contract_id=#{contractId}
    </select>
      <!--End: R7 changes for defect 8705  -->
          <!--Start: R7 changes for defect 8644  -->
          <select id="fetchRequestPartialMergeValue" resultType="String">
            SELECT count(1) 
            from CONTRACT con
            WHERE con.CONTRACT_ID = #{asContractId} and con.contract_type_id=2 and con.REQUEST_PARTIAL_MERGE &gt;0
      </select>
    <update id="baseContractBudgetStatus" parameterType="String">
        update budget set status_id=85 where BUDGET_ID=#{lsBudgetId} and budget_type_id=2 and status_id=86
    </update>
    <!--End: R7 changes for defect 8644  -->

    <!--Start: add for R7.11.0 QC9122   -->
    <select id="fetchContractBudgetStatusId" parameterType="com.nyc.hhs.model.ContractList"  resultMap="contractsList">
		select con.Contract_id , bud.budgetStatusId
		from  ( select   Contract_id from contract  where STATUS_ID in ( 61 ) and CONTRACT_TYPE_ID = 1) con , 
		      ( select   Contract_id, budget_id , status_id as budgetStatusId  from budget 
		         where   STATUS_ID  not  in ( 85, 86 )
		           and   BUDGET_TYPE_ID = 2
		           and   Contract_id  in ( select   distinct bud_inner.Contract_id    from budget bud_inner
		                             where    bud_inner.STATUS_ID not in ( 85, 86 )
		                               and    bud_inner.BUDGET_TYPE_ID = 2
		                            ) 
		       ) bud 
		where    con.Contract_id = bud.Contract_id (+)
		  and    bud.budgetStatusId   is not null
	</select>
    <!--End: add for R7.11.0 QC9122   -->



    <!--Start: add for R8.11.1     -->
    <select id="fetchContractBudgetStatusId_N"  parameterType="java.util.Map"  resultMap="contractsList">
		select con.Contract_id , bud.budgetStatusId
		from  ( select   Contract_id from contract  
		         where   Contract_id in <foreach item="items" index="index" collection="loConLst"
					                             open="(" separator="," close=")">
					                             #{items}
		                                </foreach>
		           and   STATUS_ID in ( 61 ) and CONTRACT_TYPE_ID = 1) con , 
		      ( select   Contract_id, budget_id , status_id as budgetStatusId  from budget 
		         where   Contract_id in <foreach item="items" index="index" collection="loConLst"
					                             open="(" separator="," close=")">
					                             #{items}
		                                </foreach>
		           and   STATUS_ID  not  in ( 85, 86 )
		           and   BUDGET_TYPE_ID = 2
		           and   Contract_id  in ( select   distinct bud_inner.Contract_id    from budget bud_inner
		                             where    bud_inner.STATUS_ID not in ( 85, 86 )
		                               and    bud_inner.BUDGET_TYPE_ID = 2
		                            ) 
		       ) bud 
		where    con.Contract_id = bud.Contract_id (+)
		  and    bud.budgetStatusId   is not null
	</select>
    <!--End: add for R7.11.1     -->





    <!--Start: add for R 8.1 QC9122   return list of Contracts (status 61) tha have at least one approved  budget -->
    <select id="fetchContractBudgetApprovedStatusId" parameterType="com.nyc.hhs.model.ContractList"  resultMap="contractsList">
		select con.Contract_id , bud.budgetStatusId
		from  ( select   Contract_id from contract  where STATUS_ID = 61  and CONTRACT_TYPE_ID = 1) con , 
		      ( select   Contract_id, budget_id , status_id as budgetStatusId  from budget 
		         where   STATUS_ID  = 86 
		           and   BUDGET_TYPE_ID = 2
		           and   Contract_id  in ( select   distinct bud_inner.Contract_id    from budget bud_inner
		                             where    bud_inner.STATUS_ID  =  86 
		                               and    bud_inner.BUDGET_TYPE_ID = 2
		                            ) 
		       ) bud 
		where    con.Contract_id = bud.Contract_id (+)
		  and    bud.budgetStatusId   is not null
	</select>
	<select id="fetchBaseContractStatusId" parameterType="java.lang.String" resultType="java.lang.Integer">
        select status_id from contract 
        where contract_id = #{asContractId}
              and contract_type_id = 1
    </select>
    <!--End: add for R 8.1 QC9122  return list of Contracts (status 61) tha have at least one approved  budget -->
    
    <!--Start:  R 8.2 QC9438 return number of Amendments in Processing Status with budhet that not approved yet for particular Fyscal Year -->
    <select id="getNegativeAmendmentCountForFY" parameterType="java.util.HashMap" resultType="java.lang.Integer">		
		select count(c.contract_id) as  negativeAmendCnt
		from contract c
		left join budget b on c.contract_id =  b.contract_id
		where (c.parent_contract_id = #{contractId} 
				and c.contract_type_id = 2
				and c.contract_amount &lt;0
				and b.BUDGET_TYPE_ID = 1
				and b.STATUS_ID not in(85, 86, 89, 87)
				and c.status_id not in(61, 62, 69, 67, 165, 142)
				and b.ACTIVE_FLAG = 1
				and b.fiscal_year_id = #{fiscalYearId} )
				or
				(c.parent_contract_id = #{contractId} 
				and c.contract_type_id = 2
				and c.contract_amount &lt;0
				and c.status_id in(59, 60) )
	</select>		
    <!--End:  R 8.2 QC9438 return number of Amendments in Processing Status with budhet that not approved yet for particular Fyscal Year -->
    
    <!-- Start QC 9388 R 8.4.0 Update last Approved/Active FY Budget with correct End Date -->
    <resultMap id="budgetDetailsList" type="com.nyc.hhs.model.ContractBudgetBean">		
		<result property="budgetId" column="BUDGET_ID" />		
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />		
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />
		<result property="budgetStartDate" column="BUDGET_START_DATE" />
		<result property="budgetEndDate" column="BUDGET_END_DATE" />
		<result property="statusId" column="STATUS_ID" />
		<result property="activeFlag" column="ACTIVE_FLAG" />
	</resultMap>
	
    <select id="fetchLastBaseApprovedFY" parameterType="java.lang.String" resultMap="budgetDetailsList">
    	select
    		BUDGET_ID ,
			BUDGET_TYPE_ID ,
			CONTRACT_ID ,
			FISCAL_YEAR_ID ,
			STATUS_ID ,
			BUDGET_START_DATE ,
			BUDGET_END_DATE ,
			ACTIVE_FLAG 
    	from BUDGET 
    	where CONTRACT_ID = #{asContractId}
    		and BUDGET_TYPE_ID='2' 
    		and status_id in (85, 86)
    		and active_flag = 1
      		and rownum = 1
    	order by FISCAL_YEAR_ID desc 
    </select>
    
    
    <resultMap id="baseContractInfo" type="com.nyc.hhs.model.ContractBean">
        <result property="contractId" column="CONTRACT_ID" />
        <result property="contractTitle" column="CONTRACT_TITLE" />
        <result property="contractTypeId" column="CONTRACT_TYPE_ID" />
        <result property="statusId" column="STATUS_ID" />
        <result property="contractAmount" column="CONTRACT_AMOUNT" />
        <result property="contractStartDate" column="CONTRACT_START_DATE" />
        <result property="contractEndDate" column="CONTRACT_END_DATE" />
        <result property="organizationId" column="ORGANIZATION_ID" />
        <result property="agencyId" column="AGENCY_ID" />        
        <result property="budgetStartYear" column="BUDGET_START_YEAR" />    
    </resultMap>
    
    <select id="fetchBaseContractStartEndDate" parameterType="java.lang.String" resultMap="baseContractInfo">
        SELECT 
        CONTRACT_ID, 
        CONTRACT_TITLE,
        CONTRACT_TYPE_ID, 
        STATUS_ID,
        PARENT_CONTRACT_ID,
        CONTRACT_AMOUNT, 
        CONTRACT_START_DATE, 
        CONTRACT_END_DATE,     
        EXT_CT_NUMBER,
        ORGANIZATION_ID,
        AGENCY_ID,
        BUDGET_START_YEAR
        from contract 
        where contract_id=#{asContractId}
        	and CONTRACT_TYPE_ID = 1
     </select>
    
   <!-- End QC 9388 R 8.4.0 Update last Approved/Active FY Budget with correct End Date -->
   
   <!-- [Start] QC 9452 R 8.5.0 Delete Contract from  Flagged Contracts History -->
    <delete id="deleteContractLevelMessageHistory" parameterType="map">
        delete from flag_contract_history  
        where contract_id=#{contractId}
    </delete>
   <!-- [End] QC 9452 R 8.5.0 Delete Contract from  Flagged Contracts History --> 


    <!--End: add for R 8.8 QC9400  -->
   	<select id="fetchAmendmentContractStatusId" parameterType="map" resultType="java.lang.Integer">
        SELECT STATUS_ID FROM CONTRACT 
        WHERE   CONTRACT_ID  = #{amendcontractid}
        AND     CONTRACT_TYPE_ID = 2       
    </select>
    <!--End: add for R 8.8 QC9400  -->
<!--     /* [Start] R8.10.0 QC9399    */ -->
    <select id="fetchAMDBaseDate" parameterType="HashMap"    resultMap="amendmentContractsForBatchProcessList">
        SELECT AC.CONTRACT_ID,  AC.CONTRACT_TITLE,
        AC.CONTRACT_TYPE_ID, 
        AC.CONTRACT_AMOUNT,          
        nvl(AC.FMS_CONTRACT_AMOUNT, AC.CONTRACT_AMOUNT) AS FMS_CONTRACT_AMOUNT, 
        AC.CONTRACT_START_DATE, 
        nvl(AC.FMS_CONTRACT_START_DATE, AC.CONTRACT_START_DATE) AS FMS_CONTRACT_START_DATE, 
        AC.CONTRACT_END_DATE, 
        nvl(AC.FMS_CONTRACT_END_DATE, AC.CONTRACT_END_DATE) AS FMS_CONTRACT_END_DATE,
        AC.PARENT_CONTRACT_ID,    
        PC.CONTRACT_TITLE AS PARENT_CONTRACT_TITLE,
        PC.CONTRACT_AMOUNT AS PARENT_CONTRACT_AMOUNT,
        PC.CONTRACT_START_DATE AS PARENT_CONTRACT_START_DATE, 
        PC.CONTRACT_END_DATE AS PARENT_CONTRACT_END_DATE,
        AC.DISCREPANCY_FLAG,
        AC.EXT_CT_NUMBER AS EXT_CT_NUMBER,
        PC.EXT_CT_NUMBER AS PARENT_EXT_CT_NUMBER,
        AC.ORGANIZATION_ID,
        AC.AGENCY_ID,
        ac.BUDGET_START_YEAR,
        PC.ORGANIZATION_ID AS PARENT_ORGANIZATION_ID,
        PC.AGENCY_ID AS PARENT_AGENCY_ID,
        PC.EXT_EPIN AS EXT_EPIN
        FROM  CONTRACT AC
        LEFT JOIN CONTRACT PC ON AC.PARENT_CONTRACT_ID=PC.CONTRACT_ID
        WHERE AC.CONTRACT_ID = #{contractId} 
    </select>
<!--     /* [End] R8.10.0 QC9399    */ -->

     <!--[Start] R9.2.0  QC9572  -->
     <select id="fetchContractsForSrtEndDisc" parameterType="hashmap"   resultMap="contractsForBatchProcessList">
        SELECT CONTRACT_ID, CONTRACT_TITLE, CONTRACT_TYPE_ID,  CONTRACT_AMOUNT, 
        nvl(FMS_CONTRACT_AMOUNT, CONTRACT_AMOUNT) AS FMS_CONTRACT_AMOUNT, 
        CONTRACT_START_DATE, 
        nvl(FMS_CONTRACT_START_DATE, CONTRACT_START_DATE) AS FMS_CONTRACT_START_DATE, 
        nvl(FMS_CONTRACT_END_DATE, CONTRACT_END_DATE) AS FMS_CONTRACT_END_DATE, 
        CONTRACT_END_DATE, DISCREPANCY_FLAG, EXT_CT_NUMBER,
        ORGANIZATION_ID,  AGENCY_ID, BUDGET_START_YEAR
        FROM   CONTRACT 
        WHERE  CONTRACT_ID = #{asContractId}
          AND  FMS_CONTRACT_AMOUNT is NOT NULL
          AND  FMS_CONTRACT_START_DATE is NOT NULL
          AND  FMS_CONTRACT_END_DATE is NOT NULL
     </select>

	 <update id="updateBudgetStartDateForDiscripancy" parameterType="hashmap" >
		UPDATE BUDGET 
			SET  BUDGET_START_DATE = to_date(#{contractStartDate}, 'MM/dd/yyyy')
			, MODIFIED_BY_USERID = #{modifiedByUserId}
			, MODIFIED_DATE = SYSTIMESTAMP
		WHERE CONTRACT_ID = #{contractId}
			AND FISCAL_YEAR_ID = #{contractStartFiscalYear}
			AND BUDGET_TYPE_ID = #{budgetTypeId}
			AND ACTIVE_FLAG = 1
	</update>
	<insert id="updateBudgetEndDateForDiscripancy" parameterType="hashmap" >
		MERGE INTO BUDGET  budget_Dis 
        using (select  BUDGET_ID,BUDGET_TYPE_ID , CONTRACT_ID, FISCAL_YEAR_ID, FISCAL_YEAR_AMOUNT, BUDGET_START_DATE , BUDGET_END_DATE , ACTIVE_FLAG
                from   BUDGET
               WHERE CONTRACT_ID = #{contractId}
                 AND FISCAL_YEAR_ID = #{contractEndFiscalYear}
                 AND BUDGET_TYPE_ID =#{budgetTypeId}2
                 AND ACTIVE_FLAG = 1 
              ) Tmp
      ON (   Tmp.CONTRACT_ID = budget_Dis.CONTRACT_ID 
             and  Tmp.FISCAL_YEAR_ID = budget_Dis.FISCAL_YEAR_ID   
             and  Tmp.BUDGET_TYPE_ID =  budget_Dis.BUDGET_TYPE_ID
             and  Tmp.ACTIVE_FLAG =  budget_Dis.ACTIVE_FLAG 
         )
      WHEN MATCHED THEN
    	  UPDATE  
          SET budget_Dis.BUDGET_END_DATE = to_date(#{contractEndDate}, 'MM/dd/yyyy')
            , budget_Dis.MODIFIED_DATE = SYSTIMESTAMP
            , budget_Dis.MODIFIED_BY_USERID = {modifiedByUserId}
          WHERE Tmp.CONTRACT_ID = budget_Dis.CONTRACT_ID 
             AND  Tmp.FISCAL_YEAR_ID = budget_Dis.FISCAL_YEAR_ID   
             AND  Tmp.BUDGET_TYPE_ID =  budget_Dis.BUDGET_TYPE_ID
             AND  Tmp.ACTIVE_FLAG =  budget_Dis.ACTIVE_FLAG 
	</insert>
	
	<update id="updateContractStartEndDateForDiscripancy" parameterType="hashmap" >
		UPDATE CONTRACT 
			SET	 CONTRACT_START_DATE = to_date(#{contractStartDate}, 'MM/dd/yyyy')
			,    CONTRACT_END_DATE = to_date(#{contractEndDate}, 'MM/dd/yyyy')
			,    MODIFIED_BY_USERID = #{modifiedByUserId}
			,    MODIFIED_DATE = SYSTIMESTAMP
		WHERE CONTRACT_ID = #{contractId}
			AND CONTRACT_TYPE_ID = #{contractTypeId}
	</update>

 	<resultMap id="financialFYList" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="id" column="TABLE_ID" />
		<result property="contractId" column="CONTRACT_ID" />
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
	</resultMap>

    <!-- parameterType="HashMap" resultType="HashMap" -->
    <select id="fetchContractFinalcialsFY" parameterType="hashmap"    resultMap="financialFYList">
     select  TABLE_ID,  CONTRACT_ID, FISCAL_YEAR_ID 
      from  (  select 'CONTRACT_FIN_FUNDING_STREAM' as TABLE_ID, CONTRACT_ID, FISCAL_YEAR_ID 
		         from CONTRACT_FIN_FUNDING_STREAM
		        where contract_id = #{contractId}     and   ACTIVE_FLAG = 1
		        union 
		       select  'CONTRACT_FINANCIALS' as TABLE_ID, CONTRACT_ID, FISCAL_YEAR_ID 
		        from CONTRACT_FINANCIALS
		       where contract_id = #{contractId}     and   ACTIVE_FLAG = 1
            )		
    </select>

    <insert id="addContractFinalcialsForDiscripancy" parameterType="hashmap">
		insert into CONTRACT_FINANCIALS
		      ( CONTRACT_FINANCIALS_ID, CONTRACT_ID , UNIT_OF_APPROPRIATION ,BUDGET_CODE,OBJECT_CODE ,SUB_OBJECT_CODE,REPORTING_CATEGORY
		       ,FISCAL_YEAR_ID,  AMOUNT,  LAST_UPDATE_DATE, ACTIVE_FLAG, PARENT_ID, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, APPROVED_BY, APPROVED_DATE)
		select SEQ_CONTRACT_FINANCIALS_ID.nextval, N.CONTRACT_ID, N.UNIT_OF_APPROPRIATION ,N.BUDGET_CODE,N.OBJECT_CODE ,N.SUB_OBJECT_CODE ,N.REPORTING_CATEGORY
		, #{newFiscalYearId} , 0 , SYSTIMESTAMP, 1, SEQ_CONTRACT_FINANCIALS_ID.currval , SYSTIMESTAMP, 'system',SYSTIMESTAMP, 'system',N.APPROVED_BY, N.APPROVED_DATE 
		 From  CONTRACT_FINANCIALS N 
		 Where contract_id = #{contractId} 
		 and  ACTIVE_FLAG = 1 
		 and  FISCAL_YEAR_ID = #{contractStartFiscalYear}
    </insert>

    <insert id="addContractFinStreamForDiscripancy" parameterType="hashmap">
    Insert  into CONTRACT_FIN_FUNDING_STREAM 
		 ( CONTRACT_FUNDING_ID,	 PROCUREMENT_ID, CONTRACT_ID, FEDERAL_AMOUNT, STATE_AMOUNT, CITY_AMOUNT,
		   OTHER_AMOUNT, FISCAL_YEAR_ID, LAST_UPDATE_DATE, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID)
    select  SEQ_CONTRACT_FUNDING_ID.nextval as CONTRACT_FUNDING_ID, PROCUREMENT_ID, CONTRACT_ID, FEDERAL_AMOUNT, STATE_AMOUNT, CITY_AMOUNT,
		    OTHER_AMOUNT, #{newFiscalYearId} as FISCAL_YEAR_ID, LAST_UPDATE_DATE, ACTIVE_FLAG, SYSTIMESTAMP as CREATED_DATE,
		   'system' as CREATED_BY_USERID, SYSTIMESTAMP as MODIFIED_DATE, 'system' as MODIFIED_BY_USERID
    from   CONTRACT_FIN_FUNDING_STREAM
		 Where contract_id = #{contractId} 
		 and  ACTIVE_FLAG = 1 
		 and  FISCAL_YEAR_ID = #{contractStartFiscalYear}
    </insert>
    
        <!--[eND] R9.2.0  QC9572  -->


</mapper>

