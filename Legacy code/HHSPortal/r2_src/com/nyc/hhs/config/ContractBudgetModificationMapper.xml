<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.nyc.hhs.service.db.services.application.ContractBudgetModificationMapper">

	<resultMap id="fetchInfo" type="com.nyc.hhs.model.CBGridBean">
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="parentSubBudgetId" column="PARENT_ID" />
		<result property="subBudgetName" column="SUB_BUDGET_NAME" />
		<result property="subBudgetAmount" column="SUB_BUDGET_AMOUNT" />
	</resultMap>

	<!-- build 2.6.0, defect id 5683 -->
	<insert id="insertNewBudgetModificationDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">	
		Insert into BUDGET 
		(BUDGET_ID,
		BUDGET_TYPE_ID,
		CONTRACT_ID,
		FISCAL_YEAR_ID,
		FISCAL_YEAR_AMOUNT,
		AGENCY_ID,
		ORGANIZATION_ID,
		PROGRAM_ID,
		CT_NUMBER,
		STATUS_ID,
		BUDGET_START_DATE,
		BUDGET_END_DATE,
		LAST_UPDATE_DATE,
		ACTIVE_FLAG,
		DELETE_FLAG,
		PREV_STATUS_ID,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_STAFFID,
		PARENT_ID) 
		values		
		(SEQ_BUDGET_ID.NEXTVAL,
		#{budgetTypeId},
		#{contractId},
		#{budgetfiscalYear},
		#{totalbudgetAmount},
		(SELECT AGENCY_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),	
		(SELECT ORGANIZATION_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),		
		(SELECT PROGRAM_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),
		(SELECT EXT_CT_NUMBER FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),
		#{statusId},
		(SELECT BUDGET_START_DATE FROM BUDGET WHERE BUDGET_ID=#{parentId}),
		(SELECT BUDGET_END_DATE FROM BUDGET WHERE BUDGET_ID=#{parentId}),
		SYSTIMESTAMP,
		#{activeFlag},
		'0',		
		'',
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{modifiedByUserId},
		#{parentId})
	</insert>
	
	<!--Release 3.6.0 Enhancement id 6484 -->
	<select id="getSeqForSubBudgetId" resultType="Integer">
		SELECT
		SEQ_SUB_BUDGET_ID.NEXTVAL FROM DUAL
	</select>
	<insert id="insertNewSubBudgetModificationDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">	
		Insert into SUB_BUDGET 
		(SUB_BUDGET_ID,
		BUDGET_ID,
		FISCAL_YEAR_ID,
		PARENT_ID,
		SUB_BUDGET_NAME,
		SUB_BUDGET_AMOUNT,
		LAST_UPDATE_DATE,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_STAFFID) 
		values		
		(#{subBudgetID},
		#{budgetId},
		#{budgetfiscalYear},
		#{parentid},
		(SELECT SUB_BUDGET_NAME FROM SUB_BUDGET WHERE SUB_BUDGET_ID=#{parentid}),	
		0,		
		SYSTIMESTAMP,
		'1',
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	<select id="fetchCMSubBudgetSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		SELECT SUB_BUDGET_ID,
		PARENT_ID,
		SUB_BUDGET_NAME,
		SUB_BUDGET_AMOUNT
		FROM
		SUB_BUDGET
		WHERE BUDGET_ID = #{budgetId}
		ORDER BY parent_id
	</select>
	
	<select id="fetchCMSubBudgetPrintSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		SELECT SUB_BUDGET_ID,
		PARENT_ID,
		SUB_BUDGET_NAME,
		SUB_BUDGET_AMOUNT
		FROM
		SUB_BUDGET
		WHERE BUDGET_ID = #{budgetId} AND
		SUB_BUDGET_ID = #{subBudgetId} AND
		ACTIVE_FLAG = '1'
	</select>

	<select id="fetchModifiedBudgetId" parameterType="hashmap"
		resultType="String">
		SELECT BUDGET_ID
		FROM
		BUDGET
		WHERE PARENT_ID = #{budgetId} AND
		ACTIVE_FLAG = '1' AND BUDGET_TYPE_ID='3'
	</select>
	<resultMap id="budgetSummaryMap" type="com.nyc.hhs.model.BudgetDetails">
		<result property="title" column="main_column" />
		<result property="approvedBudget" column="total" />
		<result property="ytdInvoicedAmount" column="invoiceAmount" />
		<result property="modificationAmount" column="modificationAmount" />
	</resultMap>

	<select id="fetchModificationBudgetSummary" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="budgetSummaryMap">
		(select sum(amount) as modificationAmount,'otps' main_column from
		operations_and_support
		where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'utilities' main_column from
		utilities where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(total_salary) as modificationAmount,'salary' main_column from
		personnel_service
		where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'fringes' main_column from
		fringe_benefit where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'professionalServices' main_column
		from
		professional_service where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and
		active_flag='1')
		union
		(select sum(amount) as modificationAmount,'equipment' main_column from
		equipment where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and
		active_flag='1')
		union
		(select sum(amount) as modificationAmount,'rent' main_column from rent where
		budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'contractedServices' main_column
		from contracted_service
		where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'totalRateBased' main_column from
		rate where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'totalMilestoneBased' main_column
		from milestone where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(amount) as modificationAmount,'unallocatedFunds' main_column from
		unallocated where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
		union
		(select sum(indirect_amount) as modificationAmount,'totalIndirectCost'
		main_column from
		indirect_rate where budget_id=#{modifiedContractBudgetID} and
		sub_budget_id=#{modifiedSubBudgetID} and
		active_flag='1')
		union
		(select sum(amount) as modificationAmount,'totalProgramIncome' main_column
		from program_income where
		budget_id=#{modifiedContractBudgetID} and sub_budget_id=#{modifiedSubBudgetID} and active_flag='1')
	</select>

	<resultMap id="CoCBMProfServicesList" type="com.nyc.hhs.model.CBProfessionalServicesBean">
		<result property="id" column="PROFESSIONAL_SERVICE_ID" />
		<result property="cbmId" column="MODIFY_PROFESSIONAL_SERVICE_ID" />
		<result property="profServiceTypeId" column="PROFESSIONAL_SERVICE_TYPE_ID" />
		<result property="professionalServiceName" column="PROFESSIONAL_SERVICE_TYPE" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="modifyAmount" column="MODIFY_AMOUNT" />
	</resultMap>

	<select id="cbmFetchProfServicesDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="CoCBMProfServicesList">
		select
		profess.PROFESSIONAL_SERVICE_ID,
		modifyBudget.PROFESSIONAL_SERVICE_ID as
		MODIFY_PROFESSIONAL_SERVICE_ID,
		profess.PROFESSIONAL_SERVICE_TYPE_ID,
		CASE
		WHEN other.ENTITY_NAME IS NOT NULL THEN other.ENTITY_NAME
		ELSE
		profess_master.PROFESSIONAL_SERVICE_TYPE
		END
		as
		PROFESSIONAL_SERVICE_TYPE,
		<!-- Rel 3.16.0 QC6821 BEGIN Amount to be zero, when Parent_id equals id. Otherwise the grid displays the amount newly added -->
		CASE
		WHEN profess.PROFESSIONAL_SERVICE_ID=modifyBudget.PROFESSIONAL_SERVICE_ID THEN 0
		ELSE
		nvl(profess.AMOUNT,0)
		END
		as
		AMOUNT,
		CASE
		WHEN profess.PROFESSIONAL_SERVICE_ID=modifyBudget.PROFESSIONAL_SERVICE_ID THEN 0
		ELSE
		nvl(profess.AMOUNT,'0') - nvl(invoicedetail.INVOICE_AMOUNT,'0')
		END
		as
		REMAINING_AMOUNT,
		<!-- Rel 3.16.0 QC6821 END Amount to be zero, when Parent_id equals id. Otherwise the grid displays the amount newly added -->
		nvl(modifyBudget.AMOUNT,'0') as MODIFY_AMOUNT
		from
		PROFESSIONAL_SERVICE_TYPE_MSTR profess_master
		inner join
		PROFESSIONAL_SERVICE profess on profess.PROFESSIONAL_SERVICE_TYPE_ID =
		profess_master.PROFESSIONAL_SERVICE_TYPE_ID and
		profess.PROFESSIONAL_SERVICE_ID = profess.PARENT_ID 
	    and profess.sub_budget_id=#{parentSubBudgetId}
		left outer join OTHER_DETAILS other on
		other.ENTITY_ID = profess.PROFESSIONAL_SERVICE_ID and
		other.ENTRY_TYPE_ID = 4 and other.active_flag = '1'
		left outer join
		(select * from PROFESSIONAL_SERVICE where SUB_BUDGET_ID = #{subBudgetID} 
		<!-- Rel 3.16.0 QC6821 BEGIN. Remove following filter -->
		<!--  and	PROFESSIONAL_SERVICE_ID != PARENT_ID  -->
		<!-- Rel 3.16.0 QC6821 END. Remove following filter -->
		) modifyBudget on
		modifyBudget.PARENT_ID =
		profess.PROFESSIONAL_SERVICE_ID
		left outer join
		(select entry_type_id, line_item_id, sum(invoice_amount)
		as
		INVOICE_AMOUNT
		from INVOICE_DETAILS where INVOICE_ID IN
		(select
		invoice_id from INVOICE where BUDGET_ID = #{parentBudgetId}
		and STATUS_ID in (72, 73)) and
		ENTRY_TYPE_ID = 4
		group by entry_type_id, line_item_id) invoicedetail
		on
		invoicedetail.entry_type_id = 4 and invoicedetail.line_item_id =
		profess.PROFESSIONAL_SERVICE_ID
		where profess.active_flag =	1 
		order by
		profess_master.professional_service_type_id
    </select>
    
    <select id="fetchRemainingAmnt" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean"
		resultType="java.math.BigDecimal">
		select
		nvl(profess.AMOUNT,'0') -
		nvl(invoicedetail.INVOICE_AMOUNT,'0') as REMAINING_AMOUNT
		from
		PROFESSIONAL_SERVICE profess
		left outer join (select entry_type_id,	line_item_id, sum(invoice_amount) as INVOICE_AMOUNT
		from INVOICE_DETAILS
		where INVOICE_ID IN
				(select invoice_id from INVOICE 
				where 
				    <!-- QC 9206 R 7.7.1 remove contract_id : incorrectly pointed to Update Contract Id instead of Base contract Id 
					CONTRACT_ID =#{contractID} and
					 -->
					BUDGET_ID = #{parentBudgetId} 	and STATUS_ID in(72,73)) 
		    	and ENTRY_TYPE_ID = 4
		group by entry_type_id,
		line_item_id) invoicedetail on
		invoicedetail.entry_type_id = 4 and
		invoicedetail.line_item_id =
		profess.PROFESSIONAL_SERVICE_ID
		where
		profess.PROFESSIONAL_SERVICE_ID = #{id}
    </select>

<!--   [Start] R7.5.0 QC9146 Professional Service Grid issue for MOD -->
	<insert id="mergeProfServicesModAmount" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		MERGE INTO PROFESSIONAL_SERVICE  ProfS 
        using (select  PROFESSIONAL_SERVICE_ID, PROFESSIONAL_SERVICE_TYPE_ID, #{contractBudgetID} as BUDGET_ID, 
                       #{subBudgetID} as SUB_BUDGET_ID,PARENT_ID,AMOUNT,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,
                       MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
                from   PROFESSIONAL_SERVICE
               where   PROFESSIONAL_SERVICE_ID = #{id}
                and    ACTIVE_FLAG = 1
              ) Tmp
      on (   Tmp.PARENT_ID = ProfS.PARENT_ID 
             and  Tmp.PROFESSIONAL_SERVICE_TYPE_ID = ProfS.PROFESSIONAL_SERVICE_TYPE_ID   
             and  Tmp.SUB_BUDGET_ID =  ProfS.SUB_BUDGET_ID
             and  Tmp.BUDGET_ID =  ProfS.BUDGET_ID 
         )
 		WHEN NOT MATCHED THEN
          Insert 
          (   ProfS.PROFESSIONAL_SERVICE_ID, ProfS.PROFESSIONAL_SERVICE_TYPE_ID, ProfS.BUDGET_ID, ProfS.SUB_BUDGET_ID,
              ProfS.PARENT_ID, ProfS.AMOUNT, ProfS.CREATED_DATE, ProfS.CREATED_BY_USERID, ProfS.CREATED_BY_STAFFID, ProfS.MODIFIED_DATE,
              ProfS.MODIFIED_BY_USERID, ProfS.MODIFIED_BY_STAFFID, ProfS.ACTIVE_FLAG, ProfS.PREV_APPROVED_BUDGET
          )
          values 
          ( SEQ_PROFESSIONAL_SERVICE_ID.nextval
            , Tmp.PROFESSIONAL_SERVICE_TYPE_ID,  Tmp.BUDGET_ID, Tmp.SUB_BUDGET_ID
            , Tmp.PARENT_ID , #{modifyAmount}  , SYSTIMESTAMP ,   #{modifyByAgency} , #{modifyByProvider} ,  SYSTIMESTAMP ,   
           #{modifyByAgency}  , #{modifyByProvider} , Tmp.ACTIVE_FLAG , Tmp.AMOUNT
          ) 
    WHEN MATCHED THEN
    		update  
          set ProfS.AMOUNT = #{modifyAmount}
            , ProfS.MODIFIED_DATE = SYSTIMESTAMP
            , ProfS.MODIFIED_BY_USERID = #{modifyByAgency}
            , ProfS.MODIFIED_BY_STAFFID = #{modifyByProvider} 
          where Tmp.PARENT_ID = ProfS.PARENT_ID 
          and  Tmp.PROFESSIONAL_SERVICE_TYPE_ID = ProfS.PROFESSIONAL_SERVICE_TYPE_ID   
	</insert>
	
	<insert id="addProfServicesModificationAmount" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		Insert into PROFESSIONAL_SERVICE
		(PROFESSIONAL_SERVICE_ID,
		PROFESSIONAL_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PREV_APPROVED_BUDGET)
		
		select   SEQ_PROFESSIONAL_SERVICE_ID.nextval, PROFESSIONAL_SERVICE_TYPE_ID, #{contractBudgetID} as BUDGET_ID, #{subBudgetID} as SUB_BUDGET_ID, 		
                 PARENT_ID, #{modifyAmount} as AMOUNT, SYSTIMESTAMP, #{modifyByAgency} as CREATED_BY_USERID, #{modifyByProvider} as MODIFIED_BY_STAFFID, 
                 SYSTIMESTAMP, #{modifyByAgency} as MODIFIED_BY_USERID, #{modifyByProvider} as MODIFIED_BY_STAFFID,  '1' as ACTIVE_FLAG, AMOUNT as PREV_APPROVED_BUDGET 
        from     PROFESSIONAL_SERVICE
        where    PROFESSIONAL_SERVICE_ID = #{id}
        		
<!-- 		values

		(SEQ_PROFESSIONAL_SERVICE_ID.nextval,
		#{profServiceTypeId},
		#{contractBudgetID},
		#{subBudgetID},
		#{id},
		#{modifyAmount},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		SYSTIMESTAMP,
        #{modifyByAgency},
		#{modifyByProvider},
		'1',
		#{fyBudget}) -->
	</insert>
<!--   [Start] R7.5.0 QC9146 Professional Service Grid issue for MOD -->

	<update id="updateProfServicesModificationAmount" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		update PROFESSIONAL_SERVICE 
		set AMOUNT = #{modifyAmount}
		, MODIFIED_DATE = SYSTIMESTAMP
		, MODIFIED_BY_USERID = #{modifyByAgency}
		, MODIFIED_BY_STAFFID = #{modifyByProvider}
		where professional_service_id = #{cbmId} and budget_id =
		#{contractBudgetID}
		and sub_budget_id = #{subBudgetID}
	</update>

	<resultMap id="sessionInfo" type="com.nyc.hhs.model.CBGridBean">
		<result property="contractID" column="CONTRACT_ID" />
		<result property="parentBudgetId" column="PARENT_ID" />
		<result property="fiscalYearID" column="FISCAL_YEAR_ID" />
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />
		<result property="budgetStatusId" column="BUDGET_STATUS_ID" />
		<result property="contractStatusId" column="CONTRACT_STATUS_ID" />
	</resultMap>

	<!-- R7 changes start:: Updated the query to incorporate approved modification -->
	<select id="getCbGridDataForSession" parameterType="hashmap"
		resultMap="sessionInfo">
		select 
		CONTRACT_ID,PARENT_ID,fiscal_year_id,BUDGET_STATUS_ID,CONTRACT_STATUS_ID
		from
		(select 
		CONTRACT_ID,PARENT_ID,fiscal_year_id,BUDGET_STATUS_ID,CONTRACT_STATUS_ID,BUDGET_TYPE_ID,ACTIVE_FLAG
		from
		(SELECT
		CONTRACT.CONTRACT_ID,
		BUDGET.PARENT_ID,
		BUDGET.fiscal_year_id,
		BUDGET.STATUS_ID as BUDGET_STATUS_ID,
		CONTRACT.STATUS_ID as CONTRACT_STATUS_ID,
		<!-- Added in R7 -->
		BUDGET_TYPE_ID,BUDGET.ACTIVE_FLAG
		<!-- End R7 -->
		FROM CONTRACT
		INNER JOIN BUDGET
		ON BUDGET.CONTRACT_ID =
		CONTRACT.CONTRACT_ID
		WHERE
		BUDGET.BUDGET_ID=#{budgetId} 
		<if test="budgetType != null">
		And
		BUDGET_TYPE_ID=#{budgetType}
		</if>
		) a
		where 
		((BUDGET_TYPE_ID='3' 
		and BUDGET_STATUS_ID='86'
		)
		or
		(ACTIVE_FLAG='1'
		<if test="budgetType != null">
		And
		BUDGET_TYPE_ID=#{budgetType}
		</if>
		)
		)
		) b
	</select>
 	<!-- End R7 -->
	<resultMap id="MilestoneModificationList" type="com.nyc.hhs.model.CBMileStoneBean">
		<result property="id" column="MILESTONE_ID" />
		<result property="mileStone" column="MILESTONE" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="parentId" column="PARENT_ID" />
		<result property="modificationAmount" column="AMOUNT" />
	</resultMap>


	<select id="fetchMilestoneForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="MilestoneModificationList">

		Select MS.MILESTONE_ID, MS.MILESTONE, MS.AMOUNT,
		MS.Budget_Id,
		MS.Sub_Budget_Id, MS.Parent_Id
		From
		MILESTONE MS
		WHERE
		MS.Budget_Id = #{contractBudgetID}
		And MS.Sub_Budget_Id =
		#{subBudgetID}
		and MS.ACTIVE_FLAG = 1
		ORDER BY MS.CREATED_DATE asc
	</select>

	<resultMap id="MilestoneList" type="com.nyc.hhs.model.CBMileStoneBean">
		<result property="id" column="MILESTONE_ID" />
		<result property="mileStone" column="MILESTONE" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="amount" column="AMOUNT" />
		<result property="invoiceAmount" column="INVOICE_AMOUNT" />
		<result property="invoiceId" column="INVOICE_ID" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
		<result property="remainAmt" column="REMAINING_AMOUNT" />
		<result property="entryTypeId" column="ENTRY_TYPE_ID" />
	</resultMap>

	<select id="fetchMilestoneBaseDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean"
		resultMap="MilestoneList">
		SELECT MILESTONE_ID,
		  MILESTONE,
		  AMOUNT,
		  SUM(REMAINING_AMOUNT) AS REMAINING_AMOUNT,
		  SUM(INVOICE_AMOUNT)   AS INVOICE_AMOUNT,
		  created_date
		FROM
		  (SELECT MS.MILESTONE_ID,
		    MS.MILESTONE,
		    MS.AMOUNT,
		    (MS.AMOUNT - (SUM(
		    CASE
		      WHEN inv.STATUS_ID IN ('72','73')
		      THEN idt.INVOICE_AMOUNT
		      ELSE 0
		    END ))) AS REMAINING_AMOUNT,
		    0       AS INVOICE_AMOUNT,
		    MS.created_date
		  FROM MILESTONE MS
		  LEFT JOIN INVOICE_DETAILS idt
		  ON idt.LINE_ITEM_ID   = MS.MILESTONE_ID
		  AND idt.ENTRY_TYPE_ID = 8
		  LEFT JOIN INVOICE inv
		  ON inv.INVOICE_ID    = idt.INVOICE_ID
		  WHERE MS.BUDGET_ID   = #{parentBudgetId}
		  AND MS.SUB_BUDGET_ID = #{parentSubBudgetId}
		  AND MS.ACTIVE_FLAG   = 1
		  GROUP BY MS.MILESTONE_ID,
		    MS.MILESTONE,
		    MS.AMOUNT,
		    MS.created_date
		  UNION ALL
		  SELECT MS.MILESTONE_ID,
		    MS.MILESTONE,
		    MS.AMOUNT,
		    0                           AS REMAINING_AMOUNT,
		    NVL(idt.INVOICE_AMOUNT,'0') AS INVOICE_AMOUNT,
		    MS.created_date
		  FROM MILESTONE MS
		  LEFT JOIN INVOICE_DETAILS idt
		  ON idt.LINE_ITEM_ID   = MS.MILESTONE_ID
		  AND idt.ENTRY_TYPE_ID = 8
		  LEFT JOIN INVOICE inv
		  ON inv.INVOICE_ID    = idt.INVOICE_ID
		  WHERE MS.BUDGET_ID   = #{parentBudgetId}
		  AND MS.SUB_BUDGET_ID = #{parentSubBudgetId}
		  AND MS.ACTIVE_FLAG   = 1
		  )
		GROUP BY MILESTONE_ID,
		  MILESTONE,
		  AMOUNT,
		  created_date
		ORDER BY created_date DESC
	</select>
	
	<select id="getSeqForMilestone" resultType="Integer">
		SELECT
		SEQ_MILESTONE_ID.NEXTVAL FROM DUAL
	</select>

	<insert id="insertMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		INSERT INTO
		MILESTONE
		(MILESTONE_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,MILESTONE,AMOUNT,CREATED_BY_USERID,
		CREATED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_DATE,ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(#{id},#{contractBudgetID},#{subBudgetID},#{id},#{mileStone},#{modificationAmount},
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		'0')
	</insert>
	
	<insert id="insertNewMilestoneForMod" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		INSERT INTO
		MILESTONE
		(MILESTONE_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,MILESTONE,AMOUNT,
		CREATED_BY_USERID,
		CREATED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_DATE,ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(SEQ_MILESTONE_ID.NEXTVAL,#{contractBudgetID},#{subBudgetID},#{id},#{mileStone},#{modificationAmount},
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{amount})
	</insert>

	<update id="updateMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		UPDATE
		MILESTONE
		SET MILESTONE = #{mileStone},
		AMOUNT = #{modificationAmount},
		PREV_APPROVED_BUDGET = #{amount},
		modified_date = CURRENT_TIMESTAMP, 
		MODIFIED_BY_USERID = #{modifyByAgency, jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID = #{modifyByProvider, jdbcType=VARCHAR}
		WHERE PARENT_ID = #{id} AND SUB_BUDGET_ID = #{subBudgetID}
	</update>

	<delete id="deleteMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		DELETE FROM
		MILESTONE 
		WHERE MILESTONE_ID = #{id} AND PARENT_ID = #{id} AND SUB_BUDGET_ID = #{subBudgetID}
	</delete>
	
	<select id="fetchMilestoneDetailsForValidation" parameterType="String"
		resultMap="MilestoneList">
		SELECT MS.MILESTONE, MS.SUB_BUDGET_ID, MS.AMOUNT, (MS.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IN
		('72','73')
		THEN idt.INVOICE_AMOUNT
		ELSE 0
		END ))) as
		REMAINING_AMOUNT
		FROM MILESTONE MS

		LEFT JOIN INVOICE_DETAILS idt
		ON
		idt.LINE_ITEM_ID = MS.MILESTONE_ID
		AND
		idt.ENTRY_TYPE_ID = '8'

		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = idt.INVOICE_ID

		WHERE
		MS.MILESTONE_ID = #{asId} AND MS.PARENT_ID = #{asId}
    	GROUP BY MS.MILESTONE, MS.SUB_BUDGET_ID, MS.AMOUNT
	</select>

	<resultMap id="budgetModificationList" type="com.nyc.hhs.model.RateBean">
		<result property="id" column="PARENT_ID" />
		<result property="unitDesc" column="UNIT_DESCRIPTION" />
		<result property="units" column="NUMBER_OF_UNITS" />
		<result property="fyBudget" column="FY_BUDGET" />
		<result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
		<result property="remainAmt" column="REMAINING_AMT" />
		<result property="lsParentId" column="PARENT_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="remUnits" column="REMAINING_UNITS" />
	</resultMap>
	<select id="fetchContractBudgetRateInfo" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="budgetModificationList">
		SELECT
		rt.rate_id,
		rt.parent_id AS PARENT_ID,
		rt.UNIT_DESCRIPTION,
		rt.NUMBER_OF_UNITS,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.NUMBER_OF_UNITS - SUM(CASE
		WHEN
		INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(inv.invoiced_units,0)
		ELSE
		0
		END ) AS REMAINING_UNITS,
		(CASE
		WHEN
		rt.SUB_BUDGET_ID = #{subBudgetID}
		THEN 0
		WHEN
		rt.SUB_BUDGET_ID = #{parentSubBudgetId}
		THEN rt.AMOUNT
		END) AS
		FY_BUDGET,

		SUM( CASE
		WHEN
		INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS
		INVOICE_AMOUNT,

		(CASE
		WHEN
		rt.SUB_BUDGET_ID = #{subBudgetID}
		THEN 0
		WHEN rt.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN rt.AMOUNT
		END) - SUM( CASE
		WHEN INVVV.STATUS_ID
		IS NOT NULL
		THEN NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT
		FROM
		RATE rt
		LEFT JOIN INVOICE_DETAILS inv
		ON
		rt.RATE_ID =
		inv.LINE_ITEM_ID
		AND inv.ENTRY_TYPE_ID = 7
		LEFT JOIN
		INVOICE INVVV
		ON
		INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID IN
		(72,73)
		WHERE
		rt.BUDGET_ID = #{parentBudgetId}
		AND rt.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		OR rt.SUB_BUDGET_ID = #{subBudgetID}
		AND
		rt.active_flag = 1
		AND rt.RATE_ID = rt.Parent_id
		GROUP BY
		rt.RATE_ID,
		rt.UNIT_DESCRIPTION,
		rt.NUMBER_OF_UNITS,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT,
		rt.SUB_BUDGET_ID
		ORDER BY
		parent_id DESC
	</select>

	<resultMap id="budgetModificationAmountList" type="com.nyc.hhs.model.RateBean">
		<result property="lsModifyAmount" column="MOD_AMOUNT" />
		<result property="lsParentId" column="PARENT_ID" />
		<result property="lsModifyUnits" column="MOD_UNITS" />
	</resultMap>
	<select id="fetchContractBudgetModificationAmount"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="budgetModificationAmountList">
		SELECT
		rt.parent_id AS PARENT_ID,
		SUM(CASE
		WHEN
		rt.SUB_BUDGET_ID =
		#{subBudgetID}
		THEN rt.NUMBER_OF_UNITS
		ELSE 0
		END) AS
		MOD_UNITS,
		SUM(CASE
		WHEN
		rt.SUB_BUDGET_ID = #{subBudgetID}
		THEN
		rt.AMOUNT
		ELSE 0
		END) AS
		MOD_AMOUNT
		FROM
		RATE rt
		LEFT JOIN INVOICE_DETAILS
		inv
		ON
		rt.RATE_ID =
		inv.LINE_ITEM_ID
		AND inv.ENTRY_TYPE_ID = 7
		LEFT JOIN
		INVOICE
		INVVV
		ON
		INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID IN
		(72,73)
		WHERE
		rt.BUDGET_ID = #{parentBudgetId}
		OR rt.SUB_BUDGET_ID =
		#{subBudgetID}
		AND rt.active_flag = 1
		GROUP BY
		rt.parent_id
		ORDER BY
		parent_id DESC
	</select>

	<insert id="insertContractBudgetModificationRateInfo"
		parameterType="com.nyc.hhs.model.RateBean">
		INSERT
		INTO
		RATE
		(RATE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNIT_DESCRIPTION,
		NUMBER_OF_UNITS,
		AMOUNT,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(
		SEQ_RATE_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_RATE_ID.currval,
		#{unitDesc},
		#{lsModifyUnits},
		#{lsModifyAmount},
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency,
		jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency, jdbcType=VARCHAR},
		#{modifyByProvider, jdbcType=VARCHAR},
		#{modifyByProvider,
		jdbcType=VARCHAR},
		#{fyBudget,jdbcType=VARCHAR}
		)
		
	</insert>

	<insert id="insertNewContractBudgetModificationRate"
		parameterType="com.nyc.hhs.model.RateBean">
		INSERT
		INTO
		RATE 
		(RATE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNIT_DESCRIPTION,
		NUMBER_OF_UNITS,
		AMOUNT,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(
		SEQ_RATE_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{id},
		#{unitDesc},
		#{lsModifyUnits},
		#{lsModifyAmount},
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency,
		jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency, jdbcType=VARCHAR},
		#{modifyByProvider, jdbcType=VARCHAR},
		#{modifyByProvider,
		jdbcType=VARCHAR},
		#{fyBudget,jdbcType=VARCHAR}
		)
	</insert>

	<update id="updateContractBudgetModificationRateInfo"
		parameterType="com.nyc.hhs.model.RateBean">
		UPDATE
		RATE
		SET
		UNIT_DESCRIPTION = #{unitDesc},
		AMOUNT =
		#{lsModifyAmount},
		NUMBER_OF_UNITS = #{lsModifyUnits},
		MODIFIED_BY_USERID = #{modifyByAgency, jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID = #{modifyByProvider, jdbcType=VARCHAR}
		WHERE
		PARENT_ID = #{id}
		AND
		SUB_BUDGET_ID = #{subBudgetID}
		AND ACTIVE_FLAG =
		'1'
	</update>

	<update id="updateBudgetModificationRateUnit" parameterType="com.nyc.hhs.model.RateBean">
		UPDATE
		RATE
		SET
		AMOUNT = #{lsModifyAmount},
		NUMBER_OF_UNITS =
		#{lsModifyUnits},
		MODIFIED_BY_USERID = #{modifyByAgency,
		jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID = #{modifyByProvider,
		jdbcType=VARCHAR}
		WHERE
		PARENT_ID = #{id}
		AND SUB_BUDGET_ID =
		#{subBudgetID}
		AND ACTIVE_FLAG =
		'1'
	</update>

	<delete id="deleteContractBudgetModificationRateInfo"
		parameterType="com.nyc.hhs.model.RateBean">
		DELETE
		FROM
		RATE
		WHERE
		PARENT_ID = #{id}
		AND SUB_BUDGET_ID =
		#{subBudgetID}
		AND ACTIVE_FLAG = '1'
	</delete>

	<select id="getBaseUnitContractBudgetModificationRate"
		parameterType="com.nyc.hhs.model.RateBean" resultType="java.lang.Integer">
		SELECT
		number_of_units
		FROM
		RATE
		WHERE
		parent_id = #{id}
		AND sub_budget_id =
		#{parentSubBudgetId}
	</select>

	<select id="getRemainingAmountModificationRate" resultType="java.math.BigDecimal"
		parameterType="com.nyc.hhs.model.RateBean">
		SELECT 
		(
		CASE
		WHEN rt.SUB_BUDGET_ID =
		#{subBudgetID}
		THEN 0
		WHEN rt.SUB_BUDGET_ID = #{parentSubBudgetId}
		THEN
		rt.AMOUNT
		END) - SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT
		FROM RATE rt
		LEFT
		JOIN INVOICE_DETAILS inv
		ON rt.RATE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 7
		LEFT JOIN INVOICE INVVV
		ON INVVV.INVOICE_ID =
		inv.INVOICE_ID
		AND INVVV.STATUS_ID IN (72,73)
		WHERE rt.parent_id = #{id}
		AND rt.active_flag = '1'
		AND rt.RATE_ID = rt.Parent_id
		GROUP BY
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT
	</select>

	<!-- Unallocated Funds Modification Queries Starts -->

	<!-- Start: QC 8394 R 7.9.0 add Add/Delete action for Unallocated Fund -->
	
	<resultMap id="UnallocatedFundList" type="com.nyc.hhs.model.UnallocatedFunds">
		<result property="id" column="UNALLOCATED_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modificationAmount" column="MODIFICATION_AMOUNT" />
		<result property="modCount" column="MODIFICATION_COUNT" />
		<result property="orgCount" column="ORIGINAL_COUNT" />
		<!-- QC 8694 R 7.9.0 apply add/delete functions for Unallocated Fund  -->
		<result property="unallocatedFund" column="UNALLOCATED_FUND" />
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="parentBudgetId" column="PARENT_BUDGET_ID" />
		<result property="parentSubBudgetId" column="PARENT_SUB_BUDGET_ID" />
		<result property="parentId" column="PARENT_ID" />
		<result property="childId" column="CHILD_ID" />
		<result property="type" column="TYPE" />
	</resultMap>

 <!--  
	<select id="fetchModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UnallocatedFundList">
		select UNALLOCATED_ID,
		nvl((select (amount) from unallocated 	where sub_budget_id = #{parentSubBudgetId} 	and budget_id = #{parentBudgetId}),0) as "AMOUNT",
   		nvl((select amount   from unallocated   where sub_budget_id = #{subBudgetID} and    budget_id = #{contractBudgetID} ),0)  as "MODIFICATION_AMOUNT",
		(select count(amount) from unallocated where  sub_budget_id = #{subBudgetID} and    budget_id = #{contractBudgetID}) as "MODIFICATION_COUNT"
		from unallocated where sub_budget_id = #{parentSubBudgetId} 
	</select>
-->
	<select id="fetchModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UnallocatedFundList">
		select 	UNALLOCATED_ID , 
	      		UNALLOCATED_FUND,
	      		nvl(amount, 0) as "AMOUNT",
	      		0.0 as "MODIFICATION_AMOUNT",
	      		0 as "MODIFICATION_COUNT",
	       		parent_id,
	      		null as "CHILD_ID",
	      		#{parentBudgetId} as "BUDGET_ID",
	      		#{parentSubBudgetId} as "SUB_BUDGET_ID",
	      		#{parentBudgetId} as "PARENT_BUDGET_ID",
	      		#{parentSubBudgetId} as "PARENT_SUB_BUDGET_ID",
	      		'base' as "TYPE"
	 	from unallocated
	 	where sub_budget_id = #{parentSubBudgetId} 
	        and budget_id = #{parentBudgetId} 
	        and ACTIVE_FLAG=1
	UNION ALL       
   		select UNALLOCATED_ID , 
      		UNALLOCATED_FUND,
      		0.0 as "AMOUNT",
      		amount as "MODIFICATION_AMOUNT",
      		1 as "MODIFICATION_COUNT",
      		parent_id,
      		UNALLOCATED_ID as "CHILD_ID",
      		#{contractBudgetID} as "BUDGET_ID",
	      	#{subBudgetID} as "SUB_BUDGET_ID",
	      	#{parentBudgetId} as "PARENT_BUDGET_ID",
	      	#{parentSubBudgetId} as "PARENT_SUB_BUDGET_ID",
      		'new' as "TYPE"
  		from unallocated 
       	where sub_budget_id = #{subBudgetID}
        	and budget_id = #{contractBudgetID} 
        	and UNALLOCATED_ID = parent_id
        	and ACTIVE_FLAG=1	
	</select>
	
     <!-- QC 8394 R 7.9.0 Add multiple lines to unallocated funds :: add UNALLOCATE_FUND field-->
	<insert id="insertModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.CBGridBean">
		insert into
		UNALLOCATED(UNALLOCATED_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,
		AMOUNT,CREATED_DATE,CREATED_BY_USERID,CREATED_BY_STAFFID
		,MODIFIED_DATE,MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,ACTIVE_FLAG, UNALLOCATE_FUND)
		values
		(SEQ_UNALLOCATED_ID.NEXTVAL,#{parentBudgetId ,jdbcType=VARCHAR},#{parentSubBudgetId ,jdbcType=VARCHAR},SEQ_UNALLOCATED_ID.CURRVAL,
		0.0,current_timestamp,
		#{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR},current_timestamp,#{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR},'1',
		#{unallocatedFund,jdbcType=VARCHAR})
	</insert>

	<insert id="insertModUnallocatedFunds" parameterType="com.nyc.hhs.model.CBGridBean">
		insert into
		UNALLOCATED(UNALLOCATED_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,
		AMOUNT,CREATED_DATE,CREATED_BY_USERID,CREATED_BY_STAFFID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,ACTIVE_FLAG)
		values (SEQ_UNALLOCATED_ID.NEXTVAL,#{contractBudgetID,jdbcType=VARCHAR},#{subBudgetID,jdbcType=VARCHAR},
		(select
		UNALLOCATED_ID from UNALLOCATED where sub_budget_id =
		#{parentSubBudgetId,jdbcType=VARCHAR}),
		0.0,current_timestamp,
		#{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR},current_timestamp,#{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR},'1')
	</insert>

<!-- End:  QC 8394 R 7.9.0 add Add/Delete action for Unallocated Fund -->
	<!-- Unallocated Funds Modification Queries Ends -->

	<!-- Program Income Modification Queries Starts -->

	<resultMap id="programIncomeModificationList" type="com.nyc.hhs.model.CBProgramIncomeBean">
		<result property="id" column="PROGRAM_INCOME_ID" />
		<result property="parentId" column="PARENT_ID" />
		<result property="programIncomeTypeId" column="PROGRAM_INCOME_TYPE_ID" />
		<result property="programTitle" column="PROGRAM_TITLE" />
		<result property="approvedFYBudget" column="APPROVED_FY_BUDGET" />
		<result property="remainingAmount" column="REMAINING_AMOUNT" />
		<result property="proposedBudget" column="PROPOSED_BUDGET" />
		<result property="modificationAmount" column="MODIFICATION_AMOUNT" />
		<result property="modificationAmount" column="MODIFICATION_AMOUNT" />
		<!-- Added in R7 -->
		<result property="entryTypeId" column="ENTRY_TYPE_ID" />
		<result property="description" column="DESCRIPTION" />
		<result property="empPosition" column="PROGRAM_TITLE" />
		<result property="budgetCategory" column="Entry_type" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
	</resultMap>

	<select id="fetchProgramIncomeModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="programIncomeModificationList">
		SELECT PI.PROGRAM_INCOME_ID AS PROGRAM_INCOME_ID,
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END              AS PROGRAM_TITLE,
		  NVL(PI.AMOUNT,0) AS APPROVED_FY_BUDGET,
		  (PI.AMOUNT - SUM(
		  CASE
		    WHEN INVVV.STATUS_ID IS NOT NULL
		    THEN NVL(INVD.INVOICE_AMOUNT,0)
		    ELSE 0
		  END ) ) AS REMAINING_AMOUNT,
		 <!-- Added in R7 -->
		 PI.Description,PI.SUB_BUDGET_ID,
		 PI.Entry_type_id,
		 decode(Entry_type,'Personnel Service Salary','Personnel Services',Entry_type) AS Entry_type
		<!--  R7 changes end -->
		FROM PROGRAM_INCOME_TYPE PIM
		LEFT JOIN PROGRAM_INCOME PI
		ON PIM.PROGRAM_INCOME_TYPE_ID = PI.PROGRAM_INCOME_TYPE_ID
		AND PI.SUB_BUDGET_ID          = #{parentSubBudgetId}
		<!-- Added in R7 -->
		LEFT JOIN ENTRY_TYPE_MASTER etm
        ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
		<!--  R7 changes end -->
		LEFT JOIN INVOICE_DETAILS INVD
		ON PI.PROGRAM_INCOME_ID = INVD.LINE_ITEM_ID
		AND INVD.ENTRY_TYPE_ID  = 11
		AND PI.SUB_BUDGET_ID    = #{parentSubBudgetId}
		LEFT JOIN INVOICE INVVV
		ON invvv.invoice_id  = invd.invoice_id
		AND invvv.status_id IN ('72','73')
		LEFT JOIN OTHER_DETAILS OTHER
		ON OTHER.ENTITY_ID      = PI.PROGRAM_INCOME_ID
		AND OTHER.ENTRY_TYPE_ID = 11
		AND OTHER.ACTIVE_FLAG   = '1'
		WHERE PIM.ACTIVE_FLAG   = 1
		<!-- Added in R7 -->
		AND PROGRAM_INCOME_ID IS NOT NULL
       <if test="null!= entryTypeId">
		AND PI.Entry_type_id=#{entryTypeId}
		</if>
        <!--  R7 changes end -->
		GROUP BY PIM.PROGRAM_INCOME_TYPE_ID,PI.SUB_BUDGET_ID,
		  PI.PROGRAM_INCOME_ID,
		  (
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END),
		  PI.AMOUNT, PI.Description,PI.Entry_type_id,Entry_type
		ORDER BY Entry_type_id,PIM.PROGRAM_INCOME_TYPE_ID
	 </select>
	 
	 <select id="fetchProgramIncomeModificationParentEqualSub" resultMap="programIncomeModificationList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT PI.PROGRAM_INCOME_ID AS PROGRAM_INCOME_ID,
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END AS PROGRAM_TITLE,
		  0   AS APPROVED_FY_BUDGET,
		  0   AS REMAINING_AMOUNT,
		<!-- Added in R7 -->
		 PI.Description,PI.SUB_BUDGET_ID,
		 PI.Entry_type_id,
		 decode(Entry_type,'Personnel Service Salary','Personnel Service',Entry_type) AS Entry_type
		<!--  R7 changes end -->
		FROM PROGRAM_INCOME_TYPE PIM
		LEFT JOIN PROGRAM_INCOME PI
		ON PIM.PROGRAM_INCOME_TYPE_ID = PI.PROGRAM_INCOME_TYPE_ID
		AND PI.SUB_BUDGET_ID          = #{parentSubBudgetId}
		<!-- Added in R7 -->
		LEFT JOIN ENTRY_TYPE_MASTER etm
        ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
		<!--  R7 changes end -->
		LEFT JOIN INVOICE_DETAILS INVD
		ON PI.PROGRAM_INCOME_ID = INVD.LINE_ITEM_ID
		AND INVD.ENTRY_TYPE_ID  = 11
		AND PI.SUB_BUDGET_ID    = #{parentSubBudgetId}
		LEFT JOIN INVOICE INVVV
		ON invvv.invoice_id  = invd.invoice_id
		AND invvv.status_id IN ('72','73')
		LEFT JOIN OTHER_DETAILS OTHER
		ON OTHER.ENTITY_ID      = PI.PROGRAM_INCOME_ID
		AND OTHER.ENTRY_TYPE_ID = 11
		AND OTHER.ACTIVE_FLAG   = '1'
		WHERE PIM.ACTIVE_FLAG   = 1
		<!-- Added in R7 -->
		AND PROGRAM_INCOME_ID IS NOT NULL
       <if test="null!= entryTypeId">
		AND PI.Entry_type_id=#{entryTypeId}
		</if>
        <!--  R7 changes end -->
		GROUP BY PIM.PROGRAM_INCOME_TYPE_ID,PI.SUB_BUDGET_ID,
		  PI.PROGRAM_INCOME_ID,
		  (
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END),
		  PI.AMOUNT, PI.Description,PI.Entry_type_id,Entry_type
		ORDER BY Entry_type_id,PIM.PROGRAM_INCOME_TYPE_ID
	</select>
	
	<select id="fetchProgramIncomeModAmtDetails" resultMap="programIncomeModificationList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END                 AS PROGRAM_TITLE,
		  NVL(PI.AMOUNT,0)    AS MODIFICATION_AMOUNT,
		  NVL(PI.PARENT_ID,0) AS PROGRAM_INCOME_ID,
		  <!-- Added in R7 -->
		  DESCRIPTION,PI.SUB_BUDGET_ID,PI.ENTRY_TYPE_ID,
		  PIM.PROGRAM_INCOME_TYPE,
		  decode(Entry_type,'Personnel Service Salary','Personnel Services',Entry_type) AS Entry_type
		  <!-- R7 changes end -->
		FROM PROGRAM_INCOME_TYPE PIM
		LEFT JOIN PROGRAM_INCOME PI
		ON PIM.PROGRAM_INCOME_TYPE_ID = PI.PROGRAM_INCOME_TYPE_ID
		AND PI.SUB_BUDGET_ID          = #{subBudgetID}
		AND PI.BUDGET_ID              = #{contractBudgetID}
	    <!-- Added in R7 -->
		LEFT JOIN ENTRY_TYPE_MASTER etm
        ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
		<!--  R7 changes end -->
		LEFT JOIN INVOICE_DETAILS INVD
		ON PI.PROGRAM_INCOME_ID = INVD.LINE_ITEM_ID
		AND INVD.ENTRY_TYPE_ID  = 11
		AND PI.SUB_BUDGET_ID    = #{subBudgetID}
		LEFT JOIN INVOICE INVVV
		ON invvv.invoice_id  = invd.invoice_id
		AND invvv.status_id IN ('72','73')
		LEFT JOIN OTHER_DETAILS OTHER
		ON OTHER.ENTITY_ID      = PI.PROGRAM_INCOME_ID
		AND OTHER.ENTRY_TYPE_ID = 11
		AND OTHER.ACTIVE_FLAG   = '1'
		WHERE PIM.ACTIVE_FLAG   = 1
		<if test="null!= entryTypeId">
		AND PI.Entry_type_id=#{entryTypeId}
		</if>
		<!-- Added in R7 -->
		<if test="isOldPI == 0">
		AND PROGRAM_INCOME_ID != 0
		</if>
		<!-- R7 changes end -->
		GROUP BY PIM.PROGRAM_INCOME_TYPE_ID,DESCRIPTION,PROGRAM_INCOME_TYPE,Entry_type,PI.SUB_BUDGET_ID,
		  PI.PROGRAM_INCOME_ID,PI.ENTRY_TYPE_ID,
		  (
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE PIM.PROGRAM_INCOME_TYPE
		  END),
		  PI.AMOUNT,
		  PI.PARENT_ID
		ORDER BY Entry_type_id,PIM.PROGRAM_INCOME_TYPE_ID,
		  PI.PARENT_ID
	</select>

	<insert id="insertProgramIncomeModification" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		Insert into
		PROGRAM_INCOME
		(
		PROGRAM_INCOME_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PROGRAM_INCOME_TYPE_ID,
		PARENT_ID,AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PREV_APPROVED_BUDGET,
		<!-- Added in R7  for Program Income updation-->
		ENTRY_TYPE_ID
		<!-- R7 ENd -->
		)
		values
		(
		SEQ_PROGRAM_INCOME_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		(select PROGRAM_INCOME_TYPE_ID from PROGRAM_INCOME where PROGRAM_INCOME_ID = #{id} ),
		#{id},
		#{modificationAmount},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{activeFlag},
		#{prevApprovedBudget},
		#{entryTypeId}
		)
	</insert>

	<update id="updateProgramIncomeModification" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		UPDATE PROGRAM_INCOME set AMOUNT = #{modificationAmount}, MODIFIED_DATE =
		SYSTIMESTAMP, MODIFIED_BY_USERID = #{modifyByAgency,jdbcType=VARCHAR}, MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		<!-- Updated in R7 for new columns in Program_income table -->
		<if test="entryTypeId != null and entryTypeId != '' and empPosition != 0 ">
		,PROGRAM_INCOME_TYPE_ID= #{empPosition},
		description= #{description}
		</if>
		<!-- R7 changes end -->
		WHERE PARENT_ID       = #{id}
		AND SUB_BUDGET_ID     = #{subBudgetID}
		AND ACTIVE_FLAG       = '1'
	 </update>
	 
 	<select id="fetchProgIncomeDetailsForValidation" parameterType="String"
		resultMap="programIncomeModificationList">
		SELECT 
				(PI.AMOUNT - (SUM (CASE WHEN inv.STATUS_ID IN ('72','73')
									 	 THEN idt.INVOICE_AMOUNT
										 ELSE 0
									END ))) 
			as	REMAINING_AMOUNT
		FROM PROGRAM_INCOME PI
		LEFT JOIN INVOICE_DETAILS idt
		ON
		idt.LINE_ITEM_ID = PI.PROGRAM_INCOME_ID
		AND
		idt.ENTRY_TYPE_ID = '11'

		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = idt.INVOICE_ID

		WHERE
		PI.PROGRAM_INCOME_ID = #{asId}
    	GROUP BY PI.AMOUNT
	</select>
	 
	<!-- Program Income Modification Queries Ends -->

	<resultMap id="SalariedEmployeeModificationList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="PERSONNEL_SERVICE_ID" />
		<result property="empPosition" column="Position" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="parentId" column="Parent_Id" />
		<result property="modificationUnit" column="UNITS" />
		<result property="modificationAmount" column="TOTAL_SALARY" />
	</resultMap>
	<select id="fetchSalriedEmployeeForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeModificationList">
		Select ps.Personnel_Service_Id, po.Position,ps.Budget_Id,
		ps.Sub_Budget_Id, ps.Parent_Id, ps.Units, ps.Total_Salary
		From
		personnel_service ps ,position po
		WHERE
		Ps.Position_Id = Po.Position_Id
		And Ps.Budget_Id = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And
		Ps.Personnel_Service_Type_Id = 1
		and ps.ACTIVE_FLAG = 1
		ORDER BY ps.CREATED_DATE asc				
	</select>

	<select id="fetchHourlyEmployeeForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeModificationList">
		Select ps.Personnel_Service_Id, po.Position,ps.Budget_Id,
		ps.Sub_Budget_Id, ps.Parent_Id, ps.Units, ps.Total_Salary
		From
		personnel_service ps ,position po
		WHERE
		Ps.Position_Id = Po.Position_Id
		And Ps.Budget_Id = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And
		Ps.Personnel_Service_Type_Id = 2
		and ps.ACTIVE_FLAG = 1
		ORDER BY ps.CREATED_DATE asc
	</select>

	<select id="fetchSeasonalEmployeeForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeModificationList">
		Select ps.Personnel_Service_Id, po.Position,ps.Budget_Id,
		ps.Sub_Budget_Id, ps.Parent_Id, ps.Units, ps.Total_Salary
		From
		personnel_service ps ,position po
		WHERE
		Ps.Position_Id = Po.Position_Id
		And Ps.Budget_Id = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And
		Ps.Personnel_Service_Type_Id = 3
		and ps.ACTIVE_FLAG = 1
		ORDER BY
		ps.CREATED_DATE asc
	</select>

	<resultMap id="FringeBenefitsModificationList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="FRINGE_BENEFIT_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="parentId" column="Parent_Id" />
		<result property="modificationAmount" column="AMOUNT" />
	</resultMap>

	<select id="fetchFringeBenefitsForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="FringeBenefitsModificationList">
		Select ps.FRINGE_BENEFIT_ID, ps.Budget_Id, ps.Sub_Budget_Id,
		ps.Parent_Id, ps.AMOUNT
		From
		FRINGE_BENEFIT ps
		WHERE
		Ps.Budget_Id = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		and ps.ACTIVE_FLAG =
		1
	</select>

	<insert id="insertFirstPersonnelServicesForModification"
		parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,
		PERSONNEL_SERVICE_TYPE_ID,
		POSITION_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNITS,
		TOTAL_SALARY,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,
		(SELECT PERSONNEL_SERVICE_TYPE_ID
		from PERSONNEL_SERVICE WHERE PERSONNEL_SERVICE_ID =
		#{id,jdbcType=VARCHAR}),
		(SELECT POSITION_ID from PERSONNEL_SERVICE
		WHERE PERSONNEL_SERVICE_ID = #{id,jdbcType=VARCHAR}),
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		#{id,jdbcType=VARCHAR},
		#{modificationUnit,jdbcType=VARCHAR},
		#{modificationAmount,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{budgetAmount})
	</insert>

	<update id="updatePersonnelServicesForModification"
		parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		update
		personnel_service set POSITION_ID = #{empPosition}, units =
		#{modificationUnit},total_salary = #{modificationAmount},
		modified_date =
		current_timestamp, modified_by_userid = #{modifyByAgency,jdbcType=VARCHAR},MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		where BUDGET_ID =
		#{contractBudgetID,jdbcType=VARCHAR}
		and SUB_BUDGET_ID =
		#{subBudgetID,jdbcType=VARCHAR}
		and PARENT_ID = #{id}
	</update>

	<insert id="insertPersonnelServicesModification" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,
		PERSONNEL_SERVICE_TYPE_ID,
		POSITION_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNITS,
		TOTAL_SALARY,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET)
		VALUES
		(SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,
		#{empType,jdbcType=VARCHAR},
		#{empPosition,jdbcType=VARCHAR},
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		SEQ_PERSONNEL_SERVICES_ID.currval,
		#{modificationUnit,jdbcType=VARCHAR},
		#{modificationAmount,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},'1',
		#{modifyByProvider,jdbcType=VARCHAR},		
		#{modifyByProvider,jdbcType=VARCHAR},
		#{budgetAmount})
	</insert>

	<update id="updateFringeBenifitsForModification" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		update
		fringe_benefit set amount = #{modificationAmount}, modified_date
		=
		current_timestamp, modified_by_userid = #{modifyByAgency,jdbcType=VARCHAR},MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		where
		BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
		and SUB_BUDGET_ID =
		#{subBudgetID,jdbcType=VARCHAR}
		and PARENT_ID = #{id}
	</update>

	<insert id="insertFirstFringeBenefitsForModification"
		parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		FRINGE_BENEFIT
		(FRINGE_BENEFIT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		AMOUNT,
		FRINGE_PERCENT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,PARENT_ID,ACTIVE_FLAG,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID,PREV_APPROVED_BUDGET)
		VALUES
		(SEQ_FRINGE_BENEFIT_ID.NEXTVAL,
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		#{modificationAmount,jdbcType=VARCHAR},
		'0',
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{id,jdbcType=VARCHAR},'1',#{modifyByProvider,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR},#{budgetAmount})
	</insert>

	<resultMap id="CBOperationSupportModList" type="com.nyc.hhs.model.CBOperationSupportBean">
		<result property="id" column="LINE_ITEM_ID" />
		<result property="id" column="OPERATIONS_SUPPORT_TYPE_ID" />
		<result property="opAndSupportName" column="OP_SUPPRT_NAME" />
		<result property="fyBudget" column="FY_BUDGET" />
		<result property="remainingAmt" column="REMAINING_AMOUNT"/>
		<result property="modificationAmt" column="MOD_AMOUNT"/>
		<result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
	</resultMap>
	
		<select id="fetchOpAndSupportModPageData" resultMap="CBOperationSupportModList">
		Select sum(total) as FY_BUDGET, sum(invoiceAmount) as INVOICE_AMOUNT from((select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount from operations_and_support a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, operations_and_support d where c.invoice_id = b.invoice_id and
		c.status_id IN ('72','73') and b.entry_type_id ='2'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.operations_support_id and c.budget_id=#{contractBudgetID}
		group by b.line_item_id) b ON b.line_item_id = a.operations_support_id
		where a.sub_budget_id=#{subBudgetID} and
		a.budget_id=#{contractBudgetID})
		union all
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount from equipment a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, equipment d where c.invoice_id = b.invoice_id and
		c.status_id IN ('72','73') and b.entry_type_id ='12'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.equipment_id and c.budget_id=#{contractBudgetID}
		group by b.line_item_id) b ON b.line_item_id = a.equipment_id
		where a.sub_budget_id=#{subBudgetID} and
		a.budget_id=#{contractBudgetID})
		
		 union all
		(select 0 as total,sum(invoiceAmount) as invoiceAmount from operations_and_support a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, operations_and_support d where c.invoice_id = b.invoice_id and
		c.status_id IN ('72','73') and b.entry_type_id ='2'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.OPERATIONS_SUPPORT_ID and c.budget_id=#{parentBudgetId}
		group by b.line_item_id) b ON b.line_item_id = a.OPERATIONS_SUPPORT_ID
		where a.sub_budget_id=#{parentSubBudgetId} and
		a.budget_id=#{parentBudgetId})
  union all
		(select 0 as total,sum(invoiceAmount) as invoiceAmount from equipment a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, equipment d where c.invoice_id = b.invoice_id and
		c.status_id IN ('72','73') and b.entry_type_id ='12'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.equipment_id and c.budget_id=#{parentBudgetId}
		group by b.line_item_id) b ON b.line_item_id = a.equipment_id
		where a.sub_budget_id=#{parentSubBudgetId} and
		a.budget_id=#{parentBudgetId})		
		)
	</select>
	
	<select id="fetchOperationAndSupportModDetails" resultMap="CBOperationSupportModList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT
		OAS.OPERATIONS_SUPPORT_ID AS LINE_ITEM_ID,
		CASE
		WHEN other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		END AS OP_SUPPRT_NAME,
		NVL(OAS.AMOUNT,0) AS FY_BUDGET,		
		(OAS.AMOUNT - SUM(
    	CASE
      	WHEN INVVV.STATUS_ID IS NOT NULL
      	THEN NVL(INVD.INVOICE_AMOUNT,0)
     	ELSE 0
    	END ) ) AS REMAINING_AMOUNT
		FROM
		OPERATIONS_SUPPORT_TYPE_MASTER OSTM
		LEFT JOIN
		OPERATIONS_AND_SUPPORT OAS
		ON
		OSTM.OPERATIONS_SUPPORT_TYPE_ID = OAS.OPERATIONS_SUPPORT_TYPE_ID
		AND
		OAS.SUB_BUDGET_ID = #{parentSubBudgetId}
		LEFT JOIN
		INVOICE_DETAILS INVD
		ON
		OAS.OPERATIONS_SUPPORT_ID = INVD.LINE_ITEM_ID
		AND
		INVD.ENTRY_TYPE_ID = 2
		AND
		OAS.SUB_BUDGET_ID = #{parentSubBudgetId}
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id = invd.invoice_id
		AND
		invvv.status_id IN ('72','73')
		LEFT JOIN
		OTHER_DETAILS OTHER
		ON
		OTHER.ENTITY_ID = OAS.OPERATIONS_SUPPORT_ID
		AND
		OTHER.ENTRY_TYPE_ID = 2
		AND
		OTHER.ACTIVE_FLAG = '1'
		WHERE
		OSTM.ACTIVE_FLAG = 1
		GROUP BY
		OSTM.OPERATIONS_SUPPORT_TYPE_ID,
		OAS.OPERATIONS_SUPPORT_ID,
		(CASE
		WHEN other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		END),
		OAS.AMOUNT
		ORDER BY OSTM.OPERATIONS_SUPPORT_TYPE_ID
	</select>
	
	<select id="fetchOperationAndSupportModDetailsParentEqualSub" resultMap="CBOperationSupportModList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT OAS.OPERATIONS_SUPPORT_ID AS LINE_ITEM_ID,
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		  END AS OP_SUPPRT_NAME,
		  0   AS FY_BUDGET,
		  0   AS REMAINING_AMOUNT
		FROM OPERATIONS_SUPPORT_TYPE_MASTER OSTM
		LEFT JOIN OPERATIONS_AND_SUPPORT OAS
		ON OSTM.OPERATIONS_SUPPORT_TYPE_ID = OAS.OPERATIONS_SUPPORT_TYPE_ID
		AND OAS.SUB_BUDGET_ID              = #{parentSubBudgetId}
		LEFT JOIN INVOICE_DETAILS INVD
		ON OAS.OPERATIONS_SUPPORT_ID = INVD.LINE_ITEM_ID
		AND INVD.ENTRY_TYPE_ID       = 2
		AND OAS.SUB_BUDGET_ID        = #{parentSubBudgetId}
		LEFT JOIN INVOICE INVVV
		ON invvv.invoice_id  = invd.invoice_id
		AND invvv.status_id IN ('72','73')
		LEFT JOIN OTHER_DETAILS OTHER
		ON OTHER.ENTITY_ID      = OAS.OPERATIONS_SUPPORT_ID
		AND OTHER.ENTRY_TYPE_ID = 2
		AND OTHER.ACTIVE_FLAG   = '1'
		WHERE OSTM.ACTIVE_FLAG  = 1
		GROUP BY OSTM.OPERATIONS_SUPPORT_TYPE_ID,
		  OAS.OPERATIONS_SUPPORT_ID,
		  (
		  CASE
		    WHEN other.ENTITY_NAME IS NOT NULL
		    THEN other.ENTITY_NAME
		    ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		  END),
		  OAS.AMOUNT
		ORDER BY OSTM.OPERATIONS_SUPPORT_TYPE_ID
	</select>
	
	<select id="fetchOperationAndSupportModAmtDetails" resultMap="CBOperationSupportModList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT
		CASE
		WHEN other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		END AS OP_SUPPRT_NAME,
		NVL(OAS.AMOUNT,0) AS MOD_AMOUNT,
		NVL(OAS.PARENT_ID,0) AS LINE_ITEM_ID
		FROM
		OPERATIONS_SUPPORT_TYPE_MASTER OSTM
		LEFT JOIN
		OPERATIONS_AND_SUPPORT OAS
		ON
		OSTM.OPERATIONS_SUPPORT_TYPE_ID = OAS.OPERATIONS_SUPPORT_TYPE_ID
		AND
		OAS.SUB_BUDGET_ID = #{subBudgetID}
		AND
		OAS.BUDGET_ID = #{contractBudgetID}
		LEFT JOIN
		INVOICE_DETAILS INVD
		ON
		OAS.OPERATIONS_SUPPORT_ID = INVD.LINE_ITEM_ID
		AND
		INVD.ENTRY_TYPE_ID = 2
		AND
		OAS.SUB_BUDGET_ID = #{subBudgetID}
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id = invd.invoice_id
		AND
		invvv.status_id IN ('72','73')
		LEFT JOIN
		OTHER_DETAILS OTHER
		ON
		OTHER.ENTITY_ID = OAS.OPERATIONS_SUPPORT_ID
		AND
		OTHER.ENTRY_TYPE_ID = 2
		AND
		OTHER.ACTIVE_FLAG = '1'
		WHERE
		OSTM.ACTIVE_FLAG = 1
		GROUP BY
		OSTM.OPERATIONS_SUPPORT_TYPE_ID,
		OAS.OPERATIONS_SUPPORT_ID,
		(CASE
		WHEN other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE OSTM.OPERATIONS_SUPPORT_TYPE
		END),
		OAS.AMOUNT, OAS.PARENT_ID
		ORDER BY OSTM.OPERATIONS_SUPPORT_TYPE_ID, OAS.PARENT_ID
	</select>
	
	<resultMap id="CBEquipmentBeanList" type="com.nyc.hhs.model.CBEquipmentBean">
		<result property="id" column="EQUIPMENT_ID" />
		<result property="equipment" column="EQUIPMENT_NAME" />
		<result property="units" column="UNITS" />
		<result property="fyBudget" column="FY_BUDGET" />
		<result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
		<result property="remainingAmt" column="REMAINING_AMOUNT"/>
		<result property="modificationAmt" column="MOD_AMOUNT"/>
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
	</resultMap>

	<select id="fetchEquipmentModDetails" resultMap="CBEquipmentBeanList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		select
		eqp.EQUIPMENT_ID,
		eqp.EQUIPMENT_NAME,
		0 as UNITS,
		eqp.AMOUNT AS FY_BUDGET,		
    	(eqp.AMOUNT - SUM(
    	CASE
      	WHEN INVVV.STATUS_ID IS NOT NULL
      	THEN NVL(inv.INVOICE_AMOUNT,0)
     	ELSE 0
    	END ) ) AS REMAINING_AMOUNT
		from
		EQUIPMENT eqp
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		eqp.EQUIPMENT_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 12
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id = inv.invoice_id
		AND
		invvv.status_id IN ('72','73')
		WHERE
		eqp.BUDGET_ID = #{parentBudgetId}
		AND eqp.SUB_BUDGET_ID = #{parentSubBudgetId}
		AND eqp.active_flag = 1
		GROUP BY
		eqp.EQUIPMENT_ID,
		eqp.EQUIPMENT_NAME,
		eqp.UNITS,
		eqp.AMOUNT,
		eqp.CREATED_DATE
		order by eqp.CREATED_DATE desc
	</select>
	
	<select id="fetchEquipmentModAmtDetails" resultMap="CBEquipmentBeanList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		select  
	    	(CASE
	      		WHEN eqp.PARENT_ID = eqp.EQUIPMENT_ID 
	      	THEN 
	      		(eqp.EQUIPMENT_ID || '_newrecord')
	     	ELSE
	     		(eqp.PARENT_ID || '')
	    	END) as EQUIPMENT_ID,
		    eqp.EQUIPMENT_NAME,
	    	eqp.UNITS,
			eqp.AMOUNT AS MOD_AMOUNT
		from
			EQUIPMENT eqp
		LEFT JOIN
			INVOICE_DETAILS inv
		ON
			eqp.EQUIPMENT_ID = inv.LINE_ITEM_ID
		AND
			inv.ENTRY_TYPE_ID = 12
		LEFT JOIN
			INVOICE INVVV
		ON
			invvv.invoice_id = inv.invoice_id
		AND
			invvv.status_id IN ('72','73')
		WHERE
			eqp.BUDGET_ID = #{contractBudgetID}
		AND 
			eqp.SUB_BUDGET_ID = #{subBudgetID}
		AND 
			eqp.active_flag = 1
		GROUP BY
		eqp.EQUIPMENT_ID,
		eqp.EQUIPMENT_NAME,
		eqp.UNITS,
		eqp.AMOUNT, eqp.PARENT_ID
		order by eqp.PARENT_ID
	</select>

	<update id="editOperationAndSupportModDetails" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
		update OPERATIONS_AND_SUPPORT
		set
		AMOUNT = #{modificationAmt}, 
		MODIFIED_DATE =	SYSTIMESTAMP,
		MODIFIED_BY_USERID =  #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE
		PARENT_ID = #{id}
		AND SUB_BUDGET_ID = #{subBudgetID}
		AND ACTIVE_FLAG = '1'
	</update>
	
	<select id="fetchOTPSDetailsForValidation" parameterType="String"
		resultMap="CBOperationSupportModList">
		SELECT 
				(ops.AMOUNT - (SUM (CASE WHEN inv.STATUS_ID IN ('72','73')
									 	 THEN idt.INVOICE_AMOUNT
										 ELSE 0
									END ))) 
			as	REMAINING_AMOUNT
		FROM OPERATIONS_AND_SUPPORT ops
		LEFT JOIN INVOICE_DETAILS idt
		ON
		idt.LINE_ITEM_ID = ops.OPERATIONS_SUPPORT_ID
		AND
		idt.ENTRY_TYPE_ID = '2'

		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = idt.INVOICE_ID

		WHERE
		ops.OPERATIONS_SUPPORT_ID = #{asId}
    	GROUP BY ops.AMOUNT
	</select>

	<select id="getBaseUnitForEquipment"
		parameterType="com.nyc.hhs.model.CBEquipmentBean" resultType="java.lang.Integer">
		SELECT
		units
		FROM
		 EQUIPMENT
		WHERE
		Budget_Id = #{parentBudgetId,jdbcType=VARCHAR}
		And Sub_Budget_Id = #{parentSubBudgetId,jdbcType=VARCHAR}		
		and EQUIPMENT_ID = #{id,jdbcType=VARCHAR}							
	</select>
	
	<select id="getCountForOTPSMod" parameterType="com.nyc.hhs.model.CBOperationSupportBean" resultType="Integer">
	select count(1) from OPERATIONS_AND_SUPPORT where PARENT_ID = #{id} AND sub_budget_id = #{subBudgetID}	
	</select>
	
	<insert id="insertOperationAndSupportModDetails" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
	INSERT INTO OPERATIONS_AND_SUPPORT 
	  (
	  OPERATIONS_SUPPORT_ID,
	  OPERATIONS_SUPPORT_TYPE_ID,
	  BUDGET_ID,
	  SUB_BUDGET_ID,
	  PARENT_ID,
	  AMOUNT,
	  PREV_APPROVED_BUDGET,
	  ACTIVE_FLAG,
	  CREATED_DATE,
	  CREATED_BY_USERID,
	  MODIFIED_DATE,
	  MODIFIED_BY_USERID,
	  MODIFIED_BY_STAFFID,
	  CREATED_BY_STAFFID 
	  )
	  values
	  (
	  SEQ_OPERATIONS_SUPPORT_ID.nextval,
	  (select OPERATIONS_SUPPORT_TYPE_ID from OPERATIONS_AND_SUPPORT where OPERATIONS_SUPPORT_ID = #{id} ),
	  #{contractBudgetID},
	  #{subBudgetID},
	  #{id},
	  #{modificationAmt},
	  #{fyBudget},
	  1,
	  SYSDATE,
	  #{modifyByAgency},
	  SYSDATE,
	  #{modifyByAgency},
	  #{modifyByProvider},
	  #{modifyByProvider}
	  )	
	</insert>
	
	<insert id="addEquipmentModificationDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		INSERT INTO
		EQUIPMENT(
		EQUIPMENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		EQUIPMENT_NAME,
		UNITS,
		AMOUNT,
		PREV_APPROVED_BUDGET,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		PARENT_ID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID )
		VALUES(
		SEQ_EQUIPMENT_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{equipment},
		#{units},
		#{modificationAmt},
		#{fyBudget},
		SYSTIMESTAMP,
		#{modifyByAgency},
		SYSTIMESTAMP,
		#{modifyByAgency},
		'1',
		SEQ_EQUIPMENT_ID.currval,
		#{modifyByProvider},
		#{modifyByProvider}
		)
	</insert>
	
	<select id="fetchEquipmentDetailsForValidation" parameterType="String"
		resultMap="CBEquipmentBeanList">
		SELECT 
			eqp.EQUIPMENT_NAME, eqp.SUB_BUDGET_ID,
				(eqp.AMOUNT - (SUM (CASE WHEN inv.STATUS_ID IN ('72','73')
									 	 THEN idt.INVOICE_AMOUNT
										 ELSE 0
									END ))) 
			as	REMAINING_AMOUNT
		FROM EQUIPMENT eqp

		LEFT JOIN INVOICE_DETAILS idt
		ON
		idt.LINE_ITEM_ID = eqp.EQUIPMENT_ID
		AND
		idt.ENTRY_TYPE_ID = '12'

		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = idt.INVOICE_ID

		WHERE
		eqp.EQUIPMENT_ID = #{asId}
		AND eqp.PARENT_ID = #{asId}
    	GROUP BY eqp.EQUIPMENT_NAME, eqp.SUB_BUDGET_ID, eqp.AMOUNT
	</select>
	
	<update id="editEquipmentModificationDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		update EQUIPMENT
		set
		EQUIPMENT_NAME = #{equipment},
		UNITS = #{units},
		AMOUNT = #{modificationAmt},
		MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		where
		BUDGET_ID = #{contractBudgetID} AND
		SUB_BUDGET_ID = #{subBudgetID} AND
		PARENT_ID = #{id}
	</update>

	<insert id="editInsertEquipmentModificationDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		INSERT INTO
		EQUIPMENT(
		EQUIPMENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		EQUIPMENT_NAME,
		UNITS,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		PARENT_ID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID )
		VALUES(
		SEQ_EQUIPMENT_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		(select EQUIPMENT_NAME from EQUIPMENT where equipment_id = #{id}) ,
		#{units},
		#{modificationAmt},
		SYSTIMESTAMP,
		#{modifyByAgency},
		SYSTIMESTAMP,
		#{modifyByAgency},
		'1',
		#{id},
		#{modifyByProvider},
		#{modifyByProvider}
		)
	</insert>
	
	<delete id="delEquipmentModificationDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		DELETE
		FROM
		EQUIPMENT
		WHERE
		PARENT_ID = #{id}
		AND SUB_BUDGET_ID =
		#{subBudgetID}
		AND ACTIVE_FLAG = '1'
	</delete>

	<select id="fetchParentBudgetId" parameterType="java.util.Map" resultType="String">
		SELECT PARENT_ID FROM BUDGET WHERE
		BUDGET_ID = #{budgetId}
	</select>

	<select id="getUnitDescContractBudgetModificationRate"
		parameterType="com.nyc.hhs.model.RateBean" resultType="String">
		SELECT
		UNIT_DESCRIPTION
		FROM
		RATE
		WHERE PARENT_ID = #{id}
		AND
		SUB_BUDGET_ID = #{parentSubBudgetId}
	</select>

	<select id="getFYBudgetContractBudgetModificationRate"
		parameterType="com.nyc.hhs.model.RateBean" resultType="String">
		SELECT
		AMOUNT
		FROM
		RATE
		WHERE PARENT_ID = #{id}
		AND
		SUB_BUDGET_ID = #{parentSubBudgetId}
	</select>
	
	<!--Start of changes as a part of release 3.3.0 for defect 6444-->
	<select id="getBaseUnitForPersonnelService"
		parameterType="com.nyc.hhs.model.PersonnelServiceBudget" resultType="java.lang.Double">
		SELECT
		units
		FROM
		personnel_service
		WHERE
		Budget_Id = #{parentBudgetId,jdbcType=VARCHAR}
		And Sub_Budget_Id = #{parentSubBudgetId,jdbcType=VARCHAR}		
		and PERSONNEL_SERVICE_ID = #{id,jdbcType=VARCHAR}							
	</select>	
	<!--End of changes as a part of release 3.3.0 for defect 6444-->
	
	<resultMap id="ContractedServices" type="com.nyc.hhs.model.ContractedServicesBean">
		<result property="subHeader" column="CONTRACTED_SERVICE_TYPE" />
		<result property="descOfService" column="SERVICE_DESCRIPTION" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
		<result property="csName" column="NAME" />
		<result property="id" column="PARENT_ID" />
		<result property="ytdInvoiceAmt" column="YTD_INVOICE_AMOUNT" />
		<result property="invoiceAmt" column="INVOICE_AMOUNT" />
		<result property="remaingAmt" column="REMAINING_AMOUNT" />
		<result property="modificationAmt" column="MODIFICATION_AMOUNT" />
		<result property="parentId" column="PARENT_ID" />
		<result property="proposedAmt" column="PROPOSED_AMOUNT" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="ytdTotalInvoiceAmt" column="TOTAL_YTD_INVOICE_AMOUNT" />
		<result property="totalContractedServices" column="TOTAL_PROPOSED_AMOUNT" />
		
		


	</resultMap>
	<select id="fetchContractedServicesModificationConsultants"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">

		SELECT Name,
		PARENT_ID,
		SERVICE_DESCRIPTION,
		sum(FY_BUDGET) as
		AMOUNT,
		sum(mod_Amount)
		as
		MODIFICATION_AMOUNT,
		sum(INVOICE_AMOUNT),
		sum(REMAINING_AMT) as
		REMAINING_AMOUNT
		FROM
		(SELECT cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		(
		CASE
		WHEN cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) AS
		FY_BUDGET,
		0 AS
		mod_Amount,
		SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS INVOICE_AMOUNT,
		(
		CASE
		WHEN
		cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) - SUM(
		CASE
		WHEN
		INVVV.STATUS_ID
		IS NOT NULL
		THEN NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS
		REMAINING_AMT
		FROM CONTRACTED_SERVICE cs
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		cs.CONTRACTED_SERVICE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID =
		6
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		= cs.CONTRACTED_SERVICE_TYPE_ID
		LEFT JOIN
		INVOICE INVVV
		ON INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID
		IN (72,73)
		WHERE cs.BUDGET_ID = #{parentBudgetId}
		AND cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='1'
		AND
		cs.active_flag = 1
		AND
		cs.CONTRACTED_SERVICE_ID = cs.Parent_id

		GROUP BY
		cs.Name,
		cs.parent_id,
		cs.SERVICE_DESCRIPTION,
		cs.AMOUNT,
		cs.CONTRACTED_SERVICE_ID,
		cs.SUB_BUDGET_ID
		UNION ALL
		SELECT
		cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		0 AS FY_BUDGET,
		cs.AMOUNT AS
		mod_amount,
		0 AS
		INVOICE_AMOUNT,
		0 AS REMAINING_AMT
		FROM
		CONTRACTED_SERVICE cs
		INNER JOIN
		CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		=
		cs.CONTRACTED_SERVICE_TYPE_ID
		WHERE
		cs.SUB_BUDGET_ID = #{subBudgetID}
		and
		cs.parent_id!=cs.contracted_service_id
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='1'
		AND
		cs.active_flag = 1
		)
		group
		by
		Name,
		PARENT_ID,
		SERVICE_DESCRIPTION
		ORDER BY
		parent_id DESC
		
	</select>

	<select id="fetchContractedServicesModificationSubContractors"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
		SELECT Name,
		PARENT_ID,
		SERVICE_DESCRIPTION,
		sum(FY_BUDGET) as
		AMOUNT,
		sum(mod_Amount)
		as MODIFICATION_AMOUNT,
		sum(INVOICE_AMOUNT),
		sum(REMAINING_AMT) as
		REMAINING_AMOUNT
		FROM
		(SELECT cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		(
		CASE
		WHEN cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) AS
		FY_BUDGET,
		0 AS
		mod_Amount,
		SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS INVOICE_AMOUNT,
		(
		CASE
		WHEN
		cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) - SUM(
		CASE
		WHEN
		INVVV.STATUS_ID
		IS NOT NULL
		THEN NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS
		REMAINING_AMT
		FROM CONTRACTED_SERVICE cs
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		cs.CONTRACTED_SERVICE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID =
		6
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		= cs.CONTRACTED_SERVICE_TYPE_ID
		LEFT JOIN
		INVOICE INVVV
		ON INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID
		IN (72,73)
		WHERE cs.BUDGET_ID = #{parentBudgetId}
		AND cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='2'
		AND
		cs.active_flag = 1
		AND
		cs.CONTRACTED_SERVICE_ID = cs.Parent_id

		GROUP BY
		cs.Name,
		cs.parent_id,
		cs.SERVICE_DESCRIPTION,
		cs.AMOUNT,
		cs.CONTRACTED_SERVICE_ID,
		cs.SUB_BUDGET_ID
		UNION ALL
		SELECT
		cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		0 AS FY_BUDGET,
		cs.AMOUNT AS
		mod_amount,
		0 AS
		INVOICE_AMOUNT,
		0 AS REMAINING_AMT
		FROM
		CONTRACTED_SERVICE cs
		INNER JOIN
		CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		=
		cs.CONTRACTED_SERVICE_TYPE_ID
		WHERE
		cs.SUB_BUDGET_ID = #{subBudgetID}
		and
		cs.parent_id!=cs.contracted_service_id
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='2'
		AND
		cs.active_flag = 1
		)
		group
		by
		Name,
		PARENT_ID,
		SERVICE_DESCRIPTION
		ORDER BY
		parent_id DESC
		</select>

	<select id="fetchContractedServicesModificationVendors"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
		SELECT Name,
		PARENT_ID,
		SERVICE_DESCRIPTION,
		sum(FY_BUDGET) as
		AMOUNT,
		sum(mod_Amount)
		as MODIFICATION_AMOUNT,
		sum(INVOICE_AMOUNT),
		sum(REMAINING_AMT) as
		REMAINING_AMOUNT
		FROM
		(SELECT cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		(
		CASE
		WHEN cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) AS
		FY_BUDGET,
		0 AS
		mod_Amount,
		SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS INVOICE_AMOUNT,
		(
		CASE
		WHEN
		cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN cs.AMOUNT
		END) - SUM(
		CASE
		WHEN
		INVVV.STATUS_ID
		IS NOT NULL
		THEN NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS
		REMAINING_AMT
		FROM CONTRACTED_SERVICE cs
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		cs.CONTRACTED_SERVICE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID =
		6
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		= cs.CONTRACTED_SERVICE_TYPE_ID
		LEFT JOIN
		INVOICE INVVV
		ON INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID
		IN (72,73)
		WHERE cs.BUDGET_ID = #{parentBudgetId}
		AND cs.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='3'
		AND
		cs.active_flag = 1
		AND
		cs.CONTRACTED_SERVICE_ID = cs.Parent_id

		GROUP BY
		cs.Name,
		cs.parent_id,
		cs.SERVICE_DESCRIPTION,
		cs.AMOUNT,
		cs.CONTRACTED_SERVICE_ID,
		cs.SUB_BUDGET_ID
		UNION ALL
		SELECT
		cs.Name,
		cs.CONTRACTED_SERVICE_ID,
		cs.parent_id AS PARENT_ID,
		cs.SERVICE_DESCRIPTION,
		cs.SUB_BUDGET_ID,
		0 AS FY_BUDGET,
		cs.AMOUNT AS
		mod_amount,
		0 AS
		INVOICE_AMOUNT,
		0 AS REMAINING_AMT
		FROM
		CONTRACTED_SERVICE cs
		INNER JOIN
		CONTRACTED_SERVICE_TYPE_MASTER b
		ON
		b.CONTRACTED_SERVICE_TYPE_ID
		=
		cs.CONTRACTED_SERVICE_TYPE_ID
		WHERE
		cs.SUB_BUDGET_ID = #{subBudgetID}
		and
		cs.parent_id!=cs.contracted_service_id
		And
		cs.CONTRACTED_SERVICE_TYPE_ID='3'
		AND
		cs.active_flag = 1
		)
		group
		by
		Name,
		PARENT_ID,
		SERVICE_DESCRIPTION
		ORDER BY
		parent_id DESC
	</select>

	<select id="fetchNonGridContractedServices" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="ContractedServices">
		SELECT SUM(amount)as TOTAL_PROPOSED_AMOUNT,
		SUM(INVOICE_AMOUNT)as
		TOTAL_YTD_INVOICE_AMOUNT
		FROM
		(
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT
		NULL
		THEN NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		0
		AS CURRENT_INVOICE_AMOUNT,
		CONTRACTED_SERVICE_ID,
		a.AMOUNT
		FROM
		CONTRACTED_SERVICE a
		LEFT JOIN INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
		AND
		inv_det.ENTRY_TYPE_ID = '6'
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
		LEFT
		JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND
		inv.STATUS_ID in( 72,73)
		WHERE
		a.SUB_BUDGET_ID in (#{subBudgetID},#{parentSubBudgetId})
		GROUP BY
		CONTRACTED_SERVICE_ID,
		a.AMOUNT
		)

	</select>

	<select id="fetchContractedServicesNewModificationConsultants"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
		select
		NAME,SERVICE_DESCRIPTION,PARENT_ID,SUB_BUDGET_ID,AMOUNT as MODIFICATION_AMOUNT,0 as
		AMOUNT,
		0 as PROPOSED_AMOUNT,0 as REMAINING_AMOUNT from
		contracted_service where parent_id =
		contracted_service_id and
		sub_budget_id =#{subBudgetID}
		and
		contracted_service_type_id =
		#{subHeader}
		ORDER BY
		parent_id DESC

	</select>

	<insert id="addContractedServicesModification" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		Insert into
		CONTRACTED_SERVICE
		(CONTRACTED_SERVICE_ID,
		CONTRACTED_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		NAME,
		SERVICE_DESCRIPTION,
		BUDGETED_UNITS,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_STAFFID,
		CREATED_BY_USERID,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG
		)
		VALUES
		(SEQ_CONTRACTED_SERVICE_ID.nextval,
		#{subHeader},
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_CONTRACTED_SERVICE_ID.currval,
		#{csName},
		#{descOfService},
		'0',
		#{modificationAmt},
		current_timestamp,
		#{modifyByProvider},
		current_timestamp,
		#{modifyByProvider},
		#{modifyByAgency},
		#{modifyByAgency},
		'1')

	</insert>

	<insert id="editContractedServicesModification" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		Insert into
		CONTRACTED_SERVICE
		(CONTRACTED_SERVICE_ID,
		CONTRACTED_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		NAME,
		SERVICE_DESCRIPTION,
		BUDGETED_UNITS,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_STAFFID,
		CREATED_BY_USERID,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		PREV_APPROVED_BUDGET
		)
		VALUES
		(SEQ_CONTRACTED_SERVICE_ID.nextval,
		#{subHeader},
		#{contractBudgetID},
		#{subBudgetID},
		#{id},
		#{csName},
		#{descOfService},
		'0',
		#{modificationAmt},
		current_timestamp,
		#{modifyByProvider},
		current_timestamp,
		#{modifyByProvider},
		#{modifyByAgency},
		#{modifyByAgency},
		'1',
		#{fyBudget})

	</insert>

	<delete id="delContractedServicesModification" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		Delete from CONTRACTED_SERVICE
		where CONTRACTED_SERVICE_ID=#{id}
	</delete>

	<update id="updateContractedServicesModification" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		UPDATE CONTRACTED_SERVICE set
		AMOUNT=#{modificationAmt},
		NAME=#{csName},
		SERVICE_DESCRIPTION=#{descOfService},
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID=#{modifyByProvider}
		WHERE
		PARENT_ID = #{id}
		AND
		SUB_BUDGET_ID =#{subBudgetID}
		AND ACTIVE_FLAG ='1'
	</update>

	<select id="fetchInsertContractedServicesModification"
		parameterType="com.nyc.hhs.model.ContractedServicesBean" resultMap="ContractedServices">
		select SERVICE_DESCRIPTION,NAME,AMOUNT from CONTRACTED_SERVICE
		where CONTRACTED_SERVICE_ID=#{id}
	</select>	
	
 <insert id="mergeBudgetModificationDocument" parameterType="map">
  INSERT INTO
  BUDGET_DOCUMENT(BUDGET_DOCUMENT_ID,
  BUDGET_ID,CONTRACT_ID,DOCUMENT_IDENTIFIER_ID,
  DOCUMENT_TYPE,CREATED_DATE,CREATED_BY_USERID,
  MODIFIED_DATE,MODIFIED_BY_USERID)
  (select SEQ_BUDGET_DOCUMENT_ID.nextval,
  #{parentBudgetId},CONTRACT_ID,DOCUMENT_IDENTIFIER_ID,
  DOCUMENT_TYPE,CREATED_DATE,CREATED_BY_USERID,
  <!-- changes for agency outbound interafce 6644-->
  systimestamp MODIFIED_DATE,'system' MODIFIED_BY_USERID
  from BUDGET_DOCUMENT
  where
  BUDGET_ID=#{budgetId} AND CONTRACT_ID=#{contractId})
 </insert>
 

	<!-- S368 Rent modification starts here -->

	<resultMap id="RentModificationDetailsList" type="com.nyc.hhs.model.Rent">
		<result property="id" column="PARENT_ID" />
		<result property="location" column="LOCATION" />
		<result property="managementCompanyName" column="MANAGEMENT_COMPANY_NAME" />
		<result property="propertyOwner" column="PROPERTY_OWNER" />
		<result property="publicSchoolSpace" column="PUBLIC_SCHOOL_SPACE" />
		<result property="percentChargedToContract" column="PERCENT_CHARGED_TO_CONTRACT" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="modifyAmount" column="MOD_AMOUNT" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
		<result property="parentBudgetId" column="BUDGET_ID" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
	</resultMap>
	<insert id="editRentModification" parameterType="com.nyc.hhs.model.Rent">
		Insert into
		RENT
		(RENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		PARENT_ID,
		AMOUNT,
		MODIFIED_DATE,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PREV_APPROVED_BUDGET
		)
		VALUES
		(SEQ_RENT_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{location},
		#{managementCompanyName},
		#{propertyOwner},
		#{publicSchoolSpace},
		#{percentChargedToContract},
		#{id},
		#{modifyAmount},
		current_timestamp,
		current_timestamp,
		#{modifiedByUserId},
		#{modifyByProvider},
		'1',
		#{fyBudget})
	</insert>
	<insert id="insertRentModDetails" parameterType="com.nyc.hhs.model.Rent">
		INSERT INTO RENT
		(RENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID)
		VALUES
		(SEQ_RENT_ID.NEXTVAL,#{parentBudgetId},#{subBudgetId},#{location},#{managementCompanyName},
		#{propertyOwner},#{publicSchoolSpace},#{percentChargedToContract},#{fyBudget},
		SYSTIMESTAMP,#{createdByUserId},
		SYSTIMESTAMP,
		#{modifiedByUserId,jdbcType=VARCHAR},SEQ_RENT_ID.currval, #{publicSchoolSpace},
		#{createdByUserId,jdbcType=VARCHAR})
	</insert>

	<update id="updateModificationRent" parameterType="com.nyc.hhs.model.Rent">
		UPDATE Rent
		set
		LOCATION = #{location},
		 MANAGEMENT_COMPANY_NAME = #{managementCompanyName},
		PROPERTY_OWNER = #{propertyOwner},
		PUBLIC_SCHOOL_SPACE = #{publicSchoolSpace},
		PERCENT_CHARGED_TO_CONTRACT = #{percentChargedToContract},
		AMOUNT=#{modifyAmount}, 
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE
		PARENT_ID = #{id}
		AND
		SUB_BUDGET_ID =#{subBudgetID}
		AND ACTIVE_FLAG
		='1'
		
	</update>
	
	<select id="fetchRentAmendmentNewRecord" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="RentModificationDetailsList">
		select
		PARENT_ID,
		location,
		MANAGEMENT_COMPANY_NAME,
		Property_owner,
	    PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		sum(FY_BUDGET) AS AMOUNT,
		sum( REMAINING_AMT) AS REMAINING_AMOUNT,
		sum(mod_amount) AS MOD_AMOUNT
		from
		(
		SELECT
		rt.rent_id,
		rt.parent_id AS PARENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		CASE WHEN rt.PUBLIC_SCHOOL_SPACE = '0' THEN 'No' 
        ELSE 'Yes' END as PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		0 AS
		FY_BUDGET,
		0 AS
		INVOICE_AMOUNT,
		0 AS REMAINING_AMT,
		rt.AMOUNT as mod_amount
		FROM
		RENT rt where
		rt.SUB_BUDGET_ID = #{parentSubBudgetId}
		AND
		rt.active_flag = 1
		and
		rt.parent_id!=rt.rent_id
		GROUP BY
		rt.RENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		rt.PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT,
		rt.SUB_BUDGET_ID)
		GROUP BY
		PARENT_ID,
		location,
		MANAGEMENT_COMPANY_NAME,
		Property_owner,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT
		ORDER BY
		PARENT_ID DESC
	</select>
	
	<select id="fetchContractBudgetModificationRentAmount"
		parameterType="com.nyc.hhs.model.Rent" resultMap="RentModificationDetailsList">
		select PARENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT
		from RENT
		where RENT_ID=#{id}
	</select>
	<select id="getBaseContractBudgetModificationRent"
		parameterType="com.nyc.hhs.model.Rent" resultType="java.lang.Integer">
		SELECT
		count(*)
		FROM
		Rent
		WHERE
		Budget_Id = #{parentBudgetId,jdbcType=VARCHAR}
		And
		Sub_Budget_Id = #{parentSubBudgetId,jdbcType=VARCHAR}
		and Rent_ID = #{id,jdbcType=VARCHAR}							
	</select>

	<select id="fetchContractBudgetModificationRentNew"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="RentModificationDetailsList">
		select
		PARENT_ID,
		location,
		MANAGEMENT_COMPANY_NAME,
		Property_owner,
		CASE WHEN PUBLIC_SCHOOL_SPACE = '0' THEN 'No' 
        ELSE 'Yes' END as PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT as MOD_AMOUNT,
		0 as REMAINING_AMOUNT,
		SUB_BUDGET_ID,
		0 as AMOUNT,
		0 as PROPOSED_AMOUNT
		from
		rent
		where parent_id = rent_id and
		sub_budget_id =#{subBudgetID}
		ORDER BY
		PARENT_ID DESC

	</select>

	<select id="fetchContractBudgetModificationRent" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="RentModificationDetailsList">
		select
		PARENT_ID,
		location,
		MANAGEMENT_COMPANY_NAME,
		Property_owner,
	    PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		sum(FY_BUDGET) AS AMOUNT,
		sum( REMAINING_AMT) AS REMAINING_AMOUNT,
		sum(mod_amount) AS MOD_AMOUNT

		from
		(
		SELECT
		rt.rent_id,
		rt.parent_id AS PARENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		CASE WHEN rt.PUBLIC_SCHOOL_SPACE = '0' THEN 'No' 
        ELSE 'Yes' END as PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.AMOUNT AS
		FY_BUDGET,
		SUM( CASE
		WHEN
		INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS
		INVOICE_AMOUNT,
		rt.AMOUNT - SUM( CASE
		WHEN INVVV.STATUS_ID
		IS NOT NULL
		THEN NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT,
		0 as mod_amount
		FROM
		RENT rt
		LEFT JOIN INVOICE_DETAILS inv
		ON
		rt.RENT_ID =
		inv.LINE_ITEM_ID
		AND inv.ENTRY_TYPE_ID = 5
		LEFT JOIN
		INVOICE INVVV
		ON
		INVVV.INVOICE_ID = inv.INVOICE_ID
		AND INVVV.STATUS_ID IN
		(72,73)
		WHERE
		rt.SUB_BUDGET_ID = #{parentSubBudgetId}
		AND
		rt.active_flag = 1
		
		GROUP BY
		rt.RENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		rt.PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT,
		rt.SUB_BUDGET_ID

		union all


		SELECT
		rt.rent_id,
		rt.parent_id AS PARENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		CASE WHEN rt.PUBLIC_SCHOOL_SPACE = '0' THEN 'No' 
        ELSE 'Yes' END as PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		0 AS
		FY_BUDGET,

		0 AS
		INVOICE_AMOUNT,

		0 AS REMAINING_AMT,
		rt.AMOUNT as mod_amount
		FROM
		RENT rt where
		rt.SUB_BUDGET_ID = #{subBudgetID}
		AND
		rt.active_flag = 1
		and
		rt.parent_id!=rt.rent_id
		GROUP BY
		rt.RENT_ID,
		rt.location,
		rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner,
		rt.PUBLIC_SCHOOL_SPACE,
		rt. PERCENT_CHARGED_TO_CONTRACT,
		rt.CREATED_DATE,
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT,
		rt.SUB_BUDGET_ID)
		GROUP BY
		PARENT_ID,
		location,
		MANAGEMENT_COMPANY_NAME,
		Property_owner,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT
		ORDER BY
		PARENT_ID DESC
		
	</select>

	<insert id="insertContractBudgetModificationRent" parameterType="com.nyc.hhs.model.Rent">
		Insert into
		RENT
		(RENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT,
		PARENT_ID,
		CREATED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG
		)
		VALUES
		(SEQ_RENT_ID.NEXTVAL,
		#{contractBudgetID},
		#{subBudgetID},
		#{location},
		#{managementCompanyName},
		#{propertyOwner},
		#{publicSchoolSpace},
		#{percentChargedToContract},
		#{modifyAmount},
		SEQ_RENT_ID.currval,
		current_timestamp,
		#{modifyByProvider},
		current_timestamp,
		#{modifyByProvider},
		'1')
	</insert>
    <select id="getRemainingAmountModificationRent" resultType="java.math.BigDecimal"
		parameterType="com.nyc.hhs.model.Rent">
		SELECT 
		(
		CASE
		WHEN rt.SUB_BUDGET_ID =
		#{subBudgetID}
		THEN 0
		WHEN rt.SUB_BUDGET_ID = #{parentSubBudgetId}
		THEN
		rt.AMOUNT
		END) - SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT
		FROM RENT rt
		LEFT
		JOIN INVOICE_DETAILS inv
		ON rt.RENT_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 5
		LEFT JOIN INVOICE INVVV
		ON INVVV.INVOICE_ID =
		inv.INVOICE_ID
		AND INVVV.STATUS_ID IN (72,73)
		WHERE rt.parent_id = #{id}
		AND rt.active_flag = '1'
		AND rt.RENT_ID = rt.Parent_id
		GROUP BY
		rt.SUB_BUDGET_ID,
		rt.parent_id,
		rt.AMOUNT
	</select>
	
	
	<select id="getRemainingAmountModificationContractedServices" resultType="java.math.BigDecimal"
		parameterType="com.nyc.hhs.model.ContractedServicesBean">
		SELECT 
		(
		CASE
		WHEN cs.SUB_BUDGET_ID =
		#{subBudgetID}
		THEN 0
		WHEN cs.SUB_BUDGET_ID = #{parentSubBudgetId}
		THEN
		cs.AMOUNT
		END) - SUM(
		CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT
		FROM CONTRACTED_SERVICE cs
		LEFT
		JOIN INVOICE_DETAILS inv
		ON cs.CONTRACTED_SERVICE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 6
		LEFT JOIN INVOICE INVVV
		ON INVVV.INVOICE_ID =
		inv.INVOICE_ID
		AND INVVV.STATUS_ID IN (72,73)
		WHERE cs.parent_id = #{id}
		AND cs.active_flag = '1'
		AND cs.CONTRACTED_SERVICE_ID = cs.Parent_id
		GROUP BY
		cs.SUB_BUDGET_ID,
		cs.parent_id,
		cs.AMOUNT
	</select>
	
	<delete id="delRentModification" parameterType="com.nyc.hhs.model.Rent">
		Delete from RENT
		where RENT_ID=#{id}
	</delete>
	<!-- S368 Rent modification ends -->
	<select id="fetchPSDetailsForValidation" parameterType="String"
		resultType="hashmap">
      Select Sub_Budget_Id,Position_Id,Total_Salary-Amount As RemainingAmount From (
      Select Distinct A.Personnel_Service_Id, A.sub_budget_id,A.position_id,A.Total_Salary,
         SUM(Decode(status_id,72,A.Amount,73,A.Amount,NULL,0,0)) over(partition by Personnel_Service_Id) Amount
        From(
        select ps.personnel_service_id,ps.sub_budget_id,ps.position_id,Ps.Total_Salary,
		NVL(inv.INVOICE_AMOUNT,0 ) as AMOUNT, inv.INVOICE_ID
		FROM PERSONNEL_SERVICE ps left outer join INVOICE_DETAILS inv
		ON ps.PERSONNEL_SERVICE_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 1
 		Where
	   Ps.Personnel_Service_Id = #{id}
              ) A
            Left Outer Join Invoice Invvv
            On  A.Invoice_Id   = Invvv.Invoice_Id)  
	</select>	
	
	<select id="fetchFringeAmountForValidation" parameterType="String"
		resultType="java.math.BigDecimal">
		Select Amount-INVOICED_AMOUNT as RemainingAmount from(
        Select distinct A.Fringe_Benefit_Id,A.Amount, 
        SUM(Decode(status_id,72,A.INVOICED_AMOUNT,73,A.INVOICED_AMOUNT,NULL,0,0)) over(partition by Fringe_Benefit_Id) INVOICED_AMOUNT
        from(
  	    Select Fb.Fringe_Benefit_Id, 
		fb.AMOUNT, NVL(inv.INVOICE_AMOUNT,0) as INVOICED_AMOUNT, inv.INVOICE_ID
		from
		FRINGE_BENEFIT fb
		LEFT OUTER JOIN INVOICE_DETAILS inv ON
		fb.FRINGE_BENEFIT_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 13
   	    Where
        Fb.Fringe_Benefit_Id = #{id}
        ) A
        Left Outer Join Invoice Invvv
        On  A.Invoice_Id   = Invvv.Invoice_Id)             
	</select>
	<select id="fetchModificationAmountTotal" resultType="java.lang.String"
		parameterType="java.lang.String">
		select nvl(sum(amount),0) from (
		SELECT AMOUNT FROM CONTRACTED_SERVICE where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM EQUIPMENT where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM FRINGE_BENEFIT where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT INDIRECT_AMOUNT AS AMOUNT FROM INDIRECT_RATE where
		Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM MILESTONE where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM OPERATIONS_AND_SUPPORT where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT TOTAL_SALARY AS AMOUNT FROM PERSONNEL_SERVICE where
		Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM PROFESSIONAL_SERVICE where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM RATE where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM RENT where Sub_Budget_Id=#{aoBudgetId}
		union all
		SELECT AMOUNT FROM UTILITIES where Sub_Budget_Id=#{aoBudgetId} 
		 union all
		SELECT AMOUNT FROM UNALLOCATED where Sub_Budget_Id=#{aoBudgetId}  
		)
	</select>
	
	  <insert id="mergePersonnelServiceReplica" parameterType="java.util.Map">
			Merge INTO Personnel_Service A USING
			(SELECT B.personnel_service_id AS Id,
			  B.TOTAL_SALARY               AS originalamount,
			  B.UNITS                      AS originalunits,
			  C.TOTAL_SALARY               AS modamount,
			  C.UNITS                      AS modunits
			FROM personnel_service B,
			  personnel_service C
			WHERE B.personnel_service_id    = C.Parent_Id
			AND B.Budget_Id                != C.Budget_Id
			AND B.Sub_Budget_Id            != C.Sub_Budget_Id
			AND C.BUDGET_ID                 = #{budgetId}
			AND C.Active_Flag               = '1'
			) N ON ( A.personnel_service_id = N.Id)
			WHEN matched THEN
			UPDATE
			SET TOTAL_SALARY = N.originalamount + N.modamount,
			UNITS          = N.originalunits  + N.modunits
			<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>		

  	 <insert id="mergeOperationAndSupportReplica" parameterType="java.util.Map">
  	 Merge Into OPERATIONS_AND_SUPPORT A
Using ( Select B.OPERATIONS_SUPPORT_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From OPERATIONS_AND_SUPPORT B, OPERATIONS_AND_SUPPORT C Where B.OPERATIONS_SUPPORT_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.OPERATIONS_SUPPORT_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>	
  	 
  	  <insert id="mergeUtilitiesReplica" parameterType="java.util.Map">
  	  Merge Into UTILITIES A
Using ( Select B.UTILITIES_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From UTILITIES B, UTILITIES C Where B.UTILITIES_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.UTILITIES_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeProfessionalServiceReplica" parameterType="java.util.Map">
  	  Merge Into PROFESSIONAL_SERVICE A
Using ( Select B.PROFESSIONAL_SERVICE_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From PROFESSIONAL_SERVICE B, PROFESSIONAL_SERVICE C Where B.PROFESSIONAL_SERVICE_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.PROFESSIONAL_SERVICE_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeRentReplica" parameterType="java.util.Map">
  	  Merge Into RENT A
Using ( Select B.RENT_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From RENT B, RENT C Where B.RENT_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.RENT_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeContractedServicesReplica" parameterType="java.util.Map">
  	  Merge Into CONTRACTED_SERVICE A
Using ( Select B.CONTRACTED_SERVICE_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From CONTRACTED_SERVICE B, CONTRACTED_SERVICE C Where B.CONTRACTED_SERVICE_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.CONTRACTED_SERVICE_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeRateReplica" parameterType="java.util.Map">
		Merge INTO RATE A USING
		(SELECT B.RATE_ID   AS Id,
		  B.AMOUNT          AS originalamount,
		  B.NUMBER_OF_UNITS AS originalunits,
		  C.AMOUNT          AS modamount,
		  C.NUMBER_OF_UNITS AS modunits
		FROM RATE B,
		  RATE C
		WHERE B.RATE_ID      = C.Parent_Id
		AND B.Budget_Id     != C.Budget_Id
		AND B.Sub_Budget_Id != C.Sub_Budget_Id
		AND C.BUDGET_ID      = #{budgetId}
		AND C.Active_Flag    = '1'
		) N ON ( A.RATE_ID   = N.Id)
		WHEN matched THEN
		UPDATE
		SET AMOUNT        = N.originalamount + N.modamount,
		NUMBER_OF_UNITS = N.originalunits  + N.modunits
		<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeMilestoneReplica" parameterType="java.util.Map">
  	  Merge Into MILESTONE A
Using ( Select B.MILESTONE_ID As Id,
		B.AMOUNT As originalamount, 
		C.AMOUNT As modamount 
	From MILESTONE B, MILESTONE C 
	Where B.MILESTONE_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
			And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.MILESTONE_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
 <!-- QC 8394 R 7.9.0 add multiple lines to unallocated fund -->  	 
<insert id="mergeUnallocatedReplica" parameterType="java.util.Map">
  	 Merge Into UNALLOCATED A
	  Using ( Select B.UNALLOCATED_ID As Id,
	  				 B.AMOUNT As originalamount, 
	  				 C.AMOUNT As modamount 
			 From UNALLOCATED B,UNALLOCATED C 
			 Where B.UNALLOCATED_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
				  And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.UNALLOCATED_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeIndirectRateReplica" parameterType="java.util.Map">
  	  Merge Into Indirect_Rate A
Using ( Select B.INDIRECT_RATE_ID As Id,C.Budget_Id As budget_id, B.INDIRECT_AMOUNT As originalamount, 
C.INDIRECT_AMOUNT As modamount From INDIRECT_RATE B, INDIRECT_RATE C Where B.INDIRECT_RATE_ID = C.Parent_Id 
And B.Budget_Id != C.Budget_Id And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.INDIRECT_RATE_ID = N.Id)
when matched then update set INDIRECT_AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeProgramIncomeReplica" parameterType="java.util.Map">
  	  Merge Into Program_Income A
Using ( Select B.PROGRAM_INCOME_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From PROGRAM_INCOME B, PROGRAM_INCOME C Where B.PROGRAM_INCOME_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.PROGRAM_INCOME_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeFringeReplica" parameterType="java.util.Map">
  	  Merge Into FRINGE_BENEFIT A
Using ( Select B.FRINGE_BENEFIT_ID As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
From FRINGE_BENEFIT B, FRINGE_BENEFIT C Where B.FRINGE_BENEFIT_ID = C.Parent_Id And B.Budget_Id != C.Budget_Id 
And B.Sub_Budget_Id != C.Sub_Budget_Id and C.BUDGET_ID = #{budgetId} and C.Active_Flag = '1') N
On ( A.FRINGE_BENEFIT_ID = N.Id)
when matched then update set AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	  <insert id="mergeEquipmentReplica" parameterType="java.util.Map">
		Merge INTO EQUIPMENT A USING
		(SELECT B.EQUIPMENT_ID AS Id,
		  B.AMOUNT             AS originalamount,
		  B.UNITS              AS originalunits,
		  C.AMOUNT             AS modamount,
		  C.UNITS              AS modunits
		FROM EQUIPMENT B,
		  EQUIPMENT C
		WHERE B.EQUIPMENT_ID    = C.Parent_Id
		AND B.Budget_Id        != C.Budget_Id
		AND B.Sub_Budget_Id    != C.Sub_Budget_Id
		AND C.BUDGET_ID         = #{budgetId}
		AND C.Active_Flag       = '1'
		) N ON ( A.EQUIPMENT_ID = N.Id)
		WHEN matched THEN
		UPDATE
		SET AMOUNT = N.originalamount + N.modamount,
		UNITS    = N.originalunits  + N.modunits
		<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	 </insert>
  	 
  	 <select id="fetchSubBudgetList" parameterType="java.lang.String"
		resultType="string">
		select SUB_BUDGET_ID from sub_budget where budget_id = #{budgetId} and ACTIVE_FLAG = 1
	</select>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markPersonnelServiceAsDeleted" parameterType="java.util.Map">
		UPDATE PERSONNEL_SERVICE SET ACTIVE_FLAG='0'<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markOperationAndSupportAsDeleted" parameterType="java.util.Map">
		UPDATE OPERATIONS_AND_SUPPORT SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
	WHERE BUDGET_ID   = #{budgetId}
	</update>

	<!-- changes for agency outbound interafce 6644-->
	<update id="markUtilitiesAsDeleted" parameterType="java.util.Map">
		UPDATE UTILITIES SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID   = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markProfessionalServiceAsDeleted" parameterType="java.util.Map">
		UPDATE PROFESSIONAL_SERVICE SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID  = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markRentAsDeleted" parameterType="java.util.Map">
		UPDATE RENT SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID  = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markContractedServicesAsDeleted" parameterType="java.util.Map">
		UPDATE CONTRACTED_SERVICE SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markRateAsDeleted" parameterType="java.util.Map">
		UPDATE RATE SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markMilestoneAsDeleted" parameterType="java.util.Map">
		UPDATE MILESTONE SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markUnallocatedAsDeleted" parameterType="java.util.Map">
		UPDATE UNALLOCATED SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markIndirectRateAsDeleted" parameterType="java.util.Map">
		UPDATE INDIRECT_RATE SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markProgramIncomeAsDeleted" parameterType="java.util.Map">
		UPDATE PROGRAM_INCOME SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markFringeAsDeleted" parameterType="java.util.Map">
		UPDATE FRINGE_BENEFIT SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markEquipmentAsDeleted" parameterType="java.util.Map">
		UPDATE EQUIPMENT SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markSubBudgetsAsDeleted" parameterType="java.util.Map">
		UPDATE SUB_BUDGET SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	<!-- changes for agency outbound interafce 6644-->
	<update id="markBudgetAsDeleted" parameterType="java.util.Map">
		UPDATE BUDGET SET ACTIVE_FLAG ='0' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<!-- INSERT newly added Line Items during Modification and link with Base SubBudget and Base Budget -->
	<insert id="createPersonnelServiceReplica" parameterType="java.util.Map">	
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,UNITS,
		TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID)
		 (SELECT SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,#{parentBudgetId},#{subBudgetId},
		SEQ_PERSONNEL_SERVICES_ID.currval,UNITS,TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp MODIFIED_DATE,#{modifyBy} MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,CREATED_BY_STAFFID from PERSONNEL_SERVICE 
		WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId}) and PERSONNEL_SERVICE_ID=PARENT_ID)
   </insert>
   
   <insert id="createOperationAndSupportReplica" parameterType="java.util.Map">	
		INSERT INTO OPERATIONS_AND_SUPPORT
  (OPERATIONS_SUPPORT_ID, OPERATIONS_SUPPORT_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, AMOUNT, ACTIVE_FLAG,
    CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
      (SELECT SEQ_OPERATIONS_SUPPORT_ID.NEXTVAL, OPERATIONS_SUPPORT_TYPE_ID,#{parentBudgetId},#{subBudgetId}, SEQ_OPERATIONS_SUPPORT_ID.currval, 
   AMOUNT, ACTIVE_FLAG, CREATED_DATE,CREATED_BY_USERID, <!-- changes for agency outbound interafce 6644 and 6649-->systimestamp MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID 
   From OPERATIONS_AND_SUPPORT 
 WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and OPERATIONS_SUPPORT_ID=PARENT_ID )
   </insert>	
   
    <insert id="createUtilitiesReplica" parameterType="java.util.Map">	
		INSERT INTO UTILITIES
  ( UTILITIES_ID, UTILITIES_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
    CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
    (SELECT SEQ_UTILITIES_ID.NEXTVAL, UTILITIES_TYPE_ID, #{parentBudgetId},#{subBudgetId}, SEQ_UTILITIES_ID.currval, AMOUNT, ACTIVE_FLAG,
  CREATED_DATE, CREATED_BY_USERID,
  <!-- changes for agency outbound interafce 6644 and 6649-->systimestamp MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
FROM UTILITIES WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and UTILITIES_ID = PARENT_ID )
   </insert>
   
   <insert id="createProfessionalServiceReplica" parameterType="java.util.Map">
   INSERT INTO PROFESSIONAL_SERVICE
  (PROFESSIONAL_SERVICE_ID, PROFESSIONAL_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
    AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
    MODIFIED_BY_STAFFID, CREATED_BY_STAFFID ) 
  (SELECT SEQ_PROFESSIONAL_SERVICE_ID.NEXTVAL, PROFESSIONAL_SERVICE_TYPE_ID, #{parentBudgetId},#{subBudgetId}, SEQ_PROFESSIONAL_SERVICE_ID.currval,
  AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
  CREATED_BY_STAFFID FROM PROFESSIONAL_SERVICE WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and PROFESSIONAL_SERVICE_ID = PARENT_ID )
   
   </insert>
   
   <insert id="createRentReplica" parameterType="java.util.Map">
   INSERT INTO RENT
  (RENT_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, LOCATION,  MANAGEMENT_COMPANY_NAME, PROPERTY_OWNER,  PUBLIC_SCHOOL_SPACE,
    PERCENT_CHARGED_TO_CONTRACT, AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,  MODIFIED_BY_USERID,
    MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
   (SELECT SEQ_RENT_ID.nextval, #{parentBudgetId},#{subBudgetId}, SEQ_RENT_ID.currval, LOCATION, MANAGEMENT_COMPANY_NAME, PROPERTY_OWNER, PUBLIC_SCHOOL_SPACE,
  PERCENT_CHARGED_TO_CONTRACT, AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID,
  MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RENT WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and RENT_ID = PARENT_ID )
  </insert>
   			
   <insert id="createContractedServicesReplica" parameterType="java.util.Map">
   INSERT INTO CONTRACTED_SERVICE
  (CONTRACTED_SERVICE_ID, CONTRACTED_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
    NAME, SERVICE_DESCRIPTION, BUDGETED_UNITS, AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,
    MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID) 
   (SELECT SEQ_CONTRACTED_SERVICE_ID.NEXTVAL, CONTRACTED_SERVICE_TYPE_ID, #{parentBudgetId},#{subBudgetId},
  SEQ_CONTRACTED_SERVICE_ID.currval, NAME, SERVICE_DESCRIPTION, BUDGETED_UNITS, AMOUNT, ACTIVE_FLAG,CREATED_DATE, 
  CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
FROM CONTRACTED_SERVICE WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and CONTRACTED_SERVICE_ID = PARENT_ID)
   </insert>	
   		
   <insert id="createRateReplica" parameterType="java.util.Map">
   INSERT INTO RATE 
(RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, UNIT_DESCRIPTION, NUMBER_OF_UNITS, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
    CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
   (SELECT SEQ_RATE_ID.nextval, #{parentBudgetId},#{subBudgetId}, SEQ_RATE_ID.currval, UNIT_DESCRIPTION,  NUMBER_OF_UNITS,
  AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID,
  MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RATE WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and RATE_ID = PARENT_ID )
  </insert>
  
  <insert id="createMilestoneReplica" parameterType="java.util.Map">
  INSERT INTO MILESTONE
  (MILESTONE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, MILESTONE, AMOUNT, ACTIVE_FLAG,
    CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
    CREATED_BY_STAFFID )  
  (SELECT SEQ_MILESTONE_ID.NEXTVAL,#{parentBudgetId},#{subBudgetId}, SEQ_MILESTONE_ID.currval, MILESTONE, AMOUNT, ACTIVE_FLAG,
  CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
  CREATED_BY_STAFFID FROM MILESTONE WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and MILESTONE_ID = PARENT_ID) 
  </insert>
  
 <!-- QC 8394 R 7.9.0 add multiple lines to unallocated fund -->
   <insert id="createUnallocatedReplica" parameterType="java.util.Map">
   INSERT INTO UNALLOCATED
  (UNALLOCATED_ID, BUDGET_ID,  SUB_BUDGET_ID, PARENT_ID, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
    CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, 
    CREATED_BY_STAFFID, UNALLOCATED_FUND )   
  (SELECT SEQ_UNALLOCATED_ID.nextval,#{parentBudgetId},#{subBudgetId}, SEQ_UNALLOCATED_ID.currval, AMOUNT, ACTIVE_FLAG, 
  CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID,
  UNALLOCATED_FUND
   FROM UNALLOCATED WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and UNALLOCATED_ID = PARENT_ID)
   </insert>
   
   <insert id="createIndirectRateReplica" parameterType="java.util.Map">
   INSERT INTO INDIRECT_RATE 
    (INDIRECT_RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, INDIRECT_AMOUNT, INDIRECT_RATE,
    ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
    MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )  
    (SELECT SEQ_INDIRECT_RATE_ID.nextval, #{parentBudgetId},#{subBudgetId}, SEQ_INDIRECT_RATE_ID.currval, 
    INDIRECT_AMOUNT, INDIRECT_RATE, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE, 
    #{modifyBy} MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM INDIRECT_RATE WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and INDIRECT_RATE_ID=PARENT_ID)
   </insert>
   
   <!-- Added in R7 for new columns in program income table -->
   <insert id="createProgramIncomeReplica" parameterType="java.util.Map">
   INSERT INTO PROGRAM_INCOME
  (PROGRAM_INCOME_ID, BUDGET_ID, SUB_BUDGET_ID, PROGRAM_INCOME_TYPE_ID, PARENT_ID,
    AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
    MODIFIED_BY_STAFFID, CREATED_BY_STAFFID,DESCRIPTION,ENTRY_TYPE_ID) 
  (SELECT SEQ_PROGRAM_INCOME_ID.nextval, #{parentBudgetId},#{subBudgetId}, PROGRAM_INCOME_TYPE_ID, SEQ_PROGRAM_INCOME_ID.currval,
  AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID,
  MODIFIED_BY_STAFFID, CREATED_BY_STAFFID,DESCRIPTION,ENTRY_TYPE_ID FROM PROGRAM_INCOME WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and PROGRAM_INCOME_ID = PARENT_ID)
  </insert>
  
  <insert id="createFringeReplica" parameterType="java.util.Map">
  INSERT INTO FRINGE_BENEFIT
  (FRINGE_BENEFIT_ID, BUDGET_ID, SUB_BUDGET_ID, AMOUNT, FRINGE_PERCENT, CREATED_DATE,
    CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, PARENT_ID, ACTIVE_FLAG,
    MODIFIED_BY_STAFFID, CREATED_BY_STAFFID ) 
  (SELECT SEQ_FRINGE_BENEFIT_ID.nextval, #{parentBudgetId},#{subBudgetId}, AMOUNT, FRINGE_PERCENT, CREATED_DATE,
  CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, SEQ_FRINGE_BENEFIT_ID.currval, ACTIVE_FLAG,
  MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM FRINGE_BENEFIT WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and FRINGE_BENEFIT_ID = PARENT_ID)
  </insert>
  
  <insert id="createEquipmentReplica" parameterType="java.util.Map">
  INSERT INTO EQUIPMENT
  (EQUIPMENT_ID, BUDGET_ID, SUB_BUDGET_ID, EQUIPMENT_NAME, UNITS, AMOUNT, CREATED_DATE,
    CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, ACTIVE_FLAG,
    PARENT_ID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID ) 
   (SELECT SEQ_EQUIPMENT_ID.nextval, #{parentBudgetId},#{subBudgetId}, EQUIPMENT_NAME, UNITS,
  AMOUNT, CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644 and 6649-->systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID,
  ACTIVE_FLAG, SEQ_EQUIPMENT_ID.currval, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
  FROM EQUIPMENT WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  and EQUIPMENT_ID=PARENT_ID)
  </insert>			
	
	<!-- changes for agency outbound interafce 6644-->
	<insert id="mergeSubBudgetForUpdate" parameterType="java.util.Map">
MERGE INTO sub_budget Base
USING   sub_budget Upd
 <!-- Base.budget_id != #{budgetId} added in R7 defect 6822 -->
ON (Base.sub_budget_id = Upd.parent_id AND  Upd.budget_id = #{budgetId} and Base.budget_id != #{budgetId})
WHEN MATCHED THEN
UPDATE SET Base.sub_budget_amount = Base.sub_budget_amount + Upd.sub_budget_amount
<!-- changes for agency outbound interafce 6644-->,Base.MODIFIED_DATE=systimestamp,Base.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
  	 
  	 <!-- changes for agency outbound interafce 6644-->
  	 <insert id="mergeBudgetForUpdate" parameterType="java.util.Map">
  	 MERGE INTO Budget Base
USING   Budget Upd
ON (Base.Budget_id = Upd.parent_id AND  Upd.budget_id = #{budgetId}) 
WHEN MATCHED THEN
UPDATE SET Base.fiscal_year_amount = Base.fiscal_year_amount + Upd.fiscal_year_amount
<!-- changes for agency outbound interafce 6644-->,Base.MODIFIED_DATE=systimestamp,Base.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
	
	<select id="fetchParentContractId" parameterType="java.util.Map" resultType="String">
		SELECT PARENT_CONTRACT_ID FROM CONTRACT WHERE
		CONTRACT_ID = #{contractId}
	</select>
	
	<!--Release 3.6.0 Enhancement id 6263 -->
	<select id="fetchContractAmendmentAmount" parameterType="java.lang.String" resultType="BigDecimal">
		SELECT CONTRACT_AMOUNT FROM CONTRACT WHERE
		CONTRACT_ID = #{contractId}
	</select>
	
	<!-- changes for agency outbound interafce 6644-->
	<insert id="mergeContractForUpdate" parameterType="java.util.Map">
  	MERGE INTO Contract Base
USING   Contract Upd
ON (Base.Contract_id = Upd.parent_Contract_id AND  Upd.Contract_id =  #{contractId}) 
WHEN MATCHED THEN
UPDATE SET     Base.Contract_amount = Upd.Contract_amount
<!-- changes for agency outbound interafce 6644-->,Base.MODIFIED_DATE=systimestamp,Base.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
  	 
  	  <insert id="mergeBudgetUpdateDocument" parameterType="map">
  INSERT INTO
  BUDGET_DOCUMENT(BUDGET_DOCUMENT_ID,
  BUDGET_ID,CONTRACT_ID,DOCUMENT_IDENTIFIER_ID,
  DOCUMENT_TYPE,CREATED_DATE,CREATED_BY_USERID,
  MODIFIED_DATE,MODIFIED_BY_USERID)
  (select SEQ_BUDGET_DOCUMENT_ID.nextval,
  #{parentBudgetId},#{parentContractId},DOCUMENT_IDENTIFIER_ID,
  DOCUMENT_TYPE,CREATED_DATE,CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644-->systimestamp MODIFIED_DATE,
  'system' MODIFIED_BY_USERID
  from BUDGET_DOCUMENT
  where
  BUDGET_ID=#{budgetId} AND CONTRACT_ID=#{contractId})
 </insert>
 
  <insert id="mergeContractUpdateDocument" parameterType="map">
   INSERT INTO CONTRACT_DOCUMENT
  (CONTRACT_DOCUMENT_ID, CONTRACT_ID, DOCUMENT_IDENTIFIER_ID, DOCUMENT_TYPE,
    CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID )
    (SELECT SEQ_CONTRACT_DOCUMENT_ID.nextval, #{parentContractId},DOCUMENT_IDENTIFIER_ID,DOCUMENT_TYPE,
  CREATED_DATE, CREATED_BY_USERID,<!-- changes for agency outbound interafce 6644-->systimestamp MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID
FROM CONTRACT_DOCUMENT where CONTRACT_ID=#{contractId})
 </insert>

	<select id="fetchUpdateAmountTotal" parameterType="java.lang.String"
		resultType="BigDecimal">
		SELECT CAST(SUM(amount) as decimal(25, 2))
		FROM
		( SELECT amount FROM milestone WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		UNION ALL
		SELECT amount FROM rate WHERE sub_budget_id = #{aoSubBudgetId} AND
		active_flag = 1
		UNION ALL
		SELECT amount
		FROM contracted_service
		WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		UNION ALL
		SELECT amount FROM utilities WHERE sub_budget_id = #{aoSubBudgetId} AND
		active_flag = 1
		UNION ALL
		SELECT amount FROM rent WHERE sub_budget_id = #{aoSubBudgetId} AND
		active_flag = 1
		UNION ALL
		SELECT amount FROM unallocated WHERE sub_budget_id =  #{aoSubBudgetId} AND active_flag = 1
		UNION ALL
		SELECT amount FROM fringe_benefit WHERE sub_budget_id =  #{aoSubBudgetId} AND active_flag = 1
		UNION ALL
		SELECT amount
		FROM professional_service
		WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		UNION ALL
		SELECT amount
		FROM operations_and_support
		WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		UNION ALL
		SELECT SUM(TOTAL_SALARY) AS amount
		FROM personnel_service
		WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		UNION ALL
		SELECT amount FROM EQUIPMENT WHERE sub_budget_id =  #{aoSubBudgetId} AND active_flag = 1
		UNION ALL
		SELECT indirect_amount AS amount
		FROM indirect_rate
		WHERE sub_budget_id = #{aoSubBudgetId}
		AND active_flag = 1
		)
	</select>

	<select id="fetchSubBudgetAmount" parameterType="java.lang.String"
		resultType="BigDecimal">
		  select sub_budget_amount from sub_budget where sub_budget_id = #{aoSubBudgetId}
	</select>
	
	<!-- changes for agency outbound interafce 6644-->
	<insert id="mergeContractForAmendment" parameterType="java.util.Map">
  	 Merge Into Contract A
Using ( Select B.CONTRACT_ID As Id,B.CONTRACT_AMOUNT As originalamount, C.CONTRACT_AMOUNT As modamount 
From CONTRACT B, CONTRACT C Where B.CONTRACT_ID = C.PARENT_CONTRACT_ID  and C.CONTRACT_ID = #{contractId} ) N
On ( A.CONTRACT_ID = N.Id)
when matched then update set CONTRACT_AMOUNT = N.originalamount + N.modamount
<!-- changes for agency outbound interafce 6644-->,A.MODIFIED_DATE=systimestamp,A.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
  	 
  	 <select id="fetchCountOfApprovedBudget" parameterType="java.lang.String" resultType="Integer">
		select count(1) from BUDGET where CONTRACT_ID= #{aoContractId} AND STATUS_ID = '86'	
	</select>
	
<!-- /* [Start] R8.10.0 QC9399    */ -->
	<!-- changes for agency outbound interafce 6644-->
	<update id="updateContractEndDate" parameterType="java.util.Map">
	 UPDATE CONTRACT con
     SET CONTRACT_END_DATE = 
             (SELECT   case when  amd.PROPOSED_CONTRACT_END_DATE >= con.CONTRACT_END_DATE 
                            then  amd.PROPOSED_CONTRACT_END_DATE
                            ELSE con.CONTRACT_END_DATE
                       END as PROPOSED_CONTRACT_END_DATE
                FROM CONTRACT amd WHERE CONTRACT_ID = #{contractId})
         ,MODIFIED_DATE=systimestamp,
         MODIFIED_BY_USERID = #{modifyBy}
     WHERE CONTRACT_ID = (SELECT PARENT_CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID = #{contractId})
	</update>
<!-- 	<update id="updateContractEndDate" parameterType="java.util.Map">
     UPDATE CONTRACT SET CONTRACT_END_DATE = (SELECT PROPOSED_CONTRACT_END_DATE FROM CONTRACT WHERE CONTRACT_ID = #{contractId})
     changes for agency outbound interafce 6644,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
     WHERE CONTRACT_ID = (SELECT PARENT_CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID = #{contractId})
	</update>
 -->
<!-- /* [End] R8.10.0 QC9399    */ -->

	<select id="fetchModificationSubBudgetSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		 SELECT 
		    A.SUB_BUDGET_ID,
		    A.PARENT_ID, 
		    A.SUB_BUDGET_NAME, 
		    B.SUB_BUDGET_AMOUNT 
		 FROM 
		    SUB_BUDGET A,
		    (SELECT 
		        SUB_BUDGET_ID,
		        SUB_BUDGET_AMOUNT 
		     FROM 
		        SUB_BUDGET 
		     WHERE 
		        SUB_BUDGET_ID in (SELECT PARENT_ID FROM SUB_BUDGET WHERE BUDGET_ID = #{budgetId})
		     ) B
		 WHERE 
		    A.PARENT_ID = B.SUB_BUDGET_ID 
		 AND 
		    A.BUDGET_ID = #{budgetId}
		 AND 
		 	A.ACTIVE_FLAG = '1'    
		 ORDER BY B.SUB_BUDGET_ID 
				
	</select>
	
	<select id="fetchUpdateSubBudgetSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		 SELECT 
		    A.SUB_BUDGET_ID,
		    A.PARENT_ID, 
		    A.SUB_BUDGET_NAME, 
		    B.SUB_BUDGET_AMOUNT 
		 FROM 
		    SUB_BUDGET A,
		    (
                  SELECT 
         	sub.SUB_BUDGET_ID as SUB_BUDGET_ID,
            case when sub.SUB_BUDGET_ID != sub_up.SUB_BUDGET_ID then
            (sub.SUB_BUDGET_AMOUNT + sub_up.SUB_BUDGET_AMOUNT) 
           else
            (sub.SUB_BUDGET_AMOUNT ) 
            END
            as SUB_BUDGET_AMOUNT 
         FROM 
            SUB_BUDGET sub
       		inner join 
          ( SELECT sub_budget_id,
            PARENT_ID,
            SUB_BUDGET_AMOUNT 
         FROM 
            SUB_BUDGET 
         WHERE 
            SUB_BUDGET_ID in (SELECT SUB_BUDGET_ID FROM SUB_BUDGET WHERE BUDGET_ID = #{budgetId})
           ) sub_up
             on sub_up.PARENT_ID = sub.SUB_BUDGET_ID
        
        ) B
		 WHERE 
		    A.PARENT_ID = B.SUB_BUDGET_ID 
		 AND 
		    A.BUDGET_ID = #{budgetId}
		 AND 
		 	A.ACTIVE_FLAG = '1'      
		 ORDER BY B.SUB_BUDGET_ID
				
	</select>

	<select id="fetchBudgetStatus" parameterType="java.util.Map"
		resultType="java.lang.String">
		SELECT STATUS_MASTER_R2_R3.STATUS
		FROM BUDGET
		INNER JOIN STATUS_MASTER_R2_R3 ON STATUS_MASTER_R2_R3.STATUS_ID =
		BUDGET.STATUS_ID
		WHERE BUDGET_ID = #{budgetId}
	</select>	
	
  	 <select id="fetchNewlyAddedSubBudgetList" parameterType="java.lang.String"
		resultType="string">
		select SUB_BUDGET_ID from sub_budget where budget_id = #{aoBudgetId} and sub_budget_id = parent_id and active_flag = '1'		
	</select>	
	<!-- Updated in 8775: PARENT_ID column was inserted with parentBudgetId, changed to newSubBudgetId -->
	<insert id="linkSubBudgetToBase" parameterType="java.util.Map">
		<!-- Following update statement commented for 6822 -->
		<!-- UPDATE SUB_BUDGET
		SET BUDGET_ID = #{parentBudgetId}changes for agency outbound interafce 6644,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId} -->
		 <!-- Changes for 6822 starts -->
		 Insert into SUB_BUDGET 
              (SUB_BUDGET_ID,
              BUDGET_ID,
              FISCAL_YEAR_ID,
              PARENT_ID,
              SUB_BUDGET_NAME,
              SUB_BUDGET_AMOUNT,
              <!-- Start QC 9592 R 8.10.0 - add remaining and invoiced amount for newly added sub_budget -->  
              YTD_INVOICED_AMOUNT,
              REMAINING_AMOUNT,
              <!-- End QC 9592 R 8.10.0 - add remaining and invoiced amount for newly added sub_budget -->             LAST_UPDATE_DATE,
              ACTIVE_FLAG,
              CREATED_DATE,
              CREATED_BY_STAFFID,
              MODIFIED_DATE,
              MODIFIED_BY_STAFFID)
              ( select #{newSubBudgetId},
               #{parentBudgetId},
               FISCAL_YEAR_ID,
               #{newSubBudgetId} ,
               SUB_BUDGET_NAME,
               SUB_BUDGET_AMOUNT,
               <!-- Start QC 9592 R 8.10.0 - add remaining and invoiced amount for newly added sub_budget -->  
               0,
               SUB_BUDGET_AMOUNT,
               <!-- End QC 9592 R 8.10.0 - add remaining and invoiced amount for newly added sub_budget -->  
              systimestamp, 
              1,
              systimestamp,  
              'system', 
              systimestamp,
              'system' 
              from SUB_BUDGET where SUB_BUDGET_ID = #{subBudgetId} )
             <selectKey keyProperty="newSubBudgetId" resultType="java.lang.String" order="BEFORE">
			select
			SEQ_SUB_BUDGET_ID.NEXTVAL from Dual
			</selectKey>
			<!-- Changes for 6822 ends -->
	</insert>	
	
	<!-- Start Release 6 defect id 8480 -->
	       <insert id="insertNewSubBudgetModificationDetailsInAmendment" parameterType="map">  
              Insert into SUB_BUDGET 
              (SUB_BUDGET_ID,
              BUDGET_ID,
              FISCAL_YEAR_ID,
              PARENT_ID,
              SUB_BUDGET_NAME,
              SUB_BUDGET_AMOUNT,
              LAST_UPDATE_DATE,
              ACTIVE_FLAG,
              CREATED_DATE,
              CREATED_BY_STAFFID,
              MODIFIED_DATE,
              MODIFIED_BY_STAFFID)
              <!-- Start: Added for 8529 -->      
              (select #{modSubBudgetId},
              <!-- End: Added for 8529 -->
                                BUDGET_ID,
                                FISCAL_YEAR_ID,
                                #{subBudgetId},
                                (select sub_budget_name from sub_budget where SUB_BUDGET_ID = #{subBudgetId}),
                                0,
                                systimestamp,
                                1,
                                systimestamp,
                                'system',
                                systimestamp,
                                'system'  from budget where parent_id = (select budget_id from sub_budget where SUB_BUDGET_ID = #{subBudgetId}) and budget_type_id in (3)
  				and active_flag = 1
				)
		<!-- Start: Added for 8529 -->
		<selectKey keyProperty="modSubBudgetId" resultType="java.lang.String" order="BEFORE">
			select
			SEQ_SUB_BUDGET_ID.NEXTVAL from Dual
		</selectKey>
		<!-- End: Added for 8529 -->
       </insert>
	<!-- End Release 6 defect id 8480 -->
	
	<update id="linkPersonnelServicesToBase" parameterType="java.util.Map">
		UPDATE PERSONNEL_SERVICE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	
	<update id="linkOperationsAndSupportToBase" parameterType="java.util.Map">
		UPDATE OPERATIONS_AND_SUPPORT
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	
	<update id="linkUtilitiesToBase" parameterType="java.util.Map">
		UPDATE UTILITIES
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkProfessionalServiceToBase" parameterType="java.util.Map">
		UPDATE PROFESSIONAL_SERVICE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkRentToBase" parameterType="java.util.Map">
		UPDATE RENT
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkContractedServicesToBase" parameterType="java.util.Map">
		UPDATE CONTRACTED_SERVICE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkRateToBase" parameterType="java.util.Map">
		UPDATE RATE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkMilestoneToBase" parameterType="java.util.Map">
		UPDATE MILESTONE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkUnallocatedToBase" parameterType="java.util.Map">
		UPDATE UNALLOCATED
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkIndirectToBase" parameterType="java.util.Map">
		UPDATE INDIRECT_RATE
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkProgramIncomeToBase" parameterType="java.util.Map">
		UPDATE PROGRAM_INCOME
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkFringeToBase" parameterType="java.util.Map">
		UPDATE FRINGE_BENEFIT
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>

	<update id="linkEquipmemtToBase" parameterType="java.util.Map">
		UPDATE EQUIPMENT
		SET BUDGET_ID = #{parentBudgetId}<!-- changes for agency outbound interafce 6644-->
		<!-- Changes for 6822 starts -->
		,SUB_BUDGET_ID=#{newSubBudgetId},
		<!-- Changes for 6822 ends -->
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	<!-- changes for agency outbound interafce 6644-->
	<update id="markContractAsDeleted" parameterType="java.util.Map">
		UPDATE CONTRACT SET DELETE_FLAG ='1' <!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
        WHERE CONTRACT_ID = #{contractId}
	</update>	
	<!-- changes for agency outbound interafce 6644-->
	<insert id="mergeContractFinancialForAmendment" parameterType="java.util.Map">
	Merge Into contract_FINANCIALS A
	Using (Select B.contract_FINANCIALS_id As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
	From contract_FINANCIALS B, contract_FINANCIALS C Where B.contract_FINANCIALS_id = C.Parent_Id And B.contract_Id != C.contract_Id
	and C.contract_Id = #{contractId} and C.Active_Flag = '1') N
	On (A.contract_FINANCIALS_id = N.Id)
	when matched then update set AMOUNT = N.originalamount + N.modamount,previous_amount= N.originalamount + N.modamount
	<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	</insert>
	<!-- changes for agency outbound interafce 6644-->
	<insert id="mergeContractFinancialForUpdate" parameterType="java.util.Map">
	Merge Into contract_FINANCIALS A
	Using (Select B.contract_FINANCIALS_id As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
	From contract_FINANCIALS B, contract_FINANCIALS C Where B.contract_FINANCIALS_id = C.Parent_Id And B.contract_Id != C.contract_Id
	and C.contract_Id = #{contractId} and C.Active_Flag = '1') N
	On (A.contract_FINANCIALS_id = N.Id)
	when matched then update set A.amount = N.modamount	,A.previous_amount= N.modamount
	<!-- changes for agency outbound interafce 6644-->,A.MODIFIED_DATE=systimestamp,A.MODIFIED_BY_USERID = #{modifyBy}
  	</insert>
  	
  
	<insert id="createContractFinancialReplica" parameterType="java.util.Map">	
	   	<!-- Start: QC 8934  R 7.6.0 Contract Budget Amendment Not Getting Merged because 
	   	     of attempt to insert duplicate base line
	   	     Validate: if line item already inserted - update previous amount
	   	     		   if line item not found - insert it
	   	     and QC 9173: Update Configuration not merging when new CoA is created and Update covers multiple Fiscal Years
	   	     		   
	   	 -->
	   	<!-- 
		INSERT INTO
		CONTRACT_FINANCIALS
 		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
         APPROVED_BY,
     	 APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         previous_amount)
      (
      SELECT SEQ_CONTRACT_FINANCIALS_ID.nextval,
		 PROCUREMENT_ID,
		 #{parentContractId},
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 SEQ_CONTRACT_FINANCIALS_ID.currval,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 -->
		 <!-- changes for agency outbound interafce 6644-->
		 <!-- 
		 systimestamp MODIFIED_DATE,#{modifyBy} MODIFIED_BY_USERID,
         APPROVED_BY,
         APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         AMOUNT as previous_amount
         FROM CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{contractId} and CONTRACT_FINANCIALS_ID = PARENT_ID AND ACTIVE_FLAG = 1)
         -->
         
      	Merge Into CONTRACT_FINANCIALS A
		Using ( SELECT  
					PROCUREMENT_ID,
					#{parentContractId} as CONTRACT_ID,
					UNIT_OF_APPROPRIATION,
					BUDGET_CODE,
					OBJECT_CODE,
					SUB_OBJECT_CODE,
					REPORTING_CATEGORY,
					FISCAL_YEAR_ID,
					AMOUNT,
					DOCUMENT_IDENTIFIER_ID,
					LAST_UPDATE_DATE,
					ACTIVE_FLAG,
					SYSTIMESTAMP as CREATED_DATE,
					CREATED_BY_USERID,
					APPROVED_BY,
					APPROVED_DATE,
					NEW_FY_FISCAL_YEAR_ID,
					AMOUNT as previous_amount
		 FROM CONTRACT_FINANCIALS 
		 WHERE CONTRACT_ID = #{contractId}  
				AND CONTRACT_FINANCIALS_ID = PARENT_ID
				) N
		On (A.CONTRACT_ID = N.CONTRACT_ID
        AND A.UNIT_OF_APPROPRIATION = N.UNIT_OF_APPROPRIATION
        AND A.BUDGET_CODE = N.BUDGET_CODE
        AND A.OBJECT_CODE = N.OBJECT_CODE
        AND nvl( A.SUB_OBJECT_CODE,' ') = nvl( N.SUB_OBJECT_CODE,' ')
        AND nvl(A.REPORTING_CATEGORY,' ') = nvl(N.REPORTING_CATEGORY,' ')
        AND A.FISCAL_YEAR_ID = N.FISCAL_YEAR_ID
			)
	when matched then 
			update set previous_amount= N.previous_amount,
					   MODIFIED_DATE=SYSTIMESTAMP,
					   MODIFIED_BY_USERID = 'system',
					   ACTIVE_FLAG=1
	when not matched then 
		insert 	(CONTRACT_FINANCIALS_ID,
				PROCUREMENT_ID,
				CONTRACT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				DOCUMENT_IDENTIFIER_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				PARENT_ID,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				APPROVED_BY,
				APPROVED_DATE,
				NEW_FY_FISCAL_YEAR_ID,
				previous_amount)
		 values (SEQ_CONTRACT_FINANCIALS_ID.NEXTVAL,
			n.PROCUREMENT_ID,
			n.CONTRACT_ID,
			n.UNIT_OF_APPROPRIATION,
			n.BUDGET_CODE,
			n.OBJECT_CODE,
			n.SUB_OBJECT_CODE,
			n.REPORTING_CATEGORY,
			n.FISCAL_YEAR_ID,
			n.AMOUNT,
			n.DOCUMENT_IDENTIFIER_ID,
			n.LAST_UPDATE_DATE,
			1,
			SEQ_CONTRACT_FINANCIALS_ID.CURRVAL,
			SYSTIMESTAMP,
			#{modifyBy},
      		SYSTIMESTAMP,
			#{modifyBy},
			n.APPROVED_BY,
			n.APPROVED_DATE,
			n.NEW_FY_FISCAL_YEAR_ID,
			n.previous_amount
		 )    
		    
		 <!-- End: QC 8934  R 7.6.0 Contract Budget Amendment Not Getting Merged 
		       and QC 9173: Update Configuration not merging when new CoA is created and Update covers multiple Fiscal Years
		 --> 
   </insert>
	
	<!-- changes for agency outbound interafce 6644-->
	<update id="markContractFinancialAsDeleted" parameterType="java.util.Map">
		UPDATE CONTRACT_FINANCIALS SET ACTIVE_FLAG='0'<!-- changes for agency outbound interafce 6644-->,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID=#{modifyBy}
		WHERE CONTRACT_ID = #{contractId}
	</update>
	
	<select id="fetchRateValidationRemngUnits" parameterType="com.nyc.hhs.model.RateBean"
		resultType="Integer">
		select
		rt.number_of_units - SUM(CASE
		WHEN
		INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(inv.invoiced_units,0)
		ELSE
		0
		END ) AS REMAINING_UNITS
		from
		rate rt
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		rt.RATE_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 7
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id =
		inv.invoice_id
		AND
		invvv.status_id IN ('73')
		WHERE
		rt.parent_id = #{id}
		and
		RT.BUDGET_ID = #{parentBudgetId}
		AND
		RT.SUB_BUDGET_ID = #{parentSubBudgetId}
		AND
		RT.active_flag = 1
		GROUP BY
		rt.RATE_ID,
		rt.number_of_units
	</select>
	
	
	
	<!-- START || Added as a part of release 3.12.0 for enhancement request 6601 -->
	
	<select id="isAmendmentRegisteredInFMS" parameterType="java.lang.String"
		resultType="int">
	select IS_AMENDMENT_REGISTERED_IN_FMS from contract where contract_id = #{lsContractId}
	</select>
	
	<insert id="mergeContractForAmendmentFMSRegisteredContract" parameterType="java.util.Map">
		MERGE INTO CONTRACT A
				Using (
		 WITH REF_CONTRACT_TEMP AS 
		(SELECT CONTRACT_ID, CONTRACT_AMOUNT FROM CONTRACT WHERE CONTRACT_ID = #{parentContractId}),
		REF_CONTRACT_FINANCIALS_TEMP AS
		(SELECT B.PARENT_CONTRACT_ID,SUM(A.AMOUNT) AS CF_AMOUNT FROM CONTRACT_FINANCIALS A,CONTRACT B WHERE A.CONTRACT_ID = #{contractId}  
		AND B.CONTRACT_ID = A.CONTRACT_ID AND A.ACTIVE_FLAG = 1
		<!-- start release 3.14.0 -->
		<if test="loAmendmentBudgetList != null and  loAmendmentBudgetList.size > 0">
		AND A.FISCAL_YEAR_ID NOT IN 
		<foreach item="items" index="index" collection="loAmendmentBudgetList"
					open="(" separator="," close=")">
					#{items}
		</foreach>
		</if>
		<!-- end release 3.14.0 -->
		GROUP BY B.PARENT_CONTRACT_ID)
		SELECT SUM(CF_AMOUNT+CONTRACT_AMOUNT) as NEW_TOTAL_CONTRACT_AMOUNT, PARENT_CONTRACT_ID FROM REF_CONTRACT_TEMP , REF_CONTRACT_FINANCIALS_TEMP WHERE PARENT_CONTRACT_ID  = CONTRACT_ID
		group by PARENT_CONTRACT_ID
		) N
		ON ( A.CONTRACT_ID = N.PARENT_CONTRACT_ID)
		WHEN MATCHED THEN UPDATE SET CONTRACT_AMOUNT = NEW_TOTAL_CONTRACT_AMOUNT
		,A.MODIFIED_DATE=systimestamp,A.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
  	 
  	<insert id="mergeContractFinancialForAmendmentFMSRegisteredContract" parameterType="java.util.Map">
	Merge Into contract_FINANCIALS A
	Using (Select B.contract_FINANCIALS_id As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
	From contract_FINANCIALS B, contract_FINANCIALS C Where B.contract_FINANCIALS_id = C.Parent_Id And B.contract_Id != C.contract_Id
	and C.contract_Id = #{contractId} and C.Active_Flag = '1' 
	<!-- start release 3.14.0 -->
	<if test="loAmendmentBudgetList != null and  loAmendmentBudgetList.size > 0">
	and C.FISCAL_YEAR_ID not in 
		<foreach item="items" index="index" collection="loAmendmentBudgetList"
			open="(" separator="," close=")">
			#{items}
		</foreach>
	</if>
	<!-- end release 3.14.0 -->
	) N
	On (A.contract_FINANCIALS_id = N.Id)
	when matched then update set AMOUNT = N.originalamount + N.modamount,previous_amount=N.originalamount + N.modamount
	,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	</insert>
  	
  	<insert id="createContractFinancialReplicaFMSRegisteredContract" parameterType="java.util.Map">
  	INSERT INTO
		CONTRACT_FINANCIALS
 		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
         APPROVED_BY,
     	 APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         previous_amount)
      (
      SELECT SEQ_CONTRACT_FINANCIALS_ID.nextval,
		 PROCUREMENT_ID,
		 #{parentContractId},
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 SEQ_CONTRACT_FINANCIALS_ID.currval,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 systimestamp MODIFIED_DATE,#{modifyBy} MODIFIED_BY_USERID,
         APPROVED_BY,
         APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         AMOUNT as previous_amount
         FROM CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{contractId} and CONTRACT_FINANCIALS_ID = PARENT_ID AND ACTIVE_FLAG = 1 
         <!-- start release 3.14.0 -->
         <if test="loAmendmentBudgetList != null and  loAmendmentBudgetList.size > 0">
         AND FISCAL_YEAR_ID not in 
         <foreach item="items" index="index" collection="loAmendmentBudgetList"
			open="(" separator="," close=")">
			#{items}
		</foreach>
		</if>
		<!-- end release 3.14.0 -->
		)
   </insert>
	
	<update id="markContractFinancialAsDeletedFMSRegisteredContract" parameterType="java.util.Map">
		UPDATE CONTRACT_FINANCIALS SET ACTIVE_FLAG='0',MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID=#{modifyBy}
		WHERE CONTRACT_ID = #{contractId} 
		<!-- start release 3.14.0 -->
		 <if test="loAmendmentBudgetList != null and  loAmendmentBudgetList.size > 0">
			 AND FISCAL_YEAR_ID not in 
			 <foreach item="items" index="index" collection="loAmendmentBudgetList"
				open="(" separator="," close=")">
				#{items}
			</foreach>
		</if>
		<!-- end release 3.14.0 -->
	</update>
   <!-- END || Added as a part of release 3.12.0 for enhancement request 6601 -->
   
 	<!-- R7 starts  for modification-->
	<select id="fetchInfoForAutoApproval" parameterType="String"
		resultType="Integer">
		select sum(modification_count) as MODIFICATION_COUNT from (
		SELECT count(1) as Modification_count, 3 AS entry_type_id FROM Utilities WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND Utilities.amount>0
		AND Utilities.parent_id IN (SELECT utilities_id FROM Utilities WHERE
		amount=0 AND utilities_id IN (SELECT parent_id FROM Utilities WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND amount>0))
		UNION ALL
		SELECT count(1), 2 AS entry_type_id FROM OPERATIONS_AND_SUPPORT WHERE
		SUB_BUDGET_ID=#{subBudgetID}
		AND OPERATIONS_AND_SUPPORT.amount>0
		AND OPERATIONS_AND_SUPPORT.parent_id IN (SELECT OPERATIONS_SUPPORT_ID
		FROM OPERATIONS_AND_SUPPORT WHERE
		amount=0 AND OPERATIONS_SUPPORT_ID IN (SELECT parent_id FROM
		OPERATIONS_AND_SUPPORT WHERE SUB_BUDGET_ID=#{subBudgetID} AND
		amount>0))
		UNION ALL
		SELECT count(1), 4 AS entry_type_id FROM PROFESSIONAL_SERVICE WHERE
		SUB_BUDGET_ID=#{subBudgetID}
		AND PROFESSIONAL_SERVICE.amount>0
		AND PROFESSIONAL_SERVICE.parent_id IN (SELECT PROFESSIONAL_SERVICE_ID
		FROM PROFESSIONAL_SERVICE WHERE
		amount=0 AND PROFESSIONAL_SERVICE_ID IN (SELECT parent_id FROM
		PROFESSIONAL_SERVICE WHERE SUB_BUDGET_ID=#{subBudgetID} AND amount>0))
		UNION ALL
		SELECT count(1), 9 AS entry_type_id FROM UNALLOCATED WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND UNALLOCATED.amount>0
		AND UNALLOCATED.parent_id IN (SELECT UNALLOCATED_ID FROM UNALLOCATED
		WHERE
		amount=0 AND UNALLOCATED_ID IN (SELECT parent_id FROM UNALLOCATED WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND amount>0))
		UNION ALL
		SELECT count(1), 10 AS entry_type_id FROM INDIRECT_RATE WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND INDIRECT_RATE.indirect_amount>0
		AND INDIRECT_RATE.parent_id IN (SELECT INDIRECT_RATE_ID FROM
		INDIRECT_RATE WHERE indirect_amount=0
		AND INDIRECT_RATE_ID IN (SELECT parent_id FROM INDIRECT_RATE WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND indirect_amount>0))
		UNION ALL
		SELECT count(1),1 AS entry_type_id FROM PERSONNEL_SERVICE WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND PERSONNEL_SERVICE_ID=parent_id
		UNION ALL
		SELECT count(1),13 AS entry_type_id FROM FRINGE_BENEFIT WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND FRINGE_BENEFIT_ID=parent_id
		UNION ALL
		SELECT count(1),5 AS entry_type_id FROM rent WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND rent_id=parent_id
		UNION ALL
		SELECT count(1),6 AS entry_type_id FROM contracted_service WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND contracted_service_id=parent_id
		UNION ALL
		SELECT count(1),7 AS entry_type_id FROM RATE WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND RATE_ID=parent_id
		UNION ALL
		SELECT count(1),8 AS entry_type_id FROM MILESTONE WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND MILESTONE_ID=parent_id
		UNION ALL
		SELECT count(1),12 AS entry_type_id FROM EQUIPMENT WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND EQUIPMENT_ID=parent_id
		UNION ALL
		SELECT count(1),13 AS entry_type_id FROM FRINGE_BENEFIT WHERE
		SUB_BUDGET_ID=#{subBudgetID} AND FRINGE_BENEFIT_ID=parent_id)
	</select>

	<resultMap id="autoApprovalPercentage" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="totalModification" column="total_modification_amount" />
		<result property="modificationPercentage" column="modification_percentage" />
		<result property="subbudgetAmount" column="Sub_budget_amount" />
		<result property="modifiedUnits" column="MODIFIED_UNITS" />
<!-- [Start] R8.5.0 QC9465  add column for unallocated fund --> 
		<result property="unallocatedFundCount" column="unallocated_Fund_Cnt" />
<!-- [End]  R8.5.0 QC9465  add column for unallocated fund -->		
	</resultMap>
	<!-- R7 Changes Starts: query updated for defect 8844 -Modifications to Unallocated Funds triggers manual review -->
	<select id="calculatePercentageForAutoApproval" parameterType="hashmap"
		resultMap="autoApprovalPercentage">
		with budget_list as (SELECT SB.SUB_BUDGET_ID
		FROM SUB_BUDGET SB,
		BUDGET B, 
		BUDGET_APPROVAL_DETAILS app
		WHERE SB.parent_id =
		(SELECT sb.parent_id
		FROM SUB_BUDGET sb
		WHERE sb.SUB_BUDGET_ID = #{subBudgetID})
		AND SB.BUDGET_ID = B.BUDGET_ID
		AND B.BUDGET_TYPE_ID = 3
		AND B.STATUS_ID IN (86,82)
		AND B.DELETE_FLAG =0
		AND app.sub_budget_id = sb.SUB_BUDGET_ID
		AND B.IS_AUTO_APPROVED = '1'
		UNION ALL
		SELECT #{subBudgetIDNum, jdbcType=INTEGER} FROM dual
		)
		SELECT
		to_char(sum(SUB_BUDGET_AMOUNT)) as Sub_budget_amount ,
		to_char((sum(modification_amount)/2)) AS total_modification_amount,
		Case 
        When sum(SUB_BUDGET_AMOUNT) != 0 THEN
		to_char(Round((((sum(modification_amount)/2)/sum(SUB_BUDGET_AMOUNT))*100),2))
		ELSE to_char(0)
    	END AS
		modification_percentage
		FROM (
		SELECT abs(TOTAL_SALARY) AS modification_amount,0 as sub_budget_amount FROM
		personnel_service WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		fringe_benefit WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		operations_and_support WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		utilities WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		professional_service WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM rent
		WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		contracted_service WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM rate
		WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		milestone WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(INDIRECT_AMOUNT) AS modification_amount,0 as sub_budget_amount
		FROM indirect_rate WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		equipment WHERE
		SUB_BUDGET_ID IN (SELECT SUB_BUDGET_ID FROM budget_list)
		UNION ALL
		SELECT 0 as modification_amount, sub_budget_amount FROM sub_budget WHERE
		SUB_BUDGET_ID =(select Parent_id from sub_budget where sub_budget_id=#{subBudgetID}))
	</select>
<!-- R7 Changes Starts: query updated for defect 8844 -Modifications to Unallocated Funds triggers manual review -->
<select id="calculatePercentageForCostCenterAutoApproval" parameterType="hashmap"
		resultMap="autoApprovalPercentage">
		SELECT TO_CHAR(SUM(SUB_BUDGET_AMOUNT))  AS Sub_budget_amount ,
  		TO_CHAR((SUM(modification_amount) /2))  AS total_modification_amount,
  		Case 
        When sum(SUB_BUDGET_AMOUNT) != 0 THEN
		to_char(Round((((sum(modification_amount)/2)/sum(SUB_BUDGET_AMOUNT))*100),2))
		ELSE to_char(0)
    	END AS
		modification_percentage
		FROM (SELECT 0 AS modification_amount,
    	sub_budget_amount
  		FROM sub_budget
  		WHERE SUB_BUDGET_ID =(SELECT Parent_id FROM sub_budget WHERE sub_budget_id=#{subBudgetID})
  		UNION ALL
  		SELECT ABS(FY_BUDGET_AMOUNT) AS modification_amount,
    	0  AS sub_budget_amount
  		FROM cost_center_details
 		WHERE SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
  		SELECT ABS(FY_BUDGET_INCOME) AS modification_amount,
    	0  AS sub_budget_amount
  		FROM BC_SERVICES_DETAILS
  		WHERE SUB_BUDGET_ID =#{subBudgetID}
  		UNION ALL
		SELECT abs(amount) AS modification_amount,
		0 as sub_budget_amount FROM
		unallocated WHERE
		SUB_BUDGET_ID =#{subBudgetID})
	</select>
	<!-- R7 Changes Ends:-->
	<!-- R7 Changes Starts: query will fetch the sum of modified units for budgetId. -->
<!-- /* [Start] R8.5.0 QC 9465  Adding Auto Approval into Services Tab */ -->
	<select id="sumOfModifiedUnitsForCostCenterAutoApproval" parameterType="hashmap"
		resultMap="autoApprovalPercentage">
			SELECT MODIFIED_UNITS , unallocated_Fund_Cnt
			FROM (  SELECT BUDGET_ID ,	  (SUM(modifiedUnits) + SUM(MODIFIED_FY_INCOME))  AS MODIFIED_UNITS 
			          FROM    ( SELECT   BUDGET_ID,   ABS(a.FY_BUDGET_UNITS)  as modifiedUnits, ABS( a.FY_BUDGET_INCOME) as MODIFIED_FY_INCOME
					                  FROM    BC_SERVICES_DETAILS a
					                 WHERE    a.BUDGET_ID = #{budgetId}
			    	           )
			        group by   BUDGET_ID
			      ) B_S,
			     ( SELECT BUDGET_ID, count(amount) as unallocated_Fund_Cnt from UNALLOCATED
			        WHERE BUDGET_ID  = #{budgetId}
			          and   ACTIVE_FLAG = 1 
			          and   amount != 0
			        group by   BUDGET_ID
			      ) U_a,
			      BUDGET  bud
			WHERE  bud.BUDGET_ID  = #{budgetId}
			  AND  bud.BUDGET_ID = B_S.BUDGET_ID (+)
              AND  bud.BUDGET_ID = U_a.BUDGET_ID (+)
			
	</select>
<!-- /* [End] R8.5.0 QC 9465  Adding Auto Approval into Services Tab */ -->
<!-- 	<select id="sumOfModifiedUnitsForCostCenterAutoApproval" parameterType="hashmap"
		resultMap="autoApprovalPercentage">
		SELECT 
		SUM(modifiedUnits) AS MODIFIED_UNITS
		FROM
		(SELECT 
     	ABS(a.FY_BUDGET_UNITS) as modifiedUnits
		FROM 	BC_SERVICES_DETAILS a
		WHERE a.BUDGET_ID =#{budgetId}
    	)
	</select> -->
	<!-- R7 Changes Ends:-->

	<select id="fetchConfiguredThreshold" parameterType="java.lang.String"
		resultType="hashmap">
		WITH threshold_config AS
		(SELECT COUNT(1) AS COUNT,
		max(version_id) as version_id,
    	max(THRESHOLD_PERCENTAGE) as threshold_percentage
		FROM AUTO_APPROVAL_CONFIG_PCT_TH
		WHERE agency_id=
		(SELECT agency_id FROM contract WHERE contract_id=#{contractId}
		)
		AND organization_id=
		(SELECT organization_id FROM contract WHERE contract_id=#{contractId}
		)
		)
		SELECT
		CASE
		WHEN threshold_config.count >0
		THEN threshold_config.version_id
		ELSE ac.version_id
		END AS version_id,
    	CASE
		WHEN threshold_config.count >0
		THEN threshold_config.threshold_percentage
		ELSE ac.threshold_percentage
		END AS threshold_percentage
    	FROM AUTO_APPROVAL_CONFIG_PCT_TH ac,
		threshold_config
		WHERE ac.agency_id=
		(SELECT agency_id FROM contract WHERE contract_id=#{contractId})
		AND organization_id IS NULL
	</select>
	<insert id="insertAutoApprovalDetails" parameterType="hashmap">
		INSERT INTO
		BUDGET_APPROVAL_DETAILS
		(BUDGET_APPROVAL_DETAILS_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		BUDGET_TYPE_ID,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		VERSION_ID,
		APPROVAL_REASON,
		AUTO_APPROVED_VALUE,
		SUB_BUDGET_VALUE,
		THRESHOLD_CONFIGURED,
		CALCULATED_THRESHOLD
		)
		select 
		SEQ_MODIFICATION_APPROVAL_ID.nextval,
		#{budgetId},
		#{subBudgetID},
		(SELECT BUDGET_TYPE_ID FROM budget WHERE budget_id=#{budgetId}),
		SYSTIMESTAMP,
		'system',
		SYSTIMESTAMP,
		'system',
		#{versionId ,jdbcType=VARCHAR},
		#{approvalReason},
		subbudget_modn_amt,
		(SELECT SUB_BUDGET_AMOUNT FROM SUB_BUDGET WHERE SUB_BUDGET_ID= (select Parent_id from sub_budget where sub_budget_id=#{subBudgetID})),
		#{thresholdValue,jdbcType=VARCHAR},
		actual_mod_percent
  		from
		(SELECT
		to_char(sum(SUB_BUDGET_AMOUNT)) as Sub_budget_amount ,
    	to_char((sum(subbudget_modn_amt)/2)) AS subbudget_modn_amt,
    	Case 
        When sum(SUB_BUDGET_AMOUNT) != 0 THEN
    	to_char(((sum(subbudget_modn_amt)/2)/sum(SUB_BUDGET_AMOUNT))*100) 
    	ELSE to_char(0)
    	END AS actual_mod_percent
		FROM (
		SELECT abs(TOTAL_SALARY/2) AS subbudget_modn_amt, abs(TOTAL_SALARY) AS modification_amount,0 as sub_budget_amount FROM
		personnel_service WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		fringe_benefit WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		operations_and_support WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		utilities WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		professional_service WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM rent
		WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		contracted_service WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM rate
		WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		milestone WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		unallocated WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(INDIRECT_AMOUNT/2) AS subbudget_modn_amt,abs(INDIRECT_AMOUNT) AS modification_amount,0 as sub_budget_amount
		FROM indirect_rate WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT abs(amount/2) AS subbudget_modn_amt,abs(amount) AS modification_amount,0 as sub_budget_amount FROM
		equipment WHERE
		SUB_BUDGET_ID =#{subBudgetID}
		UNION ALL
		SELECT 0 as subbudget_modn_amt,0 as modification_amount, sub_budget_amount FROM sub_budget WHERE
		SUB_BUDGET_ID =(select Parent_id from sub_budget where sub_budget_id=#{subBudgetID})))
	</insert> 
	
	<update id="updateApprovalDetailsInBudget" parameterType="hashmap">
		update BUDGET set IS_AUTO_APPROVED = #{lbIsEligibleForAutoApproval}
		where BUDGET_ID = #{budgetId}
	</update>
	
	 <select id="getTotalModificationOfBaseBudget" resultType="string" parameterType="hashmap">
		select count(1) as count from budget 
		where BUDGET_TYPE_ID ='3' 
		and status_id='86' 
		and parent_id =(SELECT parent_id FROM budget WHERE budget_id=#{budgetId})
	</select>
	
	 <select id="getFinalIsShowMessageFlag" resultType="string" parameterType="hashmap">
		SELECT IS_AUTO_APPROVED
		FROM
  		(SELECT IS_AUTO_APPROVED
  		FROM budget
  		WHERE parent_id =(SELECT parent_id FROM budget WHERE budget_id=#{budgetId})
  		AND BUDGET_TYPE_ID ='3'
  		and status_id='86'
  		and approved_date is not NULL 
  		ORDER BY approved_date DESC)
		WHERE rownum=1  
	</select>
	<update id="updateShowInfoFlagInBudget" parameterType="hashmap">
		update BUDGET set SHOW_INFO_MESSAGE = (SELECT is_auto_approved FROM budget WHERE budget_id=#{budgetId})
		WHERE parent_id=(SELECT parent_id FROM budget WHERE budget_id=#{budgetId})
		AND budget_type_id=2
	</update>
  	 
  	 <select id="getAutoApproverUserNameForAgency" resultType="string">
		select 
		concat(concat(first_name,' ') , last_name) as name 
		from city_user_details 
		where user_dn not like '%cn%' 
		and active_flag =0 
		and user_type='agency_org' 
		and user_role='system'
		and ORGANIZATION_NAME ='agency'
	</select>
	
	 <select id="fetchparentBudgetAgencyId" parameterType="java.lang.String"
		resultType="string">
		SELECT AGENCY_ID FROM Contract WHERE
		contract_id=#{lsContractId}
	</select>
	
	<!-- added in R7 to fetch the approved modification count -->
	<select id="fetchBudgetModificationUrlCount" parameterType="string"
		resultType="string">
		select IS_AUTO_APPROVED from
		(select IS_AUTO_APPROVED from budget where parent_id=(select parent_id from budget
		where budget_id=#{budgetId})
		and budget_type_id=3 and status_id=86
		and approved_date is not null 
		ORDER BY approved_date DESC)
		where rownum=1
	</select>
      
      <!-- added in R7: This query will update the showInfoMessage when the Invoice review task or budget modification review task will be approved at final level -->
      <update id="updateAutoApprovalReviewFlag" parameterType="java.lang.String">
       UPDATE budget
		SET SHOW_INFO_MESSAGE =(SELECT is_auto_approved FROM budget WHERE budget_id=#{budgetId})
		WHERE budget_id=
  		(SELECT parent_id FROM budget WHERE budget_id=#{budgetId} AND rownum=1 )
		AND budget_type_id=2
      </update>
      
      <select id="getStatusIdForModification" resultType="string">
      select status_id from budget WHERE BUDGET_ID = #{budgetId}
      </select>
      <!-- End R7 -->
     	<select id="fetchApprovedModificationSubBudgetSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		 SELECT 
		    A.SUB_BUDGET_ID,
		    A.PARENT_ID, 
		    A.SUB_BUDGET_NAME, 
		    B.SUB_BUDGET_AMOUNT 
		 FROM 
		    SUB_BUDGET A,
		    (SELECT 
		        SUB_BUDGET_ID,
		        SUB_BUDGET_AMOUNT 
		     FROM 
		        SUB_BUDGET 
		     WHERE 
		        SUB_BUDGET_ID in (SELECT PARENT_ID FROM SUB_BUDGET WHERE BUDGET_ID = #{budgetId})
		     ) B
		 WHERE 
		    A.PARENT_ID = B.SUB_BUDGET_ID 
		 AND 
		    A.BUDGET_ID = #{budgetId}
		 AND 
		 	A.ACTIVE_FLAG = '0'
		 ORDER BY B.SUB_BUDGET_ID 
				
	</select>
	<!-- R7 End for modification-->
	 <!--Start: Added in R7 for Cost Center-->
   <resultMap id="ContractServicesModificationList" type="com.nyc.hhs.model.CBServicesBean">
		<result property="id" column="SERVICES_ID" />
		<result property="serviceName" column="SERVICE_NAME" />
		<result property="units" column="APPROVED_UNITS" />
		<result property="remUnits" column="REMAINING_UNITS" />
		<result property="fyBudget" column="APPROVED_FY_INCOME" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="modificationAmt" column="MODIFIED_AMOUNT" />
		<result property="modUnits" column="MODIFICATION_UNITS" />
		<result property="costCenter" column="cost_center" />
	</resultMap>
	
   <select id="fetchContractServicesModificationDetails" parameterType="com.nyc.hhs.model.CBGridBean" 
   		resultMap="ContractServicesModificationList">
		SELECT SERVICE_NAME,
    	SUM(REMAINING_UNITS) AS REMAINING_UNITS,
    	SUM(mod_units) AS MODIFICATION_UNITS,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_INCOME,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,COST_CENTER_SERVICE_MAPPING_ID as cost_center,
		parent_id AS SERVICES_ID
		FROM
		( SELECT srv_mstr.service_name, 
     	a.REMAINING_UNITS,
     	0 as mod_units, 
		a.FY_BUDGET_INCOME AS APPROVED_FY_BUDGET, 
 		(a.FY_BUDGET_INCOME -
   		SUM(
	 	CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ))
    	AS remaining_amount,
		0 AS mod_amount,c.COST_CENTER_SERVICE_MAPPING_ID,
		a.parent_id
		FROM BC_SERVICES_DETAILS a
		LEFT JOIN INVOICE_SERVICES_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join budget_services_configuration b
    	on a.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
		inner join cost_center_services_mapping c
    	on b.COST_CENTER_SERVICE_MAPPING_ID = c.COST_CENTER_SERVICE_MAPPING_ID
    	inner join services_master srv_mstr
    	on c.SERVICE_MASTER_ID = srv_mstr.SERVICE_MASTER_ID
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		(72,73)
		WHERE a.BUDGET_ID = #{parentBudgetId}
		AND a.SUB_BUDGET_ID =#{parentSubBudgetId}
    	GROUP BY c.COST_CENTER_SERVICE_MAPPING_ID, a.FY_BUDGET_INCOME,
   		a.parent_id, srv_mstr.service_name,a.REMAINING_UNITS,a.FY_BUDGET_UNITS
  
  		union all
  
  		SELECT srv_mstr.service_name,
     	a.REMAINING_UNITS, 
     	a.FY_BUDGET_UNITS as mod_units,
		0 AS	APPROVED_FY_BUDGET ,
		0 AS remaining_amount,
		a.FY_BUDGET_INCOME AS mod_amount,
		a.parent_id
		FROM 	BC_SERVICES_DETAILS a
    	inner join budget_services_configuration b
    	on a.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
		inner join cost_center_services_mapping c
    	on b.COST_CENTER_SERVICE_MAPPING_ID = c.COST_CENTER_SERVICE_MAPPING_ID
    	inner join services_master srv_mstr
    	on c.SERVICE_MASTER_ID = srv_mstr.SERVICE_MASTER_ID
		WHERE a.BUDGET_ID =#{contractBudgetID}
		AND a.SUB_BUDGET_ID =#{subBudgetID}
    	GROUP BY a.FY_BUDGET_INCOME,
    	a.parent_id,srv_mstr.service_name,a.REMAINING_UNITS,a.FY_BUDGET_UNITS
    	)
		GROUP BY COST_CENTER_SERVICE_MAPPING_ID,
		parent_id,service_name
		ORDER BY
		parent_id
	</select>
	
	 <select id="fetchContractServicesModificationDetailsBase" parameterType="com.nyc.hhs.model.CBGridBean" 
   		resultMap="ContractServicesModificationList">
		SELECT SERVICE_NAME,
		SUM(approved_units) AS APPROVED_UNITS,
    	SUM(REMAINING_UNITS) AS REMAINING_UNITS,
    	SUM(mod_units) AS MODIFICATION_UNITS,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_INCOME,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,COST_CENTER_SERVICE_MAPPING_ID as cost_center,
		parent_id AS SERVICES_ID
		FROM
		( SELECT srv_mstr.service_name,
		a.FY_BUDGET_UNITS as approved_units, 
     	a.REMAINING_UNITS,
     	0 as mod_units, 
		a.FY_BUDGET_INCOME AS APPROVED_FY_BUDGET, 
 		(a.FY_BUDGET_INCOME -
   		SUM(
	 	CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ))
    	AS remaining_amount,
		0 AS mod_amount,c.COST_CENTER_SERVICE_MAPPING_ID,
		a.parent_id
		FROM BC_SERVICES_DETAILS a
		LEFT JOIN INVOICE_SERVICES_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join budget_services_configuration b
    	on a.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
		inner join cost_center_services_mapping c
    	on b.COST_CENTER_SERVICE_MAPPING_ID = c.COST_CENTER_SERVICE_MAPPING_ID
    	inner join services_master srv_mstr
    	on c.SERVICE_MASTER_ID = srv_mstr.SERVICE_MASTER_ID
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		(72,73)
		WHERE a.BUDGET_ID = #{parentBudgetId}
		AND a.SUB_BUDGET_ID =#{parentSubBudgetId}
    	GROUP BY c.COST_CENTER_SERVICE_MAPPING_ID, a.FY_BUDGET_INCOME,
   		a.parent_id, srv_mstr.service_name,a.REMAINING_UNITS,a.FY_BUDGET_UNITS
    	)
		GROUP BY COST_CENTER_SERVICE_MAPPING_ID,
		parent_id,service_name
		ORDER BY
		parent_id
	</select>
	
	 <select id="fetchContractServicesModificationDetailsMod" parameterType="com.nyc.hhs.model.CBGridBean" 
   		resultMap="ContractServicesModificationList">
		SELECT SERVICE_NAME,
		SUM(approved_units) AS APPROVED_UNITS,
    	SUM(REMAINING_UNITS) AS REMAINING_UNITS,
    	SUM(mod_units) AS MODIFICATION_UNITS,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_INCOME,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,COST_CENTER_SERVICE_MAPPING_ID as cost_center,
		parent_id AS SERVICES_ID
		FROM
		(   
  		SELECT srv_mstr.service_name,
  		0 AS	approved_units,
     	a.REMAINING_UNITS, 
     	a.FY_BUDGET_UNITS as mod_units,
		0 AS	APPROVED_FY_BUDGET ,
		0 AS remaining_amount,
		a.FY_BUDGET_INCOME AS mod_amount,c.COST_CENTER_SERVICE_MAPPING_ID,
		a.parent_id
		FROM 	BC_SERVICES_DETAILS a
    	inner join budget_services_configuration b
    	on a.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
		inner join cost_center_services_mapping c
    	on b.COST_CENTER_SERVICE_MAPPING_ID = c.COST_CENTER_SERVICE_MAPPING_ID
    	inner join services_master srv_mstr
    	on c.SERVICE_MASTER_ID = srv_mstr.SERVICE_MASTER_ID
		WHERE a.BUDGET_ID =#{contractBudgetID}
		AND a.SUB_BUDGET_ID =#{subBudgetID}
    	GROUP BY c.COST_CENTER_SERVICE_MAPPING_ID,a.FY_BUDGET_INCOME,
    	a.parent_id,srv_mstr.service_name,a.REMAINING_UNITS,a.FY_BUDGET_UNITS
    	)
		GROUP BY COST_CENTER_SERVICE_MAPPING_ID,
		parent_id,service_name
		ORDER BY
		parent_id
	</select>
	<resultMap id="CostCenterModificationList" type="com.nyc.hhs.model.CBServicesBean">
		<result property="id" column="COST_CENTER_ID" />
		<result property="costCenterName" column="COST_CENTER_NAME" />
		<result property="fyBudget" column="APPROVED_FY_BUDGET" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="modificationAmt" column="MODIFIED_AMOUNT" />
		<result property="costCenter" column="cost_center" />
	</resultMap>
	
	<select id="fetchContractCostCenterModificationDetails" parameterType="com.nyc.hhs.model.CBGridBean" 
   			resultMap="CostCenterModificationList">
   		SELECT COST_CENTER_NAME,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_BUDGET,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,cost_center_id as cost_center,
		parent_id AS COST_CENTER_ID
		FROM
		(
    	SELECT cost_mstr.COST_CENTER_NAME, 
 		a.FY_BUDGET_AMOUNT AS APPROVED_FY_BUDGET, 
 		(a.FY_BUDGET_AMOUNT -
    	SUM(
	  	CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ))
    	AS remaining_amount,
		0 AS mod_amount,a.cost_center_id ,
		a.parent_id
		FROM cost_center_details a
		LEFT JOIN INVOICE_COST_CENTER_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join cost_center_master cost_mstr
    	on a.COST_CENTER_ID = cost_mstr.COST_CENTER_MASTER_ID
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		(72,73)
		WHERE a.BUDGET_ID = #{parentBudgetId}
		AND a.SUB_BUDGET_ID =#{parentSubBudgetId}
    	GROUP BY a.cost_center_id, a.FY_BUDGET_AMOUNT,
    	a.parent_id, cost_mstr.COST_CENTER_NAME
  
  		union all
  
  		SELECT cost_mstr.COST_CENTER_NAME, 
		0 AS	APPROVED_FY_BUDGET ,
		0 AS remaining_amount,
		a.FY_BUDGET_AMOUNT AS mod_amount,a.cost_center_id ,
		a.parent_id
		FROM cost_center_details a
		LEFT JOIN INVOICE_COST_CENTER_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join cost_center_master cost_mstr
    	on a.COST_CENTER_ID = cost_mstr.COST_CENTER_MASTER_ID
		WHERE a.BUDGET_ID =#{contractBudgetID}
		AND a.SUB_BUDGET_ID =#{subBudgetID}
    	GROUP BY a.cost_center_id ,a.FY_BUDGET_AMOUNT,
    	a.parent_id, cost_mstr.COST_CENTER_NAME
    	)
		GROUP BY cost_center_id ,
		parent_id,COST_CENTER_NAME
		ORDER BY
		parent_id
   	</select>
   	
   	<select id="fetchContractCostCenterModificationDetailsMod" parameterType="com.nyc.hhs.model.CBGridBean" 
   			resultMap="CostCenterModificationList">
   		SELECT COST_CENTER_NAME,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_BUDGET,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,cost_center_id as cost_center,
		parent_id AS COST_CENTER_ID
		FROM
		(
  		SELECT cost_mstr.COST_CENTER_NAME, 
		0 AS	APPROVED_FY_BUDGET ,
		0 AS remaining_amount,
		a.FY_BUDGET_AMOUNT AS mod_amount,a.cost_center_id ,
		a.parent_id
		FROM cost_center_details a
		LEFT JOIN INVOICE_COST_CENTER_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join cost_center_master cost_mstr
    	on a.COST_CENTER_ID = cost_mstr.COST_CENTER_MASTER_ID
		WHERE a.BUDGET_ID =#{contractBudgetID}
		AND a.SUB_BUDGET_ID =#{subBudgetID}
    	GROUP BY a.cost_center_id ,a.FY_BUDGET_AMOUNT,
    	a.parent_id, cost_mstr.COST_CENTER_NAME
    	)
		GROUP BY cost_center_id ,
		parent_id,COST_CENTER_NAME
		ORDER BY
		parent_id
   	</select>
   	
   	<select id="fetchContractCostCenterModificationDetailsBase" parameterType="com.nyc.hhs.model.CBGridBean" 
   			resultMap="CostCenterModificationList">
   		SELECT COST_CENTER_NAME,
		SUM(APPROVED_FY_BUDGET) AS APPROVED_FY_BUDGET,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,cost_center_id as cost_center,
		parent_id AS COST_CENTER_ID
		FROM
		(
    	SELECT cost_mstr.COST_CENTER_NAME, 
 		a.FY_BUDGET_AMOUNT AS APPROVED_FY_BUDGET, 
 		(a.FY_BUDGET_AMOUNT -
    	SUM(
	  	CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ))
    	AS remaining_amount,
		0 AS mod_amount,a.cost_center_id ,
		a.parent_id
		FROM cost_center_details a
		LEFT JOIN INVOICE_COST_CENTER_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.parent_id
    	inner join cost_center_master cost_mstr
    	on a.COST_CENTER_ID = cost_mstr.COST_CENTER_MASTER_ID
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		(72,73)
		WHERE a.BUDGET_ID = #{parentBudgetId}
		AND a.SUB_BUDGET_ID =#{parentSubBudgetId}
    	GROUP BY a.cost_center_id, a.FY_BUDGET_AMOUNT,
    	a.parent_id, cost_mstr.COST_CENTER_NAME
    	)
		GROUP BY cost_center_id ,
		parent_id,COST_CENTER_NAME
		ORDER BY
		parent_id
   	</select>
   	
   	<select id="fetchContractServicesDetailsForValidation" parameterType="String"
		resultMap="ContractServicesModificationList">
		SELECT SUM(fy_amount) - SUM(inv_amt)   AS REMAINING_AMOUNT ,
		  SUM(fy_units)       - SUM(inv_units) AS REMAINING_UNITS
		FROM
		  (SELECT FY_BUDGET_INCOME AS fy_amount,
		    0                      AS inv_amt ,
		    FY_BUDGET_UNITS        AS fy_units ,
		    0                      AS inv_units
		  FROM BC_SERVICES_DETAILS
		  WHERE BC_SERVICES_DETAIL_ID = #{asId}
		  UNION ALL
		  SELECT 0                     AS fy_amount,
		    NVL(SUM(INVOICE_AMOUNT),0) AS inv_amt ,
		    0                          AS fy_units ,
		    NVL(SUM(INVOICE_UNITS),0) inv_units
		  FROM BC_SERVICES_DETAILS serv_det
		  LEFT JOIN INVOICE_SERVICES_DETAILS inv_det
		  ON inv_det.LINE_ITEM_ID = serv_det.parent_id
		  LEFT JOIN INVOICE inv
		  ON inv.INVOICE_ID                    = inv_det.INVOICE_ID	
		  WHERE serv_det.BC_SERVICES_DETAIL_ID = #{asId}
		  AND inv.STATUS_ID                   IN ('72','73')
		  )
	</select>
	
	<update id="updateContractServicesModifyDetails" parameterType="com.nyc.hhs.model.CBServicesBean">
		update
		BC_SERVICES_DETAILS
		set
		FY_BUDGET_INCOME = #{modificationAmt},
		FY_BUDGET_UNITS = #{modUnits},
		MODIFIED_DATE =
		SYSTIMESTAMP,
		<!-- MODIFIED_BY_USERID =
		#{modifyByAgency}, -->
		MODIFIED_BY_STAFFID =
		#{modifyByProvider}
		where
		PARENT_ID = #{id}
		AND
		BUDGET_ID = #{contractBudgetID}
		AND
		SUB_BUDGET_ID = #{subBudgetID}
	</update>
	
	<insert id="insertContractServicesModifyDetails" parameterType="com.nyc.hhs.model.CBServicesBean">
		insert 
		into BC_SERVICES_DETAILS 
		(BC_SERVICES_DETAIL_ID,
		BUDGET_SERVICES_CONFIG_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_INCOME,
		YTD_INVOICE_INCOME,
		CREATED_DATE,
		<!--  CREATED_BY_USERID, --> 
		MODIFIED_DATE,
		<!--  MODIFIED_BY_USERID,  -->
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PARENT_ID,
		REPORTING_MODIFIED_DATE,
		FY_BUDGET_UNITS,
		REMAINING_AMOUNT,
		REMAINING_UNITS,
		YTD_INVOICED_UNITS) 
		VALUES(
		SEQ_SERVICES_DETAIL.NEXTVAL,
		(select BUDGET_SERVICES_CONFIG_ID from BC_SERVICES_DETAILS where BC_SERVICES_DETAIL_ID = #{id}),
		#{contractBudgetID} ,
		#{subBudgetID} ,
		#{modificationAmt},
		0,
		SYSTIMESTAMP,
		<!-- #{createdByUserId}, --> 
		SYSTIMESTAMP,
		<!-- #{modifiedByUserId}, -->
		#{modifyByProvider},
		#{modifyByProvider},
		'1',
		#{id},
		SYSTIMESTAMP,
		#{modUnits},
		0,
		0,
		0
		)
	</insert>
	
	<select id="fetchContractCostCenterDetailsForValidation" parameterType="String"
		resultMap="CostCenterModificationList">
		SELECT SUM(fy_amount) - SUM(inv_amt) AS REMAINING_AMOUNT
		FROM
		  (SELECT fy_budget_amount AS fy_amount,
		    0                      AS inv_amt
		  FROM cost_center_details
		  WHERE COST_CENTER_DETAILS_ID = #{asId}
		  UNION ALL
		  SELECT 0                                AS fy_amount,
		    (NVL(SUM(inv_det.INVOICE_AMOUNT),0) ) AS fy_amount
		  FROM cost_center_details cost_det
		  LEFT JOIN invoice_cost_center_details inv_det
		  ON inv_det.LINE_ITEM_ID = cost_det.parent_id
		  LEFT JOIN INVOICE inv
		  ON inv.INVOICE_ID                     = inv_det.INVOICE_ID		 
		  WHERE cost_det.COST_CENTER_DETAILS_ID = #{asId}
		  AND inv.STATUS_ID                    IN ('72','73')
		  )
	</select>
	
	<insert id="insertContractCostCenterModifyDetails" parameterType="com.nyc.hhs.model.CBServicesBean">
		insert 
		into COST_CENTER_DETAILS 
		(COST_CENTER_DETAILS_ID,
		COST_CENTER_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_AMOUNT,
		YTD_INVOICED_AMOUNT,
		REMAINING_AMOUNT,
		CREATED_DATE,
		MODIFIED_DATE,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		REPORTING_MODIFIED_DATE,
		PARENT_ID) 
		VALUES(
		SEQ_COST_CENTER_DETAILS.NEXTVAL,
		(Select cost_center_id from cost_center_details where COST_CENTER_DETAILS_ID=#{id}),
		#{contractBudgetID} ,
		#{subBudgetID} ,
		#{modificationAmt},
		0,
		0,
		SYSTIMESTAMP,
		SYSTIMESTAMP,
		#{modifyByProvider},
		#{modifyByProvider},
		'1',
		SYSTIMESTAMP,
		#{id}
		)
	</insert>
	
	<update id="updateContractCostCentersModifyDetails" parameterType="com.nyc.hhs.model.CBServicesBean">
		update
		COST_CENTER_DETAILS
		set
		FY_BUDGET_AMOUNT = #{modificationAmt},
		MODIFIED_DATE =
		SYSTIMESTAMP,
		<!-- MODIFIED_BY_USERID =
		#{modifyByAgency}, -->
		MODIFIED_BY_STAFFID =
		#{modifyByProvider}
		where
		PARENT_ID = #{id}
		AND
		BUDGET_ID = #{contractBudgetID}
		AND
		SUB_BUDGET_ID = #{subBudgetID}
	</update>
	
    <select id="fetchServicesModAmountTotal" parameterType="hashmap" resultType="java.math.BigDecimal">
    	SELECT
		NVL(sum(a.FY_BUDGET_INCOME),0)
		FROM BC_SERVICES_DETAILS a
		WHERE a.BUDGET_ID =#{budgetId}
		AND a.SUB_BUDGET_ID =#{subBudgetId}
    </select>
    
    <select id="fetchCostCenterModAmountTotal" parameterType="hashmap" resultType="java.math.BigDecimal">
    	select sum(SUB_BUDGET_AMOUNT)
    	<if test="budgetTypeId == 4">
		-sum(FY_BUDGET_AMOUNT) 
		</if>
		from (
		SELECT 0 as SUB_BUDGET_AMOUNT,
		NVL(sum(a.FY_BUDGET_AMOUNT),0) as FY_BUDGET_AMOUNT
		FROM cost_center_details a
		WHERE 
    	a.BUDGET_ID =#{budgetId} AND
		a.SUB_BUDGET_ID  =#{subBudgetId}
    	<if test="budgetTypeId == 4">
 		union   
		select sub_budget_amount as SUB_BUDGET_AMOUNT , 0 as FY_BUDGET_AMOUNT from sub_budget where BUDGET_ID =#{budgetId} 
		AND 
		SUB_BUDGET_ID =#{subBudgetId}
		</if>
		)
    </select>
    
    <select id="fetchPIModificationAmount" parameterType="hashmap" resultType="java.math.BigDecimal">
    	SELECT
    	NVL(sum(Amount),0) from program_income
    	where budget_id=#{budgetId}
    	and
    	SUB_BUDGET_ID=#{subBudgetId}
    </select>
    
    <insert id="mergeServicesReplica" parameterType="java.util.Map">
    	Merge INTO BC_SERVICES_DETAILS A USING
		(SELECT B.BC_SERVICES_DETAIL_ID AS Id,
		  B.FY_BUDGET_INCOME             AS originalamount,
		  B.FY_BUDGET_UNITS              AS originalunits,
		  C.FY_BUDGET_INCOME             AS modamount,
		  C.FY_BUDGET_UNITS              AS modunits
		FROM BC_SERVICES_DETAILS B,
		BC_SERVICES_DETAILS C
		WHERE B.BC_SERVICES_DETAIL_ID  = C.Parent_Id
		AND B.Budget_Id        != C.Budget_Id
		AND B.Sub_Budget_Id    != C.Sub_Budget_Id
		AND C.BUDGET_ID         = #{budgetId}
		AND C.Active_Flag       = '1'
		) N ON ( A.BC_SERVICES_DETAIL_ID = N.Id)
		WHEN matched THEN
		UPDATE
		SET FY_BUDGET_INCOME = N.originalamount + N.modamount,
		FY_BUDGET_UNITS    = N.originalunits  + N.modunits,
   		MODIFIED_DATE=systimestamp,
    	MODIFIED_BY_USERID = #{modifyBy}
    </insert>
    
    <insert id="mergeCostCenterReplica" parameterType="java.util.Map">
    	Merge INTO cost_center_details A USING
		(SELECT B.COST_CENTER_DETAILS_ID AS Id,
		  B.FY_BUDGET_AMOUNT             AS originalamount,
		  C.FY_BUDGET_AMOUNT             AS modamount
		FROM cost_center_details B,
		  cost_center_details C
		WHERE B.COST_CENTER_DETAILS_ID  = C.Parent_Id
		AND B.Budget_Id        != C.Budget_Id
		AND B.Sub_Budget_Id    != C.Sub_Budget_Id
		AND C.BUDGET_ID         = #{budgetId}
		AND C.Active_Flag       = '1'
		) N ON ( A.COST_CENTER_DETAILS_ID = N.Id)
		WHEN matched THEN
		UPDATE
		SET FY_BUDGET_AMOUNT = N.originalamount + N.modamount,
    	MODIFIED_DATE=systimestamp,
    	MODIFIED_BY_USERID = #{modifyBy}
    </insert>
    
    <insert id="createServicesReplica" parameterType="java.util.Map">
    	INSERT INTO BC_SERVICES_DETAILS
  		(BC_SERVICES_DETAIL_ID,
  		BUDGET_SERVICES_CONFIG_ID,
  		BUDGET_ID,
  		SUB_BUDGET_ID,
  		FY_BUDGET_INCOME,
  		YTD_INVOICE_INCOME,
  		CREATED_DATE,
    	CREATED_BY_USERID,
    	MODIFIED_DATE,
    	MODIFIED_BY_USERID,
    	CREATED_BY_STAFFID,
    	MODIFIED_BY_STAFFID,
    	ACTIVE_FLAG,
    	PARENT_ID,
    	REPORTING_MODIFIED_DATE,
    	FY_BUDGET_UNITS,
    	REMAINING_AMOUNT,
    	REMAINING_UNITS,
    	YTD_INVOICED_UNITS ) 
   		(SELECT SEQ_SERVICES_DETAIL.nextval, BUDGET_SERVICES_CONFIG_ID,#{parentBudgetId},#{subBudgetId},FY_BUDGET_INCOME, 
  		YTD_INVOICE_INCOME, CREATED_DATE, CREATED_BY_USERID,systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID,CREATED_BY_STAFFID, MODIFIED_BY_STAFFID,
  		ACTIVE_FLAG, SEQ_SERVICES_DETAIL.currval,REPORTING_MODIFIED_DATE,FY_BUDGET_UNITS, REMAINING_AMOUNT,REMAINING_UNITS,YTD_INVOICED_UNITS
  		FROM BC_SERVICES_DETAILS WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  
  		and BC_SERVICES_DETAIL_ID=PARENT_ID AND BUDGET_SERVICES_CONFIG_ID IN
  		(
  		select BUDGET_SERVICES_CONFIG_ID from budget_services_configuration where cost_center_service_mapping_id in
  		(SELECT b.cost_center_service_mapping_id
  		FROM BC_SERVICES_DETAILS amend
  		INNER JOIN budget_services_configuration b
  		ON amend.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
  		INNER JOIN cost_center_services_mapping c
  		ON b.cost_center_service_mapping_id = c.cost_center_service_mapping_id
 		WHERE sub_budget_id =
    	(SELECT sub_budget_id
    	FROM sub_budget 
    	WHERE parent_id = #{subBudgetId}
    	AND budget_id   = #{budgetId}
    	)
  		AND amend.BC_SERVICES_DETAIL_ID=amend.PARENT_ID
  		MINUS
  		SELECT b.cost_center_service_mapping_id
  		FROM BC_SERVICES_DETAILS base
  		INNER JOIN budget_services_configuration b
  		ON base.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
  		INNER JOIN cost_center_services_mapping c
  		ON b.cost_center_service_mapping_id = c.cost_center_service_mapping_id
  		WHERE sub_budget_id = #{subBudgetId}
  		AND base.BC_SERVICES_DETAIL_ID = base.PARENT_ID
  		) and budget_id = #{budgetId}
  		)
  		)
   </insert>
   
   <insert id="createCostCenterReplica" parameterType="java.util.Map">
   		INSERT INTO cost_center_details
  		(COST_CENTER_DETAILS_ID,
  		COST_CENTER_ID,
  		BUDGET_ID,
  		SUB_BUDGET_ID,
  		FY_BUDGET_AMOUNT,
  		YTD_INVOICED_AMOUNT,
 		REMAINING_AMOUNT,
 		CREATED_DATE,
    	CREATED_BY_USERID,
    	MODIFIED_DATE,
    	MODIFIED_BY_USERID,
    	CREATED_BY_STAFFID,
    	MODIFIED_BY_STAFFID,
    	ACTIVE_FLAG,
    	REPORTING_MODIFIED_DATE,
    	PARENT_ID) 
   		(SELECT SEQ_COST_CENTER_DETAILS.nextval, COST_CENTER_ID,#{parentBudgetId},#{subBudgetId},FY_BUDGET_AMOUNT, 
 		YTD_INVOICED_AMOUNT,REMAINING_AMOUNT, CREATED_DATE, CREATED_BY_USERID,systimestamp  MODIFIED_DATE,#{modifyBy}  MODIFIED_BY_USERID, CREATED_BY_STAFFID, MODIFIED_BY_STAFFID,
  		ACTIVE_FLAG, REPORTING_MODIFIED_DATE,SEQ_COST_CENTER_DETAILS.currval
  		FROM cost_center_details WHERE SUB_BUDGET_ID = (select sub_budget_id from sub_budget where parent_id = #{subBudgetId} and budget_id = #{budgetId})  
  		and COST_CENTER_DETAILS_ID=PARENT_ID and COST_CENTER_ID in
  		(SELECT amend.COST_CENTER_ID
		FROM cost_center_details amend
		WHERE sub_budget_id =
  		(SELECT sub_budget_id
  		FROM sub_budget
 		WHERE parent_id = #{subBudgetId}
  		AND budget_id   = #{budgetId}
  		)
		AND amend.COST_CENTER_DETAILS_ID=amend.PARENT_ID
		MINUS
		SELECT base.COST_CENTER_ID
		FROM cost_center_details base
		WHERE sub_budget_id    =#{subBudgetId}
		AND base.COST_CENTER_DETAILS_ID=base.PARENT_ID
  		)
  		)
   </insert>
   
   <update id="markServiceAsDeleted" parameterType="java.util.Map">
		UPDATE BC_SERVICES_DETAILS SET ACTIVE_FLAG ='0',MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<update id="markCostCenterAsDeleted" parameterType="java.util.Map">
		UPDATE cost_center_details SET ACTIVE_FLAG ='0',MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE BUDGET_ID = #{budgetId}
	</update>
	
	<update id="linkServicesToBase" parameterType="java.util.Map">
		UPDATE BC_SERVICES_DETAILS
		SET BUDGET_ID = #{parentBudgetId},
		SUB_BUDGET_ID=#{newSubBudgetId},
		MODIFIED_DATE=systimestamp,
		MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	
	<update id="linkCostCenterToBase" parameterType="java.util.Map">
		UPDATE cost_center_details
		SET BUDGET_ID = #{parentBudgetId},
		SUB_BUDGET_ID=#{newSubBudgetId},
		MODIFIED_DATE=systimestamp,
		MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	
	<insert id="mergeServicesForAmendment" parameterType="java.util.Map">
		Merge INTO BC_SERVICES_DETAILS A USING
		(SELECT BUDGET_SERVICES_CONFIG_ID,
 		FY_BUDGET_INCOME,
 		YTD_INVOICE_INCOME,
 		FY_BUDGET_UNITS,
 		REMAINING_AMOUNT,
 		REMAINING_UNITS,
 		YTD_INVOICED_UNITS
		FROM BC_SERVICES_DETAILS
		WHERE SUB_BUDGET_ID            =#{subBudgetId}
		AND BC_SERVICES_DETAIL_ID =PARENT_ID
		AND BUDGET_SERVICES_CONFIG_ID IN
  		(select BUDGET_SERVICES_CONFIG_ID from budget_services_configuration where cost_center_service_mapping_id in
  		(SELECT b.cost_center_service_mapping_id
  		FROM BC_SERVICES_DETAILS amend
  		INNER JOIN budget_services_configuration b
  		ON amend.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
  		INNER JOIN cost_center_services_mapping c
  		ON b.cost_center_service_mapping_id = c.cost_center_service_mapping_id
 		WHERE sub_budget_id =
    	(SELECT sub_budget_id
    	FROM sub_budget 
    	WHERE parent_id = #{subBudgetId}
    	AND budget_id   = #{budgetId}
    	)
  		AND amend.BC_SERVICES_DETAIL_ID=amend.PARENT_ID
  		MINUS
  		SELECT b.cost_center_service_mapping_id
  		FROM BC_SERVICES_DETAILS base
  		INNER JOIN budget_services_configuration b
  		ON base.BUDGET_SERVICES_CONFIG_ID=b.BUDGET_SERVICES_CONFIG_ID
  		INNER JOIN cost_center_services_mapping c
  		ON b.cost_center_service_mapping_id = c.cost_center_service_mapping_id
  		WHERE sub_budget_id = #{subBudgetId}
  		AND base.BC_SERVICES_DETAIL_ID = base.PARENT_ID
  		) and budget_id = #{budgetId}
  		)
		)N ON (A.BUDGET_SERVICES_CONFIG_ID = N.BUDGET_SERVICES_CONFIG_ID AND a.sub_budget_id=#{subBudgetId})
		WHEN matched THEN
  		UPDATE
  		SET a.FY_BUDGET_INCOME = N.FY_BUDGET_INCOME + a.FY_BUDGET_INCOME,
    	a.FY_BUDGET_UNITS    = N.FY_BUDGET_UNITS  + a.FY_BUDGET_UNITS
    </insert>
    
    <insert id="mergeCostCenterForAmendment" parameterType="java.util.Map">
		Merge INTO cost_center_details A USING
		(SELECT COST_CENTER_ID,
  		FY_BUDGET_AMOUNT,
  		YTD_INVOICED_AMOUNT,
 		REMAINING_AMOUNT
		FROM cost_center_details
		WHERE SUB_BUDGET_ID =
  		(SELECT sub_budget_id
  		FROM sub_budget
  		WHERE parent_id =#{subBudgetId}
  		AND budget_id   = #{budgetId}
  		)
		AND COST_CENTER_ID IN
  		(SELECT amend.COST_CENTER_ID
  		FROM cost_center_details amend
  		WHERE sub_budget_id =
    	(SELECT sub_budget_id
    	FROM sub_budget
    	WHERE parent_id = #{subBudgetId}
    	AND budget_id   = #{budgetId}
    	)
  		AND amend.COST_CENTER_DETAILS_ID=amend.PARENT_ID
  		INTERSECT
  		SELECT base.COST_CENTER_ID
  		FROM cost_center_details base
  		WHERE sub_budget_id            =#{subBudgetId}
  		AND base.COST_CENTER_DETAILS_ID=base.PARENT_ID
  		)
		)N ON (A.COST_CENTER_ID = N.COST_CENTER_ID AND a.sub_budget_id=#{subBudgetId})
		WHEN matched THEN
  		UPDATE SET a.FY_BUDGET_AMOUNT = N.FY_BUDGET_AMOUNT + a.FY_BUDGET_AMOUNT
    </insert>
    
    <insert id="insertAmendmentServicesToBase" parameterType="java.util.Map">
    	INSERT
		INTO budget_services_configuration
 		(
   		BUDGET_SERVICES_CONFIG_ID,
    	BUDGET_ID,
    	COST_CENTER_SERVICE_MAPPING_ID,
    	CREATED_DATE,
    	CREATED_BY_USERID,
    	MODIFIED_DATE,
    	MODIFIED_BY_USERID,
    	ACTIVE_FLAG,
    	REPORTING_MODIFIED_DATE,
    	PARENT_ID
  		)
  		(SELECT SEQ_BUDGET_SERVICES_CONFIG.nextval,
      	(SELECT parent_id FROM budget WHERE budget_id = #{budgetId}
      	),
      	Master.Ids,
      	systimestamp,
      	#{userId},
      	systimestamp,
      	#{userId},
      	1,
      	systimestamp,
      	SEQ_BUDGET_SERVICES_CONFIG.currval
    	FROM
      	(SELECT COST_CENTER_SERVICE_MAPPING_ID AS Ids
      	FROM budget_services_configuration
      	WHERE active_flag='1' and budget_id                         = #{budgetId}
      	AND COST_CENTER_SERVICE_MAPPING_ID NOT IN
        (SELECT COST_CENTER_SERVICE_MAPPING_ID
        FROM budget_services_configuration
        WHERE active_flag='1' and budget_id =
          (SELECT parent_id FROM budget WHERE budget_id = #{budgetId}
          )
        )
      	) Master
  		)
   </insert>
   
    <update id="updateBaseFlagForAmendServices" parameterType="java.util.Map">
    	UPDATE BUDGET_SERVICES_CONFIGURATION
		SET ACTIVE_FLAG = '1'
		WHERE budget_id =
  		(SELECT parent_id FROM budget WHERE budget_id = #{budgetId})
		AND COST_CENTER_SERVICE_MAPPING_ID IN
  		(SELECT COST_CENTER_SERVICE_MAPPING_ID
  		FROM BUDGET_SERVICES_CONFIGURATION
  		WHERE budget_id = #{budgetId}
  		)
	</update>
	
   <!--End: Added in R7 for Cost Center-->
   <!-- Added in R7 for program income -->
  	<insert id="insertProgramIncomeModificationGrid" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		Insert into
		PROGRAM_INCOME
		(
		PROGRAM_INCOME_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PROGRAM_INCOME_TYPE_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		DESCRIPTION,
		ENTRY_TYPE_ID
		)
		values
		(
		SEQ_PROGRAM_INCOME_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{empPosition,jdbcType=VARCHAR},
		SEQ_PROGRAM_INCOME_ID.currval,
		#{modificationAmount},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		'1',
		#{description},
		#{entryTypeId}
		)
	</insert> 
	<select id="fetchPIForModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="programIncomeModificationList">

		Select PI.PROGRAM_INCOME_ID, PIT.PROGRAM_INCOME_TYPE,ENTRY_TYPE_ID,
		PI.AMOUNT,
		PI.Budget_Id,
		PI.Sub_Budget_Id, PI.Parent_Id
		FROM
		PROGRAM_INCOME PI INNER
		JOIN PROGRAM_INCOME_TYPE PIT
		ON
		PI.PROGRAM_INCOME_TYPE_ID= PIT.PROGRAM_INCOME_TYPE_ID
		WHERE
		PI.Budget_Id =#{contractBudgetID}
		And PI.Sub_Budget_Id =#{subBudgetID}
		AND PI.ACTIVE_FLAG = 1
		<!-- Entry type check added -->
		<if test="null!= entryTypeId">
		AND ENTRY_TYPE_ID = #{entryTypeId}
		</if>
		ORDER BY PI.CREATED_DATE ASC
	</select>
	<select id="fetchIsOldPI" parameterType="String" resultType="String">
		Select NVL(is_old_pi,1) from
		BUDGET
		where budget_id= #{lsParentBudgetId}
	</select>
	<!-- End: R7 changes for program income -->
	
	<!-- Start R7 for auto update -->
	<select id="fetchUpdateBudgetId" parameterType="hashmap" resultType="String">
		Select budget_id from
		BUDGET
		where contract_id= #{contractId}
		and budget_type_id='4'
		AND fiscal_year_id =#{fiscalYear} 
	</select>
	
	<!-- Start R7.0.1 Emengency for auto update in budget customization-->
	<select id="fetchCountForConfigurationChangeInUpdate" parameterType="hashmap" resultType="Integer">
			SELECT SUM(COUNT)
		FROM
		  (SELECT COUNT(*) AS COUNT
		  FROM BUDGET_CUSTOMIZATION
		  WHERE contract_id =#{contractId}
		  and BUDGET_ID =#{budgetId}
		  UNION ALL
		  SELECT COUNT(*) AS COUNT
		  FROM BUDGET_SERVICES_CONFIGURATION
		  WHERE budget_id =#{budgetId}
		  UNION ALL
		  SELECT COUNT(*) AS COUNT
		  FROM
		    (SELECT sub_budget_id,
		      parent_id
		    FROM SUB_BUDGET
		    WHERE BUDGET_ID =#{budgetId}
		    AND parent_id=sub_budget_id
		    )
		  UNION ALL
		  SELECT COUNT(*) AS COUNT
		  FROM
		    (SELECT sub_budget_id,
		      parent_id
		    FROM SUB_BUDGET
		    WHERE BUDGET_ID =#{budgetId}
		    AND parent_id !=sub_budget_id
		    AND sub_budget_amount !=0
		    )
		  )
	</select>
	<!-- End R7.0.1 Emengency for auto update in budget customization-->
	
	<!-- Start R7.0.1 Emergency for auto update -->
	<select id="getActiveFiscalYear" parameterType="String" resultType="String">
			SELECT DISTINCT(fiscal_year_id)
			FROM budget
			WHERE contract_id=#{updateContractId}
			AND active_flag ='1'
	</select>
	<!-- End R7 Emergency for auto update -->
	<select id="fetchCountForFiscalAmountChangeInUpdate" parameterType="String" resultType="Integer">
		SELECT SUM(NVL(amount,0))
		FROM contract_financials
		WHERE contract_id   = #{updateContractId}
		AND fiscal_year_id =#{fiscalYear}
		GROUP BY fiscal_year_id
		MINUS
		SELECT SUM(NVL(amount,0))
		FROM contract_financials
		WHERE contract_id=
		  (SELECT parent_contract_id FROM contract WHERE contract_id = #{updateContractId}
		  )
		AND fiscal_year_id =#{fiscalYear}
		GROUP BY fiscal_year_id
	</select>
	
	<select id="getUpdateBudgeAutoApproveFlag" resultType="string" parameterType="hashmap">
		SELECT IS_AUTO_APPROVED
  		FROM budget
  		WHERE budget_id=#{budgetId}
  		AND BUDGET_TYPE_ID ='4'
	</select>
	<!-- End R7 for auto update -->
	<!-- Start: Added in R7 to update site-details in newly added sub-budget: Defect 8916 -->
	<update id="linkSiteDetailsToBase" parameterType="java.util.Map">
		UPDATE sub_budget_site set
		SUB_BUDGET_ID=#{newSubBudgetId},
		MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
		WHERE SUB_BUDGET_ID = #{subBudgetId}
	</update>
	<!-- End: Added in R7 to update site-details in newly added sub-budget -->
		<!-- Added for R7 program income -->
	<select id="getRemainingAmountModificationPI" resultType="java.math.BigDecimal"
		parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		SELECT
		(
		CASE
		WHEN pi.SUB_BUDGET_ID =
		#{subBudgetID}
		THEN 0
		WHEN pi.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		THEN
		pi.AMOUNT
		END) - SUM(
		CASE
		WHEN INVVV.STATUS_ID
		IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END) AS REMAINING_AMT
		FROM PROGRAM_INCOME pi
		LEFT
		JOIN INVOICE_DETAILS inv
		ON pi.PROGRAM_INCOME_ID
		= inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 11
		LEFT JOIN INVOICE INVVV
		ON
		INVVV.INVOICE_ID =
		inv.INVOICE_ID
		AND INVVV.STATUS_ID IN (72,73)
		WHERE
		pi.parent_id = #{id}
		AND pi.active_flag = '1'
		AND pi.PROGRAM_INCOME_ID =
		pi.Parent_id
		GROUP BY
		pi.SUB_BUDGET_ID,
		pi.parent_id,
		pi.AMOUNT
	</select>
	
	<select id="fetchIsOldPIForValidation" parameterType="String" resultType="String">
		Select NVL(is_old_pi,1) from
		BUDGET
		where budget_id= (select budget_id from sub_budget where sub_budget_id= #{lsSubBudgetId})
	</select>
	<!-- R7 program income changes end -->
	<!-- Start: Modification Auto Approval changes -->
	<select id="fetchSubBudgetModificationAmt" parameterType="hashmap"
		resultMap="autoApprovalPercentage">
		SELECT
		to_char(NVL((sum(modification_amount)/2),0)) AS total_modification_amount
		FROM (
		SELECT abs(TOTAL_SALARY) AS modification_amount FROM
		personnel_service WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		fringe_benefit WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		operations_and_support WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		utilities WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		professional_service WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM rent
		WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		contracted_service WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM rate
		WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		milestone WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(INDIRECT_AMOUNT) AS modification_amount
		FROM indirect_rate WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		UNION ALL
		SELECT abs(amount) AS modification_amount FROM
		equipment WHERE
		SUB_BUDGET_ID  = #{subBudgetID}
		)
	</select>
	
	<!-- Start: Added for Defect QC 9151 R 7.3.2 -->
	
	 <select id="getAutoApproveFlag" resultType="string" parameterType="hashmap">
		select is_auto_approved from budget 
		where budget_id=#{budgetId}
	</select>
	<update id="resetBudgetAutoApprovalFlag" parameterType="java.util.Map">
		UPDATE budget SET is_auto_approved = null WHERE BUDGET_ID = #{budgetId}
	</update>
	<!-- End: Added for Defect QC 9151 R 7.3.2 -->
	
	<!-- Start: QC 9152 r 7.5.0 Accenture fix: Update Task (Auto-Approval) Never Finished -->
	<update id="markContractFinacialsAsInactive" parameterType="java.util.Map">
		UPDATE CONTRACT_FINANCIALS SET ACTIVE_FLAG ='0',MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
        WHERE CONTRACT_ID = #{contractId}
	</update>
	<!-- End: QC 9152 r 7.5.0 Accenture fix: Update Task (Auto-Approval) Never Finished -->
	
	<!-- Start QC 8394 R 7.9.0 add ability to Add/Delete multiple lines for Unallocated Funds -->
	<select id="fetchModificationUnallocatedFundsToBaseLine" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UnallocatedFundList">
  	select  UNALLOCATED_ID , 
      	    UNALLOCATED_FUND,
      		0.0 as "AMOUNT",
      		nvl(amount, 0) as "MODIFICATION_AMOUNT",
      		1 as "MODIFICATION_COUNT",
      		parent_id,
      		UNALLOCATED_ID as "CHILD_ID",
      		#{contractBudgetID} as "BUDGET_ID",
	      	#{subBudgetID} as "SUB_BUDGET_ID",
	      	#{parentBudgetId} as "PARENT_BUDGET_ID",
	      	#{parentSubBudgetId} as "PARENT_SUB_BUDGET_ID",
      		'mod' as "TYPE"
  		from unallocated 
       	where sub_budget_id = #{subBudgetID}
        	and budget_id = #{contractBudgetID} 
        	and UNALLOCATED_ID != parent_id
        	and ACTIVE_FLAG=1	
  </select>  
	
  	<insert id="addModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
	  			        	
			INSERT INTO UNALLOCATED(
				UNALLOCATED_ID,
				BUDGET_ID,
				SUB_BUDGET_ID,
				PARENT_ID,
				AMOUNT,
				CREATED_DATE,
				CREATED_BY_USERID,
				CREATED_BY_STAFFID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				MODIFIED_BY_STAFFID,
				ACTIVE_FLAG,
				UNALLOCATED_FUND)
			VALUES
			   (SEQ_UNALLOCATED_ID.NEXTVAL,
				#{contractBudgetID,jdbcType=VARCHAR},
				#{subBudgetID,jdbcType=VARCHAR},
				SEQ_UNALLOCATED_ID.CURRVAL,
				#{modificationAmount},
				current_timestamp,
				#{modifyByAgency,jdbcType=VARCHAR},
				#{modifyByProvider,jdbcType=VARCHAR},
				current_timestamp,
				#{modifyByAgency,jdbcType=VARCHAR},
				#{modifyByProvider,jdbcType=VARCHAR},
				'1',
				#{unallocatedFund,jdbcType=VARCHAR})
				
	</insert>
		
	<update id="deleteModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
			DELETE FROM UNALLOCATED 
				WHERE UNALLOCATED_ID = #{id}
       				 or ( PARENT_ID = #{id} and SUB_BUDGET_ID = #{subBudgetId})
       				 
	</update>
		
	<update id="updateModificationUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
		UPDATE UNALLOCATED 
		SET AMOUNT = #{modificationAmount}, 
			MODIFIED_DATE = current_timestamp,
			MODIFIED_BY_USERID = #{modifyByAgency,jdbcType=VARCHAR},
			MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR},
			UNALLOCATED_FUND = #{unallocatedFund,jdbcType=VARCHAR}
		WHERE
		    UNALLOCATED_ID = #{childId} 
		    and PARENT_ID = #{id}      
	</update>
	
	<insert id="insertNewUnallocatedFundsForModification" parameterType="com.nyc.hhs.model.UnallocatedFunds">
	  			        	
			INSERT INTO UNALLOCATED(
				UNALLOCATED_ID,
				BUDGET_ID,
				SUB_BUDGET_ID,
				PARENT_ID,
				AMOUNT,
				CREATED_DATE,
				CREATED_BY_USERID,
				CREATED_BY_STAFFID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				MODIFIED_BY_STAFFID,
				ACTIVE_FLAG,
				UNALLOCATED_FUND)
			VALUES
			   (SEQ_UNALLOCATED_ID.NEXTVAL,
				#{contractBudgetID,jdbcType=VARCHAR},
				#{subBudgetID,jdbcType=VARCHAR},
				#{id},
				#{modificationAmount},
				current_timestamp,
				#{modifyByAgency,jdbcType=VARCHAR},
				#{modifyByProvider,jdbcType=VARCHAR},
				current_timestamp,
				#{modifyByAgency,jdbcType=VARCHAR},
				#{modifyByProvider,jdbcType=VARCHAR},
				'1',
				#{unallocatedFund,jdbcType=VARCHAR})
				
	</insert>
	
	<select id="fetchModificationUnallocatedFundsBaseAmount" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UnallocatedFundList">
		select UNALLOCATED_ID,
		nvl((select (amount) from unallocated 	where sub_budget_id = #{parentSubBudgetId} 	and budget_id = #{parentBudgetId}),0) as "AMOUNT"
   		from unallocated where sub_budget_id = #{parentSubBudgetId} 
	</select>
	
	<select id="fetchUnallocatedFundsChildRecord" parameterType="com.nyc.hhs.model.UnallocatedFunds"
		resultMap="UnallocatedFundList">
  	select  UNALLOCATED_ID , 
      	    UNALLOCATED_FUND,
      		AMOUNT,
      		nvl(amount, 0) as "MODIFICATION_AMOUNT",
      		1 as "MODIFICATION_COUNT",
      		parent_id,
      		UNALLOCATED_ID as "CHILD_ID",
      		BUDGET_ID,
	      	SUB_BUDGET_ID,
	      	#{parentBudgetId} as "PARENT_BUDGET_ID",
	      	#{parentSubBudgetId} as "PARENT_SUB_BUDGET_ID",
      		'child' as "TYPE"
  		from unallocated 
       	where sub_budget_id = #{subBudgetID}
        	  and parent_id = #{id}
        	  and ACTIVE_FLAG=1	
  </select> 
  
   <select id="fetchUnallocatedFundsParentRecord" parameterType="com.nyc.hhs.model.UnallocatedFunds"
		resultMap="UnallocatedFundList">
  	select  UNALLOCATED_ID , 
      	    UNALLOCATED_FUND,
      		AMOUNT,
      		nvl(amount, 0) as "MODIFICATION_AMOUNT",
      		1 as "MODIFICATION_COUNT",
      		parent_id,
      		UNALLOCATED_ID as "CHILD_ID",
      		BUDGET_ID,
	      	SUB_BUDGET_ID,
	      	#{parentBudgetId} as "PARENT_BUDGET_ID",
	      	#{parentSubBudgetId} as "PARENT_SUB_BUDGET_ID",
      		'base' as "TYPE"
  		from unallocated 
       	where UNALLOCATED_ID = #{id}
        	  and ACTIVE_FLAG=1	
  </select> 
	<!-- End QC 8394 R 7.9.0 add ability to Add/Delete multiple lines for Unallocated Funds -->
	
</mapper>
