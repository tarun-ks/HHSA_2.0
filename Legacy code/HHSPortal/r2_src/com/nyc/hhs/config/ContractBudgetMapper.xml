<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.nyc.hhs.service.db.services.application.ContractBudgetMapper">

	<resultMap id="budgetSummaryMap" type="com.nyc.hhs.model.BudgetDetails">
		<result property="title" column="main_column" />
		<result property="approvedBudget" column="total" />
		<result property="ytdInvoicedAmount" column="invoiceAmount" />
		<result property="modificationAmount" column="modificationAmount" />
	</resultMap>
<!-- [Start] R7.3.0 QC8264 incorrect remaining amount -->
	<select id="fetchBudgetSummary" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="budgetSummaryMap">
		(select   sum(a.amount) as total,sum(invoiceAmount) as  invoiceAmount, 'otps'  main_column 
		   from   operations_and_support a 
		   left   join 	(select   distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                   from   invoice_details b , invoice c, operations_and_support d 
		                  where   c.invoice_id = b.invoice_id and c.status_id in (72,73) 
		                    and   b.entry_type_id ='2'
		                    and   d.sub_budget_id=b.sub_budget_id 
		                    and   b.line_item_id =  d.operations_support_id 
		                    and   c.budget_id=#{contractBudgetID}
		                   group by b.line_item_id
		                 ) b ON  b.line_item_id = a.operations_support_id
		   where   a.sub_budget_id=#{subBudgetID} and  a.budget_id=#{contractBudgetID})
		union all
		(select  sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'equipment' main_column 
		   from  equipment a 
		   left join (select  distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                from  invoice_details b , invoice c, equipment d 
		               where  c.invoice_id = b.invoice_id 
		                 and  c.status_id in (72,73) and b.entry_type_id ='12'
		                 and  d.sub_budget_id=b.sub_budget_id 
		                 and  b.line_item_id = d.equipment_id 
		                 and  c.budget_id=#{contractBudgetID}
                       group  by  b.line_item_id
                       ) b ON b.line_item_id = a.equipment_id
		where  a.sub_budget_id=#{subBudgetID} 
		  and  a.budget_id=#{contractBudgetID}
		)
		union all
		(select   sum(a.total_salary) as total, sum(invoiceAmount) as invoiceAmount, 'salary' main_column 
		   from   personnel_service a 
		   left   join (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                 from   invoice_details b , invoice c, personnel_service d 
		                where   c.invoice_id = b.invoice_id 
		                  and   c.status_id in (72,73)
		                  and   d.sub_budget_id=b.sub_budget_id 
		                  and   b.line_item_id = d.personnel_service_id 
		                  and   c.budget_id=#{contractBudgetID}
		                group   by  b.entry_type_id,  b.line_item_id
		               ) b ON b.line_item_id = a.personnel_service_id  and b.entry_type_id ='1' 
		  where   a.sub_budget_id=#{subBudgetID} 
		    and   a.budget_id=#{contractBudgetID})
		union all
		(select   sum(a.amount) as total, sum(invoiceAmount) as invoiceAmount, 'fringes' main_column 
		   from   fringe_benefit a 
		   left  join  (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                  from   invoice_details b ,  invoice c, fringe_benefit d 
		                 where   c.invoice_id = b.invoice_id 
		                   and   c.status_id in (72,73) 
		                   and   d.sub_budget_id = b.sub_budget_id 
						   and   b.line_item_id = d.FRINGE_BENEFIT_ID 
						   and   c.budget_id=#{contractBudgetID}
		                 group by  b.entry_type_id, b.line_item_id
		                ) b ON b.line_item_id = a.FRINGE_BENEFIT_ID and  b.entry_type_id ='13' 
		 where   a.sub_budget_id=#{subBudgetID} 
		   and   a.budget_id=#{contractBudgetID}
		)
		union all
		(select  sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount,'utilities'	main_column 
		   from  utilities a 
		   left join  (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                 from   invoice_details b , invoice c, utilities d 
		                where   c.invoice_id = b.invoice_id 
		                  and   c.status_id in (72,73)
		                  and   d.sub_budget_id=b.sub_budget_id
		                  and   b.line_item_id = d.utilities_id
		                  and   c.budget_id = #{contractBudgetID}
		                group by b.entry_type_id,  b.line_item_id
		               ) b ON b.line_item_id = a.utilities_id and b.entry_type_id = '3' 
		  where  a.sub_budget_id=#{subBudgetID} and a.budget_id=#{contractBudgetID}
		 )
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'professionalServices' main_column 
		   from   professional_service a 
		   left join (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                from   invoice_details b ,	invoice c, professional_service d 
		               where   c.invoice_id = b.invoice_id 
		                 and   c.status_id in (72,73) 
		                 and   d.sub_budget_id=b.sub_budget_id 
		                 and   b.line_item_id = d.professional_service_id 
		                 and   c.budget_id=#{contractBudgetID}
		               group   by  b.entry_type_id, b.line_item_id
		              ) b ON b.line_item_id = a.professional_service_id and b.entry_type_id ='4' 
		 where   a.sub_budget_id=#{subBudgetID} 
		   and   a.budget_id=#{contractBudgetID}
		)
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'rent' main_column 
		   from   rent a 
		   left join (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                from   invoice_details b , invoice c, rent d 
		               where   c.invoice_id = b.invoice_id 
		                 and   c.status_id in (72,73) 
		                 and   d.sub_budget_id=b.sub_budget_id
		                 and   b.line_item_id = d.rent_id 
		                 and   	c.budget_id=#{contractBudgetID}
		               group   by   b.entry_type_id, b.line_item_id
		              ) b ON b.line_item_id = a.rent_id and b.entry_type_id ='5' 
		 where   a.sub_budget_id=#{subBudgetID} 
		   and   a.budget_id=#{contractBudgetID}
		)
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'contractedServices' main_column 
		   from   contracted_service a 
		   left join ( select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                 from   invoice_details b , invoice c, contracted_service d 
		                where   c.invoice_id = b.invoice_id 
		                  and   c.status_id in (72,73) 
		                  and   d.sub_budget_id=b.sub_budget_id  
		                  and   b.line_item_id = d.contracted_service_id 
		                  and   c.budget_id=#{contractBudgetID}
		                group by  b.entry_type_id, b.line_item_id
		               ) b ON b.line_item_id = a.contracted_service_id and b.entry_type_id ='6' 
		  where   a.sub_budget_id=#{subBudgetID} 
		    and   a.budget_id=#{contractBudgetID}
		 )
		union all
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'totalRateBased' main_column 
		   from rate a left join (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                            from    invoice_details b ,	invoice c, rate d 
		                           where    c.invoice_id = b.invoice_id 
		                             and    c.status_id in (72,73) 
		                             and    d.sub_budget_id=b.sub_budget_id
		                             and    b.line_item_id = d.rate_id 
		                             and    c.budget_id=#{contractBudgetID}
		                           group by b.entry_type_id, b.line_item_id
		                          ) b ON b.line_item_id = a.rate_id and b.entry_type_id='7'
		where   a.sub_budget_id=#{subBudgetID} 
		  and   a.budget_id=#{contractBudgetID}
		)
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'totalMilestoneBased' main_column 
		   from   milestone a 
		   left join (select   distinct  b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                from   invoice_details b , invoice c, milestone d 
		               where   c.invoice_id = b.invoice_id 
		                 and   c.status_id in (72,73) 
		                 and   d.sub_budget_id=b.sub_budget_id
		                 and   b.line_item_id = d.milestone_id 
		                 and   c.budget_id=#{contractBudgetID}
		               group  by  b.entry_type_id, b.line_item_id
		              ) b ON b.line_item_id = a.milestone_id and b.entry_type_id ='8' 
		 where    a.sub_budget_id=#{subBudgetID} 
		   and    a.budget_id=#{contractBudgetID}
		 )
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'unallocatedFunds' main_column 
		   from   unallocated a 
		   left   join  (select   distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                  from   invoice_details b , invoice c, unallocated d 
		                 where   c.invoice_id   = b.invoice_id 
		                   and   c.status_id   in (72,73) 
		                   and   d.sub_budget_id  =  b.sub_budget_id
		                   and   b.line_item_id = d.unallocated_id
		                   and   c.budget_id  =  #{contractBudgetID}
		                 group  by   b.entry_type_id, b.line_item_id
		                ) b ON b.line_item_id = a.unallocated_id and b.entry_type_id ='9' 
		  where   a.sub_budget_id=#{subBudgetID} 
		    and   a.budget_id=#{contractBudgetID}
		 )
		union all
		(select   sum(a.indirect_amount) as total, sum(invoiceAmount) as invoiceAmount,'totalIndirectCost' main_column 
		   from   indirect_rate a 
		   left   join (select   distinct  b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                  from   invoice_details b , invoice c, indirect_rate d 
		                 where   c.invoice_id = b.invoice_id and c.status_id  in (72,73) 
		                   and   d.sub_budget_id=b.sub_budget_id 
							and b.line_item_id = d.indirect_rate_id
							and c.budget_id=#{contractBudgetID}
							group by b.entry_type_id,b.line_item_id
		               ) b ON b.line_item_id = a.indirect_rate_id and b.entry_type_id ='10' 
		 where     a.sub_budget_id=#{subBudgetID} 
		   and     a.budget_id=#{contractBudgetID}
		)
		union all
		(select   sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount,'totalProgramIncome' main_column 
		   from   program_income a  
		   left   join  (select   distinct  b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		                   from   invoice_details b , invoice c, program_income d 
		                  where   c.invoice_id = b.invoice_id 
		                    and   c.status_id in (72,73) 
		                    and   d.sub_budget_id=b.sub_budget_id
		                    and   b.line_item_id = d.program_income_id 
		                    and   c.budget_id=#{contractBudgetID}
		                  group  by  b.entry_type_id, b.line_item_id
		                 ) b ON b.line_item_id = a.program_income_id and b.entry_type_id ='11' 
		 where  a.sub_budget_id=#{subBudgetID} 
		   and  a.budget_id=#{contractBudgetID}
		)
	</select>
<!-- [End] R7.3.0 QC8264 incorrect remaining amount -->

	<select id="fetchCityFundedBudget" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="budgetSummaryMap">
	Select sum(total) as total, sum(invoiceAmount) as invoiceAmount from 
	(
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount,	'otps'	main_column 
		 from operations_and_support a 
		 left join
		 (select
			distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, operations_and_support d 
			where
			c.invoice_id = b.invoice_id 
			and c.status_id in (72,73) 
			and b.entry_type_id ='2'
			and d.sub_budget_id=b.sub_budget_id 
			and b.line_item_id = d.operations_support_id 
			and c.budget_id=#{contractBudgetID}
			group by b.line_item_id) b 
		ON b.line_item_id = a.operations_support_id
		where
			a.sub_budget_id=#{subBudgetID} and
			a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'equipment'	main_column 
		 from equipment a 
		 left join
		 (select 
		 	distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
		 	from invoice_details b, invoice c, equipment d 
		 	where
				c.invoice_id = b.invoice_id 
				and c.status_id in (72,73) 
				and b.entry_type_id	='12'
				and d.sub_budget_id=b.sub_budget_id 
				and b.line_item_id = d.equipment_id 
				and c.budget_id=#{contractBudgetID}
			group by b.line_item_id) b 
		ON b.line_item_id = a.equipment_id
		where
			a.sub_budget_id=#{subBudgetID} and
			a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.total_salary) as total, sum(invoiceAmount) as	invoiceAmount, 'salary'	main_column 
		 from personnel_service a 
		 left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, personnel_service d 
			where 
				c.invoice_id = b.invoice_id 
				and c.status_id in (72,73)
				and d.sub_budget_id=b.sub_budget_id 
				and b.line_item_id =d.personnel_service_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.personnel_service_id
			and b.entry_type_id ='1' 
			where a.sub_budget_id=#{subBudgetID} and
				a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.amount) as total, sum(invoiceAmount) as invoiceAmount, 'fringes' 	main_column 
		 from fringe_benefit a 
		 left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as 	invoiceAmount 
			from invoice_details b , invoice c, fringe_benefit d 
			where 
				c.invoice_id =b.invoice_id 
				and c.status_id in (72,73) 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.FRINGE_BENEFIT_ID 
				and c.budget_id=#{contractBudgetID}
		   group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.FRINGE_BENEFIT_ID and b.entry_type_id ='13' 
			where a.sub_budget_id=#{subBudgetID} 
				and a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount,'utilities' main_column 
		 from utilities a 
		 left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice	c, utilities d 
			where 
				c.invoice_id = b.invoice_id 
				<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				<!-- >and c.status_id != 74 -->
				and c.status_id in (72,73)
				<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.utilities_id
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id =	a.utilities_id 	and b.entry_type_id	='3' 
			where a.sub_budget_id=#{subBudgetID} 
				and a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.amount) as total, sum(invoiceAmount) as invoiceAmount, 'professionalServices' main_column 
		 from professional_service a 
		 left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, professional_service d
		 	where 
		 		c.invoice_id = b.invoice_id 
		 		and c.status_id in (72,73) 
		 		and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.professional_service_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.professional_service_id
			and b.entry_type_id ='4' 
			where a.sub_budget_id=#{subBudgetID} 
				and a.budget_id=#{contractBudgetID}
		)
		union
		(
		 select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'rent'	main_column
		 from rent a 
		 left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as 	invoiceAmount 
			from invoice_details b, invoice c, rent d 
			where
				c.invoice_id = b.invoice_id 
				and c.status_id in (72,73) 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.rent_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id,b.line_item_id) b 
		ON b.line_item_id = a.rent_id and b.entry_type_id='5' 
			where a.sub_budget_id=#{subBudgetID} and
			a.budget_id=#{contractBudgetID}
		)
		union
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'contractedServices' main_column 
		from contracted_service a 
		left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, contracted_service d
			where 
				c.invoice_id = b.invoice_id 
				and c.status_id in (72,73) 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.contracted_service_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id =	a.contracted_service_id
			and b.entry_type_id ='6' 
			where a.sub_budget_id=#{subBudgetID} and
					a.budget_id=#{contractBudgetID}
		)
		union
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'totalRateBased' main_column from rate a 
		left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, rate d 
			where 
				c.invoice_id = b.invoice_id 
				and c.status_id in (72,73) 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.rate_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.rate_id and b.entry_type_id='7'
			where a.sub_budget_id=#{subBudgetID} and
					a.budget_id=#{contractBudgetID}
		)
		union
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'totalMilestoneBased' main_column 
		from milestone a 
		left join 	
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as 	invoiceAmount 
			from invoice_details b, invoice c, milestone d 
			where
				c.invoice_id = b.invoice_id 
				<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				<!-- >and c.status_id != 74 -->
				and c.status_id in (72,73)
				<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.milestone_id 
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.milestone_id 	and b.entry_type_id	='8' 
			where a.sub_budget_id=#{subBudgetID} 
			and a.budget_id=#{contractBudgetID}
		)
		union
		(select sum(a.amount) as total,sum(invoiceAmount) as invoiceAmount, 'unallocatedFunds' main_column 
		from unallocated a 
		left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as 	invoiceAmount 
			from invoice_details b, invoice c, unallocated d 
			where
				c.invoice_id = b.invoice_id 
				<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				<!-- >and c.status_id != 74 -->
				and c.status_id in (72,73)
				<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
				and	d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.unallocated_id
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id =	a.unallocated_id
			and b.entry_type_id ='9' 
			where a.sub_budget_id=#{subBudgetID} and
				a.budget_id=#{contractBudgetID}
		)
		union
		(select sum(a.indirect_amount) as total,sum(invoiceAmount) as invoiceAmount,'totalIndirectCost' main_column 
		from indirect_rate a
		left join
			(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as invoiceAmount 
			from invoice_details b, invoice c, indirect_rate d 
			where
				c.invoice_id = b.invoice_id 
				and c.status_id	in (72,73) 
				and d.sub_budget_id=b.sub_budget_id
				and b.line_item_id = d.indirect_rate_id
				and c.budget_id=#{contractBudgetID}
			group by b.entry_type_id, b.line_item_id) b 
		ON b.line_item_id = a.indirect_rate_id
			and b.entry_type_id ='10' 
			where a.sub_budget_id=#{subBudgetID} and
				a.budget_id=#{contractBudgetID}
		)
		
	)
		</select>
	<!-- -->
	<!-- <resultMap id="budgetResultMap" type="com.nyc.hhs.model.BudgetDetails"> -->
	<!-- </resultMap> -->
	<!-- -->
	<!-- <select id="fetchModificationBudgetSummary" parameterType="java.lang.String" -->
	<!-- resultMap="budgetResultMap"> -->
	<!-- </select> -->
	<!-- -->
	<!-- <select id="fetchUpdateBudgetSummary" parameterType="java.lang.String" -->
	<!-- resultMap="budgetResultMap"> -->
	<!-- </select> -->
	<!-- -->
	<!-- <resultMap id="CoProgramIncomeList" type="com.nyc.hhs.model.CBProgramsIncomeBean"> -->
	<!-- </resultMap> -->
<!---->
	<!-- <select id="fetchProgramIncome" parameterType="Map" -->
	<!-- resultMap="CoProgramIncomeList"> -->
	<!-- </select> -->
<!---->
	<!-- <update id="updateProgramIncome" parameterType="CBProgramsIncomeBean"> -->
	<!-- </update> -->
<!---->
	<resultMap id="IndirectRateList" type="com.nyc.hhs.model.CBIndirectRateBean">
		<result property="id" column="INDIRECT_RATE_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="indirectAmount" column="INDIRECT_AMOUNT" />
		<result property="indirectRate" column="INDIRECT_RATE" />
		<result property="ytdInvoiceAmount" column="INVOICE_AMOUNT" />
	</resultMap>

	<resultMap id="IndirectRateListModification" type="com.nyc.hhs.model.CBIndirectRateBean">
		<result property="id" column="parent_id" />
		<result property="indirectAmount" column="INDIRECT_AMOUNT" />
		<result property="indirectModificationAmount" column="mod_amount" />
		<result property="indirectRemainingAmount" column="remaining_amount" />
	</resultMap>

	<update id="updateIndirectRate" parameterType="com.nyc.hhs.model.CBIndirectRateBean">
		update
		indirect_rate set indirect_amount =
		#{indirectAmount,jdbcType=VARCHAR},
		modified_date = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifyByAgency,jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		where
		indirect_rate_id = #{id,jdbcType=VARCHAR} 
	</update>

	<update id="updateIndirectRateModification" parameterType="com.nyc.hhs.model.CBIndirectRateBean">
		UPDATE indirect_rate
		SET indirect_amount =
		#{indirectModificationAmount,jdbcType=VARCHAR},
		MODIFIED_BY_USERID =
		#{modifyByAgency,jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider,jdbcType=VARCHAR},
		modified_date = SYSTIMESTAMP
		WHERE sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
	</update>

	<select id="getIndirectRateCount" parameterType="java.lang.String"
		resultType="int">
		select count(1) from indirect_rate where
		sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR}
	</select>

	<select id="getRemainingAmountIndirectRate" parameterType="com.nyc.hhs.model.CBIndirectRateBean"
		resultType="java.math.BigDecimal">
		SELECT a.INDIRECT_AMOUNT - SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) as REM_AMOUNT
		FROM
		INDIRECT_RATE a
		LEFT JOIN INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID = a.INDIRECT_RATE_ID
		AND inv_det.ENTRY_TYPE_ID =
		#{entryTypeId,jdbcType=VARCHAR}
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID
		= inv_det.INVOICE_ID
		AND inv.STATUS_ID in
		<foreach item="items" index="index" collection="invoiceStatusIdList"
			open="(" separator="," close=")">
			#{items}
    	</foreach>
		WHERE a.SUB_BUDGET_ID = #{parentSubBudgetId,jdbcType=VARCHAR}
		AND
		ACTIVE_FLAG = 1
		group by a.INDIRECT_AMOUNT
	</select>

	<select id="fetchIndirectRatePercentage" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="String">
		select INDIRECT_RATE from indirect_rate where
		sub_budget_id in
		(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
		and active_flag = 1 and rownum = 1
    </select>

	<select id="fecthPrevApprovedBudget" parameterType="com.nyc.hhs.model.CBIndirectRateBean"
		resultType="String">
		SELECT indirect_amount
		FROM indirect_rate
		WHERE
		indirect_rate_id =
		(SELECT parent_id FROM indirect_rate WHERE
		indirect_rate_id = #{id,jdbcType=VARCHAR}
		) 
    </select>


	<insert id="insertIndirectRate" parameterType="com.nyc.hhs.model.CBGridBean">
		INSERT
		INTO INDIRECT_RATE
		(
		INDIRECT_RATE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		INDIRECT_AMOUNT,
		INDIRECT_RATE,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID
		)
		VALUES
		(
		SEQ_INDIRECT_RATE_ID.nextval,
		#{contractBudgetID,jdbcType=VARCHAR,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR,jdbcType=VARCHAR},
		SEQ_INDIRECT_RATE_ID.currval,
		0,
		0,
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR}
		)
	</insert>

	<insert id="insertIndirectRateModification" parameterType="com.nyc.hhs.model.CBIndirectRateBean">
		INSERT
		INTO INDIRECT_RATE
		(
		INDIRECT_RATE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		INDIRECT_AMOUNT,
		INDIRECT_RATE,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET
		)
		VALUES
		(
		SEQ_INDIRECT_RATE_ID.nextval,
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		#{id,jdbcType=VARCHAR},
		#{indirectModificationAmount,jdbcType=VARCHAR},
		0,
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{prevApprovedAmount,jdbcType=VARCHAR}
		)
	</insert>

	<select id="fetchIndirectRate" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="IndirectRateList">
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		INDIRECT_RATE_ID,
		a.INDIRECT_AMOUNT
		FROM INDIRECT_RATE a
		LEFT JOIN
		INVOICE_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.INDIRECT_RATE_ID
		AND inv_det.ENTRY_TYPE_ID = #{entryTypeId,jdbcType=VARCHAR}
		LEFT JOIN
		INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID in
		<foreach item="items" index="index" collection="invoiceStatusIdList"
			open="(" separator="," close=")">
			#{items}
    	</foreach>
		WHERE a.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
		AND ACTIVE_FLAG
		= 1
		GROUP BY INDIRECT_RATE_ID,
		a.INDIRECT_AMOUNT
	</select>

	<select id="fetchIndirectRateModification" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="IndirectRateListModification">
		SELECT SUM(indirect_amount) as indirect_amount,
		SUM(remaining_amount) as remaining_amount,
		SUM(mod_amount) as mod_amount,
		parent_id
		FROM
		(
		SELECT a.INDIRECT_AMOUNT,
		(a.INDIRECT_AMOUNT - SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END )) AS remaining_amount,
		0 AS mod_amount,
		parent_id
		FROM INDIRECT_RATE a
		LEFT JOIN INVOICE_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID = a.INDIRECT_RATE_ID
		AND inv_det.ENTRY_TYPE_ID = #{entryTypeId,jdbcType=VARCHAR}
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		<foreach item="items" index="index" collection="invoiceStatusIdList"
			open="(" separator="," close=")">
			#{items}
			    	</foreach>
		WHERE a.SUB_BUDGET_ID = #{parentSubBudgetId,jdbcType=VARCHAR}
		AND ACTIVE_FLAG = 1
		GROUP BY parent_id,
		a.INDIRECT_AMOUNT
		UNION ALL
		SELECT 0 AS indirect_amount,
		0 AS remaining_amount,
		a.indirect_amount AS mod_amount,
		a.parent_id
		FROM indirect_rate a
		WHERE a.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
		AND ACTIVE_FLAG = 1
		GROUP BY a.indirect_amount,
		a.parent_id
		)
		GROUP BY parent_id
	</select>
	
	
	<select id="fetchIndirectRateAmendmentNewRecord" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="IndirectRateListModification">
		SELECT SUM(indirect_amount) as indirect_amount,
		SUM(remaining_amount) as remaining_amount,
		SUM(mod_amount) as mod_amount,
		parent_id
		FROM
		(
		SELECT 0 AS indirect_amount,
		0 AS remaining_amount,
		a.indirect_amount AS mod_amount,
		a.parent_id
		FROM indirect_rate a
		WHERE a.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
		AND ACTIVE_FLAG = 1
		GROUP BY a.indirect_amount,
		a.parent_id
		)
		GROUP BY parent_id
	</select>
    
	<!-- Query for grid Rent starts -->
	<resultMap id="RentList" type="com.nyc.hhs.model.Rent">
		<result property="id" column="RENT_ID" />
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="contractID" column="CONTRACT_ID" />
		<result property="location" column="LOCATION" />
		<result property="managementCompanyName" column="MANAGEMENT_COMPANY_NAME" />
		<result property="propertyOwner" column="PROPERTY_OWNER" />
		<result property="publicSchoolSpace" column="PUBLIC_SCHOOL_SPACE" />
		<result property="percentChargedToContract" column="PERCENT_CHARGED_TO_CONTRACT" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="ytdInvoiceAmt" column="YTD_INVOICE_AMOUNT" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
	</resultMap>

	<select id="fetchContractBudgetRent" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="RentList">
		SELECT
		rt.rent_id, b.LINE_ITEM_ID,rt.Location,
		rt.MANAGEMENT_COMPANY_NAME, rt.Property_owner,
		CASE WHEN rt.PUBLIC_SCHOOL_SPACE = '0' THEN 'No'
		ELSE 'Yes' END as PUBLIC_SCHOOL_SPACE
		, rt.PERCENT_CHARGED_TO_CONTRACT,
		rt.AMOUNT, SUM(CASE WHEN a.STATUS_ID IS NOT NULL
		THEN NVL(b.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS YTD_INVOICE_AMOUNT,
		rt.amount ,
		rt.rent_ID,
		 rt.parent_id
		FROM rent rt
		LEFT JOIN invoice_details b
		ON b.line_item_id = rt.rent_id
		AND b.entry_type_id = '5'
		LEFT JOIN invoice a
		ON a.invoice_id = b.invoice_id
		AND a.status_id IN (72,73)
		WHERE rt.budget_id = #{contractBudgetID}
		AND rt.sub_budget_id = #{subBudgetID}
		and active_flag = '1'
		GROUP BY b.LINE_ITEM_ID, rt.Location,rt.MANAGEMENT_COMPANY_NAME,
		rt.Property_owner, rt.PUBLIC_SCHOOL_SPACE,
		rt.PERCENT_CHARGED_TO_CONTRACT,rt.rent_ID,
		rt.amount,rt.parent_id
		order by 
		rt.parent_id desc
		
  </select>

	<update id="updateContractBudgetRent" parameterType="com.nyc.hhs.model.Rent">
		update rent
		set
		LOCATION=#{location},
		MANAGEMENT_COMPANY_NAME=#{managementCompanyName},
		PROPERTY_OWNER=#{propertyOwner},
		PUBLIC_SCHOOL_SPACE=#{publicSchoolSpace},
		PERCENT_CHARGED_TO_CONTRACT=#{percentChargedToContract},
		AMOUNT=#{fyBudget},
		modified_date = CURRENT_TIMESTAMP,
		MODIFIED_BY_USERID =
		#{modifyByAgency, jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider, jdbcType=VARCHAR}
		where
		rent_id = #{id,jdbcType=VARCHAR}  
	 </update>

	<insert id="insertContractBudgetRent" parameterType="com.nyc.hhs.model.Rent">
		INSERT INTO RENT
		(RENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		PARENT_ID,
		ACTIVE_FLAG)
		VALUES
		(SEQ_RENT_ID.NEXTVAL,#{contractBudgetID},#{subBudgetID},#{location},#{managementCompanyName},
		#{propertyOwner},#{publicSchoolSpace},#{percentChargedToContract},#{fyBudget},
		SYSTIMESTAMP,#{modifyByAgency},#{modifyByProvider},
		SYSTIMESTAMP,#{modifyByAgency},#{modifyByProvider},SEQ_RENT_ID.currval,
		'1')
                </insert>

	<delete id="deleteContractBudgetRent" parameterType="com.nyc.hhs.model.Rent">
		DELETE FROM
		Rent WHERE RENT_ID = #{id,jdbcType=VARCHAR}
	 </delete>

	<select id="getSeqForRent" resultType="Integer">
		SELECT SEQ_RENT_ID.NEXTVAL
		FROM DUAL
	</select>
	<insert id="insertModificationRent" parameterType="com.nyc.hhs.model.Rent">
		INSERT INTO RENT
		(RENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		LOCATION,
		MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER,
		PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		VALUES
		(SEQ_RENT_ID.NEXTVAL,#{contractBudgetID},#{subBudgetID},#{location},#{managementCompanyName},
		#{propertyOwner},#{publicSchoolSpace},#{percentChargedToContract},#{fyBudget},
		SYSTIMESTAMP, #{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP, #{modifyByAgency,jdbcType=VARCHAR},SEQ_RENT_ID.currval, '1', #{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR})
	</insert>

	<!-- Query for Grid rent ends -->

	<!-- Query for grid MileStone starts -->
	<resultMap id="MilestoneList" type="com.nyc.hhs.model.CBMileStoneBean">
		<result property="id" column="MILESTONE_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="mileStone" column="MILESTONE" />
		<result property="amount" column="AMOUNT" />
		<result property="invoiceAmount" column="INVOICE_AMOUNT" />
		<result property="invoiceId" column="INVOICE_ID" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
		<result property="remainAmt" column="REMAINING_AMOUNT" />
		<result property="entryTypeId" column="ENTRY_TYPE_ID" />
	</resultMap>

	<select id="fetchMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean"
		resultMap="MilestoneList">
		select MS.MILESTONE_ID, MS.MILESTONE, ms.amount, SUM(CASE
		WHEN INVO.STATUS_ID IS NOT NULL
		THEN NVL(inv.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT, '0' AS REMAINING_AMOUNT
		from
		MILESTONE MS
		LEFT
		OUTER JOIN
		INVOICE_DETAILS inv ON MS.MILESTONE_ID
		= inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = #{entryTypeId}
		LEFT JOIN INVOICE INVO ON
		INVO.invoice_id = inv.invoice_id
		AND INVO.status_id in ('72','73')
		WHERE
		MS.BUDGET_ID =
		#{contractBudgetID}
		AND MS.SUB_BUDGET_ID =
		#{subBudgetID}
		AND
		MS.ACTIVE_FLAG = 1
		group by MS.MILESTONE_ID,
		MS.MILESTONE, ms.amount
		order by ms.milestone_id DESC
	 </select>

	<select id="getSeqForMilestone" resultType="Integer">
		SELECT
		SEQ_MILESTONE_ID.NEXTVAL FROM DUAL
	</select>

	<insert id="insertMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		INSERT INTO
		MILESTONE
		(MILESTONE_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,MILESTONE,AMOUNT,CREATED_BY_USERID,
		CREATED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_DATE,ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		VALUES
		(#{id},#{contractBudgetID},#{subBudgetID},#{id},#{mileStone},#{amount},
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,
		#{modifyByAgency,jdbcType=VARCHAR},
		current_timestamp,'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR})
	</insert>

	<update id="updateMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		UPDATE
		MILESTONE
		SET MILESTONE = #{mileStone},AMOUNT = #{amount},
		modified_date = CURRENT_TIMESTAMP,
		MODIFIED_BY_USERID =
		#{modifyByAgency, jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider, jdbcType=VARCHAR}
		WHERE MILESTONE_ID = #{id}
	</update>

	<delete id="deleteMilestoneDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean">
		DELETE FROM
		MILESTONE WHERE MILESTONE_ID = #{id}
	</delete>

	<!-- -->
	<!-- <resultMap id="UtilitiesDetailsList" type="com.nyc.hhs.model.CBUtilities"> -->
	<!-- <result property="utilities" column="PROFESSIONAL_SERVICE_TYPE" /> -->
	<!-- <result property="ammount" column="AMOUNT" /> -->
	<!-- <result property="invoiceAmount" column="INVOICE_AMOUNT" /> -->
	<!-- </resultMap> -->
	<!-- -->
	<!-- <insert id="updateUtilitiesDetails" parameterType="com.nyc.hhs.model.CBUtilities"> -->
	<!-- </insert> -->
	<!-- -->
	<!-- <select id="fetchUtilitiesDetails" parameterType="String" -->
	<!-- resultMap="UtilitiesDetailsList"> -->
	<!-- select U_T.UTILITY_TYPE, U.AMOUNT, IN.INVOICE_AMOUNT from utility U, 
		utility_type U_T, invoice IN -->
	<!-- where U_T.SUB_BUDGET_ID=#{asBudgetID} and U_T.utility_type_id=PS_T.utility_type_id 
		and U_T.SUB_BUDGET_ID = IN.SUB_BUDGET_ID; -->
	<!-- </select> -->
	<!-- -->
	<!-- <update id="updatBudgetAmendmentStatus" parameterType="com.nyc.hhs.model.ContractBudgetBean" 
		> -->
	<!-- update budget set status_id= {Select status_id from status where status='Pending 
		Approval' and process_type='budget'} where -->
	<!-- budget_id=#{budgetId} and budget_type_id='1' -->
	<!-- </update> -->
	<!-- -->
	<!-- <update id="updatBudgetStatus" parameterType="com.nyc.hhs.model.ContractBudgetBean" 
		> -->
	<!-- update budget set status_id= {Select status_id from status where status='Pending 
		Approval' and process_type='budget'} where -->
	<!-- budget_id=#{budgetId} and budget_type_id='2' -->
	<!-- </update> -->
	<!-- -->
	<!-- <update id="updatBudgetModificationStatus" parameterType="com.nyc.hhs.model.ContractBudgetBean" 
		> -->
	<!-- update budget set status_id= {Select status_id from status where status='Pending 
		Approval' and process_type='budget'} where -->
	<!-- budget_id=#{budgetId} and budget_type_id='3' -->
	<!-- </update> -->
	<!-- -->
	<!-- <update id="updatBudgetUpdateStatus" parameterType="com.nyc.hhs.model.ContractBudgetBean" 
		> -->
	<!-- update budget set status_id= {Select status_id from status where status='Pending 
		Approval' and process_type='budget'} where -->
	<!-- budget_id=#{budgetId} and budget_type_id='4' -->
	<!-- </update> -->
	<!-- -->
	<!-- <select id="fetchBudgetSummary" parameterType="Map" -->
	<!-- resultMap="CoProgramIncomeList"> -->
	<!-- </select> -->
	<!-- -->
	<resultMap id="RateList" type="com.nyc.hhs.model.RateBean">
		<result property="id" column="RATE_ID" />
		<result property="unitDesc" column="UNIT_DESCRIPTION" />
		<result property="units" column="NUMBER_OF_UNITS" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
		<result property="remainAmt" column="REMAINING_AMOUNT" />
		<result property="ytdUnits" column="YTD_UNITS" />
		<result property="remUnits" column="REMAINING_UNITS" />
	</resultMap>

	<select id="fetchRateList" resultMap="RateList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT RATE.RATE_ID,
		  RATE.AMOUNT,
		  RATE.NUMBER_OF_UNITS,
		  RATE.UNIT_DESCRIPTION,
		  SUM(CASE
		  WHEN
		  INVOICE.STATUS_ID IS NOT NULL
		  THEN
		  NVL(INVOICE_DETAILS.invoiced_units,0)
		  ELSE
		  0
		  END) AS YTD_UNITS,
		  RATE.number_of_units - SUM(CASE
		  WHEN
		  INVOICE.STATUS_ID IS NOT NULL
		  THEN
		  NVL(INVOICE_DETAILS.invoiced_units,0)
		  ELSE
		  0
		  END ) AS REMAINING_UNITS,  
		  NVL(SUM ( INVOICE_DETAILS.INVOICE_AMOUNT), '0') AS INVOICE_AMOUNT,
		  '0'                                             AS REMAINING_AMOUNT
		  FROM RATE
		  LEFT JOIN ENTRY_TYPE_MASTER
		   ON ENTRY_TYPE_MASTER.ENTRY_TYPE_ID = 7
		  LEFT JOIN INVOICE
		   ON INVOICE.STATUS_ID IN (72,73)
		  LEFT JOIN INVOICE_DETAILS
		  ON INVOICE_DETAILS.LINE_ITEM_ID     = RATE.RATE_ID
		  AND INVOICE.INVOICE_ID              = INVOICE_DETAILS.INVOICE_ID
		  AND ENTRY_TYPE_MASTER.ENTRY_TYPE_ID = INVOICE_DETAILS.ENTRY_TYPE_ID
		  WHERE RATE.SUB_BUDGET_ID            = (#{subBudgetID})
		  AND RATE.ACTIVE_FLAG                = 1
		  GROUP BY RATE.RATE_ID ,
		    RATE.AMOUNT,
		    RATE.NUMBER_OF_UNITS,
		    RATE.UNIT_DESCRIPTION
		  ORDER BY RATE.RATE_ID DESC
	</select>

	<select id="getSeqForRate" resultType="Integer">
		SELECT SEQ_RATE_ID.NEXTVAL
		FROM DUAL
	</select>

	<insert id="insertRateList" parameterType="com.nyc.hhs.model.RateBean">
		INSERT
		INTO RATE
		(
		RATE_ID,
		AMOUNT,
		BUDGET_ID,
		CREATED_BY_USERID,
		CREATED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_DATE,
		NUMBER_OF_UNITS,
		PARENT_ID,
		SUB_BUDGET_ID,
		UNIT_DESCRIPTION,
		ACTIVE_FLAG,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID
		)
		VALUES
		(
		#{id},
		#{fyBudget},
		#{contractBudgetID},
		#{modifyByAgency},
		CURRENT_TIMESTAMP,
		#{modifyByAgency},
		CURRENT_TIMESTAMP,
		#{units},
		#{id},
		#{subBudgetID},
		#{unitDesc},
		'1',
		#{modifyByProvider},
		#{modifyByProvider}
		)
	</insert>

	<update id="updateRateList" parameterType="com.nyc.hhs.model.RateBean">
		UPDATE RATE
		SET
		UNIT_DESCRIPTION = #{unitDesc},
		NUMBER_OF_UNITS = #{units},
		AMOUNT = #{fyBudget},
		MODIFIED_DATE = SYSTIMESTAMP, 
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE RATE_ID = #{id}
	</update>

	<delete id="deleteRateList" parameterType="com.nyc.hhs.model.RateBean">
		DELETE FROM RATE WHERE
		RATE_ID = #{id}
	</delete>

	<resultMap id="CoProfessionalServicesList" type="com.nyc.hhs.model.CBProfessionalServicesBean">
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="id" column="PROFESSIONAL_SERVICE_ID" />
		<result property="profServiceTypeId" column="PROFESSIONAL_SERVICE_TYPE_ID" />
		<result property="professionalServiceName" column="PROFESSIONAL_SERVICE_TYPE" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
	</resultMap>

	<select id="fetchProfessionalServicesDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="CoProfessionalServicesList">
		select
		profess.PROFESSIONAL_SERVICE_ID,
		profess.PROFESSIONAL_SERVICE_TYPE_ID,
		profess.BUDGET_ID,
		profess.SUB_BUDGET_ID,
		CASE
		WHEN other.ENTITY_NAME IS NOT NULL THEN other.ENTITY_NAME
		ELSE profess_master.PROFESSIONAL_SERVICE_TYPE
		END
		as PROFESSIONAL_SERVICE_TYPE,
		nvl(profess.AMOUNT,'0') as AMOUNT ,
		(nvl(invoicedetail.INVOICE_AMOUNT,'0')) as INVOICE_AMOUNT
		from PROFESSIONAL_SERVICE_TYPE_MSTR profess_master
		inner join PROFESSIONAL_SERVICE profess on
		profess.PROFESSIONAL_SERVICE_TYPE_ID =
		profess_master.PROFESSIONAL_SERVICE_TYPE_ID and profess.active_flag = '1'
		<!-- Begin REL 3.9.0 QC 6479 eliminate rows where parent_id equals id & another row exists with that parent_id -->
		and profess.PROFESSIONAL_SERVICE_ID in 
			(
			  select professional_service_id from PROFESSIONAL_SERVICE where parent_id not in 
			    (select parent_id from PROFESSIONAL_SERVICE where active_flag=1 and professional_service_id != parent_id and BUDGET_ID = #{contractBudgetID})
			  union
			  select professional_service_id from PROFESSIONAL_SERVICE where active_flag=1 and professional_service_id != parent_id and BUDGET_ID = #{contractBudgetID}
			)
		<!-- End REL 3.9.0 QC 6479  -->
		left outer join OTHER_DETAILS other on other.ENTITY_ID =
		profess.PROFESSIONAL_SERVICE_ID and other.ENTRY_TYPE_ID = 4 and
		other.active_flag = '1'
		left outer join (select entry_type_id, line_item_id, sum(invoice_amount)
		as INVOICE_AMOUNT
		from INVOICE_DETAILS where INVOICE_ID IN
		(select invoice_id from INVOICE where BUDGET_ID = #{contractBudgetID} and
		CONTRACT_ID = #{contractID} and STATUS_ID in (72, 73)) and
		ENTRY_TYPE_ID = 4
		group by entry_type_id, line_item_id) invoicedetail on
		invoicedetail.entry_type_id = 4
		and invoicedetail.line_item_id = profess.PROFESSIONAL_SERVICE_ID
		where
		profess.SUB_BUDGET_ID = #{subBudgetID} and profess.BUDGET_ID =
		#{contractBudgetID}
		order by
		profess_master.professional_service_type_id
    </select>

	<update id="updateProfessionalServicesDetails" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		update PROFESSIONAL_SERVICE set AMOUNT = #{fyBudget}, MODIFIED_DATE =
		SYSTIMESTAMP, MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		where professional_service_id = #{id} and budget_id = #{contractBudgetID}
		and sub_budget_id = #{subBudgetID}
	</update>

	<select id="fetchProfessionalServicesTypeId" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="CoProfessionalServicesList">
		select PROFESSIONAL_SERVICE_TYPE_ID,
		PROFESSIONAL_SERVICE_TYPE from PROFESSIONAL_SERVICE_TYPE_MSTR
    </select>

	<insert id="addProfessionalServicesDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		Insert into PROFESSIONAL_SERVICE
		(PROFESSIONAL_SERVICE_ID,
		PROFESSIONAL_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG)
		values

		(SEQ_PROFESSIONAL_SERVICE_ID.nextval,
		#{profServiceTypeId},
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_PROFESSIONAL_SERVICE_ID.currval,
		0,
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		'1')
	</insert>

	<insert id="addProfServicesDetails" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		Insert into PROFESSIONAL_SERVICE
		(PROFESSIONAL_SERVICE_ID,
		PROFESSIONAL_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG)
		values

		(SEQ_PROFESSIONAL_SERVICE_ID.nextval,
		#{profServiceTypeId},
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_PROFESSIONAL_SERVICE_ID.currval,
		0,
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		'1')
	</insert>

	<select id="fetchProfServicesItemsCount" parameterType="java.lang.Integer"
		resultType="java.lang.Integer">
		select count(1) from PROFESSIONAL_SERVICE Where
		SUB_BUDGET_ID = #{subBudgetId} and ACTIVE_FLAG = '1'
    </select>

	<select id="fetchProfServicesForOther" parameterType="java.lang.Integer"
		resultType="java.lang.Integer">
		select count(other.ENTITY_ID)
		from PROFESSIONAL_SERVICE
		profess
		inner join OTHER_DETAILS other on other.ENTITY_ID =
		profess.PROFESSIONAL_SERVICE_ID and other.ENTRY_TYPE_ID = (select
		ENTRY_TYPE_ID from ENTRY_TYPE_MASTER where 
		ENTRY_TYPE = 'Professional Services')
		Where other.ENTITY_ID = #{aoProfServiceId}
    </select>


	<insert id="addProfServicesForOther" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		Insert into OTHER_DETAILS
		(OTHER_DETAILS_ID,
		ENTITY_ID,
		ENTRY_TYPE_ID,
		ENTITY_NAME,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID)
		values

		(SEQ_OTHER_DETAILS_ID.nextval,
		#{id},
		(select ENTRY_TYPE_ID from ENTRY_TYPE_MASTER where
		 ENTRY_TYPE = 'Professional Services'),
		#{professionalServiceName},
		'1',
		SYSTIMESTAMP,
		#{modifyByProvider},
		SYSTIMESTAMP,
		#{modifyByProvider})
	</insert>

	<update id="updateProfServicesForOther" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
		update
		OTHER_DETAILS set ENTITY_NAME = #{professionalServiceName},
		MODIFIED_DATE = SYSTIMESTAMP, MODIFIED_BY_USERID = #{modifyByProvider}
		where ENTITY_ID = #{id} and ENTRY_TYPE_ID = (select ENTRY_TYPE_ID from
		ENTRY_TYPE_MASTER where ENTRY_TYPE = 'Professional Services')
	</update>


	<resultMap id="contractInfo" type="com.nyc.hhs.model.ContractList">
		<result property="contractAgencyName" column="AGENCY_NAME" />
		<result property="agencyId" column="AGENCY_ID" />
		<result property="contractTitle" column="PROCUREMENT_TITLE" />
		<result property="provider" column="ORGANIZATION_LEGAL_NAME" />
		<result property="procEpin" column="PROCEPIN" />
		<result property="awardEpin" column="AWRDEPIN" />
		<result property="extCT" column="EXT_CT_NUMBER" />
		<result property="contractStartDate" column="CONTRACT_START_DATE" />
		<result property="contractEndDate" column="CONTRACT_END_DATE" />
		<result property="contractValue" column="CONTRACT_AMOUNT" />
		<result property="programName" column="PROGRAM_NAME" />
		<result property="budgetStatus" column="STATUS" />
		<result property="parentContractId" column="PARENT_CONTRACT_ID" />
		<result property="contractTypeId" column="CONTRACT_TYPE_ID" />
		<result property="providerOrgId" column="ORGANIZATION_ID" />
		<result property="fyConfigFiscalYear" column="fiscal_year_id" />
		<!-- Start : R5 Added -->		
		<result property="invoiceCount" column="INVOICE_COUNT" />
		<result property="paymentCount" column="PAYMENT_COUNT" />
		<!-- End : R5 Added -->
		<!-- Start : R6 USES_FTE column checking new budget flow added-->
		<!-- The following attribute is changed from existingBudget to usesFte -->
		<result property="usesFte" column="USES_FTE" />
		<result property="approvedDate" column="APPROVED_DATE" />
		<result property="returnedPaymentAmount" column="TOTAL_RETURNED_AMOUNT"></result>
		<result property="noOfReturnedPayments" column="NO_OF_RETURNED_PAYMENTS"></result>
		<result property="budgetStatusId" column="STATUS_ID"></result>
		<result property="programId" column="PROGRAM_ID" />
		<!-- End : R6 Added -->
		<!-- Fetching IS_OLD_PI flag : Added in R7: Program Income -->
		<result property="oldPIFlag" column="IS_OLD_PI" />
		<!-- End R7: Program Income -->
		<!-- Start: Added in R7 for Cost Center -->
		<result property="costCenterOpted" column="COST_CENTER_OPTED" />
		<!-- End: Added in R7 for Cost Center -->
	</resultMap>

<!-- R6: Non apt epins query changed REF_APT_EPIN_ID -->
	<select id="fetchContractSummaryAmendment" parameterType="hashmap"
	resultMap="contractInfo">
	SELECT NYC_AGENCY_DETAILS.AGENCY_NAME,
	(
	CASE
	WHEN CONTRACT.CONTRACT_TITLE IS NOT NULL
	THEN CONTRACT.CONTRACT_TITLE
	ELSE CONTRACT.PROCUREMENT_TITLE
	END) AS PROCUREMENT_TITLE,
	CONTRACT.AGENCY_ID,
	CONTRACT.PARENT_CONTRACT_ID,
	ORGANIZATION.ORGANIZATION_ID,
	ORGANIZATION.ORGANIZATION_LEGAL_NAME,
	( CASE WHEN CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE in ('APT_Contract')
	THEN (select
	PROCUREMENT_AWARD_EPIN AS PROC_EPIN
	FROM
	REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID =(select PROCUREMENT_EPIN_ID from REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID = (select REF_APT_EPIN_ID from CONTRACT where CONTRACT_ID= #{parentContractId}))) 
	ELSE
	PROCUREMENT.EPIN
	END
	) AS PROCEPIN,
	CONTRACT.EXT_EPIN AS AWRDEPIN,
	NVL(CONTRACT.EXT_CT_NUMBER, 'Not
	Registered') AS EXT_CT_NUMBER,
	CONTRACT.CONTRACT_START_DATE,
	(SELECT CONTRACT.PROPOSED_CONTRACT_END_DATE
	  FROM CONTRACT
	 INNER JOIN BUDGET ON CONTRACT.CONTRACT_ID = BUDGET.CONTRACT_ID
	  WHERE BUDGET.BUDGET_ID  = #{budgetId}
	 ) as CONTRACT_END_DATE,
	NVL((SELECT CONTRACT.PREV_CONTRACT_AMOUNT 
		FROM CONTRACT 
	 INNER JOIN BUDGET ON CONTRACT.CONTRACT_ID = BUDGET.CONTRACT_ID
	 WHERE BUDGET.BUDGET_ID = #{budgetId}
	 ),'0') AS CONTRACT_AMOUNT,
	CONTRACT.CONTRACT_TYPE_ID,
	<!-- Start: Added in R7 for Cost Center -->
	(select COST_CENTER_OPTED from Contract where CONTRACT_ID=#{parentContractId}) as COST_CENTER_OPTED,
	<!-- End: Added in R7 for Cost Center -->
	PROGRAM_MASTER.PROGRAM_NAME,
	STATUS_MASTER_R2_R3.STATUS,
	<!-- Fetching IS_OLD_PI flag : Added in R7: Program Income -->
	(select NVL(BUDGET.IS_OLD_PI,1) from budget where budget_id = (select parent_id from budget where budget_id=#{budgetId})) IS_OLD_PI,
	<!-- End R7: Program Income -->
	<!-- Start : R6 USES_FTE column checking new budget flow added-->
  	BUDGET.USES_FTE,
  	<!-- End : R6 Existing column checking new budget flow added -->
  	<!-- Start : R6 TOTAL_RETURNED_AMOUNT column getting total approved returned payment amount-->
	<!-- Defect fix 8567-->
	(SELECT NVL(SUM(CHECK_AMOUNT),0) FROM RETURN_PAYMENT WHERE BUDGET_ID = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId}) and status_id in (187,186)) AS TOTAL_RETURNED_AMOUNT
	<!-- End : R6 TOTAL_RETURNED_AMOUNT column getting total approved returned payment amount -->
	  	<!-- End : R6 Existing column checking new budget flow added -->
  	<!-- Start: Added for 8438 -->
  	,BUDGET.APPROVED_DATE
	<!-- End: Added for 8438 -->
	FROM CONTRACT
	INNER JOIN CONTRACT_SOURCE_MASTER
	ON CONTRACT.CONTRACT_SOURCE_ID =
	CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE_ID
	LEFT JOIN NYC_AGENCY_DETAILS
	ON NYC_AGENCY_DETAILS.AGENCY_ID = CONTRACT.AGENCY_ID
	LEFT JOIN ORGANIZATION
	ON ORGANIZATION.ORGANIZATION_ID =CONTRACT.ORGANIZATION_ID
	LEFT JOIN PROGRAM_MASTER
	ON PROGRAM_MASTER.PROGRAM_ID = CONTRACT.PROGRAM_ID
	LEFT JOIN PROCUREMENT
	ON PROCUREMENT.PROCUREMENT_ID = CONTRACT.PROCUREMENT_ID
	LEFT JOIN BUDGET
	ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID
	LEFT JOIN STATUS_MASTER_R2_R3
	ON STATUS_MASTER_R2_R3.STATUS_ID = BUDGET.STATUS_ID
	WHERE CONTRACT.CONTRACT_ID = #{parentContractId}
	AND BUDGET.BUDGET_ID = #{parentBudgetId}

	</select>
	
	<!-- Updated in R7 for Cost Center -->
	<!-- R6: REF_APT_EPIN_ID added in clause for non apt epins validation -->
	<select id="fetchContractSummary" parameterType="hashmap"
	resultMap="contractInfo">
	SELECT NYC_AGENCY_DETAILS.AGENCY_NAME,
	(
	CASE
	WHEN CONTRACT.CONTRACT_TITLE IS NOT NULL
	THEN CONTRACT.CONTRACT_TITLE
	ELSE CONTRACT.PROCUREMENT_TITLE
	END) AS PROCUREMENT_TITLE,
	CONTRACT.AGENCY_ID,
	CONTRACT.PARENT_CONTRACT_ID,
	ORGANIZATION.ORGANIZATION_ID,
	ORGANIZATION.ORGANIZATION_LEGAL_NAME,
	( 
	CASE 
	WHEN CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE in ('APT_Contract')
	THEN (select
	PROCUREMENT_AWARD_EPIN AS PROC_EPIN
	FROM
	REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID =(select REF_APT_EPIN_ID from REF_APT_EPIN_MASTER
	where REF_APT_EPIN_ID =(select PROCUREMENT_EPIN_ID from REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID = (select REF_APT_EPIN_ID from CONTRACT where CONTRACT_ID = #{contractId})))) 
	WHEN CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE in ('R2_Contract') and contract.contract_type_id = 4
	THEN (select
	PROCUREMENT_AWARD_EPIN AS PROC_EPIN
	FROM
	REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID =(select PROCUREMENT_EPIN_ID from REF_APT_EPIN_MASTER
	where
	REF_APT_EPIN_ID = (select REF_APT_EPIN_ID from CONTRACT where CONTRACT_ID = #{contractId}))) 
	ELSE
	PROCUREMENT.EPIN
	END
	) AS PROCEPIN,
	CONTRACT.EXT_EPIN AS AWRDEPIN,
	NVL(CONTRACT.EXT_CT_NUMBER, 'Not
	Registered') AS EXT_CT_NUMBER,
	CONTRACT.CONTRACT_START_DATE,
	CONTRACT.CONTRACT_END_DATE,
	CONTRACT.CONTRACT_AMOUNT,
	CONTRACT.CONTRACT_TYPE_ID,
	<!-- Start: Added in R7 for Cost Center -->
	(CASE WHEN (select contract_type_id from contract where contract_id=#{contractId})= 3 Then (SELECT COST_CENTER_OPTED FROM CONTRACT WHERE CONTRACT_ID =#{contractId})
    ELSE (SELECT COST_CENTER_OPTED FROM CONTRACT WHERE CONTRACT_ID =(select parent_contract_id from contract where CONTRACT_ID=#{contractId})) END) as COST_CENTER_OPTED,
	<!-- End: Added in R7 for Cost Center -->
	PROGRAM_MASTER.PROGRAM_NAME,
	PROGRAM_MASTER.PROGRAM_ID,
	STATUS_MASTER_R2_R3.STATUS,
	BUDGET.STATUS_ID,
	<!-- Fetching IS_OLD_PI flag : Added in R7: Program Income -->
	NVL(BUDGET.IS_OLD_PI,1) IS_OLD_PI,
	<!-- End R7: Program Income -->
	<!-- Start : R5 Added  -->
	(SELECT COUNT(1) FROM INVOICE WHERE CONTRACT_ID = #{contractId} AND BUDGET_ID = #{budgetId} AND STATUS_ID IN
			<choose>
				<when test="asOrgType == 'provider_org'">
					(70,71,72,73,74,75)
				</when>
				<otherwise>
					(71,72,73,74,75)
				</otherwise>
			</choose>
	) AS INVOICE_COUNT,
    (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = #{contractId} AND BUDGET_ID = #{budgetId} 
    	AND DELETE_FLAG = '0' AND STATUS_ID IN
    		<choose>
				<when test="asOrgType == 'provider_org'">
					(64,109,65)
				</when>
				<otherwise>
					(109,63,64,65,66)
				</otherwise>
    		</choose>
    ) AS PAYMENT_COUNT,
	<!-- End : R5 Added  -->
	<!-- Start : R6 USES_FTE column checking new budget flow added-->
  	(select USES_FTE FROM BUDGET WHERE budget_id= (select parent_id from budget where
  	budget_id= #{budgetId})) as USES_FTE,
  	<!--  Added in R7 for cost center -->
  	(select COST_CENTER_OPTED from contract where contract_id=#{contractId}) as COST_CENTER_OPTED,
  	<!-- End : R7 added -->
  	BUDGET.APPROVED_DATE
  	<!-- End : R6 Existing column checking new budget flow added -->
  	<!-- Start : R6 Changes to get total approved returned payment amount and count of returned payments for particular budget-->
  	<!-- Defect fix 8567-->
  	,(SELECT NVL(SUM(CHECK_AMOUNT),0) FROM RETURN_PAYMENT WHERE BUDGET_ID = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId}) and status_id in (187,186)) AS TOTAL_RETURNED_AMOUNT,
  	(SELECT count(RETURN_PAYMENT_ID) FROM RETURN_PAYMENT WHERE BUDGET_ID = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId})) AS NO_OF_RETURNED_PAYMENTS
  	<!-- End : R6 Changes to get total approved returned payment amount and count of returned payments for particular budget-->
	FROM CONTRACT
	INNER JOIN CONTRACT_SOURCE_MASTER
	ON CONTRACT.CONTRACT_SOURCE_ID =
	CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE_ID
	LEFT JOIN NYC_AGENCY_DETAILS
	ON NYC_AGENCY_DETAILS.AGENCY_ID = CONTRACT.AGENCY_ID
	LEFT JOIN ORGANIZATION
	ON ORGANIZATION.ORGANIZATION_ID =CONTRACT.ORGANIZATION_ID
	LEFT JOIN PROGRAM_MASTER
	ON PROGRAM_MASTER.PROGRAM_ID = CONTRACT.PROGRAM_ID
	LEFT JOIN PROCUREMENT
	ON PROCUREMENT.PROCUREMENT_ID = CONTRACT.PROCUREMENT_ID
	LEFT JOIN BUDGET
	ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID
	LEFT JOIN STATUS_MASTER_R2_R3
	ON STATUS_MASTER_R2_R3.STATUS_ID = BUDGET.STATUS_ID
	WHERE CONTRACT.CONTRACT_ID = #{contractId}
	AND BUDGET.BUDGET_ID = #{budgetId}
	</select>
	
	<resultMap id="fetchInfo" type="com.nyc.hhs.model.CBGridBean">
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="subBudgetName" column="SUB_BUDGET_NAME" />
		<result property="subBudgetAmount" column="SUB_BUDGET_AMOUNT" />
		<!-- added in R7 to fetch parent sub budget id -->
		<result property="parentSubBudgetId" column="PARENT_ID" />
		<!-- End R7 to fetch parent sub budget id -->
	</resultMap>

	<select id="fetchSubBudgetSummary" parameterType="hashmap"
		resultMap="fetchInfo">
		SELECT SUB_BUDGET_ID,
		SUB_BUDGET_NAME,
		SUB_BUDGET_AMOUNT,
		<!-- added in R7 -->
		PARENT_ID
		<!-- R7 End -->
		FROM
		SUB_BUDGET
		WHERE BUDGET_ID = #{budgetId} AND ACTIVE_FLAG = '1'
		ORDER BY SUB_BUDGET_ID
	</select>

	<resultMap id="fyBudgetInfo" type="com.nyc.hhs.model.BudgetDetails">
		<result property="startDate" column="BUDGET_START_DATE" />
		<result property="endDate" column="BUDGET_END_DATE" />
		<result property="approvedBudget" column="FISCAL_YEAR_AMOUNT" />
	</resultMap>

	<select id="fetchFyBudgetSummary" parameterType="hashmap"
		resultMap="fyBudgetInfo">
		SELECT BUDGET.BUDGET_START_DATE,
		BUDGET.BUDGET_END_DATE,
		BUDGET.FISCAL_YEAR_AMOUNT
		FROM BUDGET
		WHERE BUDGET.BUDGET_ID =
		#{budgetId}
		AND
		BUDGET.CONTRACT_ID = #{contractId}
	</select>

	<select id="fetchModificationFyBudgetSummary" parameterType="hashmap"
		resultMap="fyBudgetInfo">
		SELECT BUDGET.BUDGET_START_DATE, BUDGET.BUDGET_END_DATE,
		BUDGET.FISCAL_YEAR_AMOUNT FROM BUDGET WHERE BUDGET_ID = (SELECT
		PARENT_ID FROM BUDGET WHERE BUDGET_ID = #{budgetId})		
	</select>

	<select id="getInvoiceAmount" parameterType="hashmap"
		resultType="BigDecimal">
		SELECT NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),0)
		FROM BUDGET
		INNER JOIN INVOICE
		ON INVOICE.BUDGET_ID = BUDGET.BUDGET_ID
		INNER JOIN INVOICE_DETAILS
		ON INVOICE_DETAILS.INVOICE_ID = INVOICE.INVOICE_ID
		AND INVOICE_DETAILS.ENTRY_TYPE_ID NOT IN ('11','14')
		WHERE INVOICE.STATUS_ID      IN (72,73)
		AND BUDGET.BUDGET_ID          = #{budgetId}
		AND BUDGET.CONTRACT_ID        = #{contractId} 
	</select>

	<select id="getInvoiceAmountForModification" parameterType="hashmap"
		resultType="BigDecimal">
		SELECT NVL(SUM(INVOICE_AMOUNT),'0') FROM INVOICE_DETAILS
		WHERE
		INVOICE_ID IN (
		SELECT
		INVOICE.INVOICE_ID
		FROM BUDGET
		INNER JOIN
		INVOICE ON INVOICE.BUDGET_ID = BUDGET.BUDGET_ID
		WHERE
		INVOICE.STATUS_ID
		In (72,73)
		And Budget.Budget_Id =(SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId})
		)
		AND ENTRY_TYPE_ID NOT IN ('11','14')
    </select>

	<select id="getActPaidAmount" parameterType="hashmap"
		resultType="Integer">
		SELECT NVL(SUM(INVOICE_AMOUNT),'0') FROM
		INVOICE_DETAILS
		WHERE
		INVOICE_ID IN (
		SELECT DISTINCT INVOICE.INVOICE_ID
		FROM PAYMENT
		INNER JOIN INVOICE ON INVOICE.INVOICE_ID =
		PAYMENT.INVOICE_ID
		WHERE
		INVOICE.STATUS_ID IN (65)
		AND
		PAYMENT.BUDGET_ID = #{budgetId}
		AND
		PAYMENT.CONTRACT_ID = #{contractId}
		)
    </select>


	<resultMap id="sessionInfo" type="com.nyc.hhs.model.CBGridBean">
		<result property="contractID" column="CONTRACT_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="procurementID" column="PROCUREMENT_ID" />
		<result property="fiscalYearID" column="FISCAL_YEAR_ID" />
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />
		<result property="budgetStatusId" column="BUDGET_STATUS_ID" />
		<result property="contractStatusId" column="CONTRACT_STATUS_ID" />
	</resultMap>

	<select id="getCbGridDataForSession" parameterType="hashmap"
		resultMap="sessionInfo">
		SELECT
		CONTRACT.CONTRACT_ID,
		BUDGET.BUDGET_ID,
		CONTRACT.PROCUREMENT_ID,
		BUDGET.FISCAL_YEAR_ID,
		BUDGET.BUDGET_TYPE_ID,
		BUDGET.STATUS_ID as
		BUDGET_STATUS_ID,
		CONTRACT.STATUS_ID as
		CONTRACT_STATUS_ID
		FROM CONTRACT
		INNER JOIN BUDGET ON
		BUDGET.CONTRACT_ID
		= CONTRACT.CONTRACT_ID
		INNER JOIN STATUS_MASTER_R2_R3 ON
		STATUS_MASTER_R2_R3.STATUS_ID =
		BUDGET.STATUS_ID
		WHERE
		CONTRACT.CONTRACT_ID = #{contractId}
		AND
		BUDGET.BUDGET_ID = #{budgetId}
	</select>

	<resultMap id="ContractedServices" type="com.nyc.hhs.model.ContractedServicesBean">
		<result property="subHeader" column="CONTRACTED_SERVICE_TYPE" />
		<result property="descOfService" column="SERVICE_DESCRIPTION" />
		<result property="fyBudget" column="AMOUNT" />
		<result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
		<result property="csName" column="NAME" />
		<result property="id" column="CONTRACTED_SERVICE_ID" />
		<result property="ytdInvoiceAmt" column="YTD_INVOICE_AMOUNT" />
		<result property="ytdTotalInvoiceAmt" column="TOTAL_YTD_INVOICE_AMOUNT" />
		<result property="totalContractedServices" column="TOTAL_CONTRACTED_SERVICES" />
	</resultMap>
	<select id="fetchContractedServicesConsultants" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="ContractedServices">
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		CONTRACTED_SERVICE_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION,PARENT_ID
		FROM
		contracted_service a
		LEFT JOIN INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
		AND
		inv_det.ENTRY_TYPE_ID = '6'
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
		and
		a.CONTRACTED_SERVICE_TYPE_ID = '1'  
		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID in( 72,73)
		and
		inv_det.SUB_BUDGET_ID = a.SUB_BUDGET_ID
		WHERE a.BUDGET_ID =
		#{contractBudgetID}
		AND a.SUB_BUDGET_ID = #{subBudgetID}
		GROUP BY
		CONTRACTED_SERVICE_ID,PARENT_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION
		order by PARENT_ID desc
	</select>

	<select id="fetchContractedServicesSubContractors"
		parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		CONTRACTED_SERVICE_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION,PARENT_ID
		FROM contracted_service a
		LEFT JOIN
		INVOICE_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID =
		a.CONTRACTED_SERVICE_ID
		AND inv_det.ENTRY_TYPE_ID = '6' 
		INNER JOIN
		CONTRACTED_SERVICE_TYPE_MASTER b
		ON b.CONTRACTED_SERVICE_TYPE_ID =
		a.CONTRACTED_SERVICE_TYPE_ID
		and a.CONTRACTED_SERVICE_TYPE_ID =
		'2' 
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID =
		inv_det.INVOICE_ID
		AND inv.STATUS_ID in( 72,73)
		and
		inv_det.SUB_BUDGET_ID = a.SUB_BUDGET_ID
		WHERE a.BUDGET_ID =
		#{contractBudgetID}
		AND a.SUB_BUDGET_ID = #{subBudgetID}
		GROUP BY
		CONTRACTED_SERVICE_ID,PARENT_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION
		order by PARENT_ID desc
	</select>

	<select id="fetchContractedServicesVendors" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="ContractedServices">
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		CONTRACTED_SERVICE_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION,PARENT_ID
		FROM
		contracted_service a
		LEFT JOIN INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
		AND
		inv_det.ENTRY_TYPE_ID = '6'
		INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
		ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
		and
		a.CONTRACTED_SERVICE_TYPE_ID = '3' 
		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID in( 72,73)
		and
		inv_det.SUB_BUDGET_ID = a.SUB_BUDGET_ID
		WHERE a.BUDGET_ID =
		#{contractBudgetID}
		AND a.SUB_BUDGET_ID = #{subBudgetID}
		GROUP BY
		CONTRACTED_SERVICE_ID,PARENT_ID,
		a.AMOUNT,Name,SERVICE_DESCRIPTION
		order by PARENT_ID desc 
	</select>
	<select id="fetchNonGridContractedServices" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="ContractedServices">
		SELECT SUM(amount)as TOTAL_CONTRACTED_SERVICES,
		SUM(INVOICE_AMOUNT)as TOTAL_YTD_INVOICE_AMOUNT
		FROM
		(
		SELECT SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT,
		0 AS CURRENT_INVOICE_AMOUNT,
		CONTRACTED_SERVICE_ID,
		a.AMOUNT
		FROM CONTRACTED_SERVICE a
		LEFT JOIN
		INVOICE_DETAILS inv_det
		ON inv_det.LINE_ITEM_ID =
		a.CONTRACTED_SERVICE_ID
		AND inv_det.ENTRY_TYPE_ID = '6'
		INNER JOIN
		CONTRACTED_SERVICE_TYPE_MASTER b
		ON b.CONTRACTED_SERVICE_TYPE_ID =
		a.CONTRACTED_SERVICE_TYPE_ID
		LEFT JOIN INVOICE inv
		ON inv.INVOICE_ID =
		inv_det.INVOICE_ID
		AND inv.STATUS_ID in( 72,73)
		WHERE a.BUDGET_ID =
		#{contractBudgetID}
		AND a.SUB_BUDGET_ID = #{subBudgetID}
		GROUP BY
		CONTRACTED_SERVICE_ID,
		a.AMOUNT
		)
	</select>


	<insert id="addContractedServices" parameterType="com.nyc.hhs.model.ContractedServicesBean">

		Insert into
		CONTRACTED_SERVICE
		(CONTRACTED_SERVICE_ID,
		CONTRACTED_SERVICE_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		NAME,
		SERVICE_DESCRIPTION,
		BUDGETED_UNITS,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG
		)
		VALUES
		(SEQ_CONTRACTED_SERVICE_ID.nextval,
		#{subHeader},
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_CONTRACTED_SERVICE_ID.currval,
		#{csName},
		#{descOfService},
		'0',
		#{fyBudget},
		current_timestamp,
		#{modifyByAgency},
		current_timestamp,
		#{modifyByAgency},
		#{modifyByProvider},
		#{modifyByProvider},
		'1')
	</insert>

	<update id="editContractedServices" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		UPDATE
		CONTRACTED_SERVICE set
		NAME=#{csName},AMOUNT=#{fyBudget},SERVICE_DESCRIPTION=#{descOfService},
		modified_date = CURRENT_TIMESTAMP,
		MODIFIED_BY_USERID =
		#{modifyByAgency, jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider, jdbcType=VARCHAR}
		where CONTRACTED_SERVICE_ID=#{id} 
	</update>

	<delete id="delContractedServices" parameterType="com.nyc.hhs.model.ContractedServicesBean">
		DELETE FROM
		CONTRACTED_SERVICE
		where CONTRACTED_SERVICE_ID=#{id}
	</delete>

	<resultMap id="assignmentInfo" type="com.nyc.hhs.model.AssignmentsSummaryBean">
		<result property="id" column="ASSIGNMENT_id" />
		<result property="assignmentName" column="LGL_NM" />
		<result property="assignmentAmount" column="YTD_ASSIGNMENT_AMOUNT" />
	</resultMap>
	<select id="fetchAssignmentSummary" parameterType="com.nyc.hhs.model.CBGridBean"
	resultMap="assignmentInfo">
		select  ID, LGL_NM, sum(YTD_ASSIGNMENT_AMOUNT) AS
		YTD_ASSIGNMENT_AMOUNT from (
		SELECT DISTINCT ASSIGNMENT.ASSIGNMENT_id AS ID,
		REF_VENDOR_V.LGL_NM, NVL(SUM(ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT),'0') AS
		YTD_ASSIGNMENT_AMOUNT
		FROM
		ASSIGNMENT
		INNER JOIN REF_VENDOR_V ON
		REF_VENDOR_V.VEND_CUST_CD = ASSIGNMENT.VEND_CUST_CD
		LEFT JOIN ADVANCE_ASSIGNMENT ON ADVANCE_ASSIGNMENT.ASSIGNMENT_ID =
		ASSIGNMENT.ASSIGNMENT_id
		LEFT JOIN BUDGET_ADVANCE ON BUDGET_ADVANCE.BUDGET_ADVANCE_ID =
		ADVANCE_ASSIGNMENT.BUDGET_ADVANCE_ID
		where Assignment.BUDGET_ID = #{contractBudgetID} AND
		BUDGET_ADVANCE.STATUS_ID = '93'
		group by
		ASSIGNMENT.ASSIGNMENT_id,
		REF_VENDOR_V.LGL_NM,
		ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT
	
		UNION ALL
	
		select distinct ASSIGNMENT.ASSIGNMENT_id AS ID,
		REF_VENDOR_V.LGL_NM, NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),'0') AS YTD_ASSIGNMENT_AMOUNT
		FROM ASSIGNMENT
		INNER JOIN REF_VENDOR_V ON REF_VENDOR_V.VEND_CUST_CD =
		ASSIGNMENT.VEND_CUST_CD
		LEFT JOIN INVOICE ON INVOICE.BUDGET_ID = ASSIGNMENT.BUDGET_ID
		LEFT JOIN INVOICE_DETAILS ON INVOICE_DETAILS.INVOICE_ID =
		INVOICE.INVOICE_ID
		AND INVOICE_DETAILS.LINE_ITEM_ID = ASSIGNMENT.ASSIGNMENT_id AND
		INVOICE_DETAILS.ENTRY_TYPE_ID = '14' AND INVOICE.STATUS_ID = '73'
		where Assignment.BUDGET_ID = #{contractBudgetID}
		group by
		ASSIGNMENT.ASSIGNMENT_id,
		REF_VENDOR_V.LGL_NM
		)
		group by
		ID, LGL_NM order by ID desc
	</select>
	
	<select id="fetchAssignmentSummaryForParentBudget" parameterType="com.nyc.hhs.model.CBGridBean"
	resultMap="assignmentInfo">
		select  ID, LGL_NM, sum(YTD_ASSIGNMENT_AMOUNT) AS
		YTD_ASSIGNMENT_AMOUNT from (
		SELECT DISTINCT ASSIGNMENT.ASSIGNMENT_id AS ID,
		REF_VENDOR_V.LGL_NM, NVL(SUM(ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT),'0') AS
		YTD_ASSIGNMENT_AMOUNT
		FROM
		ASSIGNMENT
		INNER JOIN REF_VENDOR_V ON
		REF_VENDOR_V.VEND_CUST_CD = ASSIGNMENT.VEND_CUST_CD
		LEFT JOIN ADVANCE_ASSIGNMENT ON ADVANCE_ASSIGNMENT.ASSIGNMENT_ID =
		ASSIGNMENT.ASSIGNMENT_id
		LEFT JOIN BUDGET_ADVANCE ON BUDGET_ADVANCE.BUDGET_ADVANCE_ID =
		ADVANCE_ASSIGNMENT.BUDGET_ADVANCE_ID
		where Assignment.BUDGET_ID = #{parentBudgetId} AND
		BUDGET_ADVANCE.STATUS_ID = '93'
		group by
		ASSIGNMENT.ASSIGNMENT_id,
		REF_VENDOR_V.LGL_NM,
		ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT
	
		UNION ALL
	
		select distinct ASSIGNMENT.ASSIGNMENT_id AS ID,
		REF_VENDOR_V.LGL_NM, NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),'0') AS YTD_ASSIGNMENT_AMOUNT
		FROM ASSIGNMENT
		INNER JOIN REF_VENDOR_V ON REF_VENDOR_V.VEND_CUST_CD =
		ASSIGNMENT.VEND_CUST_CD
		LEFT JOIN INVOICE ON INVOICE.BUDGET_ID = ASSIGNMENT.BUDGET_ID
		LEFT JOIN INVOICE_DETAILS ON INVOICE_DETAILS.INVOICE_ID =
		INVOICE.INVOICE_ID
		AND INVOICE_DETAILS.LINE_ITEM_ID = ASSIGNMENT.ASSIGNMENT_id AND
		INVOICE_DETAILS.ENTRY_TYPE_ID = '14' AND INVOICE.STATUS_ID = '73'
		where Assignment.BUDGET_ID = #{parentBudgetId}
		group by
		ASSIGNMENT.ASSIGNMENT_id,
		REF_VENDOR_V.LGL_NM
		)
		group by
		ID, LGL_NM order by ID desc
	</select>
	

	<insert id="insertBudgetDocumentDetails" parameterType="java.util.Map">
		INSERT
		INTO Budget_Document
		(BUDGET_DOCUMENT_ID,
		BUDGET_ID,
		CONTRACT_ID,
		CREATED_DATE,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		DOCUMENT_IDENTIFIER_ID,
		CREATED_BY_USERID,
		DOCUMENT_TYPE )
		VALUES
		(SEQ_BUDGET_DOCUMENT_ID.NEXTVAL,
		#{budgetId},
		#{contractId},
		current_timestamp,
		#{DateLastModified},
		#{userId},
		#{documentId},
		#{userId},
		#{DOC_TYPE})
	</insert>

	<insert id="insertInvoiceDocumentDetails" parameterType="java.util.Map">
		INSERT
		INTO Invoice_Document
		(INVOICE_DOCUMENT_ID,
		INVOICE_ID,
		BUDGET_ID,
		CONTRACT_ID,
		CREATED_DATE,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		DOCUMENT_IDENTIFIER_ID,
		CREATED_BY_USERID,
		DOCUMENT_TYPE )
		VALUES
		(SEQ_INVOICE_DOCUMENT_ID.NEXTVAL,
		#{invoiceId},
		#{budgetId},
		#{contractId},
		current_timestamp,
		#{DateLastModified},
		#{userId},
		#{documentId},
		#{userId},
		#{DOC_TYPE})
	</insert>

	<resultMap id="financialsDocsDetails" type="com.nyc.hhs.model.ExtendedDocument">
		<result property="documentType" column="DOCUMENT_TYPE" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdBy" column="CREATED_BY" />
		<result property="documentId" column="DOCUMENT_IDENTIFIER_ID" />
		<result property="organizationType" column="ORGTYPE" />
		<result property="documentSeq" column="DOCUMENT_SEQ" />
		<result property="statusId" column="STATUS" />
		<result property="orgTypeInSession" column="ORG_TYPE_SESSION" />
		<result property="tableName" column="TABLE_NAME" />
	</resultMap>
	<select id="fetchFinancialDocuments" parameterType="java.util.Map"
		resultMap="financialsDocsDetails">
		select CD.DOCUMENT_TYPE,(SELECT STATUS_ID FROM CONTRACT WHERE
		CONTRACT_ID = CD.CONTRACT_ID) AS STATUS,
		TO_CHAR(CD.CREATED_DATE,'MM/DD/YYYY') as CREATED_DATE,
		CD.DOCUMENT_IDENTIFIER_ID, 'agency_org' as ORGTYPE,
		CD.CONTRACT_DOCUMENT_ID as DOCUMENT_SEQ
		,#{organizationType} as
		ORG_TYPE_SESSION,'contract_document' as TABLE_NAME,
		(select
		(CUD.FIRST_NAME ||' '|| CUD.LAST_NAME)
		FROM
		CITY_USER_DETAILS CUD WHERE
		CUD.USER_ID = CD.CREATED_BY_USERID ) AS
		CREATED_BY
		from
		contract_document CD where CD.contract_id = #{contractId}
		<if test="budgetId != null">
			union all select BD.DOCUMENT_TYPE,(SELECT STATUS_ID FROM BUDGET WHERE
			CONTRACT_ID = BD.CONTRACT_ID and BUDGET_ID = BD.BUDGET_ID) AS STATUS,
			TO_CHAR(BD.CREATED_DATE,'MM/DD/YYYY') as CREATED_DATE ,
			BD.DOCUMENT_IDENTIFIER_ID, 'provider_org' as ORGTYPE,
			BD.BUDGET_DOCUMENT_ID as DOCUMENT_SEQ
			,#{organizationType} as
			ORG_TYPE_SESSION,'budget_document' as TABLE_NAME,
			(select (SD.FIRST_NAME ||' '|| SD.LAST_NAME)
			FROM
			STAFF_DETAILS SD WHERE SD.STAFF_ID = BD.CREATED_BY_USERID )
			AS CREATED_BY
			from budget_document BD where budget_id =#{budgetId}
		</if>
		<if test="invoiceId != null">
			union all select INV.DOCUMENT_TYPE,(SELECT STATUS_ID FROM INVOICE WHERE
			CONTRACT_ID = INV.CONTRACT_ID and BUDGET_ID = INV.BUDGET_ID AND
			INVOICE_ID = INV.INVOICE_ID) AS STATUS,
			TO_CHAR(INV.CREATED_DATE,'MM/DD/YYYY') as CREATED_DATE ,
			INV.DOCUMENT_IDENTIFIER_ID, 'provider_org' as ORGTYPE,
			INV.INVOICE_DOCUMENT_ID as DOCUMENT_SEQ
			,#{organizationType} as
			ORG_TYPE_SESSION,'invoice_document' as TABLE_NAME,
			(select (SD.FIRST_NAME ||' '|| SD.LAST_NAME)
			FROM
			STAFF_DETAILS SD WHERE SD.STAFF_ID = INV.CREATED_BY_USERID
			) AS CREATED_BY
			from INVOICE_DOCUMENT INV where invoice_id =#{invoiceId}
		</if>
	</select>
	<!-- Added for R6- Returned payment attached documents -->
	<resultMap id="ReturnedPaymentDocsDetails" type="com.nyc.hhs.model.ExtendedDocument">
		<result property="documentType" column="DOCUMENT_TYPE" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdBy" column="CREATED_BY" />
		<result property="documentId" column="DOCUMENT_IDENTIFIER_ID" />
		<result property="organizationType" column="ORGTYPE" />
		<result property="documentSeq" column="DOCUMENT_SEQ" />
		<result property="statusId" column="STATUS" />
		<result property="orgTypeInSession" column="ORG_TYPE_SESSION" />
		<result property="tableName" column="TABLE_NAME" />
	</resultMap>
	<select id="fetchReturnedPaymentDocuments" parameterType="java.util.Map"
		resultMap="ReturnedPaymentDocsDetails">
		select RPD.DOCUMENT_TYPE,
		(SELECT STATUS_ID FROM RETURN_PAYMENT WHERE
		RETURN_PAYMENT_ID = RPD.RETURN_PAYMENT_ID) AS STATUS,
		TO_CHAR(RPD.CREATED_DATE,'MM/DD/YYYY') as CREATED_DATE,
		RPD.DOCUMENT_IDENTIFIER_ID, 
		'agency_org' as ORGTYPE,
		RPD.RETURN_PAYMENT_DOC_ID as DOCUMENT_SEQ,
		#{organizationType} as ORG_TYPE_SESSION,
		'RETURN_PAYMENT_DOCUMENT' as TABLE_NAME,
		(select (CUD.FIRST_NAME ||' '|| CUD.LAST_NAME)
		FROM CITY_USER_DETAILS CUD WHERE
		CUD.USER_ID = RPD.CREATED_BY_USERID) AS CREATED_BY
		from RETURN_PAYMENT_DOCUMENT RPD 
		where RETURN_PAYMENT_ID =#{returnPaymentDetailId}
	</select>
	<!-- Added for R6- Returned payment attached documents end-->
	<!-- Modified as a part of release 3.12.0 Enhancement  6602-->
	<insert id="insertContractDocumentDetails" parameterType="java.util.Map">
		INSERT
		INTO Contract_Document
		(CONTRACT_DOCUMENT_ID,
		CONTRACT_ID,
		CREATED_DATE,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		DOCUMENT_IDENTIFIER_ID,
		CREATED_BY_USERID,
		DOCUMENT_TYPE,
		NEW_FISCAL_YEAR_ID
		)
		VALUES
		(SEQ_CONTRACT_DOCUMENT_ID.NEXTVAL,
		#{contractId},
		current_timestamp,
		current_timestamp,
		#{userId},
		#{documentId},
		#{userId},
		#{DOC_TYPE},
		#{newFiscalYearId,jdbcType=NUMERIC}
		)
    </insert>

	<delete id="deleteContractFinancialDoc" parameterType="map">
		DELETE
		FROM
		Contract_Document WHERE CONTRACT_DOCUMENT_ID =
		#{asDocumentSequence} AND
		DOCUMENT_IDENTIFIER_ID=#{asDeletedDocumentId}
	</delete>
	<delete id="deleteBudgetFinancialDoc" parameterType="map">
		DELETE FROM
		Budget_Document WHERE BUDGET_DOCUMENT_ID = #{asDocumentSequence} AND
		DOCUMENT_IDENTIFIER_ID=#{asDeletedDocumentId}
	</delete>
	<delete id="deleteInvoiceFinancialDoc" parameterType="map">
		DELETE FROM
		INVOICE_DOCUMENT WHERE INVOICE_DOCUMENT_ID = #{asDocumentSequence} AND
		DOCUMENT_IDENTIFIER_ID=#{asDeletedDocumentId}
	</delete>
	<!-- Added for R6- Delete Returned payment documents -->
	<delete id="deleteReturnedPaymentDoc" parameterType="map">
		DELETE FROM
		RETURN_PAYMENT_DOCUMENT WHERE RETURN_PAYMENT_DOC_ID = #{asDocumentSequence} AND
		DOCUMENT_IDENTIFIER_ID=#{asDeletedDocumentId}
	</delete>
	<!-- Added for R6- Delete Returned payment documents end -->
	

	<resultMap id="UtilitiesDetailsList" type="com.nyc.hhs.model.CBUtilities">
		<result property="id" column="UTILITIES_ID" />
		<result property="utilitiesDesc" column="UTILITIES_TYPE" />
		<result property="fyAmount" column="AMOUNT" />
		<result property="invoiceAmount" column="INVOICE_AMOUNT" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="lineItemModifiedAmt" column="MODIFIED_AMOUNT" />
		<result property="utilitiesTypeID" column="UTILITIES_TYPE_ID" />
	</resultMap>

	<select id="fetchUtilitiesDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UtilitiesDetailsList">

		select util.UTILITIES_ID, util_mstr.UTILITIES_TYPE,
		util.AMOUNT,
		SUM(CASE WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) as INVOICE_AMOUNT,
		'0' AS
		REMAINING_AMOUNT

		from UTILITIES util

		left join INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID = util.UTILITIES_ID
		AND
		inv_det.ENTRY_TYPE_ID =
		'3'

		inner join UTILITIES_TYPE_MASTER util_mstr
		ON
		util_mstr.UTILITIES_TYPE_ID = util.UTILITIES_TYPE_ID

		left join INVOICE
		inv
		ON
		inv.INVOICE_ID = inv_det.INVOICE_ID
		AND
		inv.STATUS_ID IN
		('72','73')

		where
		util.BUDGET_ID = #{contractBudgetID}
		AND
		util.SUB_BUDGET_ID = #{subBudgetID}
		group by
		util.UTILITIES_ID
		,util.AMOUNT, util_mstr.UTILITIES_TYPE
		order
		by util.UTILITIES_ID

	</select>

	<select id="fetchUtilitiesTypeDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UtilitiesDetailsList">
		select UTILITIES_TYPE, UTILITIES_TYPE_ID from
		UTILITIES_TYPE_MASTER
		order by UTILITIES_TYPE_ID
	</select>

	<update id="updateUtilitiesDetails" parameterType="com.nyc.hhs.model.CBUtilities">
		update
		UTILITIES
		set
		AMOUNT = #{fyAmount},
		MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID =
		#{modifyByAgency},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider}
		where
		UTILITIES_ID = #{id}
	</update>

	<insert id="insertUtilitiesDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		INSERT INTO
		UTILITIES(
		UTILITIES_ID,
		UTILITIES_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID
		)
		VALUES(
		SEQ_UTILITIES_ID.nextval ,
		#{utilitiesTypeID},
		#{contractBudgetID} ,
		#{subBudgetID} ,
		SEQ_UTILITIES_ID.currval,
		#{fyAmount},
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider}
		)
	</insert>

	<select id="fetchUtilitiesModifyDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="UtilitiesDetailsList">

		SELECT UTILITIES_TYPE,
		SUM(APPROVED_FY_BUDGET) AS AMOUNT ,
		SUM(remaining_amount) AS REMAINING_AMOUNT,
		SUM(mod_amount)
		AS
		MODIFIED_AMOUNT,
		parent_id AS UTILITIES_ID
		FROM
		(
		SELECT
		util_mstr.UTILITIES_TYPE,
		a.AMOUNT AS APPROVED_FY_BUDGET ,
		(a.AMOUNT -
		SUM(
		CASE
		WHEN inv.STATUS_ID IS NOT NULL
		THEN
		NVL(inv_det.INVOICE_AMOUNT,0)
		ELSE 0
		END ) ) AS remaining_amount,
		0 AS
		mod_amount,
		a.parent_id
		FROM UTILITIES a
		LEFT JOIN INVOICE_DETAILS
		inv_det
		ON inv_det.ENTRY_TYPE_ID = #{entryTypeId}
		and
		inv_det.LINE_ITEM_ID = a.parent_id
		inner join UTILITIES_TYPE_MASTER
		util_mstr
		ON
		util_mstr.UTILITIES_TYPE_ID =
		a.UTILITIES_TYPE_ID
		LEFT JOIN
		INVOICE inv
		ON inv.INVOICE_ID = inv_det.INVOICE_ID
		AND inv.STATUS_ID IN
		(72,73)
		WHERE a.BUDGET_ID = #{parentBudgetId}
		AND a.SUB_BUDGET_ID =
		#{parentSubBudgetId}
		GROUP BY a.AMOUNT,
		a.parent_id,
		util_mstr.UTILITIES_TYPE

		UNION ALL

		SELECT util_mstr.UTILITIES_TYPE,
		0 AS
		APPROVED_FY_BUDGET ,
		0 AS
		remaining_amount,
		a.AMOUNT AS mod_amount,
		a.parent_id
		FROM UTILITIES a
		inner join UTILITIES_TYPE_MASTER util_mstr
		ON
		util_mstr.UTILITIES_TYPE_ID =
		a.UTILITIES_TYPE_ID
		WHERE a.BUDGET_ID =
		#{contractBudgetID}
		AND a.SUB_BUDGET_ID =
		#{subBudgetID}
		GROUP BY
		a.AMOUNT,
		a.parent_id,
		util_mstr.UTILITIES_TYPE
		)
		GROUP BY
		parent_id,UTILITIES_TYPE
		ORDER BY
		parent_id
		
	</select>

	<update id="updateUtilitiesModifyDetails" parameterType="com.nyc.hhs.model.CBUtilities">
		update
		UTILITIES
		set
		AMOUNT = #{lineItemModifiedAmt},
		MODIFIED_DATE =
		SYSTIMESTAMP,
		MODIFIED_BY_USERID =
		#{modifyByAgency},
		MODIFIED_BY_STAFFID =
		#{modifyByProvider}
		where
		PARENT_ID = #{id}
		AND
		BUDGET_ID = #{contractBudgetID}
		AND
		SUB_BUDGET_ID = #{subBudgetID}

	</update>

	<insert id="insertUtilitiesModifyDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		INSERT
		INTO
		UTILITIES(
		UTILITIES_ID,
		UTILITIES_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		PREV_APPROVED_BUDGET
		)
		VALUES(
		SEQ_UTILITIES_ID.nextval ,
		#{utilitiesTypeID},
		#{contractBudgetID} ,
		#{subBudgetID} ,
		#{id},
		#{lineItemModifiedAmt},
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency} ,
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{modifyByProvider},
		#{modifyByProvider},
		#{prevApprovedBudget}
		)
	</insert>

	<select id="fetchUtilitiesTypeId" parameterType="java.lang.String"
		resultType="String">
		select UTILITIES_TYPE_ID from
		UTILITIES
		where PARENT_ID =
		#{id}
		and rownum = 1
	</select>

	<select id="fetchApprovedBudgetAmnt" parameterType="java.lang.String"
		resultType="String">
		select AMOUNT from
		UTILITIES
		where UTILITIES_ID = #{id}
	</select>

	<select id="fetchUtilitiesDetailsForValidation" parameterType="String"
		resultMap="UtilitiesDetailsList">
		SELECT
		(util.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
		NULL
		THEN
		inv_det.INVOICE_AMOUNT
		ELSE 0
		END ))) as REMAINING_AMOUNT

		FROM
		UTILITIES util

		LEFT JOIN
		INVOICE_DETAILS inv_det
		ON
		inv_det.LINE_ITEM_ID =
		util.UTILITIES_ID
		AND
		inv_det.ENTRY_TYPE_ID = '3'

		LEFT JOIN INVOICE inv
		ON
		inv.INVOICE_ID = inv_det.INVOICE_ID
		AND
		inv.STATUS_ID IN
		 <!--Start QC 9206 R 7.7.1 - change status '71' to '73' ('71','72') -->  
		('73','72')
        <!--End QC 9206 R 7.7.1 - change status '71' to '73' ('71','72') -->
		WHERE
		util.UTILITIES_ID = #{asId}
		GROUP BY
		util.AMOUNT
		ORDER BY
		util.UTILITIES_ID
	</select>

	<resultMap id="CBOperationSupportBeanList" type="com.nyc.hhs.model.CBOperationSupportBean">
		<result property="id" column="LINE_ITEM_ID" />
		<result property="id" column="OPERATIONS_SUPPORT_TYPE_ID" />
		<result property="opAndSupportName" column="OP_SUPPRT_NAME" />
		<result property="fyBudget" column="FY_BUDGET" />
		<result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
	</resultMap>

	<select id="fetchOpAndSupportPageData" resultMap="CBOperationSupportBeanList">
		Select
		sum(total) as FY_BUDGET, sum(invoiceAmount) as INVOICE_AMOUNT
		from((select sum(a.amount) as total,sum(invoiceAmount) as
		invoiceAmount from operations_and_support a left join
		(select distinct
		b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, operations_and_support d where
		c.invoice_id = b.invoice_id and
		c.status_id IN ('72','73') and
		b.entry_type_id ='2'
		and d.sub_budget_id=b.sub_budget_id and
		b.line_item_id =
		d.operations_support_id and
		c.budget_id=#{contractBudgetID}
		group by b.line_item_id) b ON
		b.line_item_id = a.operations_support_id
		where
		a.sub_budget_id=#{subBudgetID} and
		a.budget_id=#{contractBudgetID})
		union all
		(select sum(a.amount) as total,sum(invoiceAmount) as
		invoiceAmount from equipment a left join
		(select distinct
		b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, equipment d where c.invoice_id =
		b.invoice_id and
		c.status_id IN ('72','73') and b.entry_type_id ='12'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.equipment_id and c.budget_id=#{contractBudgetID}
		group by
		b.line_item_id) b ON b.line_item_id = a.equipment_id
		where
		a.sub_budget_id=#{subBudgetID} and
		a.budget_id=#{contractBudgetID}))
	</select>

	<insert id="insertStandardRowsOperationSupport" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
		INSERT INTO OPERATIONS_AND_SUPPORT(
		OPERATIONS_SUPPORT_ID,
		OPERATIONS_SUPPORT_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		ACTIVE_FLAG)
		VALUES(
		SEQ_OPERATIONS_SUPPORT_ID.nextval,
		#{id},
		#{contractBudgetID},
		#{subBudgetID},
		SEQ_OPERATIONS_SUPPORT_ID.currval,
		#{fyBudget},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		'1')
	</insert>

	<resultMap id="BudgetDetailsCBGridBean" type="com.nyc.hhs.model.CBGridBean">
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
	</resultMap>

	<select id="fetchSubBudgetIDList" resultMap="BudgetDetailsCBGridBean"
		parameterType="java.util.Map">
		select 
			budget_id, 
			sub_budget_id 
		from 
			sub_budget
		where
			budget_id in (select budget_id from budget where fiscal_year_id = #{fiscalYearId}
		and contract_id = #{contractId})	
		and sub_budget_id = parent_id
		and active_flag = '1'
	</select>

	<select id="fetchOperationSupportItemsCount" resultType="Integer"
		parameterType="java.lang.String">
		select count(1) from OPERATIONS_AND_SUPPORT where
		sub_budget_id = #{asSubBudgetId}
	</select>

	<select id="fetchOperationSuppMasterList" resultMap="CBOperationSupportBeanList">
		select
		OPERATIONS_SUPPORT_TYPE_ID
		from OPERATIONS_SUPPORT_TYPE_MASTER where
		ACTIVE_FLAG = '1'
	</select>

	<select id="fetchOperationAndSupportDetails" resultMap="CBOperationSupportBeanList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT
		OAS.OPERATIONS_SUPPORT_ID AS LINE_ITEM_ID,
		CASE
		WHEN other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE
		OSTM.OPERATIONS_SUPPORT_TYPE
		END AS OP_SUPPRT_NAME,
		NVL(OAS.AMOUNT,0) AS
		FY_BUDGET,
		SUM(CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INVD.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT
		FROM
		OPERATIONS_SUPPORT_TYPE_MASTER OSTM
		LEFT JOIN
		OPERATIONS_AND_SUPPORT OAS
		ON
		OSTM.OPERATIONS_SUPPORT_TYPE_ID = OAS.OPERATIONS_SUPPORT_TYPE_ID
		AND
		OAS.SUB_BUDGET_ID = #{subBudgetID}
		AND
		OAS.BUDGET_ID =
		#{contractBudgetID}
		LEFT JOIN
		INVOICE_DETAILS INVD
		ON
		OAS.OPERATIONS_SUPPORT_ID = INVD.LINE_ITEM_ID
		AND
		INVD.ENTRY_TYPE_ID = 2
		AND
		OAS.SUB_BUDGET_ID = #{subBudgetID}
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id = invd.invoice_id
		AND
		invvv.status_id IN ('72','73')
		LEFT JOIN
		OTHER_DETAILS OTHER
		ON
		OTHER.ENTITY_ID =
		OAS.OPERATIONS_SUPPORT_ID
		AND
		OTHER.ENTRY_TYPE_ID = 2
		AND
		OTHER.ACTIVE_FLAG = '1'
		WHERE
		OSTM.ACTIVE_FLAG = 1
		GROUP BY
		OSTM.OPERATIONS_SUPPORT_TYPE_ID,
		OAS.OPERATIONS_SUPPORT_ID,
		(CASE
		WHEN
		other.ENTITY_NAME IS NOT NULL
		THEN other.ENTITY_NAME
		ELSE
		OSTM.OPERATIONS_SUPPORT_TYPE
		END),
		OAS.AMOUNT
		ORDER BY
		OSTM.OPERATIONS_SUPPORT_TYPE_ID
	</select>

	<update id="editOperationAndSupportDetails" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
		update OPERATIONS_AND_SUPPORT
		set
		AMOUNT = #{fyBudget},
		MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		where
		OPERATIONS_SUPPORT_ID =
		#{id}
	</update>

	<select id="fetchOpAndSupprtForOther" parameterType="java.lang.Integer"
		resultType="java.lang.Integer">
		select
		count(other.ENTITY_ID)
		from
		OPERATIONS_AND_SUPPORT OPS
		inner join
		OTHER_DETAILS other
		on other.ENTITY_ID = OPS.OPERATIONS_SUPPORT_ID
		and
		other.ENTRY_TYPE_ID = 2
		Where other.ENTITY_ID = #{id}
    </select>

	<insert id="addOpAndSupprtForOther" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
		Insert into
		OTHER_DETAILS(
		OTHER_DETAILS_ID,
		ENTITY_ID,
		ENTRY_TYPE_ID,
		ENTITY_NAME,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID)
		values(
		SEQ_OTHER_DETAILS_ID.nextval,
		#{id},
		(select ENTRY_TYPE_ID from ENTRY_TYPE_MASTER where 
		ENTRY_TYPE = 'Operations and Support'),
		#{opAndSupportName},
		'1',
		SYSTIMESTAMP,
		#{modifiedByUserId},
		SYSTIMESTAMP,
		#{modifiedByUserId})
	</insert>

	<update id="updateOpAndSupprtForOther" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
		update
		OTHER_DETAILS
		set
		ENTITY_NAME = #{opAndSupportName},
		MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifiedByUserId}
		where
		ENTITY_ID = #{id}
		and ENTRY_TYPE_ID = (select ENTRY_TYPE_ID from
		ENTRY_TYPE_MASTER where ENTRY_TYPE = 'Operations and Support')
	</update>

	<resultMap id="CBEquipmentBeanList" type="com.nyc.hhs.model.CBEquipmentBean">
		<result property="id" column="EQUIPMENT_ID" />
		<result property="equipment" column="EQUIPMENT_NAME" />
		<result property="units" column="UNITS" />
		<result property="fyBudget" column="FY_BUDGET" />
		<result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
	</resultMap>

	<select id="fetchEquipmentDetails" resultMap="CBEquipmentBeanList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		select
		eqp.EQUIPMENT_ID,
		eqp.EQUIPMENT_NAME,
		eqp.UNITS,
		eqp.AMOUNT AS FY_BUDGET,
		SUM(CASE
		WHEN INVVV.STATUS_ID IS NOT NULL
		THEN
		NVL(INV.INVOICE_AMOUNT,0)
		ELSE 0
		END ) AS INVOICE_AMOUNT
		from
		EQUIPMENT
		eqp
		LEFT JOIN
		INVOICE_DETAILS inv
		ON
		eqp.EQUIPMENT_ID = inv.LINE_ITEM_ID
		AND
		inv.ENTRY_TYPE_ID = 12
		LEFT JOIN
		INVOICE INVVV
		ON
		invvv.invoice_id =
		inv.invoice_id
		AND
		invvv.status_id IN ('72','73')
		WHERE
		eqp.BUDGET_ID =
		#{contractBudgetID}
		AND eqp.SUB_BUDGET_ID = #{subBudgetID}
		AND
		eqp.active_flag = 1
		GROUP BY
		eqp.EQUIPMENT_ID,
		eqp.EQUIPMENT_NAME,
		eqp.UNITS,
		eqp.AMOUNT
		order by eqp.EQUIPMENT_ID DESC
	</select>

	<insert id="addEquipmentDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		INSERT INTO
		EQUIPMENT(
		EQUIPMENT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		EQUIPMENT_NAME,
		UNITS,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		PARENT_ID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		VALUES(
		SEQ_EQUIPMENT_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{equipment},
		#{units},
		#{fyBudget},
		SYSTIMESTAMP,
		#{modifyByAgency},
		SYSTIMESTAMP,
		#{modifyByAgency},
		'1',
		SEQ_EQUIPMENT_ID.currval,
		#{modifyByProvider},
		#{modifyByProvider}
		)
	</insert>

	<update id="editEquipmentDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		update EQUIPMENT
		set
		EQUIPMENT_NAME = #{equipment},
		UNITS = #{units},
		AMOUNT =
		#{fyBudget},
		MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_STAFFID =
		#{modifyByProvider},
		MODIFIED_BY_USERID = #{modifyByAgency}
		where
		EQUIPMENT_ID = #{id}
	</update>

	<delete id="deleteEquipmentDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
		delete from
		EQUIPMENT
		where
		EQUIPMENT_ID = PARENT_ID
		AND EQUIPMENT_ID = #{id}
	</delete>

	<!-- build 2.6.0, defect id 5683 -->
	<update id="setContractBudgetStatus" parameterType="hashmap">
		UPDATE BUDGET
		SET
		PREV_STATUS_ID  = STATUS_ID, STATUS_ID = #{asStatusId},MODIFIED_BY_STAFFID= #{submittedBy},
		MODIFIED_DATE = SYSTIMESTAMP
		WHERE
		BUDGET_ID = #{budgetId} 
	</update>

	<select id="getAmendmentBudgetsCount" parameterType="hashmap" resultType="java.util.HashMap">
		SELECT SUM(bud_pend_approval_count) AS bud_pend_approval_count,
		  SUM(tot_bud_count)                AS tot_bud_count
		FROM
		  (SELECT count(1) AS bud_pend_approval_count,
		    0              AS tot_bud_count
		  FROM budget
		  WHERE contract_id = #{contractId}
		  AND status_id     in ( '82','86')
		  UNION ALL
		  SELECT 0   AS bud_pend_approval_count,
		    count(1) AS tot_bud_count
		  FROM budget
		  WHERE contract_id = #{contractId}
		  <!-- release 3.14.0 -->
		   and status_id !=106
		  <!-- release 3.14.0 -->
		  )
	</select>

	<update id="setAmendmentContractStatusPendingApproval" parameterType="hashmap">
		UPDATE CONTRACT
		SET STATUS_ID        = '129',
		  MODIFIED_DATE      = SYSTIMESTAMP
		WHERE CONTRACT_ID    = #{contractId}
	</update>
	<!-- Queries for Contract budget - Program Income Starts -->

	<resultMap id="programIncomeList" type="com.nyc.hhs.model.CBProgramIncomeBean">
		<result property="id" column="PROGRAM_INCOME_ID" />
		<result property="programTitle" column="PROGRAM_TITLE" />
		<result property="fYBudget" column="AMOUNT" />
		<result property="income" column="INCOME" />
		<result property="remainingAmount" column="REMAINING_AMOUNT" />
		<!--   Added in R7  -->
		<result property="entryTypeId" column="ENTRY_TYPE_ID" />
		<result property="description" column="DESCRIPTION" />
		<result property="empPosition" column="PROGRAM_TITLE" />
		<result property="budgetCategory" column="Entry_type" />
		<!--  R7 changes end  -->
	</resultMap>

	<select id="fetchProgramIncome" parameterType="com.nyc.hhs.model.CBProgramIncomeBean"
		resultMap="programIncomeList">

		SELECT
		PI.PROGRAM_INCOME_ID AS PROGRAM_INCOME_ID,
		PI.PROGRAM_INCOME_TYPE_ID AS PROGRAM_INCOME_TYPE_ID,
		PI.BUDGET_ID AS
		BUDGET_ID,
		<!--   Added in R7  -->
		PI.ENTRY_TYPE_ID,
		PI.DESCRIPTION,
		decode(Entry_type,'Personnel Service Salary','Personnel Services',Entry_type) as Entry_type,
		<!--  R7 changes end  -->
		PI.SUB_BUDGET_ID AS SUB_BUDGET_ID,
		CASE
		WHEN OTHER.ENTITY_NAME
		IS NOT NULL THEN OTHER.ENTITY_NAME
		ELSE PIT.PROGRAM_INCOME_TYPE
		END
		as
		PROGRAM_TITLE,
		nvl(PI.AMOUNT,'0') AS AMOUNT ,
		(nvl(invoicedetail.INVOICE_AMOUNT,'0')) as INCOME,
		nvl(PI.AMOUNT,'0') -
		nvl(invoicedetail.INVOICE_AMOUNT,'0')
		as REMAINING_AMOUNT
		from
		PROGRAM_INCOME_TYPE PIT
		inner join
		PROGRAM_INCOME PI on
		PI.PROGRAM_INCOME_TYPE_ID =
		PIT.PROGRAM_INCOME_TYPE_ID and
		PI.active_flag = '1'
		<!--   Added in R7  -->
		<if test="null!= entryTypeId">
		AND PI.ENTRY_TYPE_ID=#{entryTypeId}
		</if>
		LEFT JOIN ENTRY_TYPE_MASTER etm
        ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
		<!--  R7 changes end  -->
		left outer join
		OTHER_DETAILS OTHER on
		OTHER.ENTITY_ID = PI.PROGRAM_INCOME_ID and
		OTHER.ENTRY_TYPE_ID = 11 and
		OTHER.active_flag = '1'
		left outer join (select entry_type_id,
		line_item_id, sum(invoice_amount)
		as INVOICE_AMOUNT
		from INVOICE_DETAILS
		where INVOICE_ID IN
		(select invoice_id from INVOICE where BUDGET_ID =
		#{contractBudgetID} and
		SUB_BUDGET_ID = #{subBudgetID} and CONTRACT_ID
		= #{contractID} and
		STATUS_ID in (72,73)) and ENTRY_TYPE_ID = 11
		group
		by entry_type_id, line_item_id) invoicedetail on
		invoicedetail.entry_type_id = 11
		and invoicedetail.line_item_id =
		PI.PROGRAM_INCOME_ID
		where
		PI.SUB_BUDGET_ID = #{subBudgetID} and
		PI.BUDGET_ID =
		#{contractBudgetID} AND PI.ACTIVE_FLAG=1
		order by
		PI.ENTRY_TYPE_ID,PIT.PROGRAM_INCOME_TYPE_ID	
	 </select>

	<insert id="insertProgramIncome" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		Insert into
		PROGRAM_INCOME
		(
		PROGRAM_INCOME_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PROGRAM_INCOME_TYPE_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG
		)
		values
		(
		SEQ_PROGRAM_INCOME_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{programIncomeTypeId},
		SEQ_PROGRAM_INCOME_ID.currval,
		0,
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{activeFlag}
		)
	</insert>

	<update id="updateProgramIncome" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		update
		PROGRAM_INCOME set AMOUNT = #{fYBudget},
		<!-- Updated in R7 for new columns in Program_income table -->
		<if test="entryTypeId != null and entryTypeId != '' ">
		PROGRAM_INCOME_TYPE_ID= #{empPosition},
		description= #{description},
		</if>
		<!-- R7 changes end -->
		MODIFIED_DATE =SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifyByAgency,jdbcType=VARCHAR},
		MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		where
		PROGRAM_INCOME_ID = #{id}
	</update>

	<resultMap id="programIncomeMasterTypesList" type="com.nyc.hhs.model.CBProgramIncomeBean">
		<result property="programIncomeTypeId" column="PROGRAM_INCOME_TYPE_ID" />
		<result property="programTitle" column="PROGRAM_INCOME_TYPE" />
	</resultMap>

	<select id="fetchProgramIncomeMasterTypes" parameterType="com.nyc.hhs.model.CBProgramIncomeBean"
		resultMap="programIncomeMasterTypesList">
		SELECT PROGRAM_INCOME_TYPE_ID, PROGRAM_INCOME_TYPE FROM
		PROGRAM_INCOME_TYPE WHERE ACTIVE_FLAG=1
		ORDER BY PROGRAM_INCOME_TYPE_ID
		DESC
	 </select>

	<select id="fetchProgramIncomeForOther" parameterType="java.lang.Integer"
		resultType="java.lang.Integer">
		select count(other.ENTITY_ID)
		from PROGRAM_INCOME PI
		inner join OTHER_DETAILS
		other on other.ENTITY_ID = PI.PROGRAM_INCOME_ID
		Where PI.ACTIVE_FLAG=1 AND other.ACTIVE_FLAG=1 and other.ENTRY_TYPE_ID = 11
		AND other.ENTITY_ID = #{aoProgramIncomeId}		
    </select>

	<select id="fetchCountractBudgetCountForFY" parameterType="HashMap" resultType="java.lang.Integer">
		SELECT COUNT(BUDGET_ID) from BUDGET WHERE CONTRACT_ID = #{asContractId}  AND FISCAL_YEAR_ID &gt;=#{asFiscalYearId} and active_flag = '1' and delete_flag = '0'
    </select>    

	<insert id="addProgramIncomeForOther" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		Insert into
		OTHER_DETAILS
		(OTHER_DETAILS_ID,
		ENTITY_ID,
		ENTRY_TYPE_ID,
		ENTITY_NAME,
		ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID
		)
		values
		(SEQ_OTHER_DETAILS_ID.nextval,
		#{id},
		11,
		#{programTitle},
		#{activeFlag},
		SYSTIMESTAMP,
		#{modifyByProvider,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByProvider,jdbcType=VARCHAR}
		)
	</insert>

	<update id="updateProgramIncomeForOther" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		UPDATE
		OTHER_DETAILS set ENTITY_NAME = #{programTitle}, MODIFIED_DATE =
		SYSTIMESTAMP, MODIFIED_BY_USERID =
		#{modifyByProvider,jdbcType=VARCHAR} WHERE ENTRY_TYPE_ID = 11 AND
		ENTITY_ID = #{id}
	</update>

	<!-- Queries for Contract budget - Program Income Ends -->

	<resultMap id="SalariedEmployeeList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="PERSONNEL_SERVICE_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="empPosition" column="POSITION" />
		<result property="unit" column="UNITS" />
		<result property="budgetAmount" column="TOTAL_SALARY" />
		<result property="invoicedAmount" column="AMOUNT" />
		<result property="remainingAmount" column="RemainingAmount" />
	</resultMap>
	<select id="fetchSalariedEmployee" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeList">
		select Personnel_Service_Id,Budget_Id,Sub_Budget_Id,Position, Units,
		Total_Salary,AMOUNT,Total_Salary-AMOUNT as RemainingAmount from (
		Select Distinct A.Personnel_Service_Id,
		A.Budget_Id,A.Sub_Budget_Id,A.Position, A.Units, A.Total_Salary,
		SUM(Decode(status_id,72,A.Amount,73,A.Amount,NULL,0,0)) over(partition
		by Personnel_Service_Id) Amount,A.Created_Date
		from(
		select ps.personnel_service_id, ps.budget_id,
		Ps.Sub_Budget_Id,Pos.Position,
		Ps.Units, Ps.Total_Salary,
		NVL(inv.INVOICE_AMOUNT,0 ) as AMOUNT,
		inv.INVOICE_ID, Ps.Created_Date
		FROM PERSONNEL_SERVICE ps left outer
		join INVOICE_DETAILS inv
		ON ps.PERSONNEL_SERVICE_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 1
		Inner Join Position Pos On Ps.Position_Id =
		Pos.Position_Id
		WHERE
		Ps.Personnel_Service_Type_Id = 1
		AND ps.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And Ps.Active_Flag =
		1
		order by Ps.Created_Date desc
		) A
		Left Outer Join Invoice Invvv
		On A.Invoice_Id = Invvv.Invoice_Id
		order by A.Created_Date desc)     
		
	</select>
	<insert id="insertPersonnelServices" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,
		PERSONNEL_SERVICE_TYPE_ID,
		POSITION_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNITS,
		TOTAL_SALARY,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		VALUES
		(SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,
		#{empType,jdbcType=VARCHAR},
		#{empPosition,jdbcType=VARCHAR},
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		SEQ_PERSONNEL_SERVICES_ID.currval,
		#{unit,jdbcType=VARCHAR},
		#{budgetAmount,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR})
	</insert>

	<update id="updatePersonnelServices" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		update
		personnel_service set position_id = #{empPosition},units =
		#{unit},total_salary = #{budgetAmount}, modified_date =
		current_timestamp, modified_by_userid =
		#{modifyByAgency,jdbcType=VARCHAR},MODIFIED_BY_STAFFID =
		#{modifyByProvider,jdbcType=VARCHAR}
		where personnel_service_id = #{id}
	</update>

	<delete id="deletePersonnelServices" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		DELETE FROM
		personnel_service where personnel_service_id = #{id}
	</delete>

	<select id="fetchHourlyEmployee" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeList">

		select Personnel_Service_Id,Budget_Id,Sub_Budget_Id,Position, Units,
		Total_Salary,AMOUNT,Total_Salary-AMOUNT as RemainingAmount from (
		Select Distinct A.Personnel_Service_Id,
		A.Budget_Id,A.Sub_Budget_Id,A.Position, A.Units, A.Total_Salary,
		SUM(Decode(status_id,72,A.Amount,73,A.Amount,NULL,0,0)) over(partition
		by Personnel_Service_Id) Amount,A.Created_Date
		from(
		select ps.personnel_service_id, ps.budget_id,
		Ps.Sub_Budget_Id,Pos.Position,
		Ps.Units, Ps.Total_Salary,
		NVL(inv.INVOICE_AMOUNT,0 ) as AMOUNT,
		inv.INVOICE_ID, Ps.Created_Date
		FROM PERSONNEL_SERVICE ps left outer
		join INVOICE_DETAILS inv
		ON ps.PERSONNEL_SERVICE_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 1
		Inner Join Position Pos On Ps.Position_Id =
		Pos.Position_Id
		WHERE
		Ps.Personnel_Service_Type_Id = 2
		AND ps.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And Ps.Active_Flag =
		1
		order by Ps.Created_Date desc
		) A
		Left Outer Join Invoice Invvv
		On A.Invoice_Id = Invvv.Invoice_Id
		order by A.Created_Date desc)                        	
	</select>

	<select id="fetchSeasonalEmployee" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="SalariedEmployeeList">
		select Personnel_Service_Id,Budget_Id,Sub_Budget_Id,Position, Units,
		Total_Salary,AMOUNT,Total_Salary-AMOUNT as RemainingAmount from (
		Select Distinct A.Personnel_Service_Id,
		A.Budget_Id,A.Sub_Budget_Id,A.Position, A.Units, A.Total_Salary,
		SUM(Decode(status_id,72,A.Amount,73,A.Amount,NULL,0,0)) over(partition
		by Personnel_Service_Id) Amount,A.Created_Date
		from(
		select ps.personnel_service_id, ps.budget_id,
		Ps.Sub_Budget_Id,Pos.Position,
		Ps.Units, Ps.Total_Salary,
		NVL(inv.INVOICE_AMOUNT,0 ) as AMOUNT,
		inv.INVOICE_ID, Ps.Created_Date
		FROM PERSONNEL_SERVICE ps left outer
		join INVOICE_DETAILS inv
		ON ps.PERSONNEL_SERVICE_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 1
		Inner Join Position Pos On Ps.Position_Id =
		Pos.Position_Id
		WHERE
		Ps.Personnel_Service_Type_Id = 3
		AND ps.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Ps.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And Ps.Active_Flag =
		1
		order by Ps.Created_Date desc
		) A
		Left Outer Join Invoice Invvv
		On A.Invoice_Id = Invvv.Invoice_Id
		order by A.Created_Date desc)                	
	</select>

	<resultMap id="FringeBenifitsList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="FRINGE_BENEFIT_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="budgetAmount" column="AMOUNT" />
		<result property="invoicedAmount" column="INVOICED_AMOUNT" />
		<result property="remainingAmount" column="RemainingAmount" />
	</resultMap>

	<select id="fetchFringBenifits" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="FringeBenifitsList">
		Select Fringe_Benefit_Id,
		Budget_Id,Sub_Budget_Id,Amount,INVOICED_AMOUNT,Amount-INVOICED_AMOUNT
		as RemainingAmount from(
		Select distinct A.Fringe_Benefit_Id, A.Budget_Id,A.Sub_Budget_Id,A.Amount,
		SUM(Decode(status_id,72,A.INVOICED_AMOUNT,73,A.INVOICED_AMOUNT,NULL,0,0))
		over(partition by Fringe_Benefit_Id) INVOICED_AMOUNT
		from(
		Select Fb.Fringe_Benefit_Id, Fb.Budget_Id, Fb.Sub_Budget_Id,
		fb.AMOUNT,
		NVL(inv.INVOICE_AMOUNT,0) as INVOICED_AMOUNT, inv.INVOICE_ID
		from
		FRINGE_BENEFIT fb
		LEFT OUTER JOIN INVOICE_DETAILS inv ON
		fb.FRINGE_BENEFIT_ID = inv.LINE_ITEM_ID
		And Inv.Entry_Type_Id = 13
		Where
		Fb.Budget_Id = #{contractBudgetID,jdbcType=VARCHAR}
		And
		Fb.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		) A
		Left Outer Join Invoice Invvv
		On A.Invoice_Id = Invvv.Invoice_Id)          
                
	</select>

	<update id="updateFringeBenifits" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		update
		fringe_benefit set amount = #{budgetAmount}, modified_date =
		current_timestamp, modified_by_userid =
		#{modifyByAgency,jdbcType=VARCHAR},MODIFIED_BY_STAFFID =
		#{modifyByProvider,jdbcType=VARCHAR}
		where FRINGE_BENEFIT_ID = #{id}
	</update>

	<insert id="insertFringeBenifits" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		FRINGE_BENEFIT
		(FRINGE_BENEFIT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		AMOUNT,
		FRINGE_PERCENT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		VALUES
		(SEQ_FRINGE_BENEFIT_ID.NEXTVAL,
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		#{budgetAmount,jdbcType=VARCHAR},
		'0',
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSDATE,
		#{modifyByAgency,jdbcType=VARCHAR},SEQ_FRINGE_BENEFIT_ID.currval,'1',
		#{modifyByProvider,jdbcType=VARCHAR},#{modifyByProvider,jdbcType=VARCHAR})
	</insert>

	<select id="fetchTotalSalary" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="String">
		select NVL(SUM(TOTAL_SALARY),0)
		from personnel_service
		where
		budget_id = #{contractBudgetID,jdbcType=VARCHAR}
		and sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR}
		and PERSONNEL_SERVICE_TYPE_ID in(
		'1','2','3')
	</select>

	<select id="fetchTotalFringes" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="String">
		select NVL(AMOUNT,0)
		from FRINGE_BENEFIT
		where budget_id =
		#{contractBudgetID,jdbcType=VARCHAR}
		and sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR}
	</select>

	<select id="fetchSalariedYTDInvoicedAmount" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="BigDecimal">
		SELECT NVL(SUM(inv.invoice_amount),0)
		FROM invoice_details inv,
		PERSONNEL_SERVICE ps
		WHERE inv.line_item_id = ps.PERSONNEL_SERVICE_ID
		AND inv.entry_type_id = '1'
		AND ps.PERSONNEL_SERVICE_TYPE_ID in( '1','2','3')
		AND ps.budget_id = #{contractBudgetID}
		AND ps.sub_budget_id = #{subBudgetID}
		AND inv.invoice_id IN
		(
		SELECT invoice_id
		FROM invoice a
		WHERE a.status_id IN('72','73')
		AND a.budget_id = #{contractBudgetID}
		)
	</select>

	<select id="fetchFringesYTDInvoicedAmount" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="BigDecimal">
		SELECT NVL(SUM(inv.invoice_amount),0)
		FROM invoice_details inv,
		FRINGE_BENEFIT fb
		WHERE inv.line_item_id = fb.FRINGE_BENEFIT_ID
		AND inv.entry_type_id = '13'
		AND fb.budget_id = #{contractBudgetID}
		AND fb.sub_budget_id = #{subBudgetID}
		AND inv.invoice_id IN
		(
		SELECT invoice_id
		FROM invoice a
		WHERE a.status_id IN('72','73')
		AND a.budget_id = #{contractBudgetID}
		)
	</select>
	<select id="fetchPersonnelServiceMasterData" parameterType="string"
		resultType="string">
		select POSITION_ID||':'||POSITION from POSITION order by
		LOWER(POSITION)
	</select>


	<select id="fetchSubBudgetSummaryPrint" parameterType="hashmap"
		resultMap="fetchInfo">
		SELECT SUB_BUDGET_ID,
		SUB_BUDGET_NAME,
		SUB_BUDGET_AMOUNT
		FROM
		SUB_BUDGET
		WHERE BUDGET_ID = #{budgetId} AND
		SUB_BUDGET_ID = #{subBudgetId} AND
		ACTIVE_FLAG = '1'
	</select>
	
	
	<select id="fetchAmendmentFiscialEpinDetails" parameterType="hashmap"
		resultMap="contractInfo">
		SELECT a.contract_title as PROCUREMENT_TITLE,
		a.ext_epin as AWRDEPIN,
		b.fiscal_year_id
		FROM contract a,
		budget b
		WHERE a.contract_id = #{contractId}
		AND b.budget_id = #{budgetId}
		AND a.contract_id = b.contract_id
	</select>
	
	<!-- build 2.6.0, defect id 5683 -->
	
	<!-- Updated in Release 6 -->
	<update id="setContractBudgetStatusForReviewTask" parameterType="java.util.Map">
		UPDATE BUDGET SET PREV_STATUS_ID = STATUS_ID, STATUS_ID = #{statusId},MODIFIED_BY_USERID
		=#{modifyBy},
		MODIFIED_DATE=current_timestamp,
		MODIFIED_BY_STAFFID =
		null 
		<!-- Start: Added in Release 6 -->
		<!-- Condition added for 8439 -->
		<if test="statusId == 86 or statusId == 85">
		,APPROVED_DATE= sysdate
		</if>
		<!-- End: Added in Release 6 -->
		WHERE BUDGET_ID = #{budgetId}
		AND CONTRACT_ID = #{contractId}
	</update>

		<!-- release 3.14.0 -->
		<update id="setContractBudgetStatusForReviewTaskForAmendment" parameterType="java.util.Map">
				UPDATE BUDGET SET PREV_STATUS_ID = STATUS_ID, STATUS_ID = #{statusId},MODIFIED_BY_USERID
				=#{modifyBy},
				MODIFIED_DATE=current_timestamp,
				MODIFIED_BY_STAFFID =
				null
				WHERE BUDGET_ID = #{budgetId}
				AND CONTRACT_ID = #{contractId}
				AND status_id !=106
		</update>
			
		<update id="setContractBudgetStatusForReviewTaskForAmendmentInConfigurationStatus" parameterType="java.util.Map">
				UPDATE BUDGET SET active_flag=0,delete_flag=1,MODIFIED_BY_USERID
				=#{modifyBy},
				MODIFIED_DATE=current_timestamp,
				MODIFIED_BY_STAFFID =
				null
				WHERE BUDGET_ID = #{budgetId}
				AND CONTRACT_ID = #{contractId}
				AND status_id =106
		</update>
		<!-- release 3.14.0 -->

	<select id="fetchProgramIncomeItemsCount" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="java.lang.Integer">
		SELECT count(1) from PROGRAM_INCOME WHERE SUB_BUDGET_ID =
		#{subBudgetID}
    </select>

	<select id="fetchUtilityItemsCount" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="java.lang.Integer">
		SELECT count(1) from UTILITIES WHERE SUB_BUDGET_ID =
		#{subBudgetID}
    </select>

	<select id="fetchCurrentCBStatus" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT STATUS_ID FROM BUDGET
		WHERE BUDGET_ID = #{asBudgetID}
	</select>

    <!-- Changes for 6574 for Release 3.10.0 -->
	<insert id="insertContractDetailsFromAwardTask" parameterType="hashmap">
		insert into contract
		(CONTRACT_ID,PARENT_CONTRACT_ID,CONTRACT_TYPE_ID,PROCUREMENT_ID,CONTRACT_SOURCE_ID,PROCUREMENT_TITLE,
		CONTRACT_TITLE,AGENCY_ID,ORGANIZATION_ID,PROGRAM_ID,CONTRACT_AMOUNT,STATUS_ID,REGISTRATION_FLAG,
		UPDATE_FLAG,LAST_UPDATE_DATE,CONTRACT_START_DATE,CONTRACT_END_DATE,DELETE_FLAG,DISCREPANCY_FLAG,CREATED_DATE,
		CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID, EVALUATION_POOL_MAPPING_ID)
		(select seq_contract_id.nextval, seq_contract_id.currval,#{contractTypeId},#{procurementId},1,proc1.procurement_title,proc1.procurement_title,proc1.agency_id,temp.organization_id,
		proc1.program_id,  temp.award_amount, #{contractStatus}, 0,0, systimestamp,
		proc1.upd_contract_start_date, proc1.upd_contract_end_date,
		0,0,systimestamp, #{userId}, systimestamp, #{userId}, #{evaluationPoolMappingId} from (    
    	select SUM(evalres1.award_amount) award_amount, temp1.organization_id from evaluation_results evalres1, proposal_config pc, (
		 SELECT
		  distinct (proconf.organization_id) organization_id,pro.procurement_id procurement_id
		   FROM procurement pro  ,
		  proposal_config proconf,
		  evaluation_results evalres
		  WHERE proconf.procurement_id                                                         = pro.procurement_id
		AND proconf.proposal_id                                                                = evalres.proposal_id
		AND proconf.proc_review_status_id                                                      = #{statusId}
		AND pro.procurement_id                                                                 = #{procurementId}
		AND evalres.modified_flag                                                              = #{modifiedFlag}
		AND evalres.evaluation_pool_mapping_id                                                 = #{evaluationPoolMappingId}
		 ) temp1 where temp1.procurement_id = #{procurementId}
		
		 and evalres1.evaluation_pool_mapping_id = #{evaluationPoolMappingId}
		and pc.organization_id = temp1.organization_id
		and pc.proposal_id = evalres1.proposal_id
		 GROUP BY temp1.organization_id ) temp , procurement proc1 where proc1.procurement_id = #{procurementId})
	</insert>
	<resultMap id="advanceInfo" type="com.nyc.hhs.model.AdvanceSummaryBean">
		<result property="id" column="BUDGET_ADVANCE_ID" />
		<result property="advanceDesc" column="ADVANCE_DESCRIPTION" />
		<result property="advAmount" column="AMOUNT" />
		<result property="ytdRecoupmentAmount" column="AMOUNT_RECOUPED" />
		<result property="status" column="STATUS" />
		<result property="ytdRecoupmentPrecent" column="RecoupmentPrecent" />
		<result property="advRequestedDate" column="REQUEST_DATE" />
	</resultMap>
	<select id="fetchAdvanceDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="advanceInfo">
		select nvl(sum(ia.AMOUNT_RECOUPED),0) AS AMOUNT_RECOUPED,ba.BUDGET_ADVANCE_ID ,
		ba.ADVANCE_DESCRIPTION,
		ba.AMOUNT,
		sm.status,
		TO_CHAR(ba.REQUEST_DATE,'MM/DD/YYYY') as REQUEST_DATE ,
		100* nvl(sum(ia.AMOUNT_RECOUPED),0) / (ba.AMOUNT) as RecoupmentPrecent
		from budget_advance ba
		left join invoice_advance ia on ba.budget_advance_id=ia.budget_advance_id
		and ia.invoice_id in (select invoice_id from invoice where status_id =
		73)
		left join status_master_r2_r3 sm on ba.STATUS_ID=sm.STATUS_ID
		where ba.budget_id=#{contractBudgetID} and ba.status_id in ('92','93','125') and ba.delete_flag != '1'  
		group by
		ia.BUDGET_ADVANCE_ID,ba.BUDGET_ADVANCE_ID,ba.ADVANCE_DESCRIPTION,ba.AMOUNT,sm.status,REQUEST_DATE, ba.created_date 	order by ba.created_date desc
	</select>
	
	<select id="fetchAdvanceDetailsForParentBudget" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="advanceInfo">
		select nvl(sum(ia.AMOUNT_RECOUPED),0) AS AMOUNT_RECOUPED,ba.BUDGET_ADVANCE_ID ,
		ba.ADVANCE_DESCRIPTION,
		ba.AMOUNT,
		sm.status,
		TO_CHAR(ba.REQUEST_DATE,'MM/DD/YYYY') as REQUEST_DATE ,
		100* nvl(sum(ia.AMOUNT_RECOUPED),0) / (ba.AMOUNT) as RecoupmentPrecent
		from budget_advance ba
		left join invoice_advance ia on ba.budget_advance_id=ia.budget_advance_id
		and ia.invoice_id in (select invoice_id from invoice where status_id =
		73)
		left join status_master_r2_r3 sm on ba.STATUS_ID=sm.STATUS_ID
		where ba.budget_id=#{parentBudgetId} and ba.status_id in ('92','93','125') and ba.delete_flag != '1'  
		group by
		ia.BUDGET_ADVANCE_ID,ba.BUDGET_ADVANCE_ID,ba.ADVANCE_DESCRIPTION,ba.AMOUNT,sm.status,REQUEST_DATE, ba.created_date 	order by ba.created_date desc
	</select>

	<delete id="removeContractFinacialdocFromVault" parameterType="String">
		DELETE
		FROM
		Contract_Document WHERE
		DOCUMENT_IDENTIFIER_ID=#{asDocumentId}
	</delete>
	<delete id="removeBudgetDocumentFromVault" parameterType="String">
		DELETE
		FROM
		Budget_Document WHERE DOCUMENT_IDENTIFIER_ID=#{asDocumentId}
	</delete>
	<delete id="removeInvoiceDocumentFromVault" parameterType="String">
		DELETE FROM
		INVOICE_DOCUMENT WHERE
		DOCUMENT_IDENTIFIER_ID=#{asDocumentId}
	</delete>
	<!-- made changes for defect id 6398 -->
	<select id="fetchOriginalContractCount" parameterType="java.util.Map"
		resultType="java.lang.Integer">
		select CONTRACT_ID from CONTRACT WHERE CONTRACT_TYPE_ID = 6
		<!--  Rel 3.16.0  QC 6814 BEGIN. Check Type=6 for Contract, not Parent-Contract -->
		and PARENT_CONTRACT_ID =  #{contractId}
		<!--  Rel 3.16.0  QC 6814 END. Check Type=6 for Contract, not Parent-Contract -->
    </select>

<!-- R6: Changed insert query to also add REF_APT_EPIN_ID in table -->
	<insert id="createContractReplica" parameterType="java.util.Map">
	
		<selectKey keyProperty="aiCurrentSeq" resultType="java.lang.Integer" order="BEFORE">
			select
			seq_contract_id.nextval from Dual
		</selectKey>
	
		insert into contract
		(CONTRACT_ID,CONTRACT_TYPE_ID,PROCUREMENT_ID,CONTRACT_SOURCE_ID,PROCUREMENT_TITLE,
		CONTRACT_TITLE,AGENCY_ID,ORGANIZATION_ID,EXT_CT_NUMBER,EXT_EPIN,PROGRAM_ID,CONTRACT_AMOUNT,STATUS_ID,EXT_COMMODITY_CODE,
		EXT_REGISTRATION_DATE,EXT_DOC_VERSION,REGISTRATION_FLAG,UPDATE_FLAG,LAST_UPDATE_DATE,CONTRACT_START_DATE,CONTRACT_END_DATE,
		AMENDMENT_REASON,PREV_STATUS_ID,PROCUREMENT_METHOD,PROJECT_PROGRAM,AWARD_AGENCY_ID,PARENT_CONTRACT_ID,DELETE_FLAG,
		DISCREPANCY_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID, REF_APT_EPIN_ID)
		(select
		 #{aiCurrentSeq},6,PROCUREMENT_ID,CONTRACT_SOURCE_ID,PROCUREMENT_TITLE,CONTRACT_TITLE,AGENCY_ID,
		ORGANIZATION_ID,EXT_CT_NUMBER,EXT_EPIN,PROGRAM_ID,CONTRACT_AMOUNT,STATUS_ID,EXT_COMMODITY_CODE,
		EXT_REGISTRATION_DATE,EXT_DOC_VERSION,REGISTRATION_FLAG,UPDATE_FLAG,LAST_UPDATE_DATE,CONTRACT_START_DATE,
		CONTRACT_END_DATE,AMENDMENT_REASON,PREV_STATUS_ID,PROCUREMENT_METHOD,PROJECT_PROGRAM,AWARD_AGENCY_ID,
		#{contractId},DELETE_FLAG,DISCREPANCY_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID, REF_APT_EPIN_ID
		from CONTRACT
		where CONTRACT_ID = #{contractId} and CONTRACT_TYPE_ID in (1,3) )

	</insert>

	<insert id="createBudgetReplica" parameterType="java.util.Map">
		Insert into BUDGET
		(BUDGET_ID,BUDGET_TYPE_ID,CONTRACT_ID,FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT,AGENCY_ID,ORGANIZATION_ID,PROGRAM_ID,CT_NUMBER,STATUS_ID,
		ACTUAL_AMOUNT,CLOSED_AMOUNT,OPEN_AMOUNT,AVAIL_OBLIGATE_AMOUNT,COMMODITY_LINE,ACCOUNTING_LINE,LINE_AMOUNT,REF_DOC_CODE,REF_DOC_DEPT,
		REF_DOC_ID,REF_COMMODITY_LINE,REF_ACCOUNTING_LINE,REF_LINE_AMOUNT,REF_VENDOR_LINE,FUND,UNIT_OF_APPROPRIATION,BUDGET_CODE,OBJECT_CODE,
		SUB_OBJECT_CODE,REPORTING_CATEGORY,BUDGET_START_DATE,BUDGET_END_DATE,LAST_UPDATE_DATE,ACTIVE_FLAG,PREV_STATUS_ID,DELETE_FLAG,
		CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,PARENT_ID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
		<!-- Start : R7 changes for Program Income -->
		,IS_OLD_PI
		<!-- End: R7 changes for Program Income -->
		)
		(SELECT
		SEQ_BUDGET_ID.NEXTVAL,5,#{repContractId},FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT,AGENCY_ID,ORGANIZATION_ID,PROGRAM_ID,CT_NUMBER,STATUS_ID,
		ACTUAL_AMOUNT,CLOSED_AMOUNT,OPEN_AMOUNT,AVAIL_OBLIGATE_AMOUNT,COMMODITY_LINE,ACCOUNTING_LINE,LINE_AMOUNT,REF_DOC_CODE,REF_DOC_DEPT,
		REF_DOC_ID,REF_COMMODITY_LINE,REF_ACCOUNTING_LINE,REF_LINE_AMOUNT,REF_VENDOR_LINE,FUND,UNIT_OF_APPROPRIATION,BUDGET_CODE,OBJECT_CODE,
		SUB_OBJECT_CODE,REPORTING_CATEGORY,BUDGET_START_DATE,BUDGET_END_DATE,LAST_UPDATE_DATE,ACTIVE_FLAG,PREV_STATUS_ID,DELETE_FLAG,
		CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,#{budgetId},MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
		<!-- Start : R7 changes for Program Income -->
		,IS_OLD_PI
		<!-- End: R7 changes for Program Income -->
		from BUDGET WHERE BUDGET_ID = #{budgetId} and BUDGET_TYPE_ID = 2 and
		ACTIVE_FLAG = 1)

		<selectKey keyProperty="aiCurrentSeq" resultType="java.lang.Integer">
			select
			SEQ_BUDGET_ID.currval from Dual
		</selectKey>
	</insert>

	<select id="fetchSubBudgetList" parameterType="java.util.Map"
		resultType="string">
		select SUB_BUDGET_ID from sub_budget where budget_id =
		#{budgetId} and ACTIVE_FLAG = 1
	</select>
	<insert id="createSubBudgetReplica" parameterType="java.util.Map">
		Insert into SUB_BUDGET
		(SUB_BUDGET_ID,BUDGET_ID,FISCAL_YEAR_ID,PARENT_ID,SUB_BUDGET_NAME,SUB_BUDGET_AMOUNT,LAST_UPDATE_DATE,ACTIVE_FLAG,CREATED_DATE,
		CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID)
		(SELECT
		SEQ_SUB_BUDGET_ID.NEXTVAL,#{repBudgetId},FISCAL_YEAR_ID,#{origSubBudgetId},SUB_BUDGET_NAME,SUB_BUDGET_AMOUNT,LAST_UPDATE_DATE,
		ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
		from SUB_BUDGET where SUB_BUDGET_ID = #{origSubBudgetId} and
		ACTIVE_FLAG = 1)
		<selectKey keyProperty="aiCurrentSeq" resultType="java.lang.Integer">
			select
			SEQ_SUB_BUDGET_ID.currval from Dual
		</selectKey>
	</insert>
	<insert id="createPersonnelServiceReplica" parameterType="java.util.Map">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,UNITS,
		TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID)
		(SELECT
		SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,#{repBudgetId},#{repSubBudgetId},
		SEQ_PERSONNEL_SERVICES_ID.currval,UNITS,TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,CREATED_BY_STAFFID from PERSONNEL_SERVICE
		WHERE SUB_BUDGET_ID = #{origSubBudgetId})
   </insert>
<!-- Release 6 -->
       <insert id="createPersonnelServiceDetailReplica" parameterType="java.util.Map">
              INSERT INTO
              personnel_service_detail
              (PERSONNEL_SERVICE_DETAIL_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,HOUR_PER_YEAR,CITY_SALARY,ANNUAL_SALARY,
              RATE,ACTIVE_FLAG,CREATED_DATE,MODIFIED_DATE,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID,INTERNAL_TITLE,PERSONNEL_SERVICE_ID,REPORTING_MODIFIED_DATE)
              (SELECT
              SEQ_PERSNL_SRVC_DETAIL_ID.NEXTVAL,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,#{repBudgetId},#{repSubBudgetId},HOUR_PER_YEAR,CITY_SALARY,ANNUAL_SALARY,RATE,
              ACTIVE_FLAG,CREATED_DATE,MODIFIED_DATE,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID,INTERNAL_TITLE,PERSONNEL_SERVICE_ID,REPORTING_MODIFIED_DATE
              from personnel_service_detail
              WHERE SUB_BUDGET_ID = #{origSubBudgetId}
              )
   </insert>
   
   <insert id="createFringeDetailReplica" parameterType="java.util.Map">
              INSERT INTO
              fringe_benefit_detail
              (FRINGE_BENEFIT_DETAIL_ID,FRINGE_BENEFIT_TYPE_ID,BUDGET_ID,SUB_BUDGET_ID,AMOUNT,FRINGE_BENEFIT_ID,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_STAFFID,
              MODIFIED_BY_STAFFID,CREATED_BY_USERID,MODIFIED_BY_USERID,MODIFIED_DATE,PREV_APPROVED_BUDGET,REPORTING_MODIFIED_DATE)
              (SELECT
              SEQ_FRINGE_BENEFIT_DETAIL_ID.nextval,FRINGE_BENEFIT_TYPE_ID,#{repBudgetId},#{repSubBudgetId},AMOUNT,FRINGE_BENEFIT_ID,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_STAFFID,
              MODIFIED_BY_STAFFID,CREATED_BY_USERID,MODIFIED_BY_USERID,MODIFIED_DATE,PREV_APPROVED_BUDGET,REPORTING_MODIFIED_DATE
              from fringe_benefit_detail
              WHERE SUB_BUDGET_ID = #{origSubBudgetId}
              )

   </insert>
       <!-- Release 6 -->

	<insert id="createOperationAndSupportReplica" parameterType="java.util.Map">
		INSERT INTO OPERATIONS_AND_SUPPORT
		(OPERATIONS_SUPPORT_ID, OPERATIONS_SUPPORT_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_OPERATIONS_SUPPORT_ID.NEXTVAL,
		OPERATIONS_SUPPORT_TYPE_ID,#{repBudgetId},#{repSubBudgetId},
		SEQ_OPERATIONS_SUPPORT_ID.currval,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE,CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
		From OPERATIONS_AND_SUPPORT
		WHERE SUB_BUDGET_ID = #{origSubBudgetId} )
   </insert>

	<insert id="createUtilitiesReplica" parameterType="java.util.Map">
		INSERT INTO UTILITIES
		( UTILITIES_ID, UTILITIES_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_UTILITIES_ID.NEXTVAL, UTILITIES_TYPE_ID,
		#{repBudgetId},#{repSubBudgetId}, SEQ_UTILITIES_ID.currval, AMOUNT,
		ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
		FROM UTILITIES WHERE SUB_BUDGET_ID = #{origSubBudgetId} )
   </insert>

	<insert id="createProfessionalServiceReplica" parameterType="java.util.Map">
		INSERT INTO PROFESSIONAL_SERVICE
		(PROFESSIONAL_SERVICE_ID, PROFESSIONAL_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_PROFESSIONAL_SERVICE_ID.NEXTVAL, PROFESSIONAL_SERVICE_TYPE_ID,
		#{repBudgetId},#{repSubBudgetId}, SEQ_PROFESSIONAL_SERVICE_ID.currval,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID FROM PROFESSIONAL_SERVICE WHERE SUB_BUDGET_ID = #{origSubBudgetId} )

	</insert>

	<insert id="createRentReplica" parameterType="java.util.Map">
		INSERT INTO RENT
		(RENT_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, LOCATION,
		MANAGEMENT_COMPANY_NAME, PROPERTY_OWNER, PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
		(SELECT SEQ_RENT_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		SEQ_RENT_ID.currval, LOCATION, MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER, PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT, AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RENT WHERE SUB_BUDGET_ID = #{origSubBudgetId}
		)
  </insert>

	<insert id="createContractedServicesReplica" parameterType="java.util.Map">
		INSERT INTO CONTRACTED_SERVICE
		(CONTRACTED_SERVICE_ID, CONTRACTED_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		NAME, SERVICE_DESCRIPTION, BUDGETED_UNITS, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
		(SELECT SEQ_CONTRACTED_SERVICE_ID.NEXTVAL, CONTRACTED_SERVICE_TYPE_ID,
		#{repBudgetId},#{repSubBudgetId},
		SEQ_CONTRACTED_SERVICE_ID.currval, NAME, SERVICE_DESCRIPTION, BUDGETED_UNITS, AMOUNT,
		ACTIVE_FLAG,CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
		FROM CONTRACTED_SERVICE WHERE SUB_BUDGET_ID = #{origSubBudgetId} )
	</insert>

	<insert id="createRateReplica" parameterType="java.util.Map">
		INSERT INTO RATE
		(RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, UNIT_DESCRIPTION,
		NUMBER_OF_UNITS, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_RATE_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		SEQ_RATE_ID.currval, UNIT_DESCRIPTION, NUMBER_OF_UNITS,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RATE WHERE SUB_BUDGET_ID = #{origSubBudgetId}
		)
  </insert>

	<insert id="createMilestoneReplica" parameterType="java.util.Map">
		INSERT INTO MILESTONE
		(MILESTONE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, MILESTONE, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_MILESTONE_ID.NEXTVAL, #{repBudgetId},#{repSubBudgetId},
		SEQ_MILESTONE_ID.currval, MILESTONE, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID FROM MILESTONE WHERE SUB_BUDGET_ID = #{origSubBudgetId}) 
  </insert>
<!-- QC 8394 R 7.9.0 Add multiple lines to unallocated funds -->
	<insert id="createUnallocatedReplica" parameterType="java.util.Map">
		INSERT INTO UNALLOCATED
		(UNALLOCATED_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID, UNALLOCATED_FUND )
		(SELECT SEQ_UNALLOCATED_ID.nextval,#{repBudgetId},#{repSubBudgetId},
		SEQ_UNALLOCATED_ID.currval, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID, UNALLOCATED_FUND
		FROM UNALLOCATED WHERE SUB_BUDGET_ID = #{origSubBudgetId})
   </insert>

	<insert id="createIndirectRateReplica" parameterType="java.util.Map">
		INSERT INTO INDIRECT_RATE
		(INDIRECT_RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, INDIRECT_AMOUNT, INDIRECT_RATE,
		ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_INDIRECT_RATE_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		SEQ_INDIRECT_RATE_ID.currval,
		INDIRECT_AMOUNT, INDIRECT_RATE, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM INDIRECT_RATE WHERE
		SUB_BUDGET_ID = #{origSubBudgetId})
   </insert>

	<insert id="createProgramIncomeReplica" parameterType="java.util.Map">
		INSERT INTO PROGRAM_INCOME
		(PROGRAM_INCOME_ID, BUDGET_ID, SUB_BUDGET_ID, PROGRAM_INCOME_TYPE_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
		(SELECT SEQ_PROGRAM_INCOME_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		PROGRAM_INCOME_TYPE_ID, SEQ_PROGRAM_INCOME_ID.currval,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM PROGRAM_INCOME WHERE SUB_BUDGET_ID =
		#{origSubBudgetId})
  </insert>

	<insert id="createFringeReplica" parameterType="java.util.Map">
		INSERT INTO FRINGE_BENEFIT
		(FRINGE_BENEFIT_ID, BUDGET_ID, SUB_BUDGET_ID, AMOUNT, FRINGE_PERCENT, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_FRINGE_BENEFIT_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		AMOUNT, FRINGE_PERCENT, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, SEQ_FRINGE_BENEFIT_ID.currval,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM FRINGE_BENEFIT WHERE SUB_BUDGET_ID =
		#{origSubBudgetId})
  </insert>

	<insert id="createEquipmentReplica" parameterType="java.util.Map">
		INSERT INTO EQUIPMENT
		(EQUIPMENT_ID, BUDGET_ID, SUB_BUDGET_ID, EQUIPMENT_NAME, UNITS, AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, ACTIVE_FLAG,
		PARENT_ID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_EQUIPMENT_ID.nextval, #{repBudgetId},#{repSubBudgetId},
		EQUIPMENT_NAME, UNITS,
		AMOUNT, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		ACTIVE_FLAG, SEQ_EQUIPMENT_ID.currval, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID
		FROM EQUIPMENT WHERE SUB_BUDGET_ID = #{origSubBudgetId})
  </insert>

	<select id="getUpdateAmountBudget" parameterType="hashmap"
		resultType="BigDecimal">
		SELECT nvl(FISCAL_YEAR_AMOUNT,'0') FROM BUDGET WHERE
		budget_id =( select parent_id from budget where budget_id =
		#{budgetId})
		AND BUDGET_TYPE_ID = 2
  </select>

	<resultMap id="fyUpdateBudgetInfo" type="com.nyc.hhs.model.BudgetDetails">
		<result property="startDate" column="BUDGET_START_DATE" />
		<result property="endDate" column="BUDGET_END_DATE" />
		<result property="updateAmount" column="FISCAL_YEAR_AMOUNT" />
	</resultMap>

	<select id="fetchUpdateFyBudgetSummary" parameterType="hashmap"
		resultMap="fyUpdateBudgetInfo">
		SELECT BUDGET.BUDGET_START_DATE,
		BUDGET.BUDGET_END_DATE,
		BUDGET.FISCAL_YEAR_AMOUNT
		FROM BUDGET
		WHERE BUDGET.BUDGET_ID =
		#{budgetId}
		AND
		BUDGET.CONTRACT_ID = #{contractId}
  </select>

	<select id="fetchAmountTotal" parameterType="hashmap"
		resultType="BigDecimal">
		SELECT CAST(SUM(total) as decimal(25, 2))
		FROM(
		(select nvl(sum(a.amount),'0') as total
		from operations_and_support a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, operations_and_support d where c.invoice_id = b.invoice_id and
		c.status_id in (72,73) and b.entry_type_id ='2'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.operations_support_id and c.budget_id=#{budgetId}
		group by b.line_item_id) b ON b.line_item_id = a.operations_support_id
		where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from equipment a left join
		(select distinct b.line_item_id, sum(b.invoice_amount) as invoiceAmount from
		invoice_details b ,
		invoice c, equipment d where c.invoice_id = b.invoice_id and
		c.status_id in (72,73) and b.entry_type_id ='12'
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.equipment_id and c.budget_id=#{budgetId}
		group by b.line_item_id) b ON b.line_item_id = a.equipment_id
		where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select sum(a.total_salary) as total
		from personnel_service a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, personnel_service d where c.invoice_id = b.invoice_id and
		c.status_id in (72,73)
		and d.sub_budget_id=b.sub_budget_id and b.line_item_id =
		d.personnel_service_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.personnel_service_id
		and b.entry_type_id ='1' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from utilities 
		a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, utilities d 
		where 
		c.invoice_id = b.invoice_id 
		<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
		<!-- >and c.status_id != 74 -->
		and c.status_id in (72,73)
		<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount -->  
		and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.utilities_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.utilities_id
		and b.entry_type_id ='3' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from professional_service a left
		join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, professional_service d where c.invoice_id = b.invoice_id and
		c.status_id in (72,73) and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.professional_service_id and
		c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.professional_service_id
		and b.entry_type_id ='4' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from rent a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, rent d where c.invoice_id = b.invoice_id and c.status_id in (72,73) and
		d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.rent_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id = a.rent_id
		and b.entry_type_id ='5' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from contracted_service a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, contracted_service d where c.invoice_id = b.invoice_id and
		c.status_id in (72,73) and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.contracted_service_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.contracted_service_id
		and b.entry_type_id ='6' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from rate a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, rate d where c.invoice_id = b.invoice_id and c.status_id in (72,73) and
		d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.rate_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id = a.rate_id
		and b.entry_type_id='7' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from milestone 
		a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, milestone d 
		where c.invoice_id = b.invoice_id 
		<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
		<!-- >and c.status_id != 74 -->
		and c.status_id in (72,73)
		<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount -->  
		and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.milestone_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.milestone_id
		and b.entry_type_id ='8' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select nvl(sum(a.amount),'0') as total
		from unallocated a left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, unallocated d 
		where c.invoice_id = b.invoice_id 
		<!-- Start QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
		<!-- >and c.status_id != 74 -->
		and c.status_id in (72,73)
		<!-- End QC 9172  R 7.7.0 accumulate Pending Approval and Approved Invoice amounts only in YTD Invoice Amount --> 
		and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.unallocated_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.unallocated_id
		and b.entry_type_id ='9' 
		where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		union all
		(select sum(a.indirect_amount) as total
		from indirect_rate a
		left join
		(select distinct b.entry_type_id, b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from invoice_details b ,
		invoice c, indirect_rate d 
		where c.invoice_id = b.invoice_id 
		and c.status_id	in (72,73) 
		and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.indirect_rate_id and c.budget_id=#{budgetId}
		group by b.entry_type_id, b.line_item_id) b ON b.line_item_id =
		a.indirect_rate_id
		and b.entry_type_id ='10' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		 union all
    	(select sum(a.amount) as total
		from
		fringe_benefit a left join
		(select distinct b.entry_type_id,
		b.line_item_id, sum(b.invoice_amount) as
		invoiceAmount from
		invoice_details b ,
		invoice c, fringe_benefit d where c.invoice_id =
		b.invoice_id and
		c.status_id in (72,73) and d.sub_budget_id=b.sub_budget_id
		and b.line_item_id = d.FRINGE_BENEFIT_ID and
		c.budget_id=#{budgetId}
		group by b.entry_type_id,
		b.line_item_id) b ON b.line_item_id =
		a.FRINGE_BENEFIT_ID
		and
		b.entry_type_id ='13' where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId})
		)	
  </select>

	<select id="fetchBudgetType" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT BUDGET_TYPE_ID FROM BUDGET WHERE BUDGET_ID = #{budgetId}
  </select>
  
  <!--Release 3.6.0 Enhancement id 6484 -->
  	<select id="subBudgetSiteCount" parameterType="java.lang.String"
		resultType="Integer">
	  (SELECT COUNT(SUB_BUDGET_ID) FROM SUB_BUDGET
  		  WHERE SUB_BUDGET_ID IN( SELECT SUB_BUDGET_ID FROM SUB_BUDGET WHERE BUDGET_ID = #{asBudgetId}) and active_flag='1' )
  		   MINUS (SELECT COUNT(SUB_BUDGET_ID)   FROM SUB_BUDGET_SITE
   	   WHERE sub_budget_id in( select sub_budget_id from SUB_BUDGET where budget_id = #{asBudgetId}) and active_flag='1') 
  </select>
  
  	<resultMap id="contractBudgetBeanList" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="parentSubBudgetId" column="PARENT_ID" />
	</resultMap>
  
	<insert id="createPersonnelServiceReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,UNITS,
		TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID)
		(SELECT
		SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,#{budgetId},#{subBudgetId},
		SEQ_PERSONNEL_SERVICES_ID.currval,'0','0',ACTIVE_FLAG,CREATED_DATE,CREATED_BY_USERID,MODIFIED_DATE,MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,CREATED_BY_STAFFID from PERSONNEL_SERVICE
		WHERE SUB_BUDGET_ID = #{parentSubBudgetId})
   </insert>


	<insert id="createOperationAndSupportReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO OPERATIONS_AND_SUPPORT
		(OPERATIONS_SUPPORT_ID, OPERATIONS_SUPPORT_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_OPERATIONS_SUPPORT_ID.NEXTVAL,
		OPERATIONS_SUPPORT_TYPE_ID,#{budgetId},#{subBudgetId},
		SEQ_OPERATIONS_SUPPORT_ID.currval,
		'0', ACTIVE_FLAG, CREATED_DATE,CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
		From OPERATIONS_AND_SUPPORT
		WHERE SUB_BUDGET_ID = #{parentSubBudgetId} )
   </insert>


	<insert id="createUtilitiesReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO UTILITIES
		( UTILITIES_ID, UTILITIES_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_UTILITIES_ID.NEXTVAL, UTILITIES_TYPE_ID,
		#{budgetId},#{subBudgetId}, SEQ_UTILITIES_ID.currval, '0',
		ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID
		FROM UTILITIES WHERE SUB_BUDGET_ID = #{parentSubBudgetId} )
   </insert>


	<insert id="createProfessionalServiceReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO PROFESSIONAL_SERVICE
		(PROFESSIONAL_SERVICE_ID, PROFESSIONAL_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_PROFESSIONAL_SERVICE_ID.NEXTVAL, PROFESSIONAL_SERVICE_TYPE_ID,
		#{budgetId},#{subBudgetId}, SEQ_PROFESSIONAL_SERVICE_ID.currval,
		'0', ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID FROM PROFESSIONAL_SERVICE WHERE SUB_BUDGET_ID = #{parentSubBudgetId} )

	</insert>


	<insert id="createRentReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO RENT
		(RENT_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, LOCATION,
		MANAGEMENT_COMPANY_NAME, PROPERTY_OWNER, PUBLIC_SCHOOL_SPACE,
		PERCENT_CHARGED_TO_CONTRACT, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
		(SELECT SEQ_RENT_ID.nextval, #{budgetId},#{subBudgetId},
		SEQ_RENT_ID.currval, LOCATION, MANAGEMENT_COMPANY_NAME,
		PROPERTY_OWNER, PUBLIC_SCHOOL_SPACE,
		'0', '0', ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RENT WHERE SUB_BUDGET_ID = #{parentSubBudgetId}
		)
  </insert>

	<insert id="createContractedServicesReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO CONTRACTED_SERVICE
		(CONTRACTED_SERVICE_ID, CONTRACTED_SERVICE_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID,
		NAME, SERVICE_DESCRIPTION, BUDGETED_UNITS, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID)
		(SELECT SEQ_CONTRACTED_SERVICE_ID.NEXTVAL, CONTRACTED_SERVICE_TYPE_ID,
		#{budgetId},#{subBudgetId},
		SEQ_CONTRACTED_SERVICE_ID.currval, NAME, SERVICE_DESCRIPTION, '0', '0',
		ACTIVE_FLAG,CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,CREATED_BY_STAFFID
		FROM CONTRACTED_SERVICE WHERE SUB_BUDGET_ID = #{parentSubBudgetId} )
	</insert>


	<insert id="createRateReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO RATE
		(RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, UNIT_DESCRIPTION,
		NUMBER_OF_UNITS, AMOUNT, ACTIVE_FLAG, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_RATE_ID.nextval, #{budgetId},#{subBudgetId},
		SEQ_RATE_ID.currval, UNIT_DESCRIPTION, '0',
		'0', ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM RATE WHERE SUB_BUDGET_ID = #{parentSubBudgetId}
		)
  </insert>

	<insert id="createMilestoneReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO MILESTONE
		(MILESTONE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, MILESTONE, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID )
		(SELECT SEQ_MILESTONE_ID.NEXTVAL, #{budgetId},#{subBudgetId},
		SEQ_MILESTONE_ID.currval, MILESTONE, '0', ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID FROM MILESTONE WHERE SUB_BUDGET_ID = #{parentSubBudgetId}) 
  </insert>
<!-- QC 8394 R 7.9.0 Add multiple lines to unallocated funds -->
	<insert id="createUnallocatedReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO UNALLOCATED
		(UNALLOCATED_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, AMOUNT, ACTIVE_FLAG,
		CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID, UNALLOCATED_FUND )
		(SELECT SEQ_UNALLOCATED_ID.nextval,#{budgetId},#{subBudgetId},
		SEQ_UNALLOCATED_ID.currval, '0', ACTIVE_FLAG,
		CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID, UNALLOCATED_FUND
		FROM UNALLOCATED WHERE SUB_BUDGET_ID = #{parentSubBudgetId})
   </insert>

	<insert id="createIndirectRateReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO INDIRECT_RATE
		(INDIRECT_RATE_ID, BUDGET_ID, SUB_BUDGET_ID, PARENT_ID, INDIRECT_AMOUNT, INDIRECT_RATE,
		ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_INDIRECT_RATE_ID.nextval, #{budgetId},#{subBudgetId},
		SEQ_INDIRECT_RATE_ID.currval,
		'0', '0', ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM INDIRECT_RATE WHERE
		SUB_BUDGET_ID = #{parentSubBudgetId})
   </insert>
	
	<!-- Updated in R7 for Program Income -->
	<insert id="createProgramIncomeReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO PROGRAM_INCOME
		(PROGRAM_INCOME_ID, BUDGET_ID, SUB_BUDGET_ID, PROGRAM_INCOME_TYPE_ID, PARENT_ID,
		AMOUNT, ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID,Entry_type_id,Description)
		(SELECT SEQ_PROGRAM_INCOME_ID.nextval, #{budgetId},#{subBudgetId},
		PROGRAM_INCOME_TYPE_ID, SEQ_PROGRAM_INCOME_ID.currval,
		'0', ACTIVE_FLAG, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID, Entry_type_id,Description FROM PROGRAM_INCOME WHERE SUB_BUDGET_ID =
		#{parentSubBudgetId}
		<!-- Start:Added in R7 -->
		AND  (select is_old_pi from budget where budget_id = (select budget_id from sub_budget where 
    	sub_budget_id = #{parentSubBudgetId})) = 0)
		<!-- End:Added in R7 -->
  </insert>

	<insert id="createFringeReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO FRINGE_BENEFIT
		(FRINGE_BENEFIT_ID, BUDGET_ID, SUB_BUDGET_ID, AMOUNT, FRINGE_PERCENT, CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_FRINGE_BENEFIT_ID.nextval, #{budgetId},#{subBudgetId},
		'0', '0', CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, SEQ_FRINGE_BENEFIT_ID.currval,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID, CREATED_BY_STAFFID FROM FRINGE_BENEFIT WHERE SUB_BUDGET_ID =
		#{parentSubBudgetId})
  </insert>

	<insert id="createEquipmentReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO EQUIPMENT
		(EQUIPMENT_ID, BUDGET_ID, SUB_BUDGET_ID, EQUIPMENT_NAME, UNITS, AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID, ACTIVE_FLAG,
		PARENT_ID, MODIFIED_BY_STAFFID, CREATED_BY_STAFFID )
		(SELECT SEQ_EQUIPMENT_ID.nextval, #{budgetId},#{subBudgetId},
		EQUIPMENT_NAME, '0',
		'0', CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		ACTIVE_FLAG, SEQ_EQUIPMENT_ID.currval, MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID
		FROM EQUIPMENT WHERE SUB_BUDGET_ID = #{parentSubBudgetId})
  </insert>
  
  	<select id="fetchSubBudgetListNewFY" parameterType="com.nyc.hhs.model.TaskDetailsBean"
		resultMap="contractBudgetBeanList">
		select 
			BUDGET_ID, 
			SUB_BUDGET_ID, 
			PARENT_ID 
		from sub_budget where budget_id = ( SELECT budget_id 
											from budget 
											where contract_id = #{contractId}
											and FISCAL_YEAR_ID = #{startFiscalYear}
											and budget_type_id = '2' ) 
		and SUB_BUDGET_ID != PARENT_ID 
    	and ACTIVE_FLAG = 1
	</select>
	
  	<update id="updateParentOfDerivedSubBudgets" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		update
			sub_budget
		set
			PARENT_ID = SUB_BUDGET_ID
		where
			SUB_BUDGET_ID = #{subBudgetId}
	</update>
  
  	<insert id="insertContractFinReplicaForOriginal" parameterType="java.util.Map">
		INSERT
	INTO contract_financials
	  (
	    CONTRACT_FINANCIALS_ID,
	    PROCUREMENT_ID,
	    CONTRACT_ID,
	    UNIT_OF_APPROPRIATION,
	    BUDGET_CODE,
	    OBJECT_CODE,
	    SUB_OBJECT_CODE,
	    REPORTING_CATEGORY,
	    FISCAL_YEAR_ID,
	    AMOUNT,
	    DOCUMENT_IDENTIFIER_ID,
	    LAST_UPDATE_DATE,
	    ACTIVE_FLAG,
	    PARENT_ID,
	    CREATED_DATE,
	    CREATED_BY_USERID,
	    MODIFIED_DATE,
	    MODIFIED_BY_USERID,
	    APPROVED_BY, 
	    APPROVED_DATE,
	    NEW_FY_FISCAL_YEAR_ID
	  )
	SELECT SEQ_CONTRACT_FINANCIALS_ID.nextval, 
	  PROCUREMENT_ID,
	    #{contractIdOrig},
	    UNIT_OF_APPROPRIATION,
	    BUDGET_CODE,
	    OBJECT_CODE,
	    SUB_OBJECT_CODE,
	    REPORTING_CATEGORY,
	    FISCAL_YEAR_ID,
	    AMOUNT,
	    DOCUMENT_IDENTIFIER_ID,
	    LAST_UPDATE_DATE,
	    ACTIVE_FLAG,
	    PARENT_ID,
	    CREATED_DATE,
	    CREATED_BY_USERID,
	    MODIFIED_DATE,
	    MODIFIED_BY_USERID,
	    APPROVED_BY, 
	    APPROVED_DATE,
	    NEW_FY_FISCAL_YEAR_ID
	  FROM contract_financials
	  WHERE contract_id = #{contractId}
	</insert>
  
  	<delete id="deleteContractFinancialEntries" parameterType="java.util.Map">
		DELETE FROM
		CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{contractIdOrig}
	 </delete>

  	<delete id="deleteContractFinFundingEntries" parameterType="java.util.Map">
		DELETE FROM
		CONTRACT_FIN_FUNDING_STREAM WHERE CONTRACT_ID = #{contractIdOrig}
	 </delete>

  	<insert id="insertContractFinFundingReplicaForOriginal" parameterType="java.util.Map">
		INSERT
	INTO CONTRACT_FIN_FUNDING_STREAM
	  (
	    CONTRACT_FUNDING_ID,
	    PROCUREMENT_ID,
	    CONTRACT_ID,
	    FEDERAL_AMOUNT,
	    STATE_AMOUNT,
	    CITY_AMOUNT,
	    OTHER_AMOUNT,
	    FISCAL_YEAR_ID,
	    LAST_UPDATE_DATE,
	    ACTIVE_FLAG,
	    CREATED_DATE,
	    CREATED_BY_USERID,
	    MODIFIED_DATE,
	    MODIFIED_BY_USERID
	  )
	SELECT SEQ_CONTRACT_FUNDING_ID.nextval, 
	 	 PROCUREMENT_ID,
	    #{contractIdOrig},
	    FEDERAL_AMOUNT,
	    STATE_AMOUNT,
	    CITY_AMOUNT,
	    OTHER_AMOUNT,
	    FISCAL_YEAR_ID,
	    LAST_UPDATE_DATE,
	    ACTIVE_FLAG,
	    CREATED_DATE,
	    CREATED_BY_USERID,
	    MODIFIED_DATE,
	    MODIFIED_BY_USERID
	  FROM CONTRACT_FIN_FUNDING_STREAM
	  WHERE contract_id = #{contractId}
	</insert>
  
  	<insert id="insertStandardFringeBenefits" parameterType="com.nyc.hhs.model.CBGridBean">
		INSERT INTO
			FRINGE_BENEFIT
		(FRINGE_BENEFIT_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		AMOUNT,
		FRINGE_PERCENT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		PARENT_ID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		
		VALUES
		
		(SEQ_FRINGE_BENEFIT_ID.NEXTVAL,
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		0,
		'0',
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SEQ_FRINGE_BENEFIT_ID.currval,
		'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR})
	</insert>
  
  	<select id="getFringeBenefitCount" parameterType="java.lang.String"
		resultType="int">
		select count(1) from fringe_benefit where
		sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR}
	</select>
  
  	<select id="getAmendEpinAndAmount" parameterType="hashmap" resultType="hashmap" >
		SELECT EXT_EPIN,
		       BUDGET.FISCAL_YEAR_AMOUNT as CONTRACT_AMOUNT , CONTRACT.CONTRACT_TITLE as amendmentTitle
		FROM CONTRACT
		INNER JOIN BUDGET
		ON CONTRACT.CONTRACT_ID = BUDGET.CONTRACT_ID
		WHERE BUDGET.BUDGET_ID = #{budgetId}
	</select>
	
	<!-- Start release 3.12.0 for enhancement request 6643 -->
	<update id="updateOperationAndSupportModifiedDate" parameterType="hashmap">
	  update operations_and_support set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateUtilitiesModifiedDate" parameterType="hashmap">
	  update utilities set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateProfessionalServiceModifiedDate" parameterType="hashmap">
	  update professional_service set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateRentModifiedDate" parameterType="hashmap">
	  update rent set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateContractedServicesModifiedDate" parameterType="hashmap">
	  update contracted_service set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateRateModifiedDate" parameterType="hashmap">
	  update rate set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateMilestoneModifiedDate" parameterType="hashmap">
	  update milestone set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateUnallocatedModifiedDate" parameterType="hashmap">
	  update unallocated set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateIndirectRateModifiedDate" parameterType="hashmap">
	  update indirect_rate set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateProgramIncomeModifiedDate" parameterType="hashmap">
	  update program_income set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateFringeModifiedDate" parameterType="hashmap">
	  update fringe_benefit set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateEquipmentModifiedDate" parameterType="hashmap">
	  update equipment set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updatePersonnelServiceModifiedDate" parameterType="hashmap">
	  update personnel_service set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateSubBudgetModifiedDate" parameterType="hashmap">
	  update sub_budget set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id = (select parent_id from budget where budget_id = #{budgetId})
	</update>
	<update id="updateBudgetModifiedDate" parameterType="hashmap">
	  update budget set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =(select parent_id from budget where budget_id = #{budgetId})
	</update>
	
	<update id="updateSubBudgetYtdInvoiceAmoutnt" parameterType="hashmap">
	  update sub_budget set remaining_amount = sub_budget_amount,  ytd_invoiced_amount= 0,modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updateBudgetYtdInvoiceAmoutnt" parameterType="hashmap">
	  update budget set remaining_amount = fiscal_year_amount,  ytd_invoiced_amount= 0,modified_date = systimestamp,  modified_by_userid = #{modifyBy} where budget_id =#{budgetId}
	</update>
	<update id="updatedModifiedDateInContract" parameterType="hashmap">
	  update contract set modified_date = systimestamp,  modified_by_userid = #{modifyBy} where contract_id = (select contract_id from budget where budget_id = (select parent_id from budget where budget_id = #{budgetId}))
	</update>
	
	
	<update id="updateModifiedDateInAssignment" parameterType="hashmap">
	 update assignment set modified_date = systimestamp,  modified_by_userid = #{modifyBy}  where budget_id = (select budget_id from invoice where invoice_id = #{invoiceId})
	</update>
	
	<update id="updateModifiedDateInAssignmentInAdvanceReview" parameterType="hashmap">
	 update assignment set modified_date = systimestamp,  modified_by_userid = #{modifyBy}  where budget_id = (select budget_id from budget_advance where budget_advance_id = #{budgetAdvanceId})
	</update>
	<!-- End release 3.12.0 for enhancement request 6643  -->
	<!-- R6 change starts -->
	<!-- Start: Added in R6 -->
	<insert id="insertPersonnelServicesDetailed" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
	INSERT INTO PERSONNEL_SERVICE_DETAIL
	  (
	    PERSONNEL_SERVICE_DETAIL_ID,
	    PERSONNEL_SERVICE_TYPE_ID,
	    BUDGET_ID,
	    RATE,
	    SUB_BUDGET_ID,
	    POSITION_ID,
	    ANNUAL_SALARY,
	    HOUR_PER_YEAR,
	    CITY_SALARY,
	    CREATED_DATE ,
	    MODIFIED_DATE, 
	    INTERNAL_TITLE,
	    ACTIVE_FLAG,
	    CREATED_BY_STAFFID,
	    MODIFIED_BY_STAFFID
	  )
	  VALUES
	  (
	    SEQ_PERSNL_SRVC_DETAIL_ID.NEXTVAL, 
	    #{empType,jdbcType=VARCHAR},
	    #{contractBudgetID,jdbcType=VARCHAR},
	    #{rate,jdbcType=VARCHAR},
	    #{subBudgetID,jdbcType=VARCHAR},
	    #{empPosition,jdbcType=VARCHAR},
	    #{annualSalary,jdbcType=VARCHAR},
	    #{hourPerYear,jdbcType=VARCHAR},
	    #{budgetAmount,jdbcType=VARCHAR},
	    sysdate,
	    sysdate, 
	    #{internalTitle,jdbcType=VARCHAR},
	     '1',
	    #{modifiedByUserId,jdbcType=VARCHAR},
	    #{modifiedByUserId,jdbcType=VARCHAR}
	  )
	</insert>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<update id="updatePersonnelServicesDetails" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		update
		PERSONNEL_SERVICE_DETAIL set position_id = #{empPosition,jdbcType=VARCHAR},ANNUAL_SALARY= #{annualSalary,jdbcType=VARCHAR},
		CITY_SALARY = #{budgetAmount,jdbcType=VARCHAR},INTERNAL_TITLE= #{internalTitle,jdbcType=VARCHAR}, modified_date =
		current_timestamp,MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}, PERSONNEL_SERVICE_ID='',
		HOUR_PER_YEAR = #{hourPerYear,jdbcType=VARCHAR},RATE = #{rate,jdbcType=VARCHAR}
		where PERSONNEL_SERVICE_DETAIL_ID = #{id} and PERSONNEL_SERVICE_TYPE_ID=  #{empType,jdbcType=VARCHAR}
	</update>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchPsDetailedEmployee" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="detailedEmployeeList">
		SELECT ps.PERSONNEL_SERVICE_DETAIL_ID,
		ps.PERSONNEL_SERVICE_TYPE_ID,
		Pos.POSITION,
		ps.RATE,
		ps.budget_id,
		Ps.Sub_Budget_Id,
		Ps.Annual_Salary,
		Ps.Hour_Per_Year,
		ps.INTERNAL_TITLE,
		ps.CITY_SALARY,
		(case when Ps.Annual_Salary != 0 
				then (ps.CITY_SALARY/Ps.Annual_Salary)*100
	      	  else 0 
	     end) as invoicedAmount
		FROM PERSONNEL_SERVICE_DETAIL Ps
		INNER JOIN Position Pos
		ON Ps.POSITION_ID = Pos.Position_Id
		WHERE  Ps.Sub_Budget_Id = 
		<choose>
			<when test="budgetTypeId == 2">
				#{subBudgetID,jdbcType=VARCHAR}				
			</when>
			<otherwise>
				(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
			</otherwise>
		</choose>
		AND Ps.PERSONNEL_SERVICE_TYPE_ID = 1
		ORDER BY Ps.Created_Date DESC
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchHourlyDetailedEmployee" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="detailedEmployeeList">
	SELECT ps.PERSONNEL_SERVICE_DETAIL_ID,
	ps.PERSONNEL_SERVICE_TYPE_ID,
	Pos.POSITION,
	ps.RATE,
	ps.budget_id,
	Ps.Sub_Budget_Id,
	Ps.Annual_Salary,
	Ps.Hour_Per_Year,
	ps.INTERNAL_TITLE,
	ps.CITY_SALARY,
	(case when (Ps.Hour_Per_Year*ps.RATE) != 0 
			then (ps.CITY_SALARY/(Ps.Hour_Per_Year*ps.RATE))*100
      	  else 0 
     end) as invoicedAmount
	FROM PERSONNEL_SERVICE_DETAIL Ps
	INNER JOIN Position Pos
	ON Ps.POSITION_ID = Pos.Position_Id
	WHERE Ps.Sub_Budget_Id = 
	<choose>
		<when test="budgetTypeId == 2">
			#{subBudgetID,jdbcType=VARCHAR}
		</when>
		<otherwise>
			(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
		</otherwise>
	</choose>
	AND Ps.PERSONNEL_SERVICE_TYPE_ID = 2
	ORDER BY Ps.Created_Date DESC
	</select>
	
	<resultMap id="detailedEmployeeList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="PERSONNEL_SERVICE_DETAIL_ID" />
		<result property="contractBudgetID" column="BUDGET_ID" />
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="empPosition" column="POSITION" />
		<result property="annualSalary" column="ANNUAL_SALARY" />
		<result property="hourPerYear" column="Hour_Per_Year" />
		<result property="internalTitle" column="INTERNAL_TITLE" />
		<result property="budgetAmount" column="CITY_SALARY" />
		<result property="rate" column="RATE" />
		<result property="invoicedAmount" column="invoicedAmount" />
	</resultMap>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<delete id="deletePersonnelServicesDetails" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		DELETE FROM
		personnel_service_detail where PERSONNEL_SERVICE_DETAIL_ID = #{id}
	</delete>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<delete id="deletePersonnelServicesForDetail" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		DELETE FROM
		personnel_service where Sub_Budget_Id= #{subBudgetID,jdbcType=VARCHAR} and Personnel_Service_Type_Id = #{empType,jdbcType=VARCHAR}
		and position_id NOT IN (select distinct(position_id) from personnel_service_detail where Sub_Budget_Id= #{subBudgetID,jdbcType=VARCHAR} 
			and Personnel_Service_Type_Id = #{empType,jdbcType=VARCHAR})
	</delete>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<insert id="insertPersonnelServicesFromDetails" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO
		PERSONNEL_SERVICE
		(PERSONNEL_SERVICE_ID,
		PERSONNEL_SERVICE_TYPE_ID,
		POSITION_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		UNITS,
		TOTAL_SALARY,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		ACTIVE_FLAG,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID)
		(SELECT SEQ_PERSONNEL_SERVICES_ID.NEXTVAL,
		#{empType,jdbcType=VARCHAR},
		#{empPosition} ,
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		SEQ_PERSONNEL_SERVICES_ID.currval,
		A,B,
		systimestamp,
		#{modifyByAgency,jdbcType=VARCHAR},
		systimestamp,
		#{modifyByAgency,jdbcType=VARCHAR},'1',
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR} from (Select Count(Ps.Position_Id) A,
      	SUM(Ps.CITY_SALARY) b
    	FROM PERSONNEL_SERVICE_DETAIL Ps
    	INNER JOIN Position Pos
    	ON Ps.POSITION_ID                = Pos.Position_Id
    	WHERE ps.BUDGET_ID               = #{contractBudgetID,jdbcType=VARCHAR}
   		AND Ps.Sub_Budget_Id             = #{subBudgetID,jdbcType=VARCHAR}
    	AND Ps.Personnel_Service_Type_Id = #{empType,jdbcType=VARCHAR}
    	And Ps.Position_Id NOT IN (select distinct(position_id)
		from personnel_service where Sub_Budget_Id= #{subBudgetID,jdbcType=VARCHAR} and Personnel_Service_Type_Id = #{empType,jdbcType=VARCHAR})
    	GROUP BY Ps.Position_Id))
	</insert>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchPersonnelServicePositionId" parameterType="com.nyc.hhs.model.PersonnelServiceBudget"
		resultType="string">
		Select position_id From Personnel_Service_Detail where Sub_Budget_Id=#{subBudgetID,jdbcType=VARCHAR}
		and personnel_service_detail_id =  #{id}
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchTotalPositions" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="String">
		select NVL(count(personnel_service_detail_id),0)
		from Personnel_Service_Detail
		where
		sub_budget_id = (select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
		and PERSONNEL_SERVICE_TYPE_ID in(
		'1','2')
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="getPersonnelDetailData" parameterType="com.nyc.hhs.model.PersonnelServiceBudget"
		resultType="int">
		select count(1) from Personnel_Service_Detail where
		sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR} and position_id=#{empPosition}
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<update id="updatePersonnelServicesForDetail" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		MERGE INTO Personnel_service PD
		Using (
		Select P.Position_Id, Count(P.Position_Id) units, SUM(P.CITY_SALARY) total_salary_sum, P.PERSONNEL_SERVICE_TYPE_ID
		From Personnel_Service_Detail P WHERE P.BUDGET_ID =
		#{contractBudgetID,jdbcType=VARCHAR}
		And P.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR}
		And P.Personnel_Service_Type_Id = #{empType,jdbcType=VARCHAR} Group By
		P.Position_Id, P.PERSONNEL_SERVICE_TYPE_ID ) Tmp
		On (Tmp.PERSONNEL_SERVICE_TYPE_ID = PD.PERSONNEL_SERVICE_TYPE_ID and Pd.Sub_Budget_Id =  #{subBudgetID,jdbcType=VARCHAR} And Pd.Position_Id = Tmp.Position_Id AND (Tmp.Units != Pd.Units Or
		tmp.total_salary_sum != pd.TOTAL_SALARY ))
		WHEN MATCHED THEN
		Update Set
		Pd.Units = Tmp.Units,
		PD.TOTAL_SALARY = TMP.total_salary_sum,
		PD.MODIFIED_DATE = systimestamp,
		Pd.Modified_By_Staffid = #{modifyByProvider,jdbcType=VARCHAR}
	</update>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<update id="updatePsDetailSummaryId" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
	
	MERGE INTO Personnel_Service_Detail PD
	Using (
	Select P.personnel_service_id,p.Position_Id
	From
	Personnel_Service P WHERE P.BUDGET_ID =	#{contractBudgetID,jdbcType=VARCHAR}
	And P.Sub_Budget_Id =#{subBudgetID,jdbcType=VARCHAR}
	And P.Personnel_Service_Type_Id =#{empType,jdbcType=VARCHAR} 
	) Tmp
	On
	(Pd.Sub_Budget_Id = #{subBudgetID,jdbcType=VARCHAR} And Pd.Position_Id= Tmp.Position_Id and pd.Personnel_Service_Type_Id =#{empType,jdbcType=VARCHAR} )
	WHEN MATCHED THEN
	Update Set
	Pd.PERSONNEL_SERVICE_ID = Tmp.personnel_service_id
	
	</update>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="getBudgetExistInfo"  parameterType="com.nyc.hhs.model.CBGridBean" resultType="String">
		SELECT USES_FTE FROM BUDGET WHERE BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchFringBenefitsMasterList" resultType="String">
		select FRINGE_BENEFIT_TYPE_ID from FRINGE_BENEFIT_TYPE_MASTER where ACTIVE_FLAG = '1'
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<insert id="insertFringeBenefitDetail" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		INSERT INTO FRINGE_BENEFIT_DETAIL(
		FRINGE_BENEFIT_DETAIL_ID,
		FRINGE_BENEFIT_TYPE_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FRINGE_BENEFIT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		CREATED_BY_STAFFID,
		ACTIVE_FLAG)
		VALUES(
		SEQ_FRINGE_BENEFIT_DETAIL_ID.nextval,
		#{typeId,jdbcType=VARCHAR},
		#{contractBudgetID,jdbcType=VARCHAR},
		#{subBudgetID,jdbcType=VARCHAR},
		(select fringe_benefit_id from fringe_benefit where sub_budget_id=#{subBudgetID,jdbcType=VARCHAR} and rownum=1) ,
		#{budgetAmount,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		'1')
	</insert>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<resultMap id="fringeBenefitsDetailList" type="com.nyc.hhs.model.PersonnelServiceBudget">
		<result property="id" column="FRINGE_BENEFIT_DETAIL_ID" />
		<result property="fringeBenifits" column="FRINGE_BENEFIT_TYPE" />
		<!--[Start] R7.12.0 QC9124 add column -->
		<result property="rate" column="" />
	<!--[End] R7.12.0 QC9124 add column -->
		<result property="budgetAmount" column="AMOUNT" />
	</resultMap>
	<select id="fetchFringeBenefitsDetail" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="fringeBenefitsDetailList">
		SELECT FRINGE_BENEFIT_DETAIL_ID, FBTM.FRINGE_BENEFIT_TYPE, AMOUNT
		<!--[Start] R8.5.0 qc_9406 Sub Budget Name Change in New Fiscal Year task causes Fringe Benefit Detail Grid to break -->
		<!--[Start] R7.12.0 QC9124 add column -->
		      ,round( (AMOUNT/NULLIF(sum_hour_year,0) )*100 , 2 )  as RATE 
		<!--[End] R7.12.0 QC9124 add column -->
		<!--[End] R8.5.0 qc_9406 Sub Budget Name Change in New Fiscal Year task causes Fringe Benefit Detail Grid to break -->
		FROM   FRINGE_BENEFIT_DETAIL FBD
	<!--[Start] R7.12.0 QC9124 add sub table for calculation -->
		FULL OUTER join ( SELECT SUB_BUDGET_ID,   sum( ps.CITY_SALARY) as sum_hour_year
						FROM PERSONNEL_SERVICE_DETAIL Ps 
						WHERE  Ps.Sub_Budget_Id = 
						<choose>
							<when test="budgetTypeId == 2">
								#{subBudgetID,jdbcType=VARCHAR}
							</when>
							<otherwise>
								(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
							</otherwise>
						</choose>
						AND    Ps.PERSONNEL_SERVICE_TYPE_ID in ( 1, 2 )
						group by SUB_BUDGET_ID
                    ) PSD 
        ON FBD.SUB_BUDGET_ID = PSD.SUB_BUDGET_ID
	<!--[End] R7.12.0 QC9124 add sub table for calculation -->
		INNER JOIN FRINGE_BENEFIT_TYPE_MASTER FBTM
		ON FBD.FRINGE_BENEFIT_TYPE_ID = FBTM.FRINGE_BENEFIT_TYPE_ID
		WHERE FBD.SUB_BUDGET_ID  = 
		<choose>
			<when test="budgetTypeId == 2">
				#{subBudgetID,jdbcType=VARCHAR}				
			</when>
			<otherwise>
				(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
			</otherwise>
		</choose>
		ORDER BY FBTM.FRINGE_BENEFIT_TYPE_ID
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<update id="updateFringeBenefitsDetails" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		UPDATE FRINGE_BENEFIT_DETAIL 
		SET AMOUNT = #{budgetAmount,jdbcType=VARCHAR},
			modified_date = SYSTIMESTAMP,
			MODIFIED_BY_STAFFID = #{modifyByProvider,jdbcType=VARCHAR}
		WHERE FRINGE_BENEFIT_DETAIL_ID = #{id,jdbcType=VARCHAR}
	</update>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<update id="updateFringeBenefitsSummary" parameterType="com.nyc.hhs.model.PersonnelServiceBudget">
		UPDATE FRINGE_BENEFIT SET (FRINGE_PERCENT, AMOUNT)= (SELECT (CASE WHEN SUM(B) != '0' THEN ROUND(SUM(A)/SUM(B)*100, 2) ELSE 0 END), SUM(A) FROM(
		SELECT SUM(AMOUNT) AS A,0 AS B FROM FRINGE_BENEFIT_DETAIL WHERE BUDGET_ID =#{contractBudgetID,jdbcType=VARCHAR} AND SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
		UNION
		SELECT 0 AS A, SUM(TOTAL_SALARY) AS B FROM PERSONNEL_SERVICE WHERE BUDGET_ID =#{contractBudgetID,jdbcType=VARCHAR} AND SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
		))
		WHERE BUDGET_ID =#{contractBudgetID,jdbcType=VARCHAR} AND SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
	</update>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchFringeBenefitsSummaryData" parameterType="com.nyc.hhs.model.CBGridBean" resultType="com.nyc.hhs.model.PersonnelServicesData">
		select sum(totalFringeAmount) as totalFringeAmount,sum(totalYtdInvoicedAmount) as totalYtdInvoicedAmount,
			   sum(totalPositions) as totalPositions, sum(totalSalaryAmount) as totalSalaryAmount,
			   sum(totalFringeAmount) + sum(totalSalaryAmount) as totalSalaryAndFringeAmount,
			   ( case when sum(totalSalaryAmount) != 0 then ROUND(sum(totalFringeAmount)/ sum(totalSalaryAmount) * 100, 2) else 0 end) as fringePercentage,
			   (CASE WHEN SUM(Total_Sal_Emp_N_Hr_Annual_Sal) != 0 THEN ROUND((SUM(total_Salary_N_Hour_FY_Budget) / SUM(Total_Sal_Emp_N_Hr_Annual_Sal)) * SUM(Total_Sal_N_Hour_per_Year) / #{defaultCityFte,jdbcType=VARCHAR} , 2)
				  ELSE 0 END) AS totalCityFte
			from(
				SELECT  AMOUNT as totalFringeAmount, nvl(ytd_invoiced_amount,0) as totalYtdInvoicedAmount,
						0 as totalPositions, 0 as totalSalaryAmount,
						0 as total_Salary_N_Hour_FY_Budget,
						0 as Total_Sal_Emp_N_Hr_Annual_Sal,
						0 as Total_Sal_N_Hour_per_Year
				FROM FRINGE_BENEFIT where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
				UNION
				SELECT  0 as totalFringeAmount,
						sum(nvl(ytd_invoiced_amount,0)) as totalYtdInvoicedAmount,
						sum(units) as totalPositions,
						sum(total_salary) as totalSalaryAmount,
						0 as total_Salary_N_Hour_FY_Budget,
						0  as Total_Sal_Emp_N_Hr_Annual_Sal,
						0 as Total_Sal_N_Hour_per_Year
				FROM personnel_service where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
				union
				SELECT 	0 as totalFringeAmount,
						0 as totalYtdInvoicedAmount,
						0 as totalPositions,
						0 as totalSalaryAmount,
						sum(CITY_SALARY) as total_Salary_N_Hour_FY_Budget,
						sum(ANNUAL_SALARY)+sum(RATE*HOUR_PER_YEAR)  as Total_Sal_Emp_N_Hr_Annual_Sal,
						sum(HOUR_PER_YEAR) as Total_Sal_N_Hour_per_Year
				FROM personnel_service_detail where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
				)
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="fetchBudgetApprovedDate"  parameterType="com.nyc.hhs.model.CBGridBean" resultType="String">
		SELECT Approved_Date FROM BUDGET WHERE BUDGET_ID = (select parent_id from budget where budget_id = #{contractBudgetID,jdbcType=VARCHAR})
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<select id="checkIfOtherBudgetApproved" parameterType="java.lang.String" resultType="Integer">
		Select Count(1) From Budget Where Budget_Id in (Select Parent_Id From Budget Where Budget_Id= #{asSubBudgetId} ) And Status_Id Not In (85,86) And
		active_flag='1'
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<!-- Defect 8650 FTE formula updated for all existing as well as new budgets -->
	<select id="fetchFringeBenefitsDetailData" parameterType="com.nyc.hhs.model.CBGridBean" resultType="com.nyc.hhs.model.PersonnelServicesData">
		select sum(totalFringeAmount) as totalFringeAmount,sum(totalYtdInvoicedAmount) as totalYtdInvoicedAmount,
			   sum(totalPositions) as totalPositions, sum(totalSalaryAmount) as totalSalaryAmount,
			   sum(totalFringeAmount) + sum(totalSalaryAmount) as totalSalaryAndFringeAmount,
			   ( case when sum(totalSalaryAmount) != 0 then ROUND(sum(totalFringeAmount)/ sum(totalSalaryAmount) * 100, 2) else 0 end) as fringePercentage,
			   sum(total_sal_fte) + sum(total_hrs_fte) AS totalCityFte
			from(
				SELECT  SUM(AMOUNT) as totalFringeAmount, 0 as totalYtdInvoicedAmount,
						0 as totalPositions, 0 as totalSalaryAmount,
						0 as total_sal_fte , 0 as total_hrs_fte
				FROM FRINGE_BENEFIT_DETAIL where sub_budget_id = 
				<choose>
					<when test="budgetTypeId == 2">
					#{subBudgetID,jdbcType=VARCHAR}				
					</when>
				<otherwise>
					(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
				</otherwise>
				</choose>
				UNION
				SELECT 	0 as totalFringeAmount,
						0 as totalYtdInvoicedAmount,
						count(position_id) as totalPositions,
						sum(CITY_salary) as totalSalaryAmount,
						<!-- [Start] QC9111 R7.3.1 Case statement casue Syntax error in runtime -->
            			<!-- QC9111 R7.3.0 implement Accenture Fix - prevent division by 0 during invoice submition --> 
            			<!-- round( sum(((City_Salary / (Annual_Salary)*Hour_Per_Year)) /#{defaultCityFte,jdbcType=VARCHAR} ),2) as total_sal_fte, 0 as total_hrs_fte -->
            			round( sum(CASE   WHEN Annual_Salary=0 THEN 0 
            				       ELSE   (City_Salary / (Annual_Salary)*Hour_Per_Year) /#{defaultCityFte,jdbcType=VARCHAR} end ),2) as total_sal_fte,
            				0 as total_hrs_fte 
            		    <!-- [End] QC9111 R7.3.1 Case statement casue Syntax error in runtime  -->
				FROM personnel_service_detail where sub_budget_id =
				<choose>
					<when test="budgetTypeId == 2">
						#{subBudgetID,jdbcType=VARCHAR}				
					</when>
				<otherwise>
				(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
				</otherwise>
				</choose>
				<!-- Start: Added in R7 for 8650 -->
				and personnel_service_type_id=1
				UNION
				SELECT 	0 as totalFringeAmount,
						0 as totalYtdInvoicedAmount,
						count(position_id) as totalPositions,sum(CITY_salary) As Totalsalaryamount,
						0 as total_sal_fte ,

						<!-- [Start] QC9111 R7.3.1 Case statement casue Syntax error in runtime -->
            			<!-- QC9111 R7.3.0 implement Accenture Fix - prevent division by 0 during invoice submition --> 
            			<!-- round( sum(((City_Salary / rate)) /#{defaultCityFte,jdbcType=VARCHAR} ),2) as total_hrs_fte -->
            			round( sum(CASE WHEN rate=0 THEN 0
            				ELSE (City_Salary / (rate)/#{defaultCityFte,jdbcType=VARCHAR} ) end ),2) as total_hrs_fte
            		    <!-- [End] QC9111 R7.3.1 Case statement casue Syntax error in runtime  -->
				FROM personnel_service_detail where sub_budget_id =
				<choose>
					<when test="budgetTypeId == 2">
						#{subBudgetID,jdbcType=VARCHAR}				
					</when>
				<otherwise>
				(select parent_id from sub_budget where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR})
				</otherwise>
				</choose>
				 and personnel_service_type_id=2 )
				 <!-- End: Added in R7 for Defect 8650 -->
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in R6 -->
	<insert id="createPSDetailReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		INSERT INTO PERSONNEL_SERVICE_DETAIL
      		(PERSONNEL_SERVICE_DETAIL_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,
            HOUR_PER_YEAR,CITY_SALARY,ANNUAL_SALARY,RATE,ACTIVE_FLAG,CREATED_DATE,MODIFIED_DATE,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID,INTERNAL_TITLE)
            (SELECT SEQ_PERSNL_SRVC_DETAIL_ID.NEXTVAL,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,#{budgetId,jdbcType=VARCHAR},#{subBudgetId,jdbcType=VARCHAR},
            '0','0','0','0', ACTIVE_FLAG,CREATED_DATE,MODIFIED_DATE,MODIFIED_BY_STAFFID,CREATED_BY_STAFFID,INTERNAL_TITLE
            from PERSONNEL_SERVICE_DETAIL WHERE SUB_BUDGET_ID = #{parentSubBudgetId})
  	</insert>
  	<!-- End: Added in R6 -->
  	
  	<!-- Start: Added in R6 -->
  	<insert id="createPSSummaryAggregateReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
  		INSERT INTO PERSONNEL_SERVICE
	      (PERSONNEL_SERVICE_ID,PERSONNEL_SERVICE_TYPE_ID,POSITION_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,UNITS,
	      TOTAL_SALARY,ACTIVE_FLAG,CREATED_DATE,MODIFIED_DATE,CREATED_BY_STAFFID,MODIFIED_BY_STAFFID)
	      (SELECT SEQ_PERSONNEL_SERVICES_ID.NEXTVAL, Personnel_Service_Type_Id,Position_Id,#{budgetId,jdbcType=VARCHAR},#{subBudgetId,jdbcType=VARCHAR},
	      SEQ_PERSONNEL_SERVICES_ID.CURRVAL,COUNT_POS_ID,'0','1',SYSTIMESTAMP,SYSTIMESTAMP,#{createdByUserId,jdbcType=VARCHAR},
	      #{modifiedByUserId,jdbcType=VARCHAR}
	      FROM(SELECT Ps.Personnel_Service_Type_Id, Ps.Position_Id,
	      COUNT(Ps.Position_Id)AS COUNT_POS_ID
	      FROM PERSONNEL_SERVICE_DETAIL Ps
	      INNER JOIN Position Pos ON Ps.POSITION_ID= Pos.Position_Id
	      WHERE Ps.Sub_Budget_Id = #{parentSubBudgetId,jdbcType=VARCHAR}
		  GROUP BY Ps.Personnel_Service_Type_Id, Ps.Position_Id
	      ))
  	</insert>
  	<!-- End: Added in R6 -->
  	
  	<!-- Start: Added in R6 -->
  	<insert id="createFringeDetailReplicaNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
         INSERT INTO FRINGE_BENEFIT_DETAIL
            (FRINGE_BENEFIT_DETAIL_ID, FRINGE_BENEFIT_TYPE_ID, BUDGET_ID, SUB_BUDGET_ID, AMOUNT, 
            FRINGE_BENEFIT_ID, 
            ACTIVE_FLAG, CREATED_DATE, CREATED_BY_STAFFID, 
            MODIFIED_BY_STAFFID, 
            CREATED_BY_USERID, MODIFIED_BY_USERID, 
            MODIFIED_DATE, PREV_APPROVED_BUDGET )
            (SELECT SEQ_FRINGE_BENEFIT_DETAIL_ID.nextval, FRINGE_BENEFIT_TYPE_ID, #{budgetId}, 
            #{subBudgetId}, '0', SEQ_FRINGE_BENEFIT_DETAIL_ID.currval, 
            ACTIVE_FLAG, CREATED_DATE, CREATED_BY_STAFFID, 
            MODIFIED_BY_STAFFID, 
            CREATED_BY_USERID, MODIFIED_BY_USERID, 
            MODIFIED_DATE, PREV_APPROVED_BUDGET 
            FROM FRINGE_BENEFIT_DETAIL WHERE SUB_BUDGET_ID = #{parentSubBudgetId})
  	</insert>
  	<!-- End: Added in R6 -->
  	
  	<!-- Start: Added in R6 -->
  	<!-- Updated for 8506 -->
  	<update id="updatePSDetailSummaryIdNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		MERGE INTO PERSONNEL_SERVICE_DETAIL A USING
			(SELECT PS.PERSONNEL_SERVICE_ID,
			  PS.SUB_BUDGET_ID,
			  PS.POSITION_ID,
			  PS.PERSONNEL_SERVICE_TYPE_ID
			FROM PERSONNEL_SERVICE PS
			WHERE PS.SUB_BUDGET_ID = #{subBudgetId}
			)B ON (A.SUB_BUDGET_ID  = B.SUB_BUDGET_ID AND B.POSITION_ID = A.POSITION_ID
			<!-- Start: Added for 8506 -->
			AND A.PERSONNEL_SERVICE_TYPE_ID=B.PERSONNEL_SERVICE_TYPE_ID)
			<!-- End: Added for 8506 -->
			WHEN MATCHED THEN
			  UPDATE SET A.PERSONNEL_SERVICE_ID = B.PERSONNEL_SERVICE_ID
  	</update>
  	<!-- End: Added in R6 -->
  	
  	<!-- Start: Added in R6 -->
  	<!-- Update for 8474 -->
  	<select id="fetchPsSummaryPositions" parameterType="java.lang.String"
		resultType="String">
		select NVL(sum(units),0) from Personnel_Service where Sub_Budget_Id=#{subBudgetId,jdbcType=VARCHAR}
		and PERSONNEL_SERVICE_TYPE_ID in('1','2')
	</select>
	<!-- End: Added in R6 -->
	
	<!-- Start: Added in Defect: 8459 -->
	<select id="getFringeBenefitDetailCount" parameterType="java.lang.String" resultType="int">
		select count(1) from fringe_benefit_detail where sub_budget_id = #{subBudgetId,jdbcType=VARCHAR}
	</select>
	<!-- End: Added in Defect: 8459-->
	<!-- R6 change ends -->
	
<!-- Start Release 6 defect id 8428-->
	<select id="fetchSubBudgetDetailsForAmendmentConf" parameterType="hashmap" resultType="String">
			SELECT SUB_BUDGET_ID
			FROM SUB_BUDGET
			WHERE BUDGET_ID IN
			  (SELECT BUDGET_ID
			  FROM BUDGET
			  WHERE CONTRACT_ID in
			   (select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id = 2 and status_id not in (59,60) and delete_flag = 0)
			  <!-- Start Release 6 defect id 8527 -->
			   and parent_id =#{budgetId}
			  <!-- End Release 6 defect id 8527 -->
			  )
			  <!-- Start Release 6 defect id 8526 -->
			  and parent_id != sub_budget_id
			  <!-- End Release 6 defect id 8526-->
		</select>
			
	<!-- End Release 6 defect id 8428 -->	
	<!-- Start: Added in Release 5.1.0 for Default FTE calculations -->
	<select id="getFullTimeEmpHrPerYear" parameterType="com.nyc.hhs.model.CBGridBean" resultType="String">
		SELECT NVL(FULL_TIME_EMP_HOUR,(SELECT SETTINGS_VALUE FROM APPLICATION_SETTINGS WHERE COMPONENT_NAME LIKE 'DEFAULT_CITY_FTE')) 
		FROM budget WHERE budget_id = (
		<choose>
			<when test="budgetTypeId == 2">#{contractBudgetID,jdbcType=VARCHAR}</when>
			<otherwise>SELECT PARENT_ID FROM BUDGET WHERE BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}</otherwise>
		</choose>
		)
	</select>
	<!-- End: Added in Release 5.1.0 for Default FTE calculations -->
  	
  	<!-- Added in R6: Update query for return payment task status  -->
  	<update id="updateReturnedPaymentStatus" parameterType="com.nyc.hhs.model.ReturnedPayment">
		UPDATE RETURN_PAYMENT RP SET STATUS_ID = #{checkStatus},modified_by_userid = #{modifiedByUserId},modified_date=SYSTIMESTAMP
		<if test="checkStatus == 187">
		,APPROVED_BY = #{modifiedByUserId},
		APPROVED_DATE = systimestamp
		</if>
		WHERE RP.RETURN_PAYMENT_ID = #{returnedPaymentId}
  	</update>
  	<!-- Added in R6: Update query for return payment task status end -->	
	<insert id="insertReturnPayment" parameterType="com.nyc.hhs.model.ReturnedPayment">
		INSERT INTO RETURN_PAYMENT (RETURN_PAYMENT_ID, BUDGET_ID, CHECK_AMOUNT, STATUS_ID, DESCRIPTION, CREATED_DATE,
		MODIFIED_DATE, CREATED_BY_USERID, 
		MODIFIED_BY_USERID, PROVIDER_NOTIFIED, CHECK_RECEIVED, agency_tracking_number ) 
		values(SEQ_RETURN_PAYMENT_ID.nextval,#{budgetId},#{checkAmount}, #{checkStatus}, #{description}, SYSTIMESTAMP, SYSTIMESTAMP, #{createdByUserId},
		#{createdByUserId},#{notifyProvider}, #{checkReceived}, #{agencyTrackingNumber})
      	
      	<selectKey keyProperty="returnedPaymentId" resultType="java.lang.String">
                  select
                  SEQ_RETURN_PAYMENT_ID.currval from Dual
            </selectKey>	
  	</insert>

	<select id="getLastNotifiedDate" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT NVL(to_char(max(created_date), 'mm/dd/yyyy'),'--') NOTIFIED_DATE from
		RETURN_PAYMENT_NOTIF_MAPPING where BUDGET_ID=#{budgetId}
	</select>

	<select id="getUnRecoupedAmount" parameterType="java.lang.String"
		resultType="java.lang.String">
		select NVL((advance_amount-recouped_amount),0) UN_RECOUPED_AMOUNT
		from (
		select sum(amount) advance_amount from budget b, budget_advance ba
		where b.budget_id = ba.budget_id
		and b.budget_id = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId})
		and ba.status_id= 125) a,
		(
		select NVL(sum(amount_recouped),0) recouped_amount from budget b, invoice_advance
		ia,invoice i
		where b.budget_id = ia.budget_id
		and i.invoice_id = ia.invoice_id
		and b.budget_id = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId})
		and i.status_id IN (72,73)) b
	</select>

	<select id="getTotalApprovedRetPayAmount" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT SUM(CHECK_AMOUNT) FROM RETURN_PAYMENT WHERE
		BUDGET_ID = (SELECT PARENT_ID from BUDGET where
		budget_id =
		#{budgetId}) and status_id in (187,186)
	</select>
	
	<!-- Added in R6 : Select Query to get notification History for Returned Payment Starts -->
	<resultMap type="com.nyc.hhs.model.ReturnPaymentNotification" id="NotificationHistory">
		<result property="notificationDate" column="CREATED_DATE" />
		<result property="sentBy" column="NAME" />
		<result property="role" column="ROLE" />
	</resultMap>

	<select id="getLatestReturnedPaymentId" parameterType="java.lang.String" resultType="java.lang.String">
		select max(RETURN_PAYMENT_ID) from RETURN_PAYMENT where created_by_userid=#{lsLoggedInUser}
	</select>
	
	<select id="getNotificationHistory" resultMap="NotificationHistory">
	select pnm.CREATED_DATE, pnm.role,
	CUD.FIRST_NAME
	|| ' '|| CUD.LAST_NAME NAME
	from RETURN_PAYMENT_NOTIF_MAPPING pnm
	left join city_user_details cud on cud.user_id
	= pnm.created_by_userid
	where
	pnm.budget_id = #{asBudgetId} order by pnm.created_date desc
	</select>
  	<!-- Added in R6: Select query for return payment task details  -->
  	<resultMap id="fetchReturnPaymentInfo" type="com.nyc.hhs.model.ReturnedPayment">
		<result property="checkNumber" column="CHECK_NUMBER" />
		<result property="receivedDate" column="RECEIVED_DATE" />
		<result property="approvedBy" column="APPROVED_BY" />
		<result property="checkAmount" column="CHECK_AMOUNT" />
		<result property="description" column="DESCRIPTION" />
		<result property="checkDate" column="CHECK_DATE" />
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
		<result property="contractValue" column="CONTRACT_AMOUNT" />
		<result property="agencyTrackingNumber" column="AGENCY_TRACKING_NUMBER" />
	</resultMap>
		
	<select id="fetchReturnedPaymentSummary" parameterType="hashmap"
		resultMap="fetchReturnPaymentInfo">
		SELECT CHECK_NUMBER,
		(select contract_amount from contract where contract_id = (select contract_id from budget where budget_id = (select budget_id from RETURN_PAYMENT where RETURN_PAYMENT_ID = #{returnPaymentDetailId}))) contract_amount,
		(select fiscal_year_id from budget where budget_id = (select budget_id from RETURN_PAYMENT where RETURN_PAYMENT_ID = #{returnPaymentDetailId})) fiscal_year_id,
		to_char(RECEIVED_DATE,'mm/dd/yyyy') RECEIVED_DATE,
		APPROVED_BY,
		CHECK_AMOUNT,
		DESCRIPTION,
		to_char(CHECK_DATE,'mm/dd/yyyy') CHECK_DATE,
		AGENCY_TRACKING_NUMBER
		FROM
		RETURN_PAYMENT
		WHERE RETURN_PAYMENT_ID = #{returnPaymentDetailId}	
	</select>
	<!-- Added in R6: Select query for return payment task details  -->
	<!-- Added in R6: Update query for return payment table  -->
	<update id="updateReturnPaymentDetail" parameterType="hashmap">
		UPDATE RETURN_PAYMENT
		SET CHECK_AMOUNT =
		#{checkAmount},
		AGENCY_TRACKING_NUMBER =
		#{agencyTracking},
		CHECK_NUMBER =
		#{checkNumber},
		CHECK_DATE =
		to_date(#{checkDate},'MM/DD/YYYY'),
		RECEIVED_DATE =
		to_date(#{receivedDate},'MM/DD/YYYY'),
		DESCRIPTION =
		#{descriptionInput},
		modified_by_userid = #{userId},
		modified_date = systimestamp
		WHERE RETURN_PAYMENT_ID = #{returnPaymentDetailId}
	</update>
	<!-- Added in R6: Update query for return payment table end -->
   <!-- Added in R6: Select Query to get notification History for Returned Payment Ends -->
	
	<!-- Added in R6 : Select Query to get returned payment summary for particular Returned Payment Starts -->
	<resultMap type="com.nyc.hhs.model.ReturnedPayment" id="ReturnedPaymentSumaryDB">
		<result property="checkNumber" column="CHECK_NUMBER" />
		<result property="checkAmount" column="CHECK_AMOUNT" />
		<result property="receivedDate" column="RECEIVED_DATE" />
		<result property="approvedDate" column="APPROVED_DATE" />
		<result property="approvedBy" column="APPROVED_BY" />
		<result property="description" column="DESCRIPTION" />
		<result property="returnedPaymentId" column="RETURN_PAYMENT_ID" />
		<result property="checkStatus" column="STATUS_ID" />
		<result property="checkDate" column="CHECK_DATE" />
		<result property="checkStatusName" column="STATUS" />
		<result property="agencyTrackingNumber" column="AGENCY_TRACKING_NUMBER" />
		<result property="budgetStatusId" column="budget_status" />
		<result property="checkStatusName" column="status" />
		<!--[Start] QC9701  -->
		<result property="agencyId" column="agency_id" />
		<!--[End] QC9701  -->
		<result property="updatedDate" column="modified_date" />
		<result property="updatedByUser" column="modified_by_userid" />
	</resultMap>

	<select id="getReturnedPaymentSumaryDB" resultMap="ReturnedPaymentSumaryDB"
		parameterType="java.lang.String">
		SELECT rp.RETURN_PAYMENT_ID,NVL(to_char(rp.CHECK_NUMBER),'--') CHECK_NUMBER,
		       NVL(to_char(rp.RECEIVED_DATE,'mm/dd/yyyy'),'--') RECEIVED_DATE,
		       NVL(LTRIM(RTRIM(ct.first_name || ' ' || ct.last_name)),'--')  APPROVED_BY,
		       rp.CHECK_AMOUNT, rp.STATUS_ID, rp.DESCRIPTION,
		       to_char(rp.APPROVED_DATE,'mm/dd/yyyy') APPROVED_DATE,
		       to_char(rp.CHECK_DATE,'mm/dd/yyyy') CHECK_DATE, st.STATUS, 
		       <!--[Start] QC9701  -->
		       bd.agency_id  as  agency_id,
		       <!--[End] QC9701  -->
		       NVL(to_char(rp.AGENCY_TRACKING_NUMBER),'--') AGENCY_TRACKING_NUMBER, bd.status_id budget_status
		FROM RETURN_PAYMENT rp
		left outer join status_master_r2_r3 st on rp.status_id = st.status_id
		left outer join city_user_details ct on ct.user_id = rp.approved_by
		left outer join budget bd on rp.budget_id = bd.budget_id
		WHERE rp.BUDGET_ID =(SELECT PARENT_ID from BUDGET 
		where budget_id = #{budgetId}) order by rp.status_id asc
	</select>

	<select id="getDocIFordReturnedPaymentSumaryDB" parameterType="string"
		resultType="string">
		SELECT DOCUMENT_IDENTIFIER_ID FROM RETURN_PAYMENT_DOCUMENT
		WHERE RETURN_PAYMENT_ID = #{asReturnPaymentId}
	</select>

	<select id="getReturnedPaymentSummary" resultMap="ReturnedPaymentSumaryDB">
		SELECT
		NVL(to_char(rp.CHECK_NUMBER),'--') CHECK_NUMBER, NVL(to_char(rp.RECEIVED_DATE,'mm/dd/yyyy'),'--')
		RECEIVED_DATE,
		NVL(LTRIM(RTRIM(ct.first_name || ' ' || ct.last_name)),'--') APPROVED_BY, rp.CHECK_AMOUNT,
		rp.STATUS_ID, rp.DESCRIPTION,
		NVL(to_char(rp.APPROVED_DATE,'mm/dd/yyyy'),'--') APPROVED_DATE,
		NVL(to_char(rp.CHECK_DATE,'mm/dd/yyyy'),'--') CHECK_DATE
		,NVL(to_char(rp.AGENCY_TRACKING_NUMBER),'--') AGENCY_TRACKING_NUMBER,
		sm.status, NVL(to_char(rp.modified_date,'mm/dd/yyyy'),'--')
		modified_date, NVL((Select LTRIM(RTRIM(ct1.first_name
		|| ' '
		|| ct1.last_name)) modified_by_userid from city_user_details ct1,
		RETURN_PAYMENT rp1 where ct1.user_id = rp1.modified_by_userid and
		rp1.RETURN_PAYMENT_ID = #{returnedPaymentId,jdbcType=VARCHAR}) ,'--')
		modified_by_userid
		FROM RETURN_PAYMENT rp
		left outer join city_user_details ct on ct.user_id = rp.approved_by
		left join status_master_r2_r3 sm on sm.status_id = rp.status_id
		WHERE RETURN_PAYMENT_ID =
		#{returnedPaymentId,jdbcType=VARCHAR}
	</select>
	<!-- Added in R6 : Select Query to get returned payment summary for particular Returned Payment ends -->
	<!-- Added for R6- Returned payment documents insertion-->
	<insert id="insertReturnedPaymentDocumentDetails" parameterType="java.util.Map">
		INSERT
		INTO RETURN_PAYMENT_DOCUMENT
		(RETURN_PAYMENT_DOC_ID,
		RETURN_PAYMENT_ID,
		CREATED_DATE,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		DOCUMENT_IDENTIFIER_ID,
		CREATED_BY_USERID,
		DOCUMENT_TYPE
		)
		VALUES
		(SEQ_RETURN_PAYMENT_DOC_ID.NEXTVAL,
		#{returnPaymentDetailId},
		current_timestamp,
		current_timestamp,
		#{userId},
		#{documentId},
		#{userId},
		#{DOC_TYPE}
		)
    </insert>
	<select id="getReturnedPaymentStatus" resultType="java.lang.String">
		SELECT
		status_id
		FROM RETURN_PAYMENT
		WHERE RETURN_PAYMENT_ID =
		#{returnedPaymentId,jdbcType=VARCHAR}
	</select>
    	<!-- Added for R6- Returned payment documents insertion-->
	
	<!-- Start : R7 Program Income -->
	<select id="isPICategoryInBudgetCustomization" resultType="java.lang.String" parameterType="java.util.Map">
		select count(budget_customization_id) from budget_customization where
		budget_id IN (select budget_id from budget where contract_id =
		#{contractId}
		<if test="fiscalYearID != null">
			and fiscal_year_id = #{fiscalYearID}
		</if>
		) and entry_type_id=11
	</select>

	<select id="isPIInBudgetCustomizationForBaseBudget" resultType="java.lang.String" parameterType="java.util.Map">
		select count(budget_customization_id) from budget_customization where
		budget_id IN (select
		parent_id from budget where contract_id = #{contractId} 
		<if test="fiscalYearID != null">
			and fiscal_year_id = #{fiscalYearID}
		</if>
		<!-- Removed check because amendment budgets are always in status 106 at this point -->
		<!-- and status_id not in (106) -->
		and delete_flag=0
		) and
		entry_type_id=11 
	</select>

	<!-- delete default PI entries for base budge, amendment budget and update budget till date -->
	<delete id="deleteDefaultPIEntries" parameterType="java.util.Map">
		DELETE FROM
		program_income WHERE budget_id IN
		(SELECT budget_id FROM
		budget WHERE contract_id IN (SELECT contract_id
		FROM contract
		WHERE parent_contract_id =
		(SELECT parent_contract_id FROM contract WHERE contract_id = #{contractId}
		)
		<!-- Delete all those entries which are in pending configuration -->
		and contract_type_id not in (6)
		)
		<if test="fiscalYearID != null">
			and fiscal_year_id = #{fiscalYearID}
		</if>
		)
	</delete>
	 
	 <!-- Update is_old_pi flag for base budget and particulat budget of that fiscal year (i.e amendment or update) -->
	 <update id="updateIsOldPIFlag" parameterType="java.util.Map">

	UPDATE budget b
	SET is_old_pi = #{piStatus, jdbcType=VARCHAR},
	modified_date = SYSTIMESTAMP,
	MODIFIED_BY_USERID = #{modifyByAgency,jdbcType=VARCHAR}
	WHERE b.budget_id IN (with budget_detail as (SELECT parent_id, budget_id
	FROM budget WHERE budget_id IN(SELECT budget_id FROM budget WHERE
	contract_id = #{contractId})
	<if test="fiscalYearID != null">
		and fiscal_year_id = #{fiscalYearID}
	</if>
	)
	select b.budget_id from budget b,budget_detail where b.budget_id
	in(budget_detail.parent_id,budget_detail.budget_id))
		
	</update>

	
	
	<select id="fetchPIIndirectRatePercentage" parameterType="com.nyc.hhs.model.CBGridBean"
		resultType="String">
		select ROUND(nvl(PI_INDIRECT_RATE,0),2) from indirect_rate where
		sub_budget_id in
		(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
		and active_flag = 1 and rownum = 1
    </select>

	<resultMap id="amendAffectedBudgetMap" type="com.nyc.hhs.model.ContractBean">
		<result property="amendAffectedBudgetId" column="budget_id" />
		<result property="contractStartFiscalYear" column="fiscal_year_id" />
	</resultMap>

	<select id="fetchAffectedBudgetFYList" resultMap="amendAffectedBudgetMap"
		parameterType="java.util.Map">
		<!-- SELECT budget_id, fiscal_year_id FROM budget WHERE contract_id = #{contractId} -->
		SELECT budget_id, fiscal_year_id
		FROM budget
		WHERE contract_id = #{contractId} and fiscal_year_id IN (SELECT
		fiscal_year_id FROM budget WHERE budget_id in
		(select parent_id from budget where contract_id = #{contractId}) and status_id not in (106))
	</select>
	
	
	<select id="prevAmendUpdtPIBudgetCustCount"  resultType="java.lang.String" parameterType="java.util.Map">
		select count(budget_customization_id) from budget_customization where budget_id in (  
		SELECT budget_id
		FROM budget
		WHERE contract_id IN
		  (SELECT contract_id
		  FROM contract
		  WHERE parent_contract_id =
		    (SELECT parent_contract_id FROM contract WHERE contract_id = #{contractId}
		)
		    and contract_type_id IN (2,4)
		     and contract_id!=#{contractId}
		     and status_id not in (67,68,69)
		)
		AND fiscal_year_id = #{fiscalYearID}
		AND active_flag = '1'
		and status_id not in (106)
		and delete_flag=0
		<!-- status 67,68,69 is removed, since those status are for contract -->
		) and entry_type_id = 11
	</select>
	
	<select id="isOldPIFromContract" parameterType="java.util.Map">
		select NVL(is_old_pi,1) from budget where
		budget_id = (select parent_id from budget where budget_id = #{contractId, jdbcType=VARCHAR} and fiscal_year_id = #{fiscalYearID})
	</select>

	<select id="fetchSources" resultType="java.lang.String">
		select
		Program_income_type_id||':'||Program_income_type from
		Program_income_type
		order by Program_income_type_id
	</select>

	<insert id="insertProgramIncomeGrid" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		Insert into
		PROGRAM_INCOME
		(
		PROGRAM_INCOME_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PROGRAM_INCOME_TYPE_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		DESCRIPTION,
		ENTRY_TYPE_ID
		)
		values
		(
		SEQ_PROGRAM_INCOME_ID.nextval,
		#{contractBudgetID},
		#{subBudgetID},
		#{empPosition,jdbcType=VARCHAR},
		SEQ_PROGRAM_INCOME_ID.currval,
		#{fYBudget},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{modifyByAgency,jdbcType=VARCHAR},
		#{modifyByProvider,jdbcType=VARCHAR},
		'1',
		#{description},
		#{entryTypeId}
		)
	</insert>

	<delete id="deleteProgramIncome" parameterType="com.nyc.hhs.model.CBProgramIncomeBean">
		DELETE FROM
		program_income where program_income_id = #{id}
	</delete>
	 <!-- End : R7 Program Income -->
	 <!--Start: Added in R7 For Cost-Center-->
	
	<select id="fetchCostCenterOpted" parameterType="java.util.Map" resultType="java.lang.String">
		select COST_CENTER_OPTED from Contract where CONTRACT_ID=(
		CASE WHEN (select contract_type_id as id from contract where contract_id = #{contractId}) = 3 
		THEN (select contract_id from contract where contract_id = #{contractId}) ELSE
  		(select parent_contract_id from contract where contract_id = #{contractId} ) END)
	</select>
	
	<insert id="insertCostCentreDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		insert 
		into COST_CENTER_DETAILS 
		(COST_CENTER_DETAILS_ID,
		COST_CENTER_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_AMOUNT,
		YTD_INVOICED_AMOUNT,
		REMAINING_AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		REPORTING_MODIFIED_DATE,
		PARENT_ID)
		( select SEQ_COST_CENTER_DETAILS.NEXTVAL, 
		master.ids,
		#{contractBudgetID},
		#{subBudgetID},
		0,
		0,
		0,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{modifiedByUserId},
		'system',
		'system',
		1,
		SYSTIMESTAMP,
		SEQ_COST_CENTER_DETAILS.currval 
		from (select distinct(COST_CENTER_MASTER_ID) as ids 
		from cost_center_services_mapping ccm 
		left join 
		budget_services_configuration bs 
		on 
		bs.COST_CENTER_SERVICE_MAPPING_ID = ccm.COST_CENTER_SERVICE_MAPPING_ID 
		where bs.active_flag='1' and
		budget_id in (
		<if test="newRecord != null">
		select parent_id from budget where budget_id=#{contractBudgetID}
   		union 
   		</if>
   		select budget_id from budget where budget_id=#{contractBudgetID} )
   		minus
   		select distinct(COST_CENTER_ID) as ids
   		from COST_CENTER_DETAILS 
   		where 
   		budget_id = #{contractBudgetID} and sub_budget_id = #{subBudgetID}
		<if test="newRecord == null">
		minus
  		select distinct(COST_CENTER_MASTER_ID) as ids 
		from cost_center_services_mapping ccm 
		left join 
		budget_services_configuration bs 
		on 
		bs.COST_CENTER_SERVICE_MAPPING_ID = ccm.COST_CENTER_SERVICE_MAPPING_ID 
		where  bs.active_flag='1' and
		budget_id in (
  		select parent_id from budget where budget_id=#{contractBudgetID})
		</if>
		) master)
	</insert>
	
	<insert id="insertServicesDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		insert 
		into BC_SERVICES_DETAILS 
		(BC_SERVICES_DETAIL_ID,
		BUDGET_SERVICES_CONFIG_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_INCOME,
		YTD_INVOICE_INCOME,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PARENT_ID,
		REPORTING_MODIFIED_DATE,
		FY_BUDGET_UNITS,
		REMAINING_AMOUNT,
		REMAINING_UNITS,
		YTD_INVOICED_UNITS)
		(select SEQ_SERVICES_DETAIL.NEXTVAL, 
		master.ids,
		#{contractBudgetID},
		#{subBudgetID},
		0,
		0,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{modifiedByUserId},
		'system',
		'system',
		1,
		SEQ_SERVICES_DETAIL.currval,
		SYSTIMESTAMP,
		0,
		0,
		0,
		0
		from (select distinct(BUDGET_SERVICES_CONFIG_ID) as ids 
		from budget_services_configuration where active_flag='1' and 
		budget_id in (
		<if test="newRecord != null">
		select parent_id from budget where budget_id=#{contractBudgetID}
   		union 
   		</if>
   		select budget_id from budget where budget_id=#{contractBudgetID})
   		minus
  		select distinct(BUDGET_SERVICES_CONFIG_ID) as ids from
		BC_SERVICES_DETAILS where active_flag='1' and
		budget_id = #{contractBudgetID} and sub_budget_id = #{subBudgetID}
		) master)
	</insert>
	
	<delete id="deleteCostCenterDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		delete from COST_CENTER_DETAILS 
		where 
		BUDGET_ID=#{contractBudgetID}
		and
		SUB_BUDGET_ID=#{subBudgetID}
	</delete>
	
	<delete id="deleteServicesDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		delete from BC_SERVICES_DETAILS 
		where 
		BUDGET_ID=#{contractBudgetID}
		and
		SUB_BUDGET_ID=#{subBudgetID}
	</delete>
	
	<select id="fetchFlag" parameterType="java.lang.String" resultType="Integer">
        select distinct (CASE WHEN (select CONTRACT_TYPE_ID from contract where contract_id=(select contract_id from budget where budget_id=#{budgetId}))= 3 
        Then (select COST_CENTER_OPTED from contract where contract_id=(select contract_id from budget where budget_id=#{budgetId}))
        ELSE (select COST_CENTER_OPTED from contract where contract_id= (select parent_contract_id from contract where contract_id
        =(select contract_id from budget where budget_id=#{budgetId})
  				)) END) as cost_center_opted from contract
    </select>
    
    <select id="fetchSubBudgetIDListForUpdate" resultMap="BudgetDetailsCBGridBean"
		parameterType="java.util.Map">
		select 
			budget_id, 
			sub_budget_id 
		from 
			sub_budget
		where
			budget_id in (select budget_id from budget where fiscal_year_id = #{fiscalYearId}
						  		and contract_id = #{contractId})	
		and sub_budget_id != parent_id
		and active_flag = '1'
	</select>
				
	<resultMap id="fetchSubBudgetInfo" type="com.nyc.hhs.model.CBGridBean">
		<result property="subBudgetID" column="SUB_BUDGET_ID" />
		<result property="parentSubBudgetId" column="PARENT_ID" />
	</resultMap>
	<select id="isOldPI" resultType="java.lang.String">
select NVL(is_old_pi,1) from budget where
		budget_id = (select parent_id from budget where budget_id = #{contractBudgetID, jdbcType=VARCHAR})
	</select>
	<select id="fetchSubBudgetDetails" parameterType="java.util.Map"
		resultMap="fetchSubBudgetInfo">
		SELECT SUB_BUDGET_ID,
		PARENT_ID
		FROM
		SUB_BUDGET
		WHERE BUDGET_ID = #{budgetId} AND ACTIVE_FLAG = '1'
	</select>
		
	<select id="fetchBudgetTypeId" parameterType="String"
		resultType="String">
		SELECT BUDGET_TYPE_ID FROM BUDGET WHERE BUDGET_ID=#{budgetId}
	</select>
				
	<!--End: Added in R7 For Cost-Center-->
	
		
<!-- Start: Added in R7 for Cost-Center -->
	<resultMap id="ServicesList" type="com.nyc.hhs.model.CBServicesBean">
		<result property="serviceName" column="SERVICE_NAME" />
		<result property="fyBudget" column="FY_BUDGET_INCOME" />
		<result property="ytdInvoicedAmt" column="YTD_INVOICE_INCOME" />
		<result property="remainingAmt" column="REMAINING_AMOUNT"/>
		<result property="units" column="FY_BUDGET_UNITS" />
		<result property="ytdUnits" column="YTD_INVOICED_UNITS" />
		<result property="remUnits" column="REMAINING_UNITS" />
		<result property="id" column="id" />
	</resultMap>
	
	<select id="fetchServiceData" resultMap="ServicesList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT services_master.service_name,
  		BC_SERVICES_DETAILS .FY_BUDGET_UNITS,
 		 BC_SERVICES_DETAILS .YTD_INVOICED_UNITS,
  		BC_SERVICES_DETAILS .REMAINING_UNITS ,
  		BC_SERVICES_DETAILS .FY_BUDGET_INCOME,
  		BC_SERVICES_DETAILS .YTD_INVOICE_INCOME,
  		BC_SERVICES_DETAILS .REMAINING_AMOUNT,
  		BC_SERVICES_DETAILS .BC_SERVICES_DETAIL_ID   as id
		FROM BC_SERVICES_DETAILS 
		INNER JOIN BUDGET_SERVICES_CONFIGURATION
		ON BC_SERVICES_DETAILS .BUDGET_SERVICES_CONFIG_ID= BUDGET_SERVICES_CONFIGURATION.BUDGET_SERVICES_CONFIG_ID 
		inner join COST_CENTER_SERVICES_MAPPING
		on BUDGET_SERVICES_CONFIGURATION.COST_CENTER_SERVICE_MAPPING_ID=COST_CENTER_SERVICES_MAPPING.COST_CENTER_SERVICE_MAPPING_ID
		inner join SERVICES_MASTER
		on COST_CENTER_SERVICES_MAPPING.SERVICE_MASTER_ID=SERVICES_MASTER.SERVICE_MASTER_ID
		where BC_SERVICES_DETAILS.SUB_BUDGET_ID=#{subBudgetID}
	</select>
<!-- Added for R7- fetch service details on service grid -->
	
	<update id="updateServicesList" parameterType="com.nyc.hhs.model.CBServicesBean">
		UPDATE BC_SERVICES_DETAILS 
		SET
		FY_BUDGET_UNITS = #{units},
		REMAINING_UNITS = #{units},
		FY_BUDGET_INCOME = #{fyBudget},
		MODIFIED_DATE = SYSTIMESTAMP, 
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE BC_SERVICES_DETAIL_ID  = #{id}
	</update>
<!-- Added for R7- update service details -->	
	
	<resultMap id="CostList" type="com.nyc.hhs.model.CBServicesBean">
		<result property="costCenterName" column="COST_CENTER_NAME" />
		<result property="fyBudget" column="FY_BUDGET_AMOUNT" />
		<result property="ytdInvoicedAmt" column="YTD_INVOICED_AMOUNT" />
		<result property="remainingAmt" column="REMAINING_AMOUNT" />
		<result property="id" column="id" />
	</resultMap>
	<select id="fetchCostData" resultMap="CostList"
		parameterType="com.nyc.hhs.model.CBGridBean">
		SELECT COST_CENTER_MASTER.COST_CENTER_NAME,
 		COST_CENTER_DETAILS.FY_BUDGET_AMOUNT,
 	 	COST_CENTER_DETAILS.YTD_INVOICED_AMOUNT,
  		COST_CENTER_DETAILS.REMAINING_AMOUNT,
  		COST_CENTER_DETAILS.COST_CENTER_DETAILS_ID as id
		FROM COST_CENTER_DETAILS
		INNER JOIN COST_CENTER_MASTER
		ON COST_CENTER_DETAILS.COST_CENTER_ID= COST_CENTER_MASTER.COST_CENTER_MASTER_ID
		where COST_CENTER_DETAILS.SUB_BUDGET_ID=#{subBudgetID}
	</select>
<!-- Added for R7-fetch cost center details on cost center grid -->	

	<update id="updateCostCenterList" parameterType="com.nyc.hhs.model.CBServicesBean">
		UPDATE COST_CENTER_DETAILS
		SET
		FY_BUDGET_AMOUNT = #{fyBudget},
		MODIFIED_DATE = SYSTIMESTAMP, 
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE COST_CENTER_DETAILS_ID = #{id}
	</update>
<!-- Added for R7- update cost center details -->
	
	<select id="fetchCostCenterAmountTotal" parameterType="hashmap"
		resultType="BigDecimal">
		select NVL(sum(a.FY_BUDGET_AMOUNT),0) as total  
		from COST_CENTER_DETAILS a
		where a.sub_budget_id=#{subBudgetId} and
		a.budget_id=#{budgetId} 
	</select>
	
	<select id="fetchSubBudgetAmount" parameterType="java.lang.String"
		resultType="BigDecimal">
		  select sub_budget_amount from sub_budget where sub_budget_id = #{aoSubBudgetId}
	</select>
	<!-- End in R7 for PI indirect rate updation -->
	
	<select id="fetchOutYearAmendmentSubBudgetIDList" resultMap="BudgetDetailsCBGridBean"
		parameterType="java.util.Map">
		select 
			budget_id, 
			sub_budget_id 
		from 
			sub_budget
		where
			budget_id in (select budget_id from budget where fiscal_year_id =#{fiscalYearId}
		and contract_id  in (select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id=2))
		and active_flag = '1'
	</select>
<!-- End: Added in R7 for Cost-Center -->
	<!-- Added in R7 for program income -->
	<update id="updateIsOldPIFlagForOldPI" parameterType="java.lang.String">
		UPDATE
		budget SET
		is_old_pi = (SELECT nvl(is_old_pi,1) AS is_old_pi
		FROM budget
		WHERE
		budget_id= (SELECT parent_id FROM budget WHERE
		budget_id=#{budgetId}))
		WHERE
		budget_id =#{budgetId} AND (SELECT
		count(budget_customization_id) AS count
		FROM
		budget_customization
		where
		budget_id =(SELECT parent_id FROM budget
		WHERE budget_id=#{budgetId})
		and
		entry_type_id=11) > 0
	</update>
	<!-- R7 Program income changes end -->
	
	<!-- [Start] R7.4.0:QC 9008 Added for deleting contract budget update -->
	
	<resultMap id="BudgetUpdateSummary" type="com.nyc.hhs.model.BudgetList">
		<result property="contractId" column="CONTRACT_ID" />
		<result property="ctNumber" column="EXT_CT_NUMBER" />
		<result property="ePin" column="EXT_EPIN" />
		<result property="programName" column="PROGRAM_NAME" />
		<result property="fiscalYearId" column="FISCAL_YEAR_IDS" />
		<result property="contractTitle" column="CONTRACT_TITLE" />
		<result property="providerName" column="ORGANIZATION_LEGAL_NAME" />
		<result property="agencyId" column="AGENCY_ID" />
		<result property="budgetType" column="BUDGET_TYPE_ID" />		
	</resultMap>

		<select id="fetchBudgetUpdate4Del" resultMap="BudgetUpdateSummary" parameterType="java.util.HashMap">
          select  con.CONTRACT_ID  , con.EXT_CT_NUMBER, con.EXT_EPIN,  prom.PROGRAM_NAME, bud.FISCAL_YEAR_IDS, con.CONTRACT_TITLE
                 , org.ORGANIZATION_LEGAL_NAME, con.AGENCY_ID ,  #{asBudgetTypeId} as BUDGET_TYPE_ID
            from contract con,  PROGRAM_MASTER prom , Organization org
                 , (select CONTRACT_ID, LISTAGG(FISCAL_YEAR_ID, ',') WITHIN GROUP (ORDER BY BUDGET_ID ASC)  as Fiscal_year_ids FROM BUDGET  
					where CONTRACT_ID = #{asContractId}
					and   BUDGET_TYPE_ID = #{asBudgetTypeId}
					and   STATUS_ID in ( 82, 83, 84 )
					group by CONTRACT_ID
					) bud
			where con.CONTRACT_ID   = bud.CONTRACT_ID
			and   con.PROGRAM_ID  = prom.PROGRAM_ID
			and   con.ORGANIZATION_ID = org.ORGANIZATION_ID
        </select>

        <delete id="deleteBudgetUpdateTask" parameterType="java.util.Map">
        {call
	        BEGIN
					
					delete from   SUB_BUDGET_SITE                      where SUB_BUDGET_ID in (select SUB_BUDGET_ID from SUB_BUDGET where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID =#{asContractId} ));
					
					delete from   BC_SERVICES_DETAILS                  where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   CONTRACTED_SERVICE                   where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   COST_CENTER_DETAILS                  where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   ADVANCE_ASSIGNMENT                   where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   BUDGET_SERVICES_CONFIGURATION        where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   ASSIGNMENT                           where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   RENT                                 where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   BUDGET_APPROVAL_DETAILS              where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   OPERATIONS_AND_SUPPORT               where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   PROGRAM_INCOME                       where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   UNALLOCATED                          where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   RATE                                 where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   PROFESSIONAL_SERVICE                 where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   PERSONNEL_SERVICE_DETAIL             where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   PERSONNEL_SERVICE                    where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   UTILITIES                            where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   INDIRECT_RATE                        where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   MILESTONE                            where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   EQUIPMENT                            where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   FRINGE_BENEFIT_DETAIL                where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					delete from   FRINGE_BENEFIT                       where BUDGET_ID in (select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					
					delete from   DEFAULT_ASSIGNMENT                   where CONTRACT_ID = #{asContractId};
					delete from   TAXONOMY_TAGGING                     where CONTRACT_ID = #{asContractId};
					delete from   CONTRACT_FIN_FUNDING_STREAM          where CONTRACT_ID = #{asContractId};
					delete from   CONTRACT_FINANCIALS                  where CONTRACT_ID = #{asContractId};
					delete from   CONTRACT_DOCUMENT                    where CONTRACT_ID = #{asContractId};
					delete from   BUDGET_DOCUMENT                      where CONTRACT_ID = #{asContractId};
					delete from   BUDGET_CUSTOMIZATION                 where CONTRACT_ID = #{asContractId};
					delete from   FLAG_CONTRACT_HISTORY                where CONTRACT_ID = #{asContractId};
					
					delete from   SUB_BUDGET                           where BUDGET_ID in ( select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractId} );
					
					delete from   BUDGET                               where CONTRACT_ID = #{asContractId};
					
					delete from   CONTRACT                             where CONTRACT_ID = #{asContractId};

	        END
	    }	
        </delete>
	<!-- [End] R7.4.0:QC 9008 Added for deleting contract budget update -->
	
	<!-- Start: QC 9156 R 7.5.0 Accenture fix: Cost Center Records not created for "Original" Budget (BUDGET_TYPE_ID = 5) -->
	<insert id="createCostCenterReplica" parameterType="java.util.Map">
		INSERT INTO COST_CENTER_DETAILS
		(COST_CENTER_DETAILS_ID,
		COST_CENTER_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_AMOUNT,
		YTD_INVOICED_AMOUNT,
		REMAINING_AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		REPORTING_MODIFIED_DATE,
		PARENT_ID)
		(SELECT SEQ_COST_CENTER_DETAILS.NEXTVAL, COST_CENTER_ID, #{repBudgetId},#{repSubBudgetId},
		FY_BUDGET_AMOUNT, YTD_INVOICED_AMOUNT, REMAINING_AMOUNT, CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,CREATED_BY_STAFFID,MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,REPORTING_MODIFIED_DATE, SEQ_COST_CENTER_DETAILS.CURRVAL
		FROM COST_CENTER_DETAILS WHERE SUB_BUDGET_ID = #{origSubBudgetId})
  </insert>
  
  <insert id="createServicesReplica" parameterType="java.util.Map">
		INSERT INTO BC_SERVICES_DETAILS
		(BC_SERVICES_DETAIL_ID,
		BUDGET_SERVICES_CONFIG_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		FY_BUDGET_INCOME,
		YTD_INVOICE_INCOME,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		PARENT_ID,
		REPORTING_MODIFIED_DATE,
		FY_BUDGET_UNITS,
		REMAINING_AMOUNT,
		REMAINING_UNITS,
		YTD_INVOICED_UNITS)
		(SELECT SEQ_SERVICES_DETAIL.NEXTVAL, BUDGET_SERVICES_CONFIG_ID, #{repBudgetId},#{repSubBudgetId},
		FY_BUDGET_INCOME, YTD_INVOICE_INCOME,CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,CREATED_BY_STAFFID,MODIFIED_BY_STAFFID,
		ACTIVE_FLAG, SEQ_SERVICES_DETAIL.CURRVAL, REPORTING_MODIFIED_DATE,FY_BUDGET_UNITS, REMAINING_AMOUNT, REMAINING_UNITS, YTD_INVOICED_UNITS
		FROM BC_SERVICES_DETAILS WHERE SUB_BUDGET_ID = #{origSubBudgetId})
  </insert>
  
  <insert id="createServicesConfigReplica" parameterType="java.util.Map">
		INSERT INTO BUDGET_SERVICES_CONFIGURATION
      	(
		    BUDGET_SERVICES_CONFIG_ID,
		    BUDGET_ID,
		    COST_CENTER_SERVICE_MAPPING_ID,
		    CREATED_DATE ,
		    CREATED_BY_USERID ,
		    MODIFIED_DATE ,
		    MODIFIED_BY_USERID ,
		    ACTIVE_FLAG,
		    PARENT_ID
		)
		(SELECT SEQ_BUDGET_SERVICES_CONFIG.nextval, #{repBudgetId},COST_CENTER_SERVICE_MAPPING_ID,CREATED_DATE, CREATED_BY_USERID, MODIFIED_DATE, MODIFIED_BY_USERID,
		ACTIVE_FLAG, SEQ_BUDGET_SERVICES_CONFIG.CURRVAL
		FROM BUDGET_SERVICES_CONFIGURATION WHERE BUDGET_ID = #{budgetId})
  </insert>
  
	<!--End: QC 9156 R 7.5.0 Accenture fix: Cost Center Records not created for "Original" Budget (BUDGET_TYPE_ID = 5) -->
	
	
<!--  Start QC 8394 R 7.9.0 Financials Enhancement Request: Enable providers to add budget lines with custom text to the budget Unallocated Tab -->
      
	 <!-- Added for R6- Delete Returned payment documents end -->
	<resultMap id="UnallocatedFundList" type="com.nyc.hhs.model.UnallocatedFunds">
		<result property="id" column="UNALLOCATED_ID" />
		<result property="unallocatedFund" column="UNALLOCATED_FUND" />
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="modifyByAgency" column="CREATED_BY_USERID" />
		<result property="modifyByProvider" column="CREATED_BY_STAFFID" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifyByAgency" column="MODIFIED_BY_USERID" />
		<result property="modifyByProvider" column="MODIFIED_BY_STAFFID" />
		<result property="contractID" column="CONTRACT_ID" />
		<result property="modificationAmount" column="MODIFICATION_AMOUNT" />
		<result property="ammountMod" column="ORIGINAL_AMOUNT" />
		<result property="modCount" column="MODIFICATION_COUNT" />
	</resultMap>

	<select id="fetchUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds"
		resultMap="UnallocatedFundList">
		SELECT unAloc.UNALLOCATED_ID, 
				unAloc.UNALLOCATED_FUND, 
				unAloc.BUDGET_ID,
				unAloc.SUB_BUDGET_ID,
				unAloc.AMOUNT,
				unAloc.CREATED_DATE,
				unAloc.CREATED_BY_USERID ,
				unAloc.CREATED_BY_STAFFID,
				unAloc.MODIFIED_DATE,
				unAloc.MODIFIED_BY_USERID,
				unAloc.MODIFIED_BY_STAFFID,
				unAloc.ACTIVE_FLAG
		FROM UNALLOCATED unAloc
		where 	unAloc.SUB_BUDGET_ID = #{subBudgetId} 
		order by unAloc.UNALLOCATED_ID desc
	</select>

	<insert id="insertUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
		insert into
		UNALLOCATED(UNALLOCATED_ID,
		BUDGET_ID,
		SUB_BUDGET_ID,
		PARENT_ID,
		AMOUNT,
		CREATED_DATE,
		CREATED_BY_USERID,
		CREATED_BY_STAFFID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID,
		MODIFIED_BY_STAFFID,
		ACTIVE_FLAG,
		UNALLOCATED_ID
		)
		values
		(SEQ_UNALLOCATED_ID.NEXTVAL,
		#{budgetId},
		#{subBudgetID},
		SEQ_UNALLOCATED_ID.CURRVAL,
		#{ammount},
		current_timestamp,
		#{modifyByAgency},
		#{modifyByProvider},
		current_timestamp,
		#{modifyByAgency},
		#{modifyByProvider},
		'1',
		'Unallocated Fund'
		)
	</insert>
	
	<insert id="addUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
		insert into
		UNALLOCATED(
			UNALLOCATED_ID,
			UNALLOCATED_FUND,
			BUDGET_ID,
			SUB_BUDGET_ID,
			PARENT_ID,
			AMOUNT,
			CREATED_DATE,
			CREATED_BY_USERID,
			CREATED_BY_STAFFID,
			MODIFIED_DATE,
			MODIFIED_BY_USERID,
			MODIFIED_BY_STAFFID,
			ACTIVE_FLAG)
		values
		(
			SEQ_UNALLOCATED_ID.NEXTVAL,
			#{unallocatedFund},
			#{contractBudgetID},
			#{subBudgetID},
			SEQ_UNALLOCATED_ID.CURRVAL,
			#{ammount},
			current_timestamp,
			#{modifyByAgency},
			#{modifyByProvider},
			current_timestamp,
			#{modifyByAgency},
			#{modifyByProvider},
			'1'
		)
	</insert>

	<update id="updateUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
		UPDATE
		UNALLOCATED SET
		AMOUNT = #{ammount},
		UNALLOCATED_FUND = #{unallocatedFund},
		MODIFIED_DATE = current_timestamp,
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider}
		WHERE
		SUB_BUDGET_ID = #{subBudgetId} and UNALLOCATED_ID = #{id}
	</update>
	
	<update id="deleteUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
		DELETE FROM UNALLOCATED 
		WHERE UNALLOCATED_ID = #{id}
	</update>
	
	
	<select id="fetchUnallocatedFundsCount" resultType="Integer"
		parameterType="java.lang.String">
		select count(1) from UNALLOCATED where sub_budget_id =
		#{asSubBudgetId} 
	</select>
   <!--  End QC 8394 R 7.9.0 Financials Enhancement Request: Enable providers to add budget lines with custom text to the budget Unallocated Tab   -->
	 
  <!-- 
  Start QC 9202 Indirect Rate Percentage calculation R 7.10.0 
  Indiract Rate New formula would go in prod in July 2019. 
  Untill now 2019 became 2119 and 2020 became 2120
  revert changes back in July  
   Code was reverted back on 6/7/19.
  -->
	<update id="updateIndirectRatePercentage" parameterType="com.nyc.hhs.model.CBIndirectRateBean">
		update 	indirect_rate 
		set 
			MODIFIED_DATE = SYSTIMESTAMP, 
			MODIFIED_BY_USERID = #{modifyByAgency},
			MODIFIED_BY_STAFFID = #{modifyByProvider},
			indirect_rate =
				nvl(indirect_amount/(SELECT SUM(case
				when amount = 0 then null else amount end)
				FROM(SELECT amount
					FROM
					milestone
					where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and
						active_flag = 1
				UNION ALL
					SELECT amount
					FROM rate
					where sub_budget_id =
					#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
				<!--QC 9202 R 7.10.0 include contracted_service type 2 if amount <= 25K: condition  applyed only for fiscal year > 2019 -->	
				UNION ALL
					SELECT	amount
 					FROM contracted_service
						where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} 
				  		and active_flag = 1
		          		and (
		          		(2020 > #{fiscalYearID})
		          		or 
		          		(#{fiscalYearID} > 2019 and contracted_service_type_id = 2 and amount &lt;= 25000)
		          		or
		          		 (#{fiscalYearID} > 2019 and contracted_service_type_id != 2)
		          		)
				UNION ALL
					SELECT	amount
					FROM utilities
					where sub_budget_id =
						#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
				<!--QC 9202 R 7.10.0 include rent only for fiscal year < 2020 -->
				UNION ALL
					SELECT	amount
					FROM rent
					where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
						and active_flag = 1
				        and 2020 > #{fiscalYearID} 
				UNION ALL
					SELECT amount
					FROM unallocated
					where
					sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
				UNION ALL
					SELECT amount
					FROM professional_service
					where sub_budget_id =
					#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
				<!--QC 9202 R 7.10.0 exclude operations_support_type_id = 15, 18, 17 : condition  applyed only for fiscal year > 2019 -->	
				UNION ALL
					SELECT	amount
					FROM operations_and_support
					where sub_budget_id =
					#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
					and (
					 (2020 > #{fiscalYearID} )
					 or
					 (#{fiscalYearID} > 2019 and operations_support_type_id not in(15, 18, 17))
					 )
				UNION ALL
					SELECT
					sum(TOTAL_SALARY) AS amount
					FROM personnel_service 
					where sub_budget_id	= #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1 
				<!--QC 9202 R 7.10.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount/unit < 5000-->		 
				UNION ALL
					SELECT	amount
					FROM EQUIPMENT
					where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
					and (
		          		(2020 > #{fiscalYearID})
		          		or 
		          		(#{fiscalYearID} > 2019 and units != 0 and CAST(amount/units as decimal(25,2)) &lt;= 5000)
		          		<!--QC 9469 R 8.3.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount < 5000 if unit = 0-->	
						or
						(#{fiscalYearID} > 2019 and (units = 0 or units is null) and CAST(amount as decimal(25,2)) &lt;= 5000)
		          		)
				UNION ALL
					SELECT amount
					FROM FRINGE_BENEFIT
					where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
					and active_flag = 1
		))*100,0)
		where indirect_rate_id = (select INDIRECT_RATE_ID from	indirect_rate
								 where 	sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
										and active_flag = 1)
		</update>

	<update id="updateIndirectRateModificaitonPercentage"	parameterType="com.nyc.hhs.model.CBIndirectRateBean">
		update indirect_rate 
		set 
			MODIFIED_DATE = SYSTIMESTAMP, 
			MODIFIED_BY_USERID = #{modifyByAgency},
			MODIFIED_BY_STAFFID = #{modifyByProvider},
			indirect_rate =	nvl((SELECT sum(indirect_amount)
								FROM indirect_rate
								where sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR}, #{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1)
			/(SELECT (case when SUM(amount) = 0 then null else  SUM(amount) end) as amount
				FROM(SELECT amount
					FROM milestone
					where sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
				UNION ALL
					SELECT amount
					FROM rate
					where sub_budget_id	in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
				<!--QC 9202 R 7.10.0 include contracted_service type 2 if amount <= 25K: condition  applyed only for fiscal year > 2019 -->	
				UNION ALL
					SELECT	amount
 					FROM contracted_service
						where sub_budget_id in	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
				  		and active_flag = 1
		          		and (
		          		(2020 > #{fiscalYearID} )
		          		or 
		          		(#{fiscalYearID} > 2019 and contracted_service_type_id = 2 and amount &lt;= 25000)
		          		or
		          		 (#{fiscalYearID} > 2019 and contracted_service_type_id != 2)
		          		)	
				UNION ALL
					SELECT amount
					FROM utilities
					where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
				<!--QC 9202 R 7.10.0 include rent only for fiscal year < 2020 -->
				UNION ALL
					SELECT amount
					FROM rent
					where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
						  and active_flag = 1
						  and 2020 > #{fiscalYearID} 
				UNION ALL
					SELECT amount
					FROM unallocated
					where sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
				UNION ALL
					SELECT amount
					FROM professional_service
					where sub_budget_id in	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
		    	<!--QC 9202 R 7.10.0 exclude operations_support_type_id = 15, 18, 17 : condition  applyed only for fiscal year > 2019 -->				
				UNION ALL
					SELECT	amount
					FROM operations_and_support
					where sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
					and (
					 (2020 > #{fiscalYearID})
					 or
					 (#{fiscalYearID} > 2019 and operations_support_type_id not in(15, 18, 17))
					 )	
				UNION ALL
					SELECT sum(TOTAL_SALARY) AS amount
					FROM personnel_service
					where sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
				<!--QC 9202 R 7.10.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount/unit < 5000-->		 
				UNION ALL
					SELECT amount
					FROM EQUIPMENT
					where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
					and (
		          		(2020 > #{fiscalYearID})
		          		or 
		          		(#{fiscalYearID} > 2019 and units != 0 and CAST(amount/units as decimal(25,2)) &lt;= 5000)
		          		<!--QC 9469 R 8.3.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount < 5000 if unit = 0-->	
		          		or
		          		(#{fiscalYearID} > 2019 and (units = 0 or units is null) and CAST(amount as decimal(25,2)) &lt;= 5000)		          		
					    )
				UNION ALL
					SELECT amount
					FROM FRINGE_BENEFIT
					where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
					and active_flag = 1
		))*100,0)
		where indirect_rate_id in (select INDIRECT_RATE_ID from	indirect_rate
								   where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
									and active_flag = 1)
	</update>
  
   	<update id="updatePIIndirectRateModificaitonPercentage" 		parameterType="com.nyc.hhs.model.CBIndirectRateBean">
	UPDATE indirect_rate
	SET MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifyByAgency},
		MODIFIED_BY_STAFFID = #{modifyByProvider},
		pi_indirect_rate =
		(select case when directPI=0 or directPI is null then 0.00 else round((indirectPI/directPI)*100,2) end AS PERCENTAGE from (
			SELECT INDIRECT_AMOUNT, INDIRECT_PI, TOTAL_PI, SUB_BUDGET_AMOUNT,
    		(INDIRECT_AMOUNT+INDIRECT_PI) as indirectPI,
    		((TOTAL_PI+SUB_BUDGET_AMOUNT+INDIRECT_AMOUNT)-(INDIRECT_AMOUNT+INDIRECT_PI)) as directPI
			FROM (SELECT
					(SELECT NVL(SUM(NVL(amount,0)),0) AS amount
						FROM program_income
						WHERE sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
						AND entry_type_id = 10
						AND active_flag=1
					) AS INDIRECT_PI,
					(SELECT NVL(SUM(NVL(indirect_amount,0)),0) AS amount
						FROM indirect_rate
						WHERE sub_budget_id in 	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
						AND active_flag = 1
					) AS INDIRECT_AMOUNT,
					(SELECT NVL(SUM(NVL(amount,0)),0) AS amount
						FROM program_income
						WHERE sub_budget_id in	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
						AND active_flag=1
					) AS TOTAL_PI,
					(
					SELECT nvl((case when SUM(amount) = 0 then null else  SUM(amount) end),0) as amount
					FROM(SELECT amount
							FROM milestone
								where sub_budget_id in	(#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
						UNION ALL
							SELECT amount
							FROM rate
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
							and active_flag = 1
						UNION ALL
							SELECT amount
							FROM contracted_service
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
							and active_flag = 1
							<!--QC 9202 R 7.10.0 include contracted_service type 2 if amount <= 25K: condition  applyed only for fiscal year > 2019 -->	
							and (
		          				(2020 > #{fiscalYearID} )
		          				or 
		          				(#{fiscalYearID} > 2019 and contracted_service_type_id = 2 and amount &lt;= 25000)
		          				or
		          		 		(#{fiscalYearID} > 2019 and contracted_service_type_id != 2)
		          				)	
						UNION ALL
							SELECT amount
							FROM utilities
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
						<!--QC 9202 R 7.10.0 include rent only for fiscal year < 2020 -->
						UNION ALL
							SELECT amount
							FROM rent
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
								and 2020 > #{fiscalYearID}
						UNION ALL
							SELECT amount
							FROM unallocated
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
						UNION ALL
							SELECT amount
							FROM professional_service
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
						<!--QC 9202 R 7.10.0 exclude operations_support_type_id = 15, 18, 17 : condition  applyed only for fiscal year > 2019 -->		
						UNION ALL
							SELECT amount
							FROM operations_and_support
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
								and active_flag = 1
								and (
					 				(2020 > #{fiscalYearID})
					 				or
					 				(#{fiscalYearID} > 2019 and operations_support_type_id not in(15, 18, 17))
					 				)
						UNION ALL
							SELECT sum(TOTAL_SALARY) AS amount
							FROM personnel_service
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
							and active_flag = 1
						<!--QC 9202 R 7.10.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount/unit < 5000-->		 
						UNION ALL
							SELECT amount
							FROM EQUIPMENT
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
							and active_flag = 1
							and (
		          				(2020 > #{fiscalYearID})
		          				or 
		          				(#{fiscalYearID} > 2019 and units != 0 and CAST(amount/units as decimal(25,2)) &lt;= 5000)
		          				<!--QC 9469 R 8.3.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount < 5000 if unit = 0-->	
								or
								(#{fiscalYearID} > 2019 and (units = 0 or units is null) and CAST(amount as decimal(25,2)) &lt;= 5000)
		          				)
						UNION ALL
							SELECT amount
							FROM FRINGE_BENEFIT
							where sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
							and active_flag = 1
					)
				) AS SUB_BUDGET_AMOUNT
			FROM DUAL) A) B)
			WHERE indirect_rate_id in 
			(SELECT INDIRECT_RATE_ID
				FROM indirect_rate
				WHERE sub_budget_id in (#{subBudgetID,jdbcType=VARCHAR},#{parentSubBudgetId,jdbcType=VARCHAR})
				AND active_flag = 1
	)
	</update>
				
	<update id="updatePIIndirectRatePercentage" parameterType="com.nyc.hhs.model.CBIndirectRateBean">
	UPDATE indirect_rate
	SET MODIFIED_DATE = SYSTIMESTAMP,
	MODIFIED_BY_USERID = #{modifyByAgency},
	MODIFIED_BY_STAFFID = #{modifyByProvider},
	pi_indirect_rate =
	(select case when directPI=0 or directPI is null then 0.00 else round((indirectPI/directPI)*100,2) end as PERCENTAGE from (
	SELECT INDIRECT_AMOUNT,INDIRECT_PI,TOTAL_PI,SUB_BUDGET_AMOUNT,
    (INDIRECT_AMOUNT+INDIRECT_PI) as indirectPI,
    ((TOTAL_PI+SUB_BUDGET_AMOUNT+INDIRECT_AMOUNT)-(INDIRECT_AMOUNT+INDIRECT_PI)) as directPI
	FROM
	(SELECT
	(SELECT nvl(sum(NVL(amount,0)),0) AS amount
	FROM program_income
	WHERE SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
	AND entry_type_id = 10
	) AS INDIRECT_PI,
	(SELECT NVL(SUM(NVL(indirect_amount,0)),0) AS amount
	FROM indirect_rate
	WHERE sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
	AND active_flag = 1
	) AS INDIRECT_AMOUNT,
	(SELECT NVL(SUM(NVL(amount,0)),0) AS amount
	FROM program_income
	WHERE SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
	) AS TOTAL_PI,
	(SELECT nvl(SUM(case
		when amount = 0 then null else amount end),0)
		FROM(SELECT amount
		FROM
		milestone
		where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and
		active_flag = 1
		UNION ALL
		SELECT amount
		FROM rate
		where sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
		<!--QC 9202 R 7.10.0 include contracted_service type 2 if amount <= 25K: condition  applyed only for fiscal year > 2019 -->	
		UNION ALL
			SELECT	amount
			FROM contracted_service
			where sub_budget_id =	#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
			and (
		        (2020 > #{fiscalYearID} )
		        or 
		        (#{fiscalYearID} > 2019 and contracted_service_type_id = 2 and amount &lt;= 25000)
		        or
		         (#{fiscalYearID} > 2019 and contracted_service_type_id != 2)
		       	)	
		UNION ALL
		SELECT
		amount
		FROM utilities
		where sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
		<!--QC 9202 R 7.10.0 include rent only for fiscal year < 2020 -->
		UNION ALL
			SELECT 	amount
			FROM rent
			where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
			and active_flag = 1
        	and 2020 > #{fiscalYearID}
		UNION ALL
		SELECT amount
		FROM unallocated
		where
		sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
		UNION ALL
		SELECT amount
		FROM professional_service
		where sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
		<!--QC 9202 R 7.10.0 exclude operations_support_type_id = 15, 18, 17 : condition  applyed only for fiscal year > 2019 -->
		UNION ALL
			SELECT 	amount
			FROM operations_and_support
			where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
			and active_flag = 1
			and (
			 (2020 > #{fiscalYearID})
			 or
			 (#{fiscalYearID} > 2019 and operations_support_type_id not in(15, 18, 17))
			)
		UNION ALL
		SELECT
		sum(TOTAL_SALARY) AS amount
		FROM personnel_service where sub_budget_id
		= #{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
		<!--QC 9202 R 7.10.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount/unit < 5000-->		 
		UNION ALL
			SELECT	amount
			FROM EQUIPMENT
			where sub_budget_id =
			#{subBudgetID,jdbcType=VARCHAR} and active_flag = 1
			and (
		          		(2020 > #{fiscalYearID})
		          		or 
		          		(#{fiscalYearID} > 2019 and units != 0 and CAST(amount/units as decimal(25,2)) &lt;= 5000)
		          		<!--QC 9469 R 8.3.0 exclude equipment line : condition  applyed only for fiscal year > 2019 and amount < 5000 if unit = 0-->	
						or
						(#{fiscalYearID} > 2019 and (units = 0 or units is null) and CAST(amount as decimal(25,2)) &lt;= 5000)
		         )
		UNION ALL
		SELECT amount
		FROM FRINGE_BENEFIT
		where
		sub_budget_id =
		#{subBudgetID,jdbcType=VARCHAR}
		and active_flag = 1
		)
	) AS SUB_BUDGET_AMOUNT
	FROM DUAL) A) B)
	WHERE indirect_rate_id = 
	(SELECT INDIRECT_RATE_ID
	FROM indirect_rate
	WHERE sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
	AND active_flag = 1
	)
	</update>
	
	
	<select id="getFiscalYearIdFromSubBudget" parameterType="java.lang.String"
		resultType="java.lang.String">
		select FISCAL_YEAR_ID 
		from SUB_BUDGET
		where sub_budget_id = #{subBudgetID,jdbcType=VARCHAR}
		AND active_flag = 1
	</select>
	
	<select id="getFiscalYearIdFromBudget" parameterType="java.lang.String"
		resultType="java.lang.String">
		select FISCAL_YEAR_ID 
		from BUDGET
		where budget_id = #{contractBudgetID,jdbcType=VARCHAR}
		AND active_flag = 1
	</select>
	
    <!-- End QC 9202 Indirect Rate Percentage calculation R 7.10.0 -->
       
    <!-- Start QC 9592 R 8.10.0 Remaining Amount in Sub Budgets Created in Update Config Task are NULL when merged with Base -->
	<update id="updateSubBudgetYtdInvoiceAmoutntBase" parameterType="hashmap">
	  update sub_budget 
	  set remaining_amount = sub_budget_amount,  
			ytd_invoiced_amount= 0,
			modified_date = systimestamp,  
			modified_by_userid = #{modifyBy} 
			where budget_id =(select parent_id from budget where budget_id = #{budgetId})
	</update>
	 <!-- End QC 9592 R 8.10.0 Remaining Amount in Sub Budgets Created in Update Config Task are NULL when merged with Base -->
    
</mapper>
