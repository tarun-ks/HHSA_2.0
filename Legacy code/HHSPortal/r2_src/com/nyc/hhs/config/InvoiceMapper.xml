<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.nyc.hhs.service.db.services.application.InvoiceMapper">
 
      <!-- Changes for enhancement  id 6461  release 3.4.0 -->
      <resultMap id="invoicesList" type="com.nyc.hhs.model.InvoiceList">
            <result property="invoiceNumber" column="INVOICE_NUMBER" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="invoiceDateSubmitted" column="INVOICE_SUBMITTED_DATE" />
            <result property="invoiceDateApproved" column="INVOICE_APPROVED_DATE" />
            <result property="invoiceValue" column="INVOICE_AMOUNT" />
            <result property="invoiceStatus" column="STATUS" />
            <result property="invoiceStatusId" column="STATUS_ID" />
            <result property="orgId" column="ORGANIZATION_ID" />
            <result property="invoiceProvider" column="organization_legal_name" />
            <result property="invoiceContractTitle" column="contract_title" />
            <result property="invoiceCtId" column="ct_number" />
            <result property="invoiceAgencyId" column="AGENCY_ID" />
            <result property="invoiceContractId" column="contract_id" />
            <result property="invoiceBudgetId" column="budget_id" />
            <result property="invoiceFiscalYearId" column="FISCAL_YEAR_ID" />
            <!-- Start : R5 Added -->
            <result property="paymentCount" column="PAYMENT_EXIST_COUNT" />
            <!-- End : R5 Added -->
            <!-- [Start] R9.7.5 QC9719 -->
            <result property="actionDisable" column= "action_disable"/>
            <!-- [End] R9.7.5 QC9719 -->
            <!-- [Start] R9.7.6 QC9730 -->
            <result property="actionException" column= "action_exception"/>
            <!-- [End] R9.7.6 QC9730 -->
      </resultMap>
 
      <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
      <!-- Changes for enhancement  id 6461  release 3.4.0 -->
      <select id="fetchInvoiceListProvider" parameterType="com.nyc.hhs.model.InvoiceList"
            resultMap="invoicesList">
            SELECT
            INVOICE_NUMBER,INVOICE_ID,budget_id,contract_id,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE,INVOICE_AMOUNT,
            STATUS,STATUS_ID,AGENCY_ID,
            <!-- Start : R5 Added -->
            (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = b.CONTRACT_ID AND BUDGET_ID = b.BUDGET_ID AND INVOICE_ID = b.INVOICE_ID AND STATUS_ID IN (64,65,109) AND b.invoice_status_id = 73 AND DELETE_FLAG = 0) AS PAYMENT_EXIST_COUNT,
            <!-- End : R5 Added -->
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,rn
             <!-- [Start] R9.7.5 QC9719 -->
             ,action_disable
             <!-- [End] R9.7.5 QC9719 -->
			<!-- [Start] R9.7.6 QC9730 -->
		        , action_exception 
		    <!-- [End] R9.7.6 QC9730 -->     
            FROM ( SELECT INVOICE_NUMBER,INVOICE_ID,budget_id,contract_id,invoice_status_id,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE,INVOICE_AMOUNT,
            STATUS,STATUS_ID,AGENCY_ID, organization_legal_name,contract_title,ct_number,FISCAL_YEAR,
            FISCAL_YEAR_ID,ORGANIZATION_ID, ROWNUM as rn 
            <!-- [Start] R9.7.5 QC9719 -->
	        ,(select count(1) from ACTION_DISABLE_TASK_OBJ aet 
	               where  aet.CONTRACT_ID = A.CONTRACT_ID and  aet.BUDGET_ID = A.BUDGET_ID and aet.AGENCY_ID = A.AGENCY_ID
	                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
	                                                             from  ACTION_DISABLE_TASK_OBJ eae 
	                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
	                                                              AND  eae.BUDGET_ID =  aet.BUDGET_ID
	                                                              AND  eae.AGENCY_ID =  aet.AGENCY_ID  ) 
	         ) action_disable
            <!-- [End] R9.7.5 QC9719 -->     
			<!-- [Start] R9.7.6 QC9730 -->
		    , (select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
	               where  aet.CONTRACT_ID = A.CONTRACT_ID and aet.AGENCY_ID = A.AGENCY_ID
	                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
	                                                             from  ACTION_EXCEPTIONAL_OBJ eae 
	                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
	                                                              AND  eae.AGENCY_ID =  aet.AGENCY_ID  ) 
	         ) action_exception 
		    <!-- [End] R9.7.6 QC9730 -->
            FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,inv.AGENCY_ID,inv.budget_id,inv.contract_id,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE,
            TO_DATE (TO_CHAR (inv.INVOICE_APPROVED_DATE,'DD-MON-YYYY'), 'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
           inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,
            sta.STATUS,
            (CASE
            WHEN
            inv.STATUS_ID = 70
            THEN
            120
 
            WHEN
            inv.STATUS_ID = 75
            THEN
            124
 
            WHEN
            inv.STATUS_ID = 74
            THEN
            123
 
            WHEN
            inv.STATUS_ID = 73
            THEN
            122
 
            WHEN
            inv.STATUS_ID = 72
            THEN
            121
 
            WHEN
            inv.STATUS_ID = 71
            THEN
            119
            End)
            as STATUS_ID, inv.status_id invoice_status_id, inv.ORGANIZATION_ID,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and
            inv.organization_id = #{orgId}
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%'))
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="agency !=null and agency!=''">
                  AND inv.agency_id = #{agency}
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ORDER BY
            ${firstSort} ${firstSortType}
            <if test="secondSort != null and secondSort !=''">
                  , ${secondSort} ${secondSortType}
            </if>
            )A)B
            WHERE rn &gt;=#{startNode} AND ROWNUM
            &lt;=#{endNode}-#{startNode}+1
      </select>
 
      <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
      <!-- Changes for enhancement  id 6461  release 3.4.0 -->
      <select id="fetchInvoiceListAgency" parameterType="com.nyc.hhs.model.InvoiceList"   resultMap="invoicesList">
         SELECT  INVOICE_NUMBER,INVOICE_ID,budget_id,contract_id, INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,
            STATUS,STATUS_ID,AGENCY_ID,
            <!-- Start : R5 Added -->
            (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = b.CONTRACT_ID AND BUDGET_ID = b.BUDGET_ID AND INVOICE_ID = b.INVOICE_ID AND STATUS_ID IN (109,63,64,65,66) AND b.invoice_status_id = 73 AND DELETE_FLAG = 0) AS PAYMENT_EXIST_COUNT,
            <!-- End : R5 Added -->
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,rn
            <!-- [Start] R9.7.5 QC9719 -->
            , action_disable
            <!-- [End] R9.7.5 QC9719 -->    
			<!-- [Start] R9.7.6 QC9730 -->
		    , action_exception 
		    <!-- [End] R9.7.6 QC9730 -->        
         FROM ( SELECT INVOICE_NUMBER,INVOICE_ID,invoice_status_id, 
			            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,budget_id,contract_id,
			            STATUS,STATUS_ID,AGENCY_ID,  organization_legal_name,contract_title,ct_number,
			            FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID, ROWNUM as rn 
                        <!-- [Start] R9.7.5 QC9719 -->
				        , ( select   count(1) from ACTION_DISABLE_TASK_OBJ aet 
			               where  aet.CONTRACT_ID = A.CONTRACT_ID and  aet.BUDGET_ID = A.BUDGET_ID and aet.AGENCY_ID = A.AGENCY_ID
			                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select   nvl( max(eae.VERSION_NO), 0 ) 
			                                                                 from   ACTION_DISABLE_TASK_OBJ eae 
			                                                                where   eae.CONTRACT_ID = aet.CONTRACT_ID 
			                                                                  AND   eae.BUDGET_ID =  aet.BUDGET_ID
			                                                                  AND   eae.AGENCY_ID =  aet.AGENCY_ID  ) 
				        ) action_disable 
                        <!-- [End] R9.7.5 QC9719 -->  
			            <!-- [Start] R9.7.6 QC9730 -->
				        , ( select   count(1) from ACTION_EXCEPTIONAL_OBJ aet 
			               where  aet.CONTRACT_ID = A.CONTRACT_ID  and aet.AGENCY_ID = A.AGENCY_ID
			                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select   nvl( max(eae.VERSION_NO), 0 ) 
			                                                                 from   ACTION_EXCEPTIONAL_OBJ eae 
			                                                                where   eae.CONTRACT_ID = aet.CONTRACT_ID 
			                                                                  AND   eae.AGENCY_ID =  aet.AGENCY_ID  ) 
				        ) action_exception 
					    <!-- [End] R9.7.6 QC9730 -->        
            FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE, TO_DATE (TO_CHAR
            (inv.INVOICE_APPROVED_DATE,
            'DD-MON-YYYY'),
            'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
             inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,inv.AGENCY_ID,inv.status_id invoice_status_id,
            sta.STATUS,sta.STATUS_ID,inv.ORGANIZATION_ID,inv.budget_id,inv.contract_id,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and
            inv.agency_id = #{agency}
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%') )
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="invoiceProvider !=null and invoiceProvider!=''">
                  AND
                  lower(org.ORGANIZATION_ID) =  lower('${providerId}')
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ORDER BY
            ${firstSort} ${firstSortType}
            <if test="secondSort != null and secondSort !=''">
                  , ${secondSort} ${secondSortType}
            </if>
            )A)B
            WHERE rn &gt;=#{startNode} AND ROWNUM
            &lt;=#{endNode}-#{startNode}+1
      </select>
      <!-- Made changes in this query for defect id 6248 release 3.3.0  -->
      <!-- Changes for enhancement  id 6461  release 3.4.0 -->
      <select id="fetchInvoiceListAccelerator" parameterType="com.nyc.hhs.model.InvoiceList"
            resultMap="invoicesList">
            SELECT
            INVOICE_NUMBER,INVOICE_ID,budget_id,contract_id,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,
            STATUS,STATUS_ID,AGENCY_ID,
            <!-- Start : R5 Added -->
            (SELECT COUNT(1) FROM PAYMENT WHERE CONTRACT_ID = b.CONTRACT_ID AND BUDGET_ID = b.BUDGET_ID AND INVOICE_ID = b.INVOICE_ID AND STATUS_ID IN (109,63,64,65,66) AND b.invoice_status_id = 73 AND DELETE_FLAG = 0) AS PAYMENT_EXIST_COUNT,
            <!-- End : R5 Added -->
            organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID, rn
            <!-- [Start] R9.7.5 QC9719 -->
             , action_disable
            <!-- [End] R9.7.5 QC9719 -->      
			<!-- [Start] R9.7.6 QC9730 -->
		     , action_exception 
		    <!-- [End] R9.7.6 QC9730 -->    
            FROM(SELECT INVOICE_NUMBER,INVOICE_ID,invoice_status_id,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,budget_id,contract_id,
            STATUS,STATUS_ID,AGENCY_ID,
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,
            ROWNUM as rn
            <!-- [Start] R9.7.5 QC9719 -->
	        ,(select count(1) from ACTION_DISABLE_TASK_OBJ aet 
	               where  aet.CONTRACT_ID = A.CONTRACT_ID and  aet.BUDGET_ID = A.BUDGET_ID and aet.AGENCY_ID = A.AGENCY_ID
	                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
	                                                             from  ACTION_DISABLE_TASK_OBJ eae 
	                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
	                                                              AND  eae.BUDGET_ID =  aet.BUDGET_ID
	                                                              AND  eae.AGENCY_ID =  aet.AGENCY_ID  ) 
	         ) action_disable					         
            <!-- [End] R9.7.5 QC9719 -->
			<!-- [Start] R9.7.6 QC9730 -->
		     ,(select count(1) from ACTION_EXCEPTIONAL_OBJ aet 
	               where  aet.CONTRACT_ID = A.CONTRACT_ID  and aet.AGENCY_ID = A.AGENCY_ID
	                 and aet.IS_ACTIVE = 1 and aet.VERSION_NO in ( select  nvl( max(eae.VERSION_NO), 0 ) 
	                                                             from  ACTION_EXCEPTIONAL_OBJ eae 
	                                                            where  eae.CONTRACT_ID = aet.CONTRACT_ID 
	                                                              AND  eae.AGENCY_ID =  aet.AGENCY_ID  ) 
	          ) action_exception 
		    <!-- [End] R9.7.6 QC9730 -->    

            FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,inv.AGENCY_ID,inv.status_id invoice_status_id,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE,TO_DATE (TO_CHAR
            (inv.INVOICE_APPROVED_DATE,
            'DD-MON-YYYY'),
            'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
             inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,
            sta.STATUS,sta.STATUS_ID,inv.ORGANIZATION_ID,inv.budget_id,inv.contract_id,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%'))
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="agency !=null and agency!=''">
                  AND inv.agency_id = #{agency}
            </if>
            <if test="invoiceProvider !=null and invoiceProvider!=''">
                  AND
                  lower(org.ORGANIZATION_ID) = lower('${providerId}')
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ORDER BY
            ${firstSort} ${firstSortType}
            <if test="secondSort != null and secondSort !=''">
                  , ${secondSort} ${secondSortType}
            </if>
            )A)B
            WHERE rn &gt;=#{startNode} AND ROWNUM
            &lt;=#{endNode}-#{startNode}+1
      </select>
 
      <select id="fetchInvoiceCountProvider" parameterType="com.nyc.hhs.model.InvoiceList"
            resultType="int">
            SELECT count(1) FROM(SELECT INVOICE_NUMBER,INVOICE_ID,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE,INVOICE_AMOUNT,
            STATUS,STATUS_ID,
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,
            ROWNUM as rn FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE,
            TO_DATE (TO_CHAR (inv.INVOICE_APPROVED_DATE,'DD-MON-YYYY'), 'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
             inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,
            sta.STATUS,
            (CASE
            WHEN
            inv.STATUS_ID = 70
            THEN
            120
 
            WHEN
            inv.STATUS_ID = 75
            THEN
            124
 
            WHEN
            inv.STATUS_ID = 74
            THEN
            123
 
            WHEN
            inv.STATUS_ID = 73
            THEN
            122
 
            WHEN
            inv.STATUS_ID = 72
            THEN
            121
 
            WHEN
            inv.STATUS_ID = 71
            THEN
            119
            End)
            as STATUS_ID
            ,inv.ORGANIZATION_ID,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and
            inv.organization_id = #{orgId}
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%'))
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="agency !=null and agency!=''">
                  AND inv.agency_id = #{agency}
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ))
      </select>
      <select id="fetchInvoiceCountAgency" parameterType="com.nyc.hhs.model.InvoiceList"
            resultType="int">
            SELECT count(1) FROM(SELECT INVOICE_NUMBER,INVOICE_ID,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,
            STATUS,STATUS_ID,
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,
            ROWNUM as rn FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE, TO_DATE (TO_CHAR
            (inv.INVOICE_APPROVED_DATE,
            'DD-MON-YYYY'),
            'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
             inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,
            sta.STATUS,sta.STATUS_ID,inv.ORGANIZATION_ID,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and
            inv.agency_id = #{agency}
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%'))
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="invoiceProvider !=null and invoiceProvider!=''">
                  AND
                  lower(org.ORGANIZATION_ID)  = lower('${providerId}')
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL  &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ))
      </select>
 
      <select id="fetchInvoiceCountAccelerator" parameterType="com.nyc.hhs.model.InvoiceList"
            resultType="int">
            SELECT count(1) FROM(SELECT INVOICE_NUMBER,INVOICE_ID,
            INVOICE_SUBMITTED_DATE,INVOICE_APPROVED_DATE, INVOICE_AMOUNT,
            STATUS,STATUS_ID,
      organization_legal_name,contract_title,ct_number,FISCAL_YEAR,FISCAL_YEAR_ID,ORGANIZATION_ID,
            ROWNUM as rn FROM(
            SELECT inv.INVOICE_NUMBER,inv.INVOICE_ID,
            TO_DATE
            (TO_CHAR (inv.INVOICE_SUBMITTED_DATE, 'DD-MON-YYYY'),
            'DD-MON-YYYY') AS
            INVOICE_SUBMITTED_DATE,TO_DATE (TO_CHAR
            (inv.INVOICE_APPROVED_DATE,
            'DD-MON-YYYY'),
            'DD-MON-YYYY') AS INVOICE_APPROVED_DATE,
             inv.INVOICE_AMOUNT_TOTAL as
            INVOICE_AMOUNT,
            sta.STATUS,sta.STATUS_ID,inv.ORGANIZATION_ID,
            org.organization_legal_name,con.contract_title,con.EXT_CT_NUMBER as ct_number,fis.FISCAL_YEAR,fis.FISCAL_YEAR_ID
            FROM INVOICE inv, contract con,STATUS_MASTER_R2_R3 sta,
            organization
            org,fiscal_year fis
            WHERE
            inv.contract_id = con.contract_id and
            inv.status_id = sta.status_id and
            inv.FISCAL_YEAR_ID =
            fis.FISCAL_YEAR_ID and
            inv.organization_id = org.organization_id
            and inv.DELETE_FLAG = 0
            <if test="invoiceContractTitle != null and invoiceContractTitle !=''">
                  AND (lower(con.CONTRACT_TITLE) LIKE
                  lower('%${invoiceContractTitle}%'))
            </if>
            <if test="invoiceProgramName !=null and invoiceProgramName !=''">
                  AND inv.PROGRAM_ID = #{invoiceProgramName}
            </if>
            <if test="agency !=null and agency!=''">
                  AND inv.agency_id = #{agency}
            </if>
            <if test="invoiceProvider !=null and invoiceProvider!=''">
                  AND
                  lower(org.ORGANIZATION_ID) = lower('${providerId}')
            </if>
            <if test="invoiceCtId != null and invoiceCtId !=''">
                  AND lower(con.EXT_CT_NUMBER) = lower(#{invoiceCtId})
            </if>
            <if test="invoiceFiscalYearId != null and  invoiceFiscalYearId !=''">
                  AND inv.FISCAL_YEAR_ID = #{invoiceFiscalYearId}
            </if>
            <if test="invoiceNumber != null and invoiceNumber !=''">
                  AND inv.invoice_number = #{invoiceNumber}
            </if>
            <if test="invoiceValueFrom != null and  invoiceValueFrom !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &gt; =
                  #{invoiceValueFrom}
            </if>
            <if test="invoiceValueTo != null and invoiceValueTo !=''">
                  AND  inv.INVOICE_AMOUNT_TOTAL &lt; =
                  #{invoiceValueTo}
            </if>
            <!-- Start : R5 Added Removed string comparision on the list-->
            <if test="invoiceStatusList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
                  AND sta.STATUS_ID IN
                  <foreach item="items" index="index" collection="invoiceStatusList"
                        open="(" separator="," close=")">
                        #{items}
            </foreach>
            </if>
            <if test=" dateSubmittedFrom != null and  dateSubmittedFrom !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &gt; =
                  to_date(#{dateSubmittedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateSubmittedTo != null and  dateSubmittedTo !=''">
                  AND inv.INVOICE_SUBMITTED_DATE &lt; =
                  to_date(#{dateSubmittedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test=" dateApprovedFrom != null and  dateApprovedFrom !=''">
                  AND inv.INVOICE_APPROVED_DATE &gt; =
                  to_date(#{dateApprovedFrom,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <if test="dateApprovedTo != null and  dateApprovedTo !=''">
                  AND inv.INVOICE_APPROVED_DATE &lt; =
                  to_date(#{dateApprovedTo,
                  jdbcType=DATE},'MM/dd/YYYY')
            </if>
            <!-- Start : R5 Added -->
            <if test="invoiceContractId != null and invoiceContractId !=''">
                  AND inv.CONTRACT_ID = #{invoiceContractId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceBudgetId != null and invoiceBudgetId !=''">
                  AND inv.BUDGET_ID = #{invoiceBudgetId,jdbcType=VARCHAR}
            </if>
            <if test="invoiceId != null and invoiceId !=''">
                  AND inv.INVOICE_ID = #{invoiceId,jdbcType=VARCHAR}
            </if>
            <!-- End : R5 Added -->
            ))
      </select>
 
 
      <update id="updateInvoiceWithdrawn" parameterType="java.util.HashMap">
            UPDATE INVOICE
            SET
            STATUS_ID =#{statusId} WHERE INVOICE_ID=#{invoiceNumber}
      </update>
 
      <update id="updateWithdrawInvoiceWorkFlowId" parameterType="java.util.HashMap">
            UPDATE INVOICE
            SET PROC_STATUS_ID =#{procStatusId}
            WHERE
            INVOICE_NUMBER=#{invoiceNumber}
      </update>
 
 
      <!-- Made changes for defect id 6445 release 3.3.0  -->
      <delete id="deleteInvoiceDocument" parameterType="java.lang.String">
            DELETE FROM
            invoice_document
            WHERE INVOICE_ID= #{invoiceId}
    </delete>
 
      <!-- Made changes for defect id 6445 release 3.3.0  -->
      <select id="fetchInvoiceDocumentIds" parameterType="string" resultType="hashmap">
      select document_type, document_identifier_id from invoice_document     
      where INVOICE_ID= #{invoiceId}
      </select>
 
      <delete id="deleteInvoiceDetails" parameterType="java.lang.String">
 
            DELETE FROM
            INVOICE_DETAILS
            WHERE INVOICE_ID= #{invoiceId}
   
          </delete>
      <delete id="deleteInvoice" parameterType="java.lang.String">
 
            DELETE FROM INVOICE
            WHERE INVOICE_ID= #{invoiceId}
            </delete>
 
      <select id="fetchInvoiceFilter" parameterType="com.nyc.hhs.model.InvoiceList"
            resultMap="invoicesList">
 
      </select>
      <select id="selectWithdrawInvoiceWorkFlowDetails" parameterType="java.lang.String"
            resultType="String">
            SELECT CONTRACT_ID FROM INVOICE WHERE
            INVOICE_NUMBER=#{asInvoiceNumber}
      </select>
 
 
 
      <!-- INVOICE OPERATION SUPPORT QUERIES - STARTS HERE -->
      <resultMap id="operationSupportList" type="com.nyc.hhs.model.CBOperationSupportBean">
            <result property="id" column="OPERATIONS_SUPPORT_ID" />
            <result property="opAndSupportName" column="OP_SUPPRT_NAME" />
            <result property="fyBudget" column="FY_BUDGET" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
 
      </resultMap>
 
      <select id="fetchInvoiceOperationSupport" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="operationSupportList">
             <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID=2
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT
            OAS.OPERATIONS_SUPPORT_ID AS OPERATIONS_SUPPORT_ID,
            CASE
            WHEN
            other.ENTITY_NAME IS NOT NULL
            THEN other.ENTITY_NAME
            ELSE
            OSTM.OPERATIONS_SUPPORT_TYPE
            END AS OP_SUPPRT_NAME,
            NVL(OAS.AMOUNT,0) AS
            FY_BUDGET,
            SUM(CASE
            WHEN INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INVD.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT
            FROM
            OPERATIONS_SUPPORT_TYPE_MASTER OSTM
            LEFT JOIN
            OPERATIONS_AND_SUPPORT OAS
            ON
            OSTM.OPERATIONS_SUPPORT_TYPE_ID = OAS.OPERATIONS_SUPPORT_TYPE_ID
            AND
            OAS.SUB_BUDGET_ID = #{subBudgetID}
            AND
            OAS.BUDGET_ID =
            #{contractBudgetID}
            LEFT JOIN
            INVOICE_DETAILS INVD
            ON
            OAS.OPERATIONS_SUPPORT_ID =
            INVD.LINE_ITEM_ID
            AND
            INVD.ENTRY_TYPE_ID = 2
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
 			AND INVD.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            AND
            OAS.SUB_BUDGET_ID =
            #{subBudgetID}
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            invd.invoice_id
            AND
            invvv.status_id IN ('72', '73')
            LEFT JOIN
            OTHER_DETAILS OTHER
            ON
            OTHER.ENTITY_ID =
            OAS.OPERATIONS_SUPPORT_ID
            AND
            OTHER.ENTRY_TYPE_ID = 2
            AND
            OTHER.ACTIVE_FLAG = '1'
            WHERE
            OSTM.ACTIVE_FLAG = 1
            GROUP BY
            OSTM.OPERATIONS_SUPPORT_TYPE_ID,
            OAS.OPERATIONS_SUPPORT_ID,
            (CASE
            WHEN
            other.ENTITY_NAME IS NOT NULL
            THEN
            other.ENTITY_NAME
            ELSE
            OSTM.OPERATIONS_SUPPORT_TYPE
            END),
            OAS.AMOUNT
            ORDER BY
            OSTM.OPERATIONS_SUPPORT_TYPE_ID
            <!-- SELECT OS.OPERATIONS_SUPPORT_ID, OSM.OPERATIONS_SUPPORT_TYPE_ID, OSM.OPERATIONS_SUPPORT_TYPE
                  , OS.AMOUNT AS BUDGET from OPERATIONS_SUPPORT_TYPE_MASTER OSM Full OUTER
                  JOIN OPERATIONS_AND_SUPPORT OS ON OSM.OPERATIONS_SUPPORT_TYPE_ID = OS.OPERATIONS_SUPPORT_TYPE_ID
                  where OS.ACTIVE_FLAG='1' AND OS.SUB_BUDGET_ID = #{subBudgetID} ORDER BY OSM.OPERATIONS_SUPPORT_TYPE_ID -->
 
      </select>
 
      <resultMap id="operationSupportInvoice" type="com.nyc.hhs.model.CBOperationSupportBean">
            <result property="id" column="LINE_ITEM_ID" /> <!-- LINE_ITEM_ID is same as OPERATIONS_SUPPORT_ID -->
            <result property="invoiceDetailId" column="invoice_detail_id" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="fyBudget" column="BUDGET" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="invoicedAmt" column="INVOICE_AMOUNT" />
 
      </resultMap>
 
      <select id="fetchInvoiceOperationSupportDetails" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="operationSupportInvoice">
            <!-- Fetched Invoiced Amount for Each Op Support in an Invoice -->
            select INV.INVOICE_ID, IDT.invoice_detail_id,IDT.LINE_ITEM_ID,
            NVL(IDT.invoice_amount, 0) AS INVOICE_AMOUNT from INVOICE_DETAILS IDT,
            INVOICE INV
            where INV.INVOICE_ID = IDT.INVOICE_ID AND
            IDT.ENTRY_TYPE_ID='2' AND
            IDT.INVOICE_ID=#{invoiceId}
      </select>
 
 
 
      <select id="fetchBudgetAllocatedForAnOpSupport" parameterType="java.lang.String"
            resultType="java.lang.String">
            select NVL(AMOUNT,0) from OPERATIONS_AND_SUPPORT where
            OPERATIONS_SUPPORT_ID= #{aoOpSupportId}
      </select>
 
      <!-- Made changes for enhancement id 6535 release 3.8.0-->
      <select id="fetchInvAmountForAnOpSupportLineItem" parameterType="com.nyc.hhs.model.CBOperationSupportBean"
            resultType="java.lang.String">
            <!-- Fetch Invoiced Amount for a Single Op-Support -->
            SELECT
            nvl((SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            IDT.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            IDT.invoice_amount &lt; 0
            </if>
            THEN IDT.INVOICE_AMOUNT
            ELSE 0
            END )),0) as INVOICE_AMOUNT
           
            FROM INVOICE INV INNER JOIN
            INVOICE_DETAILS IDT
            ON INV.INVOICE_ID = IDT.INVOICE_ID
            INNER JOIN
            ENTRY_TYPE_MASTER EM ON EM.ENTRY_TYPE_ID = IDT.ENTRY_TYPE_ID
            INNER JOIN
            OPERATIONS_AND_SUPPORT OS ON IDT.LINE_ITEM_ID =
            OS.OPERATIONS_SUPPORT_ID
            INNER JOIN OPERATIONS_SUPPORT_TYPE_MASTER OSM
            ON
            OSM.OPERATIONS_SUPPORT_TYPE_ID =
            OS.OPERATIONS_SUPPORT_TYPE_ID
            WHERE
            IDT.ENTRY_TYPE_ID = '2' AND OS.SUB_BUDGET_ID =#{subBudgetID} AND
            OS.OPERATIONS_SUPPORT_ID=#{id}
            AND INV.STATUS_ID IN
            ('70','71','72','73') <if test="invoiceDetailId != ''">AND IDT.INVOICE_DETAIL_ID NOT IN
            (#{invoiceDetailId}) </if>
      </select>
 
 
 
      <update id="editInvoiceOperationSupportDetails" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
            UPDATE INVOICE_DETAILS
            SET INVOICE_AMOUNT = #{invoicedAmt},
            modified_date=CURRENT_TIMESTAMP, MODIFIED_BY_STAFFID =
            #{modifyByProvider}
            WHERE
            INVOICE_DETAIL_ID = #{invoiceDetailId}
      </update>
 
      <insert id="insertInvoiceOperationSupportDetails" parameterType="com.nyc.hhs.model.CBOperationSupportBean">
 
            Insert into INVOICE_DETAILS
            (INVOICE_DETAIL_ID,
            INVOICE_ID,
            SUB_BUDGET_ID,
            ENTRY_TYPE_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            CREATED_DATE,
            CREATED_BY_USERID,
            MODIFIED_DATE,
            MODIFIED_BY_USERID,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID)
            values
            (
            #{invoiceDetailId},
            #{invoiceId},
            #{subBudgetID},
            '2',
            #{id},
            #{invoicedAmt},
            SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR} , SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider
            ,jdbcType=VARCHAR},
            #{modifyByProvider ,jdbcType=VARCHAR}
            )
     
      </insert>
 
      <select id="getSeqForInvoiceDetail" resultType="Integer">
            SELECT
            SEQ_INVOICE_DETAIL_ID.NEXTVAL
            FROM DUAL
      </select>
     
     
            <select id="getSeqForInvoiceAdvanceNumber" resultType="Integer">
            SELECT
            SEQ_INVOICE_ADVANCE_NUMBER.NEXTVAL
            FROM DUAL
            </select>
      <!-- INVOICE OPERATION SUPPORT QUERIES - ENDS HERE -->
 
      <!-- INVOICE EQUIPMENTS QUERIES - STARTS HERE -->
      <resultMap id="equipmentList" type="com.nyc.hhs.model.CBEquipmentBean">
            <result property="id" column="EQUIPMENT_ID" />
            <result property="invoiceDetailId" column="INVOICE_DETAIL_ID" />
            <result property="equipment" column="EQUIPMENT_NAME" />
            <result property="fyBudget" column="FY_BUDGET" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
 
      </resultMap>
      <select id="fetchEquipmentDetails" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="equipmentList">
 		<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 12
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            select
            eqp.EQUIPMENT_ID,
            eqp.EQUIPMENT_NAME,
            eqp.UNITS,
            eqp.AMOUNT AS
            FY_BUDGET,
            SUM(CASE
            WHEN INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT
            from
            EQUIPMENT
            eqp
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            eqp.EQUIPMENT_ID = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 12
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            inv.invoice_id
            AND
            invvv.status_id IN ('72','73')
            WHERE
            eqp.SUB_BUDGET_ID
            = #{subBudgetID}
            AND eqp.active_flag = 1
            GROUP BY
            eqp.EQUIPMENT_ID,
            eqp.EQUIPMENT_NAME,
            eqp.UNITS,
            eqp.AMOUNT
            order by
            eqp.EQUIPMENT_ID desc
 
            <!-- SELECT EQ.EQUIPMENT_ID, EQ.EQUIPMENT_NAME , EQ.AMOUNT from EQUIPMENT
                  EQ where EQ.ACTIVE_FLAG='1' AND EQ.SUB_BUDGET_ID = #{subBudgetID} ORDER BY
                  EQ.EQUIPMENT_ID -->
      </select>
 
      <resultMap id="equipmentInvList" type="com.nyc.hhs.model.CBEquipmentBean">
            <result property="id" column="LINE_ITEM_ID" />
            <result property="invoiceDetailId" column="INVOICE_DETAIL_ID" />
            <result property="invoicedAmt" column="INVOICE_AMOUNT" />
 
      </resultMap>
      <select id="fetchEquipmentInvoiceDetails" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="equipmentInvList">
            select INV.INVOICE_ID,
            IDT.invoice_detail_id,IDT.LINE_ITEM_ID,
            NVL(IDT.invoice_amount, 0) AS
            INVOICE_AMOUNT from INVOICE_DETAILS IDT,
            INVOICE INV
            where
            INV.INVOICE_ID = IDT.INVOICE_ID AND IDT.ENTRY_TYPE_ID='12' AND
            IDT.INVOICE_ID=#{invoiceId}
      </select>
 
      <select id="fetchBudgetAllocatedForAnEquipment" parameterType="java.lang.String"
            resultType="java.lang.String">
            select NVL(AMOUNT,0) from EQUIPMENT where
            EQUIPMENT_ID =
            #{aoEquipmentId}
      </select>
     
      <!-- Made changes for enhancement id 6535 release 3.8.0-->
      <select id="fetchInvAmountForAnEquipment" parameterType="com.nyc.hhs.model.CBEquipmentBean"
            resultType="java.lang.String">
            <!-- Fetch Invoiced Amount for a Single eQUIPMENT -->
            SELECT
            nvl((SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            IDT.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            IDT.invoice_amount &lt; 0
            </if>
            THEN IDT.INVOICE_AMOUNT
            ELSE 0
            END )),0) as INVOICE_AMOUNT
            FROM INVOICE INV INNER JOIN
            INVOICE_DETAILS IDT
            ON INV.INVOICE_ID = IDT.INVOICE_ID
            INNER JOIN
            ENTRY_TYPE_MASTER EM ON EM.ENTRY_TYPE_ID = IDT.ENTRY_TYPE_ID
            INNER JOIN
            EQUIPMENT EQ ON IDT.LINE_ITEM_ID =
            EQ.EQUIPMENT_ID
            WHERE
            IDT.ENTRY_TYPE_ID = '12' AND EQ.SUB_BUDGET_ID =#{subBudgetID} AND
            EQ.EQUIPMENT_ID= #{id}
            AND INV.STATUS_ID IN ('70','71','72','73') <if test="invoiceDetailId != ''">AND IDT.INVOICE_DETAIL_ID
            NOT IN
            (#{invoiceDetailId}) </if>
 
 
      </select>
 
 
      <update id="editEquipmentDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
            UPDATE
            INVOICE_DETAILS
            SET INVOICE_AMOUNT = #{invoicedAmt},
            modified_date=CURRENT_TIMESTAMP, MODIFIED_BY_STAFFID =
            #{modifyByProvider}
            WHERE
            INVOICE_DETAIL_ID = #{invoiceDetailId}
      </update>
 
      <insert id="insertEquipmentDetails" parameterType="com.nyc.hhs.model.CBEquipmentBean">
            Insert into
            INVOICE_DETAILS
            (INVOICE_DETAIL_ID,
            INVOICE_ID,
            SUB_BUDGET_ID,
            ENTRY_TYPE_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            CREATED_DATE,
            CREATED_BY_USERID,
            MODIFIED_DATE,
            MODIFIED_BY_USERID,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID)
            values
            (
            #{invoiceDetailId},
            #{invoiceId},
            #{subBudgetID},
            '12',
            #{id},
            #{invoicedAmt},
            SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR} , SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR},#{modifyByProvider
            ,jdbcType=VARCHAR},
            #{modifyByProvider ,jdbcType=VARCHAR}
            )
           
     
      </insert>
 
      <select id="fetchInvoiceTotalForOTPS" parameterType="com.nyc.hhs.model.CBGridBean"
            resultType="java.lang.String">
            SELECT NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),0) FROM
            INVOICE_DETAILS
            INNER JOIN ENTRY_TYPE_MASTER ON
            ENTRY_TYPE_MASTER.ENTRY_TYPE_ID =
            INVOICE_DETAILS.ENTRY_TYPE_ID
            INNER
            JOIN INVOICE
            ON INVOICE.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
            WHERE
            INVOICE_DETAILS.INVOICE_ID = #{invoiceId} AND INVOICE_DETAILS.SUB_BUDGET_ID = #{subBudgetID}
            AND
            (INVOICE_DETAILS.ENTRY_TYPE_ID = '12'
            OR INVOICE_DETAILS.ENTRY_TYPE_ID
            = '2')     
     
      </select>
    <select id="fetchInvoiceTotalForContractedServices" parameterType="com.nyc.hhs.model.CBGridBean"
            resultType="java.lang.String">
            SELECT SUM(amount)as TOTAL_CONTRACTED_SERVICES
            FROM
            (
            SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,
            a.AMOUNT
            FROM CONTRACTED_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID =
            a.CONTRACTED_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID = '6'
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in( 72,73)
            WHERE a.BUDGET_ID =
            #{contractBudgetID}
            AND a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT
            )
     
      </select>
      <select id="fetchYTDInvoiced" parameterType="java.lang.String"
            resultType="java.lang.String">
            SELECT NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),0)
            FROM
            INVOICE_DETAILS
            INNER JOIN ENTRY_TYPE_MASTER
            ON
            ENTRY_TYPE_MASTER.ENTRY_TYPE_ID = INVOICE_DETAILS.ENTRY_TYPE_ID
            INNER
            JOIN INVOICE
            ON INVOICE.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
            WHERE
            INVOICE_DETAILS.SUB_BUDGET_ID = #{asSubBudgetId}
            AND(INVOICE_DETAILS.ENTRY_TYPE_ID = '12'
            OR
            INVOICE_DETAILS.ENTRY_TYPE_ID = '2')
            AND (INVOICE.STATUS_ID = '72' OR
            INVOICE.STATUS_ID = '73')    
     
      </select>
      <select id="fetchInvoiceStatus" parameterType="java.lang.String"
            resultType="java.lang.String">
            select Status_ID from INVOICE where invoice_id=
            #{asInvoiceId}
     
      </select>
      <select id="fetchCSYTDInvoiced" parameterType="java.lang.String"
            resultType="java.lang.String">
            SELECT NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),0)
            FROM
            INVOICE_DETAILS
            INNER JOIN ENTRY_TYPE_MASTER
            ON
            ENTRY_TYPE_MASTER.ENTRY_TYPE_ID = INVOICE_DETAILS.ENTRY_TYPE_ID
            INNER
            JOIN INVOICE
            ON INVOICE.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
            WHERE
            INVOICE_DETAILS.SUB_BUDGET_ID = #{asSubBudgetId}
            AND INVOICE_DETAILS.ENTRY_TYPE_ID = '6'
            AND (INVOICE.STATUS_ID = '72' OR
            INVOICE.STATUS_ID = '73')    
     
      </select>
 
 
 
 
      <resultMap id="invoiceSummary" type="com.nyc.hhs.model.BudgetDetails">
            <result property="approvedBudget" column="FY_BUDGET" />
            <result property="ytdInvoicedAmount" column="YTD_INVOICED_AMOUNT" />
            <result property="remainingAmount" column="REMAINING_AMOUNT" />
            <result property="invoicedAmount" column="INVOICE_AMOUNT" />
            <result property="title" column="MAIN_COLUMN" />
      </resultMap>
 
      <select id="fetchInvoiceSummary" parameterType="HashMap"
            resultMap="invoiceSummary">
            <!-- contract budget invoice summary for operations,support and equipment -->
            <!-- Start R 8.7.0 qc 9560 EXT - QC9501 - Invoice Budget Summary Not Including Credits after Invoice Submitted -->
            <!-- removed 8.6.0 change -->
            <!--End R 8.7.0 qc 9560 EXT - QC9501 - Invoice Budget Summary Not Including Credits after Invoice Submitted -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{OPS} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            OPERATIONS_SUPPORT_ID,
            a.AMOUNT
            FROM
            operations_and_support a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.OPERATIONS_SUPPORT_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{OSEntryType}
            INNER JOIN
            OPERATIONS_SUPPORT_TYPE_MASTER b
            ON b.OPERATIONS_SUPPORT_TYPE_ID =
            a.OPERATIONS_SUPPORT_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY OPERATIONS_SUPPORT_ID,
            a.AMOUNT
            union all
            SELECT 0
            AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID
            IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            OPERATIONS_SUPPORT_ID,
            0 AS amount
            FROM
            operations_and_support a
            LEFT
            JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.OPERATIONS_SUPPORT_ID
            AND inv_det.ENTRY_TYPE_ID
            = #{OSEntryType}
            INNER JOIN
            OPERATIONS_SUPPORT_TYPE_MASTER b
            ON
            b.OPERATIONS_SUPPORT_TYPE_ID =
            a.OPERATIONS_SUPPORT_TYPE_ID
            LEFT JOIN
            INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE
 
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            OPERATIONS_SUPPORT_ID,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for equipment -->
            SELECT SUM(amount) AS FY_BUDGET,
            SUM(INVOICE_AMOUNT) AS
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) AS INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{EQP} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            EQUIPMENT_ID,
            a.AMOUNT
            FROM EQUIPMENT a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.EQUIPMENT_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{EQUIEntryType}
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND inv.STATUS_ID IN
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
                        </foreach>
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY EQUIPMENT_ID,
            a.AMOUNT
            UNION ALL
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT
            NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            EQUIPMENT_ID,
            0 AS amount
            FROM EQUIPMENT a
            LEFT
            JOIN INVOICE_DETAILS
            inv_det
            ON inv_det.LINE_ITEM_ID = a.EQUIPMENT_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{EQUIEntryType}            
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID =
            #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            EQUIPMENT_ID,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for salary -->
            SELECT SUM(TOTAL_SALARY) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(TOTAL_SALARY) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{TS} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            PERSONNEL_SERVICE_ID,
            a.TOTAL_SALARY
            FROM
            PERSONNEL_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.PERSONNEL_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
              = #{TSEntryType}
                 
            INNER JOIN PERSONNEL_SERVICE_TYPE_MASTER b
            ON
            b.PERSONNEL_SERVICE_TYPE_ID = a.PERSONNEL_SERVICE_TYPE_ID
            AND
            a.PERSONNEL_SERVICE_TYPE_ID IN (1,2,3)
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID
            = inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY PERSONNEL_SERVICE_ID,
            a.TOTAL_SALARY
            union all
            SELECT 0 AS INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS CURRENT_INVOICE_AMOUNT,
            PERSONNEL_SERVICE_ID,
            0 AS TOTAL_SALARY
            FROM
            PERSONNEL_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.PERSONNEL_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
              = #{TSEntryType}
           
            INNER
            JOIN PERSONNEL_SERVICE_TYPE_MASTER b
            ON
            b.PERSONNEL_SERVICE_TYPE_ID =
            a.PERSONNEL_SERVICE_TYPE_ID
            AND
            a.PERSONNEL_SERVICE_TYPE_ID IN (1,2,3)
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID
            = inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            PERSONNEL_SERVICE_ID,
            a.TOTAL_SALARY
            )
 
 
            union all
            <!-- contract budget invoice summary for fringes -->
            SELECT SUM(AMOUNT)                    AS FY_BUDGET,
              SUM(INVOICE_AMOUNT)                 AS YTD_INVOICED_AMOUNT,
              SUM(CURRENT_INVOICE_AMOUNT)         AS INVOICE_AMOUNT,
              (SUM(AMOUNT) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
              #{TF}                            AS MAIN_COLUMN
            FROM
              (SELECT SUM(
                CASE
                  WHEN inv.STATUS_ID IS NOT NULL
                  THEN NVL(inv_det.INVOICE_AMOUNT,0)
                  ELSE 0
                END ) AS INVOICE_AMOUNT,
                0     AS CURRENT_INVOICE_AMOUNT,
                FRINGE_BENEFIT_ID,
                a.AMOUNT
              FROM FRINGE_BENEFIT a
              LEFT JOIN INVOICE_DETAILS inv_det
              ON inv_det.LINE_ITEM_ID   = a.FRINGE_BENEFIT_ID
              AND inv_det.ENTRY_TYPE_ID = #{TFEntryType}
              LEFT JOIN INVOICE inv
              ON inv.INVOICE_ID     = inv_det.INVOICE_ID
              AND inv.STATUS_ID    IN <foreach item="items" index="index" collection="invoiceList"
                              open="(" separator="," close=")">
                              #{items}
                  </foreach>
              WHERE a.SUB_BUDGET_ID = #{subBudgetID}
              GROUP BY FRINGE_BENEFIT_ID,
                a.AMOUNT
              UNION ALL
              SELECT 0 AS INVOICE_AMOUNT,
                SUM(
                CASE
                  WHEN inv.STATUS_ID IS NOT NULL
                  THEN NVL(inv_det.INVOICE_AMOUNT,0)
                  ELSE 0
                END ) AS CURRENT_INVOICE_AMOUNT,
                FRINGE_BENEFIT_ID,
                0 AS AMOUNT
              FROM FRINGE_BENEFIT a
              LEFT JOIN INVOICE_DETAILS inv_det
              ON inv_det.LINE_ITEM_ID   = a.FRINGE_BENEFIT_ID
              AND inv_det.ENTRY_TYPE_ID = #{TFEntryType}
               
              LEFT JOIN INVOICE inv
              ON inv.INVOICE_ID      = inv_det.INVOICE_ID
              AND inv_det.INVOICE_ID = #{invoiceId}
              WHERE a.SUB_BUDGET_ID  = #{subBudgetID}
              GROUP BY FRINGE_BENEFIT_ID,
                a.AMOUNT
              )
 
            union all
            <!-- contract budget invoice summary for utilities -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{UT} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            UTILITIES_ID,
            util.AMOUNT
            FROM UTILITIES util
            LEFT JOIN INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID =
            util.UTILITIES_ID
            AND inv_det.ENTRY_TYPE_ID = #{UTEntryType}
            
            INNER JOIN
            UTILITIES_TYPE_MASTER util_mstr
            ON util_mstr.UTILITIES_TYPE_ID =
            util.UTILITIES_TYPE_ID
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE util.BUDGET_ID = #{contractBudgetID}
            AND util.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY UTILITIES_ID,
            util.AMOUNT
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS CURRENT_INVOICE_AMOUNT,
            UTILITIES_ID,
            0 AS amount
            FROM UTILITIES util
            LEFT JOIN INVOICE_DETAILS
            inv_det
            ON inv_det.LINE_ITEM_ID = util.UTILITIES_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{UTEntryType}
            
            INNER JOIN UTILITIES_TYPE_MASTER
            util_mstr
            ON util_mstr.UTILITIES_TYPE_ID = util.UTILITIES_TYPE_ID
            LEFT
            JOIN
            INVOICE inv
            ON inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID = #{invoiceId}
            WHERE util.BUDGET_ID =
            #{contractBudgetID}
            AND util.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            UTILITIES_ID,
            util.AMOUNT
            )
 
 
            union all
            <!-- contract budget invoice summary for professional services -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{PS} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            PROFESSIONAL_SERVICE_ID,
            a.AMOUNT
            FROM
            PROFESSIONAL_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.PROFESSIONAL_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{PSEntryType}
             
            INNER JOIN
            PROFESSIONAL_SERVICE_TYPE_MSTR b
            ON b.PROFESSIONAL_SERVICE_TYPE_ID =
            a.PROFESSIONAL_SERVICE_TYPE_ID
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY PROFESSIONAL_SERVICE_ID,
            a.AMOUNT
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID
            IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            PROFESSIONAL_SERVICE_ID,
            0 AS amount
            FROM
            PROFESSIONAL_SERVICE a
            LEFT
            JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.PROFESSIONAL_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{PSEntryType}
             
            INNER JOIN
            PROFESSIONAL_SERVICE_TYPE_MSTR b
            ON
            b.PROFESSIONAL_SERVICE_TYPE_ID =
            a.PROFESSIONAL_SERVICE_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID = #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            PROFESSIONAL_SERVICE_ID,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for rent -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{RO} AS
            MAIN_COLUMN
            FROM
            (
            SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            rent_id,
            a.AMOUNT
            FROM rent a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.rent_id
            AND
            inv_det.ENTRY_TYPE_ID = #{ROEntryType}
             
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY rent_id,
            a.AMOUNT
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS CURRENT_INVOICE_AMOUNT,
            rent_id,
            0 AS amount
            FROM rent a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.rent_id
            AND inv_det.ENTRY_TYPE_ID =
            #{ROEntryType}
           
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID = #{invoiceId}
            WHERE
 
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY rent_id,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for contracted services -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{CS} AS
            MAIN_COLUMN
            FROM
            (
            SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,
            a.AMOUNT
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{CSEntryType}
            
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY CONTRACTED_SERVICE_ID,
            a.AMOUNT
            union all
            SELECT 0
            AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID
            IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,
            0 AS amount
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.CONTRACTED_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
            = #{CSEntryType}
           
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON
            b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT JOIN
            INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for rate -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURrate_INVOICE_AMOUNT),
            (SUM(amount) -
            SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{TR} AS MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURrate_INVOICE_AMOUNT,
            rate_id,
            a.AMOUNT
            FROM rate a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.rate_id
            AND
            inv_det.ENTRY_TYPE_ID = #{TREntryType}
             
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY rate_id,
            a.AMOUNT
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS CURrate_INVOICE_AMOUNT,
            rate_id,
            0 AS amount
            FROM rate a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.rate_id
            AND inv_det.ENTRY_TYPE_ID =
            #{TREntryType}
          
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID = #{invoiceId}
            WHERE
 
            a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY rate_id,
            a.AMOUNT
            )
 
            union all
            <!-- contract budget invoice summary for total milestone based -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{TM} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            milestone_id,
            a.AMOUNT
            FROM milestone a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.milestone_id
            AND
            inv_det.ENTRY_TYPE_ID =#{TMEntryType}
            
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY milestone_id,
            a.AMOUNT
            union all
            SELECT 0
            AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT
            NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            milestone_id,
            0 AS amount
            FROM milestone a
            LEFT
            JOIN INVOICE_DETAILS
            inv_det
            ON inv_det.LINE_ITEM_ID = a.milestone_id
            AND
            inv_det.ENTRY_TYPE_ID = #{TMEntryType}
             
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID =
            #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID
            = #{subBudgetID}
            GROUP BY
            milestone_id,
            a.AMOUNT
            )
 
 
            union all
            <!-- contract budget invoice summary for unallocated funds -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{UF} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            UNALLOCATED_id,
            a.AMOUNT
            FROM UNALLOCATED a
            LEFT
            JOIN INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.UNALLOCATED_id
            AND inv_det.ENTRY_TYPE_ID = #{UF_ENTRY_TYPE}
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID
            = inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY UNALLOCATED_id,
            a.AMOUNT
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT
            NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            UNALLOCATED_id,
            0 AS amount
            FROM UNALLOCATED a
            LEFT JOIN INVOICE_DETAILS
            inv_det
            ON inv_det.LINE_ITEM_ID =
            a.UNALLOCATED_id
            AND
            inv_det.ENTRY_TYPE_ID =#{UF_ENTRY_TYPE}
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            =
            #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID
            = #{subBudgetID}
            GROUP BY
            UNALLOCATED_id,
            a.AMOUNT
            )
            union all
            <!-- contract budget invoice summary for indirect rate id -->
            SELECT SUM(indirect_amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(indirect_amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{TI} AS MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            indirect_rate_id,
            a.indirect_amount
            FROM
            indirect_rate a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.indirect_rate_id
            AND inv_det.ENTRY_TYPE_ID =
            #{TIEntryType}
               
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY indirect_rate_id,
            a.indirect_amount
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS CURRENT_INVOICE_AMOUNT,
            indirect_rate_id,
            0 AS indirect_amount
            FROM
            indirect_rate a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID
            = a.indirect_rate_id
            AND inv_det.ENTRY_TYPE_ID = #{TIEntryType}
                      
            LEFT
            JOIN INVOICE inv
            ON
            inv.INVOICE_ID
            = inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID =
            #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID
            = #{subBudgetID}
            GROUP BY
            indirect_rate_id,
            a.indirect_amount
            )
 
            union all
            <!-- contract budget invoice summary for total program income -->
            SELECT SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) - SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            #{TP} AS
            MAIN_COLUMN
            FROM
            (SELECT SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            PROGRAM_INCOME_id,
            a.amount
            FROM PROGRAM_INCOME a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID =
            a.PROGRAM_INCOME_id
            AND inv_det.ENTRY_TYPE_ID = #{TPEntryType}
              
            LEFT JOIN
            INVOICE
            inv
            ON inv.INVOICE_ID = inv_det.INVOICE_ID
            AND inv.STATUS_ID in
            <foreach item="items" index="index" collection="invoiceList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            WHERE
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            GROUP BY
            PROGRAM_INCOME_id,
            a.amount
            union all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID
            IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            PROGRAM_INCOME_id,
            0 AS amount
            FROM
            PROGRAM_INCOME a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.PROGRAM_INCOME_id
            AND inv_det.ENTRY_TYPE_ID =
            #{TPEntryType}
           
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID =
            #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID
            = #{subBudgetID}
            GROUP BY PROGRAM_INCOME_id,
            a.amount
            )
           
      </select>
 
      <!-- Contract Budget invoice - Program Income Starts -->
 
      <resultMap id="programIncomeInvoiceList" type="com.nyc.hhs.model.CBProgramIncomeBean">
            <result property="id" column="PROGRAM_INCOME_ID" />
            <result property="programTitle" column="PROGRAM_INCOME_TYPE" />
            <result property="income" column="INVOICE_AMOUNT" />
            <result property="remainingAmount" column="REMAINING_AMOUNT" />
            <!--  Added in R7 -->
            <result property="budgetCategory" column="Entry_type" />
            <result property="empPosition" column="PROGRAM_INCOME_TYPE" />
            <result property="description" column="DESCRIPTION" />
            <!-- R7 changes end -->
      </resultMap>
 
      <select id="fetchProgramIncomeInvoice" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="programIncomeInvoiceList">
  			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 11
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
           SELECT PROGRAM_INCOME_ID, PROGRAM_INCOME_TYPE, Entry_type,Description,entry_type_id,
            sum(REMAINING_AMOUNT)
            as
            REMAINING_AMOUNT, sum(INVOICE_AMOUNT) as
            INVOICE_AMOUNT
            FROM
            (
            SELECT
            PI.PROGRAM_INCOME_ID,
            PI_mstr.PROGRAM_INCOME_TYPE,
            <!--  Added in R7 -->
            decode(Entry_type,'Personnel Service Salary','Personnel Services',Entry_type) AS Entry_type,
            PI.Description,
            PI.entry_type_id,
             <!-- R7 changes end -->
            (PI.AMOUNT -
            (SUM(CASE
            WHEN inv.STATUS_ID IS
            NOT NULL
            THEN inv_det.INVOICE_AMOUNT
            ELSE 0
            END )))
            as REMAINING_AMOUNT,
            0
            AS INVOICE_AMOUNT
 
            FROM
            PROGRAM_INCOME PI
           <!--  Added in R7 for showing budget category-->
           LEFT JOIN ENTRY_TYPE_MASTER etm
           ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
            <!-- R7 changes end -->
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = PI.PROGRAM_INCOME_ID
            AND
            inv_det.ENTRY_TYPE_ID
            =
            '11'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            <!--  Added in R7 -->
            AND inv_det.pi_entry_type_id = pi.entry_type_id
             <!-- R7 changes end -->
            INNER JOIN PROGRAM_INCOME_TYPE PI_mstr
            ON
            PI_mstr.PROGRAM_INCOME_TYPE_ID = PI.PROGRAM_INCOME_TYPE_ID
 
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID IN
            ('72','73')
 
            WHERE
            PI.BUDGET_ID = #{contractBudgetID}
            AND
            PI.SUB_BUDGET_ID=
            #{subBudgetID}
            <!--  Added in R7 -->
            <if test="null!= entryTypeId">
            and pi.ENTRY_TYPE_ID=#{entryTypeId}
            </if>
            GROUP BY
            PI.PROGRAM_INCOME_ID
            ,PI.AMOUNT,
            PI_mstr.PROGRAM_INCOME_TYPE,Entry_type,Description,PI.entry_type_id
 
            UNION ALL
 
            SELECT
            PI.PROGRAM_INCOME_ID,
            PI_mstr.PROGRAM_INCOME_TYPE,
            <!--  Added in R7 -->
            decode(Entry_type,'Personnel Service Salary','Personnel Services',Entry_type) AS Entry_type,
            PI.Description,
            PI.entry_type_id,
             <!-- R7 changes end -->
            0 AS REMAINING_AMOUNT,
            nvl(inv_det.INVOICE_AMOUNT,'0') AS INVOICE_AMOUNT
 
            FROM PROGRAM_INCOME
            PI
           <!--  Added in R7 for showing budget category-->
           LEFT JOIN ENTRY_TYPE_MASTER etm
           ON PI.ENTRY_TYPE_ID= etm.ENTRY_TYPE_ID
            <!-- R7 changes end -->
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            PI.PROGRAM_INCOME_ID
            AND
            inv_det.ENTRY_TYPE_ID = '11'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  				AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            <!--  Added in R7 -->
            <if test="null!= entryTypeId">
            AND inv_det.pi_entry_type_id = pi.entry_type_id
            </if>
             <!-- R7 changes end -->
            AND
            inv_det.INVOICE_ID=#{invoiceId}
            INNER JOIN PROGRAM_INCOME_TYPE PI_mstr
            ON
            PI_mstr.PROGRAM_INCOME_TYPE_ID = PI.PROGRAM_INCOME_TYPE_ID
 
            LEFT JOIN
            INVOICE
            inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
 
            WHERE
            PI.BUDGET_ID =
            #{contractBudgetID}
            AND
            PI.SUB_BUDGET_ID =#{subBudgetID}
            <!--  Added in R7 -->
            <if test="null!= entryTypeId">
            AND pi.ENTRY_TYPE_ID=#{entryTypeId}
            AND inv_det.PI_ENTRY_TYPE_ID=#{PIEntryTypeId}
            </if>
            )
            GROUP BY
            PROGRAM_INCOME_TYPE,PROGRAM_INCOME_ID,Entry_type,Description,entry_type_id
            ORDER BY
            ENTRY_TYPE_ID,PROGRAM_INCOME_ID DESC
      </select>
      <!-- Contract Budget invoice - Program Income Ends -->
 
      <resultMap id="UtilitiesInvoicingDetailsList" type="com.nyc.hhs.model.CBUtilities">
            <result property="id" column="UTILITIES_ID" />
            <result property="utilitiesDesc" column="UTILITIES_TYPE" />
            <result property="fyAmount" column="AMOUNT" />
            <result property="lineItemInvoiceAmt" column="INVOICE_AMOUNT" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="utilitiesTypeID" column="UTILITIES_TYPE_ID" />
      </resultMap>
 
      <select id="fetchInvoicingUtilitiesDetails" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="UtilitiesInvoicingDetailsList">
			 <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= #{entryTypeId}
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
			  <!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->		
            SELECT UTILITIES_ID, UTILITIES_TYPE, sum(REMAINING_AMOUNT)
            as REMAINING_AMOUNT, sum(INVOICE_AMOUNT) as INVOICE_AMOUNT
            FROM
            (
            SELECT
            util.UTILITIES_ID, util_mstr.UTILITIES_TYPE,
            (util.AMOUNT - (SUM(CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN inv_det.INVOICE_AMOUNT
            ELSE 0
            END )))
            as REMAINING_AMOUNT,
            0 AS INVOICE_AMOUNT
 
            FROM UTILITIES util
 
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = util.UTILITIES_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{entryTypeId}
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
 
            INNER JOIN UTILITIES_TYPE_MASTER
            util_mstr
            ON
            util_mstr.UTILITIES_TYPE_ID = util.UTILITIES_TYPE_ID
 
            LEFT
            JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID
            IN
            ('72','73')
 
            WHERE
            util.BUDGET_ID = #{contractBudgetID}
            AND
            util.SUB_BUDGET_ID =#{subBudgetID}
            GROUP BY
            util.UTILITIES_ID
            ,util.AMOUNT, util_mstr.UTILITIES_TYPE
 
            UNION ALL
 
            SELECT
            util.UTILITIES_ID, util_mstr.UTILITIES_TYPE, 0 as REMAINING_AMOUNT,
            nvl(inv_det.INVOICE_AMOUNT,'0') AS INVOICE_AMOUNT
 
            FROM UTILITIES util
 
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            util.UTILITIES_ID
            AND
            inv_det.ENTRY_TYPE_ID =#{entryTypeId} AND
            inv_det.INVOICE_ID=#{invoiceId}
 
            INNER JOIN UTILITIES_TYPE_MASTER
            util_mstr
            ON
            util_mstr.UTILITIES_TYPE_ID = util.UTILITIES_TYPE_ID
 
            LEFT
            JOIN INVOICE
            inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
 
            WHERE
            util.BUDGET_ID =
            #{contractBudgetID}
            AND
            util.SUB_BUDGET_ID
            =#{subBudgetID}
            )
            GROUP BY
            UTILITIES_TYPE,UTILITIES_ID
            ORDER BY
            UTILITIES_ID
     
      </select>
 
      <select id="fetchUtilitiesRemainingAmount" parameterType="com.nyc.hhs.model.CBUtilities"
            resultType="BigDecimal">
            SELECT
            (util.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
            NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ))) as REMAINING_AMOUNT
 
            FROM
            UTILITIES util
 
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            util.UTILITIES_ID
            AND
            inv_det.ENTRY_TYPE_ID = #{entryTypeId}
 
            INNER JOIN
            UTILITIES_TYPE_MASTER util_mstr
            ON
            util_mstr.UTILITIES_TYPE_ID =
            util.UTILITIES_TYPE_ID
 
            LEFT JOIN
            INVOICE
            inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID IN
            ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
 
            WHERE
            util.BUDGET_ID =
            #{contractBudgetID}
            AND
            util.SUB_BUDGET_ID
            =#{subBudgetID}
            AND
            util.utilities_id = #{id}
            GROUP BY
            util.AMOUNT
            ORDER BY
            util.UTILITIES_ID
      </select>
 
 
      <update id="updateInvoicingDetails" parameterType="HashMap">
            UPDATE
            INVOICE_DETAILS SET INVOICE_AMOUNT = #{lineItemInvoiceAmt},
            modified_date=CURRENT_TIMESTAMP,
            MODIFIED_BY_USERID =
            #{modifyByAgency,jdbcType=VARCHAR},
            MODIFIED_BY_STAFFID =
            #{modifyByProvider ,jdbcType=VARCHAR},
            INVOICED_UNITS = #{invUnits,jdbcType=NUMERIC}
            WHERE LINE_ITEM_ID = #{id} AND
            ENTRY_TYPE_ID = #{entryTypeId} AND
            INVOICE_ID = #{invoiceId}
      </update>
 
      <insert id="insertInvoicingLineItemDetails" parameterType="HashMap">
            Insert into INVOICE_DETAILS
            (INVOICE_DETAIL_ID,
            INVOICE_ID,
            SUB_BUDGET_ID,
            ENTRY_TYPE_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            CREATED_DATE,
            CREATED_BY_USERID,
            MODIFIED_DATE,
            MODIFIED_BY_USERID,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID,
            INVOICED_UNITS
            <!-- Added in R7 -->
            <if test="entryTypeId == '11'">
            ,PI_ENTRY_TYPE_ID
            </if>
            )
           
            values
 
            (SEQ_INVOICE_DETAIL_ID.nextval,
            #{invoiceId},
            #{subBudgetID},
            #{entryTypeId},
            #{id},
            #{lineItemInvoiceAmt ,jdbcType=VARCHAR},
            SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR},
            SYSTIMESTAMP,
            #{modifyByAgency,jdbcType=VARCHAR},
            #{modifyByProvider
            ,jdbcType=VARCHAR},
            #{modifyByProvider ,jdbcType=VARCHAR},
            #{invUnits ,jdbcType=NUMERIC}
            <if test="entryTypeId == '11'">
            ,#{PIEntryTypeId}
            </if>
            )
      </insert>
 
 
      <!-- Invoicing - Unallocated Funds Starts -->
      <resultMap id="UnallocatedFundList" type="com.nyc.hhs.model.UnallocatedFunds">
            <result property="id" column="UNALLOCATED_ID" />
            <!-- QC 8694 R 7.8.0 apply add/delete functions for Unallocated Fund  -->
            <result property="unallocatedFund" column="UNALLOCATED_FUND" />
            <result property="budgetId" column="BUDGET_ID" />
            <result property="subBudgetId" column="SUB_BUDGET_ID" />
            <result property="ammount" column="AMOUNT" />
            <result property="createdDate" column="CREATED_DATE" />
            <result property="modifyByAgency" column="CREATED_BY_USERID" />
            <result property="modifyByProvider" column="CREATED_BY_STAFFID" />
            <result property="modifiedDate" column="MODIFIED_DATE" />
            <result property="modifyByAgency" column="MODIFIED_BY_USERID" />
            <result property="modifyByProvider" column="MODIFIED_BY_STAFFID" />
      </resultMap>
 
      <select id="fetchInvoiceUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds"
            resultMap="UnallocatedFundList">
            SELECT 
            	unAloc.UNALLOCATED_ID, 
            	<!-- QC 8694b R 7.8.0 apply add/delete functions for Unallocated Fund  -->
            	unAloc.UNALLOCATED_FUND,
            	unAloc.BUDGET_ID,
            	unAloc.SUB_BUDGET_ID,
            	unAloc.AMOUNT,unAloc.CREATED_DATE,
            	unAloc.CREATED_BY_USERID,
            	unAloc.MODIFIED_DATE,
            	unAloc.MODIFIED_BY_USERID,
            	unAloc.ACTIVE_FLAG
            FROM UNALLOCATED unAloc
            where  unAloc.SUB_BUDGET_ID = #{subBudgetId}    
      </select>
 
      <insert id="insertInvoiceUnallocatedFunds" parameterType="com.nyc.hhs.model.UnallocatedFunds">
            insert
            into UNALLOCATED(UNALLOCATED_ID,BUDGET_ID,SUB_BUDGET_ID,PARENT_ID,
      AMOUNT,CREATED_DATE,CREATED_BY_USERID,CREATED_BY_STAFFID,MODIFIED_DATE,MODIFIED_BY_USERID,MODIFIED_BY_STAFFID,ACTIVE_FLAG, UNALLOCATED_FUND)
            values
            (SEQ_UNALLOCATED_ID.NEXTVAL,#{budgetId},#{subBudgetId},SEQ_UNALLOCATED_ID.CURRVAL,
            #{ammount},current_timestamp,
      #{modifyByAgency},#{modifyByProvider},current_timestamp,#{modifyByAgency},#{modifyByProvider},'1', 'Unallocated Fund')
      </insert>
      <!-- Invoicing - Unallocated Funds Ends -->
 
 
      <!-- Invoicing - Professional Services -->
      <resultMap id="CoProfessionalServicesList" type="com.nyc.hhs.model.CBProfessionalServicesBean">
            <result property="contractBudgetID" column="BUDGET_ID" />
            <result property="subBudgetID" column="SUB_BUDGET_ID" />
            <result property="id" column="PROFESSIONAL_SERVICE_ID" />
            <result property="profServiceTypeId" column="PROFESSIONAL_SERVICE_TYPE_ID" />
            <result property="invoiceDetailId" column="INVOICE_DETAIL_ID" />
            <result property="professionalServiceName" column="PROFESSIONAL_SERVICE_TYPE" />
            <result property="fyBudget" column="AMOUNT" />
            <result property="ytdInvoicedAmt" column="TOTAL_INVOICE_AMOUNT" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="invoiceAmount" column="INVOICE_AMOUNT" />
      </resultMap>
 
      <select id="fetchInvoiceProfServices" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="CoProfessionalServicesList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 4
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
			 <!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            select
            profess.PROFESSIONAL_SERVICE_ID,
            profess.PROFESSIONAL_SERVICE_TYPE_ID,
            profess.BUDGET_ID,
            profess.SUB_BUDGET_ID,
            invDetail.INVOICE_DETAIL_ID,
            CASE
            WHEN
            other.ENTITY_NAME IS NOT NULL THEN other.ENTITY_NAME
            ELSE
            profess_master.PROFESSIONAL_SERVICE_TYPE
            END
            as
            PROFESSIONAL_SERVICE_TYPE,
            nvl(profess.AMOUNT,'0') as AMOUNT ,
            (nvl(invoicedetail.INVOICE_AMOUNT,'0')) as TOTAL_INVOICE_AMOUNT,
            nvl(profess.AMOUNT,'0') - nvl(invoicedetail.INVOICE_AMOUNT,'0') as
            REMAINING_AMOUNT,
            (nvl(invDetail.INVOICE_AMOUNT,'0')) as INVOICE_AMOUNT
            from
            PROFESSIONAL_SERVICE_TYPE_MSTR profess_master
            inner join
            PROFESSIONAL_SERVICE profess on profess.PROFESSIONAL_SERVICE_TYPE_ID =
            profess_master.PROFESSIONAL_SERVICE_TYPE_ID and profess.active_flag = '1'
            <!-- Begin REL 3.9.0 QC 6479 eliminate rows where parent_id equals id & another row exists with that parent_id -->
            and profess.PROFESSIONAL_SERVICE_ID in
                  (
                    select professional_service_id from PROFESSIONAL_SERVICE where parent_id not in
                      (select parent_id from PROFESSIONAL_SERVICE where active_flag=1 and professional_service_id != parent_id and BUDGET_ID = #{contractBudgetID})
                    union
                    select professional_service_id from PROFESSIONAL_SERVICE where active_flag=1 and professional_service_id != parent_id and BUDGET_ID = #{contractBudgetID}
                  )
            <!-- End REL 3.9.0 QC 6479  -->
            left outer join OTHER_DETAILS other on other.ENTITY_ID =
            profess.PROFESSIONAL_SERVICE_ID and other.ENTRY_TYPE_ID = 4 and
            other.active_flag = '1'
            left outer join (select entry_type_id,
            line_item_id, sum(invoice_amount)
            as INVOICE_AMOUNT
            from INVOICE_DETAILS
            where INVOICE_ID IN
            (select invoice_id from INVOICE where CONTRACT_ID =
            #{contractID} and
            BUDGET_ID = #{contractBudgetID} and STATUS_ID in
            (72,73)) and
            ENTRY_TYPE_ID = 4
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND INVOICE_DETAILS.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            group by entry_type_id, line_item_id)
            invoicedetail on
            invoicedetail.entry_type_id = 4 and
            invoicedetail.line_item_id =
            profess.PROFESSIONAL_SERVICE_ID
            left outer
            join ( select * from INVOICE_DETAILS where INVOICE_ID =
            #{invoiceId}
            and entry_type_id = 4) invDetail
            on invDetail.entry_type_id = 4 and
            invDetail.line_item_id =
            profess.PROFESSIONAL_SERVICE_ID
            where
            profess.BUDGET_ID =
            #{contractBudgetID} and profess.SUB_BUDGET_ID =
            #{subBudgetID}
            order by
            profess_master.professional_service_type_id
      </select>
 
      <update id="updateInvoiceForProfServices" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
            update
            INVOICE_DETAILS set INVOICE_AMOUNT = #{invoiceAmount}, MODIFIED_DATE =
            SYSTIMESTAMP, MODIFIED_BY_USERID = #{modifyByAgency},
            MODIFIED_BY_STAFFID = #{modifyByProvider}
            where INVOICE_ID
            =
            #{invoiceId} and ENTRY_TYPE_ID = 4 and LINE_ITEM_ID =
            #{id} and
            SUB_BUDGET_ID = #{subBudgetID}
      </update>
 
      <select id="fetchCountInvoiceDetail" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean"
            resultType="java.lang.Integer">
            select count(1) from invoice_details where invoice_id =
            #{invoiceId} and entry_type_id = 4 and line_item_id = #{id}
    </select>
 
      <select id="getInvoiceDetailId" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean"
            resultType="java.lang.String">
            select invoice_detail_id
            from INVOICE_DETAILS
            where
            invoice_id = #{invoiceId} and sub_budget_id = #{subBudgetID} and
            entry_type_id = 4 and line_item_id = #{id}
    </select>
 
      <insert id="addInvoiceForProfServices" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean">
            insert into
            INVOICE_DETAILS
            (INVOICE_DETAIL_ID,
            INVOICE_ID,
            ENTRY_TYPE_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            CREATED_DATE,
            CREATED_BY_USERID,
            CREATED_BY_STAFFID,
            MODIFIED_DATE,
            MODIFIED_BY_USERID,
            MODIFIED_BY_STAFFID,
            SUB_BUDGET_ID)
            values
            (SEQ_INVOICE_DETAIL_ID.nextval,
            #{invoiceId},
            4,
            #{id},
            #{invoiceAmount},
            SYSTIMESTAMP,
            #{modifyByAgency},
            #{modifyByProvider},
            SYSTIMESTAMP,
            #{modifyByAgency},
            #{modifyByProvider},
            #{subBudgetID})
      </insert>
 
 
      <select id="fetchTotalRemainingAmnt" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean"
            resultType="BigDecimal">
            SELECT AMOUNT - SUM (INVOICE_AMOUNT) AS remaining_amount FROM (
      select
            nvl(profess.AMOUNT,'0') as AMOUNT,
            nvl(invoicedetail.INVOICE_AMOUNT,'0')  as INVOICE_AMOUNT
            from
            PROFESSIONAL_SERVICE profess
            left outer join (select entry_type_id,
            line_item_id,
             (case when
            <if test="invoiceAmountCurrent &gt;= 0">
            invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            invoice_amount &lt; 0
            </if>
            then
            nvl(INVOICE_AMOUNT,'0')
            else 0 end) as INVOICE_AMOUNT
            from INVOICE_DETAILS
            where INVOICE_ID IN
            (select invoice_id from INVOICE where CONTRACT_ID =
            #{contractID} and
           
            BUDGET_ID = #{contractBudgetID} and STATUS_ID in
            (70,71,72,73) AND
            INVOICE_DETAIL_ID not in (#{invoiceDetailId})) and
            ENTRY_TYPE_ID = 4
      ) invoicedetail
            on
            invoicedetail.entry_type_id = 4 and invoicedetail.line_item_id =
            profess.PROFESSIONAL_SERVICE_ID
            where profess.PROFESSIONAL_SERVICE_ID =
            #{id} 
    )GROUP BY AMOUNT 
    </select>
 
 
      <select id="fetchRemainingAmnt" parameterType="com.nyc.hhs.model.CBProfessionalServicesBean"
            resultType="BigDecimal">
            SELECT AMOUNT - SUM (INVOICE_AMOUNT) AS remaining_amount FROM (
      select
            nvl(profess.AMOUNT,'0') AS AMOUNT,
            nvl(invoicedetail.INVOICE_AMOUNT,'0')
      as INVOICE_AMOUNT
            from
            PROFESSIONAL_SERVICE profess
            left outer join (select entry_type_id,
            line_item_id,
    (case when
            <if test="invoiceAmountCurrent &gt;= 0">
            invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            invoice_amount &lt; 0
            </if>
            then
            nvl(INVOICE_AMOUNT,'0')
            else 0 end) as INVOICE_AMOUNT
            from INVOICE_DETAILS
            where INVOICE_ID IN
            (select invoice_id from INVOICE where CONTRACT_ID =
            #{contractID} and
            BUDGET_ID = #{contractBudgetID} and STATUS_ID in
            (70,71,72,73)) and
            ENTRY_TYPE_ID = 4
            ) invoicedetail on
            invoicedetail.entry_type_id = 4 and
            invoicedetail.line_item_id =
            profess.PROFESSIONAL_SERVICE_ID
            where
            profess.PROFESSIONAL_SERVICE_ID = #{id}
)GROUP BY AMOUNT
                </select>
 
 
      <resultMap id="MilestoneList" type="com.nyc.hhs.model.CBMileStoneBean">
            <result property="id" column="MILESTONE_ID" />
            <result property="contractBudgetID" column="BUDGET_ID" />
            <result property="subBudgetID" column="SUB_BUDGET_ID" />
            <result property="mileStone" column="MILESTONE" />
            <result property="amount" column="AMOUNT" />
            <result property="invoiceAmount" column="INVOICE_AMOUNT" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="createdDate" column="CREATED_DATE" />
            <result property="createdByUserId" column="CREATED_BY_USERID" />
            <result property="modifiedDate" column="MODIFIED_DATE" />
            <result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
            <result property="remainAmt" column="REMAINING_AMOUNT" />
            <result property="entryTypeId" column="ENTRY_TYPE_ID" />
      </resultMap>
 
 <!-- [Start] R7.3.1 QC8264 -->
      <select id="fetchMilestoneInvoiceDetails" parameterType="com.nyc.hhs.model.CBMileStoneBean"
            resultMap="MilestoneList">
          	<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= #{entryTypeId}
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT  MILESTONE_ID, MILESTONE, sum(REMAINING_AMOUNT) as  REMAINING_AMOUNT,  sum(INVOICE_AMOUNT) as INVOICE_AMOUNT
            FROM    ( SELECT  MS.MILESTONE_ID, MS.MILESTONE, 
                              (MS.AMOUNT - (SUM(CASE WHEN   inv.STATUS_ID IN ('72','73') 
                                                     THEN   idt.INVOICE_AMOUNT
                                                     ELSE   0
                                             END ))
                                ) as  REMAINING_AMOUNT,
                                0 AS INVOICE_AMOUNT
			            FROM MILESTONE MS
			            LEFT JOIN   INVOICE_DETAILS idt
			            ON    idt.LINE_ITEM_ID = MS.MILESTONE_ID
			            AND   idt.ENTRY_TYPE_ID = #{entryTypeId}
			            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  						AND idt.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 						<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
		 
			            LEFT JOIN INVOICE inv
			            ON    inv.INVOICE_ID = idt.INVOICE_ID
			            WHERE   MS.BUDGET_ID = #{contractBudgetID}
			              AND   MS.SUB_BUDGET_ID = #{subBudgetID}
			            GROUP BY  MS.MILESTONE_ID,  MS.MILESTONE, MS.AMOUNT

			            UNION ALL

			            SELECT   MS.MILESTONE_ID,MS.MILESTONE, 0 as REMAINING_AMOUNT, nvl(idt.INVOICE_AMOUNT,'0') AS INVOICE_AMOUNT
			            FROM   MILESTONE MS
			            LEFT JOIN   INVOICE_DETAILS idt 
			            ON   idt.LINE_ITEM_ID =   MS.MILESTONE_ID
			            AND  idt.ENTRY_TYPE_ID = #{entryTypeId} 
			            AND  idt.INVOICE_ID  = #{invoiceId}
			            LEFT JOIN INVOICE inv         
			            ON   inv.INVOICE_ID =  idt.INVOICE_ID
			            WHERE   MS.BUDGET_ID = #{contractBudgetID}
			            AND   MS.SUB_BUDGET_ID = #{subBudgetID}
		            )
            GROUP BY   MILESTONE_ID, MILESTONE
            ORDER BY   MILESTONE_ID DESC
 <!-- [End] R7.3.1 QC8264 -->
      </select>

      <select id="fetchRemainingAmountMilestone" parameterType="com.nyc.hhs.model.CBMileStoneBean"
            resultType="BigDecimal">
            SELECT (MS.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IN
            ('70','71','72','73') and
            <if test="invoiceAmountCurrent &gt;= 0">
            idt.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            idt.invoice_amount &lt; 0
            </if>
            THEN idt.INVOICE_AMOUNT
            ELSE 0
            END ))) as
            REMAINING_AMOUNT
            FROM MILESTONE MS
 
            LEFT JOIN INVOICE_DETAILS idt
            ON
            idt.LINE_ITEM_ID = MS.MILESTONE_ID
            AND
            idt.ENTRY_TYPE_ID =
            #{entryTypeId}
            AND idt.INVOICE_ID != #{invoiceId}
 
            LEFT JOIN INVOICE inv
            ON
            inv.INVOICE_ID = idt.INVOICE_ID
 
            WHERE
            MS.BUDGET_ID =
            #{contractBudgetID}
            AND
            MS.SUB_BUDGET_ID =
            #{subBudgetID}
            AND
            MS.MILESTONE_ID = #{id}
            GROUP BY
            MS.AMOUNT                               
      </select>
 
      <resultMap id="contractInfo" type="com.nyc.hhs.model.ContractList">
            <result property="contractAgencyName" column="AGENCY_NAME" />
            <result property="agencyId" column="AGENCY_ID" />
            <result property="contractTitle" column="PROCUREMENT_TITLE" />
            <result property="provider" column="ORGANIZATION_LEGAL_NAME" />
            <result property="procEpin" column="PROCEPIN" />
            <result property="awardEpin" column="AWRDEPIN" />
            <result property="extCT" column="EXT_CT_NUMBER" />
            <result property="contractStartDate" column="CONTRACT_START_DATE" />
            <result property="contractEndDate" column="CONTRACT_END_DATE" />
            <result property="contractValue" column="CONTRACT_AMOUNT" />
            <result property="programName" column="PROGRAM_NAME" />
            <result property="budgetStatus" column="STATUS" />
            <result property="contractId" column="CONTRACT_ID" />
            <result property="budgetId" column="BUDGET_ID" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="invoiceStatusId" column="STATUS_ID" />
            <result property="providerOrgId" column="ORGANIZATION_ID" />
            <!-- Start :Added in R7 for Cost-Center-->
            <result property="costCenterOpted" column="COST_CENTER_OPTED" />
            <!-- End :Added in R7 for Cost-Center-->
            <!-- Start : R5 Added -->          
            <result property="paymentCount" column="PAYMENT_COUNT" />
            <!-- End : R5 Added -->
            <!-- Start : R6 USES_FTE column checking new budget flow added-->
            <!-- The following attribute is changed from existingBudget to usesFte -->
			<result property="usesFte" column="USES_FTE" />
			<!-- End : R6 Added -->
			 <!-- Start : R6 NO_OF_RETURNED_PAYMENTS column calculate total returned payments of a budget-->
			<result property="noOfReturnedPayments" column="NO_OF_RETURNED_PAYMENTS"></result>
			<result property="returnedPaymentAmount" column="TOTAL_RETURNED_AMOUNT"></result>
			<!-- End : R6 Added -->
			<!-- Fetching IS_OLD_PI flag : Added in R7: Program Income -->
			<result property="oldPIFlag" column="IS_OLD_PI" />
			<!-- End R7: Program Income -->
      </resultMap>
 <!-- Updated fo R6: New Epin validation -->
      <select id="fetchContractInvoiceSummary" parameterType="hashmap"
            resultMap="contractInfo">
            SELECT NYC_AGENCY_DETAILS.AGENCY_NAME,
            (CASE WHEN
            CONTRACT.CONTRACT_TITLE IS NOT NULL
            THEN
            CONTRACT.CONTRACT_TITLE
            ELSE
            CONTRACT.PROCUREMENT_TITLE
            END) AS PROCUREMENT_TITLE,
            CONTRACT.AGENCY_ID,
            ORGANIZATION.ORGANIZATION_ID,
            ORGANIZATION.ORGANIZATION_LEGAL_NAME,
            ( CASE WHEN
            CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE = 'APT_Contract'
            THEN (select
            PROCUREMENT_AWARD_EPIN AS PROC_EPIN
            FROM
            REF_APT_EPIN_MASTER
            where
            REF_APT_EPIN_ID =(select PROCUREMENT_EPIN_ID
            from REF_APT_EPIN_MASTER
            where
            REF_APT_EPIN_ID = (select REF_APT_EPIN_ID
            from CONTRACT where CONTRACT_ID=INVOICE.CONTRACT_ID)))
            ELSE
            PROCUREMENT.EPIN
            END
            ) AS PROCEPIN,
            CONTRACT.EXT_EPIN AS AWRDEPIN,
            NVL(CONTRACT.EXT_CT_NUMBER, 'Not
            Registered') AS EXT_CT_NUMBER,
            CONTRACT.CONTRACT_START_DATE,
            CONTRACT.CONTRACT_END_DATE,
            CONTRACT.CONTRACT_AMOUNT,
            <!--Start:Added in R7 for Cost-Center-->
            CONTRACT.COST_CENTER_OPTED,
            <!--End:Added in R7 for Cost-Center-->
            PROGRAM_MASTER.PROGRAM_NAME,
            STATUS_MASTER_R2_R3.STATUS,
            INVOICE.CONTRACT_ID,
            INVOICE.BUDGET_ID,
            INVOICE.INVOICE_ID,
            STATUS_MASTER_R2_R3.STATUS_ID,
            <!-- Fetching IS_OLD_PI flag : Added in R7: Program Income -->
			(Select NVL(IS_OLD_PI,1) from budget where budget_id = (select budget_id from invoice where invoice_id = #{invoiceId})) IS_OLD_PI,
			<!-- End R7: Program Income -->
            <!-- Start : R5 Added -->
            (SELECT COUNT(1) FROM PAYMENT WHERE INVOICE_ID = #{invoiceId} AND DELETE_FLAG = 0 AND STATUS_ID IN
            <choose>
                        <when test="asOrgType == 'provider_org'">
                              (64,65,109)
                        </when>
                        <otherwise>
                              (109,63,64,65,66)
                        </otherwise>
            </choose>
      ) AS PAYMENT_COUNT
      <!-- End : R5 Added -->
      <!-- Start : R6 USES_FTE column checking new budget flow added-->
      ,	(select USES_FTE from budget where budget_id = (select budget_id from invoice where invoice_id = #{invoiceId})) USES_FTE
      <!-- End : R6 Added -->
        	<!-- Start : R6 Changes to get total approved returned payment amount and count of returned payments for particular budget-->
    ,  (SELECT NVL(SUM(CHECK_AMOUNT),0) FROM RETURN_PAYMENT WHERE BUDGET_ID =(SELECT budget_id FROM invoice WHERE invoice_id = #{invoiceId}) AND status_id IN (187,186)) AS TOTAL_RETURNED_AMOUNT
  	,(SELECT count(RETURN_PAYMENT_ID) FROM RETURN_PAYMENT WHERE BUDGET_ID = (select budget_id from invoice where invoice_id = #{invoiceId})) AS NO_OF_RETURNED_PAYMENTS
  	<!-- End : R6 Changes to get total approved returned payment amount and count of returned payments for particular budget-->
            FROM CONTRACT
            INNER
            JOIN
            CONTRACT_SOURCE_MASTER
            ON CONTRACT.CONTRACT_SOURCE_ID =
            CONTRACT_SOURCE_MASTER.CONTRACT_SOURCE_ID
            LEFT
            JOIN NYC_AGENCY_DETAILS
            ON
            NYC_AGENCY_DETAILS.AGENCY_ID =
            CONTRACT.AGENCY_ID
            LEFT JOIN
            ORGANIZATION ON
            ORGANIZATION.ORGANIZATION_ID
            =CONTRACT.ORGANIZATION_ID
            LEFT JOIN
            PROGRAM_MASTER ON PROGRAM_MASTER.PROGRAM_ID
            =CONTRACT.PROGRAM_ID
            LEFT
            JOIN PROCUREMENT ON
            PROCUREMENT.PROCUREMENT_ID
            =
            CONTRACT.PROCUREMENT_ID
            LEFT JOIN INVOICE
            on INVOICE.CONTRACT_ID =
            CONTRACT.CONTRACT_ID
            LEFT JOIN
            STATUS_MASTER_R2_R3 ON
            STATUS_MASTER_R2_R3.STATUS_ID =
            INVOICE.STATUS_ID
            WHERE
            INVOICE.INVOICE_ID = #{invoiceId}
      </select>
 
 
      <resultMap id="invoicedInfo" type="com.nyc.hhs.model.InvoiceList">
            <result property="invoiceNumber" column="INVOICE_NUMBER" />
            <result property="agency" column="AGENCY_INVOICE_NUMBER" />
            <result property="invoiceProvider" column="PROVIDER_INVOICE_NUMBER" />
            <result property="invoiceStartDate" column="INVOICE_START_DATE" />
            <result property="invoiceEndDate" column="INVOICE_END_DATE" />
            <result property="invoiceDateApproved" column="INVOICE_APPROVED_DATE" />
            <result property="invoiceDateSubmitted" column="INVOICE_SUBMITTED_DATE" />
      </resultMap>
 
      <select id="fetchContractInvoiceInformation" parameterType="hashmap"
            resultMap="invoicedInfo">
            SELECT INVOICE_NUMBER,
            AGENCY_INVOICE_NUMBER,
            PROVIDER_INVOICE_NUMBER,
            TO_CHAR(INVOICE_START_DATE,'MM/DD/YYYY') AS
            INVOICE_START_DATE,
            TO_CHAR(INVOICE_END_DATE,'MM/DD/YYYY') AS
            INVOICE_END_DATE,
            NVL(TO_CHAR(INVOICE_APPROVED_DATE,'MM/DD/YYYY'),'N/A') AS
            INVOICE_APPROVED_DATE,
            NVL(TO_CHAR(INVOICE_SUBMITTED_DATE,'MM/DD/YYYY'),'N/A') AS
            INVOICE_SUBMITTED_DATE
            FROM INVOICE
            WHERE INVOICE_ID = #{invoiceId}
      </select>
 
 
      <resultMap id="invoiceServiceDateInfo" type="com.nyc.hhs.model.InvoiceList">
            <result property="invoiceNumber" column="INVOICE_NUMBER" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="invoiceStartDate" column="INVOICE_START_DATE" />
            <result property="invoiceEndDate" column="INVOICE_END_DATE" />
            <result property="invoiceDateApproved" column="INVOICE_APPROVED_DATE" />
            <result property="invoiceDateSubmitted" column="INVOICE_SUBMITTED_DATE" />
      </resultMap>
 
      <select id="fetchContractInvoiceInfoList" parameterType="hashmap" resultMap="invoiceServiceDateInfo">
            SELECT  INVOICE_ID, INVOICE_NUMBER,
                        TO_CHAR(INVOICE_START_DATE,'MM/DD/YYYY') AS INVOICE_START_DATE,
                        TO_CHAR(INVOICE_END_DATE,'MM/DD/YYYY') AS INVOICE_END_DATE,
                        NVL(TO_CHAR(INVOICE_APPROVED_DATE,'MM/DD/YYYY'),'N/A') AS INVOICE_APPROVED_DATE,
                        NVL(TO_CHAR(INVOICE_SUBMITTED_DATE,'MM/DD/YYYY'),'N/A') AS INVOICE_SUBMITTED_DATE
            FROM    INVOICE
            WHERE   INVOICE_ID IN (${invoiceIds})
      </select>
 
      <update id="updateInvoiceStatus" parameterType="HashMap">
            UPDATE invoice
            SET
            status_id = 72,
            INVOICE_SUBMITTED_DATE = SYSTIMESTAMP
            WHERE
            invoice_id = #{invoiceId}
      </update>
 
      <select id="fetchCurrInvoiceStatus" parameterType="java.lang.String"
            resultType="String">
            SELECT STATUS_ID FROM INVOICE
            WHERE INVOICE_ID =
            #{invoiceId}
      </select>
 
      <resultMap id="IndirectRateList" type="com.nyc.hhs.model.CBIndirectRateBean">
            <result property="id" column="INDIRECT_RATE_ID" />
            <result property="indirectInvoiceAmount" column="CURRENT_INVOICE_AMOUNT" />
            <result property="indirectRemainingAmount" column="remaining_amount" />
      </resultMap>
 
 
      <select id="fetchInvoiceIndirectRate" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="IndirectRateList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= #{entryTypeId}
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT SUM(remaining_amount) AS remaining_amount,
            SUM(CURRENT_INVOICE_AMOUNT) AS CURRENT_INVOICE_AMOUNT,
            indirect_rate_id
            FROM
            (SELECT (a.indirect_amount - SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            ) AS remaining_amount,
            0 AS CURRENT_INVOICE_AMOUNT,
            indirect_rate_id
            FROM indirect_rate a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.indirect_rate_id
            AND inv_det.ENTRY_TYPE_ID =
            #{entryTypeId}
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID IN
            <foreach item="items" index="index" collection="invoiceStatusIdList"
                  open="(" separator="," close=")">
                  #{items}
                  </foreach>
            WHERE a.SUB_BUDGET_ID = #{subBudgetID}
            AND ACTIVE_FLAG = 1
            GROUP BY
            indirect_rate_id,
            indirect_amount
            UNION ALL
            SELECT 0 AS remaining_amount,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS CURRENT_INVOICE_AMOUNT,
            indirect_rate_id
            FROM indirect_rate a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID = a.indirect_rate_id
            AND inv_det.ENTRY_TYPE_ID
            = #{entryTypeId}
            <!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
	        LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID = #{invoiceId}
            WHERE
            a.SUB_BUDGET_ID = #{subBudgetID}
            AND ACTIVE_FLAG = 1
            GROUP BY
            indirect_rate_id
            )
            GROUP BY indirect_rate_id
      </select>
 
      <select id="fetchIndirectRemainingAmount" parameterType="com.nyc.hhs.model.CBIndirectRateBean"
            resultType="BigDecimal">
            SELECT (ir.indirect_AMOUNT - (SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN inv_det.INVOICE_AMOUNT
            ELSE 0
            END ))) AS REMAINING_AMOUNT
            FROM
            indirect_rate ir
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = ir.indirect_rate_ID
            AND inv_det.ENTRY_TYPE_ID =
            #{entryTypeId}
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID IN
            <foreach item="items" index="index" collection="invoiceStatusIdList"
                  open="(" separator="," close=")">
                  #{items}
      </foreach>
            AND inv.INVOICE_ID != #{invoiceId}
            WHERE ir.BUDGET_ID =
            #{contractBudgetID}
            AND ir.SUB_BUDGET_ID = #{subBudgetID}
            AND
            ir.indirect_rate_id = #{id}
            GROUP BY ir.indirect_AMOUNT
      </select>
 
      <resultMap id="SalariedEmployeeList" type="com.nyc.hhs.model.PersonnelServiceBudget">
            <result property="id" column="PERSONNEL_SERVICE_ID" />
            <result property="empPosition" column="POSITION" />
            <result property="unit" column="UNITS" />
            <result property="budgetAmount" column="FY_BUDGET" />
            <result property="invoicedAmount" column="INVOICE_AMOUNT" />
            <result property="remainingAmount" column="REMAINING_AMT" />
      </resultMap>
      <select id="fetchSalariedEmployeeForRemainingAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID=1
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where position_id= ps.position_id) as POSITION,
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT,
            ps.total_salary - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT
            NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMT
            from
            personnel_service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            Personnel_Service_Id = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 1
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
 			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT
            JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.status_id in (72, 73)
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 1
            and ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
      <select id="fetchSalariedEmployeeForInvoicedAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where
            position_id= ps.position_id),
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT
            from
            Personnel_Service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            ps.Personnel_Service_Id = inv.LINE_ITEM_ID
            AND inv.ENTRY_TYPE_ID = 1
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.invoice_id = #{invoiceId}
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 1
            AND ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
      <select id="fetchHourlyEmployeeForRemainingAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID=1
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where position_id= ps.position_id) as POSITION,
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT,
            ps.total_salary - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT
            NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMT
            from
            personnel_service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            Personnel_Service_Id = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 1
           <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
  			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT
            JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.status_id in (72, 73)
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 2
            and ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
      <select id="fetchHourlyEmployeeForInvoicedAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where
            position_id= ps.position_id),
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT
            from
            Personnel_Service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            ps.Personnel_Service_Id = inv.LINE_ITEM_ID
            AND inv.ENTRY_TYPE_ID = 1
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.invoice_id = #{invoiceId}
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 2
            AND ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
      <select id="fetchSeasonalEmployeeForRemainingAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where position_id= ps.position_id) as POSITION,
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT,
            ps.total_salary - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT
            NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMT
            from
            personnel_service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            Personnel_Service_Id = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 1
            LEFT
            JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.status_id in (72, 73)
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 3
            and ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
      <select id="fetchSeasonalEmployeeForInvoicedAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="SalariedEmployeeList">
            SELECT
            ps.Personnel_Service_Id,
            (select position from position
            where
            position_id= ps.position_id),
            ps.units,
            max(ps.CREATED_DATE),
            ps.total_salary AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT
            from
            Personnel_Service ps
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            ps.Personnel_Service_Id = inv.LINE_ITEM_ID
            AND inv.ENTRY_TYPE_ID = 1
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.invoice_id = #{invoiceId}
            WHERE
            ps.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND ps.Personnel_Service_Type_Id = 3
            AND ps.active_flag = 1
            GROUP BY
            ps.Personnel_Service_Id,
            ps.position_id,
            ps.units,
            ps.total_salary,
            ps.CREATED_DATE
            order by ps.CREATED_DATE DESC
      </select>
 
 
      <resultMap id="FringeBenifitsList" type="com.nyc.hhs.model.PersonnelServiceBudget">
            <result property="id" column="FRINGE_BENEFIT_ID" />
            <result property="budgetAmount" column="FY_BUDGET" />
            <result property="invoicedAmount" column="INVOICE_AMOUNT" />
            <result property="remainingAmount" column="REMAINING_AMT" />
      </resultMap>
 
      <select id="fetchFringeForRemainingAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="FringeBenifitsList">
 
 			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 13
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            SELECT
            fb.Fringe_Benefit_Id,
            fb.amount AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END )
            AS
            INVOICE_AMOUNT,
            fb.amount - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMT
            from
            FRINGE_BENEFIT fb
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            fb.FRINGE_BENEFIT_ID =
            inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 13
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND invvv.status_id in (72, 73)
            WHERE
            fb.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
            AND
            fb.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
            and fb.active_flag =
            1
            GROUP BY
            fb.Fringe_Benefit_Id,
            fb.amount
       
        
      </select>
 
      <select id="fetchFringeForInvoicedAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="FringeBenifitsList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 13
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT
            fb.Fringe_Benefit_Id,
            fb.amount AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END )
            AS
            INVOICE_AMOUNT
            from
            FRINGE_BENEFIT fb
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            fb.FRINGE_BENEFIT_ID = inv.LINE_ITEM_ID
            AND inv.ENTRY_TYPE_ID = 13
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  
            LEFT
            JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.invoice_id = #{invoiceId}
            WHERE
            fb.BUDGET_ID =
            #{contractBudgetID,jdbcType=VARCHAR}
            AND fb.SUB_BUDGET_ID =
            #{subBudgetID,jdbcType=VARCHAR}
            AND fb.active_flag = 1
            GROUP BY
            fb.Fringe_Benefit_Id,
            fb.amount
       
      </select>
 
      <select id="fetchPersonnelAmount" parameterType="com.nyc.hhs.model.PersonnelServiceBudget"
            resultType="BigDecimal">
            SELECT
            (ps.TOTAL_SALARY - (SUM(CASE WHEN inv.STATUS_ID IS NOT NULL
            and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN inv_det.INVOICE_AMOUNT ELSE 0 END ))) as REMAINING_AMOUNT
            FROM PERSONNEL_SERVICE ps left outer join INVOICE_DETAILS inv_det
            ON
            ps.PERSONNEL_SERVICE_ID = inv_det.LINE_ITEM_ID
            And inv_det.Entry_Type_Id = 1
        AND inv_det.INVOICE_DETAIL_ID NOT IN(select INVOICE_DETAIL_ID from INVOICE_DETAILS WHERE INVOICE_ID = #{invoiceId} AND LINE_ITEM_ID = #{id} and ENTRY_TYPE_ID = '1')
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND inv.STATUS_ID IN('70','71','72','73')
            WHERE
            ps.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
            AND ps.PERSONNEL_SERVICE_ID =#{id}
            GROUP BY ps.TOTAL_SALARY
      </select>
 
      <select id="fetchPersonnelFringeAmount" parameterType="com.nyc.hhs.model.PersonnelServiceBudget"
            resultType="BigDecimal">
            SELECT
            (ps.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
            NULL
            and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN
            inv_det.INVOICE_AMOUNT
            ELSE 0
            END ))) as REMAINING_AMOUNT
            FROM
            FRINGE_BENEFIT ps left outer join INVOICE_DETAILS inv_det
            ON
            ps.FRINGE_BENEFIT_ID = inv_det.LINE_ITEM_ID
            And inv_det.Entry_Type_Id = 13
            AND inv_det.INVOICE_DETAIL_ID NOT IN(select INVOICE_DETAIL_ID from INVOICE_DETAILS WHERE INVOICE_ID = #{invoiceId} AND LINE_ITEM_ID = #{id} and ENTRY_TYPE_ID = '13')
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND inv.STATUS_ID IN('70','71','72','73')
            WHERE ps.BUDGET_ID = #{contractBudgetID,jdbcType=VARCHAR}
            AND ps.SUB_BUDGET_ID = #{subBudgetID,jdbcType=VARCHAR}
            AND ps.FRINGE_BENEFIT_ID =#{id}
            GROUP BY ps.AMOUNT
      </select>
      <resultMap id="RentInvoicingDetailsList" type="com.nyc.hhs.model.Rent">
            <result property="id" column="RENT_ID" />
            <result property="location" column="LOCATION" />
            <result property="managementCompanyName" column="MANAGEMENT_COMPANY_NAME" />
            <result property="propertyOwner" column="PROPERTY_OWNER" />
            <result property="publicSchoolSpace" column="PUBLIC_SCHOOL_SPACE" />
            <result property="percentChargedToContract" column="PERCENT_CHARGED_TO_CONTRACT" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
            <result property="lineItemInvoiceAmt" column="CURRENT_INVOICE_AMOUNT" />
 
      </resultMap>
 
      <select id="fetchInvoicingRent" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="RentInvoicingDetailsList">
   			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 5
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
 
            SELECT rent_id, Location, MANAGEMENT_COMPANY_NAME,
            Property_owner,
            CASE WHEN PUBLIC_SCHOOL_SPACE = '0' THEN 'No'
            ELSE 'Yes'
            END as PUBLIC_SCHOOL_SPACE, PERCENT_CHARGED_TO_CONTRACT,
            sum(ra) AS
            REMAINING_AMOUNT,
            sum(CURRENT_INVOICE_AMOUNT) as CURRENT_INVOICE_AMOUNT
            FROM
            (
            SELECT rent_id, Location,
            MANAGEMENT_COMPANY_NAME,
            Property_owner,
            PUBLIC_SCHOOL_SPACE, PERCENT_CHARGED_TO_CONTRACT,
            (a.AMOUNT - SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )) as ra,
            0 AS
            CURRENT_INVOICE_AMOUNT
 
            FROM rent a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON inv_det.LINE_ITEM_ID =
            a.rent_id
            AND
            inv_det.ENTRY_TYPE_ID = '5'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv.STATUS_ID in (72,73)
            WHERE a.BUDGET_ID =
            #{contractBudgetID}
            AND a.SUB_BUDGET_ID = #{subBudgetID}
            GROUP BY
            rent_id,inv_det.LINE_ITEM_ID, Location, MANAGEMENT_COMPANY_NAME,
            Property_owner, PUBLIC_SCHOOL_SPACE, PERCENT_CHARGED_TO_CONTRACT,
            a.AMOUNT
 
            union all
 
            SELECT rent_id, Location, MANAGEMENT_COMPANY_NAME,
            Property_owner, PUBLIC_SCHOOL_SPACE, PERCENT_CHARGED_TO_CONTRACT,0 AS
            ra,
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS CURRENT_INVOICE_AMOUNT
 
 
            FROM
            rent a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.rent_id
            AND inv_det.ENTRY_TYPE_ID = '5'
            <!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
  			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            AND
            inv_det.INVOICE_ID
            =#{invoiceId}
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv_det.INVOICE_ID =#{invoiceId}
 
            WHERE a.BUDGET_ID
            = #{contractBudgetID}
            AND a.SUB_BUDGET_ID =#{subBudgetID}
            GROUP BY
            rent_id,
            Location,
            MANAGEMENT_COMPANY_NAME,
            Property_owner,
            PUBLIC_SCHOOL_SPACE,
            PERCENT_CHARGED_TO_CONTRACT,
            a.AMOUNT
            )
            group by
            rent_id,
            Location,
            MANAGEMENT_COMPANY_NAME,
            Property_owner,
            PUBLIC_SCHOOL_SPACE,
            PERCENT_CHARGED_TO_CONTRACT
            order by
            rent_id desc
           
 
     
      </select>
 
      <select id="fetchRentRemainingAmount" parameterType="com.nyc.hhs.model.Rent"
            resultType="BigDecimal">
            SELECT
            (rent.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
            NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN
            inv_det.INVOICE_AMOUNT
            ELSE 0
            END ))) as REMAINING_AMOUNT
 
            FROM
            rent
 
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            rent.rent_id
            AND
            inv_det.ENTRY_TYPE_ID = '5'
 
 
            LEFT JOIN
            INVOICE
            inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID IN
            ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
            WHERE
            rent.rent_id=#{id}
            AND
            rent.BUDGET_ID = #{contractBudgetID}
            AND
            rent.SUB_BUDGET_ID
            =#{subBudgetID}
            GROUP BY
            rent.AMOUNT
           
      </select>
 
      <!-- Rate invoicing, start -->
      <resultMap id="RateBeanList" type="com.nyc.hhs.model.RateBean">
            <result property="id" column="RATE_ID" />
            <result property="unitDesc" column="UNIT_DESCRIPTION" />
            <result property="units" column="NUMBER_OF_UNITS" />
            <result property="invUnits" column="INVOICED_UNITS" />
            <result property="fyBudget" column="FY_BUDGET" />
            <result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
            <result property="remainAmt" column="REMAINING_AMT" />
            <result property="remUnits" column="REMAINING_UNITS" />
      </resultMap>
 
      <select id="fetchInvoiceRateRemainingAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="RateBeanList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 7
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	

            SELECT
            rt.RATE_ID,
            rt.UNIT_DESCRIPTION,
            rt.NUMBER_OF_UNITS,
            max(rt.CREATED_DATE),
            rt.AMOUNT AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT,
            rt.AMOUNT - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMT,
      rt.number_of_units - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(inv.invoiced_units,0)
            ELSE
            0
            END ) AS REMAINING_UNITS
            from
            RATE rt
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            rt.RATE_ID = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 7
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            inv.invoice_id
            AND
            invvv.status_id in (72, 73)
            WHERE
            rt.BUDGET_ID =
            #{contractBudgetID}
            AND
            rt.SUB_BUDGET_ID = #{subBudgetID}
            AND
            rt.active_flag = 1
            GROUP BY
            rt.RATE_ID,
            rt.UNIT_DESCRIPTION,
            rt.NUMBER_OF_UNITS,
            rt.AMOUNT,
            rt.CREATED_DATE
            order by rt.CREATED_DATE desc
      </select>
     
            <select id="fetchInvoiceRateInvoiceAmt" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="RateBeanList">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 7
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			  <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            SELECT
            rt.RATE_ID,
            rt.UNIT_DESCRIPTION,
            rt.NUMBER_OF_UNITS,
      		SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(inv.invoiced_units,0)
            ELSE
            0
            END ) as INVOICED_UNITS,
            max(rt.CREATED_DATE),
            rt.AMOUNT AS FY_BUDGET,
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS
            INVOICE_AMOUNT
            from
            RATE rt
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            rt.RATE_ID =
            inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 7
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id = inv.invoice_id
            AND
            invvv.invoice_id = #{invoiceId}
            WHERE
            rt.BUDGET_ID = #{contractBudgetID}
            AND
            rt.SUB_BUDGET_ID =
            #{subBudgetID}
            AND
            rt.active_flag = 1
            GROUP BY
            rt.RATE_ID,
            rt.UNIT_DESCRIPTION,
            rt.NUMBER_OF_UNITS,
            rt.AMOUNT,
            rt.CREATED_DATE
            order
            by rt.CREATED_DATE desc
            </select>
 
      <!-- Modified this query as part of release 3.8.0 Enhancement 6535-->
      <select id="fetchRateValidationRemAmt" parameterType="com.nyc.hhs.model.RateBean"
            resultType="BigDecimal">
            select
            rt.AMOUNT - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv.invoice_amount &lt; 0
            </if>
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMOUNT
            from
            rate rt
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            rt.RATE_ID = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 7
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            inv.invoice_id
            AND
            invvv.status_id IN ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
            WHERE
            rt.rate_id = #{id}
            and
            RT.BUDGET_ID = #{contractBudgetID}
            AND
            RT.SUB_BUDGET_ID = #{subBudgetID}
            AND
            RT.active_flag = 1
            GROUP BY
            rt.RATE_ID,
            rt.AMOUNT
      </select>
      <!-- Modified this query as part of release 3.8.0 Enhancement 6535-->
     
      <select id="fetchRateValidationRemUnits" parameterType="com.nyc.hhs.model.RateBean"
            resultType="BigDecimal">
            select
            rt.number_of_units - SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL and
            <if test="invoiceUnitsCurrent &gt;= 0">
            inv.invoiced_units &gt; 0
            </if>
            <if test="invoiceUnitsCurrent &lt; 0">
            inv.invoiced_units &lt; 0
            </if>
            THEN
            NVL(inv.invoiced_units,0)
            ELSE
            0
            END ) AS REMAINING_UNITS
            from
            rate rt
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            rt.RATE_ID = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 7
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            inv.invoice_id
            AND
            invvv.status_id IN ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
            WHERE
            rt.rate_id = #{id}
            and
            RT.BUDGET_ID = #{contractBudgetID}
            AND
            RT.SUB_BUDGET_ID = #{subBudgetID}
            AND
            RT.active_flag = 1
            GROUP BY
            rt.RATE_ID,
            rt.number_of_units
      </select>
 
      <!-- Rate invoicing, end -->
 
      <select id="getAgencyIdByContractForWF" parameterType="String"
            resultType="String">
            SELECT
            AGENCY_ID
            FROM CONTRACT WHERE
            CONTRACT_ID=#{asContractId}
      </select>
 
      <select id="fetchInvoiceAmountAssignment" resultType="HashMap">
            SELECT
            sum(TOTAL_INVOICE_AMOUNT) as TOTAL_INVOICE_AMOUNT ,
            sum(ASSIGNMENT_INVOICE_AMOUNT) as ASSIGNMENT_INVOICE_AMOUNT,
            sum(AMOUNT_RECOUPED) as AMOUNT_RECOUPED
            FROM
            (
            SELECT
            SUM(inv_det.INVOICE_AMOUNT) as TOTAL_INVOICE_AMOUNT, 0 AS
            ASSIGNMENT_INVOICE_AMOUNT, 0 AS AMOUNT_RECOUPED
            FROM INVOICE_DETAILS
            inv_det
            inner join
            INVOICE inv on inv.INVOICE_ID = inv_det.INVOICE_ID
            where
            inv_det.INVOICE_ID = #{invoiceId} and inv_det.entry_type_id not
            in ('14', '11')
 
            union all
 
            SELECT
            0 as TOTAL_INVOICE_AMOUNT,
            SUM(inv_det.INVOICE_AMOUNT)
            AS
            ASSIGNMENT_INVOICE_AMOUNT, 0 AS
            AMOUNT_RECOUPED
            FROM INVOICE_DETAILS
            inv_det
            inner join
            INVOICE inv on
            inv.INVOICE_ID = inv_det.INVOICE_ID
            where
            inv_det.INVOICE_ID =
            #{invoiceId} and inv_det.entry_type_id = 14
 
            union all
 
            SELECT
            0 as
            TOTAL_INVOICE_AMOUNT, 0 AS
            ASSIGNMENT_INVOICE_AMOUNT,
            sum(iad.amount_recouped) AS AMOUNT_RECOUPED
            FROM INVOICE_ADVANCE IAD
            inner join
            INVOICE inv on inv.INVOICE_ID =
            IAD.INVOICE_ID
            where
            iAD.INVOICE_ID = #{invoiceId}
            )
      </select>
 
      <select id="fetchContractStatus" resultType="String">
            SELECT con.STATUS_ID
            from CONTRACT con
            INNER JOIN STATUS_MASTER_R2_R3 st
            ON st.STATUS_ID =
            con.STATUS_ID
            WHERE con.CONTRACT_ID = #{contractID}
      </select>
 
      <update id="setStatusForInvoiceReviewTask" parameterType="java.util.Map">
            UPDATE INVOICE
            SET STATUS_ID = #{statusId},
            <if test="statusId != null and statusId =='73'">
                  INVOICE_APPROVED_DATE = current_timestamp,
            </if>
            MODIFIED_BY_USERID =#{modifyBy},
            MODIFIED_DATE = current_timestamp,
            MODIFIED_BY_STAFFID = null
            WHERE
            BUDGET_ID = #{budgetId}
            AND CONTRACT_ID = #{contractId}
            AND INVOICE_ID = #{invoiceId}
      </update>
 
      <!-- QC9710, update InvoiceAdvance modified_date -->
      <update id="UpdateInvoiceAdvanceModifiedDate" parameterType="java.util.Map">
            UPDATE INVOICE_ADVANCE
            SET MODIFIED_DATE = current_timestamp
            WHERE
            BUDGET_ID = #{budgetId}            
            AND INVOICE_ID = #{invoiceId}
      </update>  
      
      <!-- QC9721, update Invoice_details modified_date -->
      <update id="UpdateInvoiceDetailsModifiedDate" parameterType="java.util.Map">
            UPDATE INVOICE_DETAILS
            SET MODIFIED_DATE = current_timestamp
			WHERE        
			INVOICE_ID = #{invoiceId}    
      </update>
 
      <resultMap id="assignmentInfo" type="com.nyc.hhs.model.AssignmentsSummaryBean">
            <result property="id" column="ID" />
            <result property="assignmentName" column="LGL_NM" />
            <result property="ytdAssignmentAmount" column="YTD_ASSIGNMENT_AMOUNT" />
      </resultMap>
      <select id="contractInvAssignmentSummary" resultMap="assignmentInfo"
            parameterType="com.nyc.hhs.model.CBGridBean">
            select  ID, LGL_NM, sum(YTD_ASSIGNMENT_AMOUNT)
            AS YTD_ASSIGNMENT_AMOUNT from (
            SELECT DISTINCT
            ASSIGNMENT.ASSIGNMENT_id AS ID,
            REF_VENDOR_V.LGL_NM,
            NVL(SUM(ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT),'0') AS
            YTD_ASSIGNMENT_AMOUNT
            FROM
            ASSIGNMENT
            INNER JOIN REF_VENDOR_V ON
            REF_VENDOR_V.VEND_CUST_CD =
            ASSIGNMENT.VEND_CUST_CD
            LEFT JOIN
            ADVANCE_ASSIGNMENT ON ADVANCE_ASSIGNMENT.ASSIGNMENT_ID =
            ASSIGNMENT.ASSIGNMENT_id
            LEFT JOIN BUDGET_ADVANCE ON
            BUDGET_ADVANCE.BUDGET_ADVANCE_ID =
            ADVANCE_ASSIGNMENT.BUDGET_ADVANCE_ID
            where Assignment.BUDGET_ID =
            #{contractBudgetID} AND
            BUDGET_ADVANCE.STATUS_ID = '93'
            group by
            ASSIGNMENT.ASSIGNMENT_id,
            REF_VENDOR_V.LGL_NM,
            ADVANCE_ASSIGNMENT.ASSIGNMENT_AMOUNT
 
            UNION ALL
 
            select distinct
            ASSIGNMENT.ASSIGNMENT_id AS ID,
            REF_VENDOR_V.LGL_NM,
            NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),'0') AS YTD_ASSIGNMENT_AMOUNT
            FROM ASSIGNMENT
            INNER JOIN REF_VENDOR_V ON REF_VENDOR_V.VEND_CUST_CD =
            ASSIGNMENT.VEND_CUST_CD
            LEFT JOIN INVOICE ON INVOICE.BUDGET_ID =
            ASSIGNMENT.BUDGET_ID
            LEFT JOIN INVOICE_DETAILS ON
            INVOICE_DETAILS.INVOICE_ID =
            INVOICE.INVOICE_ID
            AND
            INVOICE_DETAILS.LINE_ITEM_ID = ASSIGNMENT.ASSIGNMENT_id AND
            INVOICE_DETAILS.ENTRY_TYPE_ID = '14' AND INVOICE.STATUS_ID = '73'
            where Assignment.BUDGET_ID = #{contractBudgetID}
            group by
            ASSIGNMENT.ASSIGNMENT_id,
            REF_VENDOR_V.LGL_NM
            )
            group by
            ID, LGL_NM order
            by ID desc
           
           
           
      </select>
 
 
      <resultMap id="assignmentDetail" type="com.nyc.hhs.model.AssignmentsSummaryBean">
            <result property="id" column="ID" />
            <result property="invoiceAmount" column="INVOICE_AMOUNT" />
      </resultMap>
      <select id="fetchInvoiceAssignmentDetail" resultMap="assignmentDetail"
            parameterType="com.nyc.hhs.model.CBGridBean">
            select distinct ASSIGNMENT.ASSIGNMENT_id AS ID,
            NVL(INVOICE_DETAILS.INVOICE_AMOUNT,0) as INVOICE_AMOUNT
            FROM Assignment
            LEFT Join INVOICE ON INVOICE.BUDGET_ID = ASSIGNMENT.BUDGET_ID
            INNER
            JOIN INVOICE_DETAILS ON INVOICE_DETAILS.INVOICE_ID =
            INVOICE.INVOICE_ID
            AND INVOICE_DETAILS.LINE_ITEM_ID =
            ASSIGNMENT.ASSIGNMENT_id AND
            INVOICE_DETAILS.ENTRY_TYPE_ID = '14'
            where
            INVOICE.INVOICE_ID = #{invoiceId}
    </select>
 
      <update id="editAssignment" parameterType="com.nyc.hhs.model.AssignmentsSummaryBean">
            UPDATE INVOICE_DETAILS
            SET INVOICE_AMOUNT = #{invoiceAmount}
            WHERE INVOICE_ID = #{invoiceId}
            AND ENTRY_TYPE_ID = '14'
            AND LINE_ITEM_ID = #{id}
      </update>
      <resultMap id="ContractedServices" type="com.nyc.hhs.model.ContractedServicesBean">
            <result property="subHeader" column="CONTRACTED_SERVICE_TYPE" />
            <result property="descOfService" column="SERVICE_DESCRIPTION" />
            <result property="fyBudget" column="AMOUNT" />
            <result property="ytdInvoiceAmt" column="INVOICE_AMOUNT" />
            <result property="csName" column="NAME" />
            <result property="id" column="CONTRACTED_SERVICE_ID" />
            <result property="ytdInvoiceAmt" column="YTD_INVOICE_AMOUNT" />
            <result property="invoiceAmt" column="INVOICE_AMOUNT" />
            <result property="remaingAmt" column="REMAINING_AMOUNT" />
      </resultMap>
      <select id="fetchContractedServicesInvoicingConsultants"
            parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
           <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 6
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			  <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            SELECT
            SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) -
            SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            FROM
            (
            SELECT
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            a.AMOUNT
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = '6'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  				AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  
            INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
            ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in (72,73)
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='1'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            union
            all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            0 AS amount
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.CONTRACTED_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
            = '6'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  				AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON
            b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT JOIN
            INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID = #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='1'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            )group
            by
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            ORDER BY
            CONTRACTED_SERVICE_ID DESC
           
      </select>
 
      <select id="fetchContractedServicesInvoicingSubContractors"
            parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 6
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65)
			  <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            SELECT
            SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) -
            SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            FROM
            (
            SELECT
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            a.AMOUNT
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = '6'
             <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
            ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in (72,73)
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='2'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            union
            all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            0 AS amount
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.CONTRACTED_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
            = '6'
             <!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  			AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON
            b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT JOIN
            INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID = #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='2'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            )group
            by
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            ORDER BY
            CONTRACTED_SERVICE_ID DESC
      </select>
 
      <select id="fetchContractedServicesInvoicingVendors"
            parameterType="com.nyc.hhs.model.CBGridBean" resultMap="ContractedServices">
         
			<!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
			WITH TMP_InvPendingNegAmount AS 
			 (
			 select INVOICE_ID,ENTRY_TYPE_ID,INVOICE_DETAIL_ID, LINE_ITEM_ID, INVOICE_AMOUNT from invoice_details 
			 where INVOICE_ID in 
			 ( select INVOICE_ID from invoice where BUDGET_ID= #{contractBudgetID}
			 and status_id in (72,73) )
			 and INVOICE_AMOUNT  &lt; 0  
			 and ENTRY_TYPE_ID= 6
			 and INVOICE_ID not in 
			 (select distinct INVOICE_ID 
			 from payment 
			 where BUDGET_ID=#{contractBudgetID}
			 and status_id in (64, 65) 
			 <!--Start R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 and INVOICE_ID is not null
			 <!--End R 8.7.0 qc 9568 EXT - QC9501 - Invoices with Advances Not Calcuating Remaining Amount Correctly -->
			 )
			 and INVOICE_ID !=#{invoiceId}
			 )
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->	
            SELECT
            SUM(amount) as FY_BUDGET,
            SUM(INVOICE_AMOUNT) as
            YTD_INVOICED_AMOUNT,
            SUM(CURRENT_INVOICE_AMOUNT) as INVOICE_AMOUNT,
            (SUM(amount) -
            SUM(INVOICE_AMOUNT)) AS REMAINING_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            FROM
            (
            SELECT
            SUM(
            CASE
            WHEN
            inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END )
            AS INVOICE_AMOUNT,
            0 AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            a.AMOUNT
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID = a.CONTRACTED_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = '6'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  				AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  
            INNER JOIN CONTRACTED_SERVICE_TYPE_MASTER b
            ON b.CONTRACTED_SERVICE_TYPE_ID = a.CONTRACTED_SERVICE_TYPE_ID
            LEFT
            JOIN INVOICE inv
            ON inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID in (72,73)
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID =
            #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='3'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            union
            all
            SELECT 0 AS
            INVOICE_AMOUNT,
            SUM(
            CASE
            WHEN inv.STATUS_ID IS NOT NULL
            THEN
            NVL(inv_det.INVOICE_AMOUNT,0)
            ELSE 0
            END ) AS
            CURRENT_INVOICE_AMOUNT,
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION,
            0 AS amount
            FROM
            CONTRACTED_SERVICE a
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            a.CONTRACTED_SERVICE_ID
            AND inv_det.ENTRY_TYPE_ID
            = '6'
            <!-- Start R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  				AND inv_det.INVOICE_DETAIL_ID NOT IN (SELECT INVOICE_DETAIL_ID FROM TMP_InvPendingNegAmount)
 			<!-- End R 8.6.0 QC 9501 Invoice Credit to not be calculated in Remaining Amount until the Payment is Approved -->
  
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER b
            ON
            b.CONTRACTED_SERVICE_TYPE_ID =
            a.CONTRACTED_SERVICE_TYPE_ID
            LEFT JOIN
            INVOICE inv
            ON inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND inv_det.INVOICE_ID
            = #{invoiceId}
            WHERE a.BUDGET_ID = #{contractBudgetID}
            AND
            a.SUB_BUDGET_ID = #{subBudgetID}
            and
            a.CONTRACTED_SERVICE_TYPE_ID='3'
            GROUP BY
            CONTRACTED_SERVICE_ID,
            a.AMOUNT,name,SERVICE_DESCRIPTION
            )group
            by
            CONTRACTED_SERVICE_ID,NAME,SERVICE_DESCRIPTION
            ORDER BY
            CONTRACTED_SERVICE_ID DESC
      </select>
 
      <select id="fetchContractedServicesRemainingAmount"
            parameterType="com.nyc.hhs.model.ContractedServicesBean" resultType="BigDecimal">
            SELECT
            (cs.AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
            NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN
            inv_det.INVOICE_AMOUNT
            ELSE 0
            END ))) as REMAINING_AMOUNT
 
            FROM
            CONTRACTED_SERVICE cs
 
            LEFT JOIN
            INVOICE_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            cs.CONTRACTED_SERVICE_ID
            AND
            inv_det.ENTRY_TYPE_ID = '6'
 
            INNER JOIN
            CONTRACTED_SERVICE_TYPE_MASTER
            cs_mstr
            ON
            cs_mstr.CONTRACTED_SERVICE_TYPE_ID =
            cs.CONTRACTED_SERVICE_TYPE_ID
 
            LEFT JOIN
            INVOICE
            inv
            ON
            inv.INVOICE_ID =
            inv_det.INVOICE_ID
            AND
            inv.STATUS_ID IN
            ('70','71','72','73')
            and
            inv.INVOICE_ID not in (#{invoiceId})
 
            WHERE
            cs.BUDGET_ID =
            #{contractBudgetID}
            AND
            cs.SUB_BUDGET_ID
            =#{subBudgetID}
            AND
            cs.CONTRACTED_SERVICE_ID = #{id}
            GROUP BY
            cs.AMOUNT
            ORDER BY
            cs.CONTRACTED_SERVICE_ID
      </select>
 
      <resultMap id="fyInvBudgetInfo" type="com.nyc.hhs.model.BudgetDetails">
            <result property="startDate" column="BUDGET_START_DATE" />
            <result property="endDate" column="BUDGET_END_DATE" />
            <result property="approvedBudget" column="FISCAL_YEAR_AMOUNT" />
            <result property="ytdInvoicedAmount" column="YTD_INVOICE_AMOUNT" />
      </resultMap>
 
      <select id="fetchInvFyBudgetSummary" parameterType="hashmap"
            resultMap="fyInvBudgetInfo">
            <!-- Start R 8.7.0 qc 9560 EXT - QC9501 - Invoice Budget Summary Not Including Credits after Invoice Submitted -->
            <!-- removed 8.6.0 change -->
            <!--End R 8.7.0 qc 9560 EXT - QC9501 - Invoice Budget Summary Not Including Credits after Invoice Submitted -->
            SELECT Distinct BUDGET.BUDGET_ID,
            BUDGET.BUDGET_START_DATE,
            BUDGET.BUDGET_END_DATE,
            BUDGET.FISCAL_YEAR_AMOUNT,
            nvl((select
            sum(invoice_details.invoice_amount) from invoice_details inner join
            Invoice on invoice_details.invoice_id = Invoice.invoice_id where
            invoice.budget_id=#{budgetId} and invoice_details.entry_type_id not in
            ('11','14') and invoice.STATUS_ID IN (72,73)),'0') AS
            YTD_INVOICE_AMOUNT
            FROM
            BUDGET
            left JOIN INVOICE ON INVOICE.BUDGET_ID =
            BUDGET.BUDGET_ID AND
            INVOICE.STATUS_ID IN (72,73)
            left join
            INVOICE_DETAILS ON
            INVOICE_DETAILS.INVOICE_ID =
            INVOICE.INVOICE_ID AND
            INVOICE_DETAILS.ENTRY_TYPE_ID not in ('11','14')
            WHERE BUDGET.BUDGET_ID
            =
            #{budgetId}
            AND
            BUDGET.CONTRACT_ID = #{contractId}
            <!-- SELECT Distinct BUDGET.BUDGET_ID, BUDGET.BUDGET_START_DATE, BUDGET.BUDGET_END_DATE,
                  BUDGET.FISCAL_YEAR_AMOUNT, nvl((select sum(invoice_amount) from invoice_details
                  where invoice_id=#{invoiceId} and entry_type_id not in ('11','14')),'0')
                  AS INVOICE_AMOUNT FROM BUDGET left JOIN INVOICE ON INVOICE.BUDGET_ID = BUDGET.BUDGET_ID 
                  AND INVOICE.STATUS_ID IN (72,73) left join INVOICE_DETAILS ON INVOICE_DETAILS.INVOICE_ID
                  = INVOICE.INVOICE_ID AND INVOICE_DETAILS.ENTRY_TYPE_ID not in ('11','14')
                  WHERE BUDGET.BUDGET_ID = #{budgetId} AND BUDGET.CONTRACT_ID = #{contractId} -->
      </select>
 
 
      <select id="fetchInvFyBudgetActualPaid" parameterType="java.lang.String"
            resultType="BigDecimal">
            Select NVL(sum(PAYMENT_AMOUNT),0) from Payment where
            BUDGET_ID=
            #{aoBudgetId} AND STATUS_ID='65'
      </select>
 
      <update id="insertAgencyInvoiceNumber" parameterType="map">
            UPDATE
            INVOICE
            SET AGENCY_INVOICE_NUMBER = #{invoiceNumber},
            MODIFIED_BY_USERID =#{userId},
            MODIFIED_BY_STAFFID = null,
            MODIFIED_DATE=current_timestamp
            WHERE
            INVOICE_ID = #{invoiceId}
      </update>
      <resultMap id="fetchVendorList" type="com.nyc.hhs.model.AutoCompleteBean">
            <result property="displayName" column="ORG_NAME" />
            <result property="hiddenId" column="VEND_CUST_CD" />
      </resultMap>
 
      <select id="fetchVendorList" resultMap="fetchVendorList"
            parameterType="java.lang.String">
            SELECT V.LGL_NM || ' - '|| V.VEND_CUST_CD AS ORG_NAME,
            V.VEND_CUST_CD FROM REF_VENDOR_V V where upper(V.LGL_NM) like
            upper(#{aoVendorName})
            ORDER BY V.LGL_NM
      </select>
      <resultMap id="fetchProviderListBean" type="com.nyc.hhs.model.AutoCompleteBean">
            <result property="hiddenId" column="ORGANIZATION_ID" />
            <result property="displayName" column="ORGANIZATION_LEGAL_NAME" />
      </resultMap>
 
      <select id="fetchProviderList" resultMap="fetchProviderListBean"
            parameterType="java.lang.String">
            select ORGANIZATION_LEGAL_NAME,ORGANIZATION_ID
            from ORGANIZATION where ORGANIZATION_LEGAL_NAME is not null AND lower(ORGANIZATION_LEGAL_NAME)
            like lower(#{loProviderName})
      </select>
 
 
      <select id="validateAssignee" parameterType="java.util.HashMap"
            resultType="java.lang.Integer">
            select count(1) from Assignment where VEND_CUST_CD =
            #{lsVendorId} and BUDGET_ID=#{asBudgetId}
                                 
      </select>
 
 
 
      <insert id="addAssignment" parameterType="java.util.HashMap">
 
            INSERT
            INTO ASSIGNMENT
            (
            ASSIGNMENT_ID,
            BUDGET_ID,
            VENDOR_TYPE_ID,
            SELECTED_FLAG,
            AMOUNT,
            CREATED_DATE,
            CREATED_BY_USERID,
            MODIFIED_DATE,
            MODIFIED_BY_USERID,
            VEND_CUST_CD,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID
            )
            VALUES
            (
            SEQ_ASSIGNMENT_ID.nextval,
            #{asBudgetId},
            '1',
            '1',
            '0',
            SYSTIMESTAMP,
            #{modifyByAgency},
            SYSTIMESTAMP,
            #{modifyByAgency},
            #{lsVendorId},
            #{modifyByProvider},
            #{modifyByProvider}
            )
      </insert>
      <resultMap id="budgetList" type="com.nyc.hhs.model.BudgetList">
            <result property="budgetType" column="BUDGET_TYPE_ID" />
            <result property="budgetId" column="BUDGET_ID" />
      </resultMap>
      <select id="fetchBudgetStatus" parameterType="java.util.HashMap"
            resultMap="budgetList">
            select BUDGET_ID,BUDGET_TYPE_ID from budget
            where
            parent_id=#{budgetId}
            and
            budget_id!=parent_id
            and
            BUDGET_TYPE_ID NOT IN
            ('1','5')
            and active_flag=1
      </select>
 
      <select id="fetchBudgetAmount" parameterType="java.util.HashMap"
            resultType="java.lang.Integer">
            select
            CONTRACT_AMOUNT from contract
            where
            PARENT_CONTRACT_ID=#{contractId}
            and
            CONTRACT_TYPE_ID='2'
            and
            STATUS_ID NOT IN ('62','67','68','69')
      </select>
 
      <select id="fetchDiscFlagAmount" parameterType="java.util.HashMap"
            resultType="java.lang.String">
            select DISCREPANCY_FLAG from Contract where
            CONTRACT_ID=#{contractId}
      </select>
 
      <select id="fetchInvoiceSeqNo" resultType="java.lang.Integer">
            SELECT SUM(Count)
            from
            (
            SELECT count(1) AS Count
            FROM BUDGET_ADVANCE
            WHERE
            EXTRACT(MONTH FROM
            REQUEST_DATE) = EXTRACT(MONTH FROM
            SYSDATE)
            and
            EXTRACT(YEAR FROM
            REQUEST_DATE)=EXTRACT(YEAR FROM SYSDATE)
 
            UNION ALL
 
            SELECT count(1) AS
            Count
            FROM INVOICE
            WHERE
            EXTRACT(MONTH FROM CREATED_DATE) = EXTRACT(MONTH
            FROM
            SYSDATE)
            and
            EXTRACT(YEAR FROM CREATED_DATE)=EXTRACT(YEAR FROM
            SYSDATE)
            )
 
      </select>
 
      <select id="fetchBudgetInvoiceSeqNo" resultType="java.lang.Integer">
            SELECT
            SUM(Count)
            from
            (
            select count(1) AS Count from budget_advance where
            budget_advance_number =#{lsNumber}
 
            UNION ALL
 
            select count(1) AS Count from invoice where INVOICE_NUMBER =
            #{lsNumber}
            )
 
      </select>
      <insert id="fetchContractInvoiceSeqNo" parameterType="java.util.HashMap">
 
            INSERT INTO INVOICE
            (
            INVOICE_ID,
            INVOICE_NUMBER,
            CONTRACT_ID,
            BUDGET_ID,
            AGENCY_ID,
            ORGANIZATION_ID,
            PROGRAM_ID,
            CT_NUMBER,
            PROVIDER_INVOICE_NUMBER,
            AGENCY_INVOICE_NUMBER,
            FISCAL_YEAR_ID,
      <!-- INVOICE_AMOUNT, -->
            INVOICE_SUBMITTED_DATE,
            INVOICE_APPROVED_DATE,
            LAST_UPDATE_DATE,
            STATUS_ID,
            PREV_STATUS_ID,
            DELETE_FLAG,
            CREATED_DATE,
            MODIFIED_DATE,
            CREATED_BY_STAFFID,
            MODIFIED_BY_STAFFID
            )
            VALUES
            (
            SEQ_INVOICE_ID.nextval,
            #{lsNumber},
            #{contractId},
            #{budgetId},
            #{agencyId},
            #{asOrgId},
            #{programId},
            null,
            null,
            null,
            #{fiscalYearID},
            <!-- 0,-->
            null,
            null,
            SYSTIMESTAMP,
            '70',
            '70',
            0,
            SYSTIMESTAMP,
            SYSTIMESTAMP,
            #{userId},
            #{userId}
 
            )
            <selectKey keyProperty="aiCurrentSeq" resultType="java.lang.String">
                  select
                  SEQ_INVOICE_ID.currval from Dual
            </selectKey>
 
      </insert>
 
      <update id="updateInvoiceDetails" parameterType="map">
            update INVOICE
            SET PROVIDER_INVOICE_NUMBER = #{provider},
            INVOICE_START_DATE =
            to_date(#{invoiceStartDate,jdbcType=VARCHAR},'MM/dd/YYYY'),
            INVOICE_END_DATE =
            to_date(#{invoiceEndDate,jdbcType=VARCHAR},'MM/dd/YYYY'),
            MODIFIED_BY_STAFFID =#{userId},
            MODIFIED_DATE=current_timestamp
            where
            INVOICE_ID = #{invoiceId}
      </update>
 
      <delete id="delAssignment" parameterType="com.nyc.hhs.model.AssignmentsSummaryBean">
            DELETE FROM
            assignment
            WHERE assignment_id = #{id}
     </delete>
 
      <select id="fetchCountInvoiceDetails" parameterType="java.util.HashMap"
            resultType="java.lang.Integer">
            SELECT count(*)
            FROM INVOICE_DETAILS
            INNER JOIN INVOICE ON
            INVOICE.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
            WHERE
            INVOICE_DETAILS.ENTRY_TYPE_ID = #{ENTRY_TYPE_ID}
            AND
            INVOICE_DETAILS.LINE_ITEM_ID = #{LINE_ITEM_ID}
            AND INVOICE.STATUS_ID =
            #{STATUS_ID}
     </select>
 
      <delete id="delInvoiceDetails" parameterType="java.util.HashMap">
            DELETE FROM
            INVOICE_DETAILS
            WHERE LINE_ITEM_ID = #{LINE_ITEM_ID}
            AND ENTRY_TYPE_ID =
            #{ENTRY_TYPE_ID}
     </delete>
      <resultMap id="invoiceAdvanceList" type="com.nyc.hhs.model.AdvanceSummaryBean">
            <result property="id" column="BUDGET_ADVANCE_ID" />
            <result property="invoiceAdvanceId" column="INVOICE_ADVANCE_ID" />
            <result property="invoiceId" column="INVOICE_ID" />
            <result property="invoiceRecoupedAmt" column="AMOUNT_RECOUPED" />
 
      </resultMap>
      <select id="fetchInvoiceAdvancesDetails" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="invoiceAdvanceList">
            SELECT INVOICE_ADVANCE_ID,
            INVOICE_ID,
            BUDGET_ADVANCE_ID,
            AMOUNT_RECOUPED
            FROM INVOICE_ADVANCE where INVOICE_ID=#{invoiceId}
      </select>
 
      <select id="validateBudgetAdvanceStatus" parameterType="java.lang.String"
            resultType="java.lang.Integer">
            select count(1) from BUDGET_ADVANCE where
            BUDGET_ADVANCE_ID=#{aoBudgetAdvanceId} AND STATUS_ID='125'
 </select>
 
     
            <select id="validateInvAdvanceRecoupAmount" parameterType="java.lang.String"
            resultType="HashMap">
            select sum(ADVANCE_AMOUNT) as ADVANCE_AMOUNT,sum(TOTAL_RECOUPED_AMOUNT) AS TOTAL_RECOUPED_AMOUNT,
                sum(TOTAL_RECOUPED_REVIEW) as TOTAL_RECOUPED_REVIEW
            FROM (
            SELECT 0 as ADVANCE_AMOUNT,
            NVL(SUM(IAD.AMOUNT_RECOUPED),0) AS TOTAL_RECOUPED_AMOUNT, 0 as TOTAL_RECOUPED_REVIEW
            FROM
            BUDGET_ADVANCE BA
            left JOIN INVOICE_ADVANCE IAD ON
            BA.BUDGET_ADVANCE_ID = IAD.BUDGET_ADVANCE_ID
            LEFT join Invoice inv on
            iad.invoice_id = inv.invoice_id 
            WHERE ba.BUDGET_ADVANCE_ID
            = #{aoBudgetAdvanceId} and inv.status_id in (73) group by BA.AMOUNT
    
    UNION ALL
   
    SELECT (BA.AMOUNT) as ADVANCE_AMOUNT,
            0 AS TOTAL_RECOUPED_AMOUNT, NVL(SUM(IAD.AMOUNT_RECOUPED),0) as TOTAL_RECOUPED_REVIEW
            FROM
            BUDGET_ADVANCE BA
            left JOIN INVOICE_ADVANCE IAD ON
            BA.BUDGET_ADVANCE_ID = IAD.BUDGET_ADVANCE_ID
            LEFT join Invoice inv on
            iad.invoice_id = inv.invoice_id
            <!--Start Rel 6.2.0 QC 8663 -->
		     and inv.status_id!=74
		     <!--End Rel 6.2.0 QC 8663 -->
            WHERE ba.BUDGET_ADVANCE_ID
            = #{aoBudgetAdvanceId}
            group by BA.AMOUNT
   
    )
 
           
</select>
 
 
      <select id="fetchInvoiceRecoupAmount" parameterType="com.nyc.hhs.model.AdvanceSummaryBean"
            resultType="java.lang.String">
            select NVL(SUM(AMOUNT_RECOUPED),0) AS AMOUNT_RECOUPED from
            invoice_advance
            where
            invoice_id=#{invoiceId} and BUDGET_ADVANCE_ID = #{id}
            </select>
 
 
 
 
      <update id="editInvoiceAdvanceRecouped" parameterType="com.nyc.hhs.model.AdvanceSummaryBean">
            UPDATE
            INVOICE_ADVANCE
            SET AMOUNT_RECOUPED = #{invoiceRecoupedAmt},
            modified_date=CURRENT_TIMESTAMP, MODIFIED_BY_USERID =
            #{modifyByProvider}
            WHERE
            BUDGET_ADVANCE_ID = #{id} AND
            INVOICE_ID =
            #{invoiceId}
      </update>
 
      <insert id="insertInvoiceAdvanceRecouped" parameterType="com.nyc.hhs.model.AdvanceSummaryBean">
            INSERT
            INTO INVOICE_ADVANCE
            (
            INVOICE_ADVANCE_ID,
            INVOICE_ID,
            BUDGET_ADVANCE_ID,
            AMOUNT_RECOUPED,
            CREATED_BY_USERID,
            MODIFIED_BY_USERID,
            modified_date,
            CREATED_DATE,
            BUDGET_ID
            )
            VALUES
            (
            SEQ_INVOICE_ID.nextval,
            #{invoiceId},
            #{id},
            #{invoiceRecoupedAmt},
            #{modifyByProvider},
            #{modifyByProvider},
            SYSTIMESTAMP,
            SYSTIMESTAMP,
            #{contractBudgetID}
            )
      </insert>
 
      <select id="invoiceNegativeAmendCheck" parameterType="java.lang.String"
            resultType="java.lang.Integer">
            SELECT COUNT(1)
            FROM   CONTRACT CON,
            BUDGET BUD
            WHERE  CON.CONTRACT_ID        = BUD.CONTRACT_ID
            AND    BUD.PARENT_ID          = #{asBudgetId}
            AND    BUD.BUDGET_TYPE_ID     ='1'
            AND    BUD.STATUS_ID          ='82'
            AND    CON.CONTRACT_AMOUNT &lt; 0
      </select>
 
      <select id="invoiceTotal" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS TOTAL_INVOICE FROM
            INVOICE_DETAILS WHERE INVOICE_ID = #{asInvoiceId} AND ENTRY_TYPE_ID
            NOT IN ('11','14')
      </select>
 
      <select id="assignmentAmount" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS ASSIGNMENT FROM
            INVOICE_DETAILS WHERE INVOICE_ID = #{asInvoiceId} AND ENTRY_TYPE_ID =
            '14'
      </select>
      <select id="assignmentAmountExceptCurrentLineItem" parameterType="com.nyc.hhs.model.AssignmentsSummaryBean"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS ASSIGNMENT FROM
            INVOICE_DETAILS WHERE INVOICE_ID = #{invoiceId} AND ENTRY_TYPE_ID =
            '14' AND LINE_ITEM_ID not in #{id}
      </select>
     
            <resultMap id="totalForPersonnelServices" type="com.nyc.hhs.model.PersonnelServicesData">
            <result property="totalSalaryAmount" column="salaryTotal" />
            <result property="totalFringeAmount" column="fringeTotal" />
            <!-- Start : R6 total positions column for invoice flow-->
             <result property="totalPositions" column="totalPositions" />
             <!-- End : R6 ends-->
      </resultMap>
       <!-- Start : R6 Query updated to fetch total positions-->
		<select id="fetchInvoiceTotalForPersonnelServices"
			parameterType="com.nyc.hhs.model.CBGridBean" resultMap="totalForPersonnelServices">
			select sum(salaryTotal) as salaryTotal, sum(fringeTotal) as
			fringeTotal,sum(totalPositions) as totalPositions from (
			select sum(invoice_amount) as salaryTotal, 0 as fringeTotal, 0
			totalPositions from INVOICE_DETAILS where invoice_id=#{invoiceId} and
			sub_budget_id= #{subBudgetID} and entry_type_id='1'
			union all
			select 0 as salaryTotal, sum(invoice_amount) as fringeTotal, 0
			totalPositions from INVOICE_DETAILS where invoice_id=#{invoiceId} and
			sub_budget_id= #{subBudgetID} and entry_type_id='13'
			union all
			select 0 as salaryTotal, 0 as fringeTotal, sum(units) totalPositions from
			personnel_service where sub_budget_id = #{subBudgetID}
			)
		</select>
		<!-- End : R6 ends-->
 
      <select id="fetchYTDTotalSalaryAndFringe" parameterType="java.lang.String" resultType="java.lang.String">
      SELECT NVL(SUM(INVOICE_DETAILS.INVOICE_AMOUNT),0)
            FROM
            INVOICE_DETAILS
            INNER
            JOIN INVOICE
            ON INVOICE.INVOICE_ID = INVOICE_DETAILS.INVOICE_ID
            WHERE
            INVOICE_DETAILS.SUB_BUDGET_ID = #{aoBudgetId}
            AND INVOICE_DETAILS.ENTRY_TYPE_ID in ('13','1')
            AND INVOICE.STATUS_ID in ('72','73')     
      </select>
     
      <update id="updatePersonalServiceYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO PERSONNEL_SERVICE A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              PERSONNEL_SERVICE_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                ps.TOTAL_SALARY               AS FYBudget,
                ps.PERSONNEL_SERVICE_id
              FROM PERSONNEL_SERVICE ps,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id         = #{aoBaseBudgetId}
              AND ps.PERSONNEL_SERVICE_id = ind.line_item_id
              AND ind.entry_type_id       = '1'
              AND inv.invoice_id          = ind.invoice_id
              AND inv.status_id          IN (72,73)
              GROUP BY ps.PERSONNEL_SERVICE_id,
                ps.TOTAL_SALARY
              )
            ) B ON (A.PERSONNEL_SERVICE_id = B.PERSONNEL_SERVICE_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateContractedServiceYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO contracted_service A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              contracted_service_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                cs.amount                     AS FYBudget,
                cs.contracted_service_id
              FROM contracted_service cs,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id          = #{aoBaseBudgetId}
              AND cs.contracted_service_id = ind.line_item_id
              AND ind.entry_type_id        = '6'
              AND inv.invoice_id           = ind.invoice_id
              AND inv.status_id           IN (72,73)
              GROUP BY cs.contracted_service_id,
                cs.amount
              )
            )B ON (A.contracted_service_id = B.contracted_service_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
 
      </update>
 
      <update id="updateEquipmentYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO EQUIPMENT A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              EQUIPMENT_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                eqp.amount                    AS FYBudget,
                eqp.EQUIPMENT_id
              FROM EQUIPMENT eqp,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id   = #{aoBaseBudgetId}
              AND eqp.EQUIPMENT_id  = ind.line_item_id
              AND ind.entry_type_id = '12'
              AND inv.invoice_id    = ind.invoice_id
              AND inv.status_id    IN (72,73)
              GROUP BY eqp.EQUIPMENT_id,
                eqp.amount
              )
            ) B ON (A.EQUIPMENT_id = B.EQUIPMENT_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
 
      <update id="updateFringesYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO FRINGE_BENEFIT A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              FRINGE_BENEFIT_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                fb.amount                     AS FYBudget,
                fb.FRINGE_BENEFIT_id
              FROM FRINGE_BENEFIT fb,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id      = #{aoBaseBudgetId}
              AND fb.FRINGE_BENEFIT_id = ind.line_item_id
              AND ind.entry_type_id    = '13'
              AND inv.invoice_id       = ind.invoice_id
              AND inv.status_id       IN (72,73)
              GROUP BY fb.FRINGE_BENEFIT_id,
                fb.amount
              )
            )B ON (A.FRINGE_BENEFIT_id = B.FRINGE_BENEFIT_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateIndirectRateYtdAndRemainingAmount" parameterType="java.lang.String">
      Merge INTO INDIRECT_RATE A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              INDIRECT_RATE_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                ir.indirect_amount            AS FYBudget,
                ir.INDIRECT_RATE_id
              FROM INDIRECT_RATE ir,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id     = #{aoBaseBudgetId}
              AND ir.INDIRECT_RATE_id = ind.line_item_id
              AND ind.entry_type_id   = '10'
              AND inv.invoice_id      = ind.invoice_id
              AND inv.status_id      IN (72,73)
              GROUP BY ir.INDIRECT_RATE_id,
                ir.indirect_amount
              )
            ) B ON (A.INDIRECT_RATE_id = B.INDIRECT_RATE_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateMilestoneYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO MILESTONE A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              MILESTONE_id
            FROM
            (SELECT SUM(ind.invoice_amount)            AS YTD_INVOICED_AMOUNT,
              ms.amount                     AS FYBudget,
              ms.MILESTONE_id
            FROM MILESTONE ms,
              invoice_details ind,
              invoice inv
            WHERE inv.budget_id   = #{aoBaseBudgetId}
            AND ms.MILESTONE_id   = ind.line_item_id
            AND ind.entry_type_id = '8'
            AND inv.invoice_id    = ind.invoice_id
            AND inv.status_id    IN (72,73)
            GROUP BY ms.MILESTONE_id,ms.amount
            )) B ON (A.MILESTONE_id = B.MILESTONE_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
     
      <update id="updateOperationAndSupportYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO OPERATIONS_AND_SUPPORT A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              OPERATIONS_SUPPORT_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                os.amount                     AS FYBudget,
                os.OPERATIONS_SUPPORT_id
              FROM OPERATIONS_AND_SUPPORT os,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id          = #{aoBaseBudgetId}
              AND os.OPERATIONS_SUPPORT_id = ind.line_item_id
              AND ind.entry_type_id        = '2'
              AND inv.invoice_id           = ind.invoice_id
              AND inv.status_id           IN (72,73)
              GROUP BY os.OPERATIONS_SUPPORT_id,
                os.amount
              )
            ) B ON (A.OPERATIONS_SUPPORT_id = B.OPERATIONS_SUPPORT_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
                REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateProfessionalServicesYtdAndRemainingAmount" parameterType="java.lang.String">
                  Merge INTO PROFESSIONAL_SERVICE A USING
                  (SELECT YTD_INVOICED_AMOUNT,
                    (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
                    PROFESSIONAL_SERVICE_id
                  FROM
                    (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                      ps.amount                     AS FYBudget,
                      ps.PROFESSIONAL_SERVICE_id
                    FROM PROFESSIONAL_SERVICE ps,
                      invoice_details ind,
                      invoice inv
                    WHERE inv.budget_id            = #{aoBaseBudgetId}
                    AND ps.PROFESSIONAL_SERVICE_id = ind.line_item_id
                    AND ind.entry_type_id          = '4'
                    AND inv.invoice_id             = ind.invoice_id
                    AND inv.status_id             IN (72,73)
                    GROUP BY ps.PROFESSIONAL_SERVICE_id,
                      ps.amount
                    )
                  ) B ON (A.PROFESSIONAL_SERVICE_id = B.PROFESSIONAL_SERVICE_id)
                  WHEN matched THEN
                    UPDATE
                    SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
                  REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateProgramIncomeYtdAndRemainingAmount" parameterType="java.lang.String">
                  Merge INTO PROGRAM_INCOME A USING
                  (SELECT YTD_INVOICED_AMOUNT,
                    (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
                    PROGRAM_INCOME_id
                  FROM
                    (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                      pi.amount                     AS FYBudget,
                      pi.PROGRAM_INCOME_id
                    FROM PROGRAM_INCOME pi,
                      invoice_details ind,
                      invoice inv
                    WHERE inv.budget_id      = #{aoBaseBudgetId}
                    AND pi.PROGRAM_INCOME_id = ind.line_item_id
                    AND ind.entry_type_id    = '11'
                    AND inv.invoice_id       = ind.invoice_id
                    AND inv.status_id       IN (72,73)
                    GROUP BY pi.PROGRAM_INCOME_id,
                      pi.amount
                    )
                  ) B ON (A.PROGRAM_INCOME_id = B.PROGRAM_INCOME_id)
                  WHEN matched THEN
                    UPDATE
                    SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
                  REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
 
      <update id="updateRateYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO RATE A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              RATE_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                rt.amount                     AS FYBudget,
                rt.RATE_id
              FROM RATE rt,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id   = #{aoBaseBudgetId}
              AND rt.RATE_id        = ind.line_item_id
              AND ind.entry_type_id = '7'
              AND inv.invoice_id    = ind.invoice_id
              AND inv.status_id    IN (72,73)
              GROUP BY rt.RATE_id,
                rt.amount
              )
            ) B ON (A.RATE_id = B.RATE_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateRentYtdAndRemainingAmount" parameterType="java.lang.String">
                  Merge INTO RENT A USING
                  (SELECT YTD_INVOICED_AMOUNT,
                    (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
                    RENT_id
                  FROM
                    (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                      rnt.amount                    AS FYBudget,
                      rnt.RENT_id
                    FROM RENT rnt,
                      invoice_details ind,
                      invoice inv
                    WHERE inv.budget_id   = #{aoBaseBudgetId}
                    AND rnt.RENT_id       = ind.line_item_id
                    AND ind.entry_type_id = '5'
                    AND inv.invoice_id    = ind.invoice_id
                    AND inv.status_id    IN (72,73)
                    GROUP BY rnt.RENT_id,
                      rnt.amount
                    )
                  ) B ON (A.RENT_id = B.RENT_id)
                  WHEN matched THEN
                    UPDATE
                    SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
                  REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
      <update id="updateUtilitiesYtdAndRemainingAmount" parameterType="java.lang.String">
            Merge INTO UTILITIES A USING
            (SELECT YTD_INVOICED_AMOUNT,
              (FYBudget - YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              UTILITIES_id
            FROM
              (SELECT SUM(ind.invoice_amount) AS YTD_INVOICED_AMOUNT,
                ut.amount                     AS FYBudget,
                ut.UTILITIES_id
              FROM UTILITIES ut,
                invoice_details ind,
                invoice inv
              WHERE inv.budget_id   = #{aoBaseBudgetId}
              AND ut.UTILITIES_id   = ind.line_item_id
              AND ind.entry_type_id = '3'
              AND inv.invoice_id    = ind.invoice_id
              AND inv.status_id    IN (72,73)
              GROUP BY ut.UTILITIES_id,
                ut.amount
              )
            ) B ON (A.UTILITIES_id = B.UTILITIES_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
      </update>
     
     
     
      <update id="updateLineItemsYTDAndRemainingForAgencyInterface" parameterType="java.util.HashMap">
            Merge INTO ${TABLE} A USING
                  (
                SELECT SUM(YTD_INVOICED_AMOUNT) AS YTD_INVOICED_AMOUNT,
                    SUM(${AMOUNT})                   AS FYBudget,
                    SUM(${AMOUNT}) - SUM(YTD_INVOICED_AMOUNT)  AS REMAINING_AMOUNT,
                    ${id}
                  FROM
                    (SELECT ${id},
                      0 AS YTD_INVOICED_AMOUNT,
                      ${AMOUNT}
                    FROM ${TABLE}
                    WHERE budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
                    UNION ALL
                    SELECT line_item_id               AS ${id},
                      NVL(SUM(ind.invoice_amount), 0) AS YTD_INVOICED_AMOUNT,
                      0                               AS ${AMOUNT}
                    FROM invoice_details ind,
                      invoice inv
                    WHERE inv.budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
                    AND inv.invoice_id  = ind.invoice_id
                    AND inv.status_id  IN (72,73)
                    AND entry_type_id   = #{ENTRY_TYPE_ID}
                    GROUP BY line_item_id
                    )
                  GROUP BY ${id}
                        ) B ON (A.${id} = B.${id})
                  WHEN matched THEN
                  UPDATE
                  SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
                   REMAINING_AMOUNT      = B.REMAINING_AMOUNT
                    <!-- changes for agency outbound interafce 6644-->,MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR}
                  ,MODIFIED_DATE=systimestamp
      </update>
     
     
      <update id="updateLineItemsYTDAndRemainingUnitsForRate" parameterType="java.util.HashMap">
      Merge INTO rate A USING
                  (
                SELECT SUM(YTD_INVOICED_UNITS) AS YTD_INVOICED_UNITS,
                    SUM(NUMBER_OF_UNITS)                   AS FYUnits,
                    SUM(NUMBER_OF_UNITS) - SUM(YTD_INVOICED_UNITS)  AS REMAINING_UNITS,
                    rate_id
                  FROM
                    (SELECT rate_id,
                      0 AS YTD_INVOICED_UNITS,
                      NUMBER_OF_UNITS
                    FROM rate
                    WHERE budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
                    UNION ALL
                    SELECT line_item_id               AS rate_id,
                      NVL(SUM(ind.INVOICED_UNITS), 0) AS YTD_INVOICED_UNITS,
                      0                               AS NUMBER_OF_UNITS
                    FROM invoice_details ind,
                      invoice inv
                    WHERE inv.budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
                    AND inv.invoice_id  = ind.invoice_id
                    AND inv.status_id  IN (72,73)
                    AND entry_type_id   = <!-- changes for agency outbound interafce 6647--> 7
                    GROUP BY line_item_id
                    )
                  GROUP BY rate_id
                        ) B ON (A.rate_id = B.rate_id)
                  WHEN matched THEN
                  UPDATE
                  SET YTD_INVOICED_UNITS = B.YTD_INVOICED_UNITS,
                   REMAINING_UNITS      = B.REMAINING_UNITS
                   <!-- changes for agency outbound interafce 6644-->,MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR}
                  ,MODIFIED_DATE=systimestamp
      </update>
     
      <update id="updateSubBudgetsYTDAndRemainingForAgencyInterface" parameterType="java.util.HashMap">
            Merge INTO sub_budget A USING
            (SELECT SUM (YTD_INVOICED_AMOUNT)      AS YTD_INVOICED_AMOUNT,
              FYBudget - SUM (YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              sub_budget_id
            FROM
              (SELECT (
                CASE
                  WHEN inv.status_id IN (72,73)
                  THEN SUM(IND.invoice_amount)
                  ELSE 0
                END)              AS YTD_INVOICED_AMOUNT,
                SUB_BUDGET_AMOUNT AS FYBudget,
                tb.sub_budget_id
              FROM sub_budget tb,
                invoice_details ind,
                invoice inv
              WHERE tb.budget_id    = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
              AND tb.sub_budget_id  = ind.sub_budget_id(+)
              AND inv.invoice_id (+)= IND.invoice_id
              AND ind.entry_type_id != 11
              GROUP BY SUB_BUDGET_AMOUNT,
                tb.sub_budget_id,
                inv.status_id
              )
            GROUP BY FYBudget,
              sub_budget_id
            )B ON (A.sub_budget_id = B.sub_budget_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
              REMAINING_AMOUNT      = B.REMAINING_AMOUNT
               <!-- changes for agency outbound interafce 6644-->,MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR}
                  ,MODIFIED_DATE=systimestamp
  </update>
     
      <update id="updateBudgetsYTDAndRemainingForAgencyInterface" parameterType="java.util.HashMap">
            Merge INTO budget A USING
            (
            SELECT SUM (YTD_INVOICED_AMOUNT)       AS YTD_INVOICED_AMOUNT,
              FYBudget - SUM (YTD_INVOICED_AMOUNT) AS REMAINING_AMOUNT,
              budget_id
            FROM
              (SELECT (
                CASE
                  WHEN inv.status_id IN (72,73)
                  THEN SUM(IND.invoice_amount)
                  ELSE 0
                END)               AS YTD_INVOICED_AMOUNT,
                FISCAL_YEAR_AMOUNT AS FYBudget,
                tb.budget_id
              FROM budget tb,
                invoice_details ind,
                invoice inv,
                sub_budget sb
              WHERE sb.budget_id    = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
              AND sb.budget_id      = tb.budget_id
              AND sb.sub_budget_id  = ind.sub_budget_id(+)
              AND inv.invoice_id (+)= IND.invoice_id
              AND ind.entry_type_id != 11
              GROUP BY FISCAL_YEAR_AMOUNT,
                tb.budget_id,
                inv.status_id
              )
            GROUP BY FYBudget,
              budget_id
                        ) B ON (A.budget_id = B.budget_id)
            WHEN matched THEN
              UPDATE
              SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
            REMAINING_AMOUNT      = B.REMAINING_AMOUNT
             <!-- changes for agency outbound interafce 6644-->,MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR}
                  ,MODIFIED_DATE=systimestamp
      </update>
     
      <select id="fetchApproveInvoiceFromETL"   resultType="java.util.HashMap">
            SELECT      CT_NUMBER,
                        INVOICE_ID,
                       CONTRACT_ID,
                        BUDGET_ID,
                        AGENCY_ID,
                        ORGANIZATION_ID
                  FROM INVOICE WHERE IS_ETL_RECORD = 'Y' AND IS_RECORD_PROCESSED = 'N' AND STATUS_ID = 73
      </select>
     
      <update id="updateInvoiceIdForBatch" parameterType="java.util.HashMap">
            UPDATE INVOICE
            SET IS_RECORD_PROCESSED = 'Y',
                  MODIFIED_DATE = SYSTIMESTAMP
            WHERE INVOICE_ID=#{InvoiceNumber,jdbcType=CHAR}
      </update>
      <select id="getBaseBudgetIdFromInvoiceId" parameterType="java.lang.String"
            resultType="String">
      select budget_id from invoice where invoice_id =  #{aoInvoiceId,jdbcType=VARCHAR}
      </select>
 
      <!-- Start Enhancement 6535 Release 3.8.0 -->
      <!-- <select id="fetchInvoiceRateRemainingAmtNegative" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="RateBeanList">
            SELECT rt.RATE_ID,
              rt.UNIT_DESCRIPTION,
              rt.NUMBER_OF_UNITS,
              MAX(rt.CREATED_DATE),
              rt.AMOUNT AS FY_BUDGET,
              SUM(
              CASE
                WHEN Pay.STATUS_ID IS NOT NULL and inv.invoice_amount &lt; 0
                THEN NVL(INV.INVOICE_AMOUNT,0)
                ELSE 0
              END ) AS INVOICE_AMOUNT,
              rt.AMOUNT - SUM(
              CASE
                WHEN Pay.STATUS_ID IS NOT NULL
                THEN NVL(INV.INVOICE_AMOUNT,0)
                ELSE 0
              END ) AS REMAINING_AMT,
              rt.number_of_units - SUM(
              CASE
                WHEN Pay.STATUS_ID IS NOT NULL
                THEN NVL(inv.invoiced_units,0)
                ELSE 0
              END ) AS REMAINING_UNITS
            FROM RATE rt
            LEFT JOIN INVOICE_DETAILS inv
            ON rt.RATE_ID         = inv.LINE_ITEM_ID
            AND INV.ENTRY_TYPE_ID = 7
            LEFT JOIN Payment Pay
            ON PAY.INVOICE_ID  = inv.INVOICE_ID
            AND Pay.status_id IN (64,65)
            WHERE rt.BUDGET_ID   = #{contractBudgetID}
            AND rt.SUB_BUDGET_ID = #{subBudgetID}
            AND rt.active_flag   = 1
            GROUP BY rt.RATE_ID,
              rt.UNIT_DESCRIPTION,
              rt.NUMBER_OF_UNITS,
              rt.AMOUNT,
              RT.CREATED_DATE
            ORDER BY rt.CREATED_DATE DESC
      </select> -->
 
 
      <select id="fetchRateRemainingPaymentDisbursed" parameterType="com.nyc.hhs.model.CBGridBean" resultType="BigDecimal">
            SELECT nvl(SUM(
              CASE  WHEN PAY.STATUS_ID    IS NOT NULL and
			                <if test="invoiceAmountCurrent &gt;= 0">
			                inv.invoice_amount &lt; 0
			                </if>
			                 <if test="invoiceAmountCurrent &lt; 0">
			                inv.invoice_amount &gt; 0
			                </if>
	                THEN NVL(INV.INVOICE_AMOUNT,0)
	                ELSE 0
                    END ),'0') AS REMAINING_AMOUNT
            FROM ${tableName} rt
            LEFT JOIN   INVOICE_DETAILS inv
                   ON   rt.${tableId}         = inv.LINE_ITEM_ID
                  AND   INV.ENTRY_TYPE_ID = #{entryTypeId}
            <!--[Start] R8.3.1 R9482   -->
            LEFT JOIN (SELECT DISTINCT INVOICE_ID,  STATUS_ID from PAYMENT ) PAY
            <!--[End] R8.3.1 R9482   -->
                   ON   PAY.INVOICE_ID       = INV.INVOICE_ID
                  AND   PAY.STATUS_ID      IN (64,65)
                  AND   inv.invoice_id NOT IN (#{invoiceId})
            WHERE rt.${tableId}        = #{lineItemId}
            AND RT.BUDGET_ID        =#{contractBudgetID}
            AND RT.SUB_BUDGET_ID    = #{subBudgetID}
            AND RT.active_flag      = 1
            GROUP BY RT.${tableId},
              rt.${tableAmountColumn}
      </select>
 
      <select id="fetchRateRemainingPaymentDisbursedUnits" parameterType="com.nyc.hhs.model.CBGridBean" resultType="BigDecimal">
            SELECT nvl(SUM(
              CASE  WHEN PAY.STATUS_ID    IS NOT NULL and
			                <if test="invoiceUnitsCurrent &gt;= 0">
			                inv.INVOICED_UNITS  &lt; 0
			                </if>
			                 <if test="invoiceUnitsCurrent &lt; 0">
			                inv.INVOICED_UNITS &gt; 0
			                </if>
                    THEN NVL(inv.INVOICED_UNITS,0)
                    ELSE 0
              END ),'0') 
              AS REMAINING_UNITS
            FROM ${tableName} rt
            LEFT JOIN  INVOICE_DETAILS inv  
                   ON  rt.${tableId} = inv.LINE_ITEM_ID 
                   AND INV.ENTRY_TYPE_ID = 7
            <!--[Start] R8.3.1 R9482   -->
            LEFT JOIN (SELECT DISTINCT INVOICE_ID,  STATUS_ID from PAYMENT ) PAY
            <!--[End] R8.3.1 R9482   -->
                   ON PAY.INVOICE_ID       = INV.INVOICE_ID  
                  AND PAY.STATUS_ID      IN (64,65)
                  AND inv.invoice_id NOT IN (#{invoiceId})
            WHERE rt.${tableId}       = #{lineItemId}
            AND RT.BUDGET_ID        =#{contractBudgetID}
            AND RT.SUB_BUDGET_ID    = #{subBudgetID}
            AND RT.active_flag      = 1
            GROUP BY RT.${tableId}, rt.NUMBER_OF_UNITS
      </select>
      <select id="fetchFyBudgetLineItem" parameterType="com.nyc.hhs.model.CBGridBean" resultType="BigDecimal">
      select nvl(${tableAmountColumn},0) from ${tableName} where ${tableId} = #{lineItemId}    
      </select>
     
      <select id="fetchFyBudgetLineItemUnits" parameterType="com.nyc.hhs.model.CBGridBean" resultType="BigDecimal">
      select nvl(number_of_units,0) from rate where rate_id= #{lineItemId}   
      </select>
      <!-- <select id="fetchRateRemainingPendingInvoiceNegative" parameterType="com.nyc.hhs.model.RateBean" resultType="BigDecimal">
            select
            SUM(CASE
            WHEN
            INVVV.STATUS_ID IS NOT NULL and inv.invoice_amount &lt; 0
            THEN
            NVL(INV.INVOICE_AMOUNT,0)
            ELSE
            0
            END ) AS REMAINING_AMOUNT
            from
            rate rt
            LEFT JOIN
            INVOICE_DETAILS inv
            ON
            rt.RATE_ID = inv.LINE_ITEM_ID
            AND
            inv.ENTRY_TYPE_ID = 7
            LEFT JOIN
            INVOICE INVVV
            ON
            invvv.invoice_id =
            inv.invoice_id
            AND
            invvv.status_id IN ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
            WHERE
            rt.rate_id = #{id}
            and
            RT.BUDGET_ID = #{contractBudgetID}
            AND
            RT.SUB_BUDGET_ID = #{subBudgetID}
            AND
            RT.active_flag = 1
            GROUP BY
            rt.RATE_ID,
            rt.AMOUNT
      </select> -->
 
      <!-- End Enhancement 6535 Release 3.8.0 -->
     
      <!-- Release 3.10.0, enhancement 6576 -->
      <select id="preventPaymentOverBudgetTotal" parameterType="java.util.Map"
            resultType="string">
            SELECT (SELECT FISCAL_YEAR_AMOUNT
                  FROM BUDGET
                  WHERE BUDGET_ID = #{budgetID}) -
            <!-- Start : R5 Added Removed string comparision on the list-->
            (<if test="invoiceList != null">
            <!-- End : R5 Added Removed string comparision on the list-->
             ( (SELECT (NVL(SUM(invoice_amount),0)) 
                  FROM invoice_details
                  WHERE invoice_id IN
                  (SELECT invoice_id
                        FROM invoice
                        WHERE budget_id =#{budgetID}
                        AND status_id  IN ('72')
                        AND entry_type_id in (1,2,3,4,5,6,7,8,9,10,12,13)
                        AND delete_flag = '0'
                        AND invoice_id in
                        <foreach item="item" index="index" collection="invoiceList"
                          open="(" separator="," close=")">
                             #{item}
                              </foreach>
                  )
            )-(SELECT (NVL(SUM(amount_recouped),0)) 
                  FROM invoice_advance
                  WHERE invoice_id IN
                        <foreach item="item" index="index" collection="invoiceList"
                          open="(" separator="," close=")">
                             #{item}
                              </foreach>
                  )
       )
            +
            </if>
            (SELECT (NVL(SUM(PAYMENT_AMOUNT),0)) 
                  FROM PAYMENT
                  WHERE budget_id =#{budgetID}
                  AND status_id  IN ('63','64','65')
                  AND delete_flag = '0'
            )
            +
            ((SELECT (NVL(SUM(invoice_amount),0)) 
                  FROM invoice_details
                  WHERE invoice_id IN
                  (SELECT invoice_id
                        FROM invoice
                        WHERE invoice_id =#{invoiceId}
                        AND status_id  IN ('72')
                        AND entry_type_id in (1,2,3,4,5,6,7,8,9,10,12,13)
                        AND delete_flag = '0'
                  )
            )- (SELECT (NVL(SUM(amount_recouped),0)) 
                  FROM invoice_advance
                  WHERE invoice_id = #{invoiceId}))
            + (select (NVL(SUM(amount),0)) from budget_advance where budget_id =#{budgetID} and status_id='92' and delete_flag='0'   )
            ) as remaining_amount from dual
      </select>
      <!-- Added for R5 -->
      <select id="getInvoiceDetails" parameterType="hashmap" resultType="string">
            select INVOICE_NUMBER from invoice where INVOICE_NUMBER like #{partialString} and organization_id=#{userOrg}
      </select>
      <!-- Added for R5 -->
      <!-- Added for R7 -->
      <!-- added in R7: This query checks the visiblity of ModificationUrl in invoice review task screen -->
	<select id="fetchModificationUrlDetail" parameterType="string"
		resultType="string">
		Select Count(*) From budget bud Where
		bud.budget_id=#{budgetId} and bud.budget_type_id=2 And
		bud.SHOW_INFO_MESSAGE= 1
	</select>
      <!-- End R7 -->
      
      <!--Start:Added in R7 for Cost-Center  -->
      <update id="updateLineItemsYtdAndRemainingAmountUnitsForServices" parameterType="java.util.HashMap">
      		Merge INTO BC_SERVICES_DETAILS A USING
            (
             SELECT SUM(YTD_INVOICE_INCOME) AS YTD_INVOICE_INCOME,
             SUM(FY_BUDGET_INCOME)                   AS FY_BUDGET_INCOME,
             SUM(FY_BUDGET_INCOME) - SUM(YTD_INVOICE_INCOME)  AS REMAINING_AMOUNT,
             sum(YTD_INVOICED_UNITS) as YTD_INVOICED_UNITS,
             sum(FY_BUDGET_UNITS) as FY_BUDGET_UNITS,
             sum(FY_BUDGET_UNITS) - sum(YTD_INVOICED_UNITS) as REMAINING_UNITS,
             BC_SERVICES_DETAIL_ID
             FROM
             (SELECT BC_SERVICES_DETAIL_ID,
              0 AS YTD_INVOICE_INCOME,
              0 as YTD_INVOICED_UNITS,
              FY_BUDGET_UNITS,
              FY_BUDGET_INCOME
              FROM BC_SERVICES_DETAILS
              WHERE budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
              UNION ALL
              SELECT line_item_id AS BC_SERVICES_DETAIL_ID,
              NVL(SUM(ind.INVOICE_AMOUNT), 0) AS YTD_INVOICE_INCOME,
              NVL(SUM(ind.INVOICE_UNITS), 0) AS YTD_INVOICED_UNITS,
              0 as FY_BUDGET_UNITS,
              0 AS FY_BUDGET_INCOME 
              FROM INVOICE_SERVICES_DETAILS ind,
              invoice inv
              WHERE inv.budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
              AND inv.invoice_id  = ind.invoice_id
              AND inv.status_id  IN (72,73)
              GROUP BY line_item_id
              )
              GROUP BY BC_SERVICES_DETAIL_ID
              ) B ON (A.BC_SERVICES_DETAIL_ID = B.BC_SERVICES_DETAIL_ID)
              WHEN matched THEN
              UPDATE
              SET YTD_INVOICE_INCOME = B.YTD_INVOICE_INCOME,
              REMAINING_AMOUNT      = B.REMAINING_AMOUNT,
              YTD_INVOICED_UNITS = B.YTD_INVOICED_UNITS,
              REMAINING_UNITS = B.REMAINING_UNITS,
              MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR},
              MODIFIED_DATE=systimestamp
      </update>
      
       <update id="updateLineItemsYtdAndRemainingAmountForCostCenter" parameterType="java.util.HashMap">
      		Merge INTO COST_CENTER_DETAILS A USING
           (
            SELECT SUM(YTD_INVOICED_AMOUNT) AS YTD_INVOICED_AMOUNT,
            SUM(FY_BUDGET_AMOUNT)                   AS FY_BUDGET_AMOUNT,
            SUM(FY_BUDGET_AMOUNT) - SUM(YTD_INVOICED_AMOUNT)  AS REMAINING_AMOUNT,
            COST_CENTER_DETAILS_ID
            FROM
            (SELECT COST_CENTER_DETAILS_ID,
             0 AS YTD_INVOICED_AMOUNT,
             FY_BUDGET_AMOUNT
             FROM COST_CENTER_DETAILS
             WHERE budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
             UNION ALL
             SELECT line_item_id               AS COST_CENTER_DETAILS_ID,
             NVL(SUM(ind.INVOICE_AMOUNT), 0) AS YTD_INVOICED_AMOUNT,
             0                               AS FY_BUDGET_AMOUNT
             FROM INVOICE_COST_CENTER_DETAILS ind,
             invoice inv
             WHERE inv.budget_id = (select parent_id from budget where budget_id = #{budgetId,jdbcType=VARCHAR})
             AND inv.invoice_id  = ind.invoice_id
             AND inv.status_id  IN (72,73)
             GROUP BY line_item_id
             )
             GROUP BY COST_CENTER_DETAILS_ID
             ) B ON (A.COST_CENTER_DETAILS_ID = B.COST_CENTER_DETAILS_ID)
             WHEN matched THEN
             UPDATE
             SET YTD_INVOICED_AMOUNT = B.YTD_INVOICED_AMOUNT,
             REMAINING_AMOUNT      = B.REMAINING_AMOUNT,
             MODIFIED_BY_USERID=#{userId,jdbcType=VARCHAR},
             MODIFIED_DATE=systimestamp
      </update>
      <!--End:Added in R7 for Cost-Center  -->
      <!--End:Added in R7 for Cost-Center  -->
      
<!-- start : added in R7 for invoice cost center -->
      <resultMap id="InvoiceBeanList" type="com.nyc.hhs.model.CBServicesBean">
            <result property="id" column="BC_SERVICES_DETAIL_ID" />
            <result property="serviceName" column="SERVICE_NAME" />
            <result property="units" column="FY_BUDGET_UNITS" />
            <result property="invUnits" column="INVOICE_UNITS" />
            <result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
            <result property="remainingAmt" column="REMAINING_AMT" />
            <result property="remUnits" column="REMAINING_UNITS" />
      </resultMap>
      
      <select id="fetchInvoiceServiceData" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="InvoiceBeanList">
				SELECT BC_SERVICES_DETAIL_ID  , service_name,sum(invoice_units) as
				invoice_units, sum(REMAINING_AMT) as
				REMAINING_AMT,sum(REMAINING_UNITS) as REMAINING_UNITS,
				sum(INVOICE_AMOUNT) as INVOICE_AMOUNT
				FROM
				(
				SELECT sd.BC_SERVICES_DETAIL_ID ,
				services_master.service_name,
				0 AS INVOICE_UNITS,
				0 AS INVOICE_AMOUNT,
				sd.FY_BUDGET_INCOME - SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(INV.INVOICE_AMOUNT,0)
				ELSE 0
				END ) AS REMAINING_AMT,
				sd.FY_BUDGET_UNITS - SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(inv.INVOICE_UNITS,0)
				ELSE 0
				END ) AS REMAINING_UNITS
				FROM BC_SERVICES_DETAILS  sd
				INNER JOIN BUDGET_SERVICES_CONFIGURATION
				ON sd.BUDGET_SERVICES_CONFIG_ID=
				BUDGET_SERVICES_CONFIGURATION.BUDGET_SERVICES_CONFIG_ID
				INNER JOIN COST_CENTER_SERVICES_MAPPING
				ON
				BUDGET_SERVICES_CONFIGURATION.COST_CENTER_SERVICE_MAPPING_ID=COST_CENTER_SERVICES_MAPPING.COST_CENTER_SERVICE_MAPPING_ID
				INNER JOIN SERVICES_MASTER
				ON
				COST_CENTER_SERVICES_MAPPING.SERVICE_MASTER_ID=SERVICES_MASTER.SERVICE_MASTER_ID
				LEFT JOIN INVOICE_SERVICES_DETAILS inv
				ON sd.BC_SERVICES_DETAIL_ID  = inv.LINE_ITEM_ID
				LEFT JOIN INVOICE INVVV
				ON invvv.invoice_id = inv.invoice_id
				AND invvv.status_id IN (72, 73)
				WHERE sd.BUDGET_ID =#{contractBudgetID}
				AND sd.SUB_BUDGET_ID = #{subBudgetID}
				AND sd.active_flag = 1
				GROUP BY sd.BC_SERVICES_DETAIL_ID  ,
				services_master.service_name,
				sd.FY_BUDGET_INCOME,
				sd.FY_BUDGET_UNITS,
				sd.CREATED_DATE
				UNION ALL
				SELECT sd.BC_SERVICES_DETAIL_ID  ,
				services_master.service_name,
				SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(inv.INVOICE_UNITS,0)
				ELSE 0
				END ) AS INVOICE_UNITS,
				SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(INV.INVOICE_AMOUNT,0)
				ELSE 0
				END ) AS INVOICE_AMOUNT,
				0 AS REMAINING_AMT,
				0 AS REMAINING_UNITS
				FROM BC_SERVICES_DETAILS sd
				INNER JOIN BUDGET_SERVICES_CONFIGURATION
				ON sd.BUDGET_SERVICES_CONFIG_ID=
				BUDGET_SERVICES_CONFIGURATION.BUDGET_SERVICES_CONFIG_ID
				INNER JOIN COST_CENTER_SERVICES_MAPPING
				ON
				BUDGET_SERVICES_CONFIGURATION.COST_CENTER_SERVICE_MAPPING_ID=COST_CENTER_SERVICES_MAPPING.COST_CENTER_SERVICE_MAPPING_ID
				INNER JOIN SERVICES_MASTER
				ON
				COST_CENTER_SERVICES_MAPPING.SERVICE_MASTER_ID=SERVICES_MASTER.SERVICE_MASTER_ID
				LEFT JOIN INVOICE_SERVICES_DETAILS inv
				ON sd.BC_SERVICES_DETAIL_ID  = inv.LINE_ITEM_ID
				LEFT JOIN INVOICE INVVV
				ON invvv.invoice_id = inv.invoice_id
				and inv.INVOICE_ID= #{invoiceId}
				WHERE sd.BUDGET_ID =#{contractBudgetID}
				AND sd.SUB_BUDGET_ID = #{subBudgetID}
				AND sd.active_flag = 1
				GROUP BY sd.BC_SERVICES_DETAIL_ID ,
				services_master.service_name,
				sd.FY_BUDGET_INCOME,
				sd.FY_BUDGET_UNITS,
				sd.CREATED_DATE
				)
				GROUP BY
				BC_SERVICES_DETAIL_ID , service_name
				ORDER BY
				BC_SERVICES_DETAIL_ID 
      </select>
      
    <update id="updateInvoiceServicesList" parameterType="com.nyc.hhs.model.CBServicesBean">
			UPDATE BC_SERVICES_DETAILS
			SET
			FY_BUDGET_UNITS = #{units},
			FY_BUDGET_INCOME = #{fyBudget},
			MODIFIED_DATE = SYSTIMESTAMP, 
			MODIFIED_BY_STAFFID = #{modifyByProvider}
			WHERE BC_SERVICES_DETAIL_ID  = #{id}
	</update>
	
	 <update id="editInvoiceService" parameterType="com.nyc.hhs.model.CBServicesBean">
            UPDATE INVOICE_SERVICES_DETAILS
            SET INVOICE_AMOUNT = #{ytdInvoicedAmt},INVOICE_UNITS = #{invUnits},
            modified_date=CURRENT_TIMESTAMP, MODIFIED_BY_STAFFID =
            #{modifyByProvider}
            WHERE
            LINE_ITEM_ID = #{id} and SUB_BUDGET_ID= #{subBudgetID} and invoice_id = #{invoiceId}
      </update>
 
      <insert id="insertInvoiceService" parameterType="com.nyc.hhs.model.CBServicesBean">
            Insert into INVOICE_SERVICES_DETAILS
            (INVOICE_SERVICES_DETAILS_ID,
            INVOICE_ID,
            SUB_BUDGET_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            INVOICE_UNITS,
            CREATED_DATE,
            MODIFIED_DATE,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID)
            values
            (
            SEQ_SERVICES_INVOICE_DETAILS.nextval,
            #{invoiceId},
            #{subBudgetID},
            #{id},
            #{ytdInvoicedAmt},
            #{invUnits},
            SYSTIMESTAMP,
             SYSTIMESTAMP,
            #{modifyByProvider,jdbcType=VARCHAR},
            #{modifyByProvider ,jdbcType=VARCHAR}
            )
      </insert>
      
      <select id="fetchFyBudgetUnitsLineItem" parameterType="com.nyc.hhs.model.CBServicesBean" resultType="BigDecimal">
      		select nvl(${remUnits},0) from ${tableName} where ${tableId} = #{lineItemId}    
      </select>
     
      <resultMap id="InvoiceCostBeanList" type="com.nyc.hhs.model.CBServicesBean">
            <result property="costCenterName" column="COST_CENTER_NAME" />
            <result property="id" column="COST_CENTER_DETAILS_ID" />
            <result property="ytdInvoicedAmt" column="INVOICE_AMOUNT" />
            <result property="remainingAmt" column="REMAINING_AMOUNT" />
      </resultMap>
      <select id="fetchInvoiceCostData" parameterType="com.nyc.hhs.model.CBGridBean"
            resultMap="InvoiceCostBeanList">
		       SELECT  COST_CENTER_DETAILS_ID,
		       COST_CENTER_NAME,
		 		sum(REMAINING_AMOUNT) as
				REMAINING_AMOUNT,
				sum(INVOICE_AMOUNT) as INVOICE_AMOUNT
				FROM
				(
				SELECT  ccd.COST_CENTER_DETAILS_ID,
			            COST_CENTER_MASTER.COST_CENTER_NAME,
				0 AS INVOICE_AMOUNT,
				ccd.FY_BUDGET_AMOUNT - SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(INV.INVOICE_AMOUNT,0)
				ELSE 0
				END ) AS REMAINING_AMOUNT
				 from
				COST_CENTER_DETAILS ccd
				INNER JOIN COST_CENTER_MASTER
				ON ccd.COST_CENTER_ID= COST_CENTER_MASTER.COST_CENTER_MASTER_ID
			  	LEFT JOIN
		        INVOICE_COST_CENTER_DETAILS inv
		        ON
		        ccd.COST_CENTER_DETAILS_ID = inv.LINE_ITEM_ID
		        LEFT JOIN
		        INVOICE INVVV
		        ON
		        invvv.invoice_id =
		        inv.invoice_id
		        AND
		        invvv.status_id in (72, 73)
		        WHERE
		        ccd.BUDGET_ID =
		        #{contractBudgetID}
		        AND
		        ccd.SUB_BUDGET_ID = #{subBudgetID}
		        AND
		        ccd.active_flag = 1
		        GROUP BY
		        ccd.COST_CENTER_DETAILS_ID,
		        ccd.FY_BUDGET_AMOUNT,
		        COST_CENTER_MASTER.COST_CENTER_NAME,
				 ccd.CREATED_DATE
				UNION ALL
				select ccd.COST_CENTER_DETAILS_ID,
		        COST_CENTER_MASTER.COST_CENTER_NAME,
				SUM(
				CASE
				WHEN INVVV.STATUS_ID IS NOT NULL
				THEN NVL(INV.INVOICE_AMOUNT,0)
				ELSE 0
				END ) AS INVOICE_AMOUNT,
				0 AS REMAINING_AMOUNT
				from
			 	COST_CENTER_DETAILS ccd
				INNER JOIN COST_CENTER_MASTER
				ON ccd.COST_CENTER_ID= COST_CENTER_MASTER.COST_CENTER_MASTER_ID
			 	 LEFT JOIN
		            INVOICE_COST_CENTER_DETAILS inv
		            ON
		            ccd.COST_CENTER_DETAILS_ID = inv.LINE_ITEM_ID
		            LEFT JOIN
		            INVOICE INVVV
		            ON
		            invvv.invoice_id =
		            inv.invoice_id
		            and inv.INVOICE_ID= #{invoiceId}
		            WHERE
		            ccd.BUDGET_ID =
		           #{contractBudgetID}
		            AND
		            ccd.SUB_BUDGET_ID =#{subBudgetID}
		            AND
		            ccd.active_flag = 1
		            GROUP BY
		             ccd.COST_CENTER_DETAILS_ID,
		            ccd.FY_BUDGET_AMOUNT,
		            COST_CENTER_MASTER.COST_CENTER_NAME,
		            ccd.CREATED_DATE
					)
					GROUP BY
					COST_CENTER_DETAILS_ID,
				           COST_CENTER_NAME
					ORDER BY
					COST_CENTER_DETAILS_ID
     	</select>
      
        <select id="fetchInvAmountForCostCenterLineItem" parameterType="com.nyc.hhs.model.CBServicesBean"
            resultType="BigDecimal">
            SELECT
            (COST_CENTER_DETAILS.FY_BUDGET_AMOUNT - (SUM(CASE WHEN inv.STATUS_ID IS NOT
            NULL and
            <if test="invoiceAmountCurrent &gt;= 0">
            inv_det.invoice_amount &gt; 0
            </if>
            <if test="invoiceAmountCurrent &lt; 0">
            inv_det.invoice_amount &lt; 0
            </if>
            THEN
            inv_det.INVOICE_AMOUNT
            ELSE 0
            END ))) as REMAINING_AMOUNT
            FROM COST_CENTER_DETAILS
            LEFT JOIN
            INVOICE_COST_CENTER_DETAILS inv_det
            ON
            inv_det.LINE_ITEM_ID =
            COST_CENTER_DETAILS.COST_CENTER_DETAILS_ID
            LEFT JOIN
            INVOICE inv
            ON
            inv.INVOICE_ID = inv_det.INVOICE_ID
            AND
            inv.STATUS_ID IN ('70','71','72','73')
            AND
            inv.invoice_id not in (#{invoiceId})
            WHERE
            COST_CENTER_DETAILS.COST_CENTER_DETAILS_ID=#{id}
            AND
            COST_CENTER_DETAILS.BUDGET_ID = #{contractBudgetID}
            AND
            COST_CENTER_DETAILS.SUB_BUDGET_ID =#{subBudgetID}
            GROUP BY
            COST_CENTER_DETAILS.FY_BUDGET_AMOUNT
      </select>
      
      <update id="editInvoiceCostCenter" parameterType="com.nyc.hhs.model.CBServicesBean">
            UPDATE INVOICE_COST_CENTER_DETAILS
            SET INVOICE_AMOUNT = #{ytdInvoicedAmt},
            modified_date=CURRENT_TIMESTAMP, MODIFIED_BY_STAFFID =
            #{modifyByProvider}
            WHERE
            LINE_ITEM_ID = #{id} and SUB_BUDGET_ID= #{subBudgetID} and invoice_id = #{invoiceId}
      </update>
 
       <insert id="insertInvoiceCostCenter" parameterType="com.nyc.hhs.model.CBServicesBean">
 
       Insert into INVOICE_COST_CENTER_DETAILS 
            (INVOICE_CC_DETAIL_ID,
            INVOICE_ID,
            SUB_BUDGET_ID,
            LINE_ITEM_ID,
            INVOICE_AMOUNT,
            CREATED_DATE,
            MODIFIED_DATE,
            MODIFIED_BY_STAFFID,
            CREATED_BY_STAFFID)
            values
            (
            SEQ_CC_INVOICE_DETAILS.nextval,
            #{invoiceId},
            #{subBudgetID},
            #{id},
            #{ytdInvoicedAmt},
            SYSTIMESTAMP,
             SYSTIMESTAMP,
            #{modifyByProvider,jdbcType=VARCHAR},
            #{modifyByProvider ,jdbcType=VARCHAR}
            )
      </insert>
 
 	 <select id="invoiceServicesTotal" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS TOTAL_INVOICE FROM
            INVOICE_SERVICES_DETAILS WHERE INVOICE_ID = #{asInvoiceId} 
      </select>
      
         <select id="assignmentAmountServices" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS ASSIGNMENT FROM
            INVOICE_DETAILS WHERE INVOICE_ID = #{asInvoiceId} and ENTRY_TYPE_ID =11
      </select>
      
      <select id="fetchCostCenterAmountTotal" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS TOTAL_INVOICE FROM
            INVOICE_COST_CENTER_DETAILS  WHERE INVOICE_ID = #{asInvoiceId} 
      </select>
      
       <select id="assignmentAmountCostCenter" parameterType="java.lang.String"
            resultType="BigDecimal">
            SELECT NVL(SUM(INVOICE_AMOUNT),'0') AS ASSIGNMENT FROM
            INVOICE_DETAILS WHERE INVOICE_ID = #{asInvoiceId} and ENTRY_TYPE_ID not in(11,14)
      </select>
      
      <delete id="deleteCostCenterInvoiceDetails" parameterType="java.lang.String">
            DELETE FROM
            invoice_cost_center_details
            WHERE INVOICE_ID= #{invoiceId}
      </delete>
      
       <delete id="deleteServicesInvoiceDetails" parameterType="java.lang.String">
	DELETE FROM
	invoice_services_details
	WHERE INVOICE_ID= #{invoiceId}
      </delete>
      
      <select id="fetchCCRemainingPaymentDisbursed" parameterType="com.nyc.hhs.model.CBGridBean" resultType="BigDecimal">
            SELECT nvl(SUM( CASE WHEN PAY.STATUS_ID    IS NOT NULL and
					            <if test="invoiceAmountCurrent &gt;= 0">
					            inv.invoice_amount &lt; 0
					            </if>
					            <if test="invoiceAmountCurrent &lt; 0">
					            inv.invoice_amount &gt; 0
					            </if>
				            THEN NVL(INV.INVOICE_AMOUNT,0)
            					ELSE 0
				            END ),'0') AS REMAINING_AMOUNT
            FROM   ${tableName} rt 
            LEFT JOIN  INVOICE_COST_CENTER_DETAILS inv
                   ON  rt.${tableId}        = inv.LINE_ITEM_ID
            <!--[Start] R8.3.1 R9482   -->
            LEFT JOIN (SELECT DISTINCT INVOICE_ID,  STATUS_ID from PAYMENT ) PAY
            <!--[End] R8.3.1 R9482   -->
                   ON  PAY.INVOICE_ID       =  INV.INVOICE_ID
                  AND  PAY.STATUS_ID        IN (64,65)
                  AND  inv.invoice_id NOT   IN (#{invoiceId})
            WHERE   rt.${tableId}       =  #{lineItemId}
            AND     RT.BUDGET_ID        =  #{contractBudgetID}
            AND     RT.SUB_BUDGET_ID    =  #{subBudgetID}
            AND     RT.active_flag      =  1
            GROUP BY RT.${tableId}, rt.${tableAmountColumn}
      </select>
      
 <!-- End : added in R7 for invoice cost center -->
 
 <!-- Start QC 8774 R 7.5.0  update InvoiceAdvance with 0 RecoupedAmnt if Invoice has been Withdrawn -->
 	<update id="updateInvoiceAdvanceWith0RecoupedAmntForInvoiceWithdrawn" parameterType="java.lang.String">
            UPDATE  INVOICE_ADVANCE
            SET AMOUNT_RECOUPED = 0
            WHERE INVOICE_ID = #{asInvoiceNumber}
				  and AMOUNT_RECOUPED > 0
     </update>	 
   <!-- End QC 8774 R 7.5.0  update InvoiceAdvance with 0 RecoupedAmnt if Invoice has been Withdrawn -->   
      
</mapper>
 