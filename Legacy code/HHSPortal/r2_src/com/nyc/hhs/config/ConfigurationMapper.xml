<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.nyc.hhs.service.db.services.application.ConfigurationMapper">
	
	<resultMap id="procurementCOFDetails" type="com.nyc.hhs.model.ProcurementCOF">
		<result property="procurementID" column="PROCUREMENT_CERT_OF_FUNDS_ID" />
		<result property="procurementTitle" column="PROCUREMENT_TITLE" />
		<result property="procurementValue" column="ESTIMATED_PROCUREMENT_VALUE" />
		<result property="contractStartDate" column="CONTRACT_START_DATE" />
		<result property="contractEndDate" column="CONTRACT_END_DATE" />
		<result property="contractValue" column="CONTRACT_AMOUNT" />
		<result property="origContractStartDate" column="ORIG_CONTRACT_START_DATE" />
		<result property="origContractEndDate" column="ORIG_CONTRACT_END_DATE" />
		<result property="origContractValue" column="ORIG_ESTIMATED_PROC_VALUE" />
		<result property="procurementStatus" column="STATUS" />
		<result property="agencyName" column="AGENCY_NAME" />
		<result property="agencyId" column="AGENCY_ID" />
		<result property="agencyCode" column="AGENCY_CODE" />
		<result property="procEpin" column="EPIN" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="modifiedByUserId" column="MODIFIED_BY_USERID" />
		<result property="userFirstName" column="FIRST_NAME" />
		<result property="userLastName" column="LAST_NAME" />
		<result property="approverFirstName" column="APPROVED_FN" />
		<result property="approverLastName" column="APPROVED_LN" />	
		<result property="approvedDate" column="APPROVED_DATE" />
		<result property="status" column="STATUS" />
		<result property="updatedContractStartDate" column="UPD_CONTRACT_START_DATE" />
		<result property="updatedContractEndDate" column="UPD_CONTRACT_END_DATE" />
	</resultMap>
	
	<resultMap id="procWFDetails" type="com.nyc.hhs.model.EPinDetailBean">
		<result property="procurementTitle" column="PROCUREMENT_TITLE" />
		<result property="epinId" column="EPIN" />
		<result property="agencyId" column="AGENCY_ID" />
		<result property="procurementId" column="PROCUREMENT_ID"/>		
	</resultMap>
	
	<select id="getDataWFbyProcId" parameterType="String"
		resultMap="procWFDetails">
		SELECT 
		PROCUREMENT_TITLE,
		EPIN,
		AGENCY_ID,
		PROCUREMENT_ID
		FROM PROCUREMENT WHERE PROCUREMENT_ID = #{asProcId}
	</select>		
	<!-- R5 Changes starts-->
	<select id="fetchProcurementCOFDetails" parameterType="map"
			resultMap="procurementCOFDetails">
		WITH APPROVED_BY_DETAILS(APPROVED_FN, APPROVED_LN, Approved_date_FN ) AS
		(SELECT 
		(
		CASE
		WHEN approved_by IS NOT NULL
		THEN user1.FIRST_NAME
		ELSE ' '
		END) AS APPROVED_FN,
		(
		CASE
		WHEN approved_by IS NOT NULL
		THEN user1.LAST_NAME
		ELSE ' '
		END) AS APPROVED_LN,
		
		(
		CASE
		WHEN PRF.Approved_date IS NOT NULL
		THEN TO_CHAR(PRF.Approved_date,'MM/DD/YYYY' )
		ELSE ' '
		END) AS Approved_date_FN
		
		FROM PROCUREMENT PR,
		STATUS_MASTER_R2_R3 ST,
		NYC_AGENCY_DETAILS Agn,
		CITY_USER_DETAILS user1,
		Procurement_Financials PRF
		WHERE PRF.PROCUREMENT_ID = #{asProcurementId}
		AND PRF.PROCUREMENT_ID = PR.PROCUREMENT_ID(+)
		AND ST.STATUS_ID = PR.STATUS_ID
		AND Agn.AGENCY_ID = PR.AGENCY_ID
		AND prf.approved_by = user1.user_id(+)
		AND PRF.TYPE = #{type}
		and pr.PCOF_PSR_VERSION_NUMBER = PRF.version_number
		)
		SELECT App.APPROVED_FN,
		App.APPROVED_LN,
		App.Approved_date_FN as Approved_date,
		PR.PROCUREMENT_TITLE,
		PR.ORIG_ESTIMATED_PROC_VALUE,
		TO_CHAR(PR.ORIG_CONTRACT_START_DATE, 'MM/DD/YYYY') AS ORIG_CONTRACT_START_DATE,
		TO_CHAR(PR.ORIG_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS ORIG_CONTRACT_END_DATE,
		ST.STATUS,
		Agn.AGENCY_NAME,
		Agn.AGENCY_CODE,
		PR.AGENCY_ID,
		NVL(PR.EPIN, 'N/A') AS EPIN,
		TO_CHAR(PRF.CREATED_DATE, 'MM/DD/YYYY' ) AS CREATED_DATE,
		PRF.CREATED_BY_USERID,
		TO_CHAR(PRF.MODIFIED_DATE,'MM/DD/YYYY' ) AS MODIFIED_DATE,
		PRF.MODIFIED_BY_USERID,
		user1.FIRST_NAME ,
		user1.LAST_NAME,
		user1.FIRST_NAME AS APPROVED_BY_FN,
		PRF.TYPE,
		PRF.Approved_by,
		(
		CASE
		WHEN PRF.Approved_date IS NOT NULL
		THEN TO_CHAR(PRF.Approved_date,'MM/DD/YYYY' )
		ELSE ' '
		END) AS Approved_date
		FROM PROCUREMENT PR,
		STATUS_MASTER_R2_R3 ST,
		NYC_AGENCY_DETAILS Agn,
		CITY_USER_DETAILS user1,
		Procurement_Financials PRF,
		APPROVED_BY_DETAILS App
		WHERE PRF.PROCUREMENT_ID = #{asProcurementId}
		AND PRF.PROCUREMENT_ID = PR.PROCUREMENT_ID
		AND ST.STATUS_ID = PR.STATUS_ID
		AND Agn.AGENCY_ID = PR.AGENCY_ID
		AND PRF.MODIFIED_BY_USERID = user1.USER_ID
		AND PRF.TYPE = 'Approved'
		and pr.PCOF_PSR_VERSION_NUMBER = PRF.version_number
		AND rownum ='1'
	</select>	
	
	
<select id="fetchProcurementAddendumCOFDetails" parameterType="map"
			resultMap="procurementCOFDetails">
		WITH APPROVED_BY_DETAILS(APPROVED_FN, APPROVED_LN) AS
		(SELECT 
		(
		CASE
		WHEN approved_by IS NOT NULL
		THEN user1.FIRST_NAME
		ELSE ' '
		END) AS APPROVED_FN,
		(
		CASE
		WHEN approved_by IS NOT NULL
		THEN user1.LAST_NAME
		ELSE ' '
		END) AS APPROVED_LN
		
		FROM PROCUREMENT_ADDENDUM PR,
		STATUS_MASTER_R2_R3 ST,
		NYC_AGENCY_DETAILS Agn,
		CITY_USER_DETAILS user1,
		Procurement_Financials PRF
		WHERE PRF.PROCUREMENT_ID = #{asProcurementId}
		AND PRF.PROCUREMENT_ID = PR.PROCUREMENT_ID(+)
		AND ST.STATUS_ID = PR.STATUS_ID
		AND Agn.AGENCY_ID = PR.AGENCY_ID
		AND prf.approved_by = user1.user_id(+)
		AND PRF.TYPE = #{type}
		and PRF.version_number = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
		)
		SELECT App.APPROVED_FN,
		App.APPROVED_LN,
		PR.PROCUREMENT_TITLE,
		PR.ESTIMATED_PROCUREMENT_VALUE,
		TO_CHAR(PR.UPD_CONTRACT_START_DATE, 'MM/DD/YYYY') AS CONTRACT_START_DATE,
		TO_CHAR(PR.UPD_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS CONTRACT_END_DATE,
		ST.STATUS,
		Agn.AGENCY_NAME,
		Agn.AGENCY_CODE,
		PR.AGENCY_ID,
		NVL(PR.EPIN, 'N/A') AS EPIN,
		TO_CHAR(PRF.CREATED_DATE, 'MM/DD/YYYY' ) AS CREATED_DATE,
		PRF.CREATED_BY_USERID,
		TO_CHAR(PRF.MODIFIED_DATE,'MM/DD/YYYY' ) AS MODIFIED_DATE,
		PRF.MODIFIED_BY_USERID,
		user1.FIRST_NAME ,
		user1.LAST_NAME,
		user1.FIRST_NAME AS APPROVED_BY_FN,
		PRF.TYPE,
		PRF.Approved_by,
		(
		CASE
		WHEN PRF.Approved_date IS NOT NULL
		THEN TO_CHAR(PRF.Approved_date,'MM/DD/YYYY' )
		ELSE ' '
		END) AS Approved_date
		FROM PROCUREMENT_ADDENDUM PR,
		STATUS_MASTER_R2_R3 ST,
		NYC_AGENCY_DETAILS Agn,
		CITY_USER_DETAILS user1,
		Procurement_Financials PRF,
		APPROVED_BY_DETAILS App
		WHERE PRF.PROCUREMENT_ID = #{asProcurementId}
		AND PRF.PROCUREMENT_ID = PR.PROCUREMENT_ID
		AND ST.STATUS_ID = PR.STATUS_ID
		AND Agn.AGENCY_ID = PR.AGENCY_ID
		AND PRF.MODIFIED_BY_USERID = user1.USER_ID
		AND PRF.TYPE = #{type}
		and PRF.version_number = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
		AND rownum ='1'
	</select>	
	<!-- R5 Changes ends-->
	<select id="fetchProcurementCOFDetailsFinancials" parameterType="String"
	resultMap="procurementCOFDetails">
		select pr.ESTIMATED_PROCUREMENT_VALUE as ESTIMATED_PROCUREMENT_VALUE,
		pr.ORIG_ESTIMATED_PROC_VALUE as ORIG_ESTIMATED_PROC_VALUE,
		TO_CHAR(pr.UPD_CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE,
		TO_CHAR(pr.UPD_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS CONTRACT_END_DATE,
		TO_CHAR(pr.ORIG_CONTRACT_START_DATE,'MM/DD/YYYY' ) AS ORIG_CONTRACT_START_DATE,
		TO_CHAR(pr.ORIG_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS ORIG_CONTRACT_END_DATE,

		pr.AGENCY_ID,st.STATUS,Agn.AGENCY_CODE,pr.PROCUREMENT_TITLE,Agn.AGENCY_NAME
		from
		procurement pr, STATUS_MASTER_R2_R3 st, NYC_AGENCY_DETAILS Agn
	
		where
		pr.PROCUREMENT_ID = #{asProcurementId}
		AND
		pr.STATUS_ID = st.STATUS_ID
		AND
		pr.agency_id = agn.agency_id

	</select>

	<!-- fine tuned query as part of build 2.6.0, enhancement 5653-->
	<!-- fetching procurement title and removed extra joins -->
	<select id="fetchProcurementOrigDetails" parameterType="String"
	resultMap="procurementCOFDetails">
		select 
		pr.ORIG_ESTIMATED_PROC_VALUE as ORIG_ESTIMATED_PROC_VALUE,
		TO_CHAR(pr.ORIG_CONTRACT_START_DATE,'MM/DD/YYYY' ) AS ORIG_CONTRACT_START_DATE,
		TO_CHAR(pr.ORIG_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS ORIG_CONTRACT_END_DATE,
		pr.procurement_title
		from
		procurement pr
		where
		pr.PROCUREMENT_ID = #{asProcurementId}

	</select>
	
	<select id="fetchProcurementAddendumCOFDetailsFinancials" parameterType="String"
	resultMap="procurementCOFDetails">
		select pr.ESTIMATED_PROCUREMENT_VALUE as ESTIMATED_PROCUREMENT_VALUE,
		TO_CHAR(pr.UPD_CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE,
		TO_CHAR(pr.UPD_CONTRACT_END_DATE,'MM/DD/YYYY' ) AS CONTRACT_END_DATE,
		pr.AGENCY_ID,st.STATUS,Agn.AGENCY_CODE,pr.PROCUREMENT_TITLE,Agn.AGENCY_NAME
		from
		procurement_addendum pr, STATUS_MASTER_R2_R3 st, NYC_AGENCY_DETAILS Agn
	
		where
		pr.PROCUREMENT_ID = #{asProcurementId}
		AND
		pr.STATUS_ID = st.STATUS_ID
		AND
		pr.agency_id = agn.agency_id

	</select>
	<!-- R5 Changes starts-->
	<select id="fetchProcurementCOFStatus" parameterType="String"
		resultType="java.lang.String">
		select ST.STATUS 
			from PROCUREMENT_FINANCIALS PCOF, STATUS_MASTER_R2_R3 ST 
			where PCOF.PCOF_STATUS_ID = ST.STATUS_ID 
			AND PCOF.PROCUREMENT_ID = #{asProcurementId}
			and pcof.VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId}) 
			AND ROWNUM = 1
	</select>
	
	<update id="setPCOFStatus" parameterType="com.nyc.hhs.model.CBGridBean">
		UPDATE PROCUREMENT_FINANCIALS
	    SET  
	    PCOF_STATUS_ID = #{statusId},
	    MODIFIED_BY_USERID =  #{modifyByAgency}	    
	    WHERE
	    PROCUREMENT_ID = #{procurementID}
	    and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
	</update>
	<!-- R5 Changes ends-->
	<!-- fine tuned query as part of build 2.6.0, enhancement 5653-->
	<!-- set updated values instead of planned values in original columns in procurement table -->
	<update id="setOriginalProcurementValues" parameterType="com.nyc.hhs.model.CBGridBean">
	  UPDATE PROCUREMENT
		SET
		  (
		    ORIG_CONTRACT_START_DATE,
		    ORIG_CONTRACT_END_DATE,
		    ORIG_ESTIMATED_PROC_VALUE
		  )
		  =
		  (SELECT NVL(PRA.UPD_CONTRACT_START_DATE, PR.UPD_CONTRACT_START_DATE) NEW1,
		    NVL(PRA.UPD_CONTRACT_END_DATE,PR.UPD_CONTRACT_END_DATE) NEW2,
		    NVL(PRA.estimated_procurement_value, PR.estimated_procurement_value) new3
		  FROM PROCUREMENT PR
		  FULL JOIN PROCUREMENT_ADDENDUM PRA
		  ON PR.PROCUREMENT_ID    = PRA.PROCUREMENT_ID
		  WHERE PR.PROCUREMENT_ID = #{procurementID}
		  )
		WHERE PROCUREMENT_ID = #{procurementID}
  	</update>

	<resultMap id="procurementCoADetailsList" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="id" column="PROCUREMENT_FINANCIALS_ID" />		
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="createdDate" column="CREATED_DATE" />
		<result property="delStatus" column="PCOF_STATUS_ID" />
	</resultMap>
	<!-- R5 Changes starts-->
	<select id="fetchProcurementCoADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean"
		resultMap="procurementCoADetailsList">
		SELECT
		A.PROCUREMENT_FINANCIALS_ID,
		A.UNIT_OF_APPROPRIATION,
		A.BUDGET_CODE,
		A.OBJECT_CODE,
		A.SUB_OBJECT_CODE,
		A.REPORTING_CATEGORY,
		B.FISCAL_YEAR_ID,
		A.AMOUNT,
		A.CREATED_DATE,
		A.MODIFIED_DATE,
		A.PCOF_STATUS_ID
		FROM PROCUREMENT_FINANCIALS A, FISCAL_YEAR B
		WHERE
		A.PROCUREMENT_ID = #{procurementID} 
		AND A.TYPE = #{type}
		AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID 
		and a.version_number = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
		ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE,
		A.OBJECT_CODE,
		A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>

	<!--Build 2.6.1, enhancement id: 5707-->
	<select id="fetchProcurementFundingSourceDetails" parameterType="com.nyc.hhs.model.FundingAllocationBean"
		resultMap="fundSourceDetailsList">
					SELECT id,fundingsrc,
		       SUM(CASE WHEN RN = 1 THEN X END) AS "fy1",
		       SUM(CASE WHEN RN = 2 THEN X END) AS "fy2",
		       SUM(CASE WHEN RN = 3 THEN X END) AS "fy3",
		       SUM(CASE WHEN RN = 4 THEN X END) AS "fy4",
		       SUM(CASE WHEN RN = 5 THEN X END) AS "fy5",
		       SUM(CASE WHEN RN = 6 THEN X END) AS "fy6",
		       SUM(CASE WHEN RN = 7 THEN X END) AS "fy7",
		       SUM(CASE WHEN RN = 8 THEN X END) AS "fy8",
		       SUM(CASE WHEN RN = 9 THEN X END) AS "fy9",
		       SUM(CASE WHEN RN = 10 THEN X END) AS "fy10",
		       SUM(CASE WHEN RN = 11 THEN X END) AS "fy11",
		       SUM(CASE WHEN RN = 12 THEN X END) AS "fy12",
		       SUM(CASE WHEN RN = 13 THEN X END) AS "fy13",
		       SUM(CASE WHEN RN = 14 THEN X END) AS "fy14",
		       SUM(CASE WHEN RN = 15 THEN X END) AS "fy15",
		       SUM(CASE WHEN RN = 16 THEN X END) AS "fy16",
		       SUM(CASE WHEN RN = 17 THEN X END) AS "fy17",
		       SUM(CASE WHEN RN = 18 THEN X END) AS "fy18",
		       SUM(CASE WHEN RN = 19 THEN X END) AS "fy19",
		       SUM(CASE WHEN RN = 20 THEN X END) AS "fy20",
		       SUM(CASE WHEN RN = 21 THEN X END) AS "fy21",
		       SUM(CASE WHEN RN = 22 THEN X END) AS "fy22",
		       SUM(CASE WHEN RN = 23 THEN X END) AS "fy23",
		       SUM(CASE WHEN RN = 24 THEN X END) AS "fy24",
		       SUM(CASE WHEN RN = 25 THEN X END) AS "fy25",
		       SUM(CASE WHEN RN = 26 THEN X END) AS "fy26",
		       SUM(CASE WHEN RN = 27 THEN X END) AS "fy27",
		       SUM(CASE WHEN RN = 28 THEN X END) AS "fy28",
		       SUM(CASE WHEN RN = 29 THEN X END) AS "fy29",
		       SUM(CASE WHEN RN = 30 THEN X END) AS "fy30",
		       SUM(CASE WHEN RN = 31 THEN X END) AS "fy31"
		from (select rn,fy,
		             (case when n.n = 1 then  #{procurementID} || '-Federal'
		                   when n.n = 2 then  #{procurementID} || '-State'
		                   when n.n = 3 then  #{procurementID} || '-City'
		                   when n.n = 4 then  #{procurementID} || '-Other'
		              end) as id,
		             (case when n.n = 1 then  'Federal'
		                   when n.n = 2 then  'State'
		                   when n.n = 3 then  'City'
		                   when n.n = 4 then  'Other'
		              end) as fundingsrc,
		              (case when n.n = 1 then 1
		                   when n.n = 2 then 2
		                   when n.n = 3 then 3
		                   when n.n = 4 then 4
		              end) as orderby,
		             (case when n.n = 1 then x1
		                   when n.n = 2 then x2
		                   when n.n = 3 then x3
		                   when n.n = 4 then x4
		              END) AS X
		      from (
		          select x1,x2,x3,x4,fy, rownum rn
    from(
		      SELECT A.FEDERAL_AMOUNT x1,A.STATE_AMOUNT x2,A.CITY_AMOUNT x3,A.OTHER_AMOUNT x4,A.FISCAL_YEAR_ID fy
		FROM PROCUREMENT_FIN_FUNDING_STREAM A WHERE
		A.PROCUREMENT_ID = #{procurementID}	
		and A.VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
		AND  A.TYPE = #{type}	 
		ORDER BY A.FISCAL_YEAR_ID)) cross join
		            (select 1 as n from dual union all
		             select 2 from dual union all
		             select 3 from dual union all
		             select 4 from dual
		           ) n
		     ) T
		group by id ,fundingsrc, orderby 
		     order by orderby
		
	</select>
	
	<insert id="insertProcurementCoADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		<!-- to insert the Chart of accounts details -->	
		Insert into PROCUREMENT_FINANCIALS 
		(PROCUREMENT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 PCOF_STATUS_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 TYPE, 
		 VERSION_NUMBER)
		 values 
		
		(SEQ_PROCUREMENT_FINANCIALS_ID.nextval,
		#{procurementID},
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYearID},
		#{ammount, jdbcType=VARCHAR},
		#{delStatus, jdbcType=VARCHAR},
		SYSTIMESTAMP,
		'1',
		SYSTIMESTAMP,
		#{modifyByAgency},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{type},
		(select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID}))	
	</insert>

		<insert id="insertProcurementCoADetailsDuplicate" parameterType="com.nyc.hhs.model.CBGridBean">
			INSERT
			INTO PROCUREMENT_FINANCIALS
			  (
				PROCUREMENT_FINANCIALS_ID,
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  )
			SELECT SEQ_PROCUREMENT_FINANCIALS_ID.nextval, 
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				#{type},
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  FROM PROCUREMENT_FINANCIALS
     	WHERE 
        PROCUREMENT_ID = #{procurementID}
        AND TYPE = 'Approved' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
	</insert>

   
     <delete id="deleteRowsWithTypeUpdate" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		delete FROM PROCUREMENT_FINANCIALS where
		procurement_id =  #{procurementId} and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
		AND TYPE = 'Updated'
     </delete>
     
     <delete id="deleteProcFundRowsWithTypeUpdate" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		delete FROM procurement_fin_funding_stream where
		procurement_id =  #{procurementId} and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
		AND TYPE = 'Updated'
     </delete>

     <insert id="insertTaskRowsAsTypeUpdate" parameterType="com.nyc.hhs.model.TaskDetailsBean">
			INSERT
			INTO PROCUREMENT_FINANCIALS
			  (
				PROCUREMENT_FINANCIALS_ID,
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  )
			SELECT SEQ_PROCUREMENT_FINANCIALS_ID.nextval, 
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				'Updated',
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  FROM PROCUREMENT_FINANCIALS
     	WHERE 
        PROCUREMENT_ID = #{procurementId}
        AND TYPE = 'TaskRows' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        </insert>

     <insert id="insertProcFundTaskRowsAsTypeUpdate" parameterType="com.nyc.hhs.model.TaskDetailsBean">
        			INSERT
			INTO PROCUREMENT_FIN_FUNDING_STREAM
			  (
				PROCUREMENT_FUNDING_STREAM_ID,
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				VERSION_NUMBER)
			SELECT SEQ_PROCUREMENT_FUNDING_STM_ID.nextval, 
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				'Updated',
				VERSION_NUMBER
			  FROM PROCUREMENT_FIN_FUNDING_STREAM
     	WHERE 
        PROCUREMENT_ID = #{procurementId}
        AND TYPE = 'TaskRows' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        </insert>
     
	<update id="deleteRowsWithTypeTaskRows" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		<!-- to update/edit the Chart of accounts details -->
		UPDATE PROCUREMENT_FINANCIALS
	    SET active_flag = '0'
        WHERE 
        PROCUREMENT_ID = #{procurementId}
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        AND TYPE = 'TaskRows'
     </update>
     
	<update id="deleteProcFundRowsWithTypeTaskRows" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		<!-- to update/edit the Chart of accounts details -->
		UPDATE procurement_fin_funding_stream
	    SET active_flag = '0'
        WHERE 
        PROCUREMENT_ID = #{procurementId}
        AND TYPE = 'TaskRows'
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
     </update>
     
	<update id="updateStatusForProcurement" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		<!-- to update/edit the Chart of accounts details -->
		UPDATE PROCUREMENT_FINANCIALS
	    SET 
        APPROVED_BY =  #{userId},
        APPROVED_DATE = SYSTIMESTAMP    
        WHERE 
        PROCUREMENT_ID = #{procurementId}
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        AND TYPE = 'TaskRows'
     </update>
	<insert id="insertProcurementFundingSourceDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		<!-- to insert the Funding sources details -->
		Insert into PROCUREMENT_FIN_FUNDING_STREAM 
		(PROCUREMENT_FUNDING_STREAM_ID,
		 PROCUREMENT_ID,
		 FEDERAL_AMOUNT,
		 STATE_AMOUNT,
		 CITY_AMOUNT,
		 OTHER_AMOUNT,
		 FISCAL_YEAR_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 TYPE,
		 VERSION_NUMBER)
		 values 
		
		(SEQ_PROCUREMENT_FUNDING_STM_ID.nextval,
		#{procurementID},
		0,
		0,
		0,
		0,
		#{fiscalYearCounter},
		SYSTIMESTAMP,
		1,
		SYSTIMESTAMP,
		#{modifyByAgency},
		SYSTIMESTAMP,
		#{modifyByAgency},
		#{type},
		(select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID}))
	</insert>
	
	<insert id="copyProcurementFundingSourceDetails" parameterType="com.nyc.hhs.model.CBGridBean">
		<!-- to insert the Funding sources details -->
			INSERT
			INTO PROCUREMENT_FIN_FUNDING_STREAM
			  (
				PROCUREMENT_FUNDING_STREAM_ID,
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				VERSION_NUMBER)
			SELECT SEQ_PROCUREMENT_FUNDING_STM_ID.nextval, 
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				#{type},
				VERSION_NUMBER
			  FROM PROCUREMENT_FIN_FUNDING_STREAM
     	WHERE 
        PROCUREMENT_ID = #{procurementID}
        AND TYPE = 'Approved' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
	</insert>

	<update id="updateProcurementCoADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		<!-- to update/edit the Chart of accounts details -->
		UPDATE PROCUREMENT_FINANCIALS
	    SET 
        UNIT_OF_APPROPRIATION = #{unitOfAppropriation},
        BUDGET_CODE = #{budgetCode},
        OBJECT_CODE = #{objectCode},
        SUB_OBJECT_CODE = #{subOc},
        REPORTING_CATEGORY = #{rc},
        AMOUNT = #{ammount},
        MODIFIED_BY_USERID =  #{modifyByAgency}        
     WHERE fiscal_year_id = #{fiscalYearID}
        AND PROCUREMENT_ID = #{procurementID}
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
		AND TYPE = #{type}
	</update>

	<update id="updateProcurementFundingSourceDetails" parameterType="hashmap">
		<!-- to update/edit the Funding sources details -->
		update PROCUREMENT_FIN_FUNDING_STREAM set ${asQuerySetClause}
		and version_number = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
	</update>

	<delete id="deleteProcurementCoADetails">
		<!-- to delete the Chart of accounts details -->
		delete FROM PROCUREMENT_FINANCIALS where
		(UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id} 
		AND TYPE = #{type}
		and  procurement_id = #{procurementID}
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementID})
	</delete>	
	<!-- R5 Changes ends-->
	<!--Build 2.6.1, enhancement id: 5707-->
	<resultMap id="fundSourceDetailsList" type="com.nyc.hhs.model.FundingAllocationBean">
		<result property="id" column="id" />	
		<result property="fundingSource" column="fundingsrc" />	
		<result property="fy1" column="fy1"/>
		<result property="fy2" column="fy2"/>
		<result property="fy3" column="fy3"/>
		<result property="fy4" column="fy4"/>
		<result property="fy5" column="fy5"/>
		<result property="fy6" column="fy6"/>
		<result property="fy7" column="fy7"/>
		<result property="fy8" column="fy8"/>
		<result property="fy9" column="fy9"/>
		<result property="fy10" column="fy10"/>
		<result property="fy11" column="fy11"/>
		<result property="fy12" column="fy12"/>
		<result property="fy13" column="fy13"/>
		<result property="fy14" column="fy14"/>
		<result property="fy15" column="fy15"/>
		<result property="fy16" column="fy16"/>
		<result property="fy17" column="fy17"/>
		<result property="fy18" column="fy18"/>
		<result property="fy19" column="fy19"/>
		<result property="fy20" column="fy20"/>
		<result property="fy21" column="fy21"/>
		<result property="fy22" column="fy22"/>
		<result property="fy23" column="fy23"/>
		<result property="fy24" column="fy24"/>
		<result property="fy25" column="fy25"/>
		<result property="fy26" column="fy26"/>
		<result property="fy27" column="fy27"/>
		<result property="fy28" column="fy28"/>
		<result property="fy29" column="fy29"/>
		<result property="fy30" column="fy30"/>
		<result property="fy31" column="fy31"/>
	</resultMap>

	<!--Build 2.6.1, enhancement id: 5707-->
	<select id="fetchContractConfFundingDetails" parameterType="String"
		resultMap="fundSourceDetailsList">

		SELECT id,fundingsrc,
		       SUM(CASE WHEN RN = 1 THEN X END) AS "fy1",
		       SUM(CASE WHEN RN = 2 THEN X END) AS "fy2",
		       SUM(CASE WHEN RN = 3 THEN X END) AS "fy3",
		       SUM(CASE WHEN RN = 4 THEN X END) AS "fy4",
		       SUM(CASE WHEN RN = 5 THEN X END) AS "fy5",
		       SUM(CASE WHEN RN = 6 THEN X END) AS "fy6",
		       SUM(CASE WHEN RN = 7 THEN X END) AS "fy7",
		       SUM(CASE WHEN RN = 8 THEN X END) AS "fy8",
		       SUM(CASE WHEN RN = 9 THEN X END) AS "fy9",
		       SUM(CASE WHEN RN = 10 THEN X END) AS "fy10",
		       SUM(CASE WHEN RN = 11 THEN X END) AS "fy11",
		       SUM(CASE WHEN RN = 12 THEN X END) AS "fy12",
		       SUM(CASE WHEN RN = 13 THEN X END) AS "fy13",
		       SUM(CASE WHEN RN = 14 THEN X END) AS "fy14",
		       SUM(CASE WHEN RN = 15 THEN X END) AS "fy15",
		       SUM(CASE WHEN RN = 16 THEN X END) AS "fy16",
		       SUM(CASE WHEN RN = 17 THEN X END) AS "fy17",
		       SUM(CASE WHEN RN = 18 THEN X END) AS "fy18",
		       SUM(CASE WHEN RN = 19 THEN X END) AS "fy19",
		       SUM(CASE WHEN RN = 20 THEN X END) AS "fy20",
		       SUM(CASE WHEN RN = 21 THEN X END) AS "fy21",
		       SUM(CASE WHEN RN = 22 THEN X END) AS "fy22",
		       SUM(CASE WHEN RN = 23 THEN X END) AS "fy23",
		       SUM(CASE WHEN RN = 24 THEN X END) AS "fy24",
		       SUM(CASE WHEN RN = 25 THEN X END) AS "fy25",
		       SUM(CASE WHEN RN = 26 THEN X END) AS "fy26",
		       SUM(CASE WHEN RN = 27 THEN X END) AS "fy27",
		       SUM(CASE WHEN RN = 28 THEN X END) AS "fy28",
		       SUM(CASE WHEN RN = 29 THEN X END) AS "fy29",
		       SUM(CASE WHEN RN = 30 THEN X END) AS "fy30",
		       SUM(CASE WHEN RN = 31 THEN X END) AS "fy31"

		from (select rn,fy,
		             (case when n.n = 1 then  #{asContractId} || '-Federal'
		                   when n.n = 2 then  #{asContractId} || '-State'
		                   when n.n = 3 then  #{asContractId} || '-City'
		                   when n.n = 4 then  #{asContractId} || '-Other'
		              end) as id,
		             (case when n.n = 1 then  'Federal'
		                   when n.n = 2 then  'State'
		                   when n.n = 3 then  'City'
		                   when n.n = 4 then  'Other'
		              end) as fundingsrc,
		              (case when n.n = 1 then 1
		                   when n.n = 2 then 2
		                   when n.n = 3 then 3
		                   when n.n = 4 then 4
		              end) as orderby,
		             (case when n.n = 1 then x1
		                   when n.n = 2 then x2
		                   when n.n = 3 then x3
		                   when n.n = 4 then x4
		              END) AS X
		      from (
		            select x1,x2,x3,x4,fy, rownum rn
    				from(
		      SELECT A.FEDERAL_AMOUNT x1,A.STATE_AMOUNT x2,A.CITY_AMOUNT x3,A.OTHER_AMOUNT x4,A.FISCAL_YEAR_ID fy
		FROM CONTRACT_FIN_FUNDING_STREAM A WHERE
		A.CONTRACT_ID=#{asContractId} AND A.ACTIVE_FLAG='1' 
		ORDER BY A.FISCAL_YEAR_ID)) cross join
		            (select 1 as n from dual union all
		             select 2 from dual union all
		             select 3 from dual union all
		             select 4 from dual
		           ) n
		     ) T
		group by id ,fundingsrc, orderby 
		     order by orderby
	</select>
	
	<!--Insert query for adding the Contract Funding details -->
	<insert id="addContractConfFundingDetails" parameterType="com.nyc.hhs.model.CBGridBean">
	Insert into CONTRACT_FIN_FUNDING_STREAM 
		(CONTRACT_FUNDING_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 FEDERAL_AMOUNT,
		 STATE_AMOUNT,
		 CITY_AMOUNT,
		 OTHER_AMOUNT,
		 FISCAL_YEAR_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FUNDING_ID.nextval,
		#{procurementID,jdbcType=VARCHAR},
		#{contractID},
		0,
		0,
		0,
		0,
		#{fiscalYearCounter},
		SYSTIMESTAMP,
		1,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	
	<update id="editContractConfFundingDetails" parameterType="hashmap">
	update contract_fin_funding_stream set ${asQuerySetClause}
	</update>

	<!--Build 2.6.1, enhancement id: 5707-->
	<select id="fetchContractAmendmentFundingDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="fundSourceDetailsList">
			SELECT id,fundingsrc,
		       SUM(CASE WHEN RN = 1 THEN X END) AS "fy1",
		       SUM(CASE WHEN RN = 2 THEN X END) AS "fy2",
		       SUM(CASE WHEN RN = 3 THEN X END) AS "fy3",
		       SUM(CASE WHEN RN = 4 THEN X END) AS "fy4",
		       SUM(CASE WHEN RN = 5 THEN X END) AS "fy5",
		       SUM(CASE WHEN RN = 6 THEN X END) AS "fy6",
		       SUM(CASE WHEN RN = 7 THEN X END) AS "fy7",
		       SUM(CASE WHEN RN = 8 THEN X END) AS "fy8",
		       SUM(CASE WHEN RN = 9 THEN X END) AS "fy9",
		       SUM(CASE WHEN RN = 10 THEN X END) AS "fy10",
		       SUM(CASE WHEN RN = 11 THEN X END) AS "fy11",
		       SUM(CASE WHEN RN = 12 THEN X END) AS "fy12",
		       SUM(CASE WHEN RN = 13 THEN X END) AS "fy13",
		       SUM(CASE WHEN RN = 14 THEN X END) AS "fy14",
		       SUM(CASE WHEN RN = 15 THEN X END) AS "fy15",
		       SUM(CASE WHEN RN = 16 THEN X END) AS "fy16",
		       SUM(CASE WHEN RN = 17 THEN X END) AS "fy17",
		       SUM(CASE WHEN RN = 18 THEN X END) AS "fy18",
		       SUM(CASE WHEN RN = 19 THEN X END) AS "fy19",
		       SUM(CASE WHEN RN = 20 THEN X END) AS "fy20",
		       SUM(CASE WHEN RN = 21 THEN X END) AS "fy21",
		       SUM(CASE WHEN RN = 22 THEN X END) AS "fy22",
		       SUM(CASE WHEN RN = 23 THEN X END) AS "fy23",
		       SUM(CASE WHEN RN = 24 THEN X END) AS "fy24",
		       SUM(CASE WHEN RN = 25 THEN X END) AS "fy25",
		       SUM(CASE WHEN RN = 26 THEN X END) AS "fy26",
		       SUM(CASE WHEN RN = 27 THEN X END) AS "fy27",
		       SUM(CASE WHEN RN = 28 THEN X END) AS "fy28",
		       SUM(CASE WHEN RN = 29 THEN X END) AS "fy29",
		       SUM(CASE WHEN RN = 30 THEN X END) AS "fy30",
		       SUM(CASE WHEN RN = 31 THEN X END) AS "fy31"
		from (select rn,fy,
		             (case when n.n = 1 then  #{contractID} || '-Federal'
		                   when n.n = 2 then  #{contractID} || '-State'
		                   when n.n = 3 then  #{contractID} || '-City'
		                   when n.n = 4 then  #{contractID} || '-Other'
		              end) as id,
		             (case when n.n = 1 then  'Federal'
		                   when n.n = 2 then  'State'
		                   when n.n = 3 then  'City'
		                   when n.n = 4 then  'Other'
		              end) as fundingsrc,
		              (case when n.n = 1 then 1
		                   when n.n = 2 then 2
		                   when n.n = 3 then 3
		                   when n.n = 4 then 4
		              end) as orderby,
		             (case when n.n = 1 then x1
		                   when n.n = 2 then x2
		                   when n.n = 3 then x3
		                   when n.n = 4 then x4
		              END) AS X
		      from (
		           select x1,x2,x3,x4,fy, rownum rn
    				from(
		      SELECT A.FEDERAL_AMOUNT x1,A.STATE_AMOUNT x2,A.CITY_AMOUNT x3,A.OTHER_AMOUNT x4,A.FISCAL_YEAR_ID fy
		FROM CONTRACT_FIN_FUNDING_STREAM A WHERE
		A.CONTRACT_ID = #{amendmentContractID}
		AND A.ACTIVE_FLAG='1' 
		ORDER BY A.FISCAL_YEAR_ID)) cross join
		            (select 1 as n from dual union all
		             select 2 from dual union all
		             select 3 from dual union all
		             select 4 from dual
		           ) n
		     ) T
		group by id ,fundingsrc, orderby 
		     order by orderby
	</select>
	
	<!--Insert query for adding the Contract Funding details -->
	<insert id="addContractAmendmentFundingDetails" parameterType="com.nyc.hhs.model.CBGridBean">
	Insert into CONTRACT_FIN_FUNDING_STREAM 
		(CONTRACT_FUNDING_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 FEDERAL_AMOUNT,
		 STATE_AMOUNT,
		 CITY_AMOUNT,
		 OTHER_AMOUNT,
		 FISCAL_YEAR_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FUNDING_ID.nextval,
		#{procurementID,jdbcType=VARCHAR},
		#{amendmentContractID}, 	
		0,
		0,
		0,
		0,
		#{fiscalYearCounter},
		SYSTIMESTAMP,
		1,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	
	<update id="editContractAmendmentFundingDetails" parameterType="hashmap">
	update contract_fin_funding_stream set ${asQuerySetClause}
	</update>
	<resultMap id="CoADetailsList" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="id" column="CONTRACT_FINANCIALS_ID" />
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modifiedDate" column="MODIFIED_DATE" />
		<result property="newFYFiscalYearId" column="NEW_FY_FISCAL_YEAR_ID" />
		<result property="createdDate" column="CREATED_DATE" />
	</resultMap>
	
	
	<select id="fetchContractConfCOADetails" parameterType="com.nyc.hhs.model.CBGridBean"
	resultMap="CoADetailsList">
		SELECT
	     A.CONTRACT_FINANCIALS_ID,
	     A.UNIT_OF_APPROPRIATION,
	     A.BUDGET_CODE,
	     A.OBJECT_CODE,
	   	 A.SUB_OBJECT_CODE,
	   	 A.REPORTING_CATEGORY,
	   	 B.FISCAL_YEAR_ID,
	   	 A.AMOUNT,
	   	 A.CREATED_DATE,
	   	 A.NEW_FY_FISCAL_YEAR_ID
		 FROM CONTRACT_FINANCIALS A, 
	   		  FISCAL_YEAR B
		 WHERE
	   		  A.CONTRACT_ID = #{contractID}
	   	  AND A.ACTIVE_FLAG='1'
	      AND A.contract_financials_id = A.parent_id 
	   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
		  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>	

	<select id="fetchContractConfCOADeletedRows" parameterType="com.nyc.hhs.model.AccountsAllocationBean"
	resultMap="CoADetailsList">
		SELECT
	     A.CONTRACT_FINANCIALS_ID,
	     A.UNIT_OF_APPROPRIATION,
	     A.BUDGET_CODE,
	     A.OBJECT_CODE,
	   	 A.SUB_OBJECT_CODE,
	   	 A.REPORTING_CATEGORY,
	   	 A.AMOUNT,
	   	 A.CREATED_DATE,
	   	 A.NEW_FY_FISCAL_YEAR_ID
		 FROM CONTRACT_FINANCIALS A 
		 WHERE
	   		  A.CONTRACT_ID = 
	   		  <choose>
				<when test="contractTypeId != null and contractTypeId==2">
					#{amendmentContractID}
				</when>
				<when test="contractTypeId != null and contractTypeId==4">
					(SELECT contract_id
					FROM contract
					WHERE parent_contract_id=#{contractID}
					AND contract_id        !=#{contractID}
					AND contract_type_id    =#{contractTypeId}
					AND delete_flag = '0')
				</when>
				<otherwise>#{contractID}</otherwise>
			  </choose>
	   		  
	   	  AND A.ACTIVE_FLAG='0'
	   	  AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = 
	   	  (#{unitOfAppropriation} || '-' || #{budgetCode} || '-' || #{objectCode} || '-' || #{subOc} || '-' || #{rc}) 
		  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY
	</select>	
	
		<select id="fetchContractConfCOADetailsAmendment" parameterType="com.nyc.hhs.model.CBGridBean"
			resultMap="CoADetailsList">
			SELECT
		     A.CONTRACT_FINANCIALS_ID,
		     A.UNIT_OF_APPROPRIATION,
		     A.BUDGET_CODE,
		     A.OBJECT_CODE,
		   	 A.SUB_OBJECT_CODE,
		   	 A.REPORTING_CATEGORY,
		   	 B.FISCAL_YEAR_ID,
		   	 A.AMOUNT,
		   	 A.CREATED_DATE,
		   	 A.NEW_FY_FISCAL_YEAR_ID
			 FROM CONTRACT_FINANCIALS A, 
		   		  FISCAL_YEAR B
			 WHERE
		   		  A.CONTRACT_ID = #{contractID}
		   		  
		   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
			  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
		</select>	

		<select id="fetchContractConfCOAOriginalDetails" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="CoADetailsList">
			SELECT
		     A.CONTRACT_FINANCIALS_ID,
		     A.UNIT_OF_APPROPRIATION,
		     A.BUDGET_CODE,
		     A.OBJECT_CODE,
		   	 A.SUB_OBJECT_CODE,
		   	 A.REPORTING_CATEGORY,
		   	 B.FISCAL_YEAR_ID,
		   	 A.AMOUNT,
		   	 A.CREATED_DATE,
		   	 A.NEW_FY_FISCAL_YEAR_ID
			 FROM CONTRACT_FINANCIALS A, 
		   		  FISCAL_YEAR B
			 WHERE
		   		  A.CONTRACT_ID =  (select CONTRACT_ID from CONTRACT where PARENT_CONTRACT_ID = #{contractID} and CONTRACT_TYPE_ID = '6')
		   	  AND A.ACTIVE_FLAG='1'
		   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
			  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>	

	<select id="fetchContractConfCurrCOADetails" parameterType="com.nyc.hhs.model.CBGridBean"
	resultMap="CoADetailsList">
	SELECT
     A.CONTRACT_FINANCIALS_ID || '_current' as CONTRACT_FINANCIALS_ID ,
     A.UNIT_OF_APPROPRIATION,
     A.BUDGET_CODE,
     A.OBJECT_CODE,
   	 A.SUB_OBJECT_CODE,
   	 A.REPORTING_CATEGORY,
   	 B.FISCAL_YEAR_ID,
   	 A.AMOUNT,
	 A.CREATED_DATE
	 FROM CONTRACT_FINANCIALS A, 
   		  FISCAL_YEAR B
	 WHERE
   		  A.CONTRACT_ID = #{contractID}
   	  AND A.ACTIVE_FLAG='1'
      AND A.contract_financials_id = A.parent_id 
   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
	  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
</select>	

	<insert id="addContractConfCOADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		Insert into CONTRACT_FINANCIALS 
		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 NEW_FY_FISCAL_YEAR_ID)
		 values 
		
		(SEQ_CONTRACT_FINANCIALS_ID.nextval,
		#{procurementID,jdbcType=NUMERIC},
		#{contractID},
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYearID},
		#{ammount},
		SYSTIMESTAMP,
		#{activeFlag},
		SEQ_CONTRACT_FINANCIALS_ID.currval,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId},
		#{newFYFiscalYearId,jdbcType=NUMERIC})
	</insert>

	<select id="fetchR2ContractConfCOADetails" parameterType="com.nyc.hhs.model.CBGridBean"
	resultMap="CoADetailsList">
	SELECT
     A.CONTRACT_FINANCIALS_ID,
     A.UNIT_OF_APPROPRIATION,
     A.BUDGET_CODE,
     A.OBJECT_CODE,
   	 A.SUB_OBJECT_CODE,
   	 A.REPORTING_CATEGORY,
   	 B.FISCAL_YEAR_ID,
   	 A.AMOUNT,
     A.CREATED_DATE,
   	 A.NEW_FY_FISCAL_YEAR_ID
	 FROM CONTRACT_FINANCIALS A, 
   		  FISCAL_YEAR B
	 WHERE
   		  A.CONTRACT_ID = #{contractID}
      AND A.contract_financials_id = A.parent_id 
   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
	  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR
</select>	

	<update id="delContractConfCOADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	 update CONTRACT_FINANCIALS
	 set ACTIVE_FLAG = '0'
	 where
        contract_financials_id = parent_id 
     	AND
		(UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
		AND 
		 CONTRACT_ID = #{contractID}
	</update>
	
	<update id="editContractConfCOADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials
	    SET 
        UNIT_OF_APPROPRIATION = #{unitOfAppropriation},
        BUDGET_CODE = #{budgetCode},
        OBJECT_CODE = #{objectCode},
        SUB_OBJECT_CODE = #{subOc},
        REPORTING_CATEGORY = #{rc},
        AMOUNT = #{ammount},
        <if test="deletedRecord != null and deletedRecord==true">
		CREATED_DATE = SYSTIMESTAMP,
		</if>
        
        MODIFIED_DATE = SYSTIMESTAMP,
		MODIFIED_BY_USERID = #{modifiedByUserId},
		ACTIVE_FLAG = 1
     WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = #{contractID}
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
	</update>
	
	<select id="fetchAmendmentAmountExceptChangedOne" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="BigDecimal">
	SELECT SUM(amount)
	FROM contract_financials
	 WHERE fiscal_year_id = #{fiscalYearID}
        AND ((contract_id = #{amendmentContractID}
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) != #{id})
        OR 
        (contract_id in (select contract_id from contract where contract_amount &lt; 0 and
		contract_type_id=2 and parent_contract_id=#{contractID} and status_id!=69 and contract_id!=#{amendmentContractID})))
        and active_flag='1'
    </select>
    
    <select id="fetchFiscalYearAmount" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="BigDecimal">
        select 
        	sum(amount)
        from
        	contract_financials 
        where
        	contract_id = #{contractID}
        and fiscal_year_id = #{fiscalYearID}
		and active_flag = '1'
    </select>
    <!-- Start Created query for enhancement  6414 release 3.10.0 -->
     <select id="fetchFiscalYearAmountUpdateConf" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="BigDecimal">
        select 
        	NVL(sum(amount),0)
        from
        	contract_financials 
        WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = (select contract_id from contract where parent_contract_id=#{contractID}and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} 
        and delete_flag=0) 
        and active_flag = '1'
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) != #{id}
    </select>
    <!-- End Created query for enhancement  6414 release 3.10.0 -->
	<resultMap id="ContractConfigDetails" type="com.nyc.hhs.model.ProcurementCOF">
		<result property="procurementId" column="PROCUREMENT_ID" />
		<result property="procurementValue" column="ESTIMATED_PROCUREMENT_VALUE" />
		<result property="contractStartDate" column="CONTRACT_START_DATE" />
		<result property="contractEndDate" column="CONTRACT_END_DATE" />
		<result property="contractValue" column="CONTRACT_AMOUNT" />
		<result property="compPoolTitle" column="COMPETITION_POOL_TITLE" />
	</resultMap>

	<select id="fetchContractConfigDetails" parameterType="map"
		resultMap="ContractConfigDetails">
		SELECT P.ESTIMATED_PROCUREMENT_VALUE,  epm.COMPETITION_POOL_TITLE
		FROM PROCUREMENT P, CONTRACT C, (select epm.evaluation_pool_mapping_id, cp.competition_pool_title
		from EVALUATION_POOL_MAPPING EPM,
        COMPETITION_POOL CP where 
     	EPM.COMPETITION_POOL_ID = CP.COMPETITION_POOL_ID) epm 
		where
		P.PROCUREMENT_ID(+) = c.PROCUREMENT_ID
    	and c.evaluation_pool_mapping_id = epm.evaluation_pool_mapping_id(+)
    	AND C.CONTRACT_ID = #{asContractId}
	</select>

<!-- R6: non apt epins query changed -->
	<select id="fetchContractConfigDetailsForR3Contract" parameterType="map"
		resultMap="ContractConfigDetails">
		SELECT AWARD_AMOUNT as ESTIMATED_PROCUREMENT_VALUE
		FROM ref_apt_epin_master
		WHERE ref_apt_epin_id =
		(SELECT procurement_epin_id
		FROM ref_apt_epin_master
		WHERE ref_apt_epin_id =
		(SELECT ref_apt_epin_id FROM contract WHERE contract_id=#{asContractId}
		)
		)
	</select>
		
	<!--Observation Changes Release 3.4.0-->
	<select id="fetchContractConfSubBudgetDetails" parameterType="HashMap"
		resultMap="subBudgetDetailsList">
    	SELECT
		B.BUDGET_ID,
		s.sub_budget_name, 
		s.sub_budget_amount,
    	s.fiscal_year_id
    		FROM BUDGET B
     		INNER join CONTRACT C 
      		  on B.CONTRACT_ID = C.CONTRACT_ID
     		INNER join SUB_BUDGET S
      		  on B.BUDGET_ID = S.BUDGET_ID
      		WHERE C.CONTRACT_ID = #{asContractId}
        	  AND B.BUDGET_TYPE_ID = 2
			ORDER BY S.SUB_BUDGET_ID      
	</select>	
	
 
	<select id="fetchCountOfTaskApproved" parameterType="com.nyc.hhs.model.TaskDetailsBean" resultType="int">
		select count(1) from contract_cert_of_funds where procurement_id = #{procurementId} and proc_status_id not in(select status_id from status_master_r2_r3 where process_type = 'Task' and status = 'Complete')
	</select>

	<update id="updateAmendmentContractStatus" parameterType="java.util.Map" >
	update contract set status_id='128' where contract_id = #{contractId}
	</update>
	

	<insert id="insertPdfBatchForAmendmentCof" parameterType="java.util.HashMap" >
		INSERT
		INTO PDF_BATCH_DETAILS
	  	(
	    ENTITY_TYPE,
	    SUB_ENTITY_TYPE,
	    ENTITY_ID,
	    SUB_ENTITY_ID,
	    LAST_PICKED_TIME,
	    STATUS,
	    CREATED_BY_USER_ID,
	    MODIFIED_BY_USER_ID,
	    CREATED_DATE,
	    MODIFIED_DATE,
	    PDF_BATCH_DETAILS_ID
	 	 )
	 	 VALUES
	  	(
		   #{newEntityType},
		    #{subEntityType},
		    #{newEntityId},
		    #{subEntityId},
		    null,
		    #{status},
		   #{userId},
		    #{userId},
		    systimestamp,
		    systimestamp,
		    SEQ_PDF_BATCH_ID.nextval
		  )
	</insert>
	

	<update id="updateAmendmentContractStatusCoF" parameterType="java.util.HashMap" >
	update contract set status_id=#{statusId} where contract_id = #{contractId}
	</update>
	
	<update id="updateAmendmentBudgetStatus" parameterType="com.nyc.hhs.model.TaskDetailsBean" >
	update budget set status_id=84 where budget_id in (select budget_id from budget where budget_type_id='1' and active_flag='1' 
	and contract_id = #{contractId}
	<!-- start release 3.14.0 -->
	and parent_id  not in (select budget_id from budget where contract_id in  (select parent_contract_id from contract where contract_id = #{contractId} ) and status_id = 106 and active_flag = '1')
	<!-- end release 3.14.0 -->
	)
	</update>
	
	<!-- start release 3.14.0 -->
	<update id="updateAmendmentBudgetStatusNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean" >
	update budget set status_id=84 where parent_id in (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear} AND active_flag = 1)
	and budget_type_id = 1 and status_id = 106 and active_flag=1
	and contract_id not in (
	<!-- 
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	ext_epin in (select distinct trkg_no from ref_contracts_h) and delete_flag = 0)
	union
	 --> 
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	status_id = 60 and delete_flag = 0)
	)
	</update>
	
	<select id="selectAmendmentBudgetStatusNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="string">
	select contract_id from budget where parent_id in (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear} AND active_flag = 1)
	and budget_type_id = 1 and status_id = 106 and active_flag=1
	and contract_id not in (
	<!-- 
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	ext_epin in (select distinct trkg_no from ref_contracts_h) and delete_flag = 0)
	union
	 --> 
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	status_id = 60 and delete_flag = 0)
	)
	</select>
	<update id="updateAmendmentContractStatusNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean" >
	update contract set status_id=128 where contract_id in (
	select contract_id from budget where parent_id in (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear} AND active_flag = 1)
	and budget_type_id = 1 and status_id = 106 and active_flag=1
	and contract_id not in (
	<!-- 
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	ext_epin in (select distinct trkg_no from ref_contracts_h) and delete_flag = 0)
	union 
	-->
	(select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	status_id = 60 and delete_flag = 0)
	)
	)
	</update>
	
	<update id="updateAmendmentRegisteredInFMSBudgetStatusNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean" >
	update budget set active_flag =0, delete_flag = 1 where parent_id in 
	(select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear} AND active_flag = 1)
	and budget_type_id = 1 and status_id = 106
	and contract_id in (select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	ext_epin in (select distinct trkg_no from ref_contracts_h) and delete_flag = 0)
	</update>
	
	<select id="budgetAmendmentRegisteredInFms" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultMap="contractBudgetAmendFYDetails">
	select budget_id,contract_id from budget where 
	<!-- parent_id in (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear} AND active_flag = 1) -->
	fiscal_year_id = #{budgetfiscalYear}
	AND contract_id = #{amendmentContractId}
	and budget_type_id = 1 and status_id = 106
	and contract_id in (select contract_id from contract where parent_contract_id = #{contractId} and contract_type_id =2 and 
	(ext_epin in (select distinct trkg_no from ref_contracts_h) or REQUEST_PARTIAL_MERGE = 1) and delete_flag = 0)
	<!--Added in R7 for defect 8644 (or REQUEST_PARTIAL_MERGE = 1) -->
	</select>
	
	<insert id="mergeContractForAmendmentFMSRegisteredContractNextNewFY" parameterType="java.util.Map">
		MERGE INTO CONTRACT A
				Using (
		 WITH REF_CONTRACT_TEMP AS 
		(SELECT CONTRACT_ID, CONTRACT_AMOUNT FROM CONTRACT WHERE CONTRACT_ID = #{parentContractId}),
		REF_CONTRACT_FINANCIALS_TEMP AS
		(SELECT B.PARENT_CONTRACT_ID,SUM(A.AMOUNT) AS CF_AMOUNT FROM CONTRACT_FINANCIALS A,CONTRACT B WHERE A.CONTRACT_ID = #{contractId}  
		AND B.CONTRACT_ID = A.CONTRACT_ID AND A.ACTIVE_FLAG = 1
		AND A.FISCAL_YEAR_ID =#{asFiscalYearId} 
		GROUP BY B.PARENT_CONTRACT_ID)
		SELECT SUM(CF_AMOUNT+CONTRACT_AMOUNT) as NEW_TOTAL_CONTRACT_AMOUNT, PARENT_CONTRACT_ID FROM REF_CONTRACT_TEMP , REF_CONTRACT_FINANCIALS_TEMP WHERE PARENT_CONTRACT_ID  = CONTRACT_ID
		group by PARENT_CONTRACT_ID
		) N
		ON ( A.CONTRACT_ID = N.PARENT_CONTRACT_ID)
		WHEN MATCHED THEN UPDATE SET CONTRACT_AMOUNT = NEW_TOTAL_CONTRACT_AMOUNT
		,A.MODIFIED_DATE=systimestamp,A.MODIFIED_BY_USERID = #{modifyBy} 
  	 </insert>
  	
	
	<insert id="mergeContractFinancialForAmendmentFMSRegisteredContractNextNewFY" parameterType="java.util.Map">
	Merge Into contract_FINANCIALS A
	Using (Select B.contract_FINANCIALS_id As Id,B.AMOUNT As originalamount, C.AMOUNT As modamount 
	From contract_FINANCIALS B, contract_FINANCIALS C Where B.contract_FINANCIALS_id = C.Parent_Id And B.contract_Id != C.contract_Id
	and C.contract_Id = #{contractId} and C.Active_Flag = '1' and C.FISCAL_YEAR_ID =#{asFiscalYearId} 
	) N
	On (A.contract_FINANCIALS_id = N.Id)
	when matched then update set AMOUNT = N.originalamount + N.modamount,previous_amount=N.originalamount + N.modamount
	,MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID = #{modifyBy}
  	</insert>
  	
  		<insert id="createContractFinancialReplicaFMSRegisteredContractNextNewFY" parameterType="java.util.Map">
  	INSERT INTO
		CONTRACT_FINANCIALS
 		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
         APPROVED_BY,
     	 APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         previous_amount)
      (
      SELECT SEQ_CONTRACT_FINANCIALS_ID.nextval,
		 PROCUREMENT_ID,
		 #{parentContractId},
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
         DOCUMENT_IDENTIFIER_ID,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 SEQ_CONTRACT_FINANCIALS_ID.currval,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 systimestamp MODIFIED_DATE,#{modifyBy} MODIFIED_BY_USERID,
         APPROVED_BY,
         APPROVED_DATE,
         NEW_FY_FISCAL_YEAR_ID,
         AMOUNT as previous_amount
         FROM CONTRACT_FINANCIALS WHERE CONTRACT_ID = #{contractId} and CONTRACT_FINANCIALS_ID = PARENT_ID AND ACTIVE_FLAG = 1 AND FISCAL_YEAR_ID =#{asFiscalYearId} 
        )
   </insert>
   
   <update id="markContractFinancialAsDeletedFMSRegisteredContractNextNewFY" parameterType="java.util.Map">
		UPDATE CONTRACT_FINANCIALS SET ACTIVE_FLAG='0',MODIFIED_DATE=systimestamp,MODIFIED_BY_USERID=#{modifyBy}
		WHERE CONTRACT_ID = #{contractId}  AND FISCAL_YEAR_ID =#{asFiscalYearId} 
	</update>
	
	<select id="getParentSubBudgetCount" parameterType="java.util.Map" resultType="int">
	select count(sub_budget_id) from sub_budget where parent_id = #{asSubBudgetID}
	</select>
	
	
	<!--Query Updated in R7 for defect 8797  -->
	<update id="updateSubbudgetForCancelConfigureNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	MERGE INTO sub_budget s
	USING (select b.sub_budget_id,s.parent_id,s.SUB_BUDGET_NAME,s.fiscal_year_id as base_fy,b.fiscal_year_id as cancel_fy from sub_budget s,
	(select sub_budget_id,parent_id,fiscal_year_id from sub_budget WHERE BUDGET_ID = (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear})) b
	where s.sub_budget_id=b.parent_id) h
	on (s.sub_budget_id=h.sub_budget_id)
	when MATCHED THEN
	UPDATE SET s.SUB_BUDGET_AMOUNT=0,
	s.SUB_BUDGET_NAME=h.SUB_BUDGET_NAME
	</update>

	<update id="updateBudgetForCancelConfigureNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE BUDGET set FISCAL_YEAR_AMOUNT = 0
		WHERE CONTRACT_ID = #{contractId} AND fiscal_year_id = #{budgetfiscalYear}
	</update>
	
	<select id="subBudgetExistingAmendmentErrorCheck" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="int">
	select count(sub_budget_id) from sub_budget s, budget b where s.budget_id!=#{budgetId} and s.parent_id =#{id} and s.active_flag=1 
	and b.budget_id = s.budget_id  and b.status_id !=89
	</select>
	
	<select id="getAmendmentStartEndDate" parameterType="string" resultType="hashmap">
	 select  TO_CHAR ( b.contract_start_date, 'MM/dd/yyyy') CONTRACT_START_DATE , TO_CHAR (a.PROPOSED_CONTRACT_END_DATE, 'MM/dd/yyyy')
	 contract_end_date,TO_CHAR (b.contract_end_date, 'MM/dd/yyyy')
	 orignal_contract_end_date from contract a,contract b where a.contract_id=#{asAmendmentContractId} and a.parent_contract_id= b.contract_id and rownum=1
	</select>
	
	<!-- end release 3.14.0 -->
		
	<update id="updateContractStatus" parameterType="com.nyc.hhs.model.TaskDetailsBean" >
       UPDATE CONTRACT SET STATUS_ID =(select STATUS_ID from STATUS_MASTER_R2_R3 where PROCESS_TYPE = 'Contract' AND STATUS = 'Pending Registration'),MODIFIED_DATE = current_timestamp ,MODIFIED_BY_USERID = #{userId,jdbcType=VARCHAR} 
       WHERE CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
	</update>
	<update id="updateContractStatusCof" parameterType="com.nyc.hhs.model.TaskDetailsBean" >
       UPDATE CONTRACT SET STATUS_ID ='60',MODIFIED_BY_USERID = #{userId,jdbcType=VARCHAR} 
       WHERE CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
	</update>
	<update id="updateContractStatusToPendingConfig" parameterType="com.nyc.hhs.model.TaskDetailsBean" >
       UPDATE CONTRACT SET STATUS_ID =(select STATUS_ID from STATUS_MASTER_R2_R3 where PROCESS_TYPE = 'Contract' AND STATUS = 'Pending Configuration'),MODIFIED_DATE = current_timestamp ,MODIFIED_BY_USERID = #{userId,jdbcType=VARCHAR} 
       WHERE CONTRACT_ID = #{contractId,jdbcType=VARCHAR}
	</update>	
	
	
	<resultMap id="subBudgetDetailsList" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="id" column="SUB_BUDGET_ID" />
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subbudgetName" column="SUB_BUDGET_NAME" />
		<result property="subbudgetAmount" column="SUB_BUDGET_AMOUNT" />
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
		<result property="parentId" column="PARENT_ID" />
	</resultMap>
	
    <resultMap id="contractBudgetAmendFYDetails" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="id" column="SUB_BUDGET_ID" />
		<result property="amendAmt" column="AMEND_AMT" />
		<result property="posAmendAmt" column="POS_AMEND_AMT" />
		<result property="negAmendAmt" column="NEG_AMEND_AMT" />
		<result property="totalbudgetAmount" column="TOT_BUDGET_AMT" />
		<result property="parentId" column="PARENT_ID" />
		<result property="contractId" column="CONTRACT_ID" />
		<result property="budgetId" column="BUDGET_ID" />
	</resultMap>

	<select id="fetchContractConfSubBudgetDetailsOld" parameterType="HashMap"
		resultMap="subBudgetDetailsList">
    	SELECT
		s.SUB_BUDGET_ID,
		B.BUDGET_ID,
		S.SUB_BUDGET_NAME, 
		S.SUB_BUDGET_AMOUNT,
    	S.FISCAL_YEAR_ID
    		FROM BUDGET B
     		INNER join CONTRACT C 
      		  on B.CONTRACT_ID = C.CONTRACT_ID
     		INNER join SUB_BUDGET S
      		  on B.BUDGET_ID = S.BUDGET_ID
      		WHERE C.CONTRACT_ID = #{asContractId}
        	  AND B.BUDGET_TYPE_ID = 2
			ORDER BY S.FISCAL_YEAR_ID      
	</select>
	
	<resultMap id="budgetDetailsList" type="com.nyc.hhs.model.ContractBudgetBean">		
		<result property="budgetId" column="BUDGET_ID" />		
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />		
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
		<result property="budgetTypeId" column="BUDGET_TYPE_ID" />
		<result property="totalbudgetAmount" column="FISCAL_YEAR_AMOUNT" />
		
	</resultMap>

    <select id="fetchBudgetDetailsByFYAndContractId" parameterType="HashMap" resultMap="budgetDetailsList">
    	SELECT BUDGET_ID, BUDGET_TYPE_ID, CONTRACT_ID, FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT FROM BUDGET WHERE CONTRACT_ID = #{asContractId}  AND FISCAL_YEAR_ID=#{asFiscalYearId} and BUDGET_TYPE_ID='2'
	</select>
	
	<!-- start release 3.14.0 -->
	 <select id="getNextNewFYBudgetDetails" parameterType="HashMap" resultMap="budgetDetailsList">
	SELECT BUDGET_ID, BUDGET_TYPE_ID, CONTRACT_ID, FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT FROM BUDGET WHERE CONTRACT_ID = #{asContractId}  AND FISCAL_YEAR_ID=#{asFiscalYearId}
	and BUDGET_TYPE_ID='2' and active_flag='1' and status_id = 106
	</select>
	<!-- end release 3.14.0 -->
	
	<!-- Change done for enhancement 6601 release 3.12.0 -->
	 <select id="fetchBudgetDetailsActiveOrApproved" parameterType="HashMap" resultMap="budgetDetailsList">
	SELECT BUDGET_ID, BUDGET_TYPE_ID, CONTRACT_ID, FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT FROM BUDGET WHERE CONTRACT_ID = #{asContractId}  AND FISCAL_YEAR_ID=#{asFiscalYearId}
	and BUDGET_TYPE_ID='2' and active_flag='1' and status_id != 106
	union
	SELECT BUDGET_ID, BUDGET_TYPE_ID, CONTRACT_ID, FISCAL_YEAR_ID,FISCAL_YEAR_AMOUNT FROM BUDGET WHERE CONTRACT_ID = #{asContractId}  AND FISCAL_YEAR_ID=#{asFiscalYearId}
	and BUDGET_TYPE_ID='2' and status_id=86
	</select>
	
	<select id="fetchAmendmentBudgetDetails" parameterType="HashMap" resultMap="budgetDetailsList">
    	SELECT 
    		BUDGET_ID, 
    		BUDGET_TYPE_ID, 
    		CONTRACT_ID, 
    		FISCAL_YEAR_ID,
    		FISCAL_YEAR_AMOUNT 
    	FROM 
    		BUDGET 
    	WHERE 
    		CONTRACT_ID = #{asAmendContractId} 
    	AND FISCAL_YEAR_ID=#{asFiscalYearId} and BUDGET_TYPE_ID='1'
	</select>
	

	<select id="fetchContractConfSubBudgetDetails1" parameterType="HashMap"
	resultMap="subBudgetDetailsList">
	SELECT
	s.SUB_BUDGET_ID,
	B.BUDGET_ID,
	s.sub_budget_name,
	s.sub_budget_amount,
	s.parent_id,
	s.fiscal_year_id
	FROM BUDGET B
	INNER join CONTRACT C
	on B.CONTRACT_ID = C.CONTRACT_ID
	INNER join SUB_BUDGET S
	on B.BUDGET_ID = S.BUDGET_ID
	WHERE C.CONTRACT_ID = #{asContractId} AND S.FISCAL_YEAR_ID=#{asFiscalYearId}
	AND B.BUDGET_TYPE_ID = 2
	ORDER BY S.SUB_BUDGET_ID DESC
	</select>	

	<!-- changed query as part of build 3.1.0, enhancement id 6020-->
	<insert id="insertContractConfSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	PARENT_ID,
	FISCAL_YEAR_ID,	
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID)
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	#{budgetId},
	SEQ_SUB_BUDGET_ID.CURRVAL,
	(select fiscal_year_id from budget where budget_id = #{budgetId}),
	#{subbudgetName},
	#{subbudgetAmount},
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>	
	<insert id="insertContractConfSubBudgetDetailsWithParentId" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	PARENT_ID,
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	#{budgetId},
	#{budgetfiscalYear},
	#{parentId},
	#{subbudgetName},
	#{subbudgetAmount},
	SYSTIMESTAMP,
	'1',
	(SELECT created_date FROM  SUB_BUDGET WHERE SUB_BUDGET_ID = #{parentId} and rownum = 1),
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>	
	
	<!-- Query added as a part of release 7 for defect 8831 - will update sub budget name -->
	<update id="updateSubBudgetName" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE SUB_BUDGET
	SET SUB_BUDGET_NAME = #{subbudgetName}
	WHERE sub_budget_id =#{budgetId}
  	</update>
  
	<update id="editContractConfSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE SUB_BUDGET SET SUB_BUDGET_NAME = #{subbudgetName}, SUB_BUDGET_AMOUNT =#{subbudgetAmount}, MODIFIED_DATE = SYSTIMESTAMP WHERE SUB_BUDGET_ID = #{id}
	</update>	
	
	<update id="editContractConfSubBudgetDetails1" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE SUB_BUDGET SET SUB_BUDGET_AMOUNT =#{subbudgetAmount} WHERE SUB_BUDGET_ID = #{id}
	</update>
	
	<!-- start release 3.14.0 -->
	<delete id="delContractConfSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		 DELETE FROM SUB_BUDGET WHERE (parent_id = #{id} or sub_budget_id = #{id})
	</delete>
	<!-- end release 3.14.0 -->
	
	<resultMap id="subBudgetsSumTotalResultMap" type="HashMap">
		<result property="totalBudgetAmount" column="TOTAL_BUDGET_AMOUNT" />		
	</resultMap>
	
	<select id="getSubBudgetsSumTotal" parameterType="HashMap" resultType="string">
    	SELECT SUM(SUB_BUDGET_AMOUNT) AS TOTAL_BUDGET_AMOUNT FROM SUB_BUDGET WHERE BUDGET_ID=#{asBudgetId} AND SUB_BUDGET_ID != #{asSubBudgetId}
	</select>
	
	<!-- build 2.6.0, defect id 5683 -->
	<insert id="insertNewBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">	
		Insert into BUDGET 
		(BUDGET_ID,
		BUDGET_TYPE_ID,
		CONTRACT_ID,
		FISCAL_YEAR_ID,
		FISCAL_YEAR_AMOUNT,
		AGENCY_ID,
		ORGANIZATION_ID,
		PROGRAM_ID,
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		CT_NUMBER,
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		STATUS_ID,
		BUDGET_START_DATE,
		BUDGET_END_DATE,
		LAST_UPDATE_DATE,
		ACTIVE_FLAG,
		DELETE_FLAG,
		PREV_STATUS_ID,
		PARENT_ID,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID
		) 
		values		
		(SEQ_BUDGET_ID.NEXTVAL,
		#{budgetTypeId},
		#{contractId},
		#{budgetfiscalYear},
		#{totalbudgetAmount},
		(SELECT AGENCY_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),	
		(SELECT ORGANIZATION_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),		
		(SELECT PROGRAM_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		(select ext_ct_number from contract where contract_id = (select decode(contract_type_id,3,contract_id,parent_contract_id) from contract where CONTRACT_ID = #{contractId})),
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		#{statusId},
		to_date(#{budgetStartDate},'MM/DD/YYYY'),
		to_date(#{budgetEndDate},'MM/DD/YYYY'),
		SYSTIMESTAMP,
		#{activeFlag},
		'0',		
		'',
		SEQ_BUDGET_ID.CURRVAL,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId}
		)
	</insert>
	
	<insert id="insertNewUpdateBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">	
		Insert into BUDGET 
		(BUDGET_ID,
		BUDGET_TYPE_ID,
		CONTRACT_ID,
		FISCAL_YEAR_ID,
		FISCAL_YEAR_AMOUNT,
		AGENCY_ID,
		ORGANIZATION_ID,
		PROGRAM_ID,
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		CT_NUMBER,
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		STATUS_ID,
		BUDGET_START_DATE,
		BUDGET_END_DATE,
		LAST_UPDATE_DATE,
		ACTIVE_FLAG,
		DELETE_FLAG,
		parent_id,
		PREV_STATUS_ID,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID) 
		values		
		(SEQ_BUDGET_ID.NEXTVAL,
		#{budgetTypeId},
			(select 
				contract_id 
			from 
				contract
			where 
				parent_contract_id=#{contractId} 
			and 
				contract_id!=#{contractId} 
			and 
				contract_type_id=#{contractTypeId}  
			and 
				delete_flag='0'),
		#{budgetfiscalYear},
		#{totalbudgetAmount},
		(SELECT AGENCY_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),	
		(SELECT ORGANIZATION_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),		
		(SELECT PROGRAM_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		(select ext_ct_number from contract where contract_id = (select decode(contract_type_id,3,contract_id,parent_contract_id) from contract where CONTRACT_ID = #{contractId})),
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		#{statusId},
		to_date(#{budgetStartDate},'MM/DD/YYYY'),
		to_date(#{budgetEndDate},'MM/DD/YYYY'),
		SYSTIMESTAMP,
		'1',
		'0',
		#{budgetId},		
		83,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	
	<insert id="insertNewAmendmentBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">	
		Insert into BUDGET 
		(BUDGET_ID,
		BUDGET_TYPE_ID,
		CONTRACT_ID,
		FISCAL_YEAR_ID,
		FISCAL_YEAR_AMOUNT,
		AGENCY_ID,
		ORGANIZATION_ID,
		PROGRAM_ID,
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		CT_NUMBER,
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		STATUS_ID,
		BUDGET_START_DATE,
		BUDGET_END_DATE,
		LAST_UPDATE_DATE,
		ACTIVE_FLAG,
		DELETE_FLAG,
		parent_id,
		PREV_STATUS_ID,
		CREATED_DATE,
		CREATED_BY_USERID,
		MODIFIED_DATE,
		MODIFIED_BY_USERID) 
		values		
		(SEQ_BUDGET_ID.NEXTVAL,
		#{budgetTypeId},
		#{amendmentContractId},
		#{budgetfiscalYear},
		#{totalbudgetAmount},
		(SELECT AGENCY_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),	
		(SELECT ORGANIZATION_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),		
		(SELECT PROGRAM_ID FROM CONTRACT WHERE CONTRACT_ID=#{contractId}),
		<!-- Start Inserted ct number as part of agency outbound /CPR. -->
		(select ext_ct_number from contract where contract_id = (select decode(contract_type_id,3,contract_id,parent_contract_id) from contract where CONTRACT_ID = #{contractId})),
		<!-- End Inserted ct number as part of agency outbound /CPR. -->
		#{statusId},
		to_date(#{budgetStartDate},'MM/DD/YYYY'),
		to_date(#{budgetEndDate},'MM/DD/YYYY'),
		SYSTIMESTAMP,
		'1',
		'0',
		#{budgetId},		
		'',
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	

	<update id="updateBudgetFYTotalBudgetAmount" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE BUDGET SET fiscal_year_amount = #{totalbudgetAmount} WHERE BUDGET_ID = #{budgetId}
	</update>	

	<select id="fetchContractSourceId" parameterType="com.nyc.hhs.model.TaskDetailsBean" resultType="java.lang.String">
		select CONTRACT_SOURCE_ID from CONTRACT where CONTRACT_ID = #{contractId,jdbcType=VARCHAR}		
	</select>			
		<resultMap id="UpdateDetailsList" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="id" column="CONTRACT_FINANCIALS_ID" />
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modifiedDate" column="modified_date" />
		<result property="createdDate" column="created_date" />
	</resultMap>
	
<select id="fetchContractConfUpdateDetails" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="UpdateDetailsList">
SELECT
      A.CONTRACT_FINANCIALS_ID,
	     A.UNIT_OF_APPROPRIATION,
	     A.BUDGET_CODE,
	     A.OBJECT_CODE,
    	 A.SUB_OBJECT_CODE,
    	 A.REPORTING_CATEGORY,
    	 B.FISCAL_YEAR_ID,
    	 A.AMOUNT,
         A.parent_id,
         A.created_date
	 FROM CONTRACT_FINANCIALS A, 
   		  FISCAL_YEAR B
	 WHERE
   		  A.CONTRACT_ID = (select contract_id from contract  where parent_contract_id=#{contractID} and contract_id!=#{contractID} and contract_type_id=#{contractTypeId} and delete_flag=0)
   	  AND A.ACTIVE_FLAG='1'
    AND A.contract_financials_id != A.parent_id 
   	  AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
   	   ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, 
         A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>
		
 <resultMap id="UpdateDetailsListNew" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="id" column="CONTRACT_FINANCIALS_ID_NEW" />
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modifiedDate" column="modified_date" />
		<result property="createdDate" column="created_date" />
	</resultMap>	
<select id="fetchContractConfUpdateNewDetails" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="UpdateDetailsListNew">
	SELECT  A.CONTRACT_FINANCIALS_ID||'_newrecord' AS CONTRACT_FINANCIALS_ID_NEW,
	     A.UNIT_OF_APPROPRIATION,
	     A.BUDGET_CODE,
	     A.OBJECT_CODE,
    	 A.SUB_OBJECT_CODE,
    	 A.REPORTING_CATEGORY,
    	 B.FISCAL_YEAR_ID,
    	 A.AMOUNT,
         A.parent_id,
         A.created_date
         from CONTRACT_FINANCIALS A,  FISCAL_YEAR B
         where A.contract_financials_id = A.parent_id
         And CONTRACT_ID = (select contract_id from contract where parent_contract_id=#{contractID} and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} and delete_flag=0)
          AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
            AND A.ACTIVE_FLAG='1'
             ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, 
         A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>
	
	<!-- Modified as a part of release 3.12.0 Enhancement  6578 to include advances and recouped amount as well-->
	<!-- Made changes for Enhancement  6414 release 3.10.0 -->
	<select id="validateAmendmentAmount" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="BigDecimal">
	Select ( (SELECT (NVL(SUM(invoice_amount),0))
	   FROM invoice_details
	  WHERE invoice_id IN
	  (SELECT invoice_id
	     FROM invoice
	    WHERE budget_id=
	    (SELECT BUDGET_ID
	       FROM budget
	      WHERE contract_id=#{contractID}
	    AND BUDGET_TYPE_ID ='2'
	    AND FISCAL_YEAR_ID =#{fiscalYearID} 
	    AND active_flag    ='1'
	    )
	  AND delete_flag=0
	  AND status_id IN (72,73)
	  )
	AND entry_type_id NOT IN (11,14)
	) -
	(SELECT (NVL(SUM(amount_recouped),0))
	   FROM invoice_advance
	  WHERE invoice_id IN
	  (SELECT invoice_id
	     FROM invoice
	    WHERE budget_id=
	    (SELECT BUDGET_ID
	       FROM budget
	      WHERE contract_id=#{contractID}
	    AND BUDGET_TYPE_ID ='2'
	    AND FISCAL_YEAR_ID =#{fiscalYearID} 
	    AND active_flag    ='1'
	    )
	  AND delete_flag=0
	  AND status_id IN (72,73)
	  )
	) +
	(SELECT (NVL(SUM(amount),0))
	   FROM budget_advance
	  WHERE budget_id = 
	  (SELECT BUDGET_ID
	       FROM budget
	      WHERE contract_id=#{contractID}
	    AND BUDGET_TYPE_ID ='2'
	    AND FISCAL_YEAR_ID =#{fiscalYearID} 
	    AND active_flag    ='1'
	    )
	AND status_id    IN ('92','93','125')
	AND delete_flag   ='0'
	) ) as invoice_amount from dual
	</select>
	
	<select id="fetchContractConfAmendmentDetailsPartialMerging" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="CoADetailsList">
	SELECT count(CONTRACT_FINANCIALS_ID) FISCAL_YEAR_ID,
		  (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) as CONTRACT_FINANCIALS_ID
		FROM CONTRACT_FINANCIALS A,
		  FISCAL_YEAR B
		WHERE CONTRACT_ID    = #{amendmentContractID}
		AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
		group BY (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY)
	</select>
	
	<select id="fetchContractConfAmendmentDetails" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="CoADetailsList">
		SELECT (
		  CASE
		    WHEN a.contract_financials_id = a.parent_id
		    THEN TO_CHAR(A.CONTRACT_FINANCIALS_ID)
		      ||'_newrecord'
		    ELSE TO_CHAR(A.CONTRACT_FINANCIALS_ID)
		  END) AS CONTRACT_FINANCIALS_ID,
		  A.UNIT_OF_APPROPRIATION,
		  A.BUDGET_CODE,
		  A.OBJECT_CODE,
		  A.SUB_OBJECT_CODE,
		  A.REPORTING_CATEGORY,
		  B.FISCAL_YEAR_ID,
		  A.AMOUNT,
		  A.parent_id,
		  A.created_date
		FROM CONTRACT_FINANCIALS A,
		  FISCAL_YEAR B
		WHERE CONTRACT_ID    = #{amendmentContractID}
		AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
		<if test="partialMergedRowId != null and  partialMergedRowId.size > 0">
		AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) NOT IN 
		<foreach item="items" index="index" collection="partialMergedRowId"
					open="(" separator="," close=")">
					#{items}
		</foreach>
		</if>
		<!-- start release 3.14.0 -->
		<!-- AND A.ACTIVE_FLAG    ='1' -->
		<!-- end release 3.14.0 -->
		ORDER BY A.UNIT_OF_APPROPRIATION,
		  A.BUDGET_CODE,
		  A.OBJECT_CODE,
		  A.SUB_OBJECT_CODE,
		  A.REPORTING_CATEGORY,
		  B.FISCAL_YEAR
	</select>	
	
   <update id="editContractConfAmendmentDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials
	    SET 
        UNIT_OF_APPROPRIATION = #{unitOfAppropriation},
        BUDGET_CODE = #{budgetCode},
        OBJECT_CODE = #{objectCode},
        SUB_OBJECT_CODE = #{subOc},
        REPORTING_CATEGORY = #{rc},
        AMOUNT = #{ammount},
        ACTIVE_FLAG = '1',
        <if test="deletedRecord != null and deletedRecord==true">
		CREATED_DATE = SYSTIMESTAMP,
		</if>
		MODIFIED_DATE = SYSTIMESTAMP
        WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = #{amendmentContractID}
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
   </update>
   
   <update id="editContractConfAmendmentDetailsOld" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials
	    SET 
        AMOUNT = #{ammount},
        ACTIVE_FLAG = '1',
        <if test="deletedRecord != null and deletedRecord==true">
		CREATED_DATE = SYSTIMESTAMP,
		</if>
		MODIFIED_DATE = SYSTIMESTAMP
        WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = #{amendmentContractID}
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
   </update>
	
   <update id="editContractConfUpdateDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials
	    SET 
        AMOUNT = #{ammount},
        ACTIVE_FLAG = '1',
        <if test="deletedRecord != null and deletedRecord==true">
		CREATED_DATE = SYSTIMESTAMP,
		</if>
		MODIFIED_DATE = SYSTIMESTAMP
        WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = (select contract_id from contract where parent_contract_id=#{contractID}and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} 
        and delete_flag=0) 
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
   </update>
   
 	<resultMap type="com.nyc.hhs.model.ContractFinancialBean" id="ContractConfigUpdate">
	<result property="contractId" column="contract_id"></result>
	<result property="contractTypeId" column="contract_type_id"></result>
	<result property="agencyId" column="agency_id"></result>
	<result property="parentContractId" column="parent_contract_id"></result>
	<result property="contractAmount" column="contract_amount"></result>
	<result property="contractSourceId" column="CONTRACT_SOURCE_ID"></result>
	<result property="programId" column="PROGRAM_ID"></result>
	<result property="statusId" column="STATUS_ID"></result>
	<result property="registrationFlag" column="REGISTRATION_FLAG"></result>
	<result property="updateFlag" column="UPDATE_FLAG"></result>
	<result property="contractStart" column="CONTRACT_START_DATE"></result>
	<result property="contractEnd" column="CONTRACT_END_DATE"></result>
	<result property="statusId" column="STATUS_ID"></result>
	<result property="createByUserId" column="CREATED_BY_USERID"></result>
	<result property="modifyByUserId" column="MODIFIED_BY_USERID"></result>
	<result property="procMethod" column="PROCUREMENT_METHOD"></result>
	<result property="contractTitle" column="CONTRACT_TITLE"></result>
	<result property="orgnaziationId" column="ORGANIZATION_ID"></result>
	<result property="extEpin" column="EXT_EPIN"></result>
	<result property="extCTNumber" column="EXT_CT_NUMBER"></result>
	<!-- R6: Added a field for epin unique key -->
	<result property="refAptEpinId" column="REF_APT_EPIN_ID"></result>
	
</resultMap>
	
	<!-- R6: non apt epins - need ref_apt_epin_id as well in fetchedContractDetails -->
	<select id="fetchedContractDetails" parameterType="String" 
	resultMap="ContractConfigUpdate">
	 select contract_id,contract_type_id,agency_id,parent_contract_id,contract_amount,CONTRACT_SOURCE_ID,
	 PROGRAM_ID,STATUS_ID,REGISTRATION_FLAG,UPDATE_FLAG,CONTRACT_START_DATE,CONTRACT_END_DATE,CREATED_DATE,CREATED_BY_USERID,MODIFIED_BY_USERID,
	 PROCUREMENT_METHOD,CONTRACT_TITLE,ORGANIZATION_ID,EXT_EPIN,EXT_CT_NUMBER, REF_APT_EPIN_ID  from contract where  contract_type_id in ('1','3') and 	contract_id=#{contractID}	
	</select>
<insert id="insertFetchedContractDetails" parameterType="com.nyc.hhs.model.ContractFinancialBean">
		INSERT INTO CONTRACT(    
				CONTRACT_ID,
				CONTRACT_TYPE_ID, 
				CONTRACT_SOURCE_ID,
				AGENCY_ID,
				PROGRAM_ID,
				CONTRACT_AMOUNT,
				STATUS_ID,
				REGISTRATION_FLAG,
				UPDATE_FLAG,
				LAST_UPDATE_DATE,
				CONTRACT_START_DATE,
				CONTRACT_END_DATE,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				PARENT_CONTRACT_ID,
				ORGANIZATION_ID,
				DELETE_FLAG,
				DISCREPANCY_FLAG,
				CONTRACT_TITLE,
				EXT_EPIN,
				EXT_CT_NUMBER,
				REF_APT_EPIN_ID
				
			)
		values(
	    SEQ_CONTRACT_ID.nextval,
		#{contractTypeId},
		#{contractSourceId},
		#{agencyId},
		#{programId},
		#{contractAmount},
		#{statusId},
		#{registrationFlag},
		#{updateFlag},
		SYSTIMESTAMP,
		#{contractStart},
		#{contractEnd},
		SYSTIMESTAMP,
		#{createByUserId},
		SYSTIMESTAMP,
		#{modifyByUserId},
		#{contractId},
		#{orgnaziationId},
		#{deleteFlag},
		#{discrepancyFlag},
		#{contractTitle},
		#{extEpin},
		#{extCTNumber},
		#{refAptEpinId}
		)
	</insert>
	<resultMap type="com.nyc.hhs.model.ContractFinancialBean" id="ContractConfigFinancialUpdate">
			<result property="contractId" column="CONTRACT_ID"></result>
			<result property="contractFinancialId" column="CONTRACT_FINANCIALS_ID"></result>
			<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION"></result>
			<result property="objectCode" column="OBJECT_CODE"></result>
			<result property="budgetCode" column="BUDGET_CODE"></result>
			<result property="fiscalYear" column="FISCAL_YEAR_ID"></result>
			<result property="procurementId" column="PROCUREMENT_ID"></result>
			<result property="activeFlag" column="ACTIVE_FLAG"></result>
			<result property="ammount" column="AMOUNT"></result>
			<result property="parentId" column="PARENT_ID"></result>
			<result property="subOc" column="SUB_OBJECT_CODE"></result>
			<result property="rc" column="REPORTING_CATEGORY"></result>
			<result property="createByUserId" column="CREATED_BY_USERID"></result>
			<result property="modifyByUserId" column="MODIFIED_BY_USERID"></result>
</resultMap>

<select id="fetchedContractFinancialDetails" parameterType="String"  resultMap="ContractConfigFinancialUpdate">
	SELECT
	     CONTRACT_FINANCIALS_ID,
	     CONTRACT_ID,
	     UNIT_OF_APPROPRIATION,
	     BUDGET_CODE,
	     OBJECT_CODE,
    	 SUB_OBJECT_CODE,
    	 REPORTING_CATEGORY,
    	 FISCAL_YEAR_ID,
    	 AMOUNT,
         parent_id,
         PROCUREMENT_ID,
         ACTIVE_FLAG,
         CREATED_BY_USERID,
         MODIFIED_BY_USERID
        FROM CONTRACT_FINANCIALS
  		WHERE
    	CONTRACT_ID = #{contractID} and active_flag='1'
</select>


<insert id="insertFetchedContractFinancialDetails" parameterType="com.nyc.hhs.model.ContractFinancialBean">
		Insert into CONTRACT_FINANCIALS 
		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FINANCIALS_ID.nextval,
		#{procurementId ,jdbcType=NUMERIC},
		(select 
			contract_id 
		 from 
		 	contract
		 where 
		 	parent_contract_id=#{contractId}
		 and contract_id!=#{contractId} 
		 and delete_flag=0 
		 and contract_type_id=#{contractTypeId}
		 ),
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYear},
		#{ammount},
		SYSTIMESTAMP,
		#{activeFlag},
		#{parentId , jdbcType=VARCHAR},
		SYSTIMESTAMP,
		#{createByUserId},
		SYSTIMESTAMP,
		#{modifyByUserId})
	</insert>
	
	 <insert id="addContractConfUpdateTaskDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		Insert into CONTRACT_FINANCIALS 
		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FINANCIALS_ID.nextval,
		#{procurementID ,jdbcType=NUMERIC},
		(select contract_id from contract where parent_contract_id=#{contractID}and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} and delete_flag=0
		),
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYearID},
		#{ammount},
		SYSTIMESTAMP,
		#{activeFlag},
		SEQ_CONTRACT_FINANCIALS_ID.currval,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>

	 <insert id="addContractConfAmendmentTaskDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		Insert into CONTRACT_FINANCIALS 
		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FINANCIALS_ID.nextval,
		#{procurementID ,jdbcType=NUMERIC},
		#{amendmentContractID},
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYearID},
		#{ammount},
		SYSTIMESTAMP,
		#{activeFlag},
		SEQ_CONTRACT_FINANCIALS_ID.currval,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	
	<update id="editNewFYConfCOADetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials
	    SET 
        UNIT_OF_APPROPRIATION = #{unitOfAppropriation},
        BUDGET_CODE = #{budgetCode},
        OBJECT_CODE = #{objectCode},
        SUB_OBJECT_CODE = #{subOc},
        REPORTING_CATEGORY = #{rc},
        AMOUNT = #{ammount},
        MODIFIED_BY_USERID = #{modifyByAgency, jdbcType=VARCHAR},
        MODIFIED_DATE = SYSTIMESTAMP
     WHERE fiscal_year_id = #{fiscalYearID}
        AND contract_id = #{contractID}
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
	</update>		
	
	<select id="fetchFYPlannedAmount" parameterType="HashMap" resultType="java.lang.String">
		select SUM(amount) 
		from 
		contract_financials 
		where contract_id = #{asContractId} 
		AND contract_financials_id = parent_id
		AND fiscal_year_id = #{asFiscalYearId} 
		AND active_flag = 1
	</select>

	<select id="fetchAmendmentFYPlannedAmount" parameterType="HashMap" resultType="java.lang.String">
		select 
			SUM(amount) 
		from 
			contract_financials 
		where 
			contract_id = #{asAmendContractId} 			
		AND 
			fiscal_year_id = #{asFiscalYearId} 
		AND 
			active_flag = 1
	</select>
	
	<select id="fetchUpdateFYPlannedAmount" parameterType="HashMap" resultType="java.lang.String">
		SELECT SUM(amount)
		FROM contract_financials
		WHERE contract_id =
		  (SELECT contract_id
		  FROM contract
		  WHERE parent_contract_id=#{asContractId}
		  AND contract_id        !=#{asContractId}
		  AND contract_type_id    =#{contractTypeId}
		  AND delete_flag         =0
		  )
		AND fiscal_year_id = #{asFiscalYearId}
		AND active_flag    = 1
	</select>
	
	<select id="contractBudgetAmendFYData" parameterType="HashMap" resultMap="contractBudgetAmendFYDetails">
		SELECT SUM(TOT_BUDGET_AMT) AS TOT_BUDGET_AMT ,
		  SUM(AMEND_AMT)           AS AMEND_AMT,
		  SUM(POS_AMEND_AMT)       AS POS_AMEND_AMT ,
		  SUM(NEG_AMEND_AMT)       AS NEG_AMEND_AMT
		FROM
		  (SELECT NVL(fiscal_year_amount,0) AS TOT_BUDGET_AMT,
		    0                               AS AMEND_AMT,
		    0                               AS POS_AMEND_AMT,
		    0                               AS NEG_AMEND_AMT
		  FROM budget
		  WHERE contract_id  = #{asContractId}
		  AND budget_type_id = '2'
		  AND fiscal_year_id = #{asFiscalYearId}
		  UNION ALL
		  SELECT 0                         AS TOT_BUDGET_AMT,
		    0                              AS AMEND_AMT,
		    NVL(SUM(FISCAL_YEAR_AMOUNT),0) AS POS_AMEND_AMT,
		    0                              AS NEG_AMEND_AMT
		  FROM budget
		  WHERE contract_id IN
		    (SELECT contract_id
		    FROM contract
		    WHERE parent_contract_id = #{asContractId}
		    AND contract_type_id     = '2'
		    AND contract_id         != #{asAmendContractId}
		    AND status_id            = '61'
		    )
		  AND FISCAL_YEAR_ID      = #{asFiscalYearId}
		  AND FISCAL_YEAR_AMOUNT &gt;= 0
		  UNION ALL
		  SELECT 0                         AS TOT_BUDGET_AMT,
		    0                              AS AMEND_AMT,
		    NVL(SUM(FISCAL_YEAR_AMOUNT),0) AS POS_AMEND_AMT,
		    NVL(SUM(FISCAL_YEAR_AMOUNT),0) AS NEG_AMEND_AMT
		  FROM budget
		  WHERE contract_id IN
		    (SELECT contract_id
		    FROM contract
		    WHERE parent_contract_id = #{asContractId}
		    AND contract_type_id     = '2'
		    AND contract_id         != #{asAmendContractId}
		    AND status_id            = '129'
		    )
		  AND FISCAL_YEAR_ID      = #{asFiscalYearId}
		  AND FISCAL_YEAR_AMOUNT &lt;= 0
		  UNION ALL
		  SELECT 0                    AS TOT_BUDGET_AMT,
		    NVL(FISCAL_YEAR_AMOUNT,0) AS AMEND_AMT,
		    0                         AS POS_AMEND_AMT,
		    0                         AS NEG_AMEND_AMT
		  FROM BUDGET
		  WHERE CONTRACT_ID  = #{asAmendContractId}
		  AND BUDGET_TYPE_ID = '1'
		  AND FISCAL_YEAR_ID = #{asFiscalYearId}
		  ) 
	</select>
	
	<update id="updateBudgetForNewFYConfigurationTask" parameterType="com.nyc.hhs.model.ContractBudgetBean" >
		UPDATE BUDGET 
			SET
			budget_end_date = to_date(#{budgetEndDate}, 'yyyy-MM-dd HH24:mi:ss'),
			budget_start_date = to_date(#{budgetStartDate}, 'yyyy-MM-dd HH24:mi:ss'),
			status_id = #{statusId},
			MODIFIED_BY_USERID = #{modifiedByUserId, jdbcType=VARCHAR},
			MODIFIED_DATE = SYSTIMESTAMP
		WHERE
			contract_id = #{contractId}
			AND fiscal_year_id = #{budgetfiscalYear}
			AND active_flag = 1
	</update>
		
	<select id="getContractEndDate" parameterType="java.lang.String" resultType="java.lang.String" >
		SELECT contract_end_date 
		FROM 
		contract
		WHERE
		contract_id = #{asContractId}
	</select>
	
	<select id="fetchBudgetIdIfExists" parameterType="HashMap" resultType="java.lang.String">
		SELECT BUDGET_ID FROM budget where contract_id = #{asContractId} 
		AND fiscal_year_id = #{asFiscalYearId}
	</select>
	
	<select id="fetchSubBudgetTotalAmount" parameterType="HashMap" resultType="java.lang.String">
		SELECT SUM(SUB_BUDGET_AMOUNT) FROM SUB_BUDGET where budget_id = #{asBudgetId} 
		AND fiscal_year_id = #{asFiscalYearId}
	</select>
	<!-- R5 Changes starts-->
	<update id="updateProcStatus" parameterType="java.lang.String">
		update
		PROCUREMENT_FINANCIALS set
		PCOF_STATUS_ID='52'
		where
		PROCUREMENT_ID=#{asProcurementId}
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
	</update>
	<!-- R5 Changes ends-->
	<!-- Made changes for Release 3.10.0 Defect 6541 -->
	<resultMap id="ContractConfigFinancialActuals" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="ACTUALS" />
		<result property="modifiedDate" column="Modified_date" />
		<result property="createdDate" column="CREATED_DATE" />
</resultMap>
	
	<!--Release 3.10.0 Defect id 6541 -->
<select id="fetchContractConfUpdateActualDetails" parameterType="com.nyc.hhs.model.CBGridBean"  resultMap="ContractConfigFinancialActuals">	
SELECT 
      SUM(A.payment_amount) as ACTUALS,
       A.UNIT_OF_APPROPRIATION,
       A.BUDGET_CODE,
       A.OBJECT_CODE,
       A.SUB_OBJECT_CODE,
       A.REPORTING_CATEGORY,
       B.BUDGET_FISCAL_YEAR_ID as FISCAL_YEAR_ID ,
       max(A.Modified_date) AS  Modified_date    ,
       MAX(B.CREATED_DATE)  AS CREATED_DATE
     FROM payment_allocation A, PAYMENT B
     WHERE
          B.CONTRACT_ID = #{contractID}
          AND
          A.PAYMENT_ID=B.PAYMENT_ID 
		      and b.STATUS_ID='65'
          group by A.UNIT_OF_APPROPRIATION,A.BUDGET_CODE,A.OBJECT_CODE,A.SUB_OBJECT_CODE,A.REPORTING_CATEGORY, B.BUDGET_FISCAL_YEAR_ID   
          ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.BUDGET_FISCAL_YEAR_ID  
     </select>
        
 <select id="fetchFYAndContractId" parameterType="String" resultType="String">
      select distinct(fiscal_year_id) from budget where contract_id=#{asContractId} and active_flag='1' and status_id in (85,86)
</select>
<!-- start release 3.12.0 enhancement 6601 -->
<select id="fetchFYAndContractIdAmendment" parameterType="String" resultType="String">
      select distinct(fiscal_year_id) from budget where contract_id=#{asContractId} and active_flag='1' <!-- start release 3.14.0 --><!-- and status_id ! = 106 --><!-- end release 3.14.0 -->
</select>

<select id="fetchFYAndContractIdAmendmentNegative" parameterType="String" resultType="String">
      select distinct(fiscal_year_id) from budget where contract_id=#{asContractId} and active_flag='1' and status_id ! = 106 
</select>

<!-- end release 3.12.0 enhancement 6601 -->

<resultMap id="subBudgetDetailsListConfigUpdate" type="com.nyc.hhs.model.ContractBudgetBean">
		<result property="id" column="parent_id" />
		<result property="parentId" column="parent_id" />
		<result property="subbudgetName" column="SUB_BUDGET_NAME" />
		<result property="subbudgetAmount" column="BASE_2" />
		<result property="modifiedAmount" column="MODIFIED_4" />
		<result property="posAmendAmt" column="PEND_POS_AMEND" />
		<result property="negAmendAmt" column="PEND_NEG_AMEND" />
		<result property="remAmt" column="remaining_amount" />
 </resultMap>
	<select id="fetchContractConfUpdateSubBudgetDetails" parameterType="HashMap"
		resultMap="subBudgetDetailsListConfigUpdate">
    	SELECT 
		 x.parent_id,x.sub_budget_name,
		  sum(DECODE(x.budget_type_id, '2', x.sub_budget_amount))AS BASE_2 ,
		  sum(DECODE(x.budget_type_id, #{asBudgetTypeId}, x.sub_budget_amount)) AS MODIFIED_4 
		   FROM
		  (SELECT sb.sub_budget_amount AS sub_budget_amount,
		    b.budget_type_id  AS budget_type_id,
		    sb.sub_budget_id  AS sub_budget_id,
		    sb.parent_id  AS parent_id,
		    sb.budget_id  AS budget_id,
		    sb.sub_budget_name AS sub_budget_name
		  FROM sub_budget sb,
		    budget b
		  WHERE b.budget_id  = sb.budget_id
		  AND b.contract_id    in  (#{asContractId},(select 
		  												contract_id 
		  											from 
		  												contract 
		  											where 
		  												parent_contract_id=#{asContractId} 
		  											and  
		  												contract_id !=#{asContractId} 
		  											and 
		  												contract_type_id=#{asContractTypeId} 
		  											and 
		  												delete_flag=0
		  												))
		  AND sb.FISCAL_YEAR_ID= #{asFiscalYearId}
		  AND sb.ACTIVE_FLAG= '1'
		  ) x group by x.parent_id,x.sub_budget_name order by x.parent_id desc
	</select>

	<!-- start release 3.14.0 -->
	<select id="fetchContractConfAmendSubBudgetDetailsNextNewFY" parameterType="HashMap"
		resultMap="subBudgetDetailsListConfigUpdate">
  			  
		SELECT x.parent_id,
		  x.sub_budget_name,
		  SUM(DECODE(x.budget_type_id, '2', x.sub_budget_amount)) AS BASE_2 ,
		  SUM(DECODE(x.budget_type_id, #{asBudgetTypeId}, x.sub_budget_amount)) AS MODIFIED_4 ,
		  (SELECT yy.bbb
		  FROM
		    (SELECT SUM(sub_budget_amount) AS bbb,
		      parent_id
		    FROM sub_budget
		    WHERE budget_id IN
		      (SELECT budget_id
		      FROM budget
		      WHERE contract_id IN
		        (SELECT contract_id
		        FROM contract
		        WHERE contract_type_id = '2'
		        AND parent_contract_id = #{asContractId}
		        AND contract_id       != #{asAmendContractId}
		        )
		      )
		    AND sub_budget_amount &gt;= '0'
		    GROUP BY parent_id
		    ) yy
		  WHERE yy.parent_id = x.parent_id
		  ) AS PEND_POS_AMEND ,
		  (SELECT yy.bbb
		  FROM
		    (SELECT SUM(sub_budget_amount) AS bbb,
		      parent_id
		    FROM sub_budget
		    WHERE budget_id IN
		      (SELECT budget_id
		      FROM budget 
		      WHERE contract_id IN
		        (SELECT contract_id
		        FROM contract
		        WHERE contract_type_id = '2'
		        AND parent_contract_id = #{asContractId}
		        AND contract_id       != #{asAmendContractId}
		        )
		      )
		    AND sub_budget_amount &lt;= '0'
		    GROUP BY parent_id
		    ) yy
		  WHERE yy.parent_id = x.parent_id
		  ) AS PEND_NEG_AMEND,
		   (
		   SUM(DECODE(x.budget_type_id, '2', x.sub_budget_amount)) -
			nvl( (SELECT yy.inv_amt
			FROM
			  (SELECT SUM(a.invoice_amount) AS inv_amt ,
			    a.sub_budget_id
			  FROM invoice_details a,
			    invoice b
			  WHERE a.invoice_id   =b.invoice_id
			  AND b.contract_id    =#{asContractId}
			  AND b.FISCAL_YEAR_ID = #{asFiscalYearId}
			  AND b.status_id     IN (72,73)
			  GROUP BY a.sub_budget_id
			  ) yy
			WHERE yy.sub_budget_id = x.parent_id),0)
		  
		   )  as remaining_amount
		FROM
		  (SELECT sb.sub_budget_amount AS sub_budget_amount,
		    b.budget_type_id           AS budget_type_id,
		    sb.sub_budget_id           AS sub_budget_id,
		    sb.parent_id               AS parent_id,
		    sb.budget_id               AS budget_id,
		    sb.sub_budget_name         AS sub_budget_name
		  FROM sub_budget sb,
		    budget b
		  WHERE b.budget_id    = sb.budget_id
		  AND b.contract_id   IN (#{asAmendContractId})
		  AND sb.FISCAL_YEAR_ID= #{asFiscalYearId}
		  AND sb.ACTIVE_FLAG   = '1'
		  union
		  SELECT sb.sub_budget_amount AS sub_budget_amount,
		    b.budget_type_id           AS budget_type_id,
		    sb.sub_budget_id           AS sub_budget_id,
		    sb.parent_id               AS parent_id,
		    sb.budget_id               AS budget_id,
		    sb.sub_budget_name         AS sub_budget_name
		  FROM sub_budget sb,
		    budget b
		  WHERE b.budget_id    = sb.budget_id
		  AND b.contract_id   IN (#{asContractId})
		  AND sb.FISCAL_YEAR_ID= #{asFiscalYearId}
		  AND sb.ACTIVE_FLAG   = '1'
		  and b.status_id!=106
		  ) x
		GROUP BY x.parent_id,
		  x.sub_budget_name
		ORDER BY x.parent_id DESC
	</select>
	<!-- end release 3.14.0 -->
	
	<!-- [Start] R7.3.0 QC 9121 -->
	<select id="fetchContractConfAmendSubBudgetDetails" parameterType="HashMap"
		resultMap="subBudgetDetailsListConfigUpdate">
  			  
		SELECT x.parent_id,  x.sub_budget_name,
		  SUM(DECODE(x.budget_type_id, '2', x.sub_budget_amount)) AS BASE_2 ,
		  SUM(DECODE(x.budget_type_id, #{asBudgetTypeId}, x.sub_budget_amount)) AS MODIFIED_4 ,
		  (SELECT yy.bbb
		     FROM  (SELECT   SUM(sub_budget_amount) AS bbb, parent_id
		              FROM   sub_budget
		             WHERE   budget_id IN  (SELECT    budget_id
		                                      FROM    budget
		                                     WHERE    contract_id IN ( SELECT   contract_id
		                                                                 FROM   contract
		                                                                WHERE   contract_type_id = '2'
		                                                                  AND   parent_contract_id = #{asContractId}
		                                                                  AND   contract_id       != #{asAmendContractId}
		                                                             )
		                                    )
		             AND    sub_budget_amount &gt;= '0'
		            GROUP BY parent_id
		           ) yy
		   WHERE yy.parent_id = x.parent_id
		 ) AS PEND_POS_AMEND ,
		 (SELECT    yy.bbb 
		    FROM    (SELECT   SUM(sub_budget_amount) AS bbb,  parent_id
		               FROM   sub_budget
		              WHERE   budget_id IN  ( SELECT   budget_id
		                                        FROM   budget
		                                       WHERE   contract_id IN  (  SELECT   contract_id
		                                                                    FROM   contract
		                                                                   WHERE   contract_type_id = '2'
		                                                                     AND   parent_contract_id = #{asContractId}
		                                                                     AND   contract_id       != #{asAmendContractId}
		                                                                )
		                                    )
		               AND sub_budget_amount &lt;= '0'
		              GROUP BY parent_id
		            ) yy
		  WHERE yy.parent_id = x.parent_id
		  ) AS PEND_NEG_AMEND,
		 ( SUM(DECODE(x.budget_type_id, '2', x.sub_budget_amount)) -
			  nvl( (  SELECT  yy.inv_amt
			            FROM  (  SELECT   SUM(a.invoice_amount) AS inv_amt ,  a.sub_budget_id
			                       FROM   invoice_details a,  invoice b
			                      WHERE   a.invoice_id   =b.invoice_id
			                        AND   b.contract_id    =#{asContractId}
			                        AND   b.FISCAL_YEAR_ID = #{asFiscalYearId}
			                        AND   b.status_id     IN (72,73)
			                        AND   a.ENTRY_TYPE_ID not in (11)
			                      GROUP BY a.sub_budget_id
			                   ) yy
			             WHERE yy.sub_budget_id = x.parent_id),0
			    )
		  
		   )  as remaining_amount
		FROM
		  (SELECT sb.sub_budget_amount AS sub_budget_amount, 
				    b.budget_type_id           AS budget_type_id,
				    sb.sub_budget_id           AS sub_budget_id,
				    sb.parent_id               AS parent_id,
				    sb.budget_id               AS budget_id,
				    sb.sub_budget_name         AS sub_budget_name
		  FROM sub_budget sb, budget b
		  WHERE b.budget_id    = sb.budget_id
		  AND b.contract_id   IN (#{asContractId},#{asAmendContractId})
		  AND sb.FISCAL_YEAR_ID= #{asFiscalYearId}
		  AND sb.ACTIVE_FLAG   = '1'
		  ) x
		GROUP BY x.parent_id,
		  x.sub_budget_name
		ORDER BY x.parent_id DESC
	</select>
	<!-- [End] R7.3.0 QC 9121 -->


	<resultMap id="subBudgetConfigUpdate" type="com.nyc.hhs.model.ContractBudgetBean">
	<result property="id" column="SUB_BUDGET_ID" />
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subbudgetName" column="SUB_BUDGET_NAME" />
		<result property="subbudgetAmount" column="SUB_BUDGET_AMOUNT" />
		<result property="budgetfiscalYear" column="FISCAL_YEAR_ID" />
		<result property="activeFlag" column="ACTIVE_FLAG" />
		<result property="createdByUserId" column="CREATED_BY_USERID" />
	 </resultMap>
	<select id="insertUpdatedSubBudgetDetails" parameterType="HashMap"
		resultMap="subBudgetConfigUpdate"> 
	select SUB_BUDGET_ID,BUDGET_ID,SUB_BUDGET_NAME,SUB_BUDGET_AMOUNT,FISCAL_YEAR_ID,ACTIVE_FLAG,CREATED_BY_USERID from SUB_BUDGET where BUDGET_ID=(select BUDGET_ID from budget where contract_id=#{asContractId} and BUDGET_TYPE_ID='2' and FISCAL_YEAR_ID=#{asFiscalYearId} and active_flag='1') and FISCAL_YEAR_ID=#{asFiscalYearId}
	</select>
	<insert id="insertContractConfUpdateSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	PARENT_ID,
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
		(select BUDGET_ID from budget 
		where 
		contract_id=(select contract_id from contract 
			where 
			parent_contract_id=#{contractId} 
			and  contract_id !=#{contractId} 
			and contract_type_id=#{contractTypeId}
			and delete_flag='0') 
		and BUDGET_TYPE_ID='4' 
		AND active_flag ='1' 
		AND FISCAL_YEAR_ID = #{budgetfiscalYear}),
	#{budgetfiscalYear},
	#{id},	
	#{subbudgetName},
	#{subbudgetAmount},
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>
	<insert id="insertContractConfAmendmentSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	PARENT_ID,
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	(select 
		BUDGET_ID 
	from 
		budget 
	where 
		contract_id=#{amendmentContractId} 
	and 
		BUDGET_TYPE_ID='1'
		and 
		 fiscal_year_id=#{budgetfiscalYear} ),
	#{budgetfiscalYear},
	#{id},	
	#{subbudgetName},
	#{subbudgetAmount},
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>
	<update id="editContractConfUpdateSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		 UPDATE 
		 	SUB_BUDGET
		 SET 
		 	SUB_BUDGET_AMOUNT =#{modifiedAmount}
		 	<if test="subbudgetName != null and subbudgetName!='' ">
		 	,SUB_BUDGET_NAME=#{subbudgetName}
		 	</if> 
		 WHERE 
		 	SUB_BUDGET_ID = (select 
		 						sub_budget_id 
		 					 from 
		 					 	sub_budget
		 					 where 
		 					 	parent_id = #{id} 
		 					 and
		 					 	 budget_id=(select
		 					 	 				 BUDGET_ID
		 					 	 			from
		 					 	 				 budget
		 					 	 			where 
		 					 	 				contract_id=(select 
		 					 	 								contract_id 
		 					 	 							from
		 					 	 								 contract
		 					 	 							 where 
		 					 	 							 	parent_contract_id=#{contractId} 
		 					 	 							 and 
		 					 	 							 	 contract_id !=#{contractId} 
		 					 	 							 and 
		 					 	 							 	contract_type_id=#{contractTypeId}
		 					 	 							 and 
		 					 	 							 	delete_flag=0
		 					 	 							 	) 
		 					 	 		  and 
		 					 	 		   		BUDGET_TYPE_ID=#{budgetTypeId}
		 					 	 		  and 
		 					 	 		  		fiscal_year_id=#{budgetfiscalYear} 
		 					 	 		  and
		 					 	 		  		 active_flag='1'))
	</update>

	<update id="editContractConfAmendSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		 UPDATE 
		 	SUB_BUDGET
		 SET 
		 	SUB_BUDGET_AMOUNT =#{modifiedAmount}
		 	<if test="subbudgetName != null and subbudgetName!='' ">
		 	,SUB_BUDGET_NAME=#{subbudgetName}
		 	</if> 
		 WHERE 
		 	SUB_BUDGET_ID = (select 
		 						sub_budget_id 
		 					 from 
		 					 	sub_budget
		 					 where 
		 					 	parent_id = #{id} 
		 					 and
		 					 	 budget_id=(select
		 					 	 				 BUDGET_ID
		 					 	 			from
		 					 	 				 budget
		 					 	 			where 
		 					 	 				contract_id= #{amendmentContractId} 
		 					 	 		  and 
		 					 	 		   		BUDGET_TYPE_ID=#{budgetTypeId}
		 					 	 		  and 
		 					 	 		  		fiscal_year_id=#{budgetfiscalYear} 
		 					 	 		  and
		 					 	 		  		 active_flag='1'))
	</update>
	
	<!-- start release 3.14.0 -->
	<update id="editContractConfAmendSubBudgetDetailsParentNameNextNewFy" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		 UPDATE 
		 	SUB_BUDGET
		 SET 
		 	SUB_BUDGET_NAME=#{subbudgetName},modified_date=systimestamp
		 WHERE 
		 	parent_id = #{id}
	</update>
	
	<update id="editContractConfAmendSubBudgetDetailsNextNewFy" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		 UPDATE 
		 	SUB_BUDGET
		 SET 
		 	SUB_BUDGET_AMOUNT=#{modifiedAmount,jdbcType=NUMERIC},modified_date=systimestamp
		 WHERE 
		 	sub_budget_id = 
		 	(select sub_budget_id from sub_budget where sub_budget_name = #{subbudgetName} 
	and budget_id = (select budget_id from budget where contract_id = #{amendmentContractId} and active_flag = '1' and fiscal_year_id = #{budgetfiscalYear}))
	</update>
	
	<select id="getParentSubBudgetIdNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="string">
	select sub_budget_id from sub_budget where sub_budget_name = #{subbudgetName} and budget_id = 
	(select distinct parent_id from budget where contract_id = #{amendmentContractId} and active_flag = '1' and fiscal_year_id = #{budgetfiscalYear}) and rownum=1
	</select>
	
	<select id="getAmendSubBudgetNameSameWithAnotherAmendment" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="integer">
	select count(sub_budget_id) from sub_budget where parent_id in 
	(select parent_id from sub_budget where sub_budget_name = #{subbudgetName} 
	and budget_id = (select distinct parent_id from budget where contract_id = #{amendmentContractId} and active_flag = '1' and fiscal_year_id = #{budgetfiscalYear}))
	and sub_budget_name = #{subbudgetName} and parent_id != sub_budget_id
	</select>
	
	<select id="getParenSubBudgetIdForAlreadyLinkedAmendment" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="string">
	select parent_id from sub_budget where parent_id in 
	(select parent_id from sub_budget where sub_budget_name = #{subbudgetName} 
	and budget_id = (select distinct parent_id from budget where contract_id = #{amendmentContractId} and active_flag = '1' and fiscal_year_id = #{budgetfiscalYear}))
	and sub_budget_name = #{subbudgetName} and parent_id != sub_budget_id and rownum=1
	</select>
	
	<update id="updateParentWhileEditingAmendmentWhenParentNotExist" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	update sub_budget set parent_id =#{parentSubBudgetId},SUB_BUDGET_AMOUNT=#{modifiedAmount,jdbcType=NUMERIC},modified_date=systimestamp
	 where sub_budget_id = (select sub_budget_id from sub_budget where parent_id = #{id} and sub_budget_name =#{subbudgetNameBackup} and budget_id = #{budgetId})
	</update>
	
	<update id="updateParentWhileEditingAmendment" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	update sub_budget set parent_id =#{parentSubBudgetId},SUB_BUDGET_AMOUNT=#{modifiedAmount,jdbcType=NUMERIC},sub_budget_name = #{subbudgetName},modified_date=systimestamp
	 where sub_budget_id = (select sub_budget_id from sub_budget where parent_id = #{id} and sub_budget_name =#{subbudgetNameBackup} and budget_id = #{budgetId})
	</update>
	
	<select id="getSubBudgetName" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="string">
	select sub_budget_name from sub_budget where sub_budget_id = #{id} 
	</select>
	
	<select id="getSubBudgetNameForSameAmendmentBudget" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="string">
	select sub_budget_name from sub_budget where budget_id = #{budgetId}
	</select>
	<!-- end release 3.14.0 -->
	
	<insert id="addContractConfUpdateBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	PARENT_ID,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	(select BUDGET_ID from budget where contract_id=(select contract_id from contract where parent_contract_id=#{contractId} and  contract_id !=#{contractId} and contract_type_id=#{contractTypeId} 
	and delete_flag=0
	) and BUDGET_TYPE_ID=#{budgetTypeId} and fiscal_year_id=#{budgetfiscalYear} and active_flag='1'),
	#{budgetfiscalYear},	
	#{subbudgetName},
	#{modifiedAmount},
	SEQ_SUB_BUDGET_ID.currval,
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>
	<insert id="addContractConfAmendmentBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	PARENT_ID,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	(select BUDGET_ID from budget where contract_id= #{amendmentContractId}
	and BUDGET_TYPE_ID=#{budgetTypeId} and fiscal_year_id=#{budgetfiscalYear} and active_flag='1'),
	#{budgetfiscalYear},	
	#{subbudgetName},
	#{modifiedAmount},
	SEQ_SUB_BUDGET_ID.currval,
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>
	<!-- release 3.14.0 create base for the amendment sub budget -->
	<insert id="addContractConfAmendmentBudgetDetailsAddItsParent" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	PARENT_ID,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	(select parent_id from budget where contract_id= #{amendmentContractId}
	and BUDGET_TYPE_ID=#{budgetTypeId} and fiscal_year_id=#{budgetfiscalYear} and active_flag='1'),
	#{budgetfiscalYear},	
	#{subbudgetName},
	'0',
	SEQ_SUB_BUDGET_ID.currval,
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	
	<selectKey keyProperty="parentSubBudgetId" resultType="java.lang.String">
			select
			SEQ_SUB_BUDGET_ID.currval from Dual
		</selectKey>
	</insert>
	
	<insert id="addContractConfAmendmentBudgetDetailsForNextNewFy" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	Insert into SUB_BUDGET 
	(SUB_BUDGET_ID,
	BUDGET_ID,
	FISCAL_YEAR_ID,	
	SUB_BUDGET_NAME,
	SUB_BUDGET_AMOUNT,
	PARENT_ID,
	LAST_UPDATE_DATE,
	ACTIVE_FLAG,
	CREATED_DATE,
	CREATED_BY_USERID,
	MODIFIED_DATE,
	MODIFIED_BY_USERID) 
	values 
	(SEQ_SUB_BUDGET_ID.NEXTVAL,
	(select BUDGET_ID from budget where contract_id= #{amendmentContractId}
	and BUDGET_TYPE_ID=#{budgetTypeId} and fiscal_year_id=#{budgetfiscalYear} and active_flag='1'),
	#{budgetfiscalYear},	
	#{subbudgetName},
	#{modifiedAmount},
	#{parentSubBudgetId},
	SYSTIMESTAMP,
	'1',
	SYSTIMESTAMP,
	#{createdByUserId},
	SYSTIMESTAMP,
	#{createdByUserId})
	</insert>
	
	
	<!-- release 3.14.0 -->
	<select id="fetchInvoiceAmount" parameterType="String"
		resultType="String"> 
		select  sum(invd.invoice_amount) as invoice_amount from invoice_details invd, invoice inv where inv.invoice_id=invd.invoice_id and invd.sub_budget_id = #{parentId} and inv.status_id in (72,73) and invd.ENTRY_TYPE_ID not in (11)
	</select>
	<select id="fetchModifiedAmountByParentId" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String"> 
	   select SUB_BUDGET_AMOUNT from SUB_BUDGET where sub_budget_id=( select sub_budget_id from sub_budget where parent_id = #{id} and budget_id=((select BUDGET_ID from budget where contract_id=#{contractId} and BUDGET_TYPE_ID='4' and fiscal_year_id=#{budgetfiscalYear} and active_flag='1')))
	</select>
	<select id="fetchSubBudgetAmountByParentId" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String"> 
	   select SUB_BUDGET_AMOUNT from SUB_BUDGET where sub_budget_id=( select sub_budget_id from sub_budget where parent_id = #{id} and budget_id=((select BUDGET_ID from budget where contract_id=#{contractId} and BUDGET_TYPE_ID='2' and fiscal_year_id=#{budgetfiscalYear} and active_flag='1')))
	</select>
	
	<select id="fetchAllAmendedSubBudgetAmount" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String"> 
		SELECT SUM(SUB_BUDGET_AMOUNT)
		FROM sub_budget
		WHERE parent_id = #{id}
		AND budget_id IN
			(SELECT budget_id
			FROM budget
			WHERE contract_id IN
					   (SELECT contract_id
						FROM contract a
						WHERE contract_amount &lt; 0 AND contract_type_id =2
						AND parent_contract_id =#{contractId}
						AND status_id !=69
						AND contract_id != #{amendmentContractId}
						<!-- QC9025 R 9.2 - only select pending negative amendments that have not been merged yet -->
						AND delete_flag = 0 
						)
				<!-- QC9025 R 9.2 - exclude approved budgets -->
				and status_id != 86	
			)

			   
	</select>
	
	<resultMap id="ContractConfigFinancialActuals1" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="ACTUALS" />
		<result property="modifiedDate" column="Modified_date" />
</resultMap>
	
<select id="fetchContractConfUpdateActualDetailsBYFY" parameterType="com.nyc.hhs.model.CBGridBean"  resultMap="ContractConfigFinancialActuals1">	
SELECT 
      SUM(A.payment_amount) as ACTUALS,
       A.UNIT_OF_APPROPRIATION,
       A.BUDGET_CODE,
       A.OBJECT_CODE,
       A.SUB_OBJECT_CODE,
       A.REPORTING_CATEGORY,
       B.FISCAL_YEAR_ID,
       max(A.Modified_date) AS  Modified_date    
     FROM payment_allocation A, PAYMENT B
     WHERE
          B.CONTRACT_ID = #{contractID}
          AND
          B.FISCAL_YEAR_ID=#{fiscalYearID}
          and
          A.PAYMENT_ID=B.PAYMENT_ID 
		      and b.STATUS_ID='65'
          group by A.UNIT_OF_APPROPRIATION,A.BUDGET_CODE,A.OBJECT_CODE,A.SUB_OBJECT_CODE,A.REPORTING_CATEGORY, B.FISCAL_YEAR_ID  
          ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, A.REPORTING_CATEGORY, B.FISCAL_YEAR_ID 
     </select>
     
     <resultMap id="UpdateDetailsList1" type="com.nyc.hhs.model.AccountsAllocationBean">
		<result property="id" column="CONTRACT_FINANCIALS_ID" />
		<result property="unitOfAppropriation" column="UNIT_OF_APPROPRIATION" />
		<result property="budgetCode" column="BUDGET_CODE" />
		<result property="objectCode" column="OBJECT_CODE" />
		<result property="subOc" column="SUB_OBJECT_CODE" />
		<result property="rc" column="REPORTING_CATEGORY" />
		<result property="fiscalYear" column="FISCAL_YEAR_ID" />
		<result property="ammount" column="AMOUNT" />
		<result property="modifiedDate" column="modified_date" />
	</resultMap>
	
<select id="fetchContractConfUpdateFYIAmount" parameterType="com.nyc.hhs.model.CBGridBean" resultMap="UpdateDetailsList1">
SELECT
	     A.CONTRACT_FINANCIALS_ID,
	     A.UNIT_OF_APPROPRIATION,
	     A.BUDGET_CODE,
	     A.OBJECT_CODE,
    	 A.SUB_OBJECT_CODE,
    	 A.REPORTING_CATEGORY,
    	 B.FISCAL_YEAR_ID,
    	 A.AMOUNT,
         A.parent_id,
         A.modified_date
		 FROM CONTRACT_FINANCIALS A, 
    		  FISCAL_YEAR B
		 WHERE
    		  A.CONTRACT_ID = (select contract_id from contract where parent_contract_id=#{contractID}and  contract_id !=#{contractID}) 
        	AND A.FISCAL_YEAR_ID = B.FISCAL_YEAR_ID
        	AND A.ACTIVE_FLAG = '1'
        	AND A.FISCAL_YEAR_ID=#{fiscalYearID}
		  ORDER BY A.UNIT_OF_APPROPRIATION, A.BUDGET_CODE, A.OBJECT_CODE, A.SUB_OBJECT_CODE, 
         A.REPORTING_CATEGORY, B.FISCAL_YEAR
	</select>
	
	<!--Added for deletion ContractConfUpdateTaskDetails start by setting Active-flag 0-->
	
	<update id="delContractConfUpdateTaskDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  
	  UPDATE contract_financials A
	    SET 
	 ACTIVE_FLAG = '0'
	 where A.contract_id = (select contract_id from contract where parent_contract_id=#{contractID} and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} and delete_flag=0)
	 AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
    
    </update>

	<delete id="delContractConfAmendTaskDetails" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	 DELETE
		FROM CONTRACT_FINANCIALS
		WHERE CONTRACT_FINANCIALS_ID IN
		  (SELECT CONTRACT_FINANCIALS_ID
		  FROM CONTRACT_FINANCIALS
		  WHERE CONTRACT_ID = #{amendmentContractID}
		  AND (UNIT_OF_APPROPRIATION
		    || '-'
		    || BUDGET_CODE
		    || '-'
		    || OBJECT_CODE
		    || '-'
		    || SUB_OBJECT_CODE
		    || '-'
		    || REPORTING_CATEGORY) = (#{id}))
    </delete>
	
	<!--Added for deletion ContractConfUpdateTaskDetails END-->
	<delete id="delContractConfUpdateSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM sub_budget
		WHERE budget_id=
		  (SELECT budget_id
		  FROM budget
		  WHERE contract_id=
		    (SELECT contract_id
		    FROM contract
		    WHERE parent_contract_id=#{contractId}
		    AND contract_id        !=#{contractId}
		    AND contract_type_id    =#{contractTypeId}
		    AND delete_flag         =0
		    )
		  AND budget_type_id=#{budgetTypeId}
		  AND fiscal_year_id=#{budgetfiscalYear}
		  AND active_flag   ='1'
		  )
		AND sub_budget_id=#{id}
	</delete>
	
	<delete id="delContractConfAmendSubBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM sub_budget
		WHERE budget_id=
		  (SELECT budget_id
		  FROM budget
		  WHERE contract_id =#{amendmentContractId}
		  AND budget_type_id=#{budgetTypeId}
		  AND fiscal_year_id=#{budgetfiscalYear}
		  AND active_flag   ='1'
		  )
		AND sub_budget_id=#{id}
	</delete>
	<!-- start release 3.14.0 -->
	<delete id="delContractConfAmendSubBudgetParentDetailsNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM sub_budget
		WHERE parent_id = (select parent_id from sub_budget where sub_budget_id = #{id})
	</delete>
	<delete id="delContractConfAmendSubBudgetDetailsNextNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM sub_budget
		WHERE budget_id=
		  (SELECT budget_id
		  FROM budget
		  WHERE contract_id =#{amendmentContractId}
		  AND budget_type_id=#{budgetTypeId}
		  AND fiscal_year_id=#{budgetfiscalYear}
		  AND active_flag   ='1'
		  )
		AND sub_budget_id in (select sub_budget_id from sub_budget where parent_id = #{id} and sub_budget_name = #{subbudgetName})
	</delete>
	<!-- end release 3.14.0 -->
	
	<select id="fetchSubBudgetParentId" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String"> 
		 select 
		 	parent_id 
		 from 
		 	sub_budget 
		 where 
		 	budget_id=(select
		 					budget_id 
		 				from 
		 					budget 
		 				where 
		 					contract_id=(select 
		 									contract_id 
		 								from 
		 									contract 
		 								where 
		 									parent_contract_id=#{contractId} 
		 								and  
		 									contract_id !=#{contractId} 
		 								and 
		 									contract_type_id=#{contractTypeId}
		 								and 
		 								 	delete_flag=0
	 								 	) 
		 				and 
		 					budget_type_id=#{budgetTypeId} 
		 				and 
		 					fiscal_year_id=#{budgetfiscalYear} 
		 				and 
		 					active_flag='1') 
		 and 
         	sub_budget_id=parent_id 
         and
         	sub_budget_id=#{parentId}
	</select>

	<select id="fetchSubBudgetParentIdAmendment" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String"> 
		 select 
		 	parent_id 
		 from 
		 	sub_budget 
		 where 
		 	budget_id=(select
		 					budget_id 
		 				from 
		 					budget 
		 				where 
		 					contract_id=#{amendmentContractId} 
		 				and 
		 					budget_type_id=#{budgetTypeId} 
		 				and 
		 					fiscal_year_id=#{budgetfiscalYear} 
		 				and 
		 					active_flag='1') 
		 and 
         	sub_budget_id=parent_id 
         and
         	sub_budget_id=#{parentId}
	</select>
	
	<update id="updateContractConfSubBudgetAmt" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	   	update
	   		sub_budget 
	   	set 
	   		sub_budget_amount =#{proposedBudgetAmount} 
	   	where
	   		sub_budget_id=#{parentId} 
	</update>
	
	<delete id="delContractConfUpdateSubBudgetOldDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	update 
		sub_budget 
	set 
		active_flag='0' 
	where 
		budget_id=(select
						budget_id 
					from 
						budget
					where 
						contract_id=(select
										 contract_id 
									 from
									 	 contract 
									 where
									 	 parent_contract_id=#{contractId}
									 and  
									 	contract_id !=#{contractId}
									 and
									 	contract_type_id=#{contractTypeId}
									 and delete_flag=0
									  ) 
					and
						budget_type_id=#{budgetTypeId}
					and fiscal_year_id=#{budgetfiscalYear}
					and active_flag='1')
	and 
    	parent_id=#{id}	
	</delete>
	
	<insert id="insertContractConfUpdateFinishTask" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		Insert into CONTRACT_FINANCIALS 
		(CONTRACT_FINANCIALS_ID,
		 PROCUREMENT_ID,
		 CONTRACT_ID,
		 UNIT_OF_APPROPRIATION,
		 BUDGET_CODE,
		 OBJECT_CODE,
		 SUB_OBJECT_CODE,
		 REPORTING_CATEGORY,
		 FISCAL_YEAR_ID,
		 AMOUNT,
		 LAST_UPDATE_DATE,
		 ACTIVE_FLAG,
		 PARENT_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID)
		 values 
		
		(SEQ_CONTRACT_FINANCIALS_ID.nextval,
		#{procurementID},
		#{contractID},
		#{unitOfAppropriation},
		#{budgetCode},
		#{objectCode},
		#{subOc},
		#{rc},
		#{fiscalYearID},
		#{ammount},
		SYSTIMESTAMP,
		#{activeFlag},
		SEQ_CONTRACT_FINANCIALS_ID.currval,
		SYSTIMESTAMP,
		#{createdByUserId},
		SYSTIMESTAMP,
		#{createdByUserId})
	</insert>
	<update id="delContractConfUpdateNewRecordFinishTask" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials 
	    SET 
	 ACTIVE_FLAG = '0'
	 where contract_financials_id = #{id}
    </update>
    <update id="updateContractConfFiscalAmt" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  
	  update contract_financials set amount=#{ammount}  where contract_financials_id = (SELECT parent_id  FROM contract_financials WHERE contract_financials_id =#{id} )
 
    </update>
     <update id="delContractConfUpdateOldRecordFinishTask" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
	  UPDATE contract_financials 
	    SET 
	 ACTIVE_FLAG = '0'
	 where contract_financials_id = #{id} and contract_id = (select contract_id from contract  where parent_contract_id=#{contractID} and contract_id!=#{contractID} and contract_type_id=#{contractTypeId} and delete_flag=0)
    </update>
     <select id="checkContractDetails" parameterType="HashMap"
		resultType="String"> 
		select 
			contract_id 
		from 
			contract 
		where 
			parent_contract_id=#{contractID} 
		and 
			contract_type_id=#{contractTypeId} 
		and 
			delete_flag=0
	</select>
	<select id="fetchPlannedAmtForUpdatedContractId" parameterType="HashMap" resultType="java.lang.String">
		select SUM(amount) 
		from 
		contract_financials 
		where contract_id = (select contract_id from contract  where parent_contract_id=#{asContractId} and contract_id!=#{asContractId} and contract_type_id='4' and delete_flag=0) 
		and fiscal_year_id = #{asFiscalYearId} and active_flag = 1
	</select>
	 <select id="checkBudgetDetails" parameterType="HashMap"
		resultType="String"> 
		SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = (select contract_id from contract  where parent_contract_id=#{asContractId} and contract_id!=#{asContractId} and contract_type_id= 4 and delete_flag=0)  AND FISCAL_YEAR_ID=#{asFiscalYearId} and BUDGET_TYPE_ID='4' and active_flag = 1
	</select>
	<update id="delContractUpdatedId" parameterType="String">
	  update contract set delete_flag='1' where parent_contract_id=#{asContractID} and contract_id!=#{asContractID} and contract_type_id='4' and delete_flag='0' 
	 </update>
	<update id="updateBudgetStatus" parameterType="String">
	  update budget set status_id=84 where contract_id=(select contract_id from contract  where parent_contract_id=#{asContractID} and contract_id!=#{asContractID} and contract_type_id=4 and delete_flag=0) 
	 </update>

	<!--Release 3.6.0 Enhancement id 6484 -->
		<select id="fetchSubBudgetDetailsForUpdateConf" parameterType="hashmap" resultType="String">
			SELECT SUB_BUDGET_ID
			FROM SUB_BUDGET
			WHERE BUDGET_ID IN
			  (SELECT BUDGET_ID
			  FROM BUDGET
			  WHERE CONTRACT_ID=
			    (SELECT contract_id
			    FROM contract
			    WHERE parent_contract_id=#{asContractId}
			    AND contract_id!        =#{asContractId}
			    AND contract_type_id    =#{asBudgetTypeId}
			    AND delete_flag         =0
			    )
			  )
		</select>
		<!--3.6.0-->
		<select id="fetchSubBudgetDetailsForAmendmentConf" parameterType="String" resultType="String">
			SELECT SUB_BUDGET_ID
			FROM SUB_BUDGET
			WHERE BUDGET_ID IN
			  (SELECT BUDGET_ID
			  FROM BUDGET
			  WHERE CONTRACT_ID=
			    #{asContractId}
			  )
		</select>
	
	<resultMap id="budgetSiteDetails" type="com.nyc.hhs.model.SiteDetailsBean">
		<result property="budgetId" column="BUDGET_ID" />
		<result property="subBudgetId" column="SUB_BUDGET_ID" />
		<result property="parentSubBudgetId" column="PARENT_ID" />
	</resultMap>
	
		<select id="fetchSubBudgetDetailsBudgetUpdateTask" parameterType="String" resultMap="budgetSiteDetails">
		select SUB_BUDGET_ID,PARENT_ID from SUB_BUDGET where BUDGET_ID = #{budgetId} and SUB_BUDGET_ID !=PARENT_ID
		</select>
		
		<update id="softDeleteParent" parameterType="com.nyc.hhs.model.SiteDetailsBean">
		UPDATE SUB_BUDGET_SITE SET ACTIVE_FLAG = '0',MODIFIED_DATE =SYSTIMESTAMP,MODIFIED_BY_USERID = #{modifiedBy} WHERE SUB_BUDGET_ID = #{parentSubBudgetId}
		</update>
		
		<update id="updateParentSubBudgetSite" parameterType="com.nyc.hhs.model.SiteDetailsBean">
		UPDATE SUB_BUDGET_SITE SET SUB_BUDGET_ID = #{parentSubBudgetId},MODIFIED_DATE =SYSTIMESTAMP,MODIFIED_BY_USERID = #{modifiedBy}
		where SUB_BUDGET_ID =  #{subBudgetId} and ACTIVE_FLAG ='1'
		</update>
		
		<insert id="insertSubBudgetSiteDetailsForUpdate" parameterType="Integer">
		INSERT into
		SUB_BUDGET_SITE (CREATED_BY_USERID, CREATED_DATE, ADDRESS1, ADDRESS2,
		MODIFIED_BY_USERID, MODIFIED_DATE,CREATED_BY_STAFFID,MODIFIED_BY_STAFFID,
		SUB_BUDGET_SITE_ID,SUB_BUDGET_ID,ACTIVE_FLAG,
		CITY, SITE_NAME, STATE, ZIP_CODE,
		VAL_ASSEMBLY_DISTRICT, VAL_BOROUGH, VAL_BUILDING_ID_NUMBER,
		VAL_CITY,
		VAL_CIVIAL_COURT_DISTRICT, VAL_COMMUNITY_DISTRICT,
		VAL_CONGRESS_DISTRICT, VAL_COUNCIL_DISTRICT, VAL_HEALTH_AREA,
		VAL_HIGH_END_CROSS_STREET_NAME, VAL_HIGH_END_CROSS_STREET_NO,
		VAL_LATITUDE,
		VAL_LONGITUDE, VAL_LOW_END_CROSS_STREET_NAME,
		VAL_LOW_END_CROSS_STREET_NO,
		VAL_NORM_HOUSE_NUMBER,
		VAL_NORM_STREET_NAME, VAL_SCHOOL_DISTR_NAME,
		VAL_SENATOR_DISTRICT,
		VAL_STATE, VAL_STATUS_DECSCRIPTION,
		VAL_STATUS_REASON_TEXT,
		VAL_TAX_BLOCK, VAL_TAX_LOT,
		VAL_X_COORDINATE, VAL_Y_COORDINATE,
		VAL_ZIP_CODE)
		 (
    select  CREATED_BY_USERID, CREATED_DATE, ADDRESS1, ADDRESS2,
		MODIFIED_BY_USERID, MODIFIED_DATE,CREATED_BY_STAFFID,MODIFIED_BY_STAFFID,
		SEQ_SUB_BUDGET_SITE_ID.NEXTVAL, #{asSubBudgetId},ACTIVE_FLAG,
		CITY, SITE_NAME, STATE, ZIP_CODE,
		VAL_ASSEMBLY_DISTRICT, VAL_BOROUGH, VAL_BUILDING_ID_NUMBER,
		VAL_CITY,
		VAL_CIVIAL_COURT_DISTRICT, VAL_COMMUNITY_DISTRICT,
		VAL_CONGRESS_DISTRICT, VAL_COUNCIL_DISTRICT, VAL_HEALTH_AREA,
		VAL_HIGH_END_CROSS_STREET_NAME, VAL_HIGH_END_CROSS_STREET_NO,
		VAL_LATITUDE,
		VAL_LONGITUDE, VAL_LOW_END_CROSS_STREET_NAME,
		VAL_LOW_END_CROSS_STREET_NO,
		VAL_NORM_HOUSE_NUMBER,
		VAL_NORM_STREET_NAME, VAL_SCHOOL_DISTR_NAME,
		VAL_SENATOR_DISTRICT,
		VAL_STATE, VAL_STATUS_DECSCRIPTION,
		VAL_STATUS_REASON_TEXT,
		VAL_TAX_BLOCK, VAL_TAX_LOT,
		VAL_X_COORDINATE, VAL_Y_COORDINATE,
		VAL_ZIP_CODE  from SUB_BUDGET_SITE where sub_budget_id = (select parent_id from sub_budget where sub_budget_id = #{asSubBudgetId})
		and ACTIVE_FLAG = '1')
		</insert>
		
	<update id="updateR2BudgetStatusToPendSub" parameterType="String">
	  update budget set status_id=84 where contract_id in (select contract_id from contract where evaluation_pool_mapping_id = #{evaluationPoolMappingId}
	   and contract_type_id= 1  and status_id != 69) 
	 </update>

	<update id="updateR2ContractStatusToPendReg" parameterType="String">
     UPDATE CONTRACT SET STATUS_ID =(select STATUS_ID from STATUS_MASTER_R2_R3 where PROCESS_TYPE = 'Contract' AND STATUS = 'Pending Registration'),MODIFIED_DATE = current_timestamp  
       WHERE CONTRACT_ID in (select contract_id from contract where evaluation_pool_mapping_id = #{evaluationPoolMappingId}
	   and contract_type_id= 1  and status_id != 69)
	</update>
	
	<update id="updateBudgetConfiguration" parameterType="com.nyc.hhs.model.TaskDetailsBean">
	  update budget set status_id=84 where contract_id=#{contractId}
	 </update>
	 
	<update id="updateBudgetProcSelectionsMade" parameterType="com.nyc.hhs.model.TaskDetailsBean">
			  UPDATE budget
		SET status_id=84
		WHERE contract_id=#{contractId}
	 </update>
	 
	<update id="updateContractProcSelectionsMade" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		  UPDATE contract
		<!-- begin R6.3 QC5690 -->
		 SET status_id=(select STATUS_ID from STATUS_MASTER_R2_R3 where PROCESS_TYPE = 'Contract' AND STATUS = 'Pending Registration')   
		<!-- SET status_id=(select STATUS_ID from STATUS_MASTER_R2_R3 where PROCESS_TYPE = 'Contract' AND STATUS = 'Pending Notification') -->
		<!-- end R6.3 QC5690 -->
		WHERE contract_id=#{contractId}
	 </update>

	 <select id="fetchContractSourceType" parameterType="String"
		resultType="java.lang.String">
        SELECT
		CSM.CONTRACT_SOURCE
	 	FROM CONTRACT C, 
   		CONTRACT_SOURCE_MASTER CSM
	 	WHERE
   		C.CONTRACT_ID = #{contractId}
   	    AND C.CONTRACT_SOURCE_ID= CSM.CONTRACT_SOURCE_ID
     
	  </select>	
	  
	  <select id="fetchContractFiscalYears" parameterType="String"
	    resultType="Map">
        SELECT TO_CHAR(CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE , TO_CHAR(CONTRACT_END_DATE,'MM/DD/YYYY') AS CONTRACT_END_DATE
	    FROM CONTRACT
        WHERE 
        CONTRACT_ID = #{contractID}
     
	  </select>
	  
  	<select id="fetchBaseContractId" parameterType="String"
		resultType="java.lang.String">
		select 
			parent_contract_id 
		from
			contract 
		where 
			contract_id = #{asContractId}
	</select>
	
	<select id="fetchUpdateContractId" parameterType="String"
		resultType="java.lang.String">
	select 
			contract_id 
		from
			contract 
		where 
			parent_contract_id = #{asContractId}
    and   
      CONTRACT_TYPE_ID  = '4'
    and 
      delete_flag='0'		
	</select>
	
    <update id="updateBudgetFiscalYearAmount" parameterType="HashMap">
	  update budget set Fiscal_year_amount=#{asModifiedAmount} where budget_type_id=#{asBudgetTypeId} and Contract_id=(select contract_id from contract  where parent_contract_id=#{asContractId} and contract_id!=#{asContractId} and contract_type_id=4 and delete_flag=0)
	  and fiscal_year_id=#{asFiscalYearId}
   </update>
   	 <select id="fechActiveApprovedFiscalYears" parameterType="String"
		resultType="String">
        select 
        	FISCAL_YEAR_ID
        from
        	BUDGET
        where 
        	CONTRACT_ID = (select parent_contract_id from contract where contract_id =#{contractID})
   	    and 
   	    <!-- Start release 6 made changes for defect 8442 -->
   	    	STATUS_ID != 106
   	    <!-- End release 6 made changes for defect 8442 -->
   	    <!-- Start: Added in Release 7 for 8680 -->
   	    and
   	    	BUDGET_TYPE_ID = 2
   	    <!-- End: Added in Release 7 for 8680 -->
	  </select>	
	  
	    <select id="fetchContractType" parameterType="String"
		resultType="java.lang.String">
	        SELECT
			CONTRACT_TYPE_ID
		 	FROM CONTRACT 
		 	WHERE
	   		CONTRACT_ID = #{contractId}
	     
	  </select>	

	<!-- fine tuned query as part of build 2.6.0, enhancement 5653 -->
	<!-- added type to be in Approved or TaskRows -->
	<!-- R5 Changes starts-->
     <delete id="deleteRowsCoaDatesChanged" parameterType="map">
		DELETE
		FROM procurement_financials
		WHERE procurement_id = #{asProcurementId}
		AND type in ('Approved','TaskRows')
		AND fiscal_year_id NOT BETWEEN #{liStartYear} AND #{liEndYear}
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
     </delete>

	<!-- fine tuned query as part of build 2.6.0, enhancement 5653 -->
	<!-- added type to be in Approved or TaskRows -->
     <delete id="deleteRowsFundingDatesChanged" parameterType="map">
		DELETE
		FROM PROCUREMENT_FIN_FUNDING_STREAM
		WHERE procurement_id = #{asProcurementId}
		AND type in ('Approved','TaskRows')
		AND fiscal_year_id NOT BETWEEN #{liStartYear} AND #{liEndYear}
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
     </delete>

	<insert id="insertRowsCoaDatesChanged" parameterType="map">
	
		INSERT
			INTO PROCUREMENT_FINANCIALS
			  (
				PROCUREMENT_FINANCIALS_ID,
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  )
      	SELECT SEQ_PROCUREMENT_FINANCIALS_ID.nextval, 
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				tempFY,
				0,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  FROM PROCUREMENT_FINANCIALS,
        	<foreach item="items" index="index" collection="newlyAddedFY"
				open="(" separator=" union " close=")">
				select #{items} tempFY from dual
    		</foreach> 
     	WHERE 
        PROCUREMENT_ID = #{asProcurementId}
        AND TYPE = #{type} 
		AND FISCAL_YEAR_ID = #{existingFY}	
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
	</insert>

	<!-- fine tuned query as part of build 2.6.0, enhancement 5653-->
	<!-- corrected amount values to 0 in funding grid when fiscal years are increased/decreased -->
	<insert id="insertRowsFundingDatesChanged" parameterType="map">
	        INSERT
			INTO PROCUREMENT_FIN_FUNDING_STREAM
			  (
				PROCUREMENT_FUNDING_STREAM_ID,
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				VERSION_NUMBER)
			SELECT SEQ_PROCUREMENT_FUNDING_STM_ID.nextval, 
				PROCUREMENT_ID,
				0,
				0,
				0,
				0,
				tempFY,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				#{type},
				VERSION_NUMBER
			  FROM PROCUREMENT_FIN_FUNDING_STREAM,
        	<foreach item="items" index="index" collection="newlyAddedFY"
				open="(" separator=" union " close=")">
				select #{items} tempFY from dual
    		</foreach> 
     	WHERE 
        PROCUREMENT_ID = #{asProcurementId}
        AND TYPE = #{type} 
		AND FISCAL_YEAR_ID = #{existingFY}	
		and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId})
	</insert>
	<!-- R5 Changes ends-->
	<select id="fetchTotSubBudgetAmt" parameterType="com.nyc.hhs.model.ContractBudgetBean"
	resultType="BigDecimal"> 
	  select nvl(Sum(sub_budget_amount),0) as sub_bud_amt from sub_budget where 
	  sub_budget_id in (select sub_budget_id from sub_budget where budget_id = #{budgetId} and sub_budget_id != 
	  (select sub_budget_id from sub_budget where parent_id = #{id} and
	  active_flag = '1' and sub_budget_id != parent_id and budget_id = #{budgetId}))
	</select>

	 <select id="fetchAmendBudgetDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultMap="budgetDetailsList"> 
		SELECT BUDGET_ID, FISCAL_YEAR_AMOUNT
		 FROM BUDGET WHERE CONTRACT_ID = #{amendmentContractId} 
		  AND FISCAL_YEAR_ID=#{budgetfiscalYear} and BUDGET_TYPE_ID='1' and active_flag = 1
	</select>
	
	<select id="fetchProcDatesPublishedAndAddendum" parameterType="String"
		resultMap="procurementCOFDetails">
		SELECT TO_CHAR(pr.UPD_CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE ,
		  TO_CHAR(pr.UPD_CONTRACT_END_DATE,'MM/DD/YYYY')        AS CONTRACT_END_DATE,
		  TO_CHAR(pra.UPD_CONTRACT_START_DATE,'MM/DD/YYYY')     AS UPD_CONTRACT_START_DATE,
		  TO_CHAR(pra.UPD_CONTRACT_END_DATE,'MM/DD/YYYY')       AS UPD_CONTRACT_END_DATE
		FROM procurement pr
		FULL JOIN procurement_addendum pra
		ON pr.procurement_id    = pra.procurement_id
		WHERE pr.procurement_id = #{asProcurementId}
	</select>
	<!-- R5 Changes starts-->
	<!-- new query added as part of build 2.6.0, defect id 5653 -->
	<select id="validateProcValueAndAllocatedValue" parameterType="String" resultType="java.lang.String">
		SELECT (
		  CASE
		    WHEN ((b.ADDENDUM_PROC_VALUE                         IS NOT NULL)
		    AND (b.ADDENDUM_PROC_VALUE                            = C.ALLOCATED_AMOUNT)
		    AND (B.ADDENDUM_PROC_VALUE                            = #{oldProcValTask})
		    AND (trim(TO_CHAR(B.UPD_CONTRACT_START_DATE, 'mm/dd/yyyy')) = #{oldContStartDateTask})
		    AND (trim(TO_CHAR(b.UPD_CONTRACT_END_DATE, 'mm/dd/yyyy'))   = #{oldContEndDateTask}))
		    THEN '1'
		    WHEN ((b.ADDENDUM_PROC_VALUE                         IS NULL)
		    AND (a.ESTIMATED_PROCUREMENT_VALUE                    = C.ALLOCATED_AMOUNT)
		    AND (a.ESTIMATED_PROCUREMENT_VALUE                    = #{oldProcValTask})
		    AND (trim(TO_CHAR(a.UPD_CONTRACT_START_DATE, 'mm/dd/yyyy')) = #{oldContStartDateTask})
		    AND (trim(TO_CHAR(a.UPD_CONTRACT_END_DATE, 'mm/dd/yyyy'))   = #{oldContEndDateTask}))
		    THEN '1'
		    ELSE '0'
		  END) AS AMOUNT_EQUAL
		FROM procurement a,
		  (SELECT MAX(ESTIMATED_PROCUREMENT_VALUE) AS ADDENDUM_PROC_VALUE,
		    MAX(UPD_CONTRACT_START_DATE)           AS UPD_CONTRACT_START_DATE,
		    MAX(UPD_CONTRACT_END_DATE)             AS UPD_CONTRACT_END_DATE
		  FROM procurement_addendum
		  WHERE procurement_id = #{procurementId}
		  ) b,
		  (SELECT SUM(AMOUNT) AS ALLOCATED_AMOUNT
		  FROM procurement_financials
		  WHERE procurement_id = #{procurementId}
		  AND type             = 'TaskRows'
		  and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
		  )C
		WHERE a.PROCUREMENT_ID = #{procurementId} 		
	</select>
	<!-- R5 Changes ends-->
	<insert id="insertBudgetCustomization" parameterType="hashmap">
		INSERT INTO BUDGET_CUSTOMIZATION 
		(BUDGET_CUSTOMIZATION_ID,
		 CONTRACT_ID,
		 BUDGET_ID,
		 ENTRY_TYPE_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 ISPUBLISHED)
		 values
		 (
		 SEQ_BUDGET_CUSTOMIZATION_ID.nextval,
		 #{contractID,jdbcType=NUMERIC},
		 #{budgetID,jdbcType=NUMERIC},
		 #{entryTypeId,jdbcType=NUMERIC},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 #{published,jdbcType=NUMERIC}
		 )
	</insert>
	
	<insert id="insertBudgetCustomizationForUpdate" parameterType="hashmap">
		INSERT INTO BUDGET_CUSTOMIZATION 
		(BUDGET_CUSTOMIZATION_ID,
		 CONTRACT_ID,
		 BUDGET_ID,
		 ENTRY_TYPE_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 ISPUBLISHED)
		 values
		 (
		 SEQ_BUDGET_CUSTOMIZATION_ID.nextval,
		 (SELECT MAX(BUDGET.CONTRACT_ID)
			FROM CONTRACT
			INNER JOIN BUDGET ON BUDGET.CONTRACT_ID  = CONTRACT.CONTRACT_ID
			WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC}
			AND CONTRACT.CONTRACT_TYPE_ID     = #{contractTypeId,jdbcType=NUMERIC}
			AND BUDGET.FISCAL_YEAR_ID         = #{budgetfiscalYear,jdbcType=NUMERIC}),
		 (SELECT MAX(BUDGET.BUDGET_ID)
			FROM CONTRACT
			INNER JOIN BUDGET ON BUDGET.CONTRACT_ID  = CONTRACT.CONTRACT_ID
			WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC}
			AND CONTRACT.CONTRACT_TYPE_ID     = #{contractTypeId,jdbcType=NUMERIC}
			AND BUDGET.FISCAL_YEAR_ID         = #{budgetfiscalYear,jdbcType=NUMERIC}),
		 #{entryTypeId,jdbcType=NUMERIC},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 '0'
		 )
	</insert>
	
	<insert id="mergeBudCustomizationCBUpdateReview" parameterType="hashmap">
		INSERT INTO BUDGET_CUSTOMIZATION 
		(BUDGET_CUSTOMIZATION_ID,
		 CONTRACT_ID,
		 BUDGET_ID,
		 ENTRY_TYPE_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 ISPUBLISHED)
		 values
		 (
		 SEQ_BUDGET_CUSTOMIZATION_ID.nextval,
		 (SELECT PARENT_CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID = #{contractID}),
		 (SELECT PARENT_ID FROM BUDGET WHERE BUDGET_ID = #{budgetID}),
		 #{entryTypeId,jdbcType=NUMERIC},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 SYSTIMESTAMP,
		 #{createdByUserId,jdbcType=VARCHAR},
		 '1'
		 )
	</insert>
	
	<delete id="deleteBudgetCustomization" parameterType="hashmap">
		DELETE
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID     = #{budgetID}
		AND ENTRY_TYPE_ID = #{entryTypeId}
	</delete>
	
	<delete id="deleteBudgetCustomizationForUpdate" parameterType="hashmap">
		DELETE
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = (SELECT BUDGET.CONTRACT_ID 
                          FROM CONTRACT 
                          INNER JOIN BUDGET ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID 
                          WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC} AND CONTRACT.CONTRACT_TYPE_ID = #{contractTypeId,jdbcType=NUMERIC} AND BUDGET.FISCAL_YEAR_ID = #{budgetfiscalYear,jdbcType=NUMERIC})
		AND BUDGET_ID     = (SELECT BUDGET.BUDGET_ID 
                          FROM CONTRACT 
                          INNER JOIN BUDGET ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID 
                          WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC} AND CONTRACT.CONTRACT_TYPE_ID = #{contractTypeId,jdbcType=NUMERIC} AND BUDGET.FISCAL_YEAR_ID = #{budgetfiscalYear,jdbcType=NUMERIC})
		AND ENTRY_TYPE_ID = #{entryTypeId,jdbcType=NUMERIC}
	</delete>
	
	<select id="fetchEntryTypeDetails" parameterType="hashmap" resultType="String">
		SELECT DISTINCT(ENTRY_TYPE_ID || ':'|| ISPUBLISHED)
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID = #{budgetID}
	</select>
	
	<update id="updateBudgetCustomization" parameterType="hashmap">
		UPDATE BUDGET_CUSTOMIZATION
				SET ISPUBLISHED     = #{published},
				MODIFIED_DATE       = SYSTIMESTAMP,
				MODIFIED_BY_USERID  = #{modifiedByUserId}
				WHERE BUDGET_ID  = (SELECT BUDGET.BUDGET_ID 
                          FROM CONTRACT 
                          INNER JOIN BUDGET ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID 
                          WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC} 
                          AND CONTRACT.CONTRACT_TYPE_ID = #{budgetTypeId,jdbcType=NUMERIC} 
                          AND BUDGET.FISCAL_YEAR_ID = #{fiscalYearID,jdbcType=NUMERIC}
                          )
				AND CONTRACT_ID  = (SELECT BUDGET.CONTRACT_ID 
                          FROM CONTRACT 
                          INNER JOIN BUDGET ON BUDGET.CONTRACT_ID = CONTRACT.CONTRACT_ID 
                          WHERE CONTRACT.PARENT_CONTRACT_Id = #{contractID,jdbcType=NUMERIC} 
                          AND CONTRACT.CONTRACT_TYPE_ID = #{budgetTypeId,jdbcType=NUMERIC} 
                          AND BUDGET.FISCAL_YEAR_ID = #{fiscalYearID,jdbcType=NUMERIC}
                          )
	</update>
	<!-- release 3.14.0 -->
	<update id="updateBudgetCustomizationOnNewFyBudget" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE BUDGET_CUSTOMIZATION
				SET ISPUBLISHED     = 0,
				MODIFIED_DATE       = SYSTIMESTAMP,
				MODIFIED_BY_USERID  = #{modifiedByUserId}
				WHERE BUDGET_ID  in (select parent_id from budget where budget_id = #{budgetId})
	</update>
	<!-- release 3.14.0 -->
	<update id="updateBudgetCustomizationForUpdate" parameterType="hashmap">
		UPDATE BUDGET_CUSTOMIZATION
				SET ISPUBLISHED     = #{published},
				MODIFIED_DATE       = SYSTIMESTAMP,
				MODIFIED_BY_USERID  = #{modifiedByUserId}
				WHERE BUDGET_ID  = (SELECT budget_id FROM budget WHERE budget_type_id = ( SELECT budget_type_id 
				  												FROM budget_type WHERE budget_type LIKE #{budgetTypeId} )
				 												AND contract_id = #{contractID} 
				 												<if test="fiscalYearID != null and fiscalYearID != '' ">
				 												AND fiscal_year_id = #{fiscalYearID}
				 												</if>
				  						  )
				AND CONTRACT_ID  = #{contractID}
	</update>
	
	<select id="getBudgetFromContractAndFiscalYEar" parameterType="hashmap" resultType="String">
		SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{contractID,jdbcType=NUMERIC} AND FISCAL_YEAR_ID=#{budgetfiscalYear,jdbcType=NUMERIC} AND BUDGET_TYPE_ID='2'
	</select>
	
	<select id="countEntryTypeFromCBC" parameterType="hashmap" resultType="Integer">
		SELECT count(1) FROM BUDGET_CUSTOMIZATION WHERE CONTRACT_ID =#{contractID} AND BUDGET_ID = #{budgetID}
	</select>
	
	<select id="fetchEntryTypeDetailsForUpdateContract" parameterType="hashmap" resultType="String">
		SELECT DISTINCT(ENTRY_TYPE_ID
		  || ':1')
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID     = #{budgetID}
		UNION ALL
		SELECT ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID =
		  (SELECT contract_id
			FROM contract
			WHERE parent_contract_id=#{contractID}
			AND contract_type_id    =#{contractTypeId}
			AND delete_flag         =0
		  )
		AND BUDGET_ID = (SELECT budget_id
							FROM budget
							WHERE contract_id IN
							  (SELECT contract_id
								  FROM contract
								  WHERE parent_contract_id=#{contractID}
								  AND contract_type_id    =#{contractTypeId}
								  AND delete_flag         = 0
							  )
							AND budget_type_id = #{contractTypeId}
							AND fiscal_Year_id = #{fiscalYear}
						)
	</select>
	
	<select id="fetchEntryTypeDetailsForContractUpdateLanding" parameterType="hashmap" resultType="String">
		SELECT ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID     = #{budgetID}
		UNION ALL
		SELECT DISTINCT(ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED)
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = (SELECT PARENT_CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID = #{contractID})
		AND BUDGET_ID     = (SELECT PARENT_ID FROM BUDGET WHERE BUDGET_ID = #{budgetID})
	</select>
	
	<select id="fetchEntryTypeDetailsForAmendment" parameterType="hashmap" resultType="String">
		SELECT ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{UpdateContractId}
		AND BUDGET_ID     = (SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{UpdateContractId} AND BUDGET_TYPE_ID = 1 AND FISCAL_YEAR_ID=#{fiscalYear})
		UNION ALL
		SELECT ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID     = (SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{contractID} AND BUDGET_TYPE_ID = 2 AND FISCAL_YEAR_ID=#{fiscalYear})
	</select>
	
	<select id="fetchEntryTypeDetailsFromModification" parameterType="hashmap" resultType="String">
		SELECT ENTRY_TYPE_ID
		|| ':'
		|| ISPUBLISHED FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{contractID}
		AND BUDGET_ID = (SELECT PARENT_ID FROM BUDGET WHERE BUDGET_ID =
		#{budgetID} AND CONTRACT_ID = #{contractID} AND BUDGET_TYPE_ID = 3)
	</select>
	
	<select id="getAmendFromBudCustomization" parameterType="com.nyc.hhs.model.ContractBean" resultType="Integer">
		SELECT COUNT(*)
			FROM BUDGET_CUSTOMIZTION
			WHERE CONTRACT_ID = (SELECT CONTRACT.CONTRACT_ID
									  FROM BUDGET
									  INNER JOIN CONTRACT
									  ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
									  WHERE BUDGET.CONTRACT_ID      = #{contractId}
									  AND BUDGET.BUDGET_TYPE_ID     = '1'
									  AND CONTRACT.CONTRACT_TYPE_ID = '2'
									)
				AND 
					BUDGET_ID = 	(SELECT BUDGET.BUDGET_ID
									  FROM BUDGET
									  INNER JOIN CONTRACT
									  ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
									  WHERE BUDGET.CONTRACT_ID      = #{contractId}
									  AND BUDGET.BUDGET_TYPE_ID     = '1'
									  AND CONTRACT.CONTRACT_TYPE_ID = '2'
									)  
	</select>
	
	<select id="fetchEntryForBaseAmendMerge" parameterType="com.nyc.hhs.model.ContractBean" resultType="String">
	SELECT ENTRY_TYPE_ID
		  || ':'
		  || ISPUBLISHED
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = (SELECT CONTRACT.CONTRACT_ID
                          FROM BUDGET
                          INNER JOIN CONTRACT
                          ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                          WHERE BUDGET.CONTRACT_ID      = #{contractId}
                          AND BUDGET.BUDGET_TYPE_ID     = '1'
                          AND CONTRACT.CONTRACT_TYPE_ID = '2'
                          )
        AND BUDGET_ID =
                          (SELECT BUDGET.BUDGET_ID
                          FROM BUDGET
                          INNER JOIN CONTRACT
                          ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                          WHERE BUDGET.CONTRACT_ID      = #{contractId}
                          AND BUDGET.BUDGET_TYPE_ID     = '1'
                          AND CONTRACT.CONTRACT_TYPE_ID = '2'
                          )
	</select>
	
	<insert id="mergeBaseBudCustomization" parameterType="hashmap">
		INSERT INTO BUDGET_CUSTOMIZATION 
		(BUDGET_CUSTOMIZATION_ID,
		 CONTRACT_ID,
		 BUDGET_ID,
		 ENTRY_TYPE_ID,
		 CREATED_DATE,
		 CREATED_BY_USERID,
		 MODIFIED_DATE,
		 MODIFIED_BY_USERID,
		 ISPUBLISHED)
		 values
		 (
		 SEQ_BUDGET_CUSTOMIZATION_ID.nextval,
		 (SELECT CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID =(SELECT  CONTRACT.PARENT_CONTRACT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND CONTRACT_TYPE_ID = '1'
                            AND CONTRACT_ID = PARENT_CONTRACT_ID ),
		 ( SELECT BUDGET_ID FROM BUDGET WHERE BUDGET_ID =(SELECT  BUDGET.PARENT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND BUDGET_TYPE_ID = '2'
                            AND BUDGET_ID = PARENT_ID),
		 #{entryTypeId,jdbcType=NUMERIC},
		 SYSTIMESTAMP,
		 (SELECT CREATED_BY_USERID FROM BUDGET_CUSTOMIZATION WHERE BUDGET_ID = ( SELECT BUDGET_ID FROM BUDGET WHERE BUDGET_ID =(SELECT  BUDGET.PARENT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND BUDGET_TYPE_ID = '2'
                            AND BUDGET_ID = PARENT_ID)
                            AND CONTRACT_ID = (SELECT CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID =(SELECT  CONTRACT.PARENT_CONTRACT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND CONTRACT_TYPE_ID = '1'
                            AND CONTRACT_ID = PARENT_CONTRACT_ID )
                            AND ENTRY_TYPE_ID = 2),
		 SYSTIMESTAMP,
		 (SELECT MODIFIED_BY_USERID FROM BUDGET_CUSTOMIZATION WHERE BUDGET_ID = ( SELECT BUDGET_ID FROM BUDGET WHERE BUDGET_ID =(SELECT  BUDGET.PARENT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND BUDGET_TYPE_ID = '2'
                            AND BUDGET_ID = PARENT_ID)
                            AND CONTRACT_ID = (SELECT CONTRACT_ID FROM CONTRACT WHERE CONTRACT_ID =(SELECT  CONTRACT.PARENT_CONTRACT_ID
                            FROM BUDGET
                            INNER JOIN CONTRACT
                            ON BUDGET.CONTRACT_ID         = CONTRACT.CONTRACT_ID
                            WHERE BUDGET.CONTRACT_ID      = ${contractID}
                            AND BUDGET.BUDGET_TYPE_ID     = '1'
                            AND CONTRACT.CONTRACT_TYPE_ID = '2')
                            AND CONTRACT_TYPE_ID = '1'
                            AND CONTRACT_ID = PARENT_CONTRACT_ID )
                            AND ENTRY_TYPE_ID = 2),
		 '1'
		 )
	</insert>
	
	<select id="fetchAmendmentSubBudgetCount" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="HashMap">
		SELECT MAX(SUB_BUDGET_COUNT)   AS SUB_BUDGET_COUNT,
 		MAX(CONT_FIN_AMT_EQUAL_ZERO) AS CONT_FIN_AMT_EQUAL_ZERO
		FROM
  		(SELECT COUNT(SUB_BUDGET_ID) AS SUB_BUDGET_COUNT ,
   		 ''                         AS CONT_FIN_AMT_EQUAL_ZERO
  		FROM sub_budget
 	 WHERE budget_id =
    (SELECT budget_id
    FROM budget
    WHERE contract_id  =#{amendmentContractID}
    AND fiscal_year_id = #{fiscalYearID}
    )
 	 AND sub_budget_amount != 0
 	 UNION
  	SELECT 0 AS SUB_BUDGET_COUNT,
    (
    CASE
      WHEN NVL(SUM(amount),0) = 0
      THEN 'true'
      ELSE 'false'
    END)AS CONT_FIN_AMT_EQUAL_ZERO
 	 FROM contract_financials
 	 WHERE fiscal_year_id = #{fiscalYearID}
 	 AND contract_id      = #{amendmentContractID}
 	 AND (UNIT_OF_APPROPRIATION
    || '-'
    || BUDGET_CODE
    || '-'
    || OBJECT_CODE
    || '-'
    || SUB_OBJECT_CODE
    || '-'
    || REPORTING_CATEGORY) != #{id}
  )
		
	</select>	

	<delete id="deleteAmendmentSubBudgetRow" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		DELETE
		FROM SUB_BUDGET 
		WHERE BUDGET_ID =
		  (SELECT budget_id
		  FROM budget
		  WHERE contract_id  = #{amendmentContractID}
		  AND fiscal_year_id = #{fiscalYearID}
		  )
     </delete>

	<delete id="deleteAmendmentBudgetRow" parameterType="com.nyc.hhs.model.AccountsAllocationBean">
		DELETE
		FROM BUDGET
		WHERE BUDGET_ID =
		  (SELECT budget_id
		  FROM budget
		  WHERE contract_id  = #{amendmentContractID}
		  AND fiscal_year_id = #{fiscalYearID}
		  )
     </delete>

	<select id="checkForNewFY" parameterType="hashmap" resultType="Integer">
		SELECT count(1) FROM BUDGET
		WHERE CONTRACT_ID = #{contractID}
		AND FISCAL_YEAR_ID &lt;=#{fiscalYearID}
	</select>	
	
	<select id="getParentSubBudgetId" parameterType="hashmap" resultType="String">
		SELECT SUB_BUDGET.SUB_BUDGET_ID
		FROM BUDGET
		INNER JOIN SUB_BUDGET
		ON BUDGET.BUDGET_ID       = SUB_BUDGET.BUDGET_ID
		WHERE BUDGET.CONTRACT_ID  = #{contractID}
		AND BUDGET.FISCAL_YEAR_ID = (#{fiscalYearID} - 1) 
    	order by SUB_BUDGET.SUB_BUDGET_ID 
	</select>
	
	<select id="getBaseSubBudgetId" parameterType="hashmap" resultType="String">
		 SELECT SUB_BUDGET.SUB_BUDGET_ID AS subBudgetId  FROM SUB_BUDGET
		    INNER JOIN BUDGET ON SUB_BUDGET.BUDGET_ID = BUDGET.BUDGET_ID
		    WHERE BUDGET.BUDGET_ID = ${budgetID} AND BUDGET.CONTRACT_ID = #{contractID}
		    AND ROWNUM &lt;= ( SELECT COUNT(SUB_BUDGET.SUB_BUDGET_ID)
				FROM BUDGET
				INNER JOIN SUB_BUDGET
				ON BUDGET.BUDGET_ID       = SUB_BUDGET.BUDGET_ID
				WHERE BUDGET.CONTRACT_ID  = #{contractID}
				AND BUDGET.FISCAL_YEAR_ID = (#{fiscalYearID} - 1) )
		   order by SUB_BUDGET.SUB_BUDGET_ID
	</select>
	
	<select id="checkLineItemDefaultEntries" parameterType="com.nyc.hhs.model.ContractBudgetBean" resultType="Integer">
		select count(1) from OPERATIONS_AND_SUPPORT where sub_budget_id = #{id}
	</select>
	
	<delete id="deleteLineItemDefaultEntries" parameterType="hashmap">
		delete from ${defaultTableName} where sub_budget_id = #{id}
	</delete>
	
	<!-- changed query as part of build 3.1.0, enhancement id 6020-->
	<select id="fetchContractDetails" parameterType="com.nyc.hhs.model.CBGridBean" resultType="map">
		select TO_CHAR(contract_start_date,'MM/DD/YYYY') CONTRACT_START_DATE, 
		TO_CHAR(contract_end_date,'MM/DD/YYYY') CONTRACT_END_DATE, CONTRACT_AMOUNT, BUDGET_START_YEAR from contract where contract_id = #{contractID}
	</select>
	<!-- R5 Changes starts-->
	<!-- Start of changes in build no 3.2.0 for enhancement#5684 -->
	 <insert id="insertTaskRowsAsTypeApproved" parameterType="com.nyc.hhs.model.TaskDetailsBean">
			INSERT
			INTO PROCUREMENT_FINANCIALS
			  (
				PROCUREMENT_FINANCIALS_ID,
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  )
			SELECT SEQ_PROCUREMENT_FINANCIALS_ID.nextval, 
				PROCUREMENT_ID,
				UNIT_OF_APPROPRIATION,
				BUDGET_CODE,
				OBJECT_CODE,
				SUB_OBJECT_CODE,
				REPORTING_CATEGORY,
				FISCAL_YEAR_ID,
				AMOUNT,
				PCOF_STATUS_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				'Approved',
				APPROVED_BY,
				APPROVED_DATE,
				VERSION_NUMBER
			  FROM PROCUREMENT_FINANCIALS
     	WHERE 
        PROCUREMENT_ID = #{procurementId}
        AND TYPE = 'TaskRows' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        </insert>
        
         <insert id="insertProcFundTaskRowsAsTypeApproved" parameterType="com.nyc.hhs.model.TaskDetailsBean">
        			INSERT
			INTO PROCUREMENT_FIN_FUNDING_STREAM
			  (
				PROCUREMENT_FUNDING_STREAM_ID,
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				TYPE,
				VERSION_NUMBER)
			SELECT SEQ_PROCUREMENT_FUNDING_STM_ID.nextval, 
				PROCUREMENT_ID,
				FEDERAL_AMOUNT,
				STATE_AMOUNT,
				CITY_AMOUNT,
				OTHER_AMOUNT,
				FISCAL_YEAR_ID,
				LAST_UPDATE_DATE,
				ACTIVE_FLAG,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				'Approved',
				VERSION_NUMBER
			  FROM PROCUREMENT_FIN_FUNDING_STREAM
     	WHERE 
        PROCUREMENT_ID = #{procurementId}
        AND TYPE = 'TaskRows' 
        and VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
        </insert>
        
        <select id="fetchPCOFStatus" parameterType="String"
		resultType="java.lang.String">
			select ST.STATUS_ID 
			from PROCUREMENT_FINANCIALS PCOF, STATUS_MASTER_R2_R3 ST 
			where PCOF.PCOF_STATUS_ID = ST.STATUS_ID 
			AND PCOF.PROCUREMENT_ID = #{asProcurementId}
			and PCOF.VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementId}) 
			AND ROWNUM = 1
		</select>
		
	<select id="fetchProcFinancialEntry" parameterType="String" resultType="Integer">
		select count(1) from PROCUREMENT_FINANCIALS where PROCUREMENT_ID = #{asProcurementID} 
		AND VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{asProcurementID})
	</select>
	
	
	 <delete id="deleteRowsWithTypeApproved" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		delete FROM PROCUREMENT_FINANCIALS where
		procurement_id =  #{procurementId}
		AND TYPE = 'Approved'
		AND VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
     </delete>
     
     <delete id="deleteProcFundRowsWithTypeApproved" parameterType="com.nyc.hhs.model.TaskDetailsBean">
		delete FROM procurement_fin_funding_stream where
		procurement_id =  #{procurementId}
		AND TYPE = 'Approved'
		AND VERSION_NUMBER = (select PCOF_PSR_VERSION_NUMBER from procurement where procurement_id = #{procurementId})
     </delete>
     <!-- R5 Changes ends-->
	<!-- End of changes in build no 3.2.0 for enhancement#5684 -->
	
	 <!--Added as a part of release 3.6.0 for enhancement request #6496-->
     <select id="fetchBudgetDetailsForNT403" parameterType="HashMap" resultType="HashMap">
		select bud.BUDGET_ID,bud.FISCAL_YEAR_ID,agc.AGENCY_NAME from budget bud, NYC_AGENCY_DETAILS agc where
		bud.AGENCY_ID = agc.AGENCY_ID
		and bud.contract_id = #{contractId}
	</select>
	
	<!-- Start of changes in build no 3.8.0 for enhancement#6483 -->
	<delete id="deleteBudgetCustForCancelUpdate" parameterType="String">
		DELETE
		FROM BUDGET_CUSTOMIZATION
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<delete id="deleteSubbudgetForCancelUpdate" parameterType="String">
		DELETE
		FROM SUB_BUDGET
		WHERE BUDGET_ID in (Select BUDGET_ID from BUDGET where CONTRACT_ID = #{asContractID})
	</delete>

	<delete id="deleteBudgetForCancelUpdate" parameterType="String">
		DELETE
		FROM BUDGET
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<delete id="deleteConFinForCancelUpdate" parameterType="String">
		DELETE
		FROM CONTRACT_FINANCIALS
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<delete id="deleteConFundingForCancelUpdate" parameterType="String">
		DELETE
		FROM CONTRACT_FIN_FUNDING_STREAM
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<select id="fetchUpdateContractDocs" parameterType="String"
		resultType="String">
		select DOCUMENT_IDENTIFIER_ID from contract_document where CONTRACT_ID = #{asContractID}
	</select>
	
	<delete id="deleteUpdateDocuments" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM CONTRACT_DOCUMENT
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<delete id="deleteContractForCancelUpdate" parameterType="String">
		DELETE
		FROM CONTRACT
		WHERE CONTRACT_ID = #{asContractID}
	</delete>
	
	<select id="fetchDiscrepencyDetailsForUpdateTask" parameterType="String" resultType="String">
		 SELECT contract_id FROM contract
    	 WHERE (TO_CHAR(CONTRACT_START_DATE, 'DD/MM/YYYY') != TO_CHAR(FMS_CONTRACT_START_DATE, 'DD/MM/YYYY')
    	 or TO_CHAR(CONTRACT_END_DATE, 'DD/MM/YYYY') != TO_CHAR(FMS_CONTRACT_END_DATE, 'DD/MM/YYYY')
    	 or CONTRACT_AMOUNT != FMS_CONTRACT_AMOUNT)
    	 and contract_id = #{asContractID}
	</select>
	

	<!-- End of changes in build no 3.8.0 for enhancement#6483 -->


	<!-- [Start] R3.9.0 6524  -->

	<resultMap    id="contractRenewalDetails" type="com.nyc.hhs.model.ContractCOFDetails">
			<result property="contractId"				column="CONTRACT_ID"    			  />
			<result property="procurementTitle"			column="PROCUREMENT_TITLE"    			  />
			<result property="epin"						column="EPIN"    			  />
			<result property="awardEpin"				column="AWARD_EPIN"    			  />
			<result property="agencyName"				column="AGENCY_NAME"    			 />
			<result property="agencyCode"				column="AGENCY_CODE"    			 />
			<result property="contractAmount"			column="CONTRACT_AMOUNT"    		 />
			<result property="procurementId"			column="PROCUREMENT_ID"			 />
			<result property="contractStartDate"		column="CONTRACT_START_DATE"		 />
			<result property="contract_endDate"			column="CONTRACT_END_DATE"    	 />
			<result property="organizationLegalName"	column="ORGANIZATION_LEGAL_NAME"	 />
			<result property="firstName"				column="FIRST_NAME"    			 />
			<result property="lastName"					column="LAST_NAME"    			 />
			<result property="approvedFirstName"		column="APPROVED_FN"    			 />
			<result property="approvedLastName"			column="APPROVED_LN"    			 />
			<result property="approvedBy"				column="APPROVED_BY"    			 />
			<result property="approvedDate"				column="APPROVED_DATE"    			 />
			<result property="unitOfAppropriation"		column="UNIT_OF_APPROPRIATION"     />
			<result property="budgetCode"				column="BUDGET_CODE"    			 />
			<result property="objectCode"				column="OBJECT_CODE"    			 />
			<result property="subObjectCode"			column="SUB_OBJECT_CODE"    		 />
			<result property="reportingCategory"			column="REPORTING_CATEGORY"    		 />
			<result property="fiscalYearId"				column="FISCAL_YEAR_ID"    		 />
			<result property="amount"					column="AMOUNT"    				 />
			<result property="federalAmount"			column="FEDERAL_AMOUNT"    		 />
			<result property="stateAmount"				column="STATE_AMOUNT"    			 />
			<result property="cityAmount"				column="CITY_AMOUNT"    			 />	
			<result property="otherAmount"				column="OTHER_AMOUNT"    			 />
			<result property="modifiedDate"				column="MODIFIED_DATE"    		 />
			<result property="modifiedByUserId"			column="MODIFIED_BY_USERID"    	 />
	</resultMap>     
<!-- Modified for R6: New Epin validation -->
	<select id="getContractRenewalDetailInfo" parameterType="String" resultMap="contractRenewalDetails">
		SELECT   CON.CONTRACT_ID  , PROCUREMENT_TITLE  , EPIN  , AWARD_EPIN  
				, AGENCY_NAME  , AGENCY_CODE  , CONTRACT_AMOUNT  , PROCUREMENT_ID  
				, CONTRACT_START_DATE  , CONTRACT_END_DATE  , ORGANIZATION_LEGAL_NAME  
				, FIRST_NAME  , LAST_NAME , APPROVED_FN , APPROVED_LN 
				, APPROVED_BY  , APPROVED_DATE   , UNIT_OF_APPROPRIATION  
				, BUDGET_CODE   , OBJECT_CODE  ,  SUB_OBJECT_CODE   , REPORTING_CATEGORY
				, FISCAL_YEAR_ID    , AMOUNT  , FEDERAL_AMOUNT    , STATE_AMOUNT  , CITY_AMOUNT   , OTHER_AMOUNT 
				, MODIFIED_DATE  ,		MODIFIED_BY_USERID  
		FROM (		SELECT CON.CONTRACT_ID , AGN.AGENCY_NAME,  AGN.AGENCY_CODE  , CON.CONTRACT_AMOUNT, CON.PROCUREMENT_ID 
						   , CON.EXT_EPIN AS AWARD_EPIN , CON.CONTRACT_TITLE AS PROCUREMENT_TITLE
					       , TO_CHAR(CON.CONTRACT_START_DATE,'MM/DD/YYYY') AS CONTRACT_START_DATE
					       , TO_CHAR(CON.CONTRACT_END_DATE,'MM/DD/YYYY') AS CONTRACT_END_DATE,  ORG.ORGANIZATION_LEGAL_NAME
                   , ( SELECT  PROCUREMENT_AWARD_EPIN 
                         FROM  REF_APT_EPIN_MASTER 
                        WHERE  REF_APT_EPIN_ID = ( SELECT PROCUREMENT_EPIN_ID 
                                                     FROM REF_APT_EPIN_MASTER 
                                                    WHERE REF_APT_EPIN_ID = CON.REF_APT_EPIN_ID) 
                        AND    ROWNUM = 1
                     )  AS EPIN 
					FROM CONTRACT CON,	PROCUREMENT PR, NYC_AGENCY_DETAILS AGN, ORGANIZATION ORG
					WHERE CON.CONTRACT_ID = #{asContractID}
					AND AGN.AGENCY_ID = CON.AGENCY_ID
					AND PR.PROCUREMENT_ID(+) =CON.PROCUREMENT_ID
					AND ORG.ORGANIZATION_ID = CON.ORGANIZATION_ID
					) CON,
			(	SELECT  USER2.FIRST_NAME AS FIRST_NAME,		USER2.LAST_NAME AS LAST_NAME 
					, (	CASE WHEN APPROVED_BY IS NOT NULL  THEN USER1.FIRST_NAME ELSE ' ' END) AS APPROVED_FN
					, ( CASE WHEN APPROVED_BY IS NOT NULL THEN USER1.LAST_NAME ELSE ' ' END) AS APPROVED_LN
					, CF.CONTRACT_ID,  CF.APPROVED_BY, CF.UNIT_OF_APPROPRIATION , CF.BUDGET_CODE,  CF.OBJECT_CODE ,  CF.SUB_OBJECT_CODE  , CF.REPORTING_CATEGORY
					, CF.AMOUNT , CF.FISCAL_YEAR_ID , CFF.FEDERAL_AMOUNT , CFF.STATE_AMOUNT , CFF.CITY_AMOUNT , CFF.OTHER_AMOUNT , CFF.FISCAL_YEAR_ID AS FY_ID
					, TO_CHAR(CF.MODIFIED_DATE,'MM/DD/YYYY' ) AS MODIFIED_DATE,		CF.MODIFIED_BY_USERID 
					, ( CASE 	WHEN CF.APPROVED_DATE IS NOT NULL THEN TO_CHAR(CF.APPROVED_DATE,'MM/DD/YYYY' ) ELSE ' ' END) AS APPROVED_DATE
				FROM  CONTRACT_FINANCIALS CF , CONTRACT_FIN_FUNDING_STREAM CFF, CITY_USER_DETAILS USER1, CITY_USER_DETAILS USER2
				WHERE CF.CONTRACT_ID =  #{asContractID}
				AND CF.CONTRACT_ID =  CFF.CONTRACT_ID 
				AND CF.FISCAL_YEAR_ID =  CFF.FISCAL_YEAR_ID 
				AND CF.APPROVED_BY = USER1.USER_ID(+)
				AND  CF.MODIFIED_BY_USERID = USER2.USER_ID(+)
			) SUB
		WHERE CON.CONTRACT_ID = SUB.CONTRACT_ID(+)	
	</select>
	<!-- R6: New Epin validation changes end -->
	<!-- [Start] R3.9.0 6524  -->
	
	<!-- Start of changes in build no 3.12.0 for enhancement #6602 -->
	<delete id="deleteBudgetCustForCancelConfigureNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM BUDGET_CUSTOMIZATION
		WHERE budget_id = (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear})
	</delete>
	
	<delete id="deleteSubbudgetForCancelConfigureNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM SUB_BUDGET
		WHERE BUDGET_ID = (select budget_id from budget where contract_id = #{contractId} AND fiscal_year_id = #{budgetfiscalYear})
	</delete>

	<delete id="deleteBudgetForCancelConfigureNewFY" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM BUDGET
		WHERE CONTRACT_ID = #{contractId} AND fiscal_year_id = #{budgetfiscalYear}
	</delete>
	
	<update id="copyFYAmountToPreviousAmountForFinancials" parameterType="hashmap">
		UPDATE CONTRACT_FINANCIALS
	    SET  
	    PREVIOUS_AMOUNT = AMOUNT,
	    MODIFIED_DATE = systimestamp, 
	    MODIFIED_BY_USERID = #{asUserId}  
	    WHERE contract_id = #{asContractId}
	</update>
	
	<update id="copyPreviousAmountToAmountForFinancials" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE CONTRACT_FINANCIALS
	    SET  
	    AMOUNT = PREVIOUS_AMOUNT,
	    MODIFIED_DATE = systimestamp, 
	    MODIFIED_BY_USERID = #{modifiedByUserId}  
	    WHERE contract_id = #{contractId}
	</update>
	
	<delete id="deleteNewlyAddedContractFinancialsRows" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM CONTRACT_FINANCIALS
		WHERE CONTRACT_ID = #{contractId} AND NEW_FY_FISCAL_YEAR_ID = #{budgetfiscalYear}
	</delete>
	
	<update id="copyFYAmountToPreviousAmountForFinFunding" parameterType="hashmap">
		UPDATE CONTRACT_FIN_FUNDING_STREAM
	    SET  
	    PREVIOUS_FEDERAL_AMOUNT = FEDERAL_AMOUNT,
	    PREVIOUS_STATE_AMOUNT =  STATE_AMOUNT,
	    PREVIOUS_CITY_AMOUNT = CITY_AMOUNT,
	    PREVIOUS_OTHER_AMOUNT = OTHER_AMOUNT,
	    MODIFIED_DATE = systimestamp, 
	    MODIFIED_BY_USERID = #{asUserId}  
	    WHERE contract_id = #{asContractId}
	</update>
	
	<update id="copyPreviousAmountToAmountForFinFunding" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		UPDATE CONTRACT_FIN_FUNDING_STREAM
	    SET  
	    FEDERAL_AMOUNT = PREVIOUS_FEDERAL_AMOUNT,
	    STATE_AMOUNT = PREVIOUS_STATE_AMOUNT,
	    CITY_AMOUNT = PREVIOUS_CITY_AMOUNT,
	    OTHER_AMOUNT = PREVIOUS_OTHER_AMOUNT,
	    MODIFIED_DATE = systimestamp, 
	    MODIFIED_BY_USERID = #{modifiedByUserId}  
	    WHERE contract_id = #{contractId}
	</update>
	
	<delete id="deleteNewFYDocuments" parameterType="com.nyc.hhs.model.ContractBudgetBean">
		DELETE
		FROM CONTRACT_DOCUMENT
		WHERE CONTRACT_ID = #{contractId} AND NEW_FISCAL_YEAR_ID = #{budgetfiscalYear}
	</delete>
	
	<select id="isAlreadyLaunchedFYTask" parameterType="String"
		resultType="BigDecimal">
		select PREVIOUS_AMOUNT from CONTRACT_FINANCIALS where CONTRACT_ID = #{asContractId} and ROWNUM = 1 
	</select>
	
	<select id="fetcNewFYContractDocs" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String">
		select DOCUMENT_IDENTIFIER_ID from contract_document where CONTRACT_ID = #{contractId} AND NEW_FISCAL_YEAR_ID = #{budgetfiscalYear}
	</select>
	
	<select id="fetchAmendmentBudgetIds" parameterType="com.nyc.hhs.model.ContractBudgetBean"
		resultType="String">
		select budget_id from budget where parent_id in (select budget_id from budget where CONTRACT_ID = #{contractId} AND fiscal_year_id = #{budgetfiscalYear})
		and parent_id != budget_id
	</select>
	
	<delete id="deletePersonnelServiceForNewFYCancel" parameterType="String">
		DELETE FROM PERSONNEL_SERVICE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteOpSupportOthersForNewFYCancel" parameterType="String">
		DELETE FROM OTHER_DETAILS WHERE entity_id IN (select operations_support_id FROM OPERATIONS_AND_SUPPORT WHERE budget_id = #{asAmendmentBudgetId}) AND entry_type_id='2'
	</delete>
	<delete id="deleteOpSupportForNewFYCancel" parameterType="String">
		DELETE FROM OPERATIONS_AND_SUPPORT WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteUtilitiesForNewFYCancel" parameterType="String">
		DELETE FROM UTILITIES WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteProffServiceOthersForNewFYCancel" parameterType="String">
		DELETE FROM OTHER_DETAILS WHERE entity_id IN (select professional_service_id FROM PROFESSIONAL_SERVICE WHERE budget_id = #{asAmendmentBudgetId}) AND entry_type_id='4'
	</delete>
	<delete id="deleteProffServiceForNewFYCancel" parameterType="String">
		DELETE FROM PROFESSIONAL_SERVICE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteRentForNewFYCancel" parameterType="String">
		DELETE FROM RENT WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteContractedServiceForNewFYCancel" parameterType="String">
		DELETE FROM CONTRACTED_SERVICE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteRateForNewFYCancel" parameterType="String">
		DELETE FROM RATE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteMilestoneForNewFYCancel" parameterType="String">
		DELETE FROM MILESTONE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteUnallocatedForNewFYCancel" parameterType="String">
		DELETE FROM UNALLOCATED WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteIndirectRateForNewFYCancel" parameterType="String">
		DELETE FROM INDIRECT_RATE WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteProgIncomeOthersForNewFYCancel" parameterType="String">
		DELETE FROM OTHER_DETAILS WHERE entity_id IN (select program_income_id FROM PROGRAM_INCOME WHERE budget_id = #{asAmendmentBudgetId}) AND entry_type_id='11'
	</delete>
	<delete id="deleteProgramIncomeForNewFYCancel" parameterType="String">
		DELETE FROM PROGRAM_INCOME WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteFringeBenefitForNewFYCancel" parameterType="String">
		DELETE FROM FRINGE_BENEFIT WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteEquipmentForNewFYCancel" parameterType="String">
		DELETE FROM EQUIPMENT WHERE budget_id = #{asAmendmentBudgetId}
	</delete>	
	
	<delete id="deleteSubBudgetSiteForNewFYCancel" parameterType="String">
		DELETE FROM SUB_BUDGET_SITE WHERE sub_budget_id IN (select sub_budget_id FROM SUB_BUDGET WHERE budget_id = #{asAmendmentBudgetId})
	</delete>
	<delete id="deleteSubBudgetForNewFYCancel" parameterType="String">
		DELETE FROM SUB_BUDGET WHERE budget_id = #{asAmendmentBudgetId}
	</delete>	
	
	<delete id="deleteBudgetCustomizForNewFYCancel" parameterType="String">
		DELETE FROM BUDGET_CUSTOMIZATION WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteBudgetDocForNewFYCancel" parameterType="String">
		DELETE FROM BUDGET_DOCUMENT WHERE budget_id = #{asAmendmentBudgetId}
	</delete>
	<delete id="deleteAssociatedBudgetsForNewFYCancel" parameterType="String">
		DELETE FROM BUDGET WHERE budget_id = #{asAmendmentBudgetId}
	</delete>	
	
	<!-- Start of changes in build no 3.15.0 for enhancement #6809  -->
	<delete id="deleteBudgetWithAllSub" parameterType="String">
	    {call
	        BEGIN
				DELETE FROM SUB_BUDGET WHERE BUDGET_ID IN (SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{amendmentContractID} AND FISCAL_YEAR_ID = #{fiscalYearID});
				DELETE FROM BUDGET_CUSTOMIZATION WHERE BUDGET_ID IN (SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{amendmentContractID} AND FISCAL_YEAR_ID = #{fiscalYearID});
				DELETE FROM BUDGET             WHERE BUDGET_ID IN (SELECT BUDGET_ID FROM BUDGET WHERE CONTRACT_ID = #{amendmentContractID} AND FISCAL_YEAR_ID = #{fiscalYearID});
	        END
	    }	
	</delete>
	<!-- End of changes in build no 3.15.0 for enhancement #6809 -->
	
	<!-- End of changes in build no 3.12.0 for enhancement #6602 -->
	<!-- 11jan -->
	<select id="getPendingAmendmentBudgetFiscalYearId" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="String">
	select distinct fiscal_year_id from budget where active_flag =1 and contract_id in (
	select contract_id from contract where parent_contract_id = #{contractID} and contract_type_id = 2 
	and status_id in (128,129,61,130) and IS_AMENDMENT_REGISTERED_IN_FMS=1
	)  and status_id ! = 86
	</select>
	<select id="getContractFinancialUpdateAmount" parameterType="com.nyc.hhs.model.AccountsAllocationBean" resultType="String">
		select nvl(sum(amount),0) from contract_financials where fiscal_year_id = #{fiscalYearID}
        AND contract_id = (select contract_id from contract where parent_contract_id=#{contractID} and  contract_id !=#{contractID} and contract_type_id=#{contractTypeId} 
        and delete_flag=0) 
        AND (UNIT_OF_APPROPRIATION || '-' || BUDGET_CODE || '-' || OBJECT_CODE || '-' || SUB_OBJECT_CODE || '-' || REPORTING_CATEGORY) = #{id}
     </select>
        <!-- 11jan -->
     <!-- Start: Added in Release 5.1.0 for Default FTE calculations -->
     <update id="updateUsesFte" parameterType="HashMap">
     	UPDATE BUDGET
		SET MODIFIED_DATE = systimestamp, 
			FULL_TIME_EMP_HOUR = (SELECT SETTINGS_VALUE FROM APPLICATION_SETTINGS  WHERE COMPONENT_NAME LIKE #{DEFAULT_CITY_FTE})
		WHERE CONTRACT_ID = #{contractID}
		<if test="fiscalYearID != null and fiscalYearID != '' ">
			AND FISCAL_YEAR_ID =  #{fiscalYearID}
		</if>
 	</update>
 	<!-- End: Added in Release 5.1.0 for Default FTE calculations -->
 	
 	<!-- R6 start for inbound interface out of year amendments -->
 	<select id="fetchBudgetIdIfExistsForAmendBatch" parameterType="HashMap" resultType="java.lang.String">
		SELECT BUDGET_ID FROM budget where contract_id = #{asContractId} 
		AND fiscal_year_id = #{asFiscalYearId} AND budget_type_id = 2
	</select>
	
	<update id="updateParentBudgetIdForEtlAmendment" parameterType="HashMap">
     	UPDATE BUDGET
		SET PARENT_ID = #{asParentBudgetId} WHERE CONTRACT_ID = #{asAmendContractId}
		AND FISCAL_YEAR_ID = #{asFiscalYearId} AND BUDGET_TYPE_ID = 1 AND ACTIVE_FLAG = '1'
 	</update>
	<!-- R6 start for inbound interface out of year amendments  ends -->
	<!-- Start: Added in R7 for Cost Center -->
	<select id="fetchServicesForAgency" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="servicesMapping">
		SELECT cost_center_service_mapping_id, name FROM (
		SELECT cm.cost_center_service_mapping_id,
  		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS name
		FROM cost_center_services_mapping cm
		LEFT JOIN cost_center_master cc
		ON cm.cost_center_master_id=cc.cost_center_master_id
		LEFT JOIN services_master sm
		ON cm.service_master_id=sm.service_master_id
		WHERE agency_id=(select agency_id from contract where contract_id = #{contractID})
		 minus
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id IN 
		<choose>
			<when test="contractTypeId == 1">
				#{contractBudgetID}				
			</when>
			<when test="contractTypeId == 2">
			(select budget_id from budget where contract_id = #{contractID} and fiscal_year_id = #{fiscalYearID}
			union
			select budget_id from budget where contract_id = #{amendmentContractID} and fiscal_year_id = #{fiscalYearID}
			)			
			</when>
			<otherwise>
			(select budget_id from budget where contract_id = #{contractID} and fiscal_year_id = #{fiscalYearID}
			union
			SELECT budget_id FROM budget WHERE contract_id = (select contract_id from contract 
				where parent_contract_id = #{contractID} and contract_type_id = #{contractTypeId} and status_id = 59 and delete_flag =0) 
				AND fiscal_year_id = #{fiscalYearID})
    	</otherwise>
		</choose>
    	and bc.active_flag='1'
    	) ORDER BY name
	</select>
	
	<resultMap id="servicesMapping" type="com.nyc.hhs.model.CostCenterServicesMappingList">
		<result property="costCenterServiceMappingId" column="cost_center_service_mapping_id" />
		<result property="enabledServiceName" column="name" />		
	</resultMap>
	
	<select id="fetchSelectedServices" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="servicesMapping">
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id IN 
		<choose>
			<when test="contractTypeId == 1">
				#{contractBudgetID}				
			</when>
			<otherwise>
			(select budget_id from budget where contract_id = #{contractID} and fiscal_year_id = #{fiscalYearID})
    	</otherwise>
		</choose> 
    	 and bc.active_flag='1' order by sm.SERVICE_NAME
	</select>
	
	<select id="fetchUpdatedSelectedServices" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="servicesMapping">
		SELECT cost_center_service_mapping_id, name FROM (
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id in
		<choose>
			<when test="contractTypeId == 1">
				#{contractBudgetID}				
			</when>
			<when test="contractTypeId == 2">
				(select budget_id from budget where contract_id = #{amendmentContractID} and fiscal_year_id = #{fiscalYearID})				
			</when>
			<otherwise>
				(SELECT budget_id FROM budget WHERE contract_id = (select contract_id from contract 
				where parent_contract_id = #{contractID} and contract_type_id = #{contractTypeId} and status_id = 59 and delete_flag=0) 
				AND fiscal_year_id = #{fiscalYearID})
			</otherwise>
		</choose>
		and bc.active_flag='1'
		minus
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id IN 
		(select budget_id from budget where contract_id = #{contractID} and fiscal_year_id = #{fiscalYearID})
    	 and bc.active_flag='1' 
    	 ) ORDER BY name
	</select>
	
	<select id="fetchServicesConfFlag" parameterType="com.nyc.hhs.model.CBGridBean"
	resultType="java.lang.String">
	select
	con.cost_center_opted  as flag
	from nyc_agency_details mas left join contract con on mas.agency_id= con.agency_id 
	where con.contract_id= (CASE WHEN (select contract_type_id as id from contract where contract_id = #{contractID}) = 3 THEN (select 
	contract_id from contract where contract_id = #{contractID}) ELSE
  	(select parent_contract_id from contract where contract_id = #{contractID} ) END)
	</select>
	
	<select id="fetchServicesCount" parameterType="com.nyc.hhs.model.CBGridBean"
	resultType="integer">
		select count(1) as result from budget_services_configuration where budget_id IN 
		<choose>
			<when test="contractTypeId == 2">
			(select budget_id from budget where contract_id = #{amendmentContractID} and fiscal_year_id = #{fiscalYearID})
			</when>
			<when test="contractTypeId == 1 or contractTypeId == 3 or contractTypeId == 5">
			#{contractBudgetID}
			</when>
			<otherwise>
			(select budget_id from budget where	contract_id =#{contractID})
			</otherwise>
		</choose> 
		<if test="transactionName != null and transactionName == 'validateServicesOpted'">
			and active_flag=1
		</if>	
	</select>
	
	<insert id="insertDefaultServicesConfigurations" parameterType="com.nyc.hhs.model.CBGridBean">
			insert into budget_services_configuration (
				BUDGET_SERVICES_CONFIG_ID,
				BUDGET_ID,
				COST_CENTER_SERVICE_MAPPING_ID,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				ACTIVE_FLAG,
				PARENT_ID)
				(
					SELECT SEQ_BUDGET_SERVICES_CONFIG.nextval,
					#{contractBudgetID},				
					cm.cost_center_service_mapping_id,
					sysdate,
					#{createdByUserId},
					sysdate,
					#{createdByUserId},
					'1',
					SEQ_BUDGET_SERVICES_CONFIG.currval
					FROM cost_center_services_mapping cm
					LEFT JOIN cost_center_master cc
					ON cm.cost_center_master_id=cc.cost_center_master_id
					LEFT JOIN services_master sm
					ON cm.service_master_id=sm.service_master_id
					WHERE agency_id=#{agencyId}
				)
	</insert>
	
	<select id="fetchIfProgramIncomeAlreadySelected" parameterType="java.util.HashMap" resultType="int">
		select
			count(1) from budget_customization where budget_id = #{budgetID} and entry_type_id = 11
	</select>
	
	<insert id="insertDefaultServicesConfFromPreviousFy" parameterType="com.nyc.hhs.model.CBGridBean">
	  insert into budget_services_configuration (
				BUDGET_SERVICES_CONFIG_ID,
				BUDGET_ID,
				COST_CENTER_SERVICE_MAPPING_ID,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				ACTIVE_FLAG,
				PARENT_ID)
				(
		        select SEQ_BUDGET_SERVICES_CONFIG.nextval,
		        (select budget_id from budget where	contract_id =#{amendmentContractID} and fiscal_year_id = #{fiscalYearID}),
		        COST_CENTER_SERVICE_MAPPING_ID,
		        sysdate,
		        #{createdByUserId},
		        sysdate,
		        #{createdByUserId},
		        '1',
		        SEQ_BUDGET_SERVICES_CONFIG.currval
		        from budget_services_configuration where budget_id = ( select budget_id from budget where contract_id =#{contractID} and budget_type_id=2
		        and fiscal_year_id = #{fiscalYearID} - 1  ) and active_flag = 1 and cost_center_service_mapping_id not in (
        		select cost_center_service_mapping_id from budget_services_configuration where budget_id = 
        		(select budget_id from budget where	contract_id =#{amendmentContractID} and fiscal_year_id = #{fiscalYearID}) and active_flag='1')
        		)
	</insert>
	
	<insert id="insertAllServicesForNewFy" parameterType="com.nyc.hhs.model.CBGridBean">
	  insert into budget_services_configuration (
				BUDGET_SERVICES_CONFIG_ID,
				BUDGET_ID,
				COST_CENTER_SERVICE_MAPPING_ID,
				CREATED_DATE,
				CREATED_BY_USERID,
				MODIFIED_DATE,
				MODIFIED_BY_USERID,
				ACTIVE_FLAG,
				PARENT_ID)
				(
		        select SEQ_BUDGET_SERVICES_CONFIG.nextval,
		        #{contractBudgetID},
		        COST_CENTER_SERVICE_MAPPING_ID,
		        sysdate,
		        #{createdByUserId},
		        sysdate,
		        #{createdByUserId},
		        active_flag,
		        SEQ_BUDGET_SERVICES_CONFIG.currval
		        from budget_services_configuration where budget_id = ( select budget_id from budget where contract_id =#{contractID}
		        and fiscal_year_id = #{fiscalYearID} - 1  ) and cost_center_service_mapping_id not in (
        		select cost_center_service_mapping_id from budget_services_configuration where budget_id = #{contractBudgetID} )
        		)
	</insert>
	
	<select id="fetchUpdateServicesForAgency" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="servicesMapping">
		SELECT cost_center_service_mapping_id, name FROM (
		SELECT cm.cost_center_service_mapping_id,
  		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS name
		FROM cost_center_services_mapping cm
		LEFT JOIN cost_center_master cc
		ON cm.cost_center_master_id=cc.cost_center_master_id
		LEFT JOIN services_master sm
		ON cm.service_master_id=sm.service_master_id
		WHERE agency_id=(select agency_id from contract where contract_id = #{contractID})
		 minus
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id IN 
		(select budget_id from budget where budget_id=#{contractBudgetID}	
		union 
		select parent_id as budget_id from budget where budget_id=#{contractBudgetID}) 					
    	and bc.active_flag='1'
    	) ORDER BY name
	</select>
	
	 <select id="fetchSelectedServicesForUpdate" parameterType="com.nyc.hhs.model.CBGridBean"
		resultMap="servicesMapping">
		select cm.cost_center_service_mapping_id,
		sm.SERVICE_NAME || ' (' || cc.cost_center_name || ')' AS Name from budget_services_configuration bc left join 
		cost_center_services_mapping cm on cm.cost_center_service_mapping_id=
		bc.cost_center_service_mapping_id left join cost_center_master cc on cc.cost_center_master_id = cm.cost_center_master_id
		left join services_master sm on cm.service_master_id=sm.service_master_id where budget_id IN 
		(select budget_id from budget where budget_id=#{contractBudgetID}	
		union 
		select parent_id as budget_id from budget where budget_id=#{contractBudgetID})  
    	and bc.active_flag='1' order by sm.SERVICE_NAME
	</select>
	
	<select id="fetchAgencyServiceFlag" parameterType="com.nyc.hhs.model.CBGridBean"
	resultType="java.lang.String">
	select
	NVL( mas.SERVICES_SETTING_MASTER_ID ,0)  as flag
	from nyc_agency_details mas left join contract con on mas.agency_id= con.agency_id 
	where con.contract_id= (CASE WHEN (select contract_type_id as id from contract where contract_id = #{contractID}) = 3 THEN (select 
	contract_id from contract where contract_id = #{contractID}) ELSE
  	(select parent_contract_id from contract where contract_id = #{contractID} ) END)
	</select>
	
	<!-- End: Added in R7 for Cost Center -->
	
	<!--start changes in R7 for the defects 8644-->
		<!--[Start] R7.12.0 QC9314 Mark as Registered which is part of out year Amendment Merge -->
	<update id="updatePartialMergeAction" parameterType="java.lang.String">
            update contract 
      set  REQUEST_PARTIAL_MERGE = 2 
         , MODIFIED_BY_USERID =  'system' 
         , MODIFIED_DATE = SYSTIMESTAMP
      where contract_id = #{lsContractId} 
      and REQUEST_PARTIAL_MERGE=1
    </update>
    <!--[End] R7.12.0 QC9314 Mark as Registered which is part of out year Amendment Merge -->
      <!--ends changes in R7 for the defects 8644-->
      
<!-- added in R7 for fetching sub budget id and parent sub budget id -->
			<select id="fetchSubBudgetListDetails" parameterType="String" resultMap="budgetSiteDetails">
		select SUB_BUDGET_ID,PARENT_ID from SUB_BUDGET where BUDGET_ID = #{budgetId} AND ACTIVE_FLAG = '1'
		</select>
		<!-- End  R7 for fetching sub budget id and parent sub budget id -->
	<!--  Start: added in R7 for multiple Amendments for Defect 8831 -->
	<select id="fetchBudgetListsDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean"
	resultType="String">
	SELECT sub_budget_id
	FROM sub_budget s,
	budget b
	WHERE s.budget_id!=#{budgetId}
	AND s.parent_id =#{id}
	AND s.active_flag =1
	AND b.budget_id = s.budget_id
	</select>
	<!-- end: added in R7 for multiple Amendments for Defect 8831 -->
	
	<!-- added in release 7 for defect 8884 :it will delete newly added subbudgets during NFY task on cancellation of NFY task -->
	<delete id="deleteNewlyAddedSubBudgets" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	DELETE
	FROM sub_budget
	WHERE sub_budget_id =#{subBudgetId}
  	</delete>
	
<!--  added in release 7 for defect 8884 :it will fetch list of newly added sub budgets -->
	<select id="fetchSubBudgetListsDetails" parameterType="com.nyc.hhs.model.ContractBudgetBean"
	resultType="String">
	SELECT SUB_BUDGET_ID
	FROM SUB_BUDGET
	WHERE BUDGET_ID =(SELECT Budget_id
	FROM Budget
	WHERE CONTRACT_ID = #{contractId}
	AND fiscal_year_id = #{budgetfiscalYear})
	AND FISCAL_YEAR_ID=#{budgetfiscalYear}
	AND parent_id = SUB_BUDGET_ID
	MINUS
	SELECT parent_id
	FROM SUB_BUDGET
	WHERE BUDGET_ID IN
	(SELECT budget_id
	FROM budget
	WHERE PARENT_ID = (SELECT Budget_id
	FROM Budget
	WHERE CONTRACT_ID = #{contractId}
	AND fiscal_year_id = #{budgetfiscalYear})
	AND PARENT_ID! = BUDGET_ID
	)
	</select>
	
	<!-- Start: Added in R7 for cost center -->
	<delete id="deleteServicesConfigration" parameterType="com.nyc.hhs.model.ContractBudgetBean">
	delete from BUDGET_SERVICES_CONFIGURATION where budget_id in (select budget_id from budget where contract_id= #{contractId} 
	and fiscal_year_id = #{budgetfiscalYear})
	</delete>
	
	<!-- Start QC 9145 R 8.8 Registered Contracts not marked as registered in Accelerator -->
	<resultMap id="refContractFMS" type="com.nyc.hhs.model.RefContractFMSBean">
		<result property="fmsContractAmount" column="MAX_CNTRC_AM" />
		<result property="fmsTrkgNo" column="trkg_no" /> 
		<result property="fmsDocVersNo" column="doc_vers_no" /> 
		<result property="fmsDocCd" column="DOC_CD" />
		<result property="fmsDocDeptCd" column="DOC_DEPT_CD" />
		<result property="fmsDocId" column="DOC_ID" />
		<result property="fmsExtCtNumber" column="EXT_CT_NUMBER" />
		<result property="fmsContractStartDate" column="cntrct_strt_dt" />
		<result property="fmsContractEndDate" column="cntrct_end_dt" />
		<result property="awardEpin" column="PROCUREMENT_AWARD_EPIN" />
		<result property="vendFmsId" column="VENDOR_FMS_ID" />
		<result property="vendCustCd" column="VEND_CUST_CD" />
		<result property="vendTin" column="TIN" />
		<result property="extCpmmodityCode" column="COMM_CD" />
		<result property="extDocVersNo" column="DOC_VERS_NO" />
		
	</resultMap>

	<select id="fetchRefContractFMS" parameterType="java.lang.String"	resultMap="refContractFMS">
	select trkg_no, 
      doc_vers_no, 
      (DOC_CD || DOC_DEPT_CD || DOC_ID) AS EXT_CT_NUMBER, 
      DOC_CD, 
      DOC_DEPT_CD, 
      DOC_ID,
      MAX_CNTRC_AM, 
      cntrct_strt_dt, 
      cntrct_end_dt 
	from
	(select trkg_no, 
	      doc_vers_no, 
	      (DOC_CD || DOC_DEPT_CD || DOC_ID) AS EXT_CT_NUMBER, 
	      DOC_CD, 
	      DOC_DEPT_CD, 
	      DOC_ID,
	      MAX_CNTRC_AM, 
	      cntrct_strt_dt, 
	      cntrct_end_dt 
	      from   ref_contracts_h  
	      where 
	      trkg_no in (select ext_epin from contract where contract_id = #{contractId})
	      order by trkg_no, doc_vers_no desc)
	where ROWNUM = 1
	
	</select>
	
	<select id="fetchDocVersionAndCommodityCodeFMS" parameterType="com.nyc.hhs.model.RefContractFMSBean"
	resultMap="refContractFMS">
	select 
		trkg_no,
      	doc_vers_no,
      	comm_cd,
      	(DOC_CD || DOC_DEPT_CD || DOC_ID) AS EXT_CT_NUMBER, 
      	DOC_CD, DOC_DEPT_CD, DOC_ID
	from
		(select trkg_no,
				doc_vers_no, 
        		comm_cd,
      			(DOC_CD || DOC_DEPT_CD || DOC_ID) AS EXT_CT_NUMBER, 
      			DOC_CD, DOC_DEPT_CD, DOC_ID
      	from ref_contracts_c  
      	where DOC_CD || DOC_DEPT_CD || DOC_ID = #{fmsExtCtNumber}
      	order by (DOC_CD || DOC_DEPT_CD || DOC_ID), doc_vers_no desc)
	where ROWNUM = 1
	</select>
	
	
	<select id="fetchVendorTinFMS" parameterType="com.nyc.hhs.model.RefContractFMSBean"	
	resultMap="refContractFMS">	
	select
		r.PROCUREMENT_AWARD_EPIN, 
		r.VENDOR_FMS_ID,  
		v.VEND_CUST_CD, 
		v.TIN
		from REF_CONTRACTS_H h, REF_APT_EPIN_MASTER r, REF_VENDOR_V v
		where h.TRKG_NO = r.PROCUREMENT_AWARD_EPIN 
			and r.VENDOR_FMS_ID = v.VEND_CUST_CD
			and h.TRKG_NO = #{fmsTrkgNo}  
			and h.DOC_VERS_NO = #{fmsDocVersNo}
 	</select>
 	
 	<select id="fetchAgencyIdFMS" parameterType="com.nyc.hhs.model.RefContractFMSBean"	
	resultType="java.lang.String">	
 	select 
 	distinct(na.agency_id)
 	from NYC_AGENCY_DETAILS na, CONTRACT c, REF_CONTRACTS_H h
 	where c.AGENCY_ID = na.AGENCY_ID
 		and na.AGENCY_code = h.DOC_DEPT_CD
 		and na.ACTIVE_FLAG = 1
 		and c.AGENCY_ID = #{agencyId} 
 		and c.EXT_EPIN = #{awardEpin} 
 		and h.TRKG_NO = #{awardEpin} 
 		and h.DOC_VERS_NO = #{fmsDocVersNo}
    </select>
 
    <select id="fetchEinId" parameterType="java.lang.String"	
	resultType="java.lang.String">	
    select EIN_ID_NN  
    from  ORGANIZATION
 	where ORGANIZATION_ID = #{organizationId}
 	</select>
 	
 	<update id="updateContractWithCTandStatus" parameterType="com.nyc.hhs.model.RefContractFMSBean" >
       UPDATE CONTRACT 
       SET STATUS_ID = #{statusId},
       		EXT_CT_NUMBER = #{fmsExtCtNumber}, 
       		EXT_COMMODITY_CODE = #{extCpmmodityCode}, 
       		EXT_DOC_VERSION = #{extDocVersNo}, 
       		UPDATE_FLAG = '1',
       		MODIFIED_DATE = SYSTIMESTAMP,
       		MODIFIED_BY_USERID = #{userId} 
       WHERE CONTRACT_ID = #{contractId}
       		and CONTRACT_TYPE_ID = 1
	</update>
	
	<update id="updateContractWithCTandFMSInfo" parameterType="com.nyc.hhs.model.RefContractFMSBean" >
       UPDATE CONTRACT 
       SET STATUS_ID = #{statusId},
       		EXT_CT_NUMBER = #{fmsExtCtNumber},
       		EXT_COMMODITY_CODE = #{extCpmmodityCode}, 
       		EXT_DOC_VERSION = #{extDocVersNo}, 
       		UPDATE_FLAG = '1',
       		MODIFIED_DATE = SYSTIMESTAMP,
       		MODIFIED_BY_USERID = #{userId},
       		DISCREPANCY_FLAG = #{discrepancyFlag},
       		FMS_CONTRACT_AMOUNT = #{fmsContractAmount},
       		FMS_CONTRACT_START_DATE =#{fmsContractStartDate, jdbcType=DATE},
       		FMS_CONTRACT_END_DATE = #{fmsContractEndDate, jdbcType=DATE} 
       WHERE CONTRACT_ID = #{contractId}
       		and CONTRACT_TYPE_ID = 1
	</update>
	
	<!--  End QC 9145 R 8.8 Registered Contracts not marked as registered in Accelerator -->
	 	
</mapper>

